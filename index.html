<!DOCTYPE html>
<html lang="en">
<head>
    <!-- =====================================================
         NOWAK DISTRIBUTING ERP SYSTEM - FRONTEND
         =====================================================
         LAST UPDATED: Tuesday, December 24, 2025
         VERSION: V16_122
         =====================================================
         CHANGES IN THIS VERSION:
         - IMPROVED: Sales Order Detail report chart layout
           - Sales Trend chart moved to first position (full width)
           - Status charts (Payment/Order) on second row
           - Top 10 charts remain on rows 3 & 4
         - IMPROVED: Sales by Item report - complete redesign
           - Added Sales Trend chart (full width)
           - Added Top 10 by Sales: Items + Suppliers
           - Added Top 10 by Margin: Items + Suppliers (color-coded)
           - Added Quick Stats section (collapsible)
           - HTML/CSS bar charts matching other sales reports
         - IMPROVED: Purchase by Supplier report - complete redesign
           - Added Purchase Trend chart (full width)
           - Added Top 10 Products by Purchases
           - Added Top 10 Products by Sales
           - Added Quick Stats section (collapsible)
           - Added Total Sales KPI for supplier products
         - FIXED: Item picker "Select All" now respects supplier filter
           - Only selects visible items (filtered by supplier/search)
           - Adds to existing selection instead of replacing
         ===================================================== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Nowak Distributing - Inventory Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary, #667eea);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            margin: 0;
            /* Allow normal scrolling */
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        html {
            /* Standard scrolling setup */
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
            /* Prevent pull-to-refresh but allow scroll */
            overscroll-behavior-y: contain;
        }
        
        /* MOBILE TOUCH SENSITIVITY FIX */
        /* Reduce accidental taps and double-firing */
        select, 
        button, 
        .btn, 
        .report-btn,
        input[type="button"],
        input[type="submit"] {
            touch-action: manipulation; /* Disables double-tap zoom */
            -webkit-tap-highlight-color: rgba(0,0,0,0.1); /* Subtle tap feedback */
            -webkit-touch-callout: none; /* Disable callout on long press */
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* HORIZONTAL SCROLL CONTAINERS - Improved touch handling */
        .table-scroll-wrapper,
        .horizontal-scroll,
        [style*="overflow-x: auto"],
        [style*="overflow-x:auto"] {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-x: contain; /* Prevent horizontal scroll from triggering page navigation */
            scroll-behavior: auto; /* Use auto for more responsive feel */
        }
        
        /* Larger touch targets on mobile */
        @media (max-width: 768px) {
            select, 
            button:not(.btn-small), 
            .btn:not(.btn-small) {
                min-height: 44px; /* Apple's recommended touch target */
                padding: 12px 16px;
            }
            
            /* Add small delay before select opens to prevent accidental taps */
            select {
                -webkit-appearance: none;
                appearance: none;
            }
            
            /* MOBILE HORIZONTAL SCROLL FIX */
            /* Prioritize horizontal scrolling in scroll containers */
            .table-scroll-wrapper,
            .horizontal-scroll,
            div[style*="overflow-x: auto"],
            div[style*="overflow-x:auto"] {
                touch-action: pan-x pan-y pinch-zoom;
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
                scroll-snap-type: none; /* Disable any snap behavior */
            }
            
            /* Tables inside scroll wrappers - allow natural scrolling */
            .table-scroll-wrapper > table,
            .horizontal-scroll > table {
                touch-action: auto; /* Let table content scroll naturally */
            }
            
            /* Give horizontal scroll containers a visual hint */
            .table-scroll-wrapper::after,
            .horizontal-scroll::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 20px;
                background: linear-gradient(to right, transparent, rgba(0,0,0,0.05));
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s;
            }
            
            .table-scroll-wrapper:not(:hover)::after,
            .horizontal-scroll:not(:hover)::after {
                opacity: 1;
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-left: 4px solid rgba(255, 255, 255, 0.4);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.3);
            border-left-color: rgba(255, 255, 255, 0.6);
        }

        .tab.active {
            background: white;
            color: #667eea;
            font-weight: 600;
            border-left: 4px solid #c0c0c0;
        }

        .card {
            background: var(--card-bg, #f3f0ff); /* Use CSS variable with fallback */
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
            /* Contain content in landscape mode */
            overflow-x: auto;
            overflow-y: visible; /* Let page scroll handle vertical */
            max-width: 100%;
            border-left: 5px solid #c0c0c0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        .card.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
        }
        
        /* Section cards within main cards - consistent grey shadow edge */
        
        /* Sales page specific cards */
        .sales-filter-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .sales-data-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #e0e0e0;
        }
        
        /* Universal content cards for all tabs */
        .content-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #e0e0e0;
            margin-bottom: 20px;
            min-width: 0;
            overflow: hidden;
        }
        
        .filter-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #e0e0e0;
            margin-bottom: 20px;
            min-width: 0;
            overflow: hidden;
        }
        
        .data-display-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #e0e0e0;
            min-width: 0;
            overflow: hidden;
        }
        .section-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            min-width: 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #c0c0c0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }
        
        /* All accent colors now use consistent grey */
        .section-card.accent-blue,
        .section-card.accent-green,
        .section-card.accent-orange,
        .section-card.accent-purple,
        .section-card.accent-red,
        .section-card.accent-teal,
        .section-card.accent-pink,
        .section-card.accent-indigo,
        .section-card.accent-cyan,
        .section-card.accent-amber,
        .section-card.accent-theme,
        .section-card.accent-secondary { 
            border-left-color: #c0c0c0; 
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Table wrapper for horizontal scroll on mobile landscape */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 20px 0;
        }

        .btn {
            background: var(--primary, #667eea);
            color: white;
            border: none;
            border-left: 4px solid rgba(255, 255, 255, 0.4);
            padding: 12px 28px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            border-left-color: rgba(255, 255, 255, 0.6);
        }

        .btn-success {
            background: var(--primary, #667eea);
        }

        .btn-secondary {
            background: var(--secondary, #764ba2) !important;
            color: white !important;
            border-left: 4px solid rgba(255, 255, 255, 0.4) !important;
            opacity: 0.85;
        }
        
        .btn-secondary:hover {
            opacity: 1;
        }
        
        /* Oval filter button styles */
        .oval-filter-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 1 !important;
        }
        
        .oval-filter-btn:active {
            transform: translateY(0) scale(1);
        }
        
        .btn-small {
            background: var(--primary, #667eea);
            color: white;
            border: none;
            border-left: 3px solid rgba(255, 255, 255, 0.4);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            margin-right: 5px;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .btn-small:hover {
            filter: brightness(0.9);
            transform: translateY(-1px);
            border-left-color: rgba(255, 255, 255, 0.6);
        }
        
        .btn-danger {
            background: transparent;
            color: #b88a8a;
            border: 1px solid #b88a8a;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .btn-danger:hover {
            background: #b88a8a;
            color: white;
        }
        
        .btn-delete-icon {
            background: transparent;
            color: #999;
            border: none;
            padding: 4px 8px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .btn-delete-icon:hover {
            background: #ffebee;
            color: #b88a8a;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        /* Report Grid Layout */
        .report-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .report-category {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-left: 5px solid #c0c0c0;
        }
        
        .report-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 12px;
        }
        
        .report-category-header:hover {
            opacity: 0.8;
        }
        
        .report-category h4 {
            margin: 0;
            color: #555;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .report-toggle {
            color: #888;
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .report-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .report-buttons.collapsed {
            display: none;
        }
        
        .report-category.collapsed .report-category-header {
            margin-bottom: 0;
        }
        
        .report-btn {
            width: 100%;
            text-align: left;
            padding: 12px 15px !important;
            font-size: 14px !important;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-radius: 8px !important;
            border-left: 4px solid rgba(255,255,255,0.4) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .report-btn:hover {
            transform: translateX(3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .report-btn-green {
            background: linear-gradient(135deg, #6b9a8d, #218838) !important;
            color: white !important;
        }
        
        .report-btn-green:hover {
            background: linear-gradient(135deg, #218838, #1e7e34) !important;
        }
        
        .report-btn-red {
            background: linear-gradient(135deg, #b88a8a, #c82333) !important;
            color: white !important;
        }
        
        .report-btn-red:hover {
            background: linear-gradient(135deg, #c82333, #bd2130) !important;
        }
        
        /* Mobile: Stack categories vertically */
        @media (max-width: 600px) {
            .report-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Landscape phone: 2x2 grid */
        @media (min-width: 601px) and (max-width: 900px) {
            .report-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Desktop: 4 columns */
        @media (min-width: 901px) {
            .report-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background: #f8f9ff;
            font-weight: 600;
            color: #667eea;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-table tr:hover {
            background: #f8f9ff;
        }
        
        /* Scrollable table wrapper */
        .table-scroll-wrapper {
            max-height: 60vh;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 15px;
            -webkit-overflow-scrolling: touch;
        }
        
        /* On mobile, don't restrict table height - let page scroll naturally */
        @media (max-width: 768px) {
            .table-scroll-wrapper {
                max-height: none !important;
                overflow-y: visible !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Hide desktop floating buttons on mobile */
            #backBtn.desktop-nav-btn,
            #backToTopBtn.desktop-nav-btn {
                display: none !important;
            }
            
            /* Mobile nav bar - REMOVED - kept breaking and floating */
            #mobileNavBar {
                display: none !important;
            }
            
            /* CRITICAL FIX: When body overflow is hidden (modal open), 
               completely hide all selects outside of modals to prevent iOS touch issues */
            body[style*="overflow: hidden"] select:not(.modal-select),
            body[style*="overflow:hidden"] select:not(.modal-select) {
                visibility: hidden !important;
                pointer-events: none !important;
                position: absolute !important;
                left: -99999px !important;
                opacity: 0 !important;
            }
            
            /* Ensure selects in hidden forms are completely inaccessible */
            [style*="display: none"] select,
            [style*="display:none"] select {
                pointer-events: none !important;
                visibility: hidden !important;
                position: absolute !important;
                left: -99999px !important;
            }
        }
        
        /* Desktop: hide mobile nav bar */
        @media (min-width: 769px) {
            #mobileNavBar {
                display: none !important;
            }
        }
        
        .table-scroll-wrapper .data-table {
            margin-top: 0;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status.success {
            background: #e0ebe7;
            color: #4a6b5f;
            border: 1px solid #d0e0da;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .line-items-container {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .line-item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 50px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        
        /* Make line item selects and inputs MUCH larger and more visible */
        .line-item-row select,
        .line-item-row input[type="number"],
        .line-items-container select,
        .line-items-container input[type="number"],
        #createPOLineItems select,
        #createPOLineItems input[type="number"],
        #poLineItems select,
        #poLineItems input[type="number"],
        #soLineItems select,
        #soLineItems input[type="number"],
        .edit-line-item select,
        .edit-line-item input[type="number"] {
            padding: 14px 12px !important;
            font-size: 16px !important;
            min-height: 52px;
            border: 2px solid #667eea !important;
            border-radius: 8px !important;
            background: white !important;
        }
        
        /* Item dropdown - make extra wide and prominent */
        .line-item-row select,
        .line-items-container select,
        #createPOLineItems select,
        #poLineItems select,
        #soLineItems select,
        .edit-line-item select {
            font-size: 15px !important;
            font-weight: 500 !important;
            color: #333 !important;
            cursor: pointer;
        }
        
        /* Cases/Qty input - make VERY prominent */
        .line-item-row input[type="number"],
        .line-items-container input[type="number"],
        #createPOLineItems input[type="number"],
        #poLineItems input[type="number"],
        #soLineItems input[type="number"],
        .edit-line-item input[type="number"] {
            font-size: 18px !important;
            font-weight: bold !important;
            text-align: center !important;
            background: #fffde7 !important;
            border: 2px solid #f9a825 !important;
            min-width: 80px;
        }
        
        .line-item-row select:focus,
        .line-items-container select:focus,
        #createPOLineItems select:focus,
        #poLineItems select:focus,
        #soLineItems select:focus,
        .edit-line-item select:focus,
        .line-item-row input:focus,
        .line-items-container input:focus,
        #createPOLineItems input:focus,
        #poLineItems input:focus,
        #soLineItems input:focus,
        .edit-line-item input:focus {
            border-color: var(--primary, #667eea) !important;
            outline: none;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.25);
        }
        
        /* Item dropdown should be wider */
        .createpo-item,
        .so-item,
        .po-item,
        .edit-item {
            min-width: 250px;
        }
        
        /* Quantity/Cases input highlight on focus */
        .createpo-qty:focus,
        .so-qty:focus,
        .po-qty:focus,
        .edit-qty:focus {
            background: #fff59d !important;
            border-color: #f57f17 !important;
        }

        .remove-btn {
            background: #b88a8a;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .config-box {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        /* ==================== REPORT DASHBOARD STYLES ==================== */
        /* These must be global because <style> tags in innerHTML don't always work */
        
        .biz-header {
            padding: 35px;
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(5, 150, 105, 0.3), 0 4px 12px rgba(0,0,0,0.1);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .biz-header h2 { 
            margin: 0 0 10px 0; 
            font-size: 32px;
            display: flex;
            align-items: center;
            gap: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .biz-header p { 
            margin: 0; 
            opacity: 0.95; 
            font-size: 16px; 
        }
        
        .biz-kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .biz-kpi {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }
        .biz-kpi .icon { font-size: 32px; margin-bottom: 10px; }
        .biz-kpi .value { font-size: 28px; font-weight: bold; color: #1f2937; }
        .biz-kpi .label { font-size: 12px; color: #6b7280; text-transform: uppercase; margin-top: 5px; }
        .biz-kpi .change { font-size: 13px; margin-top: 8px; font-weight: 600; }
        .biz-kpi .change.up { color: #059669; }
        .biz-kpi .change.down { color: #b88a8a; }
        
        .biz-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .biz-section h3 {
            margin: 0 0 20px 0;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .biz-rank-list { list-style: none; padding: 0; margin: 0; }
        .biz-rank-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .biz-rank-item:last-child { border-bottom: none; }
        .biz-rank-num {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }
        .biz-rank-info { flex: 1; margin-left: 12px; min-width: 0; }
        .biz-rank-name { font-weight: 600; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .biz-rank-sub { font-size: 12px; color: #6b7280; }
        .biz-rank-value { font-weight: bold; color: #059669; font-size: 16px; }
        .biz-rank-bar {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        .biz-rank-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .biz-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .biz-stat-row:last-child { border-bottom: none; }
        .biz-stat-label { color: #6b7280; }
        .biz-stat-value { font-weight: 600; color: #1f2937; }
        
        /* ==================== MOBILE RESPONSIVE STYLES ==================== */
        
        /* Tablets and smaller (768px and below) */
        @media (max-width: 768px) {
            /* Ensure body can scroll properly on mobile */
            html, body {
                overflow-x: hidden !important;
                overflow-y: auto !important;
                height: auto !important;
                position: static !important;
            }
            
            body {
                padding: 10px;
            }
            
            /* Override stuck modal states on mobile */
            body.modal-open {
                position: static !important;
                overflow-y: auto !important;
                height: auto !important;
                overscroll-behavior: none !important;
            }
            
            /* Prevent scroll chaining on modals */
            #reportSetupModal,
            #orderModal {
                overscroll-behavior: contain !important;
            }
            
            /* Floating Settings Gear - smaller on mobile */
            div[onclick="switchTab('config')"][style*="position: fixed"][style*="top: 20px"] {
                width: 45px !important;
                height: 45px !important;
                top: 15px !important;
                right: 15px !important;
            }
            
            div[onclick="switchTab('config')"][style*="position: fixed"] span {
                font-size: 20px !important;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .tabs {
                gap: 5px;
            }
            
            .tab {
                padding: 10px 16px;
                font-size: 14px;
                flex: 1 1 auto;
            }
            
            .card {
                padding: 15px;
                border-radius: 12px;
                overflow-x: hidden; /* Prevent horizontal issues on mobile */
                overflow-y: visible; /* Let page scroll */
            }
            
            /* Stack form fields vertically on mobile */
            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 15px;
            }
            
            /* Make line items stack vertically */
            .line-item-row {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }
            
            .line-item-row select,
            .line-item-row input {
                width: 100%;
            }
            
            .remove-btn {
                width: 100%;
                padding: 12px;
            }
            
            /* Make tables scrollable horizontally */
            .data-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                touch-action: pan-x pan-y; /* Enable smooth horizontal scrolling */
                scroll-behavior: auto; /* Immediate response to touch */
            }
            
            .data-table th,
            .data-table td {
                padding: 8px;
                font-size: 14px;
            }
            
            /* Stack buttons vertically */
            .btn {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .btn-small {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            /* ========== UNIVERSAL TAB/CARD MOBILE STYLES ========== */
            
            /* All tabs - inventory flow, reports, config, etc. */
            #invflow, #reports, #guides, #config, #pricesim, #inventory {
                padding: 10px !important;
            }
            
            /* Content cards in all tabs */
            .content-card {
                padding: 12px !important;
                margin-bottom: 15px !important;
                border-radius: 10px !important;
            }
            
            .content-card h3 {
                font-size: 15px !important;
                margin-bottom: 10px !important;
            }
            
            /* All grid layouts - stack on mobile */
            .content-card > div[style*="display: grid"],
            .content-card > div[style*="grid-template-columns"],
            div[style*="grid-template-columns: repeat(auto-fit"] {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            /* Metric cards in dashboards */
            .content-card div[style*="text-align: center"][style*="padding: 20px"] {
                padding: 12px !important;
            }
            
            .content-card div[style*="font-size: 32px"],
            .content-card div[style*="font-size: 36px"] {
                font-size: 24px !important;
            }
            
            .content-card div[style*="font-size: 14px"] {
                font-size: 12px !important;
            }
            
            /* Flex containers - stack on mobile */
            .content-card > div[style*="display: flex"][style*="justify-content: space-between"] {
                flex-wrap: wrap !important;
                gap: 8px !important;
            }
            
            /* Tables in all tabs */
            .content-card table,
            #invflowBackorderItems table,
            #invflowPendingPOs table,
            #invflowCriticalItems table {
                font-size: 11px !important;
            }
            
            .content-card th,
            .content-card td {
                padding: 6px 4px !important;
            }
            
            /* How-to Guide Modal */
            #howToGuideModal > div,
            #uploadItemsModal > div,
            #tutorialModal > div {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                border-radius: 0 !important;
                min-height: 100% !important;
            }
            
            /* Price Simulator */
            #pricesim .form-grid {
                grid-template-columns: 1fr !important;
            }
            
            #pricesim table {
                font-size: 11px !important;
            }
            
            /* Inventory Adjustments */
            #inventory .form-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Reports tab buttons */
            #reports .report-btn {
                font-size: 13px !important;
                padding: 10px 12px !important;
            }
            
            /* Guides/Tutorial section */
            #guides details {
                margin-bottom: 10px !important;
            }
            
            #guides summary {
                padding: 12px !important;
                font-size: 14px !important;
            }
            
            #guides details > div {
                padding: 12px !important;
            }
            
            /* Config/Settings tab */
            #config .content-card {
                padding: 12px !important;
            }
            
            #config input,
            #config select {
                font-size: 16px !important;
                min-height: 44px !important;
            }
            
            /* ========== CREATE PO LINE ITEMS MOBILE RESPONSIVE ========== */
            
            /* Remove horizontal scroll wrapper on mobile */
            #createPOLineItemsWrapper {
                overflow-x: visible !important;
                overflow-y: visible !important;
            }
            
            #createPOLineItemsInner {
                overflow: visible !important;
                min-width: 100% !important;
                width: 100% !important;
            }
            
            /* Hide the grid header on mobile (too many columns) */
            #createPOLineItemsHeader {
                display: none !important;
            }
            
            /* Make line items container not use grid */
            #createPOLineItems {
                border: none !important;
                border-radius: 0 !important;
                padding: 0 !important;
                background: transparent !important;
            }
            
            /* Make each line item a vertical card on mobile */
            #createPOLineItems .line-item-row {
                display: flex !important;
                flex-direction: column !important;
                grid-template-columns: none !important;
                gap: 12px !important;
                padding: 15px !important;
                background: white !important;
                border: 2px solid var(--primary, #667eea) !important;
                border-radius: 12px !important;
                margin-bottom: 15px !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            }
            
            /* Each field container gets full width */
            #createPOLineItems .line-item-row > div {
                width: 100% !important;
                margin-top: 0 !important;
                box-sizing: border-box !important;
            }
            
            /* Show labels on mobile (they're already there) */
            #createPOLineItems .line-item-row label {
                display: block !important;
                font-weight: 600 !important;
                margin-bottom: 5px !important;
                font-size: 14px !important;
                color: #555 !important;
            }
            
            /* Make selects and inputs full width with better touch targets */
            #createPOLineItems .line-item-row select,
            #createPOLineItems .line-item-row input[type="number"] {
                width: 100% !important;
                min-height: 52px !important;
                font-size: 16px !important;
                padding: 14px 12px !important;
                box-sizing: border-box !important;
                background: white !important;
                color: #333 !important;
                border: 2px solid var(--primary, #667eea) !important;
                border-radius: 8px !important;
            }
            
            /* Ensure select options are visible */
            #createPOLineItems .line-item-row select option {
                color: #333 !important;
                background: white !important;
                padding: 10px !important;
            }
            
            /* Delete button full width at bottom */
            #createPOLineItems .line-item-row button {
                width: 100% !important;
                margin-top: 0 !important;
                padding: 14px !important;
                font-size: 16px !important;
            }
            
            /* Computed values - add labels and make prominent */
            #createPOLineItems .createpo-units,
            #createPOLineItems .createpo-totalunits,
            #createPOLineItems .createpo-cost,
            #createPOLineItems .createpo-linetotal {
                font-size: 18px !important;
                padding: 12px !important;
                font-weight: bold !important;
                border-radius: 8px !important;
            }
            
            /* Add visual labels for computed values on mobile */
            #createPOLineItems .createpo-units::before {
                content: "Units/Case: ";
                font-weight: 600;
                font-size: 14px;
                color: #555;
                display: block;
                margin-bottom: 4px;
            }
            
            #createPOLineItems .createpo-totalunits::before {
                content: "Total Units: ";
                font-weight: 600;
                font-size: 14px;
                color: #555;
                display: block;
                margin-bottom: 4px;
            }
            
            #createPOLineItems .createpo-cost::before {
                content: "Catalog Cost: ";
                font-weight: 600;
                font-size: 14px;
                color: #555;
                display: block;
                margin-bottom: 4px;
            }
            
            #createPOLineItems .createpo-linetotal::before {
                content: "Line Total: ";
                font-weight: 600;
                font-size: 14px;
                color: #555;
                display: block;
                margin-bottom: 4px;
            }
            
            /* Make the Order Summary sticky work better on mobile */
            #createPOForm .content-card[style*="position: sticky"] {
                position: sticky !important;
                top: 60px !important;
                z-index: 9 !important;
                margin-bottom: 20px !important;
            }
            
            /* Make Order Summary cards stack on mobile */
            #createPOForm .content-card[style*="position: sticky"] > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            /* ========== MAIN PO LINE ITEMS (#poLineItems) MOBILE RESPONSIVE ========== */
            
            /* Hide the horizontal scroll wrapper's min-width on mobile */
            #poLineItemsInner {
                min-width: 100% !important;
                width: 100% !important;
            }
            
            /* Hide the header row on mobile */
            #poLineItemsHeader {
                display: none !important;
            }
            
            /* Remove border styling from container */
            #poLineItems {
                border: none !important;
                border-radius: 0 !important;
                padding: 0 !important;
                background: transparent !important;
            }
            
            /* Make each PO line item a vertical card */
            #poLineItems .line-item-row {
                display: flex !important;
                flex-direction: column !important;
                grid-template-columns: unset !important;
                gap: 12px !important;
                padding: 15px !important;
                background: white !important;
                border: 2px solid var(--primary, #667eea) !important;
                border-radius: 12px !important;
                margin-bottom: 15px !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            }
            
            /* Each field container gets full width */
            #poLineItems .line-item-row > div {
                width: 100% !important;
                margin-top: 0 !important;
                box-sizing: border-box !important;
            }
            
            /* Show labels on mobile */
            #poLineItems .line-item-row label {
                display: block !important;
                font-weight: 600 !important;
                margin-bottom: 5px !important;
                font-size: 14px !important;
                color: #555 !important;
            }
            
            /* Make selects and inputs full width */
            #poLineItems .line-item-row select,
            #poLineItems .line-item-row input[type="number"] {
                width: 100% !important;
                min-height: 52px !important;
                font-size: 16px !important;
                padding: 14px 12px !important;
                box-sizing: border-box !important;
                background: white !important;
                color: #333 !important;
                border: 2px solid var(--primary, #667eea) !important;
                border-radius: 8px !important;
            }
            
            /* Ensure select options are visible */
            #poLineItems .line-item-row select option {
                color: #333 !important;
                background: white !important;
            }
            
            /* Computed value divs - make them stand out with labels */
            #poLineItems .po-units,
            #poLineItems .po-totalunits,
            #poLineItems .po-cost,
            #poLineItems .po-linetotal {
                padding: 12px !important;
                font-size: 16px !important;
                text-align: left !important;
                border-radius: 8px !important;
                background: #f8f9fa !important;
            }
            
            /* Add labels before computed values */
            #poLineItems .po-units::before {
                content: "Units/Case: ";
                font-weight: 600;
                color: #555;
            }
            
            #poLineItems .po-totalunits::before {
                content: "Total Units: ";
                font-weight: 600;
                color: #555;
            }
            
            #poLineItems .po-cost::before {
                content: "Catalog Cost: ";
                font-weight: 600;
                color: #555;
            }
            
            #poLineItems .po-linetotal::before {
                content: "Line Total: ";
                font-weight: 600;
                color: #555;
            }
            
            /* Delete button full width */
            #poLineItems .line-item-row > button,
            #poLineItems .line-item-row .remove-btn {
                width: 100% !important;
                margin-top: 0 !important;
                padding: 14px !important;
                font-size: 16px !important;
            }
            
            /* ========== SALES ORDER LINE ITEMS MOBILE RESPONSIVE ========== */
            
            /* Make SO line items container not use grid border */
            #soLineItems {
                border: none !important;
                padding: 0 !important;
                background: transparent !important;
            }
            
            /* Make each SO line item a vertical card on mobile */
            #soLineItems .line-item-row {
                display: flex !important;
                flex-direction: column !important;
                grid-template-columns: unset !important;
                gap: 12px !important;
                padding: 15px !important;
                background: white !important;
                border: 2px solid var(--primary, #667eea) !important;
                border-radius: 12px !important;
                margin-bottom: 15px !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            }
            
            /* Each field container gets full width */
            #soLineItems .line-item-row > div {
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* Show labels on mobile */
            #soLineItems .line-item-row label {
                display: block !important;
                font-weight: 600 !important;
                margin-bottom: 5px !important;
                font-size: 14px !important;
                color: #555 !important;
                text-align: left !important;
            }
            
            /* Make selects and inputs full width with better touch targets */
            #soLineItems .line-item-row select,
            #soLineItems .line-item-row input[type="number"] {
                width: 100% !important;
                min-height: 52px !important;
                font-size: 16px !important;
                padding: 14px 12px !important;
                box-sizing: border-box !important;
                background: white !important;
                color: #333 !important;
                border: 2px solid var(--primary, #667eea) !important;
                border-radius: 8px !important;
            }
            
            /* Ensure select options are visible */
            #soLineItems .line-item-row select option {
                color: #333 !important;
                background: white !important;
                padding: 10px !important;
            }
            
            /* Stock info full width */
            #soLineItems .so-stock-info {
                grid-column: unset !important;
                width: 100% !important;
            }
            
            /* Remove button full width */
            #soLineItems .line-item-row > button,
            #soLineItems .line-item-row .remove-btn {
                width: 100% !important;
                margin-top: 0 !important;
                padding: 14px !important;
                font-size: 16px !important;
            }
            
            /* Make Add Sale Form summary cards stack */
            #addSaleForm .content-card > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            /* ========== ORDER MODAL LINE ITEMS MOBILE RESPONSIVE ========== */
            
            /* Make modal line items stack vertically */
            #orderModal .line-items-container {
                border: none !important;
                padding: 0 !important;
                background: transparent !important;
            }
            
            #orderModal .line-item-row,
            #orderModal .edit-line-item {
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
                padding: 15px !important;
                background: white !important;
                border: 2px solid var(--primary, #667eea) !important;
                border-radius: 12px !important;
                margin-bottom: 15px !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            }
            
            #orderModal .line-item-row > div,
            #orderModal .edit-line-item > div {
                width: 100% !important;
            }
            
            #orderModal .line-item-row label,
            #orderModal .edit-line-item label {
                display: block !important;
                font-weight: 600 !important;
                margin-bottom: 5px !important;
                font-size: 14px !important;
                color: #555 !important;
                text-align: left !important;
            }
            
            #orderModal .line-item-row select,
            #orderModal .line-item-row input,
            #orderModal .edit-line-item select,
            #orderModal .edit-line-item input {
                width: 100% !important;
                min-height: 52px !important;
                font-size: 16px !important;
            }
            
            #orderModal .line-item-row button,
            #orderModal .edit-line-item button {
                width: 100% !important;
                margin-top: 0 !important;
                padding: 14px !important;
                font-size: 16px !important;
            }
            
            /* Make order modal responsive - PORTRAIT MODE */
            #orderModal {
                overflow: hidden !important;
                padding: 0 !important;
            }
            
            #orderModal > div,
            #orderModalInner {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                max-width: 100% !important;
                max-height: 100% !important;
                min-width: 0 !important;
                min-height: 0 !important;
                margin: 0 !important;
                border-radius: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                resize: none !important;
                overflow: hidden !important;
            }
            
            #orderModalHeader {
                border-radius: 0 !important;
                flex-shrink: 0 !important;
                padding: 15px !important;
            }
            
            #modalContent {
                flex: 1 !important;
                min-height: 0 !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                touch-action: pan-y !important;
                overscroll-behavior: contain !important;
                padding: 15px !important;
            }
            
            #modalFooter {
                flex-shrink: 0 !important;
                padding: 12px 15px !important;
                border-top: 1px solid #ddd !important;
                background: white !important;
            }
        }
        
        /* Phones (480px and below) */
        @media (max-width: 480px) {
            /* Floating Settings Gear - even smaller on small phones */
            div[onclick="switchTab('config')"][style*="position: fixed"][style*="top: 20px"] {
                width: 40px !important;
                height: 40px !important;
                top: 10px !important;
                right: 10px !important;
            }
            
            div[onclick="switchTab('config')"][style*="position: fixed"] span {
                font-size: 18px !important;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .card {
                padding: 10px;
            }
            
            .form-group label {
                font-size: 14px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 10px;
            }
            
            /* Make table text smaller on very small screens */
            .data-table th,
            .data-table td {
                padding: 6px;
                font-size: 12px;
            }
            
            /* Smaller buttons on very small screens */
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            /* Responsive inventory summary numbers - smaller on mobile to prevent wrapping */
            .inv-summary-number {
                font-size: 18px !important; /* Much smaller on mobile */
            }
            
            /* Oval filter buttons - better mobile layout */
            .oval-filter-btn {
                font-size: 11px !important;
                padding: 6px 12px !important;
            }
            
            /* Sales page cards - reduce padding on mobile for better fit */
            .sales-filter-card {
                padding: 10px !important;
                margin-bottom: 15px !important;
            }
            
            .sales-data-card {
                padding: 12px !important;
            }
            
            /* Universal content cards - reduce padding on mobile */
            .content-card,
            .data-display-card {
                padding: 12px !important;
                margin-bottom: 15px !important;
            }
            
            .filter-card {
                padding: 10px !important;
                margin-bottom: 15px !important;
            }
            
            /* Report Modal - Mobile Optimizations */
            #reportSetupModal {
                padding: 0 !important;
            }
            
            /* Modal container - fixed, flex layout, no scroll */
            #reportSetupModal > div {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                margin: 0 !important;
                border-radius: 0 !important;
                overflow: hidden !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            #reportSetupHeader {
                position: relative !important;
                top: auto !important;
                z-index: 10 !important;
                padding: 12px 15px !important;
                flex-wrap: nowrap !important;
                flex-shrink: 0 !important;
            }
            
            #reportSetupHeader h2 {
                font-size: 16px !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                max-width: calc(100% - 50px) !important;
            }
            
            #reportSetupFilters {
                padding: 12px !important;
                margin-top: 0 !important;
                flex-shrink: 0 !important;
            }
            
            /* Content area - THIS SCROLLS */
            #reportSetupContent {
                flex: 1 !important;
                min-height: 0 !important;
                overflow-y: auto !important;
                overflow-x: auto !important; /* Changed: allow horizontal scroll for tables */
                -webkit-overflow-scrolling: touch !important;
                padding: 12px !important;
                padding-bottom: 80px !important;
            }
            
            /* Allow horizontal scroll on table containers inside reports */
            #reportSetupContent div[style*="overflow-x"],
            #reportSetupContent .table-wrapper,
            #reportSetupContent .data-table {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                touch-action: pan-x pan-y !important;
            }
            
            /* Report Modal Footer - Ensure buttons are visible */
            #reportSetupFooter {
                position: sticky !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                padding: 10px 12px !important;
                gap: 8px !important;
                z-index: 100 !important;
                flex-shrink: 0 !important;
                background: #f8f9fa !important;
                border-top: 2px solid #ddd !important;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
            }
        }
        
        /* Portrait orientation on mobile - standard scroll behavior */
        @media (max-width: 768px) and (orientation: portrait) {
            html, body {
                overflow-x: hidden;
                overflow-y: auto !important;
                height: auto !important;
                min-height: 100vh;
                position: static !important;
                width: 100% !important;
            }
            
            /* Override any stuck modal-open state on mobile */
            body.modal-open {
                position: static !important;
                overflow-y: auto !important;
            }
            
            #reportSetupModal {
                padding: 0 !important;
            }
            
            /* Modal container - fixed, no scroll */
            #reportSetupModal > div,
            #reportSetupModalInner {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                max-width: 100% !important;
                min-width: 0 !important; /* Override inline min-width: 500px */
                min-height: 0 !important; /* Override inline min-height */
                margin: 0 !important;
                border-radius: 0 !important;
                overflow: hidden !important; /* DON'T scroll here */
                display: flex !important;
                flex-direction: column !important;
                resize: none !important; /* Disable resize on mobile */
            }
            
            /* Header - fixed at top */
            #reportSetupHeader {
                position: relative !important;
                top: auto !important;
                flex-shrink: 0 !important;
                z-index: 10 !important;
                background: var(--primary, #667eea) !important;
                border-radius: 0 !important;
            }
            
            /* Filters area - below header */
            #reportSetupFilters {
                margin-top: 0 !important;
                flex-shrink: 0 !important;
            }
            
            /* CONTENT AREA - THIS IS WHAT SCROLLS */
            #reportSetupContent {
                flex: 1 !important;
                overflow-y: auto !important;
                overflow-x: auto !important; /* FIXED: Allow horizontal scroll for tables */
                -webkit-overflow-scrolling: touch !important;
                padding: 12px !important;
                padding-bottom: 80px !important;
                min-height: 0 !important; /* Important for flex scrolling */
                touch-action: pan-x pan-y !important; /* FIXED: Allow both directions */
                overscroll-behavior: contain !important; /* Prevent scroll chaining */
                contain: layout style !important; /* Contain layout to prevent escape */
            }
            
            /* Ensure tables inside reports can scroll horizontally */
            #reportSetupContent [style*="overflow-x"],
            #reportSetupContent .data-table-wrapper {
                touch-action: pan-x pan-y !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            /* ========== UNIVERSAL REPORT MOBILE STYLES ========== */
            
            /* All report headers - compact on mobile */
            #reportSetupContent [class*="-header"],
            #reportSetupContent .biz-header,
            #reportSetupContent .prod-header {
                padding: 15px !important;
                margin-bottom: 15px !important;
                border-radius: 10px !important;
            }
            
            #reportSetupContent [class*="-header"] h2,
            #reportSetupContent .biz-header h2 {
                font-size: 18px !important;
                margin-bottom: 5px !important;
            }
            
            #reportSetupContent [class*="-header"] p {
                font-size: 12px !important;
            }
            
            /* KPI grids - stack on mobile */
            #reportSetupContent [class*="-kpi-grid"],
            #reportSetupContent .biz-kpi-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            /* KPI cards - compact */
            #reportSetupContent [class*="-kpi-card"],
            #reportSetupContent .biz-kpi-card {
                padding: 12px !important;
                border-radius: 8px !important;
            }
            
            #reportSetupContent [class*="-kpi-card"] [style*="font-size: 24"],
            #reportSetupContent [class*="-kpi-card"] [style*="font-size: 28"],
            #reportSetupContent .biz-kpi-card div[style*="font-size"] {
                font-size: 18px !important;
            }
            
            /* Section containers */
            #reportSetupContent [class*="-section"],
            #reportSetupContent .biz-section {
                padding: 15px !important;
                margin-bottom: 15px !important;
                border-radius: 10px !important;
            }
            
            #reportSetupContent [class*="-section"] h3,
            #reportSetupContent .biz-section h3 {
                font-size: 16px !important;
                margin-bottom: 10px !important;
            }
            
            /* All tables in reports */
            #reportSetupContent table {
                font-size: 11px !important;
            }
            
            #reportSetupContent th,
            #reportSetupContent td {
                padding: 8px 6px !important;
            }
            
            /* Bar charts in reports */
            #reportSetupContent [style*="height: 20px"][style*="background"],
            #reportSetupContent .bar-chart-bar {
                height: 16px !important;
            }
            
            /* Action Dashboard specific containment */
            #reportSetupContent .action-dashboard-container {
                width: 100% !important;
                max-width: 100% !important;
                overflow: visible !important;
            }
            
            #reportSetupContent .action-section {
                max-width: 100% !important;
                overflow-x: auto !important;
            }
            
            #reportSetupContent table {
                max-width: 100% !important;
                display: block !important;
                overflow-x: auto !important;
            }
            
            /* Prevent touch issues on modal */
            #reportSetupModalInner,
            #reportSetupModal > div {
                touch-action: auto !important;
                overscroll-behavior: contain !important;
            }
            
            /* Ensure canvases don't capture touch events */
            #reportSetupContent canvas {
                touch-action: none !important;
                pointer-events: none !important;
            }
            
            /* Chart grid on mobile - single column */
            #reportSetupContent div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Constrain chart containers on mobile */
            #reportSetupContent canvas {
                max-width: 100% !important;
                max-height: 180px !important;
                width: 100% !important;
            }
            
            #reportSetupContent canvas.print-chart {
                max-width: 100% !important;
                height: auto !important;
                max-height: 180px !important;
                width: 100% !important;
            }
            
            /* Chart container divs - allow legend to show */
            #reportSetupContent div[style*="height: 250px"],
            #reportSetupContent div[style*="height: 200px"] {
                min-height: 200px !important;
                position: relative !important;
            }
            
            /* Chart card containers */
            #reportSetupContent div[style*="box-shadow"] {
                max-width: 100% !important;
            }
            
            /* Footer - fixed at bottom */
            #reportSetupFooter {
                position: sticky !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                border-radius: 0 !important;
                z-index: 100 !important;
                flex-shrink: 0 !important;
                background: #f8f9fa !important;
                border-top: 2px solid #ddd !important;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
            }
        }
        
        /* Landscape orientation on mobile devices */
        @media (max-height: 600px) and (orientation: landscape) {
            
            /* ========== UNIVERSAL TAB LANDSCAPE STYLES ========== */
            
            /* All main tabs - compact in landscape */
            #invflow, #reports, #guides, #config, #pricesim, #inventory,
            #suppliers, #items, #customers, #createpo, #purchases, #sales {
                padding: 8px !important;
            }
            
            /* Card titles */
            .card > h2 {
                font-size: 16px !important;
                margin-bottom: 8px !important;
            }
            
            .card > p {
                font-size: 11px !important;
                margin-bottom: 10px !important;
            }
            
            /* Content cards in landscape */
            .content-card {
                padding: 8px !important;
                margin-bottom: 10px !important;
            }
            
            .content-card h3 {
                font-size: 13px !important;
                margin-bottom: 8px !important;
            }
            
            /* Metric grids - 4 columns in landscape */
            .content-card > div[style*="grid-template-columns"],
            div[style*="grid-template-columns: repeat(auto-fit"] {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 8px !important;
            }
            
            /* Metric cards - very compact */
            .content-card div[style*="text-align: center"][style*="padding"] {
                padding: 8px !important;
            }
            
            .content-card div[style*="font-size: 32px"],
            .content-card div[style*="font-size: 36px"] {
                font-size: 18px !important;
            }
            
            .content-card div[style*="font-size: 14px"] {
                font-size: 10px !important;
            }
            
            /* Tables in landscape */
            .content-card table {
                font-size: 10px !important;
            }
            
            .content-card th,
            .content-card td {
                padding: 4px 3px !important;
            }
            
            /* Buttons compact */
            .btn-small {
                padding: 5px 8px !important;
                font-size: 11px !important;
            }
            
            /* Other modals in landscape */
            #howToGuideModal > div,
            #uploadItemsModal > div,
            #tutorialModal > div {
                width: 100% !important;
                height: 100% !important;
                max-width: 100% !important;
                max-height: 100% !important;
                margin: 0 !important;
                border-radius: 0 !important;
                overflow-y: auto !important;
            }
            
            /* ORDER MODAL (PO/SO Edit) in Landscape - LOCKED FULL SCREEN */
            #orderModal {
                overflow: hidden !important;
            }
            
            #orderModal > div,
            #orderModalInner {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                max-width: 100% !important;
                min-width: 0 !important;
                min-height: 0 !important;
                margin: 0 !important;
                border-radius: 0 !important;
                overflow: hidden !important;
                display: flex !important;
                flex-direction: column !important;
                resize: none !important;
            }
            
            #orderModalHeader {
                position: relative !important;
                flex-shrink: 0 !important;
                padding: 8px 15px !important;
                border-radius: 0 !important;
            }
            
            #orderModalHeader h2 {
                font-size: 14px !important;
            }
            
            #modalContent {
                flex: 1 !important;
                min-height: 0 !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                padding: 10px !important;
                touch-action: pan-y !important;
                overscroll-behavior: contain !important;
            }
            
            #modalFooter {
                position: relative !important;
                flex-shrink: 0 !important;
                padding: 8px 12px !important;
                gap: 6px !important;
            }
            
            #modalFooter .btn {
                padding: 8px 12px !important;
                font-size: 12px !important;
            }
            
            /* Compact content cards in landscape order modal */
            #modalContent .content-card {
                padding: 10px !important;
                margin-bottom: 10px !important;
            }
            
            #modalContent .content-card h3 {
                font-size: 13px !important;
                margin-bottom: 8px !important;
                padding-bottom: 5px !important;
            }
            
            #modalContent table td,
            #modalContent table th {
                padding: 4px 6px !important;
                font-size: 11px !important;
            }
            
            /* Line items compact in landscape */
            #orderModal .line-item-row,
            #orderModal .edit-line-item {
                padding: 8px !important;
                margin-bottom: 8px !important;
                gap: 8px !important;
            }
            
            #orderModal .line-item-row select,
            #orderModal .line-item-row input,
            #orderModal .edit-line-item select,
            #orderModal .edit-line-item input {
                min-height: 40px !important;
                font-size: 13px !important;
                padding: 6px !important;
            }
            
            #orderModal .line-item-row label,
            #orderModal .edit-line-item label {
                font-size: 11px !important;
                margin-bottom: 3px !important;
            }
            
            /* Report Modal in Landscape - proper scrolling */
            #reportSetupModal > div,
            #reportSetupModalInner {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                max-width: 100% !important;
                min-width: 0 !important;
                min-height: 0 !important;
                margin: 0 !important;
                border-radius: 0 !important;
                overflow: hidden !important;
                display: flex !important;
                flex-direction: column !important;
                resize: none !important;
            }
            
            #reportSetupHeader {
                position: relative !important;
                flex-shrink: 0 !important;
                padding: 8px 12px !important;
            }
            
            #reportSetupHeader h2 {
                font-size: 14px !important;
            }
            
            #reportSetupFilters {
                margin-top: 0 !important;
                flex-shrink: 0 !important;
                padding: 8px !important;
            }
            
            #reportSetupContent {
                flex: 1 !important;
                min-height: 0 !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                padding: 8px !important;
                padding-bottom: 60px !important;
                touch-action: pan-y !important;
                overscroll-behavior: contain !important;
            }
            
            /* ========== LANDSCAPE REPORT CONTENT STYLES ========== */
            
            /* Report headers - very compact in landscape */
            #reportSetupContent [class*="-header"],
            #reportSetupContent .biz-header,
            #reportSetupContent .action-dashboard-container > div:first-child {
                padding: 10px 15px !important;
                margin-bottom: 10px !important;
            }
            
            #reportSetupContent [class*="-header"] h2,
            #reportSetupContent .biz-header h2 {
                font-size: 14px !important;
            }
            
            #reportSetupContent [class*="-header"] p {
                font-size: 10px !important;
                margin: 0 !important;
            }
            
            /* KPI grids in landscape - 4 columns */
            #reportSetupContent [class*="-kpi-grid"],
            #reportSetupContent .biz-kpi-grid {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 8px !important;
            }
            
            /* KPI cards - very compact */
            #reportSetupContent [class*="-kpi-card"],
            #reportSetupContent .biz-kpi-card {
                padding: 8px !important;
            }
            
            #reportSetupContent [class*="-kpi-card"] [style*="font-size"],
            #reportSetupContent .biz-kpi-card div[style*="font-size"] {
                font-size: 14px !important;
            }
            
            /* Section containers - compact */
            #reportSetupContent [class*="-section"],
            #reportSetupContent .biz-section,
            #reportSetupContent .action-section {
                padding: 10px !important;
                margin-bottom: 10px !important;
            }
            
            #reportSetupContent [class*="-section"] h3,
            #reportSetupContent .biz-section h3 {
                font-size: 13px !important;
                margin-bottom: 8px !important;
            }
            
            /* Tables very compact in landscape */
            #reportSetupContent table {
                font-size: 10px !important;
            }
            
            #reportSetupContent th,
            #reportSetupContent td {
                padding: 4px 6px !important;
            }
            
            /* Charts smaller in landscape */
            #reportSetupContent canvas {
                max-height: 120px !important;
            }
            
            /* ========== DASHBOARD REPORT CARDS - LANDSCAPE FIX ========== */
            /* Fix Top 10 lists and dashboard grids being cut off in landscape */
            
            /* Dashboard card grids - single column in landscape */
            #reportSetupContent [style*="grid-template-columns: repeat(auto-fit"],
            #reportSetupContent [style*="grid-template-columns: repeat(2"],
            #reportSetupContent [style*="display: grid"] {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            /* Dashboard cards - full width, proper overflow */
            .daily-dash-card,
            .biz-dash-card,
            .prod-dash-card,
            .supplier-dash-card,
            #reportSetupContent > div > div[style*="background: #f8fafc"],
            #reportSetupContent > div > div[style*="border-radius: 12px"] {
                width: 100% !important;
                max-width: 100% !important;
                min-width: 0 !important;
                overflow: hidden !important;
                box-sizing: border-box !important;
            }
            
            /* Bar chart lists - proper overflow handling */
            .daily-dash-bar-list,
            .biz-dash-bar-list,
            .prod-dash-bar-list,
            .supplier-dash-bar-list,
            [class*="-bar-list"] {
                width: 100% !important;
                max-width: 100% !important;
                overflow: hidden !important;
            }
            
            /* Bar items - proper flex layout */
            .daily-dash-bar-item,
            .biz-dash-bar-item,
            .prod-dash-bar-item,
            .supplier-dash-bar-item,
            [class*="-bar-item"] {
                width: 100% !important;
                max-width: 100% !important;
                flex-wrap: nowrap !important;
                overflow: hidden !important;
            }
            
            /* Labels narrower in landscape */
            .daily-dash-bar-label,
            .biz-dash-bar-label,
            .prod-dash-bar-label,
            .supplier-dash-bar-label,
            [class*="-bar-label"] {
                width: 80px !important;
                min-width: 80px !important;
                max-width: 80px !important;
            }
            
            /* Values narrower in landscape */
            .daily-dash-bar-value,
            .biz-dash-bar-value,
            .prod-dash-bar-value,
            .supplier-dash-bar-value,
            [class*="-bar-value"] {
                width: 55px !important;
                min-width: 55px !important;
                max-width: 55px !important;
                font-size: 10px !important;
            }
            
            /* Titles smaller in landscape */
            .daily-dash-bar-title,
            .biz-dash-bar-title,
            .prod-dash-bar-title,
            .supplier-dash-bar-title,
            [class*="-bar-title"] {
                font-size: 10px !important;
            }
            
            /* Subtitles smaller */
            .daily-dash-bar-sub,
            .biz-dash-bar-sub,
            .prod-dash-bar-sub,
            .supplier-dash-bar-sub,
            [class*="-bar-sub"] {
                font-size: 8px !important;
            }
            
            /* Track minimum width smaller */
            .daily-dash-bar-track,
            .biz-dash-bar-track,
            .prod-dash-bar-track,
            .supplier-dash-bar-track,
            [class*="-bar-track"] {
                min-width: 30px !important;
            }
            
            /* Quick stats grid - 2 columns */
            .daily-dash-quick-stats,
            .biz-dash-quick-stats,
            .prod-dash-quick-stats,
            .supplier-dash-quick-stats,
            [class*="-quick-stats"] {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 6px !important;
            }
            
            /* Quick stat items smaller */
            .daily-dash-quick-stat,
            .biz-dash-quick-stat,
            .prod-dash-quick-stat,
            .supplier-dash-quick-stat,
            [class*="-quick-stat"] {
                padding: 6px 8px !important;
            }
            
            [class*="-quick-label"] {
                font-size: 9px !important;
            }
            
            [class*="-quick-value"] {
                font-size: 11px !important;
            }
            
            /* Card titles smaller */
            .daily-dash-card-title,
            .biz-dash-card-title,
            .prod-dash-card-title,
            .supplier-dash-card-title,
            [class*="-card-title"] {
                font-size: 13px !important;
                margin-bottom: 8px !important;
            }
            
            [class*="-card-title"] .icon {
                width: 24px !important;
                height: 24px !important;
                font-size: 12px !important;
            }

            #reportSetupFooter {
                position: relative !important;
                flex-shrink: 0 !important;
                padding: 6px 10px !important;
            }
            
            html, body {
                overflow-x: auto;
                overflow-y: auto;
                height: auto;
                min-height: 100vh;
            }
            
            body {
                padding: 5px;
                min-height: 100vh;
                height: auto;
            }
            
            /* Floating Settings Gear - compact in landscape */
            div[onclick="switchTab('config')"][style*="position: fixed"][style*="top: 20px"] {
                width: 35px !important;
                height: 35px !important;
                top: 8px !important;
                right: 8px !important;
            }
            
            div[onclick="switchTab('config')"][style*="position: fixed"] span {
                font-size: 16px !important;
            }
            
            .container {
                max-width: 100%;
                padding: 0 5px;
                height: auto;
            }
            
            .header {
                margin-bottom: 5px;
            }
            
            .header h1 {
                font-size: 1.1em;
                margin-bottom: 3px;
            }
            
            .header p {
                font-size: 0.75em;
                margin: 0;
            }
            
            /* CRITICAL: Make navigation single-row horizontal scroll in landscape */
            /* Outer wrapper - reduce padding dramatically */
            body > .container > div[style*="position: static"][style*="border: 3px solid"] {
                padding: 2px !important;
                margin: 0px 2px 5px 2px !important;
                border-width: 2px !important;
            }
            
            /* Inner grid container - make it horizontal scroll with ALL cards in ONE row */
            body > .container > div[style*="position: static"] > div[style*="grid-template-columns"] {
                display: flex !important;
                flex-direction: row !important;
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                gap: 4px !important;
                padding: 4px 6px !important;
                scrollbar-width: thin !important;
            }
            
            /* Navigation cards - compact size for landscape */
            .landing-nav-card {
                flex: 0 0 auto !important;
                min-width: 60px !important;
                max-width: 60px !important;
                padding: 4px 3px !important;
                margin: 0 !important;
            }
            
            .landing-nav-card div[style*="font-size: 24px"] {
                font-size: 18px !important;
                margin-bottom: 2px !important;
            }
            
            .landing-nav-card h3 {
                font-size: 8px !important;
                line-height: 1.2 !important;
                margin: 0 !important;
            }
            
            .tabs {
                margin-bottom: 5px;
                gap: 3px;
            }
            
            .tab {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .card {
                padding: 8px;
                height: auto;
                max-height: none !important;
                overflow-y: visible !important;
            }
            
            /* Make tables scroll horizontally in landscape */
            .data-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
                max-width: 100%;
            }
            
            .data-table th,
            .data-table td {
                padding: 6px 8px;
                font-size: 11px;
            }
            
            /* Compact form fields in landscape */
            .form-group {
                margin-bottom: 8px;
            }
            
            .form-group label {
                font-size: 12px;
                margin-bottom: 3px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 6px;
                font-size: 14px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .btn-small {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            /* Reduce spacing in landscape */
            .form-grid {
                gap: 8px;
            }
            
            /* CRITICAL: Picker modals in landscape mode */
            /* Full-screen pickers (item, supplier, customer, invoice) */
            .item-picker-container:not(.styled-modal-container) {
                width: 100% !important;
                height: 100% !important;
                max-width: 100% !important;
                max-height: 100% !important;
                margin: 0 !important;
                border-radius: 0 !important;
            }
            
            /* Centered dialog modals (alert, confirm, status, reason, uom) */
            .styled-modal-container {
                width: 85% !important;
                max-width: 400px !important;
                height: auto !important;
                max-height: 70vh !important;
                margin: auto !important;
                border-radius: 12px !important;
            }
            
            /* Ensure overlay uses flex for centering styled modals */
            .item-picker-overlay:has(.styled-modal-container) {
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            .item-picker-header {
                padding: 10px 15px !important;
            }
            
            .item-picker-header h3 {
                font-size: 16px !important;
            }
            
            .item-picker-search {
                padding: 8px 10px !important;
            }
            
            .item-picker-search input {
                padding: 10px 12px !important;
                font-size: 14px !important;
            }
            
            .item-picker-list {
                padding: 5px !important;
            }
            
            .item-picker-card {
                padding: 10px !important;
                margin-bottom: 6px !important;
            }
            
            .item-picker-footer {
                padding: 8px 12px !important;
            }
            
            /* Theme picker special - needs more width */
            #themePickerModal .item-picker-container {
                max-width: 95% !important;
                width: 95% !important;
                height: 90vh !important;
                max-height: 90vh !important;
                margin: 2vh auto !important;
            }
            
            /* Report modal in landscape - full screen */
            #reportModal > div,
            #reportModalContent {
                width: 100% !important;
                height: 100% !important;
                max-width: 100% !important;
                max-height: 100% !important;
                margin: 0 !important;
                border-radius: 0 !important;
            }
            
            /* Success modal compact in landscape */
            #successModal > div {
                max-width: 80% !important;
                padding: 15px !important;
            }
        }
        
        /* ==================== COMPLETE THEME SYSTEM ==================== */
        
        /* Ocean Blue Theme */
        body.theme-ocean {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
        }
        body.theme-ocean .btn,
        body.theme-ocean .btn-small {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
        }
        body.theme-ocean .btn-success {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%) !important;
        }
        body.theme-ocean .btn-danger {
            background: linear-gradient(135deg, #b91c1c 0%, #b88a8a 100%) !important;
        }
        body.theme-ocean .tab.active {
            color: #1e3c72 !important;
        }
        body.theme-ocean .tab:hover {
            background: rgba(30, 60, 114, 0.3) !important;
        }
        
        /* Forest Green Theme */
        body.theme-forest {
            background: linear-gradient(135deg, #134e4a 0%, #059669 100%) !important;
        }
        body.theme-forest .btn,
        body.theme-forest .btn-small {
            background: linear-gradient(135deg, #134e4a 0%, #059669 100%) !important;
        }
        body.theme-forest .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%) !important;
        }
        body.theme-forest .btn-danger {
            background: linear-gradient(135deg, #b91c1c 0%, #b88a8a 100%) !important;
        }
        body.theme-forest .tab.active {
            color: #134e4a !important;
        }
        body.theme-forest .tab:hover {
            background: rgba(19, 78, 74, 0.3) !important;
        }
        
        /* Sunset Orange Theme */
        body.theme-sunset {
            background: linear-gradient(135deg, #c2410c 0%, #ea580c 100%) !important;
        }
        body.theme-sunset .btn,
        body.theme-sunset .btn-small {
            background: linear-gradient(135deg, #c2410c 0%, #ea580c 100%) !important;
        }
        body.theme-sunset .btn-success {
            background: linear-gradient(135deg, #ea580c 0%, #b8a07a 100%) !important;
        }
        body.theme-sunset .btn-danger {
            background: linear-gradient(135deg, #991b1b 0%, #b91c1c 100%) !important;
        }
        body.theme-sunset .tab.active {
            color: #c2410c !important;
        }
        body.theme-sunset .tab:hover {
            background: rgba(194, 65, 12, 0.3) !important;
        }
        
        /* Professional Dark Theme */
        body.theme-dark {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%) !important;
        }
        body.theme-dark .btn,
        body.theme-dark .btn-small {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%) !important;
        }
        body.theme-dark .btn-success {
            background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%) !important;
        }
        body.theme-dark .btn-danger {
            background: linear-gradient(135deg, #991b1b 0%, #b91c1c 100%) !important;
        }
        body.theme-dark .tab {
            background: rgba(255, 255, 255, 0.15) !important;
        }
        body.theme-dark .tab.active {
            background: white !important;
            color: #1f2937 !important;
            border-left: 4px solid #c0c0c0 !important;
        }
        body.theme-dark .tab:hover {
            background: rgba(255, 255, 255, 0.25) !important;
        }
        body.theme-dark .card {
            background: #f9fafb !important;
        }
        
        /* Crimson Red Theme */
        body.theme-crimson {
            background: linear-gradient(135deg, #be123c 0%, #e11d48 100%) !important;
        }
        body.theme-crimson .btn,
        body.theme-crimson .btn-small {
            background: linear-gradient(135deg, #be123c 0%, #e11d48 100%) !important;
        }
        body.theme-crimson .btn-success {
            background: linear-gradient(135deg, #6b9a8d 0%, #6b9a8d 100%) !important;
        }
        body.theme-crimson .tab.active {
            color: #be123c !important;
        }
        body.theme-crimson .tab:hover {
            background: rgba(190, 18, 60, 0.3) !important;
        }
        
        /* Slate Gray Theme */
        body.theme-slate {
            background: linear-gradient(135deg, #475569 0%, #64748b 100%) !important;
        }
        body.theme-slate .btn,
        body.theme-slate .btn-small {
            background: linear-gradient(135deg, #475569 0%, #64748b 100%) !important;
        }
        body.theme-slate .btn-success {
            background: linear-gradient(135deg, #6b9a8d 0%, #6b9a8d 100%) !important;
        }
        body.theme-slate .tab.active {
            color: #475569 !important;
        }
        body.theme-slate .tab:hover {
            background: rgba(71, 85, 105, 0.3) !important;
        }
        
        /* Teal Theme */
        body.theme-teal {
            background: linear-gradient(135deg, #6b9a8d 0%, #14b8a6 100%) !important;
        }
        body.theme-teal .btn,
        body.theme-teal .btn-small {
            background: linear-gradient(135deg, #6b9a8d 0%, #14b8a6 100%) !important;
        }
        body.theme-teal .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%) !important;
        }
        body.theme-teal .tab.active {
            color: #6b9a8d !important;
        }
        body.theme-teal .tab:hover {
            background: rgba(13, 148, 136, 0.3) !important;
        }
        
        /* Royal Purple Theme (Default) */
        body.theme-purple {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        body.theme-purple .btn,
        body.theme-purple .btn-small {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        body.theme-purple .btn-success {
            background: linear-gradient(135deg, #764ba2 0%, #9333ea 100%) !important;
        }
        body.theme-purple .btn-danger {
            background: linear-gradient(135deg, #b91c1c 0%, #b88a8a 100%) !important;
        }
        body.theme-purple .tab.active {
            color: #667eea !important;
        }
        body.theme-purple .tab:hover {
            background: rgba(102, 126, 234, 0.3) !important;
        }
        
        
        /* Landing Page Navigation Cards */
        .landing-nav-card {
            transform: translateY(0) scale(1);
        }
        
        .landing-nav-card:hover {
            transform: translateY(-8px) scale(1.02) !important;
            box-shadow: 0 12px 30px rgba(0,0,0,0.2) !important;
        }
        
        .landing-nav-card:active {
            transform: translateY(-4px) scale(1.01) !important;
        }
        
        /* Navigation Container - Uses dynamic CSS variable to match card theme */
        .nav-container {
            background: transparent !important; /* Transparent to show body background */
            border-radius: 0;
            margin: 0 -20px; /* Extend to edges to blend with body */
            padding: 10px 40px 20px 40px;
        }
        
        /* Desktop Modal Features - Draggable & Resizable */
        @media (min-width: 769px) {
            /* Add resize handle indicator to modals on desktop */
            .resizable-added::after {
                content: '';
                position: absolute;
                bottom: 5px;
                right: 5px;
                font-size: 20px;
                color: #999;
                pointer-events: none;
                line-height: 1;
            }
            
            /* Center modals initially (before dragging) */
            #orderModal > div:not(.modal-dragged),
            #orderModalInner:not(.modal-dragged),
            #reportSetupModal > div:not(.modal-dragged),
            #reportSetupModalInner:not(.modal-dragged),
            .item-picker-container:not(.modal-dragged) {
                position: relative;
                margin: 50px auto !important;
            }
            
            /* When modal is being dragged or has been dragged, use fixed positioning */
            .modal-dragged {
                position: fixed !important;
                margin: 0 !important;
            }
        }
        
        /* Mobile - keep modals full screen friendly */
        @media (max-width: 768px) {
            /* Modal containers - allow inner content to scroll */
            #orderModal,
            #reportSetupModal,
            #howToGuideModal,
            #uploadItemsModal,
            #itemPickerModal,
            #customerPickerModal,
            #supplierPickerModal {
                padding: 0 !important;
                z-index: 99999 !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
            }
            
            /* Inner modal content - base positioning (flex containers handle their own scrolling) */
            #orderModal > div,
            #orderModalInner,
            #howToGuideModal > div,
            #uploadItemsModal > div,
            .item-picker-container {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
                max-height: 100% !important;
                min-width: 0 !important;
                min-height: 0 !important;
                width: 100% !important;
                height: 100% !important;
                transform: none !important;
                border-radius: 0 !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
                z-index: 100000 !important;
                resize: none !important; /* Disable resize on mobile */
            }
            
            /* Report modal inner - FLEX CONTAINER, does NOT scroll itself */
            /* Header stays fixed, only content area scrolls */
            #reportSetupModal > div,
            #reportSetupModalInner {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
                max-height: 100% !important;
                min-width: 0 !important;
                min-height: 0 !important;
                width: 100% !important;
                height: 100% !important;
                transform: none !important;
                border-radius: 0 !important;
                overflow: hidden !important; /* CRITICAL: Don't scroll here */
                display: flex !important;
                flex-direction: column !important;
                z-index: 100000 !important;
                resize: none !important;
            }
        }
        
        /* Modal resize handle styles */
        #orderModalInner,
        #reportSetupModalInner {
            position: relative;
        }
        
        #orderModalInner::after,
        #reportSetupModalInner::after {
            content: '';
            position: absolute;
            bottom: 5px;
            right: 8px;
            font-size: 14px;
            color: #aaa;
            pointer-events: none;
        }
        
        #orderModalInner:hover::after,
        #reportSetupModalInner:hover::after {
            color: #667eea;
        }
        
        /* Maximized modal - full screen */
        #reportSetupModalInner.modal-maximized {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            min-width: 0 !important;
            min-height: 0 !important;
            margin: 0 !important;
            border-radius: 0 !important;
            resize: none !important;
        }
        
        #reportSetupModalInner.modal-maximized::after {
            display: none;
        }
        
        /* ==================== IN-PLACE PRINT STYLES ==================== */
        @media print {
            /* ========================================
               COMPREHENSIVE REPORT PRINT STYLES
               ======================================== */
            
            /* CRITICAL: Reset ALL elements to static flow */
            * {
                position: static !important;
                transform: none !important;
                float: none !important;
            }
            
            /* Hide EVERYTHING first */
            body > * {
                display: none !important;
            }
            
            /* Show only the report modal */
            #reportSetupModal {
                display: block !important;
                position: static !important;
                left: auto !important;
                top: auto !important;
                transform: none !important;
                width: 100% !important;
                height: auto !important;
                max-height: none !important;
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
                z-index: auto !important;
            }
            
            /* Reset body */
            body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                overflow: visible !important;
                height: auto !important;
                width: 100% !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }
            
            html {
                overflow: visible !important;
                height: auto !important;
            }
            
            /* Modal inner container - RESET ALL POSITIONING FOR PRINT */
            #reportSetupModalInner {
                position: static !important;
                top: auto !important;
                left: auto !important;
                transform: none !important;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                max-height: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                overflow: visible !important;
                display: block !important;
            }
            
            /* Hide modal UI elements */
            #reportSetupHeader,
            #reportSetupFilters,
            #reportSetupFooter,
            .report-setup-header,
            .report-setup-filters,
            .report-setup-footer {
                display: none !important;
            }
            
            /* Report content - CENTERED and properly styled */
            #reportSetupContent {
                padding: 0.25in 0.5in !important;
                overflow: visible !important;
                height: auto !important;
                max-height: none !important;
                min-height: 0 !important;
                display: block !important;
                position: static !important;
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 auto !important;
                box-sizing: border-box !important;
            }
            
            /* Hide ALL scrollbars in print */
            *::-webkit-scrollbar {
                display: none !important;
                width: 0 !important;
                height: 0 !important;
            }
            
            * {
                scrollbar-width: none !important;
                -ms-overflow-style: none !important;
            }
            
            #reportSetupContent *::-webkit-scrollbar {
                display: none !important;
                width: 0 !important;
                height: 0 !important;
            }
            
            #reportSetupContent * {
                scrollbar-width: none !important;
                -ms-overflow-style: none !important;
            }
            
            /* Force overflow visible on all elements for multi-page printing */
            #reportSetupContent,
            #reportSetupContent div,
            #reportSetupContent section,
            #reportSetupModalInner {
                overflow: visible !important;
                overflow-x: visible !important;
                overflow-y: visible !important;
                max-height: none !important;
                height: auto !important;
            }
            
            /* CHARTS - Show images, hide canvases */
            canvas {
                display: none !important;
            }
            
            .print-chart-image {
                display: block !important;
                max-width: 100% !important;
                height: auto !important;
                margin: 15px auto !important;
                page-break-inside: avoid !important;
            }
            
            /* Chart containers - center them */
            .biz-chart-container,
            .chart-container,
            [class*="chart"] {
                text-align: center !important;
                page-break-inside: avoid !important;
            }
            
            /* Tables - full width and centered */
            table {
                width: 100% !important;
                border-collapse: collapse !important;
                font-size: 9pt !important;
                page-break-inside: auto !important;
                margin: 10px 0 !important;
            }
            
            thead {
                display: table-header-group !important;
            }
            
            tbody {
                display: table-row-group !important;
            }
            
            tr {
                page-break-inside: avoid !important;
            }
            
            th {
                background: #333 !important;
                color: white !important;
                padding: 6px !important;
                font-size: 9pt !important;
                border: 1px solid #333 !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }
            
            td {
                border: 1px solid #ccc !important;
                padding: 4px 6px !important;
                font-size: 9pt !important;
            }
            
            /* Prevent page breaks in these elements */
            h1, h2, h3, h4 {
                page-break-after: avoid !important;
            }
            
            p, li, .content-card, .biz-section, .backorder-section, .action-section {
                page-break-inside: avoid !important;
            }
            
            /* KPI grids - keep colors */
            .biz-kpi-grid, .backorder-kpi-grid, .pl-summary {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 10px !important;
                justify-content: center !important;
            }
            
            .biz-kpi, .backorder-kpi, .pl-stat {
                flex: 1 1 120px !important;
                padding: 8px !important;
                border: 1px solid #ccc !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }
            
            /* Summary cards - preserve styling */
            .summary-grid, .period-grid {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 10px !important;
                justify-content: center !important;
            }
            
            .summary-card, .period-card {
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }
            
            /* Hide interactive elements */
            button, .btn, .create-po-btn, .oval-action-btn, 
            input[type="number"], input[type="checkbox"], 
            .pl-print-btn, .toggle-section-btn {
                display: none !important;
            }
            
            /* Preserve gradients and colors for presentation reports */
            .pres-header, .partnership-box {
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }
            
            /* Product rows */
            .product-row {
                border: 1px solid #eee !important;
                padding: 8px !important;
                margin: 5px 0 !important;
                page-break-inside: avoid !important;
            }
            
            /* Links - plain text */
            a {
                color: #333 !important;
                text-decoration: none !important;
            }
            
            /* Collapsible sections - ALWAYS show when printing */
            .collapsible-content,
            [class*="collapsible"] {
                display: block !important;
                max-height: none !important;
                overflow: visible !important;
            }
            
            /* Force show ALL divs inside report content that might be hidden */
            #reportSetupContent div[style*="display: none"],
            #reportSetupContent div[style*="display:none"] {
                display: block !important;
            }
            
            /* Force grid layouts to show */
            #reportSetupContent div[style*="display: grid"],
            #reportSetupContent div[style*="display:grid"] {
                display: grid !important;
            }
            
            /* Toggle icons - hide them */
            .toggle-icon {
                display: none !important;
            }
            
            /* Hide "click to hide/show" text */
            #reportSetupContent span[style*="click to hide"] {
                display: none !important;
            }
            
            /* Page setup */
            @page {
                margin: 0.4in;
                size: auto;
            }
        }
        
        /* ==================== GLOBAL HORIZONTAL OVERFLOW PREVENTION ==================== */
        /* This ensures ALL report content stays within the viewport horizontally */
        
        #reportSetupContent {
            overflow-x: hidden !important;
        }
        
        #reportSetupContent > div,
        #reportSetupContent > div > div {
            max-width: 100% !important;
            box-sizing: border-box !important;
        }
        
        /* All grid containers in reports must not overflow */
        #reportSetupContent [style*="grid"],
        #reportSetupContent [style*="display: grid"] {
            max-width: 100% !important;
            overflow: hidden !important;
        }
        
        /* All flex containers in reports must not overflow */
        #reportSetupContent [style*="flex"],
        #reportSetupContent [style*="display: flex"] {
            max-width: 100% !important;
            overflow: hidden !important;
        }
        
        /* Dashboard cards and similar report sections */
        #reportSetupContent [class*="-card"],
        #reportSetupContent [class*="-section"],
        #reportSetupContent [class*="-container"] {
            max-width: 100% !important;
            overflow: hidden !important;
            box-sizing: border-box !important;
        }
        
        /* Bar chart lists */
        #reportSetupContent [class*="-bar-list"],
        #reportSetupContent [class*="-bar-item"] {
            max-width: 100% !important;
            overflow: hidden !important;
        }
        
        /* KPI grids */
        #reportSetupContent [class*="-kpi"],
        #reportSetupContent [class*="-stats"],
        #reportSetupContent [class*="-summary"] {
            max-width: 100% !important;
            overflow: hidden !important;
        }
        
        /* Chart containers - allow vertical but not horizontal */
        #reportSetupContent [style*="border-radius"][style*="padding"],
        #reportSetupContent [style*="box-shadow"] {
            max-width: 100% !important;
            box-sizing: border-box !important;
        }
        
        /* Tables are allowed to scroll horizontally within their wrapper */
        #reportSetupContent div[style*="overflow-x: auto"] {
            max-width: 100% !important;
        }
        
        #reportSetupContent div[style*="overflow-x: auto"] table {
            /* Table can be wider than container, wrapper handles scroll */
        }
    </style>
    <link rel="stylesheet" href="sports-themes.css">
    <!-- Chart.js for report visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Chart.js DataLabels plugin for showing values ON charts -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script>
        // Disable ALL Chart.js animations globally to prevent looping
        Chart.defaults.animation = false;
        Chart.defaults.animations = {
            colors: false,
            x: false,
            y: false
        };
        Chart.defaults.transitions = {
            active: { animation: { duration: 0 } },
            resize: { animation: { duration: 0 } },
            show: { animation: { duration: 0 } },
            hide: { animation: { duration: 0 } }
        };
        Chart.defaults.responsive = false;
        Chart.defaults.maintainAspectRatio = false;
        
        // Fix blurry charts - use device pixel ratio for crisp rendering
        Chart.defaults.devicePixelRatio = window.devicePixelRatio || 1;
        
        // Register datalabels plugin globally
        Chart.register(ChartDataLabels);
        
        // Enable datalabels by default with white text
        Chart.defaults.plugins.datalabels = {
            display: true,
            color: '#fff',
            font: { weight: 'bold', size: 12 },
            formatter: (value, ctx) => {
                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                const pct = total > 0 ? ((value / total) * 100).toFixed(0) : 0;
                return pct > 5 ? pct + '%' : '';
            }
        };
    </script>
</head>
<body class="theme-purple">
    <!-- Immediate theme application -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'purple';
            document.body.className = 'theme-' + savedTheme;
        })();
    </script>
    <div class="container">
        <div class="header" onclick="showSplashScreen(true)" style="cursor: pointer;" title="Click to lock screen">
            <h1> Nowak Distributing <span style="transform: scaleX(-1); display: inline-block;"></span></h1>
            <p>Professional Inventory & Order Management System</p>
        </div>

        <!-- Environment Indicator Circle - Top Left Corner (matches Settings icon style) -->
        <div id="envBadge" onclick="switchTab('config')" style="position: fixed; top: 20px; left: 20px; z-index: 1001; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: opacity 0.3s ease, transform 0.3s ease; background: var(--primary, #667eea); font-weight: 800; font-size: 22px; color: white;" title="Production Environment - Click to change" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
            P
        </div>

        <!-- Floating Settings Gear Icon - Top Right Corner -->
        <div id="settingsBtn" onclick="switchTab('config')" style="position: fixed; top: 20px; right: 20px; z-index: 1001; background: var(--primary, #667eea); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: opacity 0.3s ease, transform 0.3s ease;" onmouseover="this.style.transform='rotate(90deg) scale(1.1)'" onmouseout="this.style.transform='rotate(0deg) scale(1)'" title="Settings">
            <span style="font-size: 24px;"></span>
        </div>

        <!-- Navigation Cards - Always Visible at Top -->
        <!-- Navigation Cards - Seamless with body background - V9j -->
        <div class="nav-container">
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px;">
                
                <!-- Reports Card - FIRST -->
                <div class="landing-nav-card active-nav-card" onclick="switchTab('reports')" style="background: rgba(255,255,255,0.95); color: #4c1d95; padding: 8px 6px; border: 2px solid #4c1d95; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Reports</h3>
                </div>

                <!-- Suppliers Card -->
                <div class="landing-nav-card" onclick="switchTab('suppliers')" style="background: rgba(255,255,255,0.95); color: #1e3a8a; padding: 8px 6px; border: 2px solid #1e3a8a; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Suppliers</h3>
                </div>

                <!-- Items Card -->
                <div class="landing-nav-card" onclick="switchTab('items')" style="background: rgba(255,255,255,0.95); color: #475569; padding: 8px 6px; border: 2px solid #475569; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Items</h3>
                </div>

                <!-- Customers Card -->
                <div class="landing-nav-card" onclick="switchTab('customers')" style="background: rgba(255,255,255,0.95); color: #0369a1; padding: 8px 6px; border: 2px solid #0369a1; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Customers</h3>
                </div>

                <!-- Create PO Card -->
                <div class="landing-nav-card" onclick="switchTab('createpo')" style="background: rgba(255,255,255,0.95); color: #0f766e; padding: 8px 6px; border: 2px solid #0f766e; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Create PO</h3>
                </div>

                <!-- Purchases Card -->
                <div class="landing-nav-card" onclick="switchTab('purchases')" style="background: rgba(255,255,255,0.95); color: #4338ca; padding: 8px 6px; border: 2px solid #4338ca; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Purchases</h3>
                </div>

                <!-- Sales Card -->
                <div class="landing-nav-card" onclick="switchTab('sales')" style="background: rgba(255,255,255,0.95); color: #065f46; padding: 8px 6px; border: 2px solid #065f46; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Sales</h3>
                </div>

                <!-- Inventory Card -->
                <div class="landing-nav-card" onclick="switchTab('inventory')" style="background: rgba(255,255,255,0.95); color: #374151; padding: 8px 6px; border: 2px solid #374151; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Inventory</h3>
                </div>

                <!-- Price Simulator Card -->
                <div class="landing-nav-card" onclick="switchTab('expenses')" style="background: rgba(255,255,255,0.95); color: #9333ea; padding: 8px 6px; border: 2px solid #9333ea; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Expenses</h3>
                </div>

                <!-- Price Simulation Card -->
                <div class="landing-nav-card" onclick="switchTab('pricesim')" style="background: rgba(255,255,255,0.95); color: #1e40af; padding: 8px 6px; border: 2px solid #1e40af; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Price Sim</h3>
                </div>

                <!-- Help & Guides Card -->
                <div class="landing-nav-card" onclick="switchTab('guides')" style="background: rgba(255,255,255,0.95); color: #059669; padding: 8px 6px; border: 2px solid #059669; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Help</h3>
                </div>
            </div>
        </div>
        
        <!-- Mobile Navigation Bar - Clean horizontal bar at bottom -->
        <div id="mobileNavBar" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; background: white; border-top: 2px solid #e0e0e0; padding: 8px 15px; box-shadow: 0 -4px 12px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-around; align-items: center; max-width: 400px; margin: 0 auto;">
                <button id="navBackBtn" onclick="goBack()" style="display: none; background: var(--primary, #667eea); color: white; border: none; border-radius: 8px; padding: 10px 20px; font-size: 14px; font-weight: 600; cursor: pointer; flex: 1; margin-right: 8px;">
                     Back
                </button>
                <button id="navTopBtn" onclick="scrollToTop()" style="display: none; background: #f5f5f5; color: #333; border: 2px solid #ddd; border-radius: 8px; padding: 10px 20px; font-size: 14px; font-weight: 600; cursor: pointer; flex: 1; margin-left: 8px;">
                     Top
                </button>
            </div>
        </div>
        
        <!-- Desktop Floating Buttons (hidden on mobile) -->
        <button id="backToTopBtn" onclick="scrollToTop()" class="desktop-nav-btn" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" style="display: none; position: fixed; bottom: 100px; left: 30px; z-index: 1000; background: var(--primary, #667eea); color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.3s ease;" title="Back to top">
            
        </button>
        
        <button id="backBtn" onclick="goBack()" class="desktop-nav-btn" style="display: none; position: fixed; bottom: 30px; left: 30px; z-index: 1000; background: var(--primary, #667eea); color: white; border: none; border-left: 4px solid rgba(255,255,255,0.4); border-radius: 50%; width: 60px; height: 60px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="Go back to previous tab">
            
        </button>

        <!-- Settings Tab -->
        <div id="config" class="card">
            <h2>System Configuration</h2>
            <div class="status" id="configStatus"></div>
            
            <!-- Theme Selection - First and prominent -->
            <div style="margin-bottom: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;"> Theme</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('themeSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="themeSection-toggle"> Hide</span>
                    </button>
                </div>
                <div id="themeSection">
                    <p style="margin-bottom: 10px; color: #666;">
                        Choose your color scheme (280+ options!)
                    </p>
                    <div onclick="openThemePicker()" style="cursor: pointer; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; background: white; display: flex; align-items: center; gap: 15px; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary, #667eea)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                        <div id="themePreviewSwatch" style="width: 50px; height: 50px; border-radius: 10px; background: var(--primary, #667eea); box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>
                        <div style="flex: 1;">
                            <div id="themePreviewName" style="font-weight: 600; font-size: 16px; color: #333;"> Royal Purple</div>
                            <div style="font-size: 13px; color: #888;">Click to browse 280+ themes</div>
                        </div>
                        <div style="font-size: 24px; color: #999;"></div>
                    </div>
                    <input type="hidden" id="themeSelector" value="purple">
                    
                    <!-- Splash Screen Settings -->
                    <div style="margin-top: 15px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; background: #f8f9fa;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 600; font-size: 16px; color: #333;"> Splash Screen</div>
                                <div style="font-size: 12px; color: #888;">Show landing page when app opens</div>
                            </div>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="splashScreenEnabled" onchange="saveSplashSettings()" style="width: 20px; height: 20px; cursor: pointer;">
                                <span style="margin-left: 8px; font-size: 14px;">Enabled</span>
                            </label>
                        </div>
                        <div id="splashBackgroundOptions" style="margin-top: 10px;">
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Background:</label>
                            <select id="splashBackground" onchange="saveSplashSettings()" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                                <optgroup label=" Chicago Cubs">
                                    <option value="cubs1">Cubs 1</option>
                                    <option value="cubs2">Cubs 2</option>
                                    <option value="cubs3">Cubs 3</option>
                                    <option value="cubs4">Cubs 4</option>
                                    <option value="cubs5">Cubs 5</option>
                                </optgroup>
                                <optgroup label=" Chicago Bears">
                                    <option value="bears1">Bears 1</option>
                                    <option value="bears2">Bears 2</option>
                                    <option value="bears3">Bears 3</option>
                                    <option value="bears4">Bears 4</option>
                                    <option value="bears5">Bears 5</option>
                                </optgroup>
                                <optgroup label=" Gradients">
                                    <option value="gradient-blue">Blue Gradient</option>
                                    <option value="gradient-purple">Purple Gradient</option>
                                    <option value="gradient-green">Green Gradient</option>
                                    <option value="gradient-sunset">Sunset Gradient</option>
                                    <option value="gradient-dark">Dark Gradient</option>
                                </optgroup>
                                <optgroup label=" Custom">
                                    <option value="custom">Custom URL...</option>
                                </optgroup>
                            </select>
                            <input type="text" id="splashCustomUrl" placeholder="Enter image URL..." style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd; margin-top: 8px; display: none;" onchange="saveSplashSettings()">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Backup Data Section -->
            <div style="margin-bottom: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;"> Backup Data</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('backupSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="backupSection-toggle"> Hide</span>
                    </button>
                </div>
                <div id="backupSection">
                    <p style="margin-bottom: 10px; color: #666;">
                        Access your Google Sheet database directly
                    </p>
                    <button class="btn" onclick="openBackup()" style="background: var(--secondary, #764ba2); color: white;"> Open Google Sheet</button>
                </div>
            </div>
            
            <!-- Invoice Settings Section -->
            <div style="margin-bottom: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;"> Invoice Settings</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('invoiceSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="invoiceSection-toggle"> Hide</span>
                    </button>
                </div>
                <div id="invoiceSection">
                    <p style="margin-bottom: 15px; color: #666;">
                        Customize your printed invoices
                    </p>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Company Name *</label>
                            <input type="text" id="invoiceCompanyName" placeholder="Nowak Distributing">
                        </div>
                        
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="invoiceContactName" placeholder="Joe Nowak">
                        </div>
                        
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="text" id="invoicePhone" placeholder="(920)634-4351">
                        </div>
                        
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="invoiceEmail" placeholder="jnowaksnfoodistributors@gmail.com">
                        </div>
                        
                        <div class="form-group">
                            <label>Address Line 1</label>
                            <input type="text" id="invoiceAddress1" placeholder="123 Business Street">
                        </div>
                        
                        <div class="form-group">
                            <label>Address Line 2</label>
                            <input type="text" id="invoiceAddress2" placeholder="Suite 100 (optional)">
                        </div>
                        
                        <div class="form-group">
                            <label>City, State, ZIP</label>
                            <input type="text" id="invoiceCityStateZip" placeholder="Milwaukee, WI 53201">
                        </div>
                        
                        <div class="form-group">
                            <label>Footer Message</label>
                            <textarea id="invoiceFooter" rows="2" placeholder="Thank you for doing business with us!"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 10px;">
                        <label>
                            <input type="checkbox" id="invoiceSignatureLine" checked>
                            Include signature line on invoices
                        </label>
                    </div>
                    
                    <button class="btn" onclick="if(event && debounceButton(event.currentTarget)) saveInvoiceSettings()"> Save Invoice Settings</button>
                </div>
            </div>
            
            <!-- Current Status Section -->
            <div style="margin-bottom: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;"> Current Status</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('statusSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="statusSection-toggle"> Hide</span>
                    </button>
                </div>
                <div id="statusSection">
                    <p id="configStatusText"> Not configured</p>
                </div>
            </div>
            
            <!-- Diagnostics Section -->
            <div style="margin-bottom: 20px; background: #f0e8d0; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #b8a86b;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;"> Diagnostics & Troubleshooting</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('diagnosticsSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="diagnosticsSection-toggle"> Show</span>
                    </button>
                </div>
                <div id="diagnosticsSection" style="display: none; margin-top: 15px;">
                    <p style="margin-bottom: 15px; color: #7a6b40; font-size: 14px;">
                         Run diagnostics to troubleshoot issues with loading data, especially on mobile devices. This tool will test your API connection, data fetching, and identify exactly where problems occur.
                    </p>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: #666;">When to use diagnostics:</h4>
                        <ul style="margin: 10px 0; padding-left: 20px; color: #666;">
                            <li>Sales Orders or Purchase Orders won't load</li>
                            <li>Error messages appear when creating orders</li>
                            <li>Data loads on desktop but not on mobile</li>
                            <li>API connection issues</li>
                        </ul>
                    </div>
                    
                    <button class="btn" onclick="openDiagnosticTool()" style="background: #b8a86b; color: #000; font-weight: bold;">
                         Open Diagnostic Tool
                    </button>
                    
                    <p style="margin-top: 15px; color: #7a6b40; font-size: 13px;">
                         <strong>Tip:</strong> After running diagnostics, use the "Print/Save as PDF" button to save results and share them for support.
                    </p>
                </div>
            </div>
            
            <!-- Backend API URL - At bottom, collapsed by default -->
            <div style="margin-bottom: 20px; background: #f8f9fa; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #999;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; color: #666;"> Database Environment</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('apiSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="apiSection-toggle"> Show</span>
                    </button>
                </div>
                <div id="apiSection" style="display: none; margin-top: 15px;">
                    
                    <!-- Environment Switcher Buttons -->
                    <div style="margin-bottom: 20px;">
                        <p style="margin: 0 0 10px 0; color: #666; font-size: 13px; font-weight: 600;"> Quick Switch Environment:</p>
                        <div id="envButtonsContainer" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="button" id="envBtn-production" onclick="switchEnvironment('production')" class="env-btn" style="padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: 3px solid #059669; background: #d1fae5; color: #065f46; -webkit-tap-highlight-color: transparent; touch-action: manipulation; min-height: 44px;">
                                 Production
                            </button>
                            <button type="button" id="envBtn-training" onclick="switchEnvironment('training')" class="env-btn" style="padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: 3px solid #0284c7; background: white; color: #0284c7; -webkit-tap-highlight-color: transparent; touch-action: manipulation; min-height: 44px;">
                                 Training
                            </button>
                            <button type="button" id="envBtn-test" onclick="switchEnvironment('test')" class="env-btn" style="padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: 3px solid #b88a8a; background: white; color: #b88a8a; -webkit-tap-highlight-color: transparent; touch-action: manipulation; min-height: 44px;">
                                 Development
                            </button>
                        </div>
                        <p id="currentEnvDisplay" style="margin: 10px 0 0 0; padding: 8px 12px; background: #d1fae5; border-radius: 6px; color: #065f46; font-weight: 600; display: inline-block;">
                             Currently using: Production
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                        <button class="btn" onclick="if(event && debounceButton(event.currentTarget)) saveConfig()" style="background: #059669;"> Save All Settings</button>
                        <button class="btn" onclick="refreshAfterEnvSwitch()" style="background: var(--secondary, #764ba2); color: white;"> Refresh Data</button>
                        <button class="btn" onclick="restoreDefaultUrls()" style="background: #7c3aed;"> Restore Default URLs</button>
                    </div>
                    
                    <!-- URL Configuration Card - Collapsible, hidden by default -->
                    <div style="margin-top: 20px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; cursor: pointer;" onclick="toggleUrlConfig()">
                            <span style="font-weight: 600; color: #666; font-size: 13px;"> Configure URLs</span>
                            <span id="urlConfigToggle" style="color: #666; font-size: 12px;"> Show URLs</span>
                        </div>
                        <div id="urlConfigSection" style="display: none; padding: 0 15px 15px 15px; border-top: 1px solid #e5e7eb;">
                            <p style="margin: 15px 0; color: #888; font-size: 12px;">
                                Configure your Google Apps Script URLs for each environment:
                            </p>
                            
                            <!-- Production URL -->
                            <div style="margin-bottom: 15px; padding: 15px; background: #ecfdf5; border-radius: 8px; border-left: 4px solid #059669;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #065f46;"> Production URL</label>
                                <input type="text" id="envUrl-production" class="form-group" style="width: 100%; padding: 10px; border: 2px solid #a7f3d0; border-radius: 6px;" 
                                       placeholder="https://script.google.com/macros/s/.../exec"
                                       onchange="saveEnvironmentUrl('production')">
                                <p style="margin: 5px 0 0 0; font-size: 11px; color: #059669;">Your live business data</p>
                            </div>
                            
                            <!-- Training URL -->
                            <div style="margin-bottom: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0284c7;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #0369a1;"> Training URL</label>
                                <input type="text" id="envUrl-training" class="form-group" style="width: 100%; padding: 10px; border: 2px solid #bae6fd; border-radius: 6px;" 
                                       placeholder="https://script.google.com/macros/s/.../exec"
                                       onchange="saveEnvironmentUrl('training')">
                                <p style="margin: 5px 0 0 0; font-size: 11px; color: #0284c7;">Sample data for learning the system</p>
                            </div>
                            
                            <!-- Development URL -->
                            <div style="margin-bottom: 15px; padding: 15px; background: #fef2f2; border-radius: 8px; border-left: 4px solid #b88a8a;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #991b1b;"> Development URL</label>
                                <input type="text" id="envUrl-test" class="form-group" style="width: 100%; padding: 10px; border: 2px solid #fecaca; border-radius: 6px;" 
                                       placeholder="https://script.google.com/macros/s/.../exec"
                                       onchange="saveEnvironmentUrl('test')">
                                <p style="margin: 5px 0 0 0; font-size: 11px; color: #b88a8a;">For testing new features and changes</p>
                            </div>
                            
                            <p style="margin: 10px 0 0 0; padding: 10px; background: #fef3c7; border-radius: 6px; color: #92400e; font-size: 12px;">
                                 <strong>Tip:</strong> If URLs are blank after clearing site data, click "Restore Default URLs" to repopulate them!
                            </p>
                        </div>
                    </div>
                    
                    <!-- Legacy single URL input (hidden but functional for backward compatibility) -->
                    <input type="hidden" id="apiUrl">
                </div>
            </div>
        </div>

        <!-- HOME / LANDING PAGE -->
        <!-- Suppliers Tab -->
        <div id="suppliers" class="card">
            <h2>Suppliers</h2>
            <div class="status" id="suppliersStatus"></div>
            
            <!-- Button Group Card -->
            <div class="filter-card">
                <button class="btn" onclick="loadSuppliers()"> Refresh</button>
                <button class="btn" onclick="showAddSupplierForm()"> Add Supplier</button>
            </div>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;"> Filter Suppliers</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-suppliers')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-suppliers-toggle"> Show</span>
                    </button>
                </div>
                <div id="filter-panel-suppliers" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Search Name</label>
                        <input type="text" id="filterSupplierName" placeholder=" Click to search..." onkeyup="filterSuppliers()" onclick="openSupplierPickerForFilter(this)" readonly style="cursor: pointer; background: #fff;">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="filterSupplierCity" placeholder="Filter by city..." onkeyup="filterSuppliers()">
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <input type="text" id="filterSupplierState" placeholder="Filter by state..." onkeyup="filterSuppliers()">
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="clearSupplierFilters()" style="background: var(--secondary, #764ba2); color: white;">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addSupplierForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <h3>Add New Supplier</h3>
                <form onsubmit="addSupplier(event)" autocomplete="off">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier Name *</label>
                            <input type="text" id="newSupplierName" required autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="newContactName" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="newPhone" placeholder="(999) 999-9999" oninput="formatPhone(this)" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="newEmail" autocomplete="off">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="newAddress" autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="newCity" autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" id="newState" maxlength="2" autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" id="newZip" autocomplete="new-password">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Payment Terms</label>
                        <select id="newPaymentTerms">
                            <option value="Net 30">Net 30</option>
                            <option value="Net 45">Net 45</option>
                            <option value="Net 60">Net 60</option>
                            <option value="COD">COD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="newNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn"> Save Supplier</button>
                    <button type="button" class="btn" onclick="hideAddSupplierForm()" style="background: var(--secondary, #764ba2); color: white;">Cancel</button>
                </form>
            </div>
            
            <!-- Edit Supplier Form -->
            <div id="editSupplierForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #f39c12;">
                <h3> Edit Supplier</h3>
                <form onsubmit="updateSupplier(event)">
                    <input type="hidden" id="editSupplierId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier Name *</label>
                            <input type="text" id="editSupplierName" required>
                        </div>
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="editContactName">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="editPhone">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="editEmail">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="editAddress">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="editCity">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" id="editState" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" id="editZip">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Payment Terms</label>
                        <select id="editPaymentTerms">
                            <option value="Net 30">Net 30</option>
                            <option value="Net 45">Net 45</option>
                            <option value="Net 60">Net 60</option>
                            <option value="COD">COD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn"> Update Supplier</button>
                    <button type="button" class="btn" onclick="hideEditSupplierForm()" style="background: var(--secondary, #764ba2); color: white;">Cancel</button>
                </form>
            </div>
            
            <div class="data-display-card">
                <div id="suppliersTable"></div>
            </div>
        </div>

        <!-- Items Tab -->
        <div id="items" class="card">
            <h2>Items</h2>
            <div class="status" id="itemsStatus"></div>
            
            <!-- Button Group Card -->
            <div class="filter-card">
                <button class="btn" onclick="loadItems(true)"> Refresh</button>
                <button class="btn" onclick="showAddItemForm()"> Add Item</button>
                <button class="btn" onclick="downloadItemsReport()" style="background: #7aaab8;"> Download Items</button>
                <button class="btn" onclick="openUploadItemsModal()" style="background: #6b9a8d;"> Upload Items</button>
                <button class="btn" onclick="recalculateOnOrder()" style="background: var(--secondary, #764ba2); color: white;" title="Recalculate On Order quantities based on pending POs - also available in Action Dashboard"> Fix On Order</button>
            </div>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;"> Filter Items</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-items')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-items-toggle"> Show</span>
                    </button>
                </div>
                <div id="filter-panel-items" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Search SKU/Description</label>
                        <input type="text" id="filterItemSearch" placeholder=" Click to search..." onkeyup="filterItems()" onclick="openItemPickerForFilter(this)" readonly style="cursor: pointer; background: #fff;">
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <select id="filterItemSupplier" onchange="filterItems()">
                            <option value="">All Suppliers</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stock Status</label>
                        <select id="filterItemStock" onchange="filterItems()">
                            <option value="">All Items</option>
                            <option value="negative"> Negative Inventory</option>
                            <option value="low"> Low Stock (Below Reorder)</option>
                            <option value="onorder"> On Order (Pending Delivery)</option>
                            <option value="reorder"> Needs Reorder (Low + No Order)</option>
                            <option value="ok"> Normal Stock</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Item Status</label>
                        <select id="filterItemActive" onchange="filterItems()">
                            <option value="active"> Active Items Only</option>
                            <option value="archived"> Archived Items Only</option>
                            <option value="">All Items</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="clearItemFilters()" style="background: var(--secondary, #764ba2); color: white;">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addItemForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <h3>Add New Item</h3>
                <form onsubmit="addItem(event)" autocomplete="off">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="newItemSupplier" required>
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Item Description *</label>
                            <input type="text" id="newItemDescription" required autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>SKU *</label>
                            <input type="text" id="newItemSKU" required placeholder="e.g. BM-BBQ-001" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Purchase UOM (What you buy)</label>
                            <input type="text" id="newItemPurchaseUOMDisplay" value="Case" 
                                   onclick="openUOMPicker('newItemPurchaseUOM')" readonly
                                   style="cursor: pointer; background: #fff;">
                            <input type="hidden" id="newItemPurchaseUOM" value="Case">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Units Per Package * <span style="font-size: 12px; color: #666;">(How many individual units in one box/case)</span></label>
                            <input type="number" id="newUnitsPerPackage" step="1" min="1" required placeholder="e.g. 27" oninput="calculateUnitCost()" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Package Cost * <span style="font-size: 12px; color: #666;">(Cost per box/case)</span></label>
                            <input type="number" id="newPackageCost" step="0.01" required placeholder="e.g. 20.00" oninput="calculateUnitCost()" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Unit Cost (Calculated)</label>
                            <input type="text" id="calculatedUnitCost" readonly style="background: #f0f0f0; font-weight: bold;" value="$0.00">
                        </div>
                        <div class="form-group">
                            <label>Unit Sell Price * <span style="font-size: 12px; color: #666;">(Price per individual unit)</span></label>
                            <input type="number" id="newUnitSellPrice" step="0.01" required placeholder="e.g. 3.00" autocomplete="off">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Initial Quantity <span style="font-size: 12px; color: #666;">(In individual units)</span></label>
                            <input type="number" id="newQtyOnHand" value="0" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Reorder Point <span style="font-size: 12px; color: #666;">(In individual units)</span></label>
                            <input type="number" id="newReorderPoint" value="10" autocomplete="off">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="newItemNotes" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn"> Save Item</button>
                    <button type="button" class="btn" onclick="hideAddItemForm()" style="background: var(--secondary, #764ba2); color: white;">Cancel</button>
                </form>
            </div>
            
            <!-- Edit Item Form -->
            <div id="editItemForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #f39c12;">
                <h3> Edit Item</h3>
                <form onsubmit="updateItem(event)">
                    <input type="hidden" id="editItemId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="editItemSupplier" required>
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Item Description *</label>
                            <input type="text" id="editItemDescription" required>
                        </div>
                        <div class="form-group">
                            <label>SKU *</label>
                            <input type="text" id="editItemSKU" required>
                        </div>
                        <div class="form-group">
                            <label>Purchase UOM</label>
                            <input type="text" id="editItemPurchaseUOMDisplay" 
                                   onclick="openUOMPicker('editItemPurchaseUOM')" readonly
                                   style="cursor: pointer; background: #fff;">
                            <input type="hidden" id="editItemPurchaseUOM">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Units Per Package *</label>
                            <input type="number" id="editUnitsPerPackage" step="1" min="1" required oninput="calculateEditUnitCost()">
                        </div>
                        <div class="form-group">
                            <label>Package Cost *</label>
                            <input type="number" id="editPackageCost" step="0.01" required oninput="calculateEditUnitCost()">
                        </div>
                        <div class="form-group">
                            <label>Unit Cost (Calculated)</label>
                            <input type="text" id="calculatedEditUnitCost" readonly style="background: #f0f0f0; font-weight: bold;" value="$0.00">
                        </div>
                        <div class="form-group">
                            <label>Unit Sell Price *</label>
                            <input type="number" id="editUnitSellPrice" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Current Quantity <span style="font-size: 12px; color: #666;">(In individual units)</span></label>
                            <input type="number" id="editQtyOnHand" readonly style="background: #f0f0f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                                <small style="color: #666;">Use Purchases/Sales to adjust quantity</small>
                                <a href="#" onclick="goToAdjustInventory(); return false;" style="font-size: 12px; color: #3b82f6; text-decoration: none; font-weight: 600;"> Adjust Inventory </a>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Reorder Point <span style="font-size: 12px; color: #666;">(In individual units)</span></label>
                            <input type="number" id="editReorderPoint">
                        </div>
                        <div class="form-group">
                            <label>Item Status</label>
                            <select id="editItemStatus">
                                <option value="Active"> Active</option>
                                <option value="Archived"> Archived</option>
                            </select>
                            <small style="color: #666;">Archived items won't appear in new PO/SO dropdowns</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editItemNotes" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn"> Update Item</button>
                    <button type="button" class="btn" onclick="hideEditItemForm()" style="background: var(--secondary, #764ba2); color: white;">Cancel</button>
                </form>
            </div>
            
            <div class="data-display-card">
                <div id="itemsTable"></div>
            </div>
        </div>

        <!-- Customers Tab -->
        <div id="customers" class="card">
            <h2>Customers</h2>
            <div class="status" id="customersStatus"></div>
            
            <!-- Button Group Card -->
            <div class="filter-card">
                <button class="btn" onclick="loadCustomers()"> Refresh</button>
                <button class="btn" onclick="showAddCustomerForm()"> Add Customer</button>
            </div>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;"> Filter Customers</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-customers')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-customers-toggle"> Show</span>
                    </button>
                </div>
                <div id="filter-panel-customers" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Search Name</label>
                        <input type="text" id="filterCustomerName" placeholder=" Click to search..." onkeyup="filterCustomers()" onclick="openCustomerPickerForFilter(this)" readonly style="cursor: pointer; background: #fff;">
                    </div>
                    <div class="form-group">
                        <label>Contact Name</label>
                        <input type="text" id="filterCustomerContact" placeholder="Contact name..." onkeyup="filterCustomers()">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="filterCustomerCity" placeholder="Filter by city..." onkeyup="filterCustomers()">
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <input type="text" id="filterCustomerState" placeholder="Filter by state..." onkeyup="filterCustomers()">
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="clearCustomerFilters()" style="background: var(--secondary, #764ba2); color: white;">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addCustomerForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <h3>Add New Customer</h3>
                <form onsubmit="addCustomer(event)" autocomplete="off">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Customer Name *</label>
                            <input type="text" id="newCustomerName" required autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="newCustomerContact" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="newCustomerPhone" autocomplete="off" placeholder="(999) 999-9999" oninput="formatPhone(this)">
                        </div>
                        <div class="form-group">
                            <label>Mobile</label>
                            <input type="tel" id="newCustomerMobile" autocomplete="off" placeholder="(999) 999-9999" oninput="formatPhone(this)">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="newCustomerEmail" autocomplete="off">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="newCustomerAddress" autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="newCustomerCity" autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" id="newCustomerState" maxlength="2" autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" id="newCustomerZip" autocomplete="new-password">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Credit Limit</label>
                            <input type="number" id="newCreditLimit" step="0.01" value="0" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Payment Terms</label>
                            <select id="newCustomerPaymentTerms">
                                <option value="Net 30">Net 30</option>
                                <option value="Net 15">Net 15</option>
                                <option value="Net 45">Net 45</option>
                                <option value="COD">COD</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="newCustomerNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn"> Save Customer</button>
                    <button type="button" class="btn" onclick="hideAddCustomerForm()" style="background: var(--secondary, #764ba2); color: white;">Cancel</button>
                </form>
            </div>
            
            <!-- Edit Customer Form -->
            <div id="editCustomerForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #f39c12;">
                <h3> Edit Customer</h3>
                <form onsubmit="updateCustomer(event)">
                    <input type="hidden" id="editCustomerId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Customer Name *</label>
                            <input type="text" id="editCustomerName" required>
                        </div>
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="editCustomerContact">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="editCustomerPhone" placeholder="(999) 999-9999" oninput="formatPhone(this)">
                        </div>
                        <div class="form-group">
                            <label>Mobile</label>
                            <input type="tel" id="editCustomerMobile" placeholder="(999) 999-9999" oninput="formatPhone(this)">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="editCustomerEmail">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="editCustomerAddress">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="editCustomerCity">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" id="editCustomerState" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" id="editCustomerZip">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Credit Limit</label>
                            <input type="number" id="editCreditLimit" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Payment Terms</label>
                            <select id="editCustomerPaymentTerms">
                                <option value="Net 30">Net 30</option>
                                <option value="Net 15">Net 15</option>
                                <option value="Net 45">Net 45</option>
                                <option value="COD">COD</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editCustomerNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn"> Update Customer</button>
                    <button type="button" class="btn" onclick="hideEditCustomerForm()" style="background: var(--secondary, #764ba2); color: white;">Cancel</button>
                </form>
            </div>
            
            <div class="data-display-card">
                <div id="customersTable"></div>
            </div>
        </div>

        <!-- Create PO Tab (Generate Only - No Database Save) -->
        <div id="createpo" class="card">
            <div style="max-width: 100%; overflow: hidden;">
                <h2> Create Purchase Order</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Create a purchase order to track items on order from suppliers. Use <strong>"Save PO"</strong> to save to database and mark items as "On Order", or use <strong>"Print PO (No Save)"</strong> to just generate a printable document.
                </p>
                
                <div id="createPOForm">
                    <!-- Card 1: Basic Information -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary, #667eea);"> Order Information</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Supplier *</label>
                                <select id="createPOSupplier" required onchange="filterItemsBySupplier()">
                                    <option value="">Select Supplier...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>PO Date *</label>
                                <input type="date" id="createPODate" required>
                            </div>
                            <div class="form-group">
                                <label>Expected Delivery Date *</label>
                                <input type="date" id="createPOExpectedDate" required>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Notes</label>
                                <textarea id="createPONotes" rows="2" placeholder="Special instructions, delivery notes, etc."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 2: Line Items -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: flex-start; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 12px;">
                            <h4 style="margin: 0; color: var(--primary, #667eea);"> Line Items</h4>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn-small" onclick="openMultiItemPickerForPO()" style="background: #6b9a8d; color: white;"> Select Multiple Items</button>
                                <button class="btn-small" onclick="addCreatePOLineItem()" style="background: var(--primary, #667eea); color: white;"> Add Single Item</button>
                            </div>
                        </div>
                        
                        <!-- Wrapper for horizontal scroll on mobile -->
                        <div id="createPOLineItemsWrapper" style="overflow-x: auto; -webkit-overflow-scrolling: touch; width: 100%; position: relative;">
                            <div id="createPOLineItemsInner" style="min-width: 700px; width: 100%; max-width: 100%;">
                                <!-- Header Row -->
                                <div id="createPOLineItemsHeader" style="display: grid; grid-template-columns: 2.5fr 1fr 0.6fr 0.8fr 0.8fr 0.8fr 50px; gap: 6px; padding: 12px; background: var(--primary, #667eea); color: white; font-weight: bold; border-radius: 8px 8px 0 0; font-size: 16px;">
                                    <div>Item</div>
                                    <div style="text-align: center;">Cases</div>
                                    <div style="text-align: center;">Units/Case</div>
                                    <div style="text-align: center;">Total Units</div>
                                    <div style="text-align: center;">Catalog Cost</div>
                                    <div style="text-align: right;">Line Total</div>
                                    <div style="text-align: center;">Del</div>
                                </div>
                                
                                <!-- Line Items Container -->
                                <div id="createPOLineItems" style="border: 2px solid #667eea; border-top: none; border-radius: 0 0 8px 8px; padding: 10px; background: #fafafa;">
                                    <div class="line-item-row" style="display: grid; grid-template-columns: 2.5fr 1fr 0.6fr 0.8fr 0.8fr 0.8fr 50px; gap: 8px; margin-bottom: 10px; align-items: end;">
                                        <div>
                                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                                            <select class="createpo-item" style="width: 100%; padding: 14px 12px; border: 2px solid #ccc; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: #f5f5f5;" onchange="updateCreatePOItemCost(this)" disabled>
                                                <option value=""> Select Supplier First</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Cases</label>
                                            <input type="number" class="createpo-qty" placeholder="0" min="1" style="width: 100%; padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px;" disabled>
                                        </div>
                                        <div style="margin-top: 26px;">
                                            <div class="createpo-units" style="text-align: center; font-size: 14px; color: #666; padding: 6px;">-</div>
                                        </div>
                                        <div style="margin-top: 26px;">
                                            <div class="createpo-totalunits" style="text-align: center; font-size: 16px; font-weight: bold; color: var(--primary, #667eea); padding: 6px;">-</div>
                                        </div>
                                        <div style="margin-top: 26px;">
                                            <div class="createpo-cost" style="text-align: center; font-size: 14px; font-weight: bold; color: #6b9a8d; background: #e8f5e9; padding: 10px; border-radius: 6px;">-</div>
                                        </div>
                                        <div style="margin-top: 26px;">
                                            <div class="createpo-linetotal" style="text-align: right; font-size: 14px; font-weight: bold; color: var(--primary, #667eea); background: var(--primary-light, #E3F2FD); padding: 10px; border-radius: 6px;">$0.00</div>
                                        </div>
                                        <button type="button" class="btn-danger" onclick="removeLineItem(this)" style="width: 100%; padding: 10px; font-size: 14px; margin-top: 26px;"></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 3: Order Summary - STICKY -->
                    <div class="content-card" style="margin-bottom: 20px; position: sticky; top: 80px; z-index: 10; background: white;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary, #667eea);"> Order Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); border-radius: 12px; border: 2px solid #7a9bb8;">
                                <div style="font-size: 14px; color: #5a7a8a; margin-bottom: 8px; font-weight: 600;">Total Cases</div>
                                <div style="font-size: 32px; font-weight: bold; color: #7a9bb8;" id="createPOTotalCases">0</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); border-radius: 12px; border: 2px solid #b8a86b;">
                                <div style="font-size: 14px; color: #8a7a4a; margin-bottom: 8px; font-weight: 600;">Total Units</div>
                                <div style="font-size: 32px; font-weight: bold; color: #b8a86b;" id="createPOTotalUnits">0</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); border-radius: 12px; border: 2px solid #6b9a8d;">
                                <div style="font-size: 14px; color: #5a7a6d; margin-bottom: 8px; font-weight: 600;">Total Cost</div>
                                <div style="font-size: 32px; font-weight: bold; color: #6b9a8d;" id="createPOTotal">$0.00</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="filter-card">
                        <button class="btn" onclick="if(event && debounceButton(event.currentTarget)) showCreatePOPreview()" style="flex: 1; min-width: 200px; background: var(--primary, #667eea); color: white;"> Save PO</button>
                        <button class="btn" onclick="showPrintablePOPreview()" style="flex: 1; min-width: 200px; background: var(--primary, #667eea); color: white;"> Print PO (No Save)</button>
                        <button class="btn" onclick="clearCreatePOForm()" style="flex: 1; min-width: 200px; background: var(--secondary, #764ba2); color: white;"> Clear Form</button>
                    </div>
                </div>
            </div>
            
            <!-- Printable PO Document (Hidden initially) -->
            <div id="printablePOContainer" style="display: none; margin-top: 30px;">
                <div style="text-align: right; margin-bottom: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn" onclick="window.print()"> Print</button>
                    <button class="btn" onclick="downloadPOAsPDF()"> Download PDF</button>
                    <button class="btn" onclick="emailPO()"> Email PO</button>
                    <button class="btn" onclick="closePrintablePO()" style="background: var(--secondary, #764ba2); color: white;"> Close</button>
                </div>
                <div id="printablePO" style="background: white; padding: 40px; border: 1px solid #ddd; max-width: 800px; margin: 0 auto;">
                    <!-- Printable PO will be generated here -->
                </div>
            </div>
        </div>

        <!-- Purchases Tab -->
        <div id="purchases" class="card">
            <h2>Purchase Orders</h2>
            <div class="status" id="purchasesStatus"></div>
            
            <!-- Button Group Card -->
            <div class="filter-card">
                <button class="btn" onclick="loadPurchases(true)"> Refresh</button>
                <button class="btn" onclick="showAddPurchaseForm()"> New Purchase Order</button>
            </div>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;"> Filter Purchases</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-purchases')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-purchases-toggle"> Show</span>
                    </button>
                </div>
                <div id="filter-panel-purchases" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Invoice # / PO</label>
                        <input type="text" id="filterPurchasePO_display" placeholder=" Click to select POs..." onclick="openPOPickerForPurchases()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="filterPurchasePO" value="">
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <input type="text" id="filterPurchaseSupplier_display" placeholder=" Click to select suppliers..." onclick="openSupplierPickerForPurchases()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="filterPurchaseSupplier" value="">
                    </div>
                    <div class="form-group">
                        <label>Order Status</label>
                        <input type="text" id="filterPurchaseStatus_display" placeholder=" Click to select..." onclick="openStatusPicker('filterPurchaseStatus', 'filterPurchaseStatus', filterPurchases)" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="filterPurchaseStatus" value="">
                    </div>
                    <div class="form-group">
                        <label> Payment Status</label>
                        <input type="text" id="filterPurchasePaymentStatus_display" placeholder=" Click to select..." onclick="openStatusPicker('paymentStatus', 'filterPurchasePaymentStatus', filterPurchases)" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="filterPurchasePaymentStatus" value="">
                    </div>
                    <div class="form-group">
                        <label> PO Date From</label>
                        <input type="date" id="filterPurchaseDateFrom" onchange="filterPurchases()">
                    </div>
                    <div class="form-group">
                        <label> PO Date To</label>
                        <input type="date" id="filterPurchaseDateTo" onchange="filterPurchases()">
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="clearPurchaseFilters()" style="background: var(--secondary, #764ba2); color: white;">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addPurchaseForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <h3>New Purchase Order</h3>
                <form onsubmit="addPurchase(event)">
                    <!-- Purchase Type Selection -->
                    <div class="content-card" style="margin-bottom: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
                        <h4 style="margin-top: 0; margin-bottom: 15px; color: #0369a1;"> Purchase Type</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <label id="poTypeOrdering" style="display: flex; align-items: flex-start; gap: 12px; padding: 15px; background: white; border-radius: 10px; cursor: pointer; border: 3px solid #3b82f6; transition: all 0.2s;" onclick="setPurchaseType('ordering')">
                                <input type="radio" name="purchaseType" value="ordering" checked style="margin-top: 3px; width: 18px; height: 18px;">
                                <div>
                                    <div style="font-weight: 600; color: #1e40af; font-size: 15px;"> Placing an Order</div>
                                    <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Items coming later - adds to <strong>Qty On Order</strong></div>
                                </div>
                            </label>
                            <label id="poTypeReceived" style="display: flex; align-items: flex-start; gap: 12px; padding: 15px; background: white; border-radius: 10px; cursor: pointer; border: 3px solid #e5e7eb; transition: all 0.2s;" onclick="setPurchaseType('received')">
                                <input type="radio" name="purchaseType" value="received" style="margin-top: 3px; width: 18px; height: 18px;">
                                <div>
                                    <div style="font-weight: 600; color: #15803d; font-size: 15px;"> Already Received</div>
                                    <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Have items now - adds to <strong>Qty On Hand</strong></div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Card 1: Basic Information -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Supplier *</label>
                                <select id="poSupplier" onchange="loadSupplierItems()">
                                    <option value="">Select Supplier</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label id="poDateLabel">Order Date *</label>
                                <input type="date" id="poDate" onchange="syncDueDateIfReceived()">
                            </div>
                            <div class="form-group" id="poDueDateGroup">
                                <label>Expected Delivery Date *</label>
                                <input type="date" id="poDueDate">
                                <small style="color: #666;">When do you expect to receive this order?</small>
                            </div>
                            <div class="form-group">
                                <label>Payment Terms</label>
                                <input type="text" id="poPaymentTerms_display" value=" Net 30" onclick="openStatusPicker('paymentTerms', 'poPaymentTerms')" readonly style="cursor: pointer; background: #fff; font-weight: 600;">
                                <input type="hidden" id="poPaymentTerms" value="Net 30">
                            </div>
                            <div class="form-group" id="poStatusGroup" style="display: none;">
                                <label>Status *</label>
                                <input type="text" id="poStatus_display" value=" Ordered - Sent to supplier" onclick="openStatusPicker('poStatus', 'poStatus')" readonly style="cursor: pointer; background: #fff; font-weight: 600;">
                                <input type="hidden" id="poStatus" value="Ordered">
                            </div>
                            <div class="form-group">
                                <label>Invoice Total *</label>
                                <input type="number" id="poTotal" step="0.01" min="0" readonly style="background: #f0f0f0; display: none;">
                                <div id="poTotalDisplay" style="font-size: 24px; font-weight: bold; color: #6b9a8d; padding: 10px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 8px; text-align: center; border: 2px solid #6b9a8d;">$0.00</div>
                            </div>
                            <div class="form-group">
                                <label>Amount Paid</label>
                                <input type="number" id="poAmountPaid" step="0.01" min="0" value="0" placeholder="0.00">
                                <small style="color: #666;">Enter amount if paid at time of purchase</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 2: Line Items (Matching Create PO Design) -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: flex-start; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 12px;">
                            <h4 style="margin: 0; color: var(--primary, #667eea);"> Line Items</h4>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button type="button" class="btn-small" onclick="openMultiItemPickerForMainPO()" style="background: #6b9a8d; color: white;"> Select Multiple Items</button>
                                <button type="button" class="btn-small" onclick="addPOLineItem()" style="background: var(--primary, #667eea); color: white;"> Add Single Item</button>
                            </div>
                        </div>
                        
                        <!-- Wrapper for horizontal scroll on mobile -->
                        <div id="poLineItemsWrapper" style="overflow-x: auto; -webkit-overflow-scrolling: touch; width: 100%; position: relative;">
                            <div id="poLineItemsInner" style="min-width: 780px; width: 100%; max-width: 100%;">
                                <!-- Header Row -->
                                <div id="poLineItemsHeader" style="display: grid; grid-template-columns: 2.2fr 0.6fr 0.9fr 0.5fr 0.7fr 0.8fr 0.8fr 45px; gap: 6px; padding: 12px; background: var(--primary, #667eea); color: white; font-weight: bold; border-radius: 8px 8px 0 0; font-size: 13px;">
                                    <div>Item</div>
                                    <div style="text-align: center;">Eaches?</div>
                                    <div style="text-align: center;">Qty</div>
                                    <div style="text-align: center;">Pkg</div>
                                    <div style="text-align: center;">Units</div>
                                    <div style="text-align: center;">Cost</div>
                                    <div style="text-align: right;">Total</div>
                                    <div style="text-align: center;"></div>
                                </div>
                                
                                <!-- Line Items Container -->
                                <div class="line-items-container" id="poLineItems" style="border: 2px solid var(--primary, #667eea); border-top: none; border-radius: 0 0 8px 8px; padding: 10px; background: #fafafa;">
                                    <div class="line-item-row" data-eaches="false" style="display: grid; grid-template-columns: 2.2fr 0.6fr 0.9fr 0.5fr 0.7fr 0.8fr 0.8fr 45px; gap: 8px; margin-bottom: 10px; align-items: end;">
                                        <div>
                                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                                            <select class="po-item" style="width: 100%; padding: 14px 12px; border: 2px solid #ccc; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: #f5f5f5;" required disabled>
                                                <option value=""> Select Supplier First</option>
                                            </select>
                                        </div>
                                        <div style="text-align: center;">
                                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 11px;"></label>
                                            <label class="eaches-toggle" style="display: inline-flex; align-items: center; justify-content: center; cursor: not-allowed; background: #ccc; padding: 12px; border-radius: 8px; min-height: 52px; width: 100%; box-sizing: border-box; opacity: 0.5;" title="Select supplier first">
                                                <input type="checkbox" class="po-eaches" style="width: 20px; height: 20px; cursor: not-allowed;" onchange="togglePOEaches(this)" disabled>
                                            </label>
                                        </div>
                                        <div>
                                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 11px; text-align: center;" class="po-qty-label"> Cases</label>
                                            <input type="number" class="po-qty" placeholder="0" min="1" style="width: 100%; padding: 14px 8px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 18px; font-weight: bold; background: #fffde7; min-height: 52px;" required disabled>
                                        </div>
                                        <div style="margin-top: 26px;">
                                            <div class="po-units" style="text-align: center; font-size: 13px; color: #666; padding: 6px;">-</div>
                                        </div>
                                        <div style="margin-top: 26px;">
                                            <div class="po-totalunits" style="text-align: center; font-size: 14px; font-weight: bold; color: var(--primary, #667eea); padding: 6px;">-</div>
                                        </div>
                                        <div style="margin-top: 26px;">
                                            <div class="po-cost-display" style="text-align: center; font-size: 12px; font-weight: bold; color: #6b9a8d; background: #e8f5e9; padding: 8px; border-radius: 6px;">-</div>
                                            <input type="number" class="po-cost-input" step="0.01" min="0" style="display: none; width: 100%; padding: 8px 4px; border: 2px solid #9333ea; border-radius: 6px; text-align: center; font-size: 14px; font-weight: bold; background: #f3e8ff; color: #9333ea;" placeholder="0.00">
                                        </div>
                                        <div style="margin-top: 26px;">
                                            <div class="po-linetotal" style="text-align: right; font-size: 12px; font-weight: bold; color: var(--primary, #667eea); background: var(--primary-light, #E3F2FD); padding: 8px; border-radius: 6px;">$0.00</div>
                                        </div>
                                        <button type="button" class="remove-btn btn-danger" onclick="removeLineItem(this); calculatePOTotal();" style="width: 100%; padding: 8px; font-size: 14px; margin-top: 26px;"></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                            <button type="button" class="btn" onclick="addNewItemFromPO()" style="background: #9c27b0;"> Add New Item to Catalog</button>
                        </div>
                    </div>
                    
                    <!-- Card 3: Order Summary -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary, #667eea);"> Order Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); border-radius: 12px; border: 2px solid #7a9bb8;">
                                <div style="font-size: 14px; color: #5a7a8a; margin-bottom: 8px; font-weight: 600;">Total Cases</div>
                                <div style="font-size: 32px; font-weight: bold; color: #7a9bb8;" id="poTotalCases">0</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); border-radius: 12px; border: 2px solid #b8a86b;">
                                <div style="font-size: 14px; color: #8a7a4a; margin-bottom: 8px; font-weight: 600;">Total Units</div>
                                <div style="font-size: 32px; font-weight: bold; color: #b8a86b;" id="poTotalUnits">0</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); border-radius: 12px; border: 2px solid #6b9a8d;">
                                <div style="font-size: 14px; color: #5a7a6d; margin-bottom: 8px; font-weight: 600;">Total Cost</div>
                                <div style="font-size: 32px; font-weight: bold; color: #6b9a8d;" id="poTotalCost">$0.00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="poNotes" rows="2"></textarea>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="filter-card" style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn" onclick="showPOPreview()" id="savePOBtn" style="flex: 1; min-width: 150px; background: var(--primary, #667eea); color: white;"> Create Purchase Order</button>
                        <button type="button" class="btn" onclick="printPOWithoutSave()" style="flex: 1; min-width: 150px; background: var(--primary, #667eea); color: white;"> Print PO (No Save)</button>
                        <button type="button" class="btn" onclick="clearPOForm()" style="flex: 1; min-width: 150px; background: var(--secondary, #764ba2); color: white;"> Clear Form</button>
                    </div>
                </form>
            </div>
            
            <div class="data-display-card" style="margin-top: 30px;">
                <div id="purchasesTable"></div>
            </div>
        </div>

        <!-- Sales Tab -->
        <div id="sales" class="card">
            <h2>Sales Orders</h2>
            <div class="status" id="salesStatus"></div>
            
            <!-- Button Group Card -->
            <div class="filter-card">
                <button class="btn" onclick="loadSales(true)"> Refresh</button>
                <button class="btn" onclick="showAddSaleForm()"> Record Sale</button>
            </div>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;"> Filter Sales</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-sales')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-sales-toggle"> Show</span>
                    </button>
                </div>
                <div id="filter-panel-sales" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Customer</label>
                        <input type="text" id="filterSaleCustomer_display" placeholder=" Click to select customers..." onclick="openCustomerPickerForSales()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="filterSaleCustomer" value="">
                    </div>
                    <div class="form-group">
                        <label>Invoice #</label>
                        <input type="text" id="filterInvoiceNumber_display" placeholder=" Click to select invoices..." onclick="openInvoicePickerForSales()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="filterInvoiceNumber" value="">
                    </div>
                    <div class="form-group">
                        <label>Order Status</label>
                        <input type="text" id="filterSaleStatus_display" placeholder=" Click to select..." onclick="openStatusPicker('filterSaleStatus', 'filterSaleStatus', filterSales)" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="filterSaleStatus" value="">
                    </div>
                    <div class="form-group">
                        <label>Date From</label>
                        <input type="date" id="filterSaleDateFrom" onchange="filterSales()">
                    </div>
                    <div class="form-group">
                        <label>Date To</label>
                        <input type="date" id="filterSaleDateTo" onchange="filterSales()">
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="clearSaleFilters()" style="background: var(--secondary, #764ba2); color: white;">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addSaleForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <h3>Record New Sale</h3>
                <form onsubmit="addSale(event)">
                    <!-- Card 1: Basic Information -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Customer *</label>
                                <select id="soCustomer">
                                    <option value="">Select Customer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Sale Date *</label>
                                <input type="date" id="soDate">
                            </div>
                            <div class="form-group">
                                <label>Payment Method</label>
                                <select id="soPayment">
                                    <option value="Cash">Cash</option>
                                    <option value="Credit Card">Credit Card</option>
                                    <option value="Check">Check</option>
                                    <option value="Invoice">Invoice</option>
                                    <option value="Terms (Net 30)">Terms (Net 30)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Due Date *</label>
                                <input type="date" id="soDueDate">
                                <small style="color: #666;">Defaults to today for same-day sales</small>
                            </div>
                            <div class="form-group">
                                <label>Order Total *</label>
                                <input type="number" id="soTotal" step="0.01" min="0" readonly style="background: #f0f0f0;">
                                <small style="color: #666;">Auto-calculated from line items</small>
                            </div>
                            <div class="form-group">
                                <label>Amount Paid</label>
                                <input type="number" id="soAmountPaid" step="0.01" min="0" value="0" placeholder="0.00">
                                <small style="color: #666;">Enter amount if paid at time of sale</small>
                            </div>
                            <div class="form-group">
                                <label>Status *</label>
                                <input type="hidden" id="soStatus" value="Pending">
                                <input type="text" id="soStatus_display" value=" Pending - Order placed" onclick="openStatusPicker('soStatus', 'soStatus')" readonly style="cursor: pointer; background: #fff; font-weight: 600; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 2: Items Sold -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: flex-start; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 12px;">
                            <h4 style="margin: 0;">Items Sold</h4>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button type="button" class="btn-small" onclick="openMultiItemPickerForSO()" style="background: #6b9a8d; color: white;"> Select Multiple Items</button>
                            </div>
                        </div>
                        <div class="line-items-container" id="soLineItems" style="background: #fafafa; padding: 15px; border-radius: 8px; border: 2px solid #667eea;">
                            <div class="line-item-row" style="display: grid; grid-template-columns: 2.5fr 1fr 1fr 50px; gap: 10px; margin-bottom: 10px; align-items: end;">
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                                    <select class="so-item" required style="padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white; width: 100%;">
                                        <option value="">Select Item</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Quantity</label>
                                    <input type="number" class="so-qty" placeholder="0" min="1" required style="padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px; width: 100%;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Price</label>
                                    <input type="number" class="so-price" placeholder="0.00" step="0.01" min="0" required style="padding: 14px 10px; border: 2px solid #667eea; border-radius: 8px; text-align: center; font-size: 16px; min-height: 52px; background: white; width: 100%;">
                                </div>
                                <button type="button" class="remove-btn" style="min-height: 52px; font-size: 18px; margin-top: 26px;"></button>
                                <div class="so-stock-info" style="grid-column: 1 / -1; font-size: 13px; padding: 8px 12px; margin-top: -5px; display: none; border-radius: 6px; border: 2px solid #e0e0e0; background: white;"></div>
                            </div>
                        </div>
                        <button type="button" class="btn" onclick="addSOLineItem()" style="margin-top: 10px; background: var(--primary, #667eea); color: white;">+ Add Line Item</button>
                    </div>
                    
                    <!-- Card 3: Order Summary -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary, #667eea);"> Order Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); border-radius: 12px; border: 2px solid #7a9bb8;">
                                <div style="font-size: 14px; color: #5a7a8a; margin-bottom: 8px; font-weight: 600;">Total Items</div>
                                <div style="font-size: 32px; font-weight: bold; color: #7a9bb8;" id="soTotalQty">0</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); border-radius: 12px; border: 2px solid #b8a86b;">
                                <div style="font-size: 14px; color: #8a7a4a; margin-bottom: 8px; font-weight: 600;">Total Units</div>
                                <div style="font-size: 32px; font-weight: bold; color: #b8a86b;" id="soTotalUnits">0</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); border-radius: 12px; border: 2px solid #6b9a8d;">
                                <div style="font-size: 14px; color: #5a7a6d; margin-bottom: 8px; font-weight: 600;">Total Amount</div>
                                <div style="font-size: 32px; font-weight: bold; color: #6b9a8d;" id="soTotalAmount">$0.00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="soNotes" rows="2"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" id="createSaleBtn" class="btn" onclick="showOrderPreview()" style="background: var(--primary, #667eea); color: white;"> Create Sale</button>
                        <button type="button" class="btn" onclick="hideAddSaleForm()" style="background: var(--secondary, #764ba2); color: white;">Cancel</button>
                    </div>
                </form>
            </div>
            
            <div id="salesTable" style="margin-top: 30px;"></div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="card">
            <h2>Inventory Report</h2>
            <div class="status" id="inventoryStatus"></div>
            
            <!-- Button Group Card -->
            <div class="filter-card">
                <button class="btn" onclick="loadInventory(true)"> Refresh</button>
                <button class="btn" onclick="showAdjustInventoryForm()" style="background: #f39c12;"> Adjust Inventory</button>
                <button class="btn" onclick="goToAddItem()" style="background: #9c27b0;"> Add New Item</button>
            </div>
            
            <!-- Quick Guide Card -->
            <div class="content-card" style="background: #e3f2fd;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleSection('inventoryGuide')">
                    <strong> Quick Guide</strong>
                    <span id="inventoryGuide-toggle" style="color: var(--primary, #667eea);"> Hide</span>
                </div>
                <div id="inventoryGuide" style="margin-top: 10px;">
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><strong> Add New Item</strong> - Add items you already have in stock (no purchase order needed)</li>
                        <li><strong> Adjust Inventory</strong> - Fix counts, record damage, shrinkage, or physical inventory counts</li>
                        <li><strong> Purchases tab</strong> - Record new inventory from suppliers (creates purchase orders)</li>
                    </ul>
                </div>
            </div>
            
            <!-- Manual Adjustment Form -->
            <div id="adjustInventoryForm" style="display: none; margin-top: 20px; background: #fff8e1; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #f39c12;">
                <h3> Manual Inventory Adjustment</h3>
                <p style="color: #666; margin-bottom: 15px;">Use this for physical counts, damaged goods, shrinkage, etc.</p>
                <form onsubmit="submitInventoryAdjustment(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Item * <small style="color: #888;">(click to search)</small></label>
                            <input type="text" id="adjustItemDisplay" placeholder=" Click to select item..." 
                                   onclick="openItemPickerForAdjustment()" readonly
                                   style="cursor: pointer; background: #fff;">
                            <input type="hidden" id="adjustItem" required>
                        </div>
                        <div class="form-group">
                            <label>Current Quantity</label>
                            <input type="number" id="adjustCurrentQty" readonly style="background: #f0f0f0;">
                        </div>
                        <div class="form-group">
                            <label>Adjustment (+/-) *</label>
                            <input type="number" id="adjustQuantity" placeholder="e.g., -5 or +10" required oninput="updateAdjustNewQty()">
                            <small style="color: #666;">Use negative for decrease, positive for increase</small>
                        </div>
                        <div class="form-group">
                            <label>New Quantity</label>
                            <input type="number" id="adjustNewQty" readonly style="background: #e8f5e9;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Reason * <span style="color: #b88a8a; font-size: 11px;">(required)</span></label>
                        <input type="text" id="adjustReasonDisplay" placeholder=" Click to select reason..." 
                               onclick="openReasonPicker()" readonly
                               style="cursor: pointer; background: #fff; border: 2px solid #f39c12;">
                        <input type="hidden" id="adjustReason" required>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="adjustNotes" rows="2" placeholder="Additional details..."></textarea>
                    </div>
                    <button type="submit" class="btn" onclick="event.preventDefault(); submitInventoryAdjustment(event);"> Save Adjustment</button>
                    <button type="button" class="btn" onclick="hideAdjustInventoryForm()" style="background: var(--secondary, #764ba2); color: white;">Cancel</button>
                </form>
            </div>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;"> Filter Inventory</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-inventory')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-inventory-toggle"> Show</span>
                    </button>
                </div>
                <div id="filter-panel-inventory" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Search SKU/Description</label>
                        <input type="text" id="filterInventorySearch_display" placeholder=" Click to select items..." onclick="openItemPickerForInventory()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="filterInventorySearch" value="">
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <input type="text" id="filterInventorySupplier_display" placeholder=" Click to select suppliers..." onclick="openSupplierPickerForInventory()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="filterInventorySupplier" value="">
                    </div>
                    <div class="form-group">
                        <label>Stock Status</label>
                        <select id="filterInventoryStock" onchange="filterInventory()">
                            <option value="">All Items</option>
                            <option value="negative"> Negative</option>
                            <option value="out"> Out of Stock</option>
                            <option value="low"> Low Stock</option>
                            <option value="ok"> In Stock</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="clearInventoryFilters()" style="background: var(--secondary, #764ba2); color: white;">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div class="data-display-card">
                <div id="inventoryTable"></div>
            </div>
        </div>
        
        <!-- EXPENSES TAB -->
        <div id="expenses" class="card">
            <h2> Expense Management</h2>
            <div class="status" id="expenseStatus"></div>
            
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
                <button class="btn" onclick="loadExpenses()" style="background: #9333ea;"> Refresh</button>
                <button class="btn" onclick="showAddExpenseModal()" style="background: #6b9a8d;"> Add Expense</button>
                <button class="btn" onclick="showAddMileageModal()" style="background: #7aaab8;"> Log Mileage</button>
                <button class="btn" onclick="showGenerateMonthlyModal()" style="background: #b8a86b;"> Generate Monthly</button>
            </div>
            
            <!-- Sub-tabs for expenses -->
            <div style="display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="expense-subtab active" onclick="showExpenseSubtab('log')" style="padding: 10px 20px; border: 2px solid #9333ea; background: #9333ea; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;"> Expense Log</button>
                <button class="expense-subtab" onclick="showExpenseSubtab('recurring')" style="padding: 10px 20px; border: 2px solid #9333ea; background: white; color: #9333ea; border-radius: 8px; cursor: pointer; font-weight: 600;"> Recurring</button>
                <button class="expense-subtab" onclick="showExpenseSubtab('categories')" style="padding: 10px 20px; border: 2px solid #9333ea; background: white; color: #9333ea; border-radius: 8px; cursor: pointer; font-weight: 600;"> Categories</button>
                <button class="expense-subtab" onclick="showExpenseSubtab('mileage')" style="padding: 10px 20px; border: 2px solid #9333ea; background: white; color: #9333ea; border-radius: 8px; cursor: pointer; font-weight: 600;"> Mileage Rates</button>
            </div>
            
            <!-- Expense Log Subtab -->
            <div id="expenseLogSubtab" class="expense-content">
                <div class="section-card">
                    <h3> Expense Log</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                        <div class="form-group" style="margin: 0; min-width: 150px;">
                            <label> From Date</label>
                            <input type="date" id="expenseFromDate">
                        </div>
                        <div class="form-group" style="margin: 0; min-width: 150px;">
                            <label> To Date</label>
                            <input type="date" id="expenseToDate">
                        </div>
                        <div class="form-group" style="margin: 0; min-width: 150px;">
                            <label> Category</label>
                            <select id="expenseCategoryFilter">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <button class="btn" onclick="filterExpenses()" style="align-self: flex-end; background: #9333ea;"> Filter</button>
                    </div>
                    <div id="expenseLogTable"></div>
                </div>
            </div>
            
            <!-- Recurring Expenses Subtab -->
            <div id="expenseRecurringSubtab" class="expense-content" style="display: none;">
                <div class="section-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;"> Recurring Expenses</h3>
                        <button class="btn" onclick="showAddRecurringModal()" style="background: #6b9a8d;"> Add Recurring</button>
                    </div>
                    <p style="color: #666; margin-bottom: 15px;">Set up expenses that repeat monthly, quarterly, or annually. Use "Generate Monthly" to create expense entries from these templates.</p>
                    <div id="recurringExpenseTable"></div>
                </div>
            </div>
            
            <!-- Categories Subtab -->
            <div id="expenseCategoriesSubtab" class="expense-content" style="display: none;">
                <div class="section-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;"> Expense Categories</h3>
                        <button class="btn" onclick="showAddCategoryModal()" style="background: #6b9a8d;"> Add Category</button>
                    </div>
                    <div id="expenseCategoryTable"></div>
                </div>
            </div>
            
            <!-- Mileage Rates Subtab -->
            <div id="expenseMileageSubtab" class="expense-content" style="display: none;">
                <div class="section-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;"> IRS Mileage Rates</h3>
                        <button class="btn" onclick="showAddMileageRateModal()" style="background: #6b9a8d;"> Add Year</button>
                    </div>
                    <p style="color: #666; margin-bottom: 15px;">Configure the IRS standard mileage rate for each year. This rate is used when logging mileage expenses.</p>
                    <div id="mileageRateTable"></div>
                </div>
            </div>
        </div>
        
        <!-- PRICE SIMULATOR TAB -->
        <div id="pricesim" class="card">
            <h2> Pricing Workbench</h2>
            <div class="status" id="pricesimStatus"></div>
            
            <!-- Revenue Impact Calculator - MOVED TO TOP -->
            <div class="section-card accent-theme" style="background: var(--primary-light, #e3f2fd);">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleSection('revenueCalcContent')">
                    <h3 style="margin: 0; color: var(--primary, #667eea);"> Revenue Impact Calculator</h3>
                    <span id="revenueCalcContent-toggle" style="font-size: 14px; color: #666;"> Hide</span>
                </div>
                <div id="revenueCalcContent" style="margin-top: 15px;">
                    <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">See how a price increase affects your profit on a sample sale amount.</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="form-group" style="margin: 0;">
                            <label> Sample Sale Amount</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span style="font-size: 18px; font-weight: bold;">$</span>
                                <input type="number" id="revCalcSaleAmount" value="100" min="1" step="1" style="width: 100px;" oninput="updateRevenueCalc()">
                            </div>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label> Price Increase %</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="revCalcPercent" min="0" max="25" value="10" step="0.5" style="flex: 1;" oninput="updateRevenueCalc()">
                                <span id="revCalcPercentLabel" style="font-weight: bold; color: var(--primary, #667eea); min-width: 45px;">10%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="background: #fff; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #e0e0e0;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">BEFORE Increase</div>
                            <div id="revCalcBefore" style="font-size: 32px; font-weight: bold; color: #666;">$100.00</div>
                            <div style="font-size: 12px; color: #999;">Your Sale</div>
                        </div>
                        <div style="background: #fff; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #e0e0e0;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">AFTER Increase</div>
                            <div id="revCalcAfter" style="font-size: 32px; font-weight: bold; color: #2e7d32;">$110.00</div>
                            <div style="font-size: 12px; color: #999;">New Sale Value</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #6b9a8d, #2e7d32); padding: 20px; border-radius: 12px; text-align: center; color: white;">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">EXTRA PROFIT</div>
                            <div id="revCalcProfit" style="font-size: 32px; font-weight: bold;">+$10.00</div>
                            <div style="font-size: 12px; opacity: 0.9;">Per Sale</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #c0c0c0;">
                        <h4 style="margin: 0 0 10px 0; color: var(--primary, #667eea);"> Projected Impact</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                            <div>
                                <div style="color: #666; font-size: 13px;">10 Sales/Week</div>
                                <div id="revCalc10Sales" style="font-size: 20px; font-weight: bold; color: #2e7d32;">+$100/week</div>
                            </div>
                            <div>
                                <div style="color: #666; font-size: 13px;">Monthly (40 sales)</div>
                                <div id="revCalcMonthly" style="font-size: 20px; font-weight: bold; color: #2e7d32;">+$400/month</div>
                            </div>
                            <div>
                                <div style="color: #666; font-size: 13px;">Yearly (520 sales)</div>
                                <div id="revCalcYearly" style="font-size: 20px; font-weight: bold; color: #2e7d32;">+$5,200/year</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section-card accent-theme" style="background: linear-gradient(135deg, #667eea15, #764ba215);">
                <h3 style="margin: 0 0 10px 0; color: #667eea;"> What You Can Do Here</h3>
                <p style="margin: 0; color: #555;">
                    <strong> Existing Items:</strong> Adjust sell prices by % or flat amount, preview impact, then apply<br>
                    <strong> New Items:</strong> Add items from supplier catalog, enter cost, simulate different markups to find the right sell price
                </p>
            </div>
            
            <!-- ADD NEW ITEM SECTION -->
            <div class="section-card accent-theme" style="background: #fff3e0;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleSection('addNewItemContent')">
                    <h3 style="margin: 0; color: #e65100;"> Add New Item from Supplier Catalog</h3>
                    <span id="addNewItemContent-toggle" style="font-size: 14px; color: #666;"> Hide</span>
                </div>
                <div id="addNewItemContent" style="margin-top: 15px;">
                <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">Enter item details from your supplier's catalog. Set the markup % to calculate a sell price, then add to simulation to compare.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Supplier *</label>
                        <select id="newSimSupplier" required>
                            <option value="">Select Supplier</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>SKU / UPC</label>
                        <input type="text" id="newSimSKU" placeholder="e.g., 41633009999">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Description *</label>
                        <input type="text" id="newSimDescription" placeholder="e.g., Cheese Puffs, 12ct" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Package Cost *</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span>$</span>
                            <input type="number" id="newSimPackageCost" step="0.01" min="0" placeholder="18.50" oninput="calcNewSimUnitCost()">
                        </div>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Units/Package *</label>
                        <input type="number" id="newSimUnitsPerPkg" step="1" min="1" value="1" placeholder="12" oninput="calcNewSimUnitCost()">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Unit Cost</label>
                        <input type="text" id="newSimUnitCost" readonly style="background: #e0e0e0; font-weight: bold;" value="$0.00">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Markup %</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number" id="newSimMarkup" value="30" min="0" max="500" step="1" style="width: 70px;" oninput="calcNewSimSellPrice()">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Sell Price</label>
                        <input type="text" id="newSimSellPrice" readonly style="background: #c8e6c9; font-weight: bold; color: #2e7d32;" value="$0.00">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" class="btn" onclick="addNewItemToSimulation()" style="background: #b8a86b;">
                         Add to Simulation
                    </button>
                    <button type="button" class="btn" onclick="clearNewSimForm()" style="background: var(--secondary, #764ba2); color: white;">
                         Clear Form
                    </button>
                </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="section-card accent-theme" style="background: #f8f9fa;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0;"> Filter Existing Items</h3>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-pricesim')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-pricesim-toggle"> Show</span>
                    </button>
                </div>
                <div id="filter-panel-pricesim" class="form-grid" style="display: none;">
                    <div class="form-group" style="margin: 0;">
                        <label>Search SKU/Description</label>
                        <input type="text" id="pricesimSearch_display" placeholder=" Click to select items..." onclick="openItemPickerForPricing()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="pricesimSearch" value="">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Supplier</label>
                        <input type="text" id="pricesimSupplier_display" placeholder=" Click to select suppliers..." onclick="openSupplierPickerForPricing()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="pricesimSupplier" value="">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Stock Status</label>
                        <select id="pricesimStock" onchange="filterPriceSimItems()">
                            <option value="">All Items</option>
                            <option value="instock">In Stock Only</option>
                            <option value="low">Low Stock</option>
                            <option value="out">Out of Stock</option>
                            <option value="new"> New (Simulated Only)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Price Adjustment Controls -->
            <div class="section-card accent-theme" style="background: #e8f5e9;">
                <h3 style="margin: 0 0 15px 0; color: #2e7d32;"> Bulk Price Adjustment (Existing Items)</h3>
                <div style="display: flex; gap: 20px; align-items: end; flex-wrap: wrap;">
                    <div class="form-group" style="margin: 0; min-width: 200px;">
                        <label>Increase by Percentage</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="pricesimPercent" value="10" min="0" max="50" step="0.5" style="flex: 1;" oninput="updatePercentLabel(); clearFlatAmount()">
                            <span id="pricesimPercentLabel" style="font-weight: bold; color: #2e7d32; min-width: 50px; text-align: right;">10%</span>
                        </div>
                    </div>
                    <div style="color: #666; font-size: 14px; padding-bottom: 8px;"> OR </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Increase by Flat Amount</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="font-size: 18px; font-weight: bold;">$</span>
                            <input type="number" id="pricesimFlat" value="0" min="0" step="0.01" style="width: 80px;" oninput="clearPercentAmount()">
                        </div>
                    </div>
                    <button class="btn" onclick="previewPriceChanges()" style="height: 42px;">
                         Preview Changes
                    </button>
                </div>
            </div>
            
            <!-- Impact Summary Cards -->
            <div id="pricesimSummary" style="display: none; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                    <div style="background: #667eea; color: white; padding: 15px; border-radius: 12px; text-align: center; overflow: hidden;">
                        <div style="font-size: 12px; opacity: 0.9;">Selected Items</div>
                        <div id="simSelectedCount" style="font-size: 28px; font-weight: bold;">0</div>
                    </div>
                    <div style="background: #8a8a8a; color: white; padding: 15px; border-radius: 12px; text-align: center; overflow: hidden;">
                        <div style="font-size: 12px; opacity: 0.9;">Current Revenue</div>
                        <div id="simCurrentRevenue" style="font-size: 20px; font-weight: bold; word-break: break-all;">$0.00</div>
                    </div>
                    <div style="background: #6b9a8d; color: white; padding: 15px; border-radius: 12px; text-align: center; overflow: hidden;">
                        <div style="font-size: 12px; opacity: 0.9;">New Revenue</div>
                        <div id="simNewRevenue" style="font-size: 20px; font-weight: bold; word-break: break-all;">$0.00</div>
                    </div>
                    <div style="background: #7aaab8; color: white; padding: 15px; border-radius: 12px; text-align: center; overflow: hidden;">
                        <div style="font-size: 12px; opacity: 0.9;">Revenue Increase</div>
                        <div id="simIncrease" style="font-size: 20px; font-weight: bold; word-break: break-all;">+$0.00</div>
                    </div>
                </div>
            </div>
            
            <!-- INVENTORY IMPACT - Simple info strip style -->
            <div id="pricesimInventoryImpact" style="display: none; margin-bottom: 20px; padding: 15px 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px;"></span>
                        <span style="font-weight: 600; color: #495057;">Inventory Impact:</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: #8a8a8a; text-transform: uppercase;">Current Value</div>
                            <div id="simCurrentInvValue" style="font-size: 16px; font-weight: bold; color: #495057;">$0.00</div>
                        </div>
                        <div style="font-size: 20px; color: #adb5bd;"></div>
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: #8a8a8a; text-transform: uppercase;">New Value</div>
                            <div id="simNewInvValue" style="font-size: 16px; font-weight: bold; color: #495057;">$0.00</div>
                        </div>
                        <div style="font-size: 20px; color: #adb5bd;">=</div>
                        <div style="text-align: center; background: #e0ebe7; padding: 8px 15px; border-radius: 6px;">
                            <div style="font-size: 11px; color: #4a6b5f; text-transform: uppercase;">Extra Profit</div>
                            <div id="simInvProfit" style="font-size: 18px; font-weight: bold; color: #4a6b5f;">+$0.00</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Apply Button - MOVED BEFORE TABLE (#5) -->
            <div id="pricesimApplySection" class="section-card accent-theme" style="display: none; background: #f0e8d0;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <strong style="font-size: 18px;"> Ready to Apply Changes?</strong>
                        <p style="margin: 5px 0 0 0; color: #666;">This will update the Unit Sell Price for all selected items in your database.</p>
                    </div>
                    <button class="btn" onclick="applyPriceChanges()" style="font-size: 16px; padding: 15px 30px;">
                         APPLY CHANGES TO <span id="applyCount">0</span> ITEMS
                    </button>
                </div>
            </div>
            
            <!-- Items Table -->
            <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
                        <input type="checkbox" id="pricesimSelectAll" onchange="toggleAllPriceSimItems()" style="width: 18px; height: 18px;">
                        <strong>Select All Visible Items</strong>
                    </label>
                    <div style="background: #e3f2fd; padding: 8px 12px; border-radius: 6px; border-left: 3px solid #1976d2;">
                        <p style="margin: 0; font-size: 13px; color: #1565c0;">
                            <strong> Tip:</strong> Check the items you want to update, then click Preview Changes
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="data-display-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 2px solid #e0e0e0;">
                    <h3 style="margin: 0; color: #667eea;"> Items in Simulation</h3>
                    <button class="btn" onclick="loadPriceSimItems()" style="background: var(--primary, #667eea); color: white;"> Refresh Items</button>
                </div>
                <div id="pricesimTable" style="overflow-x: auto;"></div>
            </div>
        </div>
        
        <!-- INVENTORY FLOW DASHBOARD TAB -->
        <div id="invflow" class="card">
            <h2> Inventory Flow Dashboard</h2>
            <p style="color: #666; margin-bottom: 20px;">Real-time visibility into inventory movement: what's coming in, what's going out, and what needs attention</p>
            
            <!-- Critical Alerts Section -->
            <div class="content-card" style="margin-bottom: 20px; border-left: 4px solid #b88a8a;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #b88a8a;"> Critical Alerts</h3>
                    <button class="btn-small" onclick="refreshInventoryFlowWithTimeout()" style="background: #b88a8a; color: white;"> Refresh</button>
                </div>
                <div id="invflowAlerts">
                    <!-- Alerts populated by JavaScript -->
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <div style="font-size: 32px; margin-bottom: 10px;"></div>
                        <div>Loading alerts...</div>
                    </div>
                </div>
            </div>
            
            <!-- Summary Metrics -->
            <div class="content-card" style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; color: #667eea;"> Summary Metrics</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <!-- Total On Order -->
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); border-radius: 12px; border: 2px solid #7a9bb8;">
                        <div style="font-size: 36px; margin-bottom: 8px;"></div>
                        <div style="font-size: 32px; font-weight: bold; color: #5a7a8a;" id="invflowTotalOnOrder">0</div>
                        <div style="font-size: 14px; color: #7a9bb8; margin-top: 4px;">Total On Order</div>
                    </div>
                    
                    <!-- Total Backorder -->
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); border-radius: 12px; border: 2px solid #b8a86b;">
                        <div style="font-size: 36px; margin-bottom: 8px;"></div>
                        <div style="font-size: 32px; font-weight: bold; color: #8a7a4a;" id="invflowTotalBackorder">0</div>
                        <div style="font-size: 14px; color: #b8a86b; margin-top: 4px;">Total Backorder</div>
                    </div>
                    
                    <!-- Expected This Week -->
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); border-radius: 12px; border: 2px solid #6b9a8d;">
                        <div style="font-size: 36px; margin-bottom: 8px;"></div>
                        <div style="font-size: 32px; font-weight: bold; color: #4a7a6d;" id="invflowPOsThisWeek">0</div>
                        <div style="font-size: 14px; color: #6b9a8d; margin-top: 4px;">POs This Week</div>
                    </div>
                    
                    <!-- Total Value Pending -->
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f0e8f0 0%, #e4d8e8 100%); border-radius: 12px; border: 2px solid #9a8ab8;">
                        <div style="font-size: 36px; margin-bottom: 8px;"></div>
                        <div style="font-size: 32px; font-weight: bold; color: #6a5a8a;" id="invflowTotalValue">$0</div>
                        <div style="font-size: 14px; color: #9a8ab8; margin-top: 4px;">Value Pending</div>
                    </div>
                </div>
            </div>
            
            <!-- Items On Backorder Section -->
            <div class="content-card" style="margin-bottom: 20px; border-left: 4px solid #f57c00;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #f57c00;"> Items On Backorder <span style="background: #b8a86b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 14px; margin-left: 8px;" id="invflowBackorderCount">0</span></h3>
                    <button class="btn-small" onclick="switchTab('createpo')" style="background: #f57c00; color: white;"> Restock Items</button>
                </div>
                <div id="invflowBackorderItems">
                    <!-- Backorder items populated by JavaScript -->
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                        <div style="font-size: 16px; color: #666;">No items on backorder</div>
                        <div style="font-size: 14px; color: #999; margin-top: 8px;">All customer orders can be fulfilled!</div>
                    </div>
                </div>
            </div>
            
            <!-- Pending Arrivals Section -->
            <div class="content-card" style="margin-bottom: 20px; border-left: 4px solid #1976d2;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #1976d2;"> Pending Arrivals <span style="background: #7a9bb8; color: white; padding: 2px 8px; border-radius: 12px; font-size: 14px; margin-left: 8px;" id="invflowPendingCount">0</span></h3>
                    <button class="btn-small" onclick="switchTab('purchases')" style="background: #1976d2; color: white;">View All POs</button>
                </div>
                <div id="invflowPendingPOs">
                    <!-- Pending POs populated by JavaScript -->
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                        <div style="font-size: 16px; color: #666;">No pending arrivals</div>
                        <div style="font-size: 14px; color: #999; margin-top: 8px;">No purchase orders expected</div>
                    </div>
                </div>
            </div>
            
            <!-- Critical Items Section -->
            <div class="content-card" style="border-left: 4px solid #b88a8a;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #b88a8a;"> Critical Items <span style="background: #b88a8a; color: white; padding: 2px 8px; border-radius: 12px; font-size: 14px; margin-left: 8px;" id="invflowCriticalCount">0</span></h3>
                    <button class="btn-small" onclick="viewCriticalItemsReport()" style="background: #b88a8a; color: white;"> View Report</button>
                </div>
                <div id="invflowCriticalItems">
                    <!-- Critical items populated by JavaScript -->
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                        <div style="font-size: 16px; color: #666;">No critical items</div>
                        <div style="font-size: 14px; color: #999; margin-top: 8px;">All items have adequate stock levels</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- REPORTS TAB -->
        <div id="reports" class="card active">
            <h2> Business Reports</h2>
            <div class="status" id="reportsStatus"></div>
            
            <p style="color: #666; margin-bottom: 20px;">Generate professional reports to analyze your business performance</p>
            
            <!-- Report Selection Buttons - Organized Grid -->
            <div class="report-grid">
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('dashboardReports')">
                        <h4> Dashboards</h4>
                        <span id="dashboardReports-toggle" class="report-toggle"></span>
                    </div>
                    <div id="dashboardReports" class="report-buttons">
                        <button class="btn report-btn" onclick="showReport('action-dashboard')" style="background: linear-gradient(135deg, #b88a8a, #b88a8a) !important; color: white !important; font-weight: 700; border-left: 4px solid #b91c1c !important;"> Action Dashboard</button>
                        <button class="btn report-btn" onclick="showReport('business-overview')"> Business Overview</button>
                        <button class="btn report-btn" onclick="showReport('daily-dashboard')"> Daily Sales Dashboard</button>
                        <button class="btn report-btn" onclick="showReport('product-dashboard')"> Product Performance Dashboard</button>
                        <button class="btn report-btn" onclick="showReport('supplier-dashboard')"> Supplier Performance Dashboard</button>
                    </div>
                </div>
                
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('salesReports')">
                        <h4> Sales Reports</h4>
                        <span id="salesReports-toggle" class="report-toggle"></span>
                    </div>
                    <div id="salesReports" class="report-buttons">
                        <button class="btn report-btn" onclick="showReport('sales-by-customer')"> Sales by Customer</button>
                        <button class="btn report-btn" onclick="showReport('sales-order-detail')"> Sales Order Detail</button>
                        <button class="btn report-btn" onclick="showReport('sales-by-product')"> Sales by Item</button>
                        <button class="btn report-btn" onclick="showReport('customer-backorders')"> Customer Backorders</button>
                        <button class="btn report-btn" onclick="showReport('pick-list')"> Pick List</button>
                        <button class="btn report-btn" onclick="showReport('dormant-customers')"> Dormant Customers</button>
                    </div>
                </div>
                
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('purchaseReports')">
                        <h4> Purchase Reports</h4>
                        <span id="purchaseReports-toggle" class="report-toggle"></span>
                    </div>
                    <div id="purchaseReports" class="report-buttons">
                        <button class="btn report-btn" onclick="showReport('purchase-by-supplier')"> Purchase by Supplier</button>
                        <button class="btn report-btn" onclick="showReport('purchase-order-detail')"> Purchase Order Detail</button>
                        <button class="btn report-btn" onclick="showReport('supplier-performance')"> Supplier Performance</button>
                    </div>
                </div>
                
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('inventoryReports')">
                        <h4> Inventory Reports</h4>
                        <span id="inventoryReports-toggle" class="report-toggle"></span>
                    </div>
                    <div id="inventoryReports" class="report-buttons">
                        <button class="btn report-btn" onclick="showReport('inventory-flow')"> Inventory Flow Dashboard</button>
                        <button class="btn report-btn" onclick="showReport('simple-inventory')"> Inventory List / Bulk Order</button>
                        <button class="btn report-btn" onclick="showReport('inventory-turnover')"> Inventory Turnover</button>
                        <button class="btn report-btn" onclick="showReport('gross-margin')"> Gross Margin</button>
                        <button class="btn report-btn" onclick="showReport('inventory-adjustments')"> Adjustment History</button>
                    </div>
                </div>
                
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('financialReports')">
                        <h4> Financial Reports</h4>
                        <span id="financialReports-toggle" class="report-toggle"></span>
                    </div>
                    <div id="financialReports" class="report-buttons">
                        <button class="btn report-btn report-btn-green" onclick="showReport('accounts-receivable')"> Accounts Receivable</button>
                        <button class="btn report-btn report-btn-red" onclick="showReport('accounts-payable')"> Accounts Payable</button>
                    </div>
                </div>
                
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('taxReports')">
                        <h4> Tax & Annual Reports</h4>
                        <span id="taxReports-toggle" class="report-toggle"></span>
                    </div>
                    <div id="taxReports" class="report-buttons">
                        <button class="btn report-btn" onclick="showReport('profit-loss')"> Profit & Loss Statement</button>
                        <button class="btn report-btn" onclick="showReport('annual-sales-summary')"> Annual Sales Summary</button>
                        <button class="btn report-btn" onclick="showReport('annual-purchase-summary')"> Annual Purchase Summary</button>
                        <button class="btn report-btn" onclick="showReport('inventory-valuation')"> Inventory Valuation</button>
                        <button class="btn report-btn" onclick="showReport('cash-flow-summary')"> Cash Flow Summary</button>
                    </div>
                </div>
            </div>
            
            <!-- Report Container -->
            <div class="data-display-card">
                <div id="reportContainer"></div>
            </div>
        </div>
        
        <!-- HELP & GUIDES TAB -->
        <div id="guides" class="card">
            <!-- Premium Header -->
            <div style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; padding: 35px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(5, 150, 105, 0.3), 0 4px 12px rgba(0,0,0,0.1); border: 2px solid rgba(255, 255, 255, 0.1);">
                <h2 style="margin: 0 0 10px 0; font-size: 32px; display: flex; align-items: center; gap: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                     Help Center & User Guides
                </h2>
                <p style="margin: 0; font-size: 16px; opacity: 0.95;">
                    Everything you need to master the Nowak Distributing ERP system
                </p>
            </div>
            
            <!-- Quick Start Banner -->
            <div onclick="scrollToGuideSection('quick-start')" style="background: linear-gradient(135deg, #fbbf24 0%, #b8a86b 100%); border-radius: 16px; padding: 25px; margin-bottom: 30px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(245, 158, 11, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(245, 158, 11, 0.3)';">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="font-size: 48px;"></div>
                    <div>
                        <h3 style="margin: 0 0 8px 0; color: #1f2937; font-size: 22px;">New Here? Start with the 5-Minute Quick Start Guide</h3>
                        <p style="margin: 0; color: #374151; font-size: 15px;">Get up and running in minutes with our streamlined setup guide</p>
                    </div>
                    <div style="margin-left: auto; font-size: 24px; color: #1f2937;"></div>
                </div>
            </div>
            
            <!-- Guide Navigation Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px;">
                
                <!-- Quick Start Card -->
                <div onclick="scrollToGuideSection('quick-start')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#059669'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Quick Start Guide</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">5-minute setup to get running</p>
                    <div style="margin-top: 12px; color: #059669; font-weight: 600; font-size: 13px;">START HERE </div>
                </div>
                
                <!-- Getting Started Card -->
                <div onclick="scrollToGuideSection('getting-started')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#3b82f6'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Getting Started Tutorial</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Complete 30-minute walkthrough</p>
                    <div style="margin-top: 12px; color: #3b82f6; font-weight: 600; font-size: 13px;">READ GUIDE </div>
                </div>
                
                <!-- Feature Overview Card -->
                <div onclick="scrollToGuideSection('features')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#8b5cf6'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Feature Overview</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">What's new & all features</p>
                    <div style="margin-top: 12px; color: #8b5cf6; font-weight: 600; font-size: 13px;">EXPLORE </div>
                </div>
                
                <!-- FAQ Card -->
                <div onclick="scrollToGuideSection('faq')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#b8a86b'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">FAQ</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Most asked questions answered</p>
                    <div style="margin-top: 12px; color: #b8a86b; font-weight: 600; font-size: 13px;">GET ANSWERS </div>
                </div>
                
                <!-- How-To Guides Card -->
                <div onclick="scrollToGuideSection('how-to')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#10b981'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">How-To Guides</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Step-by-step task instructions</p>
                    <div style="margin-top: 12px; color: #10b981; font-weight: 600; font-size: 13px;">VIEW ALL </div>
                </div>
                
                <!-- Mobile App Guide Card -->
                <div onclick="scrollToGuideSection('mobile')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#ec4899'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Mobile Access Guide</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Android, iPhone & tablet setup</p>
                    <div style="margin-top: 12px; color: #ec4899; font-weight: 600; font-size: 13px;">SETUP MOBILE </div>
                </div>
                
                <!-- Keyboard Shortcuts Card -->
                <div onclick="scrollToGuideSection('shortcuts')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#6366f1'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Keyboard Shortcuts</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Work faster with shortcuts</p>
                    <div style="margin-top: 12px; color: #6366f1; font-weight: 600; font-size: 13px;">LEARN SHORTCUTS </div>
                </div>
                
                <!-- Troubleshooting Card -->
                <div onclick="scrollToGuideSection('troubleshooting')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#b88a8a'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Troubleshooting</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Fix common issues quickly</p>
                    <div style="margin-top: 12px; color: #b88a8a; font-weight: 600; font-size: 13px;">GET HELP </div>
                </div>
                
                <!-- Best Practices Card -->
                <div onclick="scrollToGuideSection('best-practices')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#14b8a6'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Best Practices</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Tips from power users</p>
                    <div style="margin-top: 12px; color: #14b8a6; font-weight: 600; font-size: 13px;">LEARN TIPS </div>
                </div>
                
                <!-- Data Import/Export Card -->
                <div onclick="scrollToGuideSection('import-export')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#0891b2'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Data Import/Export</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Move data in and out</p>
                    <div style="margin-top: 12px; color: #0891b2; font-weight: 600; font-size: 13px;">VIEW GUIDE </div>
                </div>
                
                <!-- Backup & Recovery Card -->
                <div onclick="scrollToGuideSection('backup')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#7c3aed'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Backup & Recovery</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Protect your data</p>
                    <div style="margin-top: 12px; color: #7c3aed; font-weight: 600; font-size: 13px;">LEARN MORE </div>
                </div>
                
                <!-- Quick Reference Card -->
                <div onclick="scrollToGuideSection('cheatsheet')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#ea580c'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Quick Reference Card</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Printable cheat sheet</p>
                    <div style="margin-top: 12px; color: #ea580c; font-weight: 600; font-size: 13px;">PRINT IT </div>
                </div>
                
                <!-- Error Messages Card -->
                <div onclick="scrollToGuideSection('errors')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#b88a8a'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Error Messages</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">What they mean & fixes</p>
                    <div style="margin-top: 12px; color: #b88a8a; font-weight: 600; font-size: 13px;">DECODE ERRORS </div>
                </div>
                
                <!-- Browser Compatibility Card -->
                <div onclick="scrollToGuideSection('browsers')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#2563eb'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Browser Compatibility</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Supported browsers & devices</p>
                    <div style="margin-top: 12px; color: #2563eb; font-weight: 600; font-size: 13px;">CHECK COMPATIBILITY </div>
                </div>
                
            </div>
            
            <!-- GUIDE CONTENT SECTIONS -->
            <div id="guide-content-container" style="background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden;">
            
                <!-- ==================== QUICK START GUIDE ==================== -->
                <div id="guide-quick-start" class="guide-content-section" style="padding: 40px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #059669;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Quick Start Guide</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Get up and running in 5 minutes</p>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 12px; padding: 25px; margin-bottom: 30px; border-left: 5px solid #059669;">
                        <h4 style="margin: 0 0 10px 0; color: #065f46;"> Welcome to Nowak Distributing ERP!</h4>
                        <p style="margin: 0; color: #047857;">This quick start guide will have you managing your snack distribution business like a pro in just 5 minutes. Follow these simple steps to get started.</p>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- Step 1 -->
                        <div style="display: flex; gap: 20px; align-items: flex-start; padding: 25px; background: #f8fafc; border-radius: 12px; border-left: 5px solid #3b82f6;">
                            <div style="background: #3b82f6; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; flex-shrink: 0;">1</div>
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #1e40af;">Add Your Suppliers</h4>
                                <p style="margin: 0; color: #475569;">Click <strong>Suppliers</strong> in the navigation  Click <strong>+ Add Supplier</strong>  Enter supplier info (Better Made, Brimhall, Kim's Processing)  Save</p>
                                <div style="margin-top: 10px; padding: 10px; background: #dbeafe; border-radius: 6px; font-size: 13px; color: #1e40af;">
                                     <strong>Pro Tip:</strong> Add phone numbers and emails so you can quickly contact suppliers when placing orders.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 2 -->
                        <div style="display: flex; gap: 20px; align-items: flex-start; padding: 25px; background: #f8fafc; border-radius: 12px; border-left: 5px solid #8b5cf6;">
                            <div style="background: #8b5cf6; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; flex-shrink: 0;">2</div>
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #6d28d9;">Add Your Products (Items)</h4>
                                <p style="margin: 0; color: #475569;">Click <strong>Items</strong>  Click <strong>+ Add Item</strong>  Select supplier, enter SKU, description, package cost, sell price, and units per package  Save</p>
                                <div style="margin-top: 10px; padding: 10px; background: #ede9fe; border-radius: 6px; font-size: 13px; color: #6d28d9;">
                                     <strong>Pro Tip:</strong> The unit cost calculates automatically from package cost  units per package.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 3 -->
                        <div style="display: flex; gap: 20px; align-items: flex-start; padding: 25px; background: #f8fafc; border-radius: 12px; border-left: 5px solid #10b981;">
                            <div style="background: #10b981; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; flex-shrink: 0;">3</div>
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #047857;">Add Your Customers</h4>
                                <p style="margin: 0; color: #475569;">Click <strong>Customers</strong>  Click <strong>+ Add Customer</strong>  Enter business name, contact info, and payment terms  Save</p>
                                <div style="margin-top: 10px; padding: 10px; background: #d1fae5; border-radius: 6px; font-size: 13px; color: #047857;">
                                     <strong>Pro Tip:</strong> Set payment terms (Net 30, COD, etc.) to track when payments are due.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 4 -->
                        <div style="display: flex; gap: 20px; align-items: flex-start; padding: 25px; background: #f8fafc; border-radius: 12px; border-left: 5px solid #b8a86b;">
                            <div style="background: #b8a86b; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; flex-shrink: 0;">4</div>
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #b45309;">Create Your First Purchase Order</h4>
                                <p style="margin: 0; color: #475569;">Click <strong>Create PO</strong>  Select supplier  Add items and quantities  Set dates  Click <strong>Submit PO</strong></p>
                                <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 13px; color: #b45309;">
                                     <strong>Pro Tip:</strong> Use the "Add All Items" button to quickly add every item from that supplier.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 5 -->
                        <div style="display: flex; gap: 20px; align-items: flex-start; padding: 25px; background: #f8fafc; border-radius: 12px; border-left: 5px solid #ec4899;">
                            <div style="background: #ec4899; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; flex-shrink: 0;">5</div>
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #be185d;">Create Your First Sales Order</h4>
                                <p style="margin: 0; color: #475569;">Click <strong>Sales</strong>  Click <strong>+ Create Invoice</strong>  Select customer  Add items  Save & Print invoice</p>
                                <div style="margin-top: 10px; padding: 10px; background: #fce7f3; border-radius: 6px; font-size: 13px; color: #be185d;">
                                     <strong>Pro Tip:</strong> Use the Pick List report to see what items you need to gather for delivery.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #059669 0%, #10b981 100%); border-radius: 12px; color: white; text-align: center;">
                        <h3 style="margin: 0 0 10px 0;"> You're Ready to Go!</h3>
                        <p style="margin: 0; opacity: 0.95;">Now explore the Reports section to see your business analytics and dashboards.</p>
                        <button onclick="switchTab('reports')" style="margin-top: 15px; background: white; color: #059669; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 15px;">View Reports </button>
                    </div>
                </div>
                
                <!-- ==================== GETTING STARTED TUTORIAL ==================== -->
                <div id="guide-getting-started" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #3b82f6;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Complete Getting Started Tutorial</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">30-minute comprehensive walkthrough</p>
                        </div>
                    </div>
                    
                    <!-- Table of Contents -->
                    <div style="background: #f1f5f9; border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                        <h4 style="margin: 0 0 15px 0; color: #334155;"> Table of Contents</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <a href="#gs-overview" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">1. System Overview</a>
                            <a href="#gs-navigation" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">2. Navigation Guide</a>
                            <a href="#gs-suppliers" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">3. Managing Suppliers</a>
                            <a href="#gs-items" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">4. Managing Items</a>
                            <a href="#gs-customers" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">5. Managing Customers</a>
                            <a href="#gs-purchasing" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">6. Purchase Orders</a>
                            <a href="#gs-sales" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">7. Sales & Invoicing</a>
                            <a href="#gs-inventory" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">8. Inventory Management</a>
                            <a href="#gs-reports" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">9. Reports & Analytics</a>
                        </div>
                    </div>
                    
                    <!-- Section 1: Overview -->
                    <div id="gs-overview" style="margin-bottom: 40px;">
                        <h3 style="color: #1e40af; border-bottom: 2px solid #dbeafe; padding-bottom: 10px;">1. System Overview</h3>
                        <p style="color: #475569; line-height: 1.7;">The Nowak Distributing ERP is a complete business management system designed specifically for snack food distribution. It handles everything from managing your supplier relationships and product catalog to processing purchase orders, creating customer invoices, tracking inventory, and generating business reports.</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div style="background: #eff6ff; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; margin-bottom: 8px;"></div>
                                <strong style="color: #1e40af;">Suppliers</strong>
                                <p style="margin: 5px 0 0 0; font-size: 13px; color: #64748b;">Better Made, Brimhall, Kim's</p>
                            </div>
                            <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; margin-bottom: 8px;"></div>
                                <strong style="color: #166534;">Items</strong>
                                <p style="margin: 5px 0 0 0; font-size: 13px; color: #64748b;">Your product catalog</p>
                            </div>
                            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; margin-bottom: 8px;"></div>
                                <strong style="color: #b45309;">Customers</strong>
                                <p style="margin: 5px 0 0 0; font-size: 13px; color: #64748b;">Stores, restaurants, etc.</p>
                            </div>
                            <div style="background: #fce7f3; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; margin-bottom: 8px;"></div>
                                <strong style="color: #be185d;">Reports</strong>
                                <p style="margin: 5px 0 0 0; font-size: 13px; color: #64748b;">Business analytics</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 2: Navigation -->
                    <div id="gs-navigation" style="margin-bottom: 40px;">
                        <h3 style="color: #1e40af; border-bottom: 2px solid #dbeafe; padding-bottom: 10px;">2. Navigation Guide</h3>
                        <p style="color: #475569; line-height: 1.7;">The navigation bar at the top of the screen provides quick access to all sections:</p>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                            <tr style="background: #f1f5f9;">
                                <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Tab</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Purpose</th>
                            </tr>
                            <tr><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Reports</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">View dashboards, sales reports, inventory reports, and business analytics</td></tr>
                            <tr style="background: #f8fafc;"><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Suppliers</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">Manage your vendor relationships (Better Made, Brimhall, Kim's)</td></tr>
                            <tr><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Items</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">Manage your product catalog with pricing</td></tr>
                            <tr style="background: #f8fafc;"><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Customers</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">Manage customer accounts and contact info</td></tr>
                            <tr><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Create PO</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">Create new purchase orders to suppliers</td></tr>
                            <tr style="background: #f8fafc;"><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Purchases</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">View and manage all purchase orders</td></tr>
                            <tr><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Sales</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">Create invoices and manage sales orders</td></tr>
                            <tr style="background: #f8fafc;"><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Inventory</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">Track stock levels and make adjustments</td></tr>
                            <tr><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Price Sim</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">Simulate price changes and see revenue impact</td></tr>
                            <tr style="background: #f8fafc;"><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Help</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">Access guides and documentation (you're here!)</td></tr>
                        </table>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #b8a86b;">
                            <strong style="color: #b45309;"> Navigation Tips:</strong>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px; color: #92400e;">
                                <li>Use the  button (bottom-left) to scroll back to top</li>
                                <li>Use the  button to go back to the previous tab</li>
                                <li>Click the  gear icon (top-right) for settings and theme options</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Continue with more sections... -->
                    <div style="padding: 20px; background: #f1f5f9; border-radius: 12px; text-align: center;">
                        <p style="margin: 0; color: #64748b;">For detailed walkthroughs of each section, see the <strong>How-To Guides</strong> below.</p>
                    </div>
                </div>
                
                <!-- ==================== FEATURE OVERVIEW ==================== -->
                <div id="guide-features" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #8b5cf6;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Feature Overview & What's New</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">All features and recent updates</p>
                        </div>
                    </div>
                    
                    <!-- What's New Section -->
                    <div style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-radius: 12px; padding: 25px; margin-bottom: 30px; border: 2px solid #c4b5fd;">
                        <h4 style="margin: 0 0 15px 0; color: #7c3aed;"> Latest Updates (Version 10Y)</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #6d28d9;">
                            <li style="margin-bottom: 8px;"><strong>Number Formatting:</strong> All dollar amounts and quantities now display with commas for easier reading</li>
                            <li style="margin-bottom: 8px;"><strong>Inventory Flow Dashboard:</strong> Real-time visibility into inventory movement</li>
                            <li style="margin-bottom: 8px;"><strong>Partial PO Receiving:</strong> Receive partial shipments and track remaining quantities</li>
                            <li style="margin-bottom: 8px;"><strong>Enhanced Dashboards:</strong> Premium styling with gradient headers throughout</li>
                            <li style="margin-bottom: 8px;"><strong>Pick List Report:</strong> Efficiently gather items for delivery routes</li>
                            <li style="margin-bottom: 8px;"><strong>Dormant Customers Report:</strong> Identify and win back inactive customers with buying history</li>
                            <li><strong>13 Theme Options:</strong> Including Chicago sports teams and Green Bay Packers</li>
                        </ul>
                    </div>
                    
                    <!-- Feature Categories -->
                    <h3 style="color: #1f2937; margin-bottom: 20px;"> Complete Feature List</h3>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- Master Data -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #3b82f6;">
                            <h4 style="margin: 0 0 15px 0; color: #1e40af;"> Master Data Management</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Supplier Management</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Item/Product Catalog</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Customer Database</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Search & Filter</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Bulk Operations</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Archive/Restore</div>
                            </div>
                        </div>
                        
                        <!-- Purchasing -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #10b981;">
                            <h4 style="margin: 0 0 15px 0; color: #047857;"> Purchasing Features</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Create Purchase Orders</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Receive Full/Partial Shipments</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Track Payment Status</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Print PO Documents</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Edit Line Items</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Auto-Update Inventory</div>
                            </div>
                        </div>
                        
                        <!-- Sales -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #b8a86b;">
                            <h4 style="margin: 0 0 15px 0; color: #b45309;"> Sales & Invoicing</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Create Sales Orders</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Print Professional Invoices</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Payment Tracking</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Quick Item Picker</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Auto-Calculate Totals</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Pick List Generation</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Dormant Customer Tracking</div>
                            </div>
                        </div>
                        
                        <!-- Reporting -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #8b5cf6;">
                            <h4 style="margin: 0 0 15px 0; color: #6d28d9;"> Reports & Dashboards</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Action Dashboard</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Business Overview</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Sales Dashboard</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Inventory Flow Dashboard</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Customer & Product Analytics</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Dormant Customers Report</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Accounts Receivable/Payable</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Profit & Loss Statement</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Supplier Performance</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ==================== FAQ ==================== -->
                <div id="guide-faq" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #b8a86b;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Frequently Asked Questions</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Quick answers to common questions</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 15px;">
                        <!-- FAQ Item -->
                        <details style="background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <summary style="padding: 20px; cursor: pointer; font-weight: 600; color: #1f2937; background: #f8fafc;">How do I change the app's theme/colors?</summary>
                            <div style="padding: 20px; background: white; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; color: #475569;">Click the  gear icon in the top-right corner to open Settings. Under "Theme Selection," you'll find 13 different themes including Chicago sports teams (Bears, Bulls, Cubs, White Sox, Blackhawks, Fire) and the Green Bay Packers.</p>
                            </div>
                        </details>
                        
                        <details style="background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <summary style="padding: 20px; cursor: pointer; font-weight: 600; color: #1f2937; background: #f8fafc;">How does inventory tracking work?</summary>
                            <div style="padding: 20px; background: white; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; color: #475569;">Inventory is automatically updated when you:<br><br>
                                 <strong>Receive a PO:</strong> Inventory increases by the received quantity<br>
                                 <strong>Ship a Sales Order:</strong> Inventory decreases by the sold quantity<br>
                                 <strong>Manual Adjustment:</strong> Use the Inventory tab to manually adjust quantities with reason tracking</p>
                            </div>
                        </details>
                        
                        <details style="background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <summary style="padding: 20px; cursor: pointer; font-weight: 600; color: #1f2937; background: #f8fafc;">Can I receive a partial shipment on a PO?</summary>
                            <div style="padding: 20px; background: white; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; color: #475569;">Yes! When viewing a PO, click "Receive PO" and you can enter the actual quantities received for each line item. If you receive less than ordered, the PO will show status "Partially Received" and track the remaining quantity.</p>
                            </div>
                        </details>
                        
                        <details style="background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <summary style="padding: 20px; cursor: pointer; font-weight: 600; color: #1f2937; background: #f8fafc;">How do I print an invoice for a customer?</summary>
                            <div style="padding: 20px; background: white; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; color: #475569;">Go to <strong>Sales</strong>  Find the order  Click <strong>View</strong>  Click <strong> Print Invoice</strong>. The invoice will open in a print-friendly format with your business name and all order details.</p>
                            </div>
                        </details>
                        
                        <details style="background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <summary style="padding: 20px; cursor: pointer; font-weight: 600; color: #1f2937; background: #f8fafc;">What is the Action Dashboard?</summary>
                            <div style="padding: 20px; background: white; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; color: #475569;">The Action Dashboard shows items that need your immediate attention:<br><br>
                                 <strong>Past Due Payments:</strong> Customer invoices that haven't been paid<br>
                                 <strong>Late POs:</strong> Purchase orders past their expected date<br>
                                 <strong>Low Stock Items:</strong> Items below reorder point<br>
                                 <strong>Dead Stock:</strong> Items with no recent sales</p>
                            </div>
                        </details>
                        
                        <details style="background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <summary style="padding: 20px; cursor: pointer; font-weight: 600; color: #1f2937; background: #f8fafc;">How do I use the Price Simulator?</summary>
                            <div style="padding: 20px; background: white; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; color: #475569;">The Price Simulator lets you test "what if" scenarios:<br><br>
                                1. Go to <strong>Price Sim</strong> tab<br>
                                2. Select an item and enter a new sell price<br>
                                3. Click <strong>Calculate Impact</strong> to see how it affects your revenue<br>
                                4. If you like the result, click <strong>Apply Price</strong> to make it permanent</p>
                            </div>
                        </details>
                        
                        <details style="background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <summary style="padding: 20px; cursor: pointer; font-weight: 600; color: #1f2937; background: #f8fafc;">Where is my data stored?</summary>
                            <div style="padding: 20px; background: white; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; color: #475569;">All data is stored securely in Google Sheets connected to Google Apps Script. This means:<br><br>
                                 Your data is in your Google account<br>
                                 It's backed up automatically by Google<br>
                                 You can access it from any device<br>
                                 You can export to Excel anytime</p>
                            </div>
                        </details>
                        
                        <details style="background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <summary style="padding: 20px; cursor: pointer; font-weight: 600; color: #1f2937; background: #f8fafc;">Can I use this on my phone?</summary>
                            <div style="padding: 20px; background: white; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; color: #475569;">Yes! The ERP is fully responsive and works on any device. See the <strong>Mobile Access Guide</strong> section below for detailed instructions on adding it to your home screen for quick access.</p>
                            </div>
                        </details>
                    </div>
                </div>
                
                <!-- ==================== HOW-TO GUIDES ==================== -->
                <div id="guide-how-to" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #10b981;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">How-To Guides</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Click any task for step-by-step instructions</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        
                        <!-- Supplier Tasks -->
                        <div style="background: #eff6ff; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 15px 0; color: #1e40af;"> Supplier Tasks</h4>
                            <ul style="margin: 0; padding-left: 20px; line-height: 2.2; list-style: none;">
                                <li><a href="#" onclick="showTutorial('add-supplier'); return false;" style="color: #2563eb; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #3b82f6;"></span> How to add a new supplier</a></li>
                                <li><a href="#" onclick="showTutorial('edit-supplier'); return false;" style="color: #2563eb; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #3b82f6;"></span> How to edit supplier information</a></li>
                                <li><a href="#" onclick="showTutorial('supplier-history'); return false;" style="color: #2563eb; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #3b82f6;"></span> How to view supplier purchase history</a></li>
                                <li><a href="#" onclick="showTutorial('archive-supplier'); return false;" style="color: #2563eb; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #3b82f6;"></span> How to archive/restore a supplier</a></li>
                            </ul>
                        </div>
                        
                        <!-- Item Tasks -->
                        <div style="background: #f0fdf4; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 15px 0; color: #166534;"> Item/Product Tasks</h4>
                            <ul style="margin: 0; padding-left: 20px; line-height: 2.2; list-style: none;">
                                <li><a href="#" onclick="showTutorial('add-item'); return false;" style="color: #6b9a8d; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #6b9a8d;"></span> How to add a new item</a></li>
                                <li><a href="#" onclick="showTutorial('update-pricing'); return false;" style="color: #6b9a8d; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #6b9a8d;"></span> How to update item pricing</a></li>
                                <li><a href="#" onclick="showTutorial('set-reorder'); return false;" style="color: #6b9a8d; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #6b9a8d;"></span> How to set reorder points</a></li>
                                <li><a href="#" onclick="showTutorial('archive-item'); return false;" style="color: #6b9a8d; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #6b9a8d;"></span> How to archive discontinued items</a></li>
                            </ul>
                        </div>
                        
                        <!-- Customer Tasks -->
                        <div style="background: #fef3c7; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 15px 0; color: #b45309;"> Customer Tasks</h4>
                            <ul style="margin: 0; padding-left: 20px; line-height: 2.2; list-style: none;">
                                <li><a href="#" onclick="showTutorial('add-customer'); return false;" style="color: #d97706; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #b8a86b;"></span> How to add a new customer</a></li>
                                <li><a href="#" onclick="showTutorial('payment-terms'); return false;" style="color: #d97706; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #b8a86b;"></span> How to set payment terms</a></li>
                                <li><a href="#" onclick="showTutorial('customer-history'); return false;" style="color: #d97706; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #b8a86b;"></span> How to view customer order history</a></li>
                                <li><a href="#" onclick="showTutorial('track-balances'); return false;" style="color: #d97706; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #b8a86b;"></span> How to track outstanding balances</a></li>
                            </ul>
                        </div>
                        
                        <!-- Purchase Order Tasks -->
                        <div style="background: #ede9fe; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 15px 0; color: #6d28d9;"> Purchase Order Tasks</h4>
                            <ul style="margin: 0; padding-left: 20px; line-height: 2.2; list-style: none;">
                                <li><a href="#" onclick="showTutorial('create-po'); return false;" style="color: #7c3aed; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #8b5cf6;"></span> How to create a purchase order</a></li>
                                <li><a href="#" onclick="showTutorial('receive-shipment'); return false;" style="color: #7c3aed; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #8b5cf6;"></span> How to receive a shipment</a></li>
                                <li><a href="#" onclick="showTutorial('partial-receive'); return false;" style="color: #7c3aed; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #8b5cf6;"></span> How to receive partial shipments</a></li>
                                <li><a href="#" onclick="showTutorial('pay-supplier'); return false;" style="color: #7c3aed; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #8b5cf6;"></span> How to record payment to supplier</a></li>
                                <li><a href="#" onclick="showTutorial('print-po'); return false;" style="color: #7c3aed; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #8b5cf6;"></span> How to print/email a PO</a></li>
                            </ul>
                        </div>
                        
                        <!-- Sales Tasks -->
                        <div style="background: #fce7f3; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 15px 0; color: #be185d;"> Sales & Invoice Tasks</h4>
                            <ul style="margin: 0; padding-left: 20px; line-height: 2.2; list-style: none;">
                                <li><a href="#" onclick="showTutorial('create-invoice'); return false;" style="color: #db2777; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #ec4899;"></span> How to create a sales order/invoice</a></li>
                                <li><a href="#" onclick="showTutorial('item-picker'); return false;" style="color: #db2777; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #ec4899;"></span> How to use the quick item picker</a></li>
                                <li><a href="#" onclick="showTutorial('print-invoice'); return false;" style="color: #db2777; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #ec4899;"></span> How to print an invoice</a></li>
                                <li><a href="#" onclick="showTutorial('record-payment'); return false;" style="color: #db2777; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #ec4899;"></span> How to record customer payment</a></li>
                                <li><a href="#" onclick="showTutorial('pick-list'); return false;" style="color: #db2777; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #ec4899;"></span> How to generate a pick list</a></li>
                                <li><a href="#" onclick="showTutorial('dormant-customers'); return false;" style="color: #db2777; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #ec4899;"></span> How to win back dormant customers</a></li>
                            </ul>
                        </div>
                        
                        <!-- Inventory Tasks -->
                        <div style="background: #f1f5f9; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 15px 0; color: #475569;"> Inventory Tasks</h4>
                            <ul style="margin: 0; padding-left: 20px; line-height: 2.2; list-style: none;">
                                <li><a href="#" onclick="showTutorial('view-inventory'); return false;" style="color: #475569; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #64748b;"></span> How to view current inventory levels</a></li>
                                <li><a href="#" onclick="showTutorial('adjust-inventory'); return false;" style="color: #475569; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #64748b;"></span> How to make manual adjustments</a></li>
                                <li><a href="#" onclick="showTutorial('low-stock'); return false;" style="color: #475569; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #64748b;"></span> How to track low stock items</a></li>
                                <li><a href="#" onclick="showTutorial('inventory-flow'); return false;" style="color: #475569; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #64748b;"></span> How to use Inventory Flow Dashboard</a></li>
                            </ul>
                        </div>
                        
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f0f9ff; border-radius: 12px; border-left: 4px solid #0ea5e9;">
                        <p style="margin: 0; color: #0369a1;"><strong> Tip:</strong> Click any task above to see detailed step-by-step instructions. Each guide includes numbered steps and helpful tips!</p>
                    </div>
                </div>
                
                <!-- ==================== MOBILE ACCESS GUIDE ==================== -->
                <div id="guide-mobile" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #ec4899;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Mobile Access Guide</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Access the ERP from any phone or tablet</p>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%); border-radius: 12px; padding: 25px; margin-bottom: 30px; border: 2px solid #f9a8d4;">
                        <p style="margin: 0; color: #9d174d;"> The Nowak Distributing ERP works perfectly on mobile devices! For the best experience, add it to your home screen to launch it like a native app.</p>
                    </div>
                    
                    <!-- Android Instructions -->
                    <div style="background: #f0fdf4; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-left: 5px solid #6b9a8d;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                            <span style="font-size: 32px;"></span>
                            <h3 style="margin: 0; color: #166534;">Android Setup (Samsung, Google Pixel, etc.)</h3>
                        </div>
                        
                        <div style="display: grid; gap: 15px;">
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #6b9a8d; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</div>
                                <div>
                                    <strong>Open Chrome Browser</strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">Navigate to the ERP website in Google Chrome</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #6b9a8d; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</div>
                                <div>
                                    <strong>Tap the Menu ()</strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">Tap the three dots in the top-right corner of Chrome</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #6b9a8d; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">3</div>
                                <div>
                                    <strong>Tap "Add to Home screen"</strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">Scroll down in the menu and select this option</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #6b9a8d; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">4</div>
                                <div>
                                    <strong>Name it "Nowak ERP"</strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">Enter a short name and tap "Add"</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #6b9a8d; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">5</div>
                                <div>
                                    <strong>Done! </strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">Find the icon on your home screen and tap to launch</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- iPhone Instructions -->
                    <div style="background: #f1f5f9; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-left: 5px solid #6b7280;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                            <span style="font-size: 32px;"></span>
                            <h3 style="margin: 0; color: #374151;">iPhone & iPad Setup</h3>
                        </div>
                        
                        <div style="display: grid; gap: 15px;">
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #6b7280; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</div>
                                <div>
                                    <strong>Open Safari Browser</strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">Navigate to the ERP website in Safari (required for iOS)</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #6b7280; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</div>
                                <div>
                                    <strong>Tap the Share Button ()</strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">Tap the share icon at the bottom of Safari</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #6b7280; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">3</div>
                                <div>
                                    <strong>Tap "Add to Home Screen"</strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">Scroll down in the share menu to find this option</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #6b7280; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">4</div>
                                <div>
                                    <strong>Name it "Nowak ERP" and tap Add</strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">The app icon will appear on your home screen</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Samsung Specific -->
                    <div style="background: #eff6ff; border-radius: 12px; padding: 25px; border-left: 5px solid #3b82f6;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                            <span style="font-size: 28px;"></span>
                            <h4 style="margin: 0; color: #1e40af;">Samsung Internet Browser (Alternative)</h4>
                        </div>
                        <p style="margin: 0; color: #475569;">If using Samsung Internet: Tap the menu ()  "Add page to"  "Home screen"</p>
                    </div>
                    
                    <!-- Mobile Tips -->
                    <div style="margin-top: 30px; padding: 20px; background: #fef3c7; border-radius: 12px; border-left: 4px solid #b8a86b;">
                        <h4 style="margin: 0 0 10px 0; color: #b45309;"> Mobile Tips</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #92400e;">
                            <li>Turn your phone sideways (landscape) for better table viewing</li>
                            <li>Use pinch-to-zoom on reports and invoices</li>
                            <li>The navigation grid works great with one-handed scrolling</li>
                            <li>All printing works through your phone's print system</li>
                        </ul>
                    </div>
                </div>
                
                <!-- ==================== KEYBOARD SHORTCUTS ==================== -->
                <div id="guide-shortcuts" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #6366f1;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Keyboard Shortcuts & Tips</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Work faster with these shortcuts</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        
                        <!-- General Shortcuts -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 20px 0; color: #475569;"> General Navigation</h4>
                            <table style="width: 100%; font-size: 14px;">
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Tab</kbd></td><td>Move to next field</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Shift + Tab</kbd></td><td>Move to previous field</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Enter</kbd></td><td>Submit form / Confirm</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Esc</kbd></td><td>Close modal / Cancel</td></tr>
                            </table>
                        </div>
                        
                        <!-- Browser Shortcuts -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 20px 0; color: #475569;"> Browser Shortcuts</h4>
                            <table style="width: 100%; font-size: 14px;">
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Ctrl + P</kbd></td><td>Print current page</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Ctrl + F</kbd></td><td>Find on page</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Ctrl + R</kbd></td><td>Refresh page</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">F11</kbd></td><td>Full screen mode</td></tr>
                            </table>
                        </div>
                        
                        <!-- Form Tips -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 20px 0; color: #475569;"> Form Tips</h4>
                            <table style="width: 100%; font-size: 14px;">
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;"></kbd></td><td>Open dropdown list</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Type</kbd></td><td>Search in dropdown</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Ctrl + A</kbd></td><td>Select all text in field</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Ctrl + Z</kbd></td><td>Undo typing</td></tr>
                            </table>
                        </div>
                        
                    </div>
                    
                    <div style="padding: 20px; background: #ede9fe; border-radius: 12px; border-left: 4px solid #8b5cf6;">
                        <h4 style="margin: 0 0 10px 0; color: #6d28d9;"> Pro Tips</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #5b21b6;">
                            <li>In dropdowns, start typing to jump to matching options</li>
                            <li>Click column headers in tables to sort data</li>
                            <li>Use the search/filter boxes to quickly find records</li>
                            <li>Double-click a row in many tables to view details</li>
                        </ul>
                    </div>
                </div>
                
                <!-- ==================== TROUBLESHOOTING ==================== -->
                <div id="guide-troubleshooting" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #b88a8a;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Troubleshooting Guide</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Fix common issues quickly</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        
                        <!-- Issue 1 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 25px; border-left: 5px solid #b88a8a;">
                            <h4 style="margin: 0 0 15px 0; color: #b91c1c;"> Data Not Loading / "Loading..." Stuck</h4>
                            <p style="margin: 0 0 15px 0; color: #7f1d1d;"><strong>Cause:</strong> Connection to Google Sheets backend may have timed out.</p>
                            <p style="margin: 0; color: #7f1d1d;"><strong>Solution:</strong></p>
                            <ol style="margin: 10px 0 0 0; padding-left: 20px; color: #991b1b;">
                                <li>Refresh the page (Ctrl+R or +R)</li>
                                <li>Wait 10-15 seconds for data to load</li>
                                <li>If still stuck, check your internet connection</li>
                                <li>Clear browser cache: Settings  Privacy  Clear browsing data</li>
                            </ol>
                        </div>
                        
                        <!-- Issue 2 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 25px; border-left: 5px solid #b88a8a;">
                            <h4 style="margin: 0 0 15px 0; color: #b91c1c;"> Changes Not Saving</h4>
                            <p style="margin: 0 0 15px 0; color: #7f1d1d;"><strong>Cause:</strong> Form validation failed or network issue.</p>
                            <p style="margin: 0; color: #7f1d1d;"><strong>Solution:</strong></p>
                            <ol style="margin: 10px 0 0 0; padding-left: 20px; color: #991b1b;">
                                <li>Check for red error messages on the form</li>
                                <li>Make sure all required fields (marked with *) are filled</li>
                                <li>Look for the green "Success" message after saving</li>
                                <li>If no message appears, refresh and try again</li>
                            </ol>
                        </div>
                        
                        <!-- Issue 3 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 25px; border-left: 5px solid #b88a8a;">
                            <h4 style="margin: 0 0 15px 0; color: #b91c1c;"> Print Not Working</h4>
                            <p style="margin: 0 0 15px 0; color: #7f1d1d;"><strong>Cause:</strong> Browser popup blocker or print dialog issue.</p>
                            <p style="margin: 0; color: #7f1d1d;"><strong>Solution:</strong></p>
                            <ol style="margin: 10px 0 0 0; padding-left: 20px; color: #991b1b;">
                                <li>Allow popups for this site if prompted</li>
                                <li>Try Ctrl+P (or +P on Mac) after clicking Print</li>
                                <li>Make sure you have a printer selected</li>
                                <li>For PDF: Select "Save as PDF" in the print dialog</li>
                            </ol>
                        </div>
                        
                        <!-- Issue 4 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 25px; border-left: 5px solid #b88a8a;">
                            <h4 style="margin: 0 0 15px 0; color: #b91c1c;"> Inventory Numbers Wrong</h4>
                            <p style="margin: 0 0 15px 0; color: #7f1d1d;"><strong>Cause:</strong> Orders may not have been marked as received/shipped.</p>
                            <p style="margin: 0; color: #7f1d1d;"><strong>Solution:</strong></p>
                            <ol style="margin: 10px 0 0 0; padding-left: 20px; color: #991b1b;">
                                <li>Check that POs are marked "Received" (not just "Submitted")</li>
                                <li>Verify Sales Orders are "Shipped" status</li>
                                <li>Use Inventory  Manual Adjustment to correct quantities</li>
                                <li>Check the Adjustment History report to see all changes</li>
                            </ol>
                        </div>
                        
                        <!-- Issue 5 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 25px; border-left: 5px solid #b88a8a;">
                            <h4 style="margin: 0 0 15px 0; color: #b91c1c;"> Page Looks Wrong / Broken Layout</h4>
                            <p style="margin: 0 0 15px 0; color: #7f1d1d;"><strong>Cause:</strong> Cached old version of the page.</p>
                            <p style="margin: 0; color: #7f1d1d;"><strong>Solution:</strong></p>
                            <ol style="margin: 10px 0 0 0; padding-left: 20px; color: #991b1b;">
                                <li>Hard refresh: Ctrl+Shift+R (or +Shift+R on Mac)</li>
                                <li>Clear cache: Ctrl+Shift+Delete  Clear cached images/files</li>
                                <li>Try a different browser (Chrome, Firefox, Edge)</li>
                            </ol>
                        </div>
                        
                    </div>
                    
                    <div style="margin-top: 30px; padding: 25px; background: #f0f9ff; border-radius: 12px; text-align: center;">
                        <h4 style="margin: 0 0 10px 0; color: #0369a1;">Still Having Issues?</h4>
                        <p style="margin: 0; color: #0c4a6e;">Contact your system administrator or check the browser console (F12) for error messages.</p>
                    </div>
                </div>
                
                <!-- ==================== BEST PRACTICES GUIDE ==================== -->
                <div id="guide-best-practices" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #14b8a6;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Best Practices Guide</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Tips and tricks from power users</p>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%); border-radius: 12px; padding: 25px; margin-bottom: 30px; border: 2px solid #5eead4;">
                        <p style="margin: 0; color: #0f766e;"> These best practices will help you get the most out of the Nowak Distributing ERP and keep your business running smoothly.</p>
                    </div>
                    
                    <div style="display: grid; gap: 25px;">
                        
                        <!-- Daily Habits -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #14b8a6;">
                            <h4 style="margin: 0 0 15px 0; color: #0f766e;"> Daily Habits</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                                <li><strong>Start with the Action Dashboard</strong> - Check it first thing every morning to see what needs immediate attention</li>
                                <li><strong>Record sales same-day</strong> - Enter invoices the day they happen to keep inventory accurate</li>
                                <li><strong>Mark payments promptly</strong> - Record payments as soon as received to track cash flow</li>
                                <li><strong>Check low stock alerts</strong> - Review items below reorder point before the weekly order</li>
                            </ul>
                        </div>
                        
                        <!-- Weekly Tasks -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #3b82f6;">
                            <h4 style="margin: 0 0 15px 0; color: #1e40af;"> Weekly Tasks</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                                <li><strong>Review Accounts Receivable</strong> - Follow up on past-due invoices every week</li>
                                <li><strong>Check supplier PO status</strong> - Make sure expected deliveries are on track</li>
                                <li><strong>Run the Business Overview report</strong> - Track your weekly performance trends</li>
                                <li><strong>Backup your data</strong> - Export key reports to Excel for safekeeping</li>
                            </ul>
                        </div>
                        
                        <!-- Data Entry Tips -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #8b5cf6;">
                            <h4 style="margin: 0 0 15px 0; color: #6d28d9;"> Data Entry Tips</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                                <li><strong>Use consistent naming</strong> - "Better Made" not "BetterMade" or "Better made"</li>
                                <li><strong>Include SKUs</strong> - Makes searching and matching items much easier</li>
                                <li><strong>Set reorder points</strong> - Prevents stockouts by alerting you early</li>
                                <li><strong>Use notes fields</strong> - Add details that help you remember special arrangements</li>
                                <li><strong>Double-check quantities</strong> - Verify numbers before saving orders</li>
                            </ul>
                        </div>
                        
                        <!-- Inventory Management -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #b8a86b;">
                            <h4 style="margin: 0 0 15px 0; color: #b45309;"> Inventory Best Practices</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                                <li><strong>Receive POs promptly</strong> - Mark shipments received same day they arrive</li>
                                <li><strong>Do physical counts monthly</strong> - Verify system matches actual stock</li>
                                <li><strong>Use adjustment reasons</strong> - Document why quantities changed (damage, shrinkage, etc.)</li>
                                <li><strong>Watch for dead stock</strong> - Items with no sales in 90+ days may need promotion or removal</li>
                            </ul>
                        </div>
                        
                        <!-- Reporting Tips -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #ec4899;">
                            <h4 style="margin: 0 0 15px 0; color: #be185d;"> Reporting Tips</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                                <li><strong>Use date filters</strong> - Compare periods (this month vs last month)</li>
                                <li><strong>Export to Excel</strong> - For further analysis or sharing with accountant</li>
                                <li><strong>Check margins regularly</strong> - Use Gross Margin report to spot pricing issues</li>
                                <li><strong>Track customer trends</strong> - Customer Dashboard shows who's buying more or less</li>
                            </ul>
                        </div>
                        
                    </div>
                </div>
                
                <!-- ==================== DATA IMPORT/EXPORT GUIDE ==================== -->
                <div id="guide-import-export" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #0891b2;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Data Import/Export Guide</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Move data in and out of the system</p>
                        </div>
                    </div>
                    
                    <!-- Export Section -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="color: #0e7490; border-bottom: 2px solid #cffafe; padding-bottom: 10px;"> Exporting Data</h3>
                        
                        <div style="background: #ecfeff; border-radius: 12px; padding: 25px; margin: 20px 0; border-left: 5px solid #06b6d4;">
                            <h4 style="margin: 0 0 15px 0; color: #0e7490;">Method 1: Export Reports to Excel</h4>
                            <ol style="margin: 0; padding-left: 20px; color: #164e63; line-height: 1.8;">
                                <li>Go to <strong>Reports</strong> and run any report</li>
                                <li>Click the <strong> Email</strong> button on the report</li>
                                <li>Copy the report data from the email preview</li>
                                <li>Paste into Excel or Google Sheets</li>
                            </ol>
                        </div>
                        
                        <div style="background: #ecfeff; border-radius: 12px; padding: 25px; margin: 20px 0; border-left: 5px solid #06b6d4;">
                            <h4 style="margin: 0 0 15px 0; color: #0e7490;">Method 2: Direct Google Sheets Access</h4>
                            <ol style="margin: 0; padding-left: 20px; color: #164e63; line-height: 1.8;">
                                <li>Open your Google Sheets database directly</li>
                                <li>Select the tab you want (Suppliers, Items, Customers, etc.)</li>
                                <li>Go to <strong>File  Download  Microsoft Excel (.xlsx)</strong></li>
                                <li>Or <strong>File  Download  Comma-separated values (.csv)</strong></li>
                            </ol>
                        </div>
                        
                        <div style="background: #fef3c7; border-radius: 8px; padding: 15px; margin-top: 15px;">
                            <strong style="color: #b45309;"> Pro Tip:</strong>
                            <span style="color: #92400e;">For tax season, export the Profit & Loss and Annual Sales Summary reports for your accountant.</span>
                        </div>
                    </div>
                    
                    <!-- Import Section -->
                    <div>
                        <h3 style="color: #0e7490; border-bottom: 2px solid #cffafe; padding-bottom: 10px;"> Importing Data</h3>
                        
                        <div style="background: #fef2f2; border-radius: 12px; padding: 25px; margin: 20px 0; border-left: 5px solid #b88a8a;">
                            <h4 style="margin: 0 0 10px 0; color: #b91c1c;"> Important Warning</h4>
                            <p style="margin: 0; color: #7f1d1d;">Importing data directly into Google Sheets requires caution. Always make a backup first, and ensure your data matches the exact column format.</p>
                        </div>
                        
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; margin: 20px 0;">
                            <h4 style="margin: 0 0 15px 0; color: #334155;">Steps to Import Items from Excel:</h4>
                            <ol style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                                <li>First, <strong>backup your database</strong> (File  Make a copy)</li>
                                <li>Format your Excel file to match the Items sheet columns exactly</li>
                                <li>Required columns: Item_ID, SKU, Item_Description, Supplier_ID, Package_Cost, Units_Per_Package, Unit_Sell_Price, Qty_On_Hand, Reorder_Point, Status</li>
                                <li>Copy the data rows (without headers) from Excel</li>
                                <li>Paste into the Items sheet below existing data</li>
                                <li>Make sure Item_IDs are unique (I001, I002, etc.)</li>
                            </ol>
                        </div>
                        
                        <div style="padding: 20px; background: #f0fdf4; border-radius: 12px; text-align: center;">
                            <p style="margin: 0; color: #166534;"><strong>Need help importing large datasets?</strong> Contact your system administrator for assistance with bulk data migration.</p>
                        </div>
                    </div>
                </div>
                
                <!-- ==================== BACKUP & RECOVERY GUIDE ==================== -->
                <div id="guide-backup" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #7c3aed;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Backup & Data Recovery Guide</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Protect your business data</p>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-radius: 12px; padding: 25px; margin-bottom: 30px; border: 2px solid #c4b5fd;">
                        <p style="margin: 0; color: #6d28d9;"> Your data is stored in Google Sheets, which provides automatic cloud backup. However, it's still important to create your own backups for extra protection.</p>
                    </div>
                    
                    <!-- Automatic Backups -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-left: 5px solid #6b9a8d;">
                        <h4 style="margin: 0 0 15px 0; color: #166534;"> Automatic Protection (Built-in)</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                            <li><strong>Google's cloud backup</strong> - Your Sheets are automatically saved and backed up</li>
                            <li><strong>Version history</strong> - Google keeps a history of all changes (File  Version history)</li>
                            <li><strong>Recover deleted files</strong> - Check Google Drive Trash for accidentally deleted files</li>
                            <li><strong>Sync across devices</strong> - Access from any device with your Google account</li>
                        </ul>
                    </div>
                    
                    <!-- Manual Backups -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-left: 5px solid #3b82f6;">
                        <h4 style="margin: 0 0 15px 0; color: #1e40af;"> Manual Backup (Recommended Weekly)</h4>
                        <ol style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                            <li>Open your Google Sheets database</li>
                            <li>Go to <strong>File  Make a copy</strong></li>
                            <li>Name it with the date: "Nowak ERP Backup - 2024-12-12"</li>
                            <li>Save to a "Backups" folder in Google Drive</li>
                            <li>Optionally download as Excel: <strong>File  Download  Microsoft Excel</strong></li>
                        </ol>
                    </div>
                    
                    <!-- Recovery Steps -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-left: 5px solid #b8a86b;">
                        <h4 style="margin: 0 0 15px 0; color: #b45309;"> How to Recover Data</h4>
                        
                        <div style="margin-bottom: 20px;">
                            <strong style="color: #1f2937;">Option 1: Use Version History</strong>
                            <ol style="margin: 10px 0 0 0; padding-left: 20px; color: #475569;">
                                <li>Open Google Sheets  <strong>File  Version history  See version history</strong></li>
                                <li>Click on a previous version to preview it</li>
                                <li>Click <strong>Restore this version</strong> to roll back</li>
                            </ol>
                        </div>
                        
                        <div>
                            <strong style="color: #1f2937;">Option 2: Restore from Backup Copy</strong>
                            <ol style="margin: 10px 0 0 0; padding-left: 20px; color: #475569;">
                                <li>Open your backup copy from Google Drive</li>
                                <li>Copy the data you need from the backup</li>
                                <li>Paste into your main database file</li>
                            </ol>
                        </div>
                    </div>
                    
                    <!-- Backup Schedule -->
                    <div style="padding: 25px; background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); border-radius: 12px; color: white;">
                        <h4 style="margin: 0 0 15px 0;"> Recommended Backup Schedule</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;"></div>
                                <strong>Weekly</strong><br>
                                <span style="font-size: 13px; opacity: 0.9;">Make a copy</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;"></div>
                                <strong>Monthly</strong><br>
                                <span style="font-size: 13px; opacity: 0.9;">Download Excel</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;"></div>
                                <strong>Quarterly</strong><br>
                                <span style="font-size: 13px; opacity: 0.9;">Archive to USB</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ==================== QUICK REFERENCE CARD / CHEAT SHEET ==================== -->
                <div id="guide-cheatsheet" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #ea580c;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Quick Reference Card</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Printable cheat sheet for common tasks</p>
                        </div>
                        <button onclick="window.print()" style="margin-left: auto; background: #ea580c; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                             Print This Page
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        
                        <!-- Column 1: Navigation -->
                        <div style="background: #fff7ed; border-radius: 12px; padding: 20px; border: 2px solid #fed7aa;">
                            <h4 style="margin: 0 0 15px 0; color: #c2410c; border-bottom: 2px solid #fdba74; padding-bottom: 8px;"> Navigation</h4>
                            <table style="width: 100%; font-size: 13px;">
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Reports</strong></td><td>Dashboards & analytics</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Suppliers</strong></td><td>Manage vendors</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Items</strong></td><td>Product catalog</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Customers</strong></td><td>Customer database</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Create PO</strong></td><td>New purchase order</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Purchases</strong></td><td>View/manage POs</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Sales</strong></td><td>Create invoices</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Inventory</strong></td><td>Stock levels</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Price Sim</strong></td><td>Test price changes</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong> (gear)</strong></td><td>Settings & themes</td></tr>
                            </table>
                        </div>
                        
                        <!-- Column 2: Common Tasks -->
                        <div style="background: #f0fdf4; border-radius: 12px; padding: 20px; border: 2px solid #bbf7d0;">
                            <h4 style="margin: 0 0 15px 0; color: #166534; border-bottom: 2px solid #86efac; padding-bottom: 8px;"> Quick Tasks</h4>
                            <div style="font-size: 13px; color: #14532d;">
                                <p style="margin: 0 0 10px 0;"><strong>Create Invoice:</strong><br>Sales  + Create Invoice  Select customer  Add items  Save</p>
                                <p style="margin: 0 0 10px 0;"><strong>Create PO:</strong><br>Create PO  Select supplier  Add items  Submit</p>
                                <p style="margin: 0 0 10px 0;"><strong>Receive Shipment:</strong><br>Purchases  Find PO  View  Receive PO</p>
                                <p style="margin: 0 0 10px 0;"><strong>Record Payment:</strong><br>Sales/Purchases  View order  Record Payment</p>
                                <p style="margin: 0;"><strong>Adjust Inventory:</strong><br>Inventory  Find item  Adjust  Enter qty & reason</p>
                            </div>
                        </div>
                        
                        <!-- Column 3: Key Reports -->
                        <div style="background: #eff6ff; border-radius: 12px; padding: 20px; border: 2px solid #bfdbfe;">
                            <h4 style="margin: 0 0 15px 0; color: #1e40af; border-bottom: 2px solid #93c5fd; padding-bottom: 8px;"> Key Reports</h4>
                            <div style="font-size: 13px; color: #1e3a8a;">
                                <p style="margin: 0 0 8px 0;"> <strong>Action Dashboard</strong> - What needs attention NOW</p>
                                <p style="margin: 0 0 8px 0;"> <strong>Business Overview</strong> - Sales, costs, profit summary</p>
                                <p style="margin: 0 0 8px 0;"> <strong>Inventory Flow</strong> - Stock movement</p>
                                <p style="margin: 0 0 8px 0;"> <strong>Accounts Receivable</strong> - Who owes you</p>
                                <p style="margin: 0 0 8px 0;"> <strong>Accounts Payable</strong> - What you owe</p>
                                <p style="margin: 0 0 8px 0;"> <strong>Pick List</strong> - Items to gather for delivery</p>
                                <p style="margin: 0;"> <strong>Profit & Loss</strong> - Financial statement</p>
                            </div>
                        </div>
                        
                        <!-- Column 4: Status Colors -->
                        <div style="background: #fdf4ff; border-radius: 12px; padding: 20px; border: 2px solid #f5d0fe;">
                            <h4 style="margin: 0 0 15px 0; color: #86198f; border-bottom: 2px solid #e879f9; padding-bottom: 8px;"> Status Colors</h4>
                            <div style="font-size: 13px;">
                                <p style="margin: 0 0 8px 0;"><span style="background: #6b9a8d; color: white; padding: 2px 8px; border-radius: 4px;">Green</span> Paid / Received / Good</p>
                                <p style="margin: 0 0 8px 0;"><span style="background: #b8a86b; color: white; padding: 2px 8px; border-radius: 4px;">Yellow</span> Pending / Partial</p>
                                <p style="margin: 0 0 8px 0;"><span style="background: #b88a8a; color: white; padding: 2px 8px; border-radius: 4px;">Red</span> Overdue / Low Stock</p>
                                <p style="margin: 0 0 8px 0;"><span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px;">Blue</span> Info / In Progress</p>
                                <p style="margin: 0;"><span style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 4px;">Gray</span> Draft / Archived</p>
                            </div>
                        </div>
                        
                        <!-- Column 5: Keyboard Shortcuts -->
                        <div style="background: #f1f5f9; border-radius: 12px; padding: 20px; border: 2px solid #cbd5e1;">
                            <h4 style="margin: 0 0 15px 0; color: #334155; border-bottom: 2px solid #94a3b8; padding-bottom: 8px;"> Shortcuts</h4>
                            <table style="width: 100%; font-size: 13px;">
                                <tr><td style="padding: 4px 0;"><kbd style="background: #e2e8f0; padding: 2px 6px; border-radius: 3px; font-size: 11px;">Tab</kbd></td><td>Next field</td></tr>
                                <tr><td style="padding: 4px 0;"><kbd style="background: #e2e8f0; padding: 2px 6px; border-radius: 3px; font-size: 11px;">Enter</kbd></td><td>Submit/Confirm</td></tr>
                                <tr><td style="padding: 4px 0;"><kbd style="background: #e2e8f0; padding: 2px 6px; border-radius: 3px; font-size: 11px;">Esc</kbd></td><td>Close/Cancel</td></tr>
                                <tr><td style="padding: 4px 0;"><kbd style="background: #e2e8f0; padding: 2px 6px; border-radius: 3px; font-size: 11px;">Ctrl+P</kbd></td><td>Print</td></tr>
                                <tr><td style="padding: 4px 0;"><kbd style="background: #e2e8f0; padding: 2px 6px; border-radius: 3px; font-size: 11px;">Ctrl+F</kbd></td><td>Find on page</td></tr>
                                <tr><td style="padding: 4px 0;"><kbd style="background: #e2e8f0; padding: 2px 6px; border-radius: 3px; font-size: 11px;">F11</kbd></td><td>Full screen</td></tr>
                            </table>
                        </div>
                        
                        <!-- Column 6: Glossary -->
                        <div style="background: #fefce8; border-radius: 12px; padding: 20px; border: 2px solid #fef08a;">
                            <h4 style="margin: 0 0 15px 0; color: #a16207; border-bottom: 2px solid #fde047; padding-bottom: 8px;"> Terms</h4>
                            <div style="font-size: 13px; color: #713f12;">
                                <p style="margin: 0 0 6px 0;"><strong>PO</strong> = Purchase Order</p>
                                <p style="margin: 0 0 6px 0;"><strong>SO</strong> = Sales Order</p>
                                <p style="margin: 0 0 6px 0;"><strong>SKU</strong> = Product Code</p>
                                <p style="margin: 0 0 6px 0;"><strong>AR</strong> = Money owed TO you</p>
                                <p style="margin: 0 0 6px 0;"><strong>AP</strong> = Money you OWE</p>
                                <p style="margin: 0 0 6px 0;"><strong>COGS</strong> = Cost of Goods Sold</p>
                                <p style="margin: 0 0 6px 0;"><strong>Net 30</strong> = Due in 30 days</p>
                                <p style="margin: 0;"><strong>COD</strong> = Cash on Delivery</p>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <!-- ==================== ERROR MESSAGES EXPLAINED ==================== -->
                <div id="guide-errors" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #b88a8a;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Error Messages Explained</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">What they mean and how to fix them</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        
                        <!-- Error 1 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 20px; border-left: 5px solid #b88a8a;">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="background: #b88a8a; color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 13px; white-space: nowrap;">Error loading data</div>
                                <div>
                                    <p style="margin: 0 0 10px 0; color: #7f1d1d;"><strong>What it means:</strong> The app couldn't connect to the Google Sheets database.</p>
                                    <p style="margin: 0; color: #991b1b;"><strong>Fix:</strong> Check your internet connection, then refresh the page. If it persists, verify the API URL in Settings is correct.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error 2 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 20px; border-left: 5px solid #b88a8a;">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="background: #b88a8a; color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 13px; white-space: nowrap;">Please select a supplier</div>
                                <div>
                                    <p style="margin: 0 0 10px 0; color: #7f1d1d;"><strong>What it means:</strong> A required field was left empty.</p>
                                    <p style="margin: 0; color: #991b1b;"><strong>Fix:</strong> Look for required fields (usually marked with *) and make sure they're filled in.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error 3 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 20px; border-left: 5px solid #b88a8a;">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="background: #b88a8a; color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 13px; white-space: nowrap;">Invalid quantity</div>
                                <div>
                                    <p style="margin: 0 0 10px 0; color: #7f1d1d;"><strong>What it means:</strong> You entered a non-numeric value or negative number in a quantity field.</p>
                                    <p style="margin: 0; color: #991b1b;"><strong>Fix:</strong> Enter a positive whole number (no letters, symbols, or decimals for quantities).</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error 4 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 20px; border-left: 5px solid #b88a8a;">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="background: #b88a8a; color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 13px; white-space: nowrap;">Duplicate entry</div>
                                <div>
                                    <p style="margin: 0 0 10px 0; color: #7f1d1d;"><strong>What it means:</strong> You're trying to add something that already exists (same SKU, customer name, etc.).</p>
                                    <p style="margin: 0; color: #991b1b;"><strong>Fix:</strong> Use a unique identifier. Search existing records to avoid duplicates.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error 5 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 20px; border-left: 5px solid #b88a8a;">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="background: #b88a8a; color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 13px; white-space: nowrap;">Network error</div>
                                <div>
                                    <p style="margin: 0 0 10px 0; color: #7f1d1d;"><strong>What it means:</strong> The request couldn't reach the server.</p>
                                    <p style="margin: 0; color: #991b1b;"><strong>Fix:</strong> Check your Wi-Fi/internet connection. Try again in a few seconds. If on mobile, try switching between Wi-Fi and cellular data.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error 6 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 20px; border-left: 5px solid #b88a8a;">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="background: #b88a8a; color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 13px; white-space: nowrap;">Timeout</div>
                                <div>
                                    <p style="margin: 0 0 10px 0; color: #7f1d1d;"><strong>What it means:</strong> The request took too long (Google Apps Script has execution limits).</p>
                                    <p style="margin: 0; color: #991b1b;"><strong>Fix:</strong> Wait a moment and try again. For large reports, try using date filters to reduce data size.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error 7 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 20px; border-left: 5px solid #b88a8a;">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="background: #b88a8a; color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 13px; white-space: nowrap;">Insufficient inventory</div>
                                <div>
                                    <p style="margin: 0 0 10px 0; color: #7f1d1d;"><strong>What it means:</strong> You're trying to sell more than you have in stock.</p>
                                    <p style="margin: 0; color: #991b1b;"><strong>Fix:</strong> Check current inventory levels. Either reduce the quantity or create a PO to restock first.</p>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #fef3c7; border-radius: 12px;">
                        <h4 style="margin: 0 0 10px 0; color: #b45309;"> Debugging Tip</h4>
                        <p style="margin: 0; color: #92400e;">Press <kbd style="background: #fde68a; padding: 2px 6px; border-radius: 3px;">F12</kbd> to open browser Developer Tools, then click the <strong>Console</strong> tab to see detailed error messages that can help diagnose issues.</p>
                    </div>
                </div>
                
                <!-- ==================== BROWSER COMPATIBILITY GUIDE ==================== -->
                <div id="guide-browsers" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #2563eb;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Browser Compatibility Guide</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Supported browsers and devices</p>
                        </div>
                    </div>
                    
                    <!-- Supported Browsers -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="color: #1e40af; margin-bottom: 20px;"> Fully Supported Browsers</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            
                            <div style="background: #f0fdf4; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #86efac;">
                                <div style="font-size: 40px; margin-bottom: 10px;"></div>
                                <h4 style="margin: 0 0 5px 0; color: #166534;">Google Chrome</h4>
                                <p style="margin: 0; font-size: 13px; color: #15803d;">Version 90+  Recommended</p>
                            </div>
                            
                            <div style="background: #f0fdf4; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #86efac;">
                                <div style="font-size: 40px; margin-bottom: 10px;"></div>
                                <h4 style="margin: 0 0 5px 0; color: #166534;">Microsoft Edge</h4>
                                <p style="margin: 0; font-size: 13px; color: #15803d;">Version 90+</p>
                            </div>
                            
                            <div style="background: #f0fdf4; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #86efac;">
                                <div style="font-size: 40px; margin-bottom: 10px;"></div>
                                <h4 style="margin: 0 0 5px 0; color: #166534;">Mozilla Firefox</h4>
                                <p style="margin: 0; font-size: 13px; color: #15803d;">Version 88+</p>
                            </div>
                            
                            <div style="background: #f0fdf4; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #86efac;">
                                <div style="font-size: 40px; margin-bottom: 10px;"></div>
                                <h4 style="margin: 0 0 5px 0; color: #166534;">Safari</h4>
                                <p style="margin: 0; font-size: 13px; color: #15803d;">Version 14+ (macOS/iOS)</p>
                            </div>
                            
                            <div style="background: #f0fdf4; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #86efac;">
                                <div style="font-size: 40px; margin-bottom: 10px;"></div>
                                <h4 style="margin: 0 0 5px 0; color: #166534;">Samsung Internet</h4>
                                <p style="margin: 0; font-size: 13px; color: #15803d;">Version 14+</p>
                            </div>
                            
                            <div style="background: #fef3c7; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #fcd34d;">
                                <div style="font-size: 40px; margin-bottom: 10px;"></div>
                                <h4 style="margin: 0 0 5px 0; color: #a16207;">Opera</h4>
                                <p style="margin: 0; font-size: 13px; color: #a16207;">Works but less tested</p>
                            </div>
                            
                        </div>
                    </div>
                    
                    <!-- Not Supported -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="color: #b91c1c; margin-bottom: 20px;"> Not Supported</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            
                            <div style="background: #fef2f2; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #fca5a5;">
                                <div style="font-size: 40px; margin-bottom: 10px;"></div>
                                <h4 style="margin: 0 0 5px 0; color: #b91c1c;">Internet Explorer</h4>
                                <p style="margin: 0; font-size: 13px; color: #b88a8a;">Discontinued - Please upgrade</p>
                            </div>
                            
                            <div style="background: #fef2f2; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #fca5a5;">
                                <div style="font-size: 40px; margin-bottom: 10px;"></div>
                                <h4 style="margin: 0 0 5px 0; color: #b91c1c;">Very Old Browsers</h4>
                                <p style="margin: 0; font-size: 13px; color: #b88a8a;">Pre-2020 versions</p>
                            </div>
                            
                        </div>
                    </div>
                    
                    <!-- Device Support -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="color: #1f2937; margin-bottom: 20px;"> Device Support</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            
                            <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #3b82f6;">
                                <h4 style="margin: 0 0 15px 0; color: #1e40af;"> Desktop / Laptop</h4>
                                <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.7;">
                                    <li>Windows 10/11</li>
                                    <li>macOS 10.15+</li>
                                    <li>Linux (Chrome/Firefox)</li>
                                    <li>Chromebook</li>
                                </ul>
                            </div>
                            
                            <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #6b9a8d;">
                                <h4 style="margin: 0 0 15px 0; color: #166534;"> Mobile Phones</h4>
                                <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.7;">
                                    <li>iPhone (iOS 14+)</li>
                                    <li>Android phones (Android 10+)</li>
                                    <li>Samsung Galaxy</li>
                                    <li>Google Pixel</li>
                                </ul>
                            </div>
                            
                            <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #8b5cf6;">
                                <h4 style="margin: 0 0 15px 0; color: #6d28d9;"> Tablets</h4>
                                <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.7;">
                                    <li>iPad (iPadOS 14+)</li>
                                    <li>Android tablets</li>
                                    <li>Samsung Galaxy Tab</li>
                                    <li>Microsoft Surface</li>
                                </ul>
                            </div>
                            
                        </div>
                    </div>
                    
                    <!-- Performance Tips -->
                    <div style="padding: 25px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px;">
                        <h4 style="margin: 0 0 15px 0; color: #1e40af;"> Performance Tips</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #1e3a8a; line-height: 1.8;">
                            <li><strong>Keep browser updated</strong> - Latest versions have best performance and security</li>
                            <li><strong>Clear cache occasionally</strong> - Settings  Clear browsing data  Cached images/files</li>
                            <li><strong>Close unused tabs</strong> - Frees up memory for better performance</li>
                            <li><strong>Use stable internet</strong> - Wi-Fi or strong cellular signal recommended</li>
                            <li><strong>Disable ad blockers</strong> - Some may interfere with the app (add to whitelist)</li>
                        </ul>
                    </div>
                </div>
                
            </div>
            
            <!-- Glossary Quick Reference -->
            <div style="margin-top: 40px; background: #f8fafc; border-radius: 16px; padding: 30px;">
                <h3 style="margin: 0 0 20px 0; color: #1f2937;"> Quick Glossary</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div style="padding: 12px; background: white; border-radius: 8px;"><strong>PO</strong> - Purchase Order (order to supplier)</div>
                    <div style="padding: 12px; background: white; border-radius: 8px;"><strong>SO</strong> - Sales Order (invoice to customer)</div>
                    <div style="padding: 12px; background: white; border-radius: 8px;"><strong>SKU</strong> - Stock Keeping Unit (product code)</div>
                    <div style="padding: 12px; background: white; border-radius: 8px;"><strong>COGS</strong> - Cost of Goods Sold</div>
                    <div style="padding: 12px; background: white; border-radius: 8px;"><strong>AR</strong> - Accounts Receivable (money owed to you)</div>
                    <div style="padding: 12px; background: white; border-radius: 8px;"><strong>AP</strong> - Accounts Payable (money you owe)</div>
                    <div style="padding: 12px; background: white; border-radius: 8px;"><strong>Net 30</strong> - Payment due in 30 days</div>
                    <div style="padding: 12px; background: white; border-radius: 8px;"><strong>COD</strong> - Cash On Delivery</div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- How-To Guide Modal -->
    <div id="howToGuideModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto; padding: 20px 0;">
        <div style="max-width: 900px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); position: relative; max-height: calc(100vh - 40px); display: flex; flex-direction: column;">
            <!-- Header -->
            <div id="howToGuideHeader" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0 0 5px 0; font-size: 28px;"> Nowak Distributing ERP - How-To Guide</h2>
                    <p style="margin: 0; opacity: 0.95; font-size: 14px;">Complete instructions for using the system</p>
                </div>
                <button onclick="closeHowToGuide()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'"></button>
            </div>

            <!-- Tab Navigation -->
            <div style="display: flex; gap: 0; border-bottom: 2px solid #e0e0e0; background: #f8f9fa; padding: 0 20px; overflow-x: auto;">
                <button class="guide-tab active" onclick="showGuideSection('getting-started')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                     Getting Started
                </button>
                <button class="guide-tab" onclick="showGuideSection('suppliers')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                     Suppliers
                </button>
                <button class="guide-tab" onclick="showGuideSection('items')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                     Items
                </button>
                <button class="guide-tab" onclick="showGuideSection('customers')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                     Customers
                </button>
                <button class="guide-tab" onclick="showGuideSection('orders')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                     Orders
                </button>
                <button class="guide-tab" onclick="showGuideSection('reports')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                     Reports
                </button>
                <button class="guide-tab" onclick="showGuideSection('advanced')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                     Advanced
                </button>
                <button class="guide-tab" onclick="showGuideSection('updates')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                     Updates
                </button>
            </div>

            <!-- Content -->
            <div style="padding: 30px; max-height: 600px; overflow-y: auto;">
                
                <!-- Getting Started Section -->
                <div id="guide-getting-started" class="guide-section">
                    <h3 style="color: #667eea; margin-top: 0;"> Getting Started</h3>
                    
                    <div style="background: #f0f7ff; border-left: 4px solid #667eea; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <strong>Welcome to Nowak Distributing ERP!</strong><br>
                        This system helps you manage suppliers, inventory, customers, and orders all in one place.
                    </div>

                    <h4> Home / Landing Page</h4>
                    <ul style="line-height: 1.8;">
                        <li>The <strong>Home tab</strong> is your dashboard - click any card to navigate to that section</li>
                        <li>Each card shows a different area of the system</li>
                        <li>Perfect for showing to customers (no data visible)</li>
                    </ul>

                    <h4> Choosing a Theme</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Settings</strong> tab</li>
                        <li>Click the <strong>Theme</strong> box</li>
                        <li>Browse 280+ themes (sports teams, colors, etc.)</li>
                        <li>Click any theme to apply it instantly</li>
                    </ol>

                    <h4> Navigation Tips</h4>
                    <ul style="line-height: 1.8;">
                        <li>Use the <strong>tabs at the top</strong> to switch between sections</li>
                        <li>Click <strong> Back button</strong> (bottom-left) to return to previous page</li>
                        <li>The active tab is highlighted</li>
                    </ul>
                </div>

                <!-- Suppliers Section -->
                <div id="guide-suppliers" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;"> Managing Suppliers</h3>

                    <h4> Adding a New Supplier</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Suppliers</strong> tab</li>
                        <li>Click <strong> Add Supplier</strong></li>
                        <li>Fill in:
                            <ul>
                                <li><strong>Supplier Name</strong> (required)</li>
                                <li><strong>Contact Name</strong></li>
                                <li><strong>Email & Phone</strong></li>
                                <li><strong>Address</strong></li>
                                <li><strong>Payment Terms</strong> (Net 30, Net 60, etc.)</li>
                            </ul>
                        </li>
                        <li>Click <strong> Save</strong></li>
                    </ol>

                    <h4> Editing a Supplier</h4>
                    <ol style="line-height: 1.8;">
                        <li>Find the supplier in the list</li>
                        <li>Click the <strong> Edit</strong> button</li>
                        <li>Update any information</li>
                        <li>Click <strong> Save Changes</strong></li>
                    </ol>

                    <h4> Deleting a Supplier</h4>
                    <ol style="line-height: 1.8;">
                        <li>Click <strong> Delete</strong> on the supplier</li>
                        <li>Confirm deletion</li>
                        <li><strong>Warning:</strong> You cannot delete suppliers with existing items or orders</li>
                    </ol>

                    <div style="background: #f0e8d0; border-left: 4px solid #b8a86b; padding: 15px; margin-top: 20px; border-radius: 4px;">
                        <strong> Tip:</strong> Keep supplier information up-to-date for accurate purchase orders and invoicing.
                    </div>
                </div>

                <!-- Items Section -->
                <div id="guide-items" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;"> Managing Items</h3>

                    <h4> Adding a New Item</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Items</strong> tab</li>
                        <li>Click <strong> Add Item</strong></li>
                        <li>Fill in:
                            <ul>
                                <li><strong>SKU</strong> - Your product code</li>
                                <li><strong>Description</strong> - What is it?</li>
                                <li><strong>Supplier</strong> - Who do you buy from?</li>
                                <li><strong>Cost</strong> - What you pay</li>
                                <li><strong>Sell Price</strong> - What you charge</li>
                                <li><strong>Qty On Hand</strong> - Current stock</li>
                                <li><strong>Reorder Point</strong> - When to reorder</li>
                            </ul>
                        </li>
                        <li>Click <strong> Save</strong></li>
                    </ol>

                    <h4> Bulk Import Items (from Excel)</h4>
                    <ol style="line-height: 1.8;">
                        <li>Click <strong> Download Items</strong> button</li>
                        <li>Save the PDF, then convert to Excel (use ilovepdf.com)</li>
                        <li>Edit prices, quantities, etc. in Excel</li>
                        <li>Click <strong> Upload Items</strong></li>
                        <li>Select your Excel file</li>
                        <li>Choose mode: <strong>Update Existing + Add New</strong> OR <strong>Full Refresh</strong></li>
                        <li>Click <strong> Preview Changes</strong></li>
                        <li>Review what will change</li>
                        <li>Click <strong> Commit Changes</strong> or <strong> Cancel</strong></li>
                    </ol>

                    <h4> Filtering Items</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Search:</strong> Type SKU or description</li>
                        <li><strong>Supplier:</strong> Filter by supplier</li>
                        <li><strong>Stock Status:</strong> Low Stock, Negative, On Order, Needs Reorder</li>
                        <li><strong>Active/Archived:</strong> Show only active items</li>
                    </ul>

                    <div style="background: #f0e8d0; border-left: 4px solid #b8a86b; padding: 15px; margin-top: 20px; border-radius: 4px;">
                        <strong> Tip:</strong> Use the bulk import feature for price updates or inventory counts!
                    </div>
                </div>

                <!-- Customers Section -->
                <div id="guide-customers" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;"> Managing Customers</h3>

                    <h4> Adding a New Customer</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Customers</strong> tab</li>
                        <li>Click <strong> Add Customer</strong></li>
                        <li>Fill in:
                            <ul>
                                <li><strong>Customer Name</strong></li>
                                <li><strong>Contact Name</strong></li>
                                <li><strong>Email & Phone</strong></li>
                                <li><strong>Billing Address</strong></li>
                                <li><strong>Shipping Address</strong> (if different)</li>
                                <li><strong>Payment Terms</strong></li>
                            </ul>
                        </li>
                        <li>Click <strong> Save</strong></li>
                    </ol>

                    <h4> Editing a Customer</h4>
                    <ol style="line-height: 1.8;">
                        <li>Find customer in the list</li>
                        <li>Click <strong> Edit</strong></li>
                        <li>Update information</li>
                        <li>Click <strong> Save Changes</strong></li>
                    </ol>

                    <div style="background: #f0f7ff; border-left: 4px solid #667eea; padding: 15px; margin-top: 20px; border-radius: 4px;">
                        <strong> Note:</strong> Customer information is used for sales orders and invoices.
                    </div>
                </div>

                <!-- Orders Section -->
                <div id="guide-orders" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;"> Managing Orders</h3>

                    <h4> Creating a Purchase Order</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Create PO</strong> tab</li>
                        <li>Select <strong>Supplier</strong></li>
                        <li>Click <strong> Add Line Item</strong></li>
                        <li>Select <strong>Item</strong> and enter <strong>Quantity</strong></li>
                        <li>Add more line items as needed</li>
                        <li>Review <strong>Total Amount</strong></li>
                        <li>Click <strong> Save Purchase Order</strong></li>
                    </ol>

                    <h4> Creating a Sales Order</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Sales</strong> tab</li>
                        <li>Click <strong> Create Sales Order</strong></li>
                        <li>Select <strong>Customer</strong></li>
                        <li>Add line items (items and quantities)</li>
                        <li>Review total</li>
                        <li>Click <strong> Save</strong></li>
                    </ol>

                    <h4> Receiving a Purchase Order</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Purchases</strong> tab</li>
                        <li>Find the PO</li>
                        <li>Click <strong> View</strong></li>
                        <li>Change status to <strong>Received</strong></li>
                        <li>Inventory automatically updates!</li>
                    </ol>

                    <h4> Voiding an Order</h4>
                    <ol style="line-height: 1.8;">
                        <li>Open the order</li>
                        <li>Change status to <strong>Voided</strong></li>
                        <li>Inventory reverses automatically</li>
                    </ol>

                    <h4> Printing Orders</h4>
                    <ul style="line-height: 1.8;">
                        <li>Open any order</li>
                        <li>Click <strong> Print</strong></li>
                        <li>Print matches your selected theme!</li>
                    </ul>

                    <div style="background: #f0e8d0; border-left: 4px solid #b8a86b; padding: 15px; margin-top: 20px; border-radius: 4px;">
                        <strong> Tip:</strong> Status changes automatically update inventory counts.
                    </div>
                </div>

                <!-- Advanced Section -->
                <div id="guide-advanced" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;"> Advanced Features</h3>

                    <h4> Inventory Management</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Manual Adjustments:</strong> Add/remove inventory manually</li>
                        <li><strong>Audit Trail:</strong> See all inventory changes with dates</li>
                        <li><strong>Low Stock Alerts:</strong> Filter by items below reorder point</li>
                    </ul>

                    <h4> Price Simulator</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Price Sim</strong> tab</li>
                        <li>Select an item</li>
                        <li>Try different sell prices</li>
                        <li>See profit margin and revenue impact</li>
                        <li>Apply new price if desired</li>
                    </ol>

                    <h4> Backup & Data Access</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Settings</strong> tab</li>
                        <li>Click <strong> Open Google Sheet</strong></li>
                        <li>Access raw data directly</li>
                        <li>Make backups as needed</li>
                    </ol>

                    <h4> Customization</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>280+ Themes:</strong> NFL, NHL, MLB teams + colors</li>
                        <li><strong>Print Templates:</strong> Auto-match theme colors</li>
                        <li><strong>Landing Page:</strong> Customer-safe first screen</li>
                    </ul>

                    <div style="background: #d1f2eb; border-left: 4px solid #6b9a8d; padding: 15px; margin-top: 20px; border-radius: 4px;">
                        <strong> Pro Tip:</strong> Regularly backup your Google Sheet and use the bulk import for major updates!
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="guide-reports" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;"> Reports Guide</h3>

                    <div style="background: #f0f7ff; border-left: 4px solid #667eea; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <strong>Report Window Features:</strong><br>
                         Drag the header to move the window<br>
                         Drag the corner to resize<br>
                         Click  to maximize/restore<br>
                         Window size is remembered between sessions
                    </div>

                    <h4> Action Dashboard</h4>
                    <p>Your daily command center showing items needing immediate attention:</p>
                    <ul style="line-height: 1.8;">
                        <li><strong>Low Stock - Needs Reorder:</strong> Items below reorder point (considering pending POs)</li>
                        <li><strong>Overdue POs:</strong> Purchase orders past their expected delivery date</li>
                        <li><strong>Unpaid Invoices:</strong> Customer payments that are past due</li>
                        <li><strong>Qty On Order Sync:</strong> Detects mismatches between item quantities and pending POs</li>
                        <li><strong>Quick Order:</strong> Create POs directly from the dashboard with one click</li>
                        <li><strong>Bulk Reorder:</strong> Select multiple items and create one PO</li>
                    </ul>

                    <h4> Inventory Pick List</h4>
                    <p>Generate picking lists for deliveries:</p>
                    <ul style="line-height: 1.8;">
                        <li>Organized by <strong>Customer  Item  Invoices</strong></li>
                        <li>Shows <strong>cumulative inventory</strong> tracking across customers</li>
                        <li><strong>Stock</strong> column: inventory before this customer's pick</li>
                        <li><strong>After</strong> column: inventory after pick (running total)</li>
                        <li>Alerts when stock goes negative</li>
                        <li>Print-optimized layout</li>
                    </ul>

                    <h4> Sales Reports</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Sales Dashboard:</strong> Revenue, cost, profit, and margin KPIs</li>
                        <li><strong>Sales by Customer:</strong> Customer performance with addresses</li>
                        <li><strong>Sales Order Detail:</strong> All invoices with customer addresses</li>
                        <li><strong>Sales by Product:</strong> Product performance analysis</li>
                        <li><strong>Sales Dashboard:</strong> Top sellers, customers and margins</li>
                        <li><strong>Customer Dashboard:</strong> Individual customer deep-dive</li>
                    </ul>

                    <h4> Inventory Reports</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Inventory List:</strong> Current stock levels</li>
                        <li><strong>Gross Margin:</strong> Margin analysis with Top 10/Bottom 5 charts</li>
                        <li><strong>Inventory Turnover:</strong> How fast items sell</li>
                        <li><strong>Inventory Valuation:</strong> Total inventory value</li>
                    </ul>

                    <h4> Financial Reports</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Accounts Receivable:</strong> What customers owe you</li>
                        <li><strong>Accounts Payable:</strong> What you owe suppliers</li>
                        <li><strong>Profit & Loss:</strong> Simplified P&L statement</li>
                        <li><strong>Cash Flow Summary:</strong> Money in vs money out</li>
                    </ul>
                </div>

                <!-- Updates Section -->
                <div id="guide-updates" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;"> Recent Updates (December 2025)</h3>

                    <div style="background: #e0ebe7; border-left: 4px solid #6b9a8d; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <strong>Version 16.120</strong> - Latest Release
                    </div>

                    <h4> Report Window Improvements</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Resizable windows:</strong> Drag the corner to resize report modals</li>
                        <li><strong>Maximize button:</strong> Click  to go full-screen</li>
                        <li><strong>Persistent sizing:</strong> Window size saved between sessions</li>
                        <li><strong>Larger default:</strong> Reports now open at 1400px wide (up from 900px)</li>
                    </ul>

                    <h4> Pick List Enhancements</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Cumulative inventory tracking:</strong> "After" column shows running total across all customers</li>
                        <li><strong>Reorganized layout:</strong> Customer  Item  Invoices structure</li>
                        <li><strong>Print optimization:</strong> Better alignment and formatting for printing</li>
                    </ul>

                    <h4> Action Dashboard Improvements</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Auto-refresh:</strong> Dashboard refreshes after creating POs</li>
                        <li><strong>Fixed Qty Sync:</strong> Accurate detection of on-order mismatches</li>
                        <li><strong>Faster loading:</strong> Uses cached data for better performance</li>
                    </ul>

                    <h4> Report Enhancements</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Sales by Customer:</strong> Now includes customer address column</li>
                        <li><strong>Sales Order Detail:</strong> Now includes customer address column</li>
                        <li><strong>Gross Margin charts:</strong> Fixed to show actual margin percentages</li>
                        <li><strong>Sales Dashboard:</strong> Cost and Profit now show cents (not rounded)</li>
                    </ul>

                    <h4> Bug Fixes</h4>
                    <ul style="line-height: 1.8;">
                        <li>Fixed chart data labels showing incorrect percentages</li>
                        <li>Fixed Pick List empty report issues</li>
                        <li>Fixed print layout alignment problems</li>
                        <li>Fixed modal animation looping</li>
                        <li>Fixed chart label cutoff issues</li>
                    </ul>

                    <h4> Mobile Improvements</h4>
                    <ul style="line-height: 1.8;">
                        <li>Better touch sensitivity for scrolling</li>
                        <li>Improved modal positioning on mobile</li>
                        <li>Fixed date picker compatibility with Safari</li>
                    </ul>

                    <div style="background: #f0e8d0; border-left: 4px solid #b8a86b; padding: 15px; margin-top: 20px; border-radius: 4px;">
                        <strong> Tip:</strong> If you encounter any issues, try the <strong>Diagnostic Tool</strong> in Settings to test your connection!
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <div style="background: #f8f9fa; padding: 20px 30px; border-radius: 0 0 16px 16px; border-top: 1px solid #e0e0e0; text-align: center; color: #666;">
                <p style="margin: 0; font-size: 14px;">Need more help? Contact support or refer to the Google Sheet for raw data access.</p>
            </div>
        </div>
    </div>

    <!-- Diagnostic Tool Modal -->
    <div id="diagnosticModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10001; overflow-y: auto; padding: 10px;">
        <div style="max-width: 600px; margin: 0 auto; background: #1a1a2e; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); max-height: calc(100vh - 20px); display: flex; flex-direction: column; color: #fff;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #b8a86b 0%, #b8a86b 100%); color: #000; padding: 20px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: 20px; font-weight: 700;"> Diagnostic Tool</h2>
                    <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.8;">Test API connectivity & troubleshoot issues</p>
                </div>
                <button onclick="closeDiagnosticTool()" style="background: rgba(0,0,0,0.2); border: none; color: #000; font-size: 24px; width: 36px; height: 36px; border-radius: 8px; cursor: pointer;"></button>
            </div>
            
            <!-- Body -->
            <div style="padding: 20px; overflow-y: auto; flex: 1;">
                <!-- Current Environment -->
                <div style="background: #16213e; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #b8a86b; font-size: 14px;"> Current Environment</h4>
                    <div id="diagEnvDisplay" style="font-family: monospace; font-size: 13px; color: #4ade80; word-break: break-all;"></div>
                </div>
                
                <!-- Test Buttons -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <button onclick="runDiagnosticTest('connection')" style="background: #3b82f6; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: 600; cursor: pointer;">
                         Test Connection
                    </button>
                    <button onclick="runDiagnosticTest('suppliers')" style="background: #8b5cf6; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: 600; cursor: pointer;">
                         Test Suppliers
                    </button>
                    <button onclick="runDiagnosticTest('items')" style="background: #6b9a8d; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: 600; cursor: pointer;">
                         Test Items
                    </button>
                    <button onclick="runDiagnosticTest('customers')" style="background: #b8a86b; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: 600; cursor: pointer;">
                         Test Customers
                    </button>
                </div>
                
                <button onclick="runAllDiagnostics()" style="width: 100%; background: linear-gradient(135deg, #b8a86b, #b8a86b); color: #000; border: none; padding: 15px; border-radius: 10px; font-weight: 700; cursor: pointer; margin-bottom: 20px; font-size: 16px;">
                     Run All Tests
                </button>
                
                <!-- Results -->
                <div style="background: #0f0f1a; border-radius: 10px; padding: 15px; min-height: 200px;">
                    <h4 style="margin: 0 0 10px 0; color: #a0a0a0; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Test Results</h4>
                    <div id="diagResults" style="font-family: monospace; font-size: 12px; line-height: 1.8; color: #e0e0e0;">
                        <p style="color: #666;">Click a test button to begin...</p>
                    </div>
                </div>
                
                <!-- Tips -->
                <div style="background: #1e3a5f; border-radius: 10px; padding: 15px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #60a5fa; font-size: 14px;"> Troubleshooting Tips</h4>
                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #94a3b8; line-height: 1.8;">
                        <li>If tests fail, check your internet connection</li>
                        <li>Try switching environments in Settings</li>
                        <li>Clear browser cache and reload</li>
                        <li>On mobile, try closing and reopening the app</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Adjust Inventory Modal (for use within reports) -->
    <div id="quickAdjustModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10002; overflow-y: auto; padding: 20px;">
        <div style="max-width: 500px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: 20px; font-weight: 700;"> Quick Inventory Adjustment</h2>
                    <p id="quickAdjustItemName" style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;"></p>
                </div>
                <button onclick="closeQuickAdjustModal()" style="background: rgba(0,0,0,0.2); border: none; color: white; font-size: 24px; width: 36px; height: 36px; border-radius: 8px; cursor: pointer;"></button>
            </div>
            
            <!-- Body -->
            <div style="padding: 25px;">
                <input type="hidden" id="quickAdjustItemId">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Current Stock</div>
                        <div id="quickAdjustCurrentQty" style="font-size: 28px; font-weight: 700; color: #333;">0</div>
                    </div>
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">New Stock</div>
                        <div id="quickAdjustNewQty" style="font-size: 28px; font-weight: 700; color: #6b9a8d;">0</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Adjustment (+/-) *</label>
                    <input type="number" id="quickAdjustAmount" placeholder="e.g., -5 or +10" 
                           oninput="updateQuickAdjustPreview()"
                           style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 18px; text-align: center;">
                    <small style="color: #666;">Negative to decrease, positive to increase</small>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Reason *</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button type="button" onclick="selectQuickReason('Physical Count')" class="quick-reason-btn" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-size: 13px;"> Physical Count</button>
                        <button type="button" onclick="selectQuickReason('Damaged')" class="quick-reason-btn" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-size: 13px;"> Damaged</button>
                        <button type="button" onclick="selectQuickReason('Shrinkage')" class="quick-reason-btn" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-size: 13px;"> Shrinkage</button>
                        <button type="button" onclick="selectQuickReason('Found Stock')" class="quick-reason-btn" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-size: 13px;"> Found Stock</button>
                        <button type="button" onclick="selectQuickReason('Return')" class="quick-reason-btn" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-size: 13px;"> Return</button>
                        <button type="button" onclick="selectQuickReason('Correction')" class="quick-reason-btn" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-size: 13px;"> Correction</button>
                    </div>
                    <input type="hidden" id="quickAdjustReason">
                    <div id="quickAdjustReasonDisplay" style="margin-top: 8px; padding: 8px; background: #f0f0f0; border-radius: 6px; font-size: 13px; color: #666; display: none;"></div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Notes (optional)</label>
                    <input type="text" id="quickAdjustNotes" placeholder="Additional details..." 
                           style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button id="quickAdjustCancelBtn" onclick="closeQuickAdjustModal()" style="flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 8px; background: white; font-size: 16px; cursor: pointer;">Cancel</button>
                    <button id="quickAdjustSubmitBtn" onclick="submitQuickAdjustment()" style="flex: 2; padding: 14px; border: none; border-radius: 8px; background: linear-gradient(135deg, #f39c12, #e67e22); color: white; font-size: 16px; font-weight: 600; cursor: pointer;"> Save Adjustment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick View Item Modal (for use within reports) -->
    <div id="quickViewItemModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10002; overflow-y: auto; padding: 20px;">
        <div style="max-width: 550px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
            <!-- Header -->
            <div id="quickViewItemHeader" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: 20px; font-weight: 700;"> Item Details</h2>
                    <p id="quickViewItemSKU" style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;"></p>
                </div>
                <button onclick="closeQuickViewItemModal()" style="background: rgba(0,0,0,0.2); border: none; color: white; font-size: 24px; width: 36px; height: 36px; border-radius: 8px; cursor: pointer;"></button>
            </div>
            
            <!-- Body -->
            <div id="quickViewItemBody" style="padding: 25px;">
                <!-- Content populated by JS -->
            </div>
            
            <!-- Footer -->
            <div style="padding: 15px 25px 25px; display: flex; gap: 10px;">
                <button onclick="closeQuickViewItemModal()" style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; background: white; font-size: 14px; cursor: pointer;">Close</button>
                <button onclick="quickViewToAdjust()" style="flex: 1; padding: 12px; border: none; border-radius: 8px; background: #f39c12; color: white; font-size: 14px; font-weight: 600; cursor: pointer;"> Adjust Qty</button>
                <button onclick="quickViewToCreatePO()" style="flex: 1; padding: 12px; border: none; border-radius: 8px; background: #6b9a8d; color: white; font-size: 14px; font-weight: 600; cursor: pointer;"> Restock</button>
            </div>
        </div>
    </div>

    <!-- Upload Items Modal -->
    <div id="uploadItemsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto; padding: 20px 0;">
        <div style="max-width: 700px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); padding: 30px; max-height: calc(100vh - 40px); overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; color: #667eea;"> Upload Items - Bulk Import</h2>
                <button onclick="closeUploadItemsModal()" style="background: #b88a8a; border: none; color: white; font-size: 24px; width: 35px; height: 35px; border-radius: 6px; cursor: pointer;"></button>
            </div>

            <div style="background: #f0e8d0; border-left: 4px solid #b8a86b; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                <strong> Important Instructions:</strong>
                <ul style="margin: 10px 0 0 0; padding-left: 20px; line-height: 1.7;">
                    <li><strong>DO NOT modify the Item_ID column</strong> - This is your primary key</li>
                    <li>You can edit SKU, Description, Supplier_ID, Cost, Sell_Price, quantities, Status</li>
                    <li>To add new items, leave Item_ID blank or type "NEW"</li>
                    <li><strong>BACKUP RECOMMENDED:</strong> Download a copy before uploading</li>
                    <li>Accepted formats: Excel (.xlsx, .xls) or CSV (.csv)</li>
                </ul>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Select File:</label>
                <input type="file" id="uploadItemsFile" accept=".xlsx,.xls,.csv" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
            </div>

            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 12px; font-weight: 600;">Upload Mode:</label>
                
                <label style="display: block; padding: 15px; border: 2px solid #6b9a8d; border-radius: 8px; margin-bottom: 10px; cursor: pointer; background: #f0f7ff;">
                    <input type="radio" name="uploadMode" value="update-add" checked style="margin-right: 10px;">
                    <strong style="color: #6b9a8d;"> Update Existing + Add New (Recommended)</strong>
                    <div style="margin-left: 28px; margin-top: 5px; font-size: 13px; color: #666;">
                         Matches on Item_ID<br>
                         Updates existing items<br>
                         Adds new items if Item_ID is blank or "NEW"<br>
                         Safe - does not delete anything
                    </div>
                </label>

                <label style="display: block; padding: 15px; border: 2px solid #b88a8a; border-radius: 8px; cursor: pointer; background: #ffebee;">
                    <input type="radio" name="uploadMode" value="full-refresh" style="margin-right: 10px;">
                    <strong style="color: #b88a8a;"> Full Refresh (DANGER)</strong>
                    <div style="margin-left: 28px; margin-top: 5px; font-size: 13px; color: #666;">
                         <strong>DELETES ALL existing items</strong><br>
                         Replaces with uploaded file<br>
                         Requires 3 confirmations<br>
                         Use with extreme caution!
                    </div>
                </label>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn" onclick="previewItemsUpload()" style="background: #7aaab8; width: 100%; padding: 15px; font-size: 16px;">
                     Preview Changes
                </button>
                <button class="btn" onclick="closeUploadItemsModal()" style="width: 100%; margin-top: 10px; background: var(--secondary, #764ba2); color: white;">
                    Cancel
                </button>
            </div>

            <div id="uploadItemsPreview" style="margin-top: 20px; display: none;">
                <h3 style="color: #667eea; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0;"> Preview Changes</h3>
                <div id="uploadItemsSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin: 15px 0;"></div>
                <div id="uploadItemsPreviewContent" style="max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 12px; border-radius: 8px; border: 2px solid #667eea; font-size: 13px;"></div>
                
                <div style="margin-top: 15px; padding: 12px; background: #f0e8d0; border-radius: 8px; border-left: 4px solid #b8a86b;">
                    <strong> Review carefully before committing!</strong> Once you click "Commit Changes", the database will be updated.
                </div>
                
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn" onclick="commitItemsUpload()" style="background: #6b9a8d; flex: 1; padding: 12px; font-size: 15px;">
                         Commit Changes
                    </button>
                    <button class="btn" onclick="cancelPreview()" style="flex: 1; padding: 12px; font-size: 15px; background: var(--secondary, #764ba2); color: white;">
                         Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== ENVIRONMENT MANAGEMENT ====================
        // Default URLs for each environment
        const DEFAULT_PRODUCTION_URL = 'https://script.google.com/macros/s/AKfycbyCcX93pMAfO3hOsrQjDuSnMMMmL0l9EnLFHnn0BBQ_RjGelL-Jp-0OcSRTgf72rIAITA/exec';
        const DEFAULT_TRAINING_URL = 'https://script.google.com/macros/s/AKfycbxfYLcOjk04p2MMSzAkiUT26MXx0zrzCmBdCqJ1oPfgcvIEBNtIfTzOsStuV-Nlibc7/exec';
        const DEFAULT_TEST_URL = 'https://script.google.com/macros/s/AKfycbyNVzERe6ZKvSiTX0yNF3IU9gT2V2cK8hzXoqsSmU5hE9fVXokO0zV2XXbiWxyrB-DF/exec';
        
        // Environment configuration (loaded from localStorage)
        let environments = {
            production: localStorage.getItem('envUrl-production') || DEFAULT_PRODUCTION_URL,
            training: localStorage.getItem('envUrl-training') || DEFAULT_TRAINING_URL,
            test: localStorage.getItem('envUrl-test') || DEFAULT_TEST_URL
        };
        
        // Current active environment
        let currentEnvironment = localStorage.getItem('currentEnvironment') || 'production';
        
        // Get the active API URL based on current environment
        function getActiveApiUrl() {
            return environments[currentEnvironment] || environments.production || DEFAULT_PRODUCTION_URL;
        }
        
        // API_URL - now dynamically set from environment
        let API_URL = getActiveApiUrl();
        
        // Also support legacy apiUrl for backward compatibility
        if (localStorage.getItem('apiUrl') && !localStorage.getItem('envUrl-production')) {
            environments.production = localStorage.getItem('apiUrl');
            localStorage.setItem('envUrl-production', environments.production);
        }
        
        // ==================== HIDE FIXED ELEMENTS ON SCROLL ====================
        // Hide badge and settings when scrolling down, show at top
        (function() {
            let ticking = false;
            
            function updateFixedElements() {
                const scrollY = window.scrollY || window.pageYOffset || 0;
                const envBadge = document.getElementById('envBadge');
                const settingsBtn = document.getElementById('settingsBtn');
                
                // Hide if scrolled down more than 50px, show if at top
                if (scrollY > 50) {
                    if (envBadge) envBadge.style.opacity = '0';
                    if (settingsBtn) settingsBtn.style.opacity = '0';
                } else {
                    if (envBadge) envBadge.style.opacity = '1';
                    if (settingsBtn) settingsBtn.style.opacity = '1';
                }
                
                ticking = false;
            }
            
            window.addEventListener('scroll', function() {
                if (!ticking) {
                    window.requestAnimationFrame(updateFixedElements);
                    ticking = true;
                }
            }, { passive: true });
            
            // Initial state
            updateFixedElements();
        })();
        
        // Switch to a different environment
        function switchEnvironment(env) {
            if (!environments[env]) {
                showWarning(`No URL configured for ${env} environment. Please enter a URL first.`);
                return;
            }
            
            currentEnvironment = env;
            localStorage.setItem('currentEnvironment', env);
            API_URL = getActiveApiUrl();
            
            // Also update legacy apiUrl for compatibility
            localStorage.setItem('apiUrl', API_URL);
            
            // Update UI
            updateEnvironmentUI();
            
            // Show confirmation
            const envNames = { production: ' Production', training: ' Training', test: ' Development' };
            showStatus('configStatus', ` Switched to ${envNames[env]} environment`, 'success');
            
            // Refresh all data
            refreshAfterEnvSwitch();
        }
        
        // Save an environment URL
        function saveEnvironmentUrl(env) {
            const input = document.getElementById(`envUrl-${env}`);
            if (input) {
                const url = input.value.trim();
                environments[env] = url;
                localStorage.setItem(`envUrl-${env}`, url);
                
                // If this is the current environment, update API_URL
                if (env === currentEnvironment) {
                    API_URL = url;
                    localStorage.setItem('apiUrl', url);
                }
                
                console.log(`Saved ${env} URL:`, url);
            }
        }
        
        // Restore default URLs (useful after clearing site data)
        function restoreDefaultUrls() {
            // Set the input fields to default values
            document.getElementById('envUrl-production').value = DEFAULT_PRODUCTION_URL;
            document.getElementById('envUrl-training').value = DEFAULT_TRAINING_URL;
            document.getElementById('envUrl-test').value = DEFAULT_TEST_URL;
            
            // Save to localStorage
            environments.production = DEFAULT_PRODUCTION_URL;
            environments.training = DEFAULT_TRAINING_URL;
            environments.test = DEFAULT_TEST_URL;
            
            localStorage.setItem('envUrl-production', DEFAULT_PRODUCTION_URL);
            localStorage.setItem('envUrl-training', DEFAULT_TRAINING_URL);
            localStorage.setItem('envUrl-test', DEFAULT_TEST_URL);
            
            // Update current API_URL
            API_URL = environments[currentEnvironment] || DEFAULT_PRODUCTION_URL;
            localStorage.setItem('apiUrl', API_URL);
            
            showSuccess('Default URLs restored!\n\nProduction, Training, and Development URLs have been repopulated.');
            console.log('Default URLs restored:', environments);
        }
        
        // Update UI to reflect current environment
        function updateEnvironmentUI() {
            // Letter colors only (background stays theme color)
            const envLetterColors = {
                production: 'white',    // White like settings gear
                training: '#93c5fd',    // Light blue  
                test: '#fca5a5'         // Light red
            };
            const envButtonColors = {
                production: { bg: '#d1fae5', border: '#059669', text: '#065f46', activeBg: '#d1fae5' },
                training: { bg: '#dbeafe', border: '#0284c7', text: '#0369a1', activeBg: '#dbeafe' },
                test: { bg: '#fee2e2', border: '#b88a8a', text: '#991b1b', activeBg: '#fee2e2' }
            };
            const envNames = { production: ' Production', training: ' Training', test: ' Development' };
            const envLetters = { production: 'P', training: 'T', test: 'D' };
            const envTitles = { 
                production: 'Production Environment - Click to change', 
                training: 'Training Environment - Click to change', 
                test: 'Development Environment - Click to change' 
            };
            
            // Update buttons in settings
            ['production', 'training', 'test'].forEach(env => {
                const btn = document.getElementById(`envBtn-${env}`);
                if (btn) {
                    const colors = envButtonColors[env];
                    if (env === currentEnvironment) {
                        btn.style.background = colors.activeBg;
                        btn.style.borderWidth = '3px';
                        btn.style.transform = 'scale(1.05)';
                        btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    } else {
                        btn.style.background = 'white';
                        btn.style.borderWidth = '3px';
                        btn.style.transform = 'scale(1)';
                        btn.style.boxShadow = 'none';
                    }
                }
            });
            
            // Update status display in settings
            const display = document.getElementById('currentEnvDisplay');
            if (display) {
                const colors = envButtonColors[currentEnvironment];
                display.style.background = colors.activeBg;
                display.style.color = colors.text;
                display.innerHTML = ` Currently using: <strong>${envNames[currentEnvironment]}</strong>`;
            }
            
            // Update the small circle badge in top left - only change letter color
            const badge = document.getElementById('envBadge');
            if (badge) {
                badge.style.color = envLetterColors[currentEnvironment];
                badge.textContent = envLetters[currentEnvironment];
                badge.title = envTitles[currentEnvironment];
            }
            
            // Update page title to show environment
            if (currentEnvironment === 'test') {
                document.title = 'ERP System [DEVELOPMENT]';
            } else if (currentEnvironment === 'training') {
                document.title = 'ERP System [TRAINING]';
            } else {
                document.title = 'Nowak Distributing - ERP System';
            }
        }
        
        // Refresh all cached data after environment switch
        async function refreshAfterEnvSwitch() {
            // Show loading indicator
            const envNames = { production: ' Production', training: ' Training', test: ' Development' };
            showStatus('configStatus', ` Loading all data from ${envNames[currentEnvironment]}...`, 'info');
            
            // Clear all caches
            cachedSuppliers = [];
            cachedItems = [];
            cachedCustomers = [];
            
            try {
                // Load ALL data in parallel for speed
                console.log(' Refreshing all data for environment:', currentEnvironment);
                
                await Promise.all([
                    loadSuppliers(),
                    loadItems(),
                    loadCustomers(),
                    loadPurchases(),
                    loadSales(),
                    loadInventory()
                ]);
                
                // IMPORTANT: Repopulate ALL dropdowns with new data
                repopulateAllDropdowns();
                
                // Show success message
                showStatus('configStatus', ` All data loaded from ${envNames[currentEnvironment]}!`, 'success');
                console.log(' All data refreshed successfully');
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                showStatus('configStatus', ` Some data may not have loaded. Try refreshing individual tabs.`, 'error');
            }
        }
        
        // Repopulate ALL dropdowns after environment switch
        function repopulateAllDropdowns() {
            console.log(' Repopulating all dropdowns with new environment data...');
            
            // Customer dropdowns
            const customerSelects = document.querySelectorAll('#soCustomer, #filter_customer, #custDash_customer');
            customerSelects.forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Customer</option>';
                    if (select.id === 'filter_customer' || select.id === 'custDash_customer') {
                        select.innerHTML = '<option value="">All Customers</option>';
                    }
                    cachedCustomers.forEach(c => {
                        select.innerHTML += `<option value="${c.Customer_ID}">${c.Customer_Name}</option>`;
                    });
                    // Restore selection if still valid
                    if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                        select.value = currentValue;
                    }
                }
            });
            
            // Supplier dropdowns
            const supplierSelects = document.querySelectorAll('#poSupplier, #filterSupplier, #filterItemSupplier, #createPOSupplier, #suppDash_supplier');
            supplierSelects.forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    const isFilter = select.id.includes('filter') || select.id.includes('Dash');
                    select.innerHTML = isFilter ? '<option value="">All Suppliers</option>' : '<option value="">Select Supplier</option>';
                    cachedSuppliers.forEach(s => {
                        select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                    });
                    if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                        select.value = currentValue;
                    }
                }
            });
            
            // Item dropdowns (Sales Order line items)
            document.querySelectorAll('.so-item').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Item</option>';
                cachedItems.forEach(item => {
                    select.innerHTML += `<option value="${item.Item_ID}" data-price="${item.Unit_Sell_Price}" data-stock="${item.Qty_On_Hand || 0}">${item.Item_Description}</option>`;
                });
                if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                    select.value = currentValue;
                }
            });
            
            // Item dropdowns (Purchase Order line items)
            document.querySelectorAll('.po-item').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Item</option>';
                cachedItems.forEach(item => {
                    const packageCost = parseFloat(item.Package_Cost) || 0;
                    const unitsPerPackage = parseInt(item.Units_Per_Package) || 1;
                    select.innerHTML += `<option value="${item.Item_ID}" data-cost="${packageCost.toFixed(2)}" data-units="${unitsPerPackage}">${item.Item_Description}</option>`;
                });
                if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                    select.value = currentValue;
                }
            });
            
            // Create PO item dropdowns
            document.querySelectorAll('.createpo-item').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select item...</option>';
                cachedItems.forEach(item => {
                    const packageCost = parseFloat(item.Package_Cost) || 0;
                    const unitsPerPackage = parseInt(item.Units_Per_Package) || 1;
                    select.innerHTML += `<option value="${item.Item_ID}" data-cost="${packageCost.toFixed(2)}" data-units="${unitsPerPackage}">${item.Item_Description}</option>`;
                });
                if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                    select.value = currentValue;
                }
            });
            
            // Filter item dropdown
            const filterItem = document.getElementById('filter_item');
            if (filterItem) {
                const currentValue = filterItem.value;
                filterItem.innerHTML = '<option value="">All Items</option>';
                cachedItems.forEach(item => {
                    filterItem.innerHTML += `<option value="${item.Item_ID}">${item.Item_Description}</option>`;
                });
                if (currentValue && filterItem.querySelector(`option[value="${currentValue}"]`)) {
                    filterItem.value = currentValue;
                }
            }
            
            console.log(' All dropdowns repopulated');
        }
        
        // Initialize environment URLs in the form on page load
        function initializeEnvironmentForm() {
            // Load URLs into form fields
            ['production', 'training', 'test'].forEach(env => {
                const input = document.getElementById(`envUrl-${env}`);
                if (input && environments[env]) {
                    input.value = environments[env];
                }
            });
            
            // Update UI to show current environment
            updateEnvironmentUI();
            
            // MOBILE FIX: Add touch-friendly event listeners to environment buttons
            ['production', 'training', 'test'].forEach(env => {
                const btn = document.getElementById(`envBtn-${env}`);
                if (btn) {
                    // Remove inline onclick to avoid double-firing
                    btn.removeAttribute('onclick');
                    
                    // Add both click and touchend for mobile compatibility
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Environment button clicked:', env);
                        switchEnvironment(env);
                    });
                    
                    // Make touch more responsive
                    btn.style.touchAction = 'manipulation';
                    btn.style.webkitTapHighlightColor = 'transparent';
                }
            });
        }
        
        // ==================== SUCCESS/INFO MODAL ====================
        // Nice styled popup instead of browser alert()
        function showSuccessModal(title, message, onClose) {
            const modalHtml = `
                <div id="successModalOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 99999;">
                    <div style="background: white; border-radius: 16px; padding: 30px; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: successModalPop 0.3s ease;">
                        <div style="font-size: 48px; margin-bottom: 15px;"></div>
                        <h2 style="margin: 0 0 15px 0; color: #6b9a8d; font-size: 22px;">${title}</h2>
                        <p style="margin: 0 0 25px 0; color: #555; font-size: 15px; line-height: 1.6; white-space: pre-line;">${message}</p>
                        <button onclick="closeSuccessModal()" style="padding: 12px 40px; background: #6b9a8d; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">OK</button>
                    </div>
                </div>
                <style>
                    @keyframes successModalPop {
                        0% { transform: scale(0.8); opacity: 0; }
                        100% { transform: scale(1); opacity: 1; }
                    }
                </style>
            `;
            
            // Store callback
            window.successModalCallback = onClose;
            
            // Add to page
            const container = document.createElement('div');
            container.id = 'successModalContainer';
            container.innerHTML = modalHtml;
            document.body.appendChild(container);
        }
        
        function closeSuccessModal() {
            const container = document.getElementById('successModalContainer');
            if (container) container.remove();
            if (window.successModalCallback) {
                window.successModalCallback();
                window.successModalCallback = null;
            }
        }
        
        // ==================== MOBILE HORIZONTAL SCROLL HELPER ====================
        // Improves horizontal scrolling on mobile by detecting swipe direction
        (function() {
            if (!('ontouchstart' in window)) return; // Desktop doesn't need this
            
            let startX, startY, scrollContainer, isHorizontalScroll = null;
            
            document.addEventListener('touchstart', function(e) {
                const target = e.target;
                // Find if we're inside a horizontal scroll container
                scrollContainer = target.closest('.table-scroll-wrapper, .horizontal-scroll, [style*="overflow-x"]');
                if (!scrollContainer) return;
                
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isHorizontalScroll = null; // Reset - we'll determine on first move
            }, { passive: true });
            
            document.addEventListener('touchmove', function(e) {
                if (!scrollContainer || !startX || !startY) return;
                
                const deltaX = Math.abs(e.touches[0].clientX - startX);
                const deltaY = Math.abs(e.touches[0].clientY - startY);
                
                // Determine scroll direction on first significant movement
                if (isHorizontalScroll === null && (deltaX > 10 || deltaY > 10)) {
                    isHorizontalScroll = deltaX > deltaY;
                }
                
                // If horizontal scroll detected and container can scroll horizontally
                if (isHorizontalScroll && scrollContainer.scrollWidth > scrollContainer.clientWidth) {
                    // Let the horizontal scroll happen naturally
                    // The CSS overscroll-behavior: contain prevents it from affecting the page
                }
            }, { passive: true });
            
            document.addEventListener('touchend', function() {
                scrollContainer = null;
                startX = null;
                startY = null;
                isHorizontalScroll = null;
            }, { passive: true });
        })();
        
        // Loading overlay functions
        function showLoading(message) {
            let overlay = document.getElementById('loadingOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 99998;';
                overlay.innerHTML = `<div style="background: white; padding: 30px 40px; border-radius: 12px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div style="font-size: 32px; margin-bottom: 10px;"></div>
                    <div id="loadingMessage" style="font-size: 16px; color: #333;">${message || 'Loading...'}</div>
                </div>`;
                document.body.appendChild(overlay);
            } else {
                document.getElementById('loadingMessage').textContent = message || 'Loading...';
                overlay.style.display = 'flex'; // Use flex, not block, to maintain centering
            }
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'none';
        }
        
        let cachedSuppliers = [];
        let cachedItems = [];
        let cachedCustomers = [];
        
        // Report data caching - reduces API calls significantly
        let cachedSalesOrders = [];
        let cachedSalesLines = [];  // ALL sales order line items
        let cachedPurchaseOrders = [];
        let cachedPurchaseLines = []; // ALL purchase order line items
        let reportDataCacheTime = 0;
        const REPORT_CACHE_DURATION = 60000; // 1 minute cache
        
        // Function to load all report data at once
        async function loadReportData(forceRefresh = false) {
            const now = Date.now();
            if (!forceRefresh && reportDataCacheTime && (now - reportDataCacheTime) < REPORT_CACHE_DURATION) {
                console.log(' Using cached report data');
                return true;
            }
            
            console.log(' Loading fresh report data...');
            const startTime = performance.now();
            
            try {
                // Load ALL data in parallel - much faster than sequential
                const [salesResult, customersResult, itemsResult, suppliersResult, purchasesResult, salesLinesResult, purchaseLinesResult] = await Promise.all([
                    apiCall('getSalesOrders'),
                    apiCall('getCustomers'),
                    apiCall('getItems'),
                    apiCall('getSuppliers'),
                    apiCall('getPurchaseOrders'),
                    apiCall('getAllSalesOrderLineItems'),
                    apiCall('getAllPurchaseOrderLineItems')
                ]);
                
                if (salesResult?.data) cachedSalesOrders = salesResult.data;
                if (customersResult?.data) cachedCustomers = customersResult.data;
                if (itemsResult?.data) cachedItems = itemsResult.data;
                if (suppliersResult?.data) cachedSuppliers = suppliersResult.data;
                if (purchasesResult?.data) cachedPurchaseOrders = purchasesResult.data;
                if (salesLinesResult?.data) cachedSalesLines = salesLinesResult.data;
                if (purchaseLinesResult?.data) cachedPurchaseLines = purchaseLinesResult.data;
                
                reportDataCacheTime = now;
                const elapsed = (performance.now() - startTime).toFixed(0);
                console.log(` Report data loaded in ${elapsed}ms (${cachedSalesOrders.length} sales, ${cachedPurchaseOrders.length} POs)`);
                return true;
            } catch (error) {
                console.error(' Error loading report data:', error);
                return false;
            }
        }
        
        // Helper to get sales lines for a specific order from cache
        function getSalesLinesFromCache(soId) {
            return cachedSalesLines.filter(line => line.SO_ID === soId);
        }
        
        // Helper to get purchase lines for a specific order from cache
        function getPurchaseLinesFromCache(poId) {
            return cachedPurchaseLines.filter(line => line.PO_ID === poId);
        }
        
        // Multi-select support for report filters
        let selectedCustomersForReport = [];
        let selectedSuppliersForReport = [];
        let selectedItemsForReport = [];
        let selectedInvoicesForSales = [];
        let selectedPOsForPurchases = [];
        let selectedItemsForInventory = [];
        let selectedItemsForPricing = [];
        let selectedSuppliersForPricing = [];
        
        // ==================== TOUCH-AWARE PICKER SELECTION ====================
        // Prevents accidental selections when scrolling through picker lists
        // A selection only fires if the finger didn't move more than the threshold
        
        const pickerTouchState = {
            startX: 0,
            startY: 0,
            moved: false,
            threshold: 10  // pixels - if finger moves more than this, it's a scroll not a tap
        };
        
        // Call this on touchstart for picker cards - null-safe
        function pickerTouchStart(e) {
            if (!e || !e.touches || !e.touches[0]) return;
            const touch = e.touches[0];
            pickerTouchState.startX = touch.clientX;
            pickerTouchState.startY = touch.clientY;
            pickerTouchState.moved = false;
        }
        
        // Call this on touchmove for picker cards - null-safe
        function pickerTouchMove(e) {
            if (pickerTouchState.moved) return;
            if (!e || !e.touches || !e.touches[0]) return;
            const touch = e.touches[0];
            const deltaX = Math.abs(touch.clientX - pickerTouchState.startX);
            const deltaY = Math.abs(touch.clientY - pickerTouchState.startY);
            if (deltaX > pickerTouchState.threshold || deltaY > pickerTouchState.threshold) {
                pickerTouchState.moved = true;
            }
        }
        
        // Call this on touchend - returns true if it was a clean tap (not a scroll)
        function pickerTouchEnd() {
            return !pickerTouchState.moved;
        }
        
        // Wrapper for picker card selection - only fires callback if it was a clean tap
        function handlePickerTap(callback, ...args) {
            if (pickerTouchEnd()) {
                callback(...args);
            }
        }
        
        // ==================== DATE PARSING HELPER ====================
        /**
         * Parse a YYYY-MM-DD date string as LOCAL time (not UTC)
         * This fixes timezone issues where new Date("2025-12-12") is parsed as UTC midnight
         * which then becomes the previous day in local time zones
         * @param {string} dateStr - Date string in YYYY-MM-DD format
         * @returns {Date} - Date object in local time
         */
        function parseLocalDate(dateStr) {
            if (!dateStr) return null;
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }
        
        /**
         * Format a Date object as YYYY-MM-DD in LOCAL time (not UTC)
         * @param {Date} d - Date object
         * @returns {string} - Date string in YYYY-MM-DD format
         */
        function formatLocalDate(d) {
            if (!d) return '';
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        /**
         * Format a number with commas (e.g., 1234567 -> "1,234,567")
         * @param {number} num - Number to format
         * @param {number} decimals - Optional decimal places (default 0)
         * @returns {string} - Formatted number string
         */
        function formatNum(num, decimals = 0) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return Number(num).toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }
        
        /**
         * Format a number as currency with $ and commas (e.g., 1234.56 -> "$1,234.56")
         * @param {number} num - Number to format
         * @returns {string} - Formatted currency string
         */
        function formatMoney(num) {
            if (num === null || num === undefined || isNaN(num)) return '$0.00';
            return '$' + Number(num).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        /**
         * Convert PO line item quantity to display format
         * Detects "eaches" purchases and converts to fractional cases
         * Uses stored Units_Per_Package if available, falls back to current item data
         * @param {object} line - The PO line item with Quantity, Unit_Cost, Item_ID, Units_Per_Package, Is_Eaches
         * @param {array} items - Cached items array
         * @returns {object} - { displayQty, displayCost, isEaches, tooltip }
         */
        function convertPOLineToDisplay(line, items) {
            const qty = parseFloat(line.Quantity) || 0;
            const unitCost = parseFloat(line.Unit_Cost) || 0;
            const item = (items || cachedItems || []).find(i => i.Item_ID === line.Item_ID);
            
            // Use stored values if available (from time of purchase), fall back to current item data
            const storedUnitsPerPkg = parseFloat(line.Units_Per_Package);
            const unitsPerPackage = !isNaN(storedUnitsPerPkg) && storedUnitsPerPkg > 0 
                ? storedUnitsPerPkg 
                : (parseFloat(item?.Units_Per_Package) || 1);
            
            // Check if Is_Eaches flag is stored, otherwise detect from cost comparison
            let isEaches = false;
            if (line.Is_Eaches !== undefined && line.Is_Eaches !== null && line.Is_Eaches !== '') {
                isEaches = line.Is_Eaches === true || line.Is_Eaches === 'true';
            } else {
                // Fall back to detection: unit cost < 50% of package cost means eaches
                const packageCost = parseFloat(item?.Package_Cost) || 0;
                isEaches = packageCost > 0 && unitCost < (packageCost * 0.5);
            }
            
            if (isEaches && unitsPerPackage > 1) {
                const fractionalCases = qty / unitsPerPackage;
                // Round to 4 decimal places to avoid floating point precision issues in sums
                const roundedFractional = Math.round(fractionalCases * 10000) / 10000;
                return {
                    displayQty: roundedFractional,
                    displayQtyFormatted: fractionalCases.toFixed(2),
                    displayCost: unitCost * unitsPerPackage, // Convert to per-case equivalent
                    isEaches: true,
                    tooltip: `${qty} of ${unitsPerPackage} units`,
                    originalQty: qty,
                    unitsPerPackage: unitsPerPackage
                };
            }
            
            return {
                displayQty: qty,
                displayQtyFormatted: qty.toString(),
                displayCost: unitCost,
                isEaches: false,
                tooltip: null,
                originalQty: qty,
                unitsPerPackage: unitsPerPackage
            };
        }
        
        // ==================== MULTI-SELECT FILTER HELPER ====================
        /**
         * Focus an element only on desktop (not touch devices)
         * Prevents keyboard from popping up on mobile when opening pickers
         */
        function focusOnDesktop(elementId) {
            if (!('ontouchstart' in window)) {
                setTimeout(() => {
                    const el = document.getElementById(elementId);
                    if (el) el.focus();
                }, 100);
            }
        }
        
        /**
         * Check if a value matches a filter that might contain comma-separated values
         * @param {string} value - The value to check (e.g., "C001")
         * @param {string} filter - The filter (might be "C001" or "C001,C002,C003")
         * @returns {boolean} - True if value matches filter
         */
        function matchesFilter(value, filter) {
            if (!filter || filter === '') return true;
            
            // Convert to string for consistent comparison
            const strValue = String(value);
            const strFilter = String(filter);
            
            // Check if filter contains multiple values (comma-separated)
            if (strFilter.includes(',')) {
                const allowedValues = strFilter.split(',').map(v => v.trim());
                return allowedValues.includes(strValue);
            }
            
            // Single value comparison
            return strValue === strFilter;
        }
        
        // ==================== BUTTON DEBOUNCE SYSTEM ====================
        // Prevents double-clicks/taps from submitting forms twice
        let buttonDebounceMap = new Map();
        
        // Get today's date in YYYY-MM-DD format using LOCAL time (not UTC)
        function getTodayLocalDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }
        
        function debounceButton(buttonElement, duration = 2000) {
            if (!buttonElement) return false;
            
            const buttonId = buttonElement.id || buttonElement.outerHTML.substring(0, 100);
            const now = Date.now();
            const lastClick = buttonDebounceMap.get(buttonId) || 0;
            
            if (now - lastClick < duration) {
                console.log(' Button debounced - click ignored');
                return false; // Too soon, ignore click
            }
            
            buttonDebounceMap.set(buttonId, now);
            
            // Visually disable button
            buttonElement.disabled = true;
            buttonElement.style.opacity = '0.6';
            buttonElement.style.cursor = 'not-allowed';
            
            // Re-enable after duration
            setTimeout(() => {
                buttonElement.disabled = false;
                buttonElement.style.opacity = '';
                buttonElement.style.cursor = '';
            }, duration);
            
            return true; // Allow click
        }
        
        // Helper functions to lookup names from IDs
        function getCustomerName(customerId) {
            if (!cachedCustomers || cachedCustomers.length === 0) return customerId;
            const customer = cachedCustomers.find(c => c.Customer_ID === customerId);
            return customer ? customer.Customer_Name : customerId;
        }
        
        function getCustomerLocation(customerId) {
            if (!cachedCustomers || cachedCustomers.length === 0) return '';
            const customer = cachedCustomers.find(c => c.Customer_ID === customerId);
            if (!customer) return '';
            const parts = [];
            if (customer.Address) parts.push(customer.Address);
            if (customer.City) parts.push(customer.City);
            return parts.join(', ');
        }
        
        function getSupplierName(supplierId) {
            if (!cachedSuppliers || cachedSuppliers.length === 0) return supplierId;
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            return supplier ? supplier.Supplier_Name : supplierId;
        }
        
        function getItemDescription(itemId) {
            const item = cachedItems.find(i => i.Item_ID === itemId);
            return item ? item.Item_Description : itemId;
        }
        
        // ==================== GLOBAL MODAL SAFETY ====================
        // Emergency function to close all modals and reset body state
        function globalModalReset() {
            console.log(' Global modal reset triggered');
            
            // Reset body state
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
            document.body.style.height = '';
            document.body.classList.remove('modal-open');
            
            // Close all known modals
            const modalIds = [
                'reportSetupModal', 'itemPickerModal', 'customerPickerModal', 
                'supplierPickerModal', 'invoicePickerModal', 'poPickerModal',
                'bulkPOModalContainer', 'confirmationModal', 'alertModal',
                'lineItemsModal', 'adjustmentModal', 'quickViewModal'
            ];
            
            modalIds.forEach(id => {
                const modal = document.getElementById(id);
                if (modal) {
                    modal.style.display = 'none';
                    modal.classList.remove('modal-open');
                }
            });
            
            // Remove any dynamically created modals
            document.querySelectorAll('[id*="Modal"]').forEach(el => {
                if (el.style.display !== 'none' && el.style.position === 'fixed') {
                    el.style.display = 'none';
                }
            });
            
            // Reset maximize state
            if (typeof reportModalMaximized !== 'undefined') {
                reportModalMaximized = false;
            }
        }
        
        // Expose globally for emergency use
        window.globalModalReset = globalModalReset;
        
        // Escape key handler to close modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Try to close the topmost modal
                const reportModal = document.getElementById('reportSetupModal');
                const itemPicker = document.getElementById('itemPickerModal');
                const customerPicker = document.getElementById('customerPickerModal');
                const supplierPicker = document.getElementById('supplierPickerModal');
                const invoicePicker = document.getElementById('invoicePickerModal');
                const poPicker = document.getElementById('poPickerModal');
                const bulkPOModal = document.getElementById('bulkPOModalContainer');
                
                // Close in order of priority (pickers first, then main modals)
                if (bulkPOModal && bulkPOModal.innerHTML) {
                    if (typeof closeBulkPOModal === 'function') closeBulkPOModal();
                    return;
                }
                if (itemPicker && itemPicker.classList.contains('modal-open')) {
                    if (typeof closeItemPicker === 'function') closeItemPicker();
                    return;
                }
                if (customerPicker && customerPicker.classList.contains('modal-open')) {
                    if (typeof closeCustomerPicker === 'function') closeCustomerPicker();
                    return;
                }
                if (supplierPicker && supplierPicker.classList.contains('modal-open')) {
                    if (typeof closeSupplierPicker === 'function') closeSupplierPicker();
                    return;
                }
                if (invoicePicker && invoicePicker.classList.contains('modal-open')) {
                    if (typeof closeInvoicePicker === 'function') closeInvoicePicker();
                    return;
                }
                if (poPicker && poPicker.classList.contains('modal-open')) {
                    if (typeof closePOPicker === 'function') closePOPicker();
                    return;
                }
                if (reportModal && reportModal.style.display !== 'none') {
                    if (typeof closeReportSetup === 'function') closeReportSetup();
                    return;
                }
            }
        });
        
        // Periodic safety check - detect stuck modal states
        setInterval(function() {
            // If body has overflow hidden but no modals are visible, reset
            if (document.body.style.overflow === 'hidden' || document.body.classList.contains('modal-open')) {
                const hasVisibleModal = document.querySelector('[id*="Modal"][style*="display: block"], [id*="Modal"][style*="display: flex"], [id*="Modal"].modal-open');
                const reportModal = document.getElementById('reportSetupModal');
                const reportModalVisible = reportModal && reportModal.style.display !== 'none' && reportModal.style.display !== '';
                
                if (!hasVisibleModal && !reportModalVisible) {
                    console.log(' Stuck modal state detected - auto-resetting');
                    document.body.style.overflow = '';
                    document.body.classList.remove('modal-open');
                }
            }
        }, 3000); // Check every 3 seconds

        window.addEventListener('DOMContentLoaded', () => {
            // SAFETY: Remove any stuck modal-open class and reset body styles
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
            document.body.style.height = '';
            
            // SAFETY: Ensure back button is hidden on load
            const backBtn = document.getElementById('backBtn');
            const backToTopBtn = document.getElementById('backToTopBtn');
            if (backBtn) backBtn.style.display = 'none';
            if (backToTopBtn) backToTopBtn.style.display = 'none';
            
            // MOBILE TOUCH DEBOUNCE - Prevent rapid multiple taps on selects
            let lastSelectTap = 0;
            const SELECT_DEBOUNCE_MS = 300; // Minimum ms between select taps
            
            document.addEventListener('touchstart', function(e) {
                if (e.target.tagName === 'SELECT' || e.target.closest('select')) {
                    const now = Date.now();
                    if (now - lastSelectTap < SELECT_DEBOUNCE_MS) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log(' Select tap debounced');
                        return false;
                    }
                    lastSelectTap = now;
                }
            }, { passive: false });
            
            // Apply gradient for current theme
            applyThemeGradient();
            
            // Initialize environment switcher
            initializeEnvironmentForm();
            
            updateConfigStatus();
            loadInvoiceSettings();
            const today = getTodayLocalDate();
            if (document.getElementById('poDate')) document.getElementById('poDate').value = today;
            if (document.getElementById('soDate')) document.getElementById('soDate').value = today;
            if (document.getElementById('soDueDate')) document.getElementById('soDueDate').value = today;
            if (document.getElementById('createPODate')) document.getElementById('createPODate').value = today;
            // Expected delivery date left blank - user must select
            
            // Restore report section visibility preferences
            restoreReportSections();
            
            // Restore settings section visibility preferences
            restoreSettingsSections();
            
            // AUTO-LOAD ALL DATA ON PAGE LOAD
            console.log(' Auto-loading all data from Google Sheets...');
            loadSuppliers();
            loadItems();
            loadCustomers();
            loadPurchases();
            loadSales();
            loadInventory();
            
            // Attach event listeners to the first Create PO line item
            const firstCreatePORow = document.querySelector('#createPOLineItems div.line-item-row');
            if (firstCreatePORow) {
                const itemSelect = firstCreatePORow.querySelector('.createpo-item');
                const qtyInput = firstCreatePORow.querySelector('.createpo-qty');
                
                if (itemSelect) {
                    itemSelect.addEventListener('change', function() {
                        updateCreatePOItemCost(this);
                    });
                }
                
                if (qtyInput) {
                    qtyInput.addEventListener('input', function() {
                        calculateCreatePOTotal();
                    });
                }
            }
            
            // Attach event listeners to the first hardcoded Sales Order line item
            const firstSORow = document.querySelector('#soLineItems .line-item-row');
            if (firstSORow) {
                console.log('Attaching listeners to first SO line item'); // DEBUG
                const itemSelect = firstSORow.querySelector('.so-item');
                const qtyInput = firstSORow.querySelector('.so-qty');
                const priceInput = firstSORow.querySelector('.so-price');
                const removeBtn = firstSORow.querySelector('.remove-btn');
                
                if (itemSelect) {
                    itemSelect.addEventListener('change', function() {
                        console.log('First row CHANGE EVENT FIRED!'); // DEBUG
                        updateSOItemInfo(this);
                    });
                }
                
                if (qtyInput) {
                    qtyInput.addEventListener('input', function() {
                        // Update stock info when quantity changes
                        const row = this.closest('.line-item-row');
                        const itemSelect = row.querySelector('.so-item');
                        if (itemSelect.value) {
                            updateSOItemInfo(itemSelect);
                        }
                        calculateSOTotal();
                    });
                }
                
                if (priceInput) {
                    priceInput.addEventListener('input', function() {
                        calculateSOTotal();
                    });
                }
                
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        removeLineItem(this);
                        calculateSOTotal();
                    });
                }
                console.log('First SO row listeners attached!'); // DEBUG
            }
            
            // Attach event listeners to the first hardcoded Purchase Order line item
            const firstPORow = document.querySelector('#poLineItems .line-item-row');
            if (firstPORow) {
                console.log('Attaching listeners to first PO line item'); // DEBUG
                const itemSelect = firstPORow.querySelector('.po-item');
                const qtyInput = firstPORow.querySelector('.po-qty');
                const costInput = firstPORow.querySelector('.po-cost');
                const removeBtn = firstPORow.querySelector('.remove-btn');
                
                if (itemSelect) {
                    itemSelect.addEventListener('change', function() {
                        console.log('First PO row CHANGE EVENT FIRED!'); // DEBUG
                        updatePOItemInfo(this);
                    });
                }
                
                if (qtyInput) {
                    qtyInput.addEventListener('input', function() {
                        calculatePOTotal();
                    });
                }
                
                if (costInput) {
                    costInput.addEventListener('input', function() {
                        calculatePOTotal();
                    });
                }
                
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        removeLineItem(this);
                        calculatePOTotal();
                    });
                }
                console.log('First PO row listeners attached!'); // DEBUG
            }
            
            // Minimal pull-to-refresh prevention (only at very top)
            let lastTouchY = 0;
            
            document.body.addEventListener('touchstart', function(e) {
                if (e.touches.length !== 1) return;
                lastTouchY = e.touches[0].clientY;
            }, { passive: true });
            
            document.body.addEventListener('touchmove', function(e) {
                const touchY = e.touches[0].clientY;
                const touchYDelta = touchY - lastTouchY;
                lastTouchY = touchY;
                
                // Only prevent if at absolute top AND pulling down
                if (window.pageYOffset === 0 && touchYDelta > 0) {
                    e.preventDefault();
                }
            }, { passive: false });
        });

        // Navigation history for back button
        let navigationHistory = ['reports'];
        
        // ========== CHART MANAGEMENT ==========
        // Global registry to track all chart instances
        const chartRegistry = {};
        
        // Safely create a chart, destroying any existing one on the same canvas
        function createSafeChart(canvasId, config) {
            // Destroy existing chart if it exists
            if (chartRegistry[canvasId]) {
                try {
                    chartRegistry[canvasId].destroy();
                } catch (e) {
                    console.log('Chart destroy error (non-critical):', e);
                }
                delete chartRegistry[canvasId];
            }
            
            // Also check Chart.js internal registry
            const existingChart = Chart.getChart(canvasId);
            if (existingChart) {
                try {
                    existingChart.destroy();
                } catch (e) {
                    console.log('Existing chart destroy error (non-critical):', e);
                }
            }
            
            // Get canvas element
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.warn('Canvas not found:', canvasId);
                return null;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.warn('Could not get canvas context:', canvasId);
                return null;
            }
            
            // Create new chart
            try {
                const chart = new Chart(ctx, config);
                chartRegistry[canvasId] = chart;
                return chart;
            } catch (e) {
                console.error('Error creating chart:', e);
                return null;
            }
        }
        
        // Destroy all charts (useful when switching reports)
        function destroyAllCharts() {
            // First destroy all charts in our registry
            Object.keys(chartRegistry).forEach(canvasId => {
                try {
                    if (chartRegistry[canvasId]) {
                        chartRegistry[canvasId].destroy();
                    }
                } catch (e) {
                    // Ignore errors during cleanup
                }
            });
            // Clear registry
            Object.keys(chartRegistry).forEach(key => delete chartRegistry[key]);
            
            // Also destroy any Chart.js instances that might not be in our registry
            // by finding all canvases and checking if they have charts
            document.querySelectorAll('canvas').forEach(canvas => {
                try {
                    const chart = Chart.getChart(canvas);
                    if (chart) {
                        chart.destroy();
                    }
                } catch (e) {
                    // Ignore errors
                }
            });
        }
        
        function switchTab(tabName) {
            // Remove active class from all navigation cards
            document.querySelectorAll('.landing-nav-card').forEach(card => {
                card.classList.remove('active-nav-card');
                // Reset styling
                card.style.transform = 'scale(1)';
                card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
            });
            
            // Find and highlight the clicked navigation card
            document.querySelectorAll('.landing-nav-card').forEach(card => {
                if (card.onclick && card.onclick.toString().includes(`'${tabName}'`)) {
                    card.classList.add('active-nav-card');
                    card.style.transform = 'scale(1.05)';
                    card.style.boxShadow = '0 4px 16px rgba(0,0,0,0.3)';
                }
            });
            
            // Hide all content sections and show the selected one
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            const targetCard = document.getElementById(tabName);
            if (targetCard) {
                targetCard.classList.add('active');
            }
            
            // Add to history (avoid duplicates of current tab)
            if (navigationHistory[navigationHistory.length - 1] !== tabName) {
                navigationHistory.push(tabName);
                // Keep only last 20 tabs in history
                if (navigationHistory.length > 20) {
                    navigationHistory.shift();
                }
            }
            
            // Show/hide Back button based on history length AND current tab
            const backBtn = document.getElementById('backBtn');
            const navBackBtn = document.getElementById('navBackBtn');
            const mobileNavBar = document.getElementById('mobileNavBar');
            
            // Hide on home tab, only show on other tabs when there's history
            const showBack = navigationHistory.length > 1 && tabName !== 'home';
            
            if (backBtn) backBtn.style.display = showBack ? 'block' : 'none';
            if (navBackBtn) navBackBtn.style.display = showBack ? 'block' : 'none';
            
            // Update mobile nav bar visibility
            updateMobileNavBar();
            
            // Check if we need to restore PO form when switching to purchases
            if (tabName === 'purchases') {
                checkAndRestorePOForm();
            }
            
            // Load price sim items when switching to that tab
            if (tabName === 'pricesim') {
                loadPriceSimItems();
            }
            
            // Load expenses data when switching to expenses tab
            if (tabName === 'expenses') {
                loadExpenses();
            }
            
            // Refresh Inventory Flow Dashboard when switching to that tab
            if (tabName === 'invflow') {
                refreshInventoryFlowWithTimeout();
            }
            
            // Clear Create PO form when switching to that tab (fresh start)
            // But only if not coming from a pre-fill action
            if (tabName === 'createpo' && !window.skipCreatePOClear) {
                if (typeof clearCreatePOForm === 'function') {
                    clearCreatePOForm();
                }
            }
            window.skipCreatePOClear = false; // Reset flag
            
            // Scroll to top when switching tabs
            window.scrollTo(0, 0);
        }
        
        function goBack() {
            // Remove current tab from history
            if (navigationHistory.length > 1) {
                navigationHistory.pop();
                const previousTab = navigationHistory[navigationHistory.length - 1];
                
                // Switch to previous tab
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                
                document.getElementById(previousTab).classList.add('active');
                
                // Highlight the correct tab button
                const tabButtons = document.querySelectorAll('.tabs .tab');
                tabButtons.forEach(btn => {
                    if (btn.textContent.toLowerCase().includes(previousTab.substring(0, 4))) {
                        btn.classList.add('active');
                    }
                });
                
                window.scrollTo(0, 0);
                
                // Check if we need to restore PO form state
                checkAndRestorePOForm();
            }
            
            // Hide Back button if only one tab in history
            const backBtn = document.getElementById('backBtn');
            const navBackBtn = document.getElementById('navBackBtn');
            
            if (navigationHistory.length <= 1) {
                if (backBtn) backBtn.style.display = 'none';
                if (navBackBtn) navBackBtn.style.display = 'none';
                updateMobileNavBar();
            }
        }
        
        // Update mobile nav bar visibility
        function updateMobileNavBar() {
            const mobileNavBar = document.getElementById('mobileNavBar');
            const navBackBtn = document.getElementById('navBackBtn');
            const navTopBtn = document.getElementById('navTopBtn');
            
            if (!mobileNavBar) return;
            
            const backVisible = navBackBtn && navBackBtn.style.display !== 'none';
            const topVisible = navTopBtn && navTopBtn.style.display !== 'none';
            
            // Only show bar on mobile (CSS handles actual display)
            if (backVisible || topVisible) {
                mobileNavBar.classList.add('has-buttons');
            } else {
                mobileNavBar.classList.remove('has-buttons');
            }
        }
        
        // ==================== HELP/GUIDES NAVIGATION ====================
        /**
         * Scroll to a specific guide section in the Help tab
         */
        function scrollToGuideSection(sectionId) {
            // First, make sure we're on the guides tab
            switchTab('guides');
            
            // Hide all guide content sections
            document.querySelectorAll('.guide-content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show the requested section
            const targetSection = document.getElementById('guide-' + sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';
                
                // Smooth scroll to the guide content container
                setTimeout(() => {
                    const container = document.getElementById('guide-content-container');
                    if (container) {
                        container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
        }
        
        function checkAndRestorePOForm() {
            const savedState = localStorage.getItem('poFormState');
            if (savedState) {
                const state = JSON.parse(savedState);
                if (state.returnToPO) {
                    // Show a notification
                    const currentTab = document.querySelector('.card.active');
                    if (currentTab && currentTab.id === 'purchases') {
                        setTimeout(async () => {
                            const confirmed = await showConfirmModal(
                                ' Resume Purchase Order',
                                'You have an unfinished purchase order. Would you like to resume?',
                                'Resume',
                                'Discard'
                            );
                            if (confirmed) {
                                showAddPurchaseForm();
                                
                                // Restore form fields
                                setTimeout(() => {
                                    if (state.supplier) document.getElementById('poSupplier').value = state.supplier;
                                    if (state.purchaseDate) document.getElementById('poPurchaseDate').value = state.purchaseDate;
                                    if (state.dueDate) document.getElementById('poDueDate').value = state.dueDate;
                                    if (state.paymentTerms) document.getElementById('poPaymentTerms').value = state.paymentTerms;
                                    if (state.status) document.getElementById('poStatus').value = state.status;
                                    if (state.amountPaid) document.getElementById('poAmountPaid').value = state.amountPaid;
                                    if (state.notes) document.getElementById('poNotes').value = state.notes;
                                    
                                    // Reload supplier items
                                    if (state.supplier) {
                                        loadSupplierItems();
                                    }
                                    
                                    showStatus('purchaseStatus', ' Purchase order form restored! The new item should now be available in the dropdown.', 'success');
                                }, 200);
                            }
                            
                            // Clear saved state
                            localStorage.removeItem('poFormState');
                        }, 500);
                    }
                }
            }
        }
        
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // Toggle collapsible sections (Quick Guides, Entry Forms)
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId + '-toggle');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                if (toggle) toggle.textContent = ' Hide';
            } else {
                section.style.display = 'none';
                if (toggle) toggle.textContent = ' Show';
            }
        }
        
        // Toggle report category sections with localStorage persistence
        function toggleReportSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId + '-toggle');
            const category = section.parentElement;
            
            if (section.classList.contains('collapsed')) {
                // Show
                section.classList.remove('collapsed');
                category.classList.remove('collapsed');
                if (toggle) toggle.textContent = '';
                localStorage.setItem('report_' + sectionId, 'visible');
            } else {
                // Hide
                section.classList.add('collapsed');
                category.classList.add('collapsed');
                if (toggle) toggle.textContent = '';
                localStorage.setItem('report_' + sectionId, 'hidden');
            }
        }
        
        // Restore report section visibility on page load
        function restoreReportSections() {
            const sections = ['salesReports', 'purchaseReports', 'inventoryReports', 'financialReports'];
            sections.forEach(sectionId => {
                const state = localStorage.getItem('report_' + sectionId);
                if (state === 'hidden') {
                    const section = document.getElementById(sectionId);
                    const toggle = document.getElementById(sectionId + '-toggle');
                    const category = section?.parentElement;
                    if (section) {
                        section.classList.add('collapsed');
                        if (category) category.classList.add('collapsed');
                        if (toggle) toggle.textContent = '';
                    }
                }
            });
        }
        
        // Toggle settings page sections with localStorage persistence
        function toggleSettingsSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId + '-toggle');
            
            if (section.style.display === 'none') {
                // Show
                section.style.display = 'block';
                if (toggle) toggle.textContent = ' Hide';
                localStorage.setItem('settings_' + sectionId, 'visible');
            } else {
                // Hide
                section.style.display = 'none';
                if (toggle) toggle.textContent = ' Show';
                localStorage.setItem('settings_' + sectionId, 'hidden');
            }
        }
        
        // Toggle URL Configuration section
        function toggleUrlConfig() {
            const section = document.getElementById('urlConfigSection');
            const toggle = document.getElementById('urlConfigToggle');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                toggle.textContent = ' Hide URLs';
            } else {
                section.style.display = 'none';
                toggle.textContent = ' Show URLs';
            }
        }
        
        // Restore settings section visibility on page load
        function restoreSettingsSections() {
            const sections = ['themeSection', 'backupSection', 'invoiceSection', 'statusSection', 'apiSection'];
            sections.forEach(sectionId => {
                const state = localStorage.getItem('settings_' + sectionId);
                const section = document.getElementById(sectionId);
                const toggle = document.getElementById(sectionId + '-toggle');
                
                if (sectionId === 'apiSection') {
                    // API section hidden by default unless explicitly shown
                    if (state === 'visible') {
                        if (section) section.style.display = 'block';
                        if (toggle) toggle.textContent = ' Hide';
                    }
                } else {
                    // Other sections shown by default unless explicitly hidden
                    if (state === 'hidden') {
                        if (section) section.style.display = 'none';
                        if (toggle) toggle.textContent = ' Show';
                    }
                }
            });
        }
        
        // Show/hide back to top button based on scroll position
        window.addEventListener('scroll', function() {
            const backToTopBtn = document.getElementById('backToTopBtn');
            const navTopBtn = document.getElementById('navTopBtn');
            const mobileNavBar = document.getElementById('mobileNavBar');
            const navBackBtn = document.getElementById('navBackBtn');
            
            const showTop = window.pageYOffset > 300;
            
            // Desktop button
            if (backToTopBtn) {
                backToTopBtn.style.display = showTop ? 'block' : 'none';
            }
            
            // Mobile nav bar - show if either button should be visible
            if (mobileNavBar && navTopBtn) {
                navTopBtn.style.display = showTop ? 'block' : 'none';
                
                // Check if Back button is visible
                const backVisible = navBackBtn && navBackBtn.style.display !== 'none';
                
                // Show nav bar if any button is visible
                if (showTop || backVisible) {
                    mobileNavBar.style.display = 'block';
                } else {
                    mobileNavBar.style.display = 'none';
                }
            }
        });
        
        function goToAddItem() {
            // Switch to Items tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent.includes('Items')) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            document.getElementById('items').classList.add('active');
            
            // Open the Add Item form
            showAddItemForm();
            
            // Scroll to top of page
            window.scrollTo(0, 0);
        }
        
        function addNewItemFromPO() {
            // Get current supplier from PO form
            const currentSupplier = document.getElementById('poSupplier')?.value;
            
            if (!currentSupplier) {
                showWarning('Please select a supplier first before adding items');
                return;
            }
            
            // Set the supplier in the quick add form
            document.getElementById('quickItemSupplier').value = currentSupplier;
            
            // Clear the form
            document.getElementById('quickAddItemForm').reset();
            document.getElementById('quickItemSupplier').value = currentSupplier;
            document.getElementById('quickItemUnits').value = '24';
            document.getElementById('quickItemUOM').value = 'Case';
            document.getElementById('quickItemReorder').value = '50';
            document.getElementById('quickItemQty').value = '0';
            
            // CRITICAL: Disable ALL select elements on the page to prevent iOS touch issues
            document.querySelectorAll('select').forEach(sel => {
                sel.dataset.wasDisabled = sel.disabled ? 'true' : 'false';
                sel.disabled = true;
                sel.style.pointerEvents = 'none';
            });
            
            // Show the modal using class (not inline style)
            const modal = document.getElementById('quickAddItemModal');
            modal.classList.add('quick-add-open');
            document.body.style.overflow = 'hidden';
            
            // Focus on SKU field
            setTimeout(() => {
                document.getElementById('quickItemSKU').focus();
            }, 100);
        }
        
        function closeQuickAddItem() {
            const modal = document.getElementById('quickAddItemModal');
            modal.classList.remove('quick-add-open');
            document.body.style.overflow = '';
            
            // Re-enable selects that weren't originally disabled
            document.querySelectorAll('select').forEach(sel => {
                if (sel.dataset.wasDisabled !== 'true') {
                    sel.disabled = false;
                    sel.style.pointerEvents = '';
                }
            });
        }
        
        async function saveQuickAddItem(e) {
            e.preventDefault();
            
            const supplierId = document.getElementById('quickItemSupplier').value;
            const sku = document.getElementById('quickItemSKU').value.trim();
            const description = document.getElementById('quickItemDescription').value.trim();
            const packageCost = parseFloat(document.getElementById('quickItemCost').value) || 0;
            const sellPrice = parseFloat(document.getElementById('quickItemPrice').value) || 0;
            const unitsPerPackage = parseInt(document.getElementById('quickItemUnits').value) || 24;
            const purchaseUOM = document.getElementById('quickItemUOM').value.trim() || 'Case';
            const reorderPoint = parseInt(document.getElementById('quickItemReorder').value) || 50;
            const startingQty = parseInt(document.getElementById('quickItemQty').value) || 0;
            
            // Validate
            if (!sku || !description) {
                showWarning('Please enter SKU and Description');
                return;
            }
            
            if (packageCost <= 0 || sellPrice <= 0) {
                showWarning('Please enter valid Cost and Price');
                return;
            }
            
            // Create item data - match the field names expected by addItem API
            const itemData = {
                sku: sku,
                description: description,
                supplierId: supplierId,
                packageCost: packageCost,
                unitSellPrice: sellPrice,
                unitsPerPackage: unitsPerPackage,
                purchaseUOM: purchaseUOM,
                reorderPoint: reorderPoint,
                qtyOnHand: startingQty,
                notes: ''
            };
            
            showLoading('Adding Item...');
            try {
                // Save to backend
                const result = await apiCall('addItem', itemData);
                
                if (result && result.status === 'success') {
                    // Force refresh items cache
                    const itemsResult = await apiCall('getItems');
                    if (itemsResult && itemsResult.status === 'success') {
                        cachedItems = itemsResult.data;
                    }
                    
                    // Reload the PO form item dropdowns with fresh data
                    const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId && item.Status !== 'Archived');
                    document.querySelectorAll('#poLineItems .po-item').forEach(select => {
                        const currentValue = select.value; // Preserve current selection
                        select.innerHTML = '<option value="">Select item...</option>';
                        supplierItems.forEach(item => {
                            const cost = parseFloat(item.Package_Cost) || 0;
                            const units = parseInt(item.Units_Per_Package) || 1;
                            select.innerHTML += `<option value="${item.Item_ID}" data-cost="${cost}" data-units="${units}">${item.Item_Description}</option>`;
                        });
                        if (currentValue) select.value = currentValue; // Restore selection
                    });
                    
                    // Close modal
                    closeQuickAddItem();
                    
                    // Show success
                    showSuccessModal('Item Added!', `"${description}" has been added to the catalog and is now available in your item list.`);
                } else {
                    showWarning('Error adding item: ' + (result?.message || 'Unknown error'));
                }
            } finally {
                hideLoading();
            }
        }

        function updateConfigStatus() {
            const statusEl = document.getElementById('configStatusText');
            const apiInput = document.getElementById('apiUrl');
            
            const envNames = { production: ' Production', training: ' Training', test: ' Development' };
            const envColors = { production: '#059669', training: '#0284c7', test: '#b88a8a' };
            
            if (API_URL) {
                if (apiInput) apiInput.value = API_URL;
                statusEl.innerHTML = ` Connected to <strong>${envNames[currentEnvironment]}</strong>`;
                statusEl.style.color = envColors[currentEnvironment];
            } else {
                statusEl.innerHTML = ' Not configured - enter API URL in settings';
                statusEl.style.color = '#f57c00';
            }
        }

        
        // Apply gradient for current theme (called on page load)
        function applyThemeGradient() {
            const themeColors = getThemeColors();
            const gradient = `linear-gradient(135deg, ${themeColors.primary} 0%, ${themeColors.accent} 100%)`;
            document.documentElement.style.setProperty('--theme-gradient', gradient);
            document.body.style.background = gradient;
            
            //  NEW: Also set the card background color
            const cardBg = generateLightBackground(themeColors.accent);
            document.documentElement.style.setProperty('--card-bg', cardBg);
        }
        
        function changeTheme() {
            const theme = document.getElementById('themeSelector').value;
            const body = document.body;
            
            // Remove all existing theme classes (ALL themes)
            body.classList.remove(
                // Classic themes
                'theme-purple', 'theme-ocean', 'theme-forest', 'theme-sunset', 'theme-dark', 'theme-crimson', 'theme-slate', 'theme-teal',
                // NFL Teams
                'theme-bills', 'theme-dolphins', 'theme-patriots', 'theme-jets',
                'theme-ravens', 'theme-bengals', 'theme-browns', 'theme-steelers',
                'theme-texans', 'theme-colts', 'theme-jaguars', 'theme-titans',
                'theme-broncos', 'theme-chiefs', 'theme-raiders', 'theme-chargers',
                'theme-cowboys', 'theme-giants', 'theme-eagles', 'theme-commanders',
                'theme-bears', 'theme-lions', 'theme-packers', 'theme-vikings',
                'theme-falcons', 'theme-panthers', 'theme-saints', 'theme-bucs',
                'theme-azcardinals', 'theme-rams', 'theme-niners', 'theme-seahawks',
                // MLB Teams
                'theme-orioles', 'theme-redsox', 'theme-yankees', 'theme-rays', 'theme-bluejays',
                'theme-whitesox', 'theme-guardians', 'theme-tigers', 'theme-royals', 'theme-twins',
                'theme-astros', 'theme-angels', 'theme-athletics', 'theme-mariners', 'theme-rangers',
                'theme-braves', 'theme-marlins', 'theme-mets', 'theme-phillies', 'theme-nationals',
                'theme-cubs', 'theme-reds', 'theme-brewers', 'theme-pirates', 'theme-stlcardinals',
                'theme-dbacks', 'theme-rockies', 'theme-dodgers', 'theme-padres', 'theme-sfgiants',
                // Chicago extras
                'theme-bulls', 'theme-blackhawks',
                // NHL Teams
                'theme-ducks', 'theme-coyotes', 'theme-bruins', 'theme-sabres', 'theme-flames',
                'theme-hurricanes', 'theme-avalanche', 'theme-bluejackets', 'theme-stars', 'theme-redwings',
                'theme-oilers', 'theme-flapanthers', 'theme-kings', 'theme-wild', 'theme-canadiens',
                'theme-predators', 'theme-devils', 'theme-islanders', 'theme-nhlrangers', 'theme-senators',
                'theme-flyers', 'theme-penguins', 'theme-sharks', 'theme-kraken', 'theme-stlblues',
                'theme-lightning', 'theme-mapleleafs', 'theme-canucks', 'theme-goldenknights',
                'theme-capitals', 'theme-nhljets',
                // NBA Teams
                'theme-hawks', 'theme-celtics', 'theme-nets', 'theme-hornets', 'theme-cavs',
                'theme-mavs', 'theme-nuggets', 'theme-pistons', 'theme-warriors', 'theme-rockets',
                'theme-pacers', 'theme-clippers', 'theme-lakers', 'theme-grizzlies', 'theme-heat',
                'theme-bucks', 'theme-twolves', 'theme-pelicans', 'theme-knicks', 'theme-thunder',
                'theme-magic', 'theme-sixers', 'theme-suns', 'theme-blazers', 'theme-nbakings',
                'theme-spurs', 'theme-raptors', 'theme-jazz', 'theme-wizards',
                // College Teams
                'theme-alabama', 'theme-arkansas', 'theme-auburn', 'theme-clemson', 'theme-florida',
                'theme-fsu', 'theme-georgia', 'theme-lsu', 'theme-michigan', 'theme-michiganst',
                'theme-ohiostate', 'theme-oklahoma', 'theme-okstate', 'theme-oregon', 'theme-oregonst',
                'theme-pennstate', 'theme-tennessee', 'theme-texas', 'theme-texasam', 'theme-usc',
                'theme-ucla', 'theme-notredame', 'theme-wisconsin', 'theme-nebraska', 'theme-miami', 'theme-byu',
                // Fast Food
                'theme-mcdonalds', 'theme-burgerking', 'theme-wendys', 'theme-tacobell', 'theme-kfc',
                'theme-subway', 'theme-pizzahut', 'theme-chickfila', 'theme-dunkin', 'theme-dominos',
                'theme-sonic', 'theme-arbys', 'theme-dairyqueen', 'theme-jackinthebox', 'theme-popeyes',
                'theme-chipotle', 'theme-fiveguys', 'theme-innout', 'theme-culvers', 'theme-timhortons',
                // Wisconsin Local
                'theme-kwiktrip', 'theme-rutters', 'theme-cenex', 'theme-cenexcoop', 'theme-fleetfarm',
                'theme-woodmans', 'theme-picknsave', 'theme-sentry', 'theme-festival', 'theme-pigglywiggly',
                'theme-holiday', 'theme-bp', 'theme-caseys', 'theme-shell', 'theme-mobil',
                // Retro Gaming
                'theme-nes', 'theme-snes', 'theme-genesis', 'theme-gameboy', 'theme-n64',
                'theme-ps1', 'theme-windows95', 'theme-windowsxp', 'theme-macos9', 'theme-amiga', 'theme-c64',
                // Cars
                'theme-camaro', 'theme-challenger', 'theme-bullitt', 'theme-supra', 'theme-skyline', 'theme-typer',
                // Sneakers
                'theme-jordan1', 'theme-yeezy', 'theme-pigeon', 'theme-wotherspoon',
                // National Parks
                'theme-yellowstone', 'theme-grandcanyon', 'theme-yosemite',
                // Lo-Fi / Vaporwave / Synthwave
                'theme-lofi', 'theme-chillhop', 'theme-vaporwave', 'theme-mallsoft', 'theme-miamivice', 'theme-outrun',
                // Airlines
                'theme-panam', 'theme-braniff', 'theme-southwest', 'theme-pokemon',
                // NFL Throwbacks
                'theme-bucscreamsicle', 'theme-steelersbee', 'theme-oilersthrow', 'theme-patpatriot',
                'theme-chargerspowder', 'theme-orangecrush', 'theme-kellygreen', 'theme-niners94',
                'theme-rams99', 'theme-seahawkslime', 'theme-falcons66', 'theme-jets98',
                'theme-bears36', 'theme-acme', 'theme-cards47',
                // NFL Alternates
                'theme-billsred', 'theme-chiefsred', 'theme-raidersblack', 'theme-whitetiger',
                'theme-brownsrush', 'theme-eaglesblack', 'theme-titansoilers', 'theme-actiongreen',
                'theme-jagsteal', 'theme-purplepeople',
                // Superheroes
                'theme-reaper', 'theme-spiderman', 'theme-symbiote', 'theme-batman', 'theme-superman',
                'theme-wonderwoman', 'theme-ironman', 'theme-captainamerica', 'theme-hulk', 'theme-thor',
                'theme-harleyquinn', 'theme-starlord', 'theme-groot', 'theme-marvelrivals',
                'theme-flash', 'theme-greenlantern',
                // Cyberpunk
                'theme-nightcity', 'theme-arasaka', 'theme-militech', 'theme-moxes', 'theme-valentinos',
                'theme-vjacket', 'theme-silverhand', 'theme-cyberpunkui', 'theme-phantomliberty', 'theme-cyberpunklogo',
                // Retro Search Engines
                'theme-yahoo1996', 'theme-yahoo2000s', 'theme-aol1995', 'theme-aol2000s', 'theme-excite1997',
                'theme-lycos', 'theme-altavista', 'theme-askjeeves', 'theme-webcrawler', 'theme-infoseek',
                'theme-msn1998', 'theme-netscape', 'theme-dogpile', 'theme-geocities',
                // MAME Arcade
                'theme-mamepacman', 'theme-mamemspacman', 'theme-mamedonkeykong', 'theme-mamespaceinvaders',
                'theme-mamegalaga', 'theme-mamefrogger', 'theme-mamestreetfighter', 'theme-mamemortalkombat',
                'theme-mamedefender', 'theme-mamecentipede', 'theme-mamedigdug', 'theme-mameqbert',
                'theme-mametempest', 'theme-mameasteroids', 'theme-mamebubble', 'theme-mamegauntlet',
                'theme-mamerampage', 'theme-mamerobotron', 'theme-mamejoust', 'theme-mametron',
                'theme-mamenbajam', 'theme-mamecontra', 'theme-mamemetalslug', 'theme-mametmnt',
                'theme-mamedoubledragon', 'theme-mamefinalfight', 'theme-mamegradius', 'theme-mamegoldenaxe',
                'theme-mamestrider', 'theme-mamertype',
                // Monster Energy
                'theme-monstergreen', 'theme-monsterblack', 'theme-monstersunrise', 'theme-monsterparadise',
                'theme-monsterviolet', 'theme-monsterpipeline', 'theme-monsterrehab', 'theme-monsterred',
                // Mountain Dew
                'theme-mtndewgreen', 'theme-mtndewcodered', 'theme-mtndewvoltage', 'theme-mtndewbaja',
                'theme-mtndewlivewire', 'theme-mtndewwhiteout',
                // Root Beer & Soda
                'theme-awrootbeer', 'theme-barqs', 'theme-mugcream', 'theme-ibccherry',
                'theme-cocacola', 'theme-drpepper', 'theme-pepsi', 'theme-sprite', 'theme-fanta',
                // Energy Drinks
                'theme-redbull', 'theme-rockstar', 'theme-nos', 'theme-bang', 'theme-c4energy',
                'theme-alaninu', 'theme-ghostenergy', 'theme-celsius', 'theme-prime', 'theme-reign', 'theme-gamerfuel'
            );
            
            // Add new theme class
            body.classList.add('theme-' + theme);
            
            // Save preference FIRST (so getThemeColors reads the correct theme)
            localStorage.setItem('theme', theme);
            
            // Set --primary CSS variable based on theme
            const themeColors = getThemeColors();
            document.documentElement.style.setProperty('--primary', themeColors.primary);
            document.documentElement.style.setProperty('--secondary', themeColors.accent);
            document.documentElement.style.setProperty('--primary-light', hexToRgbaLight(themeColors.primary));
            
            //  NEW: Generate light background color for cards and navigation
            const cardBg = generateLightBackground(themeColors.accent);
            document.documentElement.style.setProperty('--card-bg', cardBg);
            
            //  NEW: Apply dynamic gradient to ALL themes
            const gradient = `linear-gradient(135deg, ${themeColors.primary} 0%, ${themeColors.accent} 100%)`;
            document.documentElement.style.setProperty('--theme-gradient', gradient);
            
            // Apply gradient to body background
            document.body.style.background = gradient;
            
            showStatus('configStatus', ` Theme changed to ${theme}!`, 'success');
        }
        
        // NEW: Generate a light pastel background color from hex
        function generateLightBackground(hexColor) {
            // Convert hex to RGB
            const r = parseInt(hexColor.slice(1, 3), 16);
            const g = parseInt(hexColor.slice(3, 5), 16);
            const b = parseInt(hexColor.slice(5, 7), 16);
            
            // Create a very light tint (mix with white at ~92%)
            const lightR = Math.round(r * 0.08 + 255 * 0.92);
            const lightG = Math.round(g * 0.08 + 255 * 0.92);
            const lightB = Math.round(b * 0.08 + 255 * 0.92);
            
            return `rgb(${lightR}, ${lightG}, ${lightB})`;
        }
        
        // Convert hex to light background color
        function hexToRgbaLight(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, 0.1)`;
        }
        
        // Get theme colors for print templates
        function getThemeColors() {
            const theme = localStorage.getItem('theme') || 'purple';
            const themes = {
                // Classic themes
                purple: { primary: '#667eea', accent: '#764ba2', text: '#667eea' },
                ocean: { primary: '#0077b6', accent: '#00b4d8', text: '#0077b6' },
                forest: { primary: '#2d6a4f', accent: '#40916c', text: '#2d6a4f' },
                sunset: { primary: '#e85d04', accent: '#f48c06', text: '#e85d04' },
                dark: { primary: '#1e293b', accent: '#334155', text: '#1e293b' },
                crimson: { primary: '#be123c', accent: '#e11d48', text: '#be123c' },
                slate: { primary: '#475569', accent: '#64748b', text: '#475569' },
                teal: { primary: '#6b9a8d', accent: '#14b8a6', text: '#6b9a8d' },
                // NFL AFC East
                bills: { primary: '#00338D', accent: '#C60C30', text: '#C60C30' },
                dolphins: { primary: '#008E97', accent: '#FC4C02', text: '#FC4C02' },
                patriots: { primary: '#002244', accent: '#C60C30', text: '#C60C30' },
                jets: { primary: '#125740', accent: '#000000', text: '#FFFFFF' },
                // NFL AFC North
                ravens: { primary: '#241773', accent: '#9E7C0C', text: '#9E7C0C' },
                bengals: { primary: '#FB4F14', accent: '#000000', text: '#FFFFFF' },
                browns: { primary: '#311D00', accent: '#FF3C00', text: '#FF3C00' },
                steelers: { primary: '#FFB612', accent: '#000000', text: '#000000' },
                // NFL AFC South
                texans: { primary: '#03202F', accent: '#A71930', text: '#A71930' },
                colts: { primary: '#002C5F', accent: '#A2AAAD', text: '#FFFFFF' },
                jaguars: { primary: '#006778', accent: '#D7A22A', text: '#D7A22A' },
                titans: { primary: '#0C2340', accent: '#4B92DB', text: '#4B92DB' },
                // NFL AFC West
                broncos: { primary: '#FB4F14', accent: '#002244', text: '#002244' },
                chiefs: { primary: '#E31937', accent: '#FFB612', text: '#FFB612' },
                raiders: { primary: '#000000', accent: '#A5ACAF', text: '#A5ACAF' },
                chargers: { primary: '#0080C6', accent: '#FFC20E', text: '#FFC20E' },
                // NFL NFC East
                cowboys: { primary: '#003594', accent: '#869397', text: '#FFFFFF' },
                giants: { primary: '#0B2265', accent: '#A71930', text: '#A71930' },
                eagles: { primary: '#004C54', accent: '#A5ACAF', text: '#A5ACAF' },
                commanders: { primary: '#5A1414', accent: '#FFB612', text: '#FFB612' },
                // NFL NFC North
                bears: { primary: '#0B162A', accent: '#C83803', text: '#C83803' },
                lions: { primary: '#0076B6', accent: '#B0B7BC', text: '#FFFFFF' },
                packers: { primary: '#203731', accent: '#FFB612', text: '#FFB612' },
                vikings: { primary: '#4F2683', accent: '#FFC62F', text: '#FFC62F' },
                // NFL NFC South
                falcons: { primary: '#A71930', accent: '#000000', text: '#FFFFFF' },
                panthers: { primary: '#0085CA', accent: '#BFC0BF', text: '#FFFFFF' },
                saints: { primary: '#D3BC8D', accent: '#101820', text: '#101820' },
                bucs: { primary: '#D50A0A', accent: '#34302B', text: '#FFFFFF' },
                // NFL NFC West
                azcardinals: { primary: '#97233F', accent: '#000000', text: '#FFFFFF' },
                rams: { primary: '#003594', accent: '#FFA300', text: '#FFA300' },
                niners: { primary: '#AA0000', accent: '#B3995D', text: '#B3995D' },
                seahawks: { primary: '#002244', accent: '#69BE28', text: '#69BE28' },
                // MLB AL East
                orioles: { primary: '#DF4601', accent: '#000000', text: '#FFFFFF' },
                redsox: { primary: '#BD3039', accent: '#0C2340', text: '#0C2340' },
                yankees: { primary: '#0C2340', accent: '#C4CED4', text: '#FFFFFF' },
                rays: { primary: '#092C5C', accent: '#8FBCE6', text: '#F5D130' },
                bluejays: { primary: '#134A8E', accent: '#E8291C', text: '#E8291C' },
                // MLB AL Central
                whitesox: { primary: '#000000', accent: '#C4CED4', text: '#C4CED4' },
                guardians: { primary: '#E31937', accent: '#003087', text: '#003087' },
                tigers: { primary: '#0C2340', accent: '#FA4616', text: '#FA4616' },
                royals: { primary: '#004687', accent: '#BD9B60', text: '#BD9B60' },
                twins: { primary: '#002B5C', accent: '#D31145', text: '#D31145' },
                // MLB AL West
                astros: { primary: '#002D62', accent: '#EB6E1F', text: '#EB6E1F' },
                angels: { primary: '#BA0021', accent: '#003263', text: '#FFFFFF' },
                athletics: { primary: '#003831', accent: '#EFB21E', text: '#EFB21E' },
                mariners: { primary: '#0C2C56', accent: '#005C5C', text: '#00A3E0' },
                rangers: { primary: '#003278', accent: '#C0111F', text: '#C0111F' },
                // MLB NL East
                braves: { primary: '#CE1141', accent: '#13274F', text: '#13274F' },
                marlins: { primary: '#00A3E0', accent: '#FF6600', text: '#FF6600' },
                mets: { primary: '#002D72', accent: '#FF5910', text: '#FF5910' },
                phillies: { primary: '#E81838', accent: '#002D72', text: '#002D72' },
                nationals: { primary: '#AB0003', accent: '#14225A', text: '#14225A' },
                // MLB NL Central
                cubs: { primary: '#0E3386', accent: '#CC3433', text: '#CC3433' },
                reds: { primary: '#C6011F', accent: '#000000', text: '#FFFFFF' },
                brewers: { primary: '#12284B', accent: '#FFB81C', text: '#FFB81C' },
                pirates: { primary: '#FDB827', accent: '#000000', text: '#000000' },
                stlcardinals: { primary: '#C41E3A', accent: '#0C2340', text: '#FEDB00' },
                // MLB NL West
                dbacks: { primary: '#A71930', accent: '#E3D4AD', text: '#E3D4AD' },
                rockies: { primary: '#33006B', accent: '#C4CED4', text: '#C4CED4' },
                dodgers: { primary: '#005A9C', accent: '#EF3E42', text: '#FFFFFF' },
                padres: { primary: '#2F241D', accent: '#FFC425', text: '#FFC425' },
                sfgiants: { primary: '#FD5A1E', accent: '#000000', text: '#000000' },
                // Chicago extras
                bulls: { primary: '#121212', accent: '#CE1141', text: '#CE1141' },
                blackhawks: { primary: '#002F6C', accent: '#CF0A2C', text: '#CF0A2C' },
                // Retro Search Engines
                yahoo1996: { primary: '#6001A8', accent: '#FF9900', text: '#FF9900' },
                yahoo2000s: { primary: '#7B0099', accent: '#FF0000', text: '#FF0000' },
                aol1995: { primary: '#00C8FF', accent: '#FFCC00', text: '#FFCC00' },
                aol2000s: { primary: '#00A0D8', accent: '#FFFFFF', text: '#FFFFFF' },
                excite1997: { primary: '#E4002B', accent: '#000000', text: '#FFFFFF' },
                lycos: { primary: '#FF0000', accent: '#000000', text: '#FFFFFF' },
                altavista: { primary: '#0066CC', accent: '#FF9900', text: '#FF9900' },
                askjeeves: { primary: '#00A99D', accent: '#FF6600', text: '#FF6600' },
                webcrawler: { primary: '#009900', accent: '#FFFF00', text: '#FFFF00' },
                infoseek: { primary: '#660099', accent: '#FFCC00', text: '#FFCC00' },
                msn1998: { primary: '#00ADEF', accent: '#FFB900', text: '#FFB900' },
                netscape: { primary: '#0033CC', accent: '#FFCC00', text: '#FFCC00' },
                dogpile: { primary: '#FF6600', accent: '#6600CC', text: '#6600CC' },
                geocities: { primary: '#FF0099', accent: '#00FF00', text: '#00FF00' },
                // MAME Arcade
                mamepacman: { primary: '#FFFF00', accent: '#FF0000', text: '#FFFF00' },
                mamemspacman: { primary: '#FF21AE', accent: '#00FFFF', text: '#00FFFF' },
                mamedonkeykong: { primary: '#E80709', accent: '#EE7511', text: '#EE7511' },
                mamespaceinvaders: { primary: '#62DE6D', accent: '#F83B3A', text: '#62DE6D' },
                mamegalaga: { primary: '#00FF00', accent: '#EC4705', text: '#00FF00' },
                mamefrogger: { primary: '#66A400', accent: '#EB1C2D', text: '#66A400' },
                mamestreetfighter: { primary: '#FFFFFF', accent: '#E70000', text: '#E70000' },
                mamemortalkombat: { primary: '#EED911', accent: '#F53929', text: '#EED911' },
                mamedefender: { primary: '#00A651', accent: '#FF4500', text: '#00A651' },
                mamecentipede: { primary: '#228B22', accent: '#8B4513', text: '#FFFFFF' },
                mamedigdug: { primary: '#4169E1', accent: '#FF0000', text: '#4169E1' },
                mameqbert: { primary: '#9370DB', accent: '#FF8C00', text: '#9370DB' },
                mametempest: { primary: '#8A2BE2', accent: '#00BFFF', text: '#00BFFF' },
                mameasteroids: { primary: '#FFFFFF', accent: '#00FFFF', text: '#00FFFF' },
                mamebubble: { primary: '#FFB6C1', accent: '#87CEEB', text: '#FFB6C1' },
                mamegauntlet: { primary: '#40FF40', accent: '#FF4040', text: '#40FF40' },
                mamerampage: { primary: '#00A000', accent: '#FF69B4', text: '#00A000' },
                mamerobotron: { primary: '#00FFFF', accent: '#FF00FF', text: '#00FFFF' },
                mamejoust: { primary: '#FFD700', accent: '#FF0000', text: '#FFD700' },
                mametron: { primary: '#00FFFF', accent: '#FF0000', text: '#00FFFF' },
                mamenbajam: { primary: '#C8102E', accent: '#002244', text: '#FFFFFF' },
                mamecontra: { primary: '#0000FF', accent: '#FF0000', text: '#FF0000' },
                mamemetalslug: { primary: '#FFD700', accent: '#4169E1', text: '#FFD700' },
                mametmnt: { primary: '#008000', accent: '#FF0000', text: '#008000' },
                mamedoubledragon: { primary: '#0000FF', accent: '#FF0000', text: '#0000FF' },
                mamefinalfight: { primary: '#FFFF00', accent: '#FF0000', text: '#FFFF00' },
                mamegradius: { primary: '#00FFFF', accent: '#FF4500', text: '#00FFFF' },
                mamegoldenaxe: { primary: '#8B0000', accent: '#FF4500', text: '#FF4500' },
                mamestrider: { primary: '#00FF00', accent: '#FF00FF', text: '#00FF00' },
                mamertype: { primary: '#4169E1', accent: '#FF0000', text: '#4169E1' },
                // Monster Energy
                monstergreen: { primary: '#8DC63F', accent: '#000000', text: '#8DC63F' },
                monsterblack: { primary: '#000000', accent: '#C0C0C0', text: '#C0C0C0' },
                monstersunrise: { primary: '#FF6B00', accent: '#FFD700', text: '#FFD700' },
                monsterparadise: { primary: '#00FF7F', accent: '#FFFFFF', text: '#00FF7F' },
                monsterviolet: { primary: '#9932CC', accent: '#E0B0FF', text: '#E0B0FF' },
                monsterpipeline: { primary: '#FF69B4', accent: '#FFD700', text: '#FFD700' },
                monsterrehab: { primary: '#FFD700', accent: '#8B4513', text: '#FFD700' },
                monsterred: { primary: '#C8102E', accent: '#FFFFFF', text: '#FFFFFF' },
                // Mountain Dew
                mtndewgreen: { primary: '#99CC00', accent: '#006633', text: '#99CC00' },
                mtndewcodered: { primary: '#C8102E', accent: '#000000', text: '#C8102E' },
                mtndewvoltage: { primary: '#00B7EB', accent: '#000000', text: '#00B7EB' },
                mtndewbaja: { primary: '#66CCCC', accent: '#FFFFFF', text: '#FFFFFF' },
                mtndewlivewire: { primary: '#FF6B00', accent: '#000000', text: '#FF6B00' },
                mtndewwhiteout: { primary: '#FFFFFF', accent: '#00BFFF', text: '#00BFFF' },
                // Root Beer & Soda
                awrootbeer: { primary: '#8B4513', accent: '#FFD700', text: '#FFD700' },
                barqs: { primary: '#C8102E', accent: '#FFFFFF', text: '#FFFFFF' },
                mugcream: { primary: '#FFF8DC', accent: '#8B4513', text: '#8B4513' },
                ibccherry: { primary: '#4B0082', accent: '#C71585', text: '#C71585' },
                cocacola: { primary: '#C8102E', accent: '#FFFFFF', text: '#FFFFFF' },
                drpepper: { primary: '#8B0000', accent: '#DAA520', text: '#DAA520' },
                pepsi: { primary: '#004B8D', accent: '#E4002B', text: '#FFFFFF' },
                sprite: { primary: '#00A550', accent: '#FFFFFF', text: '#FFFFFF' },
                fanta: { primary: '#FF6600', accent: '#003DA5', text: '#FF6600' },
                // Energy Drinks
                redbull: { primary: '#0050A4', accent: '#C0C0C0', text: '#C0C0C0' },
                rockstar: { primary: '#800080', accent: '#FFD700', text: '#FFD700' },
                nos: { primary: '#000000', accent: '#FF0000', text: '#FF0000' },
                bang: { primary: '#FF6B00', accent: '#FFD700', text: '#FFD700' },
                c4energy: { primary: '#00BFFF', accent: '#FFFFFF', text: '#FFFFFF' },
                alaninu: { primary: '#FF69B4', accent: '#E0B0FF', text: '#E0B0FF' },
                ghostenergy: { primary: '#39FF14', accent: '#000000', text: '#39FF14' },
                celsius: { primary: '#FF4500', accent: '#FFD700', text: '#FFD700' },
                prime: { primary: '#00AEEF', accent: '#FF6B00', text: '#FF6B00' },
                reign: { primary: '#000000', accent: '#C0C0C0', text: '#C0C0C0' },
                gamerfuel: { primary: '#00FFFF', accent: '#FF00FF', text: '#00FFFF' },
                // Cyberpunk / Neon
                neon: { primary: '#00FFFF', accent: '#FF00FF', text: '#00FFFF' },
                neoncyan: { primary: '#00FFFF', accent: '#0088AA', text: '#00FFFF' },
                neonpink: { primary: '#FF00FF', accent: '#FF0080', text: '#FF00FF' },
                neonyellow: { primary: '#FFFF00', accent: '#FFD700', text: '#FFFF00' },
                neongreen: { primary: '#39FF14', accent: '#00FF00', text: '#39FF14' },
                cyberpunk: { primary: '#FF00FF', accent: '#00FFFF', text: '#FF00FF' },
                synthwave: { primary: '#FF6EC7', accent: '#7B68EE', text: '#FF6EC7' },
                vaporwave: { primary: '#FF71CE', accent: '#01CDFE', text: '#FF71CE' },
                retrowave: { primary: '#F9C80E', accent: '#FF6B6B', text: '#F9C80E' },
                outrun: { primary: '#FF2A6D', accent: '#05D9E8', text: '#FF2A6D' }
            };
            return themes[theme] || themes.purple;
        }
        
        // ========== SPLASH SCREEN FUNCTIONS ==========
        const SPLASH_BACKGROUNDS = {
            // Cubs options
            'cubs1': './cubs1.jpg',
            'cubs2': './cubs2.jpg',
            'cubs3': './cubs3.jpg',
            'cubs4': './cubs4.jpg',
            'cubs5': './cubs5.jpg',
            // Bears options
            'bears1': './bears1.jpg',
            'bears2': './bears2.jpg',
            'bears3': './bears3.jpg',
            'bears4': './bears4.jpg',
            'bears5': './bears5.jpg',
            // Gradient fallbacks
            'gradient-blue': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'gradient-purple': 'linear-gradient(135deg, #7c3aed 0%, #c026d3 100%)',
            'gradient-green': 'linear-gradient(135deg, #059669 0%, #10b981 100%)',
            'gradient-sunset': 'linear-gradient(135deg, #b8a86b 0%, #b88a8a 100%)',
            'gradient-dark': 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)'
        };
        
        function getSplashBackground(key) {
            if (key === 'custom') {
                return localStorage.getItem('splashCustomUrl') || SPLASH_BACKGROUNDS['gradient-blue'];
            }
            return SPLASH_BACKGROUNDS[key] || SPLASH_BACKGROUNDS['gradient-blue'];
        }
        
        function saveSplashSettings() {
            const enabled = document.getElementById('splashScreenEnabled')?.checked || false;
            const background = document.getElementById('splashBackground')?.value || 'gradient-blue';
            const customUrl = document.getElementById('splashCustomUrl')?.value || '';
            
            localStorage.setItem('splashEnabled', enabled ? 'true' : 'false');
            localStorage.setItem('splashBackground', background);
            localStorage.setItem('splashCustomUrl', customUrl);
            
            // Show/hide custom URL input
            const customInput = document.getElementById('splashCustomUrl');
            if (customInput) {
                customInput.style.display = background === 'custom' ? 'block' : 'none';
            }
        }
        
        function loadSplashSettings() {
            const enabled = localStorage.getItem('splashEnabled') === 'true';
            const background = localStorage.getItem('splashBackground') || 'gradient-blue';
            const customUrl = localStorage.getItem('splashCustomUrl') || '';
            
            const enabledEl = document.getElementById('splashScreenEnabled');
            const backgroundEl = document.getElementById('splashBackground');
            const customUrlEl = document.getElementById('splashCustomUrl');
            
            if (enabledEl) enabledEl.checked = enabled;
            if (backgroundEl) backgroundEl.value = background;
            if (customUrlEl) {
                customUrlEl.value = customUrl;
                customUrlEl.style.display = background === 'custom' ? 'block' : 'none';
            }
        }
        
        function showSplashScreen(force = false) {
            const enabled = localStorage.getItem('splashEnabled') === 'true';
            if (!enabled && !force) return;
            
            const background = localStorage.getItem('splashBackground') || 'gradient-blue';
            const bgValue = getSplashBackground(background);
            const isGradient = bgValue.startsWith('linear-gradient');
            
            const splash = document.createElement('div');
            splash.id = 'splashScreen';
            splash.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 999999;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                overflow: hidden;
                ${isGradient ? `background: ${bgValue};` : `background: url('${bgValue}') center center / cover no-repeat; background-color: #1a1a2e;`}
            `;
            
            // Hide body scrollbar while splash is showing
            document.body.style.overflow = 'hidden';
            document.documentElement.style.overflow = 'hidden';
            document.body.classList.add('splash-active');
            
            splash.innerHTML = `
                <style>
                    body.splash-active, html {
                        overflow: hidden !important;
                        -ms-overflow-style: none !important;
                        scrollbar-width: none !important;
                    }
                    body.splash-active::-webkit-scrollbar, 
                    html::-webkit-scrollbar,
                    #splashScreen::-webkit-scrollbar {
                        display: none !important;
                        width: 0 !important;
                    }
                    @keyframes pulse {
                        0%, 100% { opacity: 0.7; transform: translateX(-50%) scale(1); }
                        50% { opacity: 1; transform: translateX(-50%) scale(1.05); }
                    }
                </style>
                <div style="text-align: center; padding: 40px; position: absolute; top: 4%; left: 50%; transform: translateX(-50%);">
                    <h1 style="color: white; font-size: 2.5rem; margin-bottom: 10px; text-shadow: 3px 3px 6px rgba(0,0,0,0.8), 0 0 20px rgba(0,0,0,0.5);">Nowak Distributing</h1>
                    <p style="color: white; font-size: 1.2rem; margin-bottom: 30px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">ERP System</p>
                </div>
                <div style="position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.9); font-size: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); animation: pulse 2s ease-in-out infinite;">
                     Tap anywhere to continue
                </div>
            `;
            
            splash.addEventListener('click', () => {
                splash.style.transition = 'opacity 0.3s ease';
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.remove();
                    document.body.style.overflow = '';
                    document.documentElement.style.overflow = '';
                    document.body.classList.remove('splash-active');
                }, 300);
            });
            
            document.body.appendChild(splash);
        }
        
        function openBackup() {
            if (!API_URL) {
                showWarning('Please configure your API URL first!');
                return;
            }
            // Extract the Google Sheets URL from API URL pattern
            showInfo('To backup your data:<br><br>1. Go to your Google Sheets database<br>2. File  Make a copy<br>3. Download as Excel or CSV<br><br>Your Google Sheet contains all your data!');
        }
        
        // Load theme on startup
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'purple';
            document.getElementById('themeSelector').value = savedTheme;
            document.body.classList.remove(
                'theme-purple', 'theme-ocean', 'theme-forest', 'theme-sunset', 'theme-dark', 'theme-crimson', 'theme-slate', 'theme-teal',
                'theme-bills', 'theme-dolphins', 'theme-patriots', 'theme-jets',
                'theme-ravens', 'theme-bengals', 'theme-browns', 'theme-steelers',
                'theme-texans', 'theme-colts', 'theme-jaguars', 'theme-titans',
                'theme-broncos', 'theme-chiefs', 'theme-raiders', 'theme-chargers',
                'theme-cowboys', 'theme-giants', 'theme-eagles', 'theme-commanders',
                'theme-bears', 'theme-lions', 'theme-packers', 'theme-vikings',
                'theme-falcons', 'theme-panthers', 'theme-saints', 'theme-bucs',
                'theme-azcardinals', 'theme-rams', 'theme-niners', 'theme-seahawks',
                'theme-orioles', 'theme-redsox', 'theme-yankees', 'theme-rays', 'theme-bluejays',
                'theme-whitesox', 'theme-guardians', 'theme-tigers', 'theme-royals', 'theme-twins',
                'theme-astros', 'theme-angels', 'theme-athletics', 'theme-mariners', 'theme-rangers',
                'theme-braves', 'theme-marlins', 'theme-mets', 'theme-phillies', 'theme-nationals',
                'theme-cubs', 'theme-reds', 'theme-brewers', 'theme-pirates', 'theme-stlcardinals',
                'theme-dbacks', 'theme-rockies', 'theme-dodgers', 'theme-padres', 'theme-sfgiants',
                'theme-bulls', 'theme-blackhawks'
            );
            document.body.classList.add('theme-' + savedTheme);
            
            // CRITICAL: Disable all select elements in hidden forms to prevent iOS touch issues
            // This fixes the "Select Status" popup appearing randomly on mobile
            document.querySelectorAll('[style*="display: none"] select, [style*="display:none"] select').forEach(sel => {
                sel.disabled = true;
                sel.style.pointerEvents = 'none';
            });
            
            // Also specifically disable selects in edit forms that start hidden
            ['editItemForm', 'editSupplierForm', 'editCustomerForm', 'addSupplierForm', 'addCustomerForm', 'addItemForm'].forEach(formId => {
                const form = document.getElementById(formId);
                if (form && form.style.display === 'none') {
                    form.querySelectorAll('select').forEach(sel => {
                        sel.disabled = true;
                        sel.style.pointerEvents = 'none';
                    });
                }
            });
            
            // Show splash screen if enabled
            showSplashScreen();
            
            // Load splash settings for settings page
            setTimeout(() => loadSplashSettings(), 500);
            
            // Set --primary CSS variable based on saved theme
            setTimeout(() => {
                const themeColors = getThemeColors();
                document.documentElement.style.setProperty('--primary', themeColors.primary);
                document.documentElement.style.setProperty('--secondary', themeColors.accent);
                document.documentElement.style.setProperty('--primary-light', hexToRgbaLight(themeColors.primary));
                
                // Update theme preview in settings
                if (typeof updateThemePreview === 'function') {
                    updateThemePreview();
                }
            }, 100);
        });
        
        function saveConfig() {
            // Save all environment URLs
            ['production', 'training', 'test'].forEach(env => {
                const input = document.getElementById(`envUrl-${env}`);
                if (input) {
                    const url = input.value.trim();
                    environments[env] = url;
                    localStorage.setItem(`envUrl-${env}`, url);
                }
            });
            
            // Update the active API_URL
            API_URL = getActiveApiUrl();
            localStorage.setItem('apiUrl', API_URL);
            
            // Also update the hidden legacy input for compatibility
            const apiUrlInput = document.getElementById('apiUrl');
            if (apiUrlInput) {
                apiUrlInput.value = API_URL;
            }
            
            updateConfigStatus();
            updateEnvironmentUI();
            
            showStatus('configStatus', ' All environment settings saved!', 'success');
        }
        
        // Save Invoice Settings
        function saveInvoiceSettings() {
            const settings = {
                companyName: document.getElementById('invoiceCompanyName').value,
                contactName: document.getElementById('invoiceContactName').value,
                phone: document.getElementById('invoicePhone').value,
                email: document.getElementById('invoiceEmail').value,
                address1: document.getElementById('invoiceAddress1').value,
                address2: document.getElementById('invoiceAddress2').value,
                cityStateZip: document.getElementById('invoiceCityStateZip').value,
                footer: document.getElementById('invoiceFooter').value,
                signatureLine: document.getElementById('invoiceSignatureLine').checked
            };
            
            localStorage.setItem('invoiceSettings', JSON.stringify(settings));
            showStatus('configStatus', ' Invoice settings saved!', 'success');
        }
        
        // Load Invoice Settings
        function loadInvoiceSettings() {
            const saved = localStorage.getItem('invoiceSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('invoiceCompanyName').value = settings.companyName || '';
                document.getElementById('invoiceContactName').value = settings.contactName || '';
                document.getElementById('invoicePhone').value = settings.phone || '';
                document.getElementById('invoiceEmail').value = settings.email || '';
                document.getElementById('invoiceAddress1').value = settings.address1 || '';
                document.getElementById('invoiceAddress2').value = settings.address2 || '';
                document.getElementById('invoiceCityStateZip').value = settings.cityStateZip || '';
                document.getElementById('invoiceFooter').value = settings.footer || '';
                document.getElementById('invoiceSignatureLine').checked = settings.signatureLine !== false;
            }
        }
        
        // Get Invoice Settings
        function getInvoiceSettings() {
            const saved = localStorage.getItem('invoiceSettings');
            if (saved) {
                return JSON.parse(saved);
            }
            return {
                companyName: 'Nowak Distributing',
                contactName: '',
                phone: '(920)634-4351',
                email: 'jnowaksnfoodistributors@gmail.com',
                address1: '',
                address2: '',
                cityStateZip: '',
                footer: 'Thank you for doing business with us!',
                signatureLine: true
            };
        }

        // Format phone number as (999) 999-9999
        function formatPhone(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            if (value.length > 10) value = value.slice(0, 10);
            
            if (value.length >= 6) {
                input.value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6)}`;
            } else if (value.length >= 3) {
                input.value = `(${value.slice(0,3)}) ${value.slice(3)}`;
            } else if (value.length > 0) {
                input.value = `(${value}`;
            }
        }
        
        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        async function apiCall(action, data = {}) {
            if (!API_URL) {
                console.error('API_URL not configured!');
                showWarning('Please configure your API URL in Settings first!');
                switchTab('config');
                return null;
            }

            try {
                // Use GET with query parameters to avoid CORS preflight
                const params = new URLSearchParams({
                    action: action,
                    data: JSON.stringify(data)
                });
                
                const url = `${API_URL}?${params.toString()}`;
                console.log(`API Call: ${action}`, data);
                
                // Simple fetch without AbortController to avoid DataCloneError on some browsers
                // Use Promise.race for timeout instead
                const fetchPromise = fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Request timed out')), 30000);
                });
                
                const response = await Promise.race([fetchPromise, timeoutPromise]);
                
                console.log(`API Response status: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    console.error('API HTTP Error:', response.status, response.statusText);
                    return { status: 'error', message: `HTTP ${response.status}: ${response.statusText}` };
                }

                const text = await response.text();
                console.log('API Response text (first 200 chars):', text.substring(0, 200));
                
                try {
                    const result = JSON.parse(text);
                    return result;
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError, 'Response was:', text.substring(0, 500));
                    return { status: 'error', message: 'Invalid JSON response from server' };
                }
            } catch (error) {
                if (error.message === 'Request timed out') {
                    console.error('API Timeout:', action);
                    return { status: 'error', message: 'Request timed out - please try again' };
                }
                console.error('API Fetch Error:', error);
                return { status: 'error', message: error.toString() };
            }
        }

        // ==================== SUPPLIERS ====================

        function showAddSupplierForm() {
            const form = document.getElementById('addSupplierForm');
            form.style.display = 'block';
            // Re-enable selects that were disabled at startup
            form.querySelectorAll('select').forEach(sel => {
                sel.disabled = false;
                sel.style.pointerEvents = '';
            });
        }

        function hideAddSupplierForm() {
            document.getElementById('addSupplierForm').style.display = 'none';
            document.querySelector('#addSupplierForm form').reset();
        }

        async function addSupplier(e) {
            e.preventDefault();
            
            const data = {
                supplierName: document.getElementById('newSupplierName').value,
                contactName: document.getElementById('newContactName').value,
                phone: document.getElementById('newPhone').value,
                email: document.getElementById('newEmail').value,
                address: document.getElementById('newAddress').value,
                city: document.getElementById('newCity').value,
                state: document.getElementById('newState').value,
                zip: document.getElementById('newZip').value,
                paymentTerms: document.getElementById('newPaymentTerms').value,
                notes: document.getElementById('newNotes').value
            };
            
            // Validate required fields
            if (!data.supplierName) {
                showWarning('Please enter a Supplier Name');
                return;
            }

            // Show preview confirmation
            const confirmed = await showRecordPreview('supplier', data, null);
            if (!confirmed) return;

            showLoading('Adding Supplier...');
            try {
                const result = await apiCall('addSupplier', data);
                
                if (result && result.status === 'success') {
                    hideAddSupplierForm();
                    loadSuppliers();
                    showSuccessModal('Supplier Added!', 'New supplier has been created successfully.');
                } else {
                    showStatus('suppliersStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                }
            } finally {
                hideLoading();
            }
        }

        async function loadSuppliers() {
            document.getElementById('suppliersTable').innerHTML = '<div class="loading">Loading suppliers...</div>';
            
            const result = await apiCall('getSuppliers');
            
            if (result && result.status === 'success') {
                cachedSuppliers = result.data;
                displaySuppliers(result.data);
                
                // Populate Create PO supplier dropdown
                const createPOSupplierSelect = document.getElementById('createPOSupplier');
                if (createPOSupplierSelect) {
                    createPOSupplierSelect.innerHTML = '<option value="">Select Supplier...</option>';
                    result.data.forEach(supplier => {
                        const option = document.createElement('option');
                        option.value = supplier.Supplier_ID;
                        option.textContent = supplier.Supplier_Name;
                        createPOSupplierSelect.appendChild(option);
                    });
                }
            } else {
                document.getElementById('suppliersTable').innerHTML = '<div class="loading">Error loading suppliers</div>';
            }
        }

        function displaySuppliers(suppliers) {
            if (!suppliers || suppliers.length === 0) {
                document.getElementById('suppliersTable').innerHTML = '<p>No suppliers yet. Add your first supplier!</p>';
                return;
            }

            let html = '<div class="table-scroll-wrapper"><table class="data-table" id="suppliersDataTable"><thead><tr>';
            html += '<th>Name</th><th>Contact</th><th>Phone</th><th>Email</th><th>City</th><th>Payment Terms</th>';
            html += '</tr></thead><tbody>';

            suppliers.forEach(s => {
                html += `<tr style="cursor: pointer;" onclick='editSupplier(${JSON.stringify(s).replace(/'/g, "&#39;")})' onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                    <td><strong>${s.Supplier_Name}</strong></td>
                    <td>${s.Contact_Name || '-'}</td>
                    <td>${s.Phone || '-'}</td>
                    <td>${s.Email || '-'}</td>
                    <td>${s.City || '-'}, ${s.State || '-'}</td>
                    <td>${s.Payment_Terms || '-'}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            document.getElementById('suppliersTable').innerHTML = html;
            
            // Make table sortable
            setTimeout(() => makeSortable('suppliersDataTable'), 0);
        }
        
        // Filter suppliers
        function filterSuppliers() {
            const nameFilter = document.getElementById('filterSupplierName').value.toLowerCase();
            const cityFilter = document.getElementById('filterSupplierCity').value.toLowerCase();
            const stateFilter = document.getElementById('filterSupplierState').value.toLowerCase();
            
            const filtered = cachedSuppliers.filter(s => {
                const matchesName = !nameFilter || (s.Supplier_Name && s.Supplier_Name.toLowerCase().includes(nameFilter));
                const matchesCity = !cityFilter || (s.City && s.City.toLowerCase().includes(cityFilter));
                const matchesState = !stateFilter || (s.State && s.State.toLowerCase().includes(stateFilter));
                return matchesName && matchesCity && matchesState;
            });
            
            displaySuppliers(filtered);
        }
        
        function clearSupplierFilters() {
            document.getElementById('filterSupplierName').value = '';
            document.getElementById('filterSupplierCity').value = '';
            document.getElementById('filterSupplierState').value = '';
            displaySuppliers(cachedSuppliers);
        }
        
        // Edit supplier
        let currentEditingSupplier = null; // Store original for comparison
        
        function editSupplier(supplier) {
            currentEditingSupplier = supplier; // Store original
            document.getElementById('editSupplierId').value = supplier.Supplier_ID;
            document.getElementById('editSupplierName').value = supplier.Supplier_Name || '';
            document.getElementById('editContactName').value = supplier.Contact_Name || '';
            document.getElementById('editPhone').value = supplier.Phone || '';
            document.getElementById('editEmail').value = supplier.Email || '';
            document.getElementById('editAddress').value = supplier.Address || '';
            document.getElementById('editCity').value = supplier.City || '';
            document.getElementById('editState').value = supplier.State || '';
            document.getElementById('editZip').value = supplier.ZIP || '';
            document.getElementById('editPaymentTerms').value = supplier.Payment_Terms || 'Net 30';
            document.getElementById('editNotes').value = supplier.Notes || '';
            
            const form = document.getElementById('editSupplierForm');
            form.style.display = 'block';
            document.getElementById('addSupplierForm').style.display = 'none';
            
            // Re-enable selects that were disabled at startup
            form.querySelectorAll('select').forEach(sel => {
                sel.disabled = false;
                sel.style.pointerEvents = '';
            });
        }
        
        function hideEditSupplierForm() {
            document.getElementById('editSupplierForm').style.display = 'none';
            document.querySelector('#editSupplierForm form').reset();
            
            // Return to previous tab if we came from Reports
            if (returnToTab === 'reports') {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="reports"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('reports').classList.add('active');
                returnToTab = null;
            }
        }
        
        async function updateSupplier(e) {
            e.preventDefault();
            
            const data = {
                supplierId: document.getElementById('editSupplierId').value,
                name: document.getElementById('editSupplierName').value,
                address: document.getElementById('editAddress').value,
                city: document.getElementById('editCity').value,
                state: document.getElementById('editState').value,
                zip: document.getElementById('editZip').value,
                contactName: document.getElementById('editContactName').value,
                phone: document.getElementById('editPhone').value,
                fax: '',
                email: document.getElementById('editEmail').value,
                paymentTerms: document.getElementById('editPaymentTerms').value,
                notes: document.getElementById('editNotes').value
            };
            
            // Map original data for comparison
            const originalData = currentEditingSupplier ? {
                name: currentEditingSupplier.Supplier_Name || '',
                address: currentEditingSupplier.Address || '',
                city: currentEditingSupplier.City || '',
                state: currentEditingSupplier.State || '',
                zip: currentEditingSupplier.ZIP || '',
                contactName: currentEditingSupplier.Contact_Name || '',
                phone: currentEditingSupplier.Phone || '',
                email: currentEditingSupplier.Email || '',
                paymentTerms: currentEditingSupplier.Payment_Terms || '',
                notes: currentEditingSupplier.Notes || ''
            } : null;
            
            // Show preview of changes
            const confirmed = await showRecordPreview('supplier', data, originalData);
            if (!confirmed) return;
            
            showLoading('Updating Supplier...');
            try {
                const result = await apiCall('updateSupplier', data);
                
                if (result && result.status === 'success') {
                    hideEditSupplierForm();
                    loadSuppliers();
                    showSuccessModal('Supplier Updated!', 'Changes saved successfully.');
                } else {
                    showStatus('suppliersStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                }
            } finally {
                hideLoading();
            }
        }
        
        async function deleteSupplier(supplierId, supplierName) {
            const confirmed = await showConfirmModal(
                'Delete Supplier?',
                `Are you sure you want to delete supplier "<strong>${supplierName}</strong>"?<br><br> This cannot be undone!`,
                'Delete',
                'Cancel',
                'danger'
            );
            if (!confirmed) return;
            
            showLoading('Deleting Supplier...');
            try {
                const result = await apiCall('deleteSupplier', { supplierId });
                
                if (result && result.status === 'success') {
                    loadSuppliers();
                    showSuccessModal('Supplier Deleted!', `"${supplierName}" has been removed.`);
                } else {
                    showStatus('suppliersStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                }
            } finally {
                hideLoading();
            }
        }

        // ==================== ITEMS ====================

        function showAddItemForm() {
            loadSuppliersList();
            const form = document.getElementById('addItemForm');
            form.style.display = 'block';
            
            // Re-enable selects that were disabled at startup (when form was hidden)
            form.querySelectorAll('select').forEach(sel => {
                sel.disabled = false;
                sel.style.pointerEvents = '';
            });
        }

        function hideAddItemForm() {
            document.getElementById('addItemForm').style.display = 'none';
            document.querySelector('#addItemForm form').reset();
        }

        async function loadSuppliersList() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }

            const select = document.getElementById('newItemSupplier');
            select.innerHTML = '<option value="">Select Supplier</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }

        // Calculate unit cost in Add Item form
        function calculateUnitCost() {
            const packageCost = parseFloat(document.getElementById('newPackageCost').value) || 0;
            const unitsPerPackage = parseFloat(document.getElementById('newUnitsPerPackage').value) || 1;
            const unitCost = packageCost / unitsPerPackage;
            document.getElementById('calculatedUnitCost').value = '$' + unitCost.toFixed(2);
        }
        
        // Calculate unit cost in Edit Item form
        function calculateEditUnitCost() {
            const packageCost = parseFloat(document.getElementById('editPackageCost').value) || 0;
            const unitsPerPackage = parseFloat(document.getElementById('editUnitsPerPackage').value) || 1;
            const unitCost = packageCost / unitsPerPackage;
            document.getElementById('calculatedEditUnitCost').value = '$' + unitCost.toFixed(2);
        }
        
        async function addItem(e) {
            e.preventDefault();
            
            const data = {
                supplierId: document.getElementById('newItemSupplier').value,
                description: document.getElementById('newItemDescription').value,
                purchaseUOM: document.getElementById('newItemPurchaseUOM').value,
                unitsPerPackage: document.getElementById('newUnitsPerPackage').value,
                packageCost: document.getElementById('newPackageCost').value,
                unitSellPrice: document.getElementById('newUnitSellPrice').value,
                qtyOnHand: document.getElementById('newQtyOnHand').value,
                reorderPoint: document.getElementById('newReorderPoint').value,
                sku: document.getElementById('newItemSKU').value,
                notes: document.getElementById('newItemNotes').value
            };
            
            // Validate required fields
            if (!data.description) {
                showWarning('Please enter an Item Description');
                return;
            }
            
            // Get supplier name for display
            const supplierSelect = document.getElementById('newItemSupplier');
            const supplierName = supplierSelect.options[supplierSelect.selectedIndex]?.text || '';
            
            // Build display data with supplier name
            const displayData = { ...data, supplier: supplierName };
            delete displayData.supplierId;

            // Show preview confirmation
            const confirmed = await showRecordPreview('item', displayData, null);
            if (!confirmed) return;

            showLoading('Adding Item...');
            try {
                const result = await apiCall('addItem', data);
                
                if (result && result.status === 'success') {
                    hideAddItemForm();
                    loadItems();
                    showSuccessModal('Item Added!', 'New item has been created successfully.');
                } else {
                    showStatus('itemsStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                }
            } finally {
                hideLoading();
            }
        }

        async function loadItems(forceRefresh = false) {
            const itemsTable = document.getElementById('itemsTable');
            if (itemsTable) {
                itemsTable.innerHTML = '<div class="loading">Loading items...</div>';
            }
            
            // Ensure suppliers are loaded first so getSupplierName works
            if (cachedSuppliers.length === 0) {
                const suppResult = await apiCall('getSuppliers');
                if (suppResult && suppResult.status === 'success') {
                    cachedSuppliers = suppResult.data;
                }
            }
            
            // Add timestamp to bust caching if forced
            const result = await apiCall('getItems', forceRefresh ? { _t: Date.now() } : {});
            
            if (result && result.status === 'success') {
                cachedItems = result.data;
                
                // DEBUG: Log the first item to see what properties it actually has
                if (cachedItems.length > 0) {
                    console.log('=== ITEM DATA STRUCTURE DEBUG ===');
                    console.log('First item keys:', Object.keys(cachedItems[0]));
                    console.log('First item full data:', cachedItems[0]);
                    console.log('Unit_Sell_Price:', cachedItems[0].Unit_Sell_Price);
                    console.log('Sell_Price:', cachedItems[0].Sell_Price);
                    console.log('=================================');
                }
                
                // Build expected arrival dates from pending POs (async, don't wait)
                buildItemExpectedArrivals();
                
                // Apply active filter by default (show only active items)
                if (itemsTable) {
                    const activeFilter = document.getElementById('filterItemActive')?.value || 'active';
                    let itemsToDisplay = result.data;
                    if (activeFilter === 'active') {
                        itemsToDisplay = result.data.filter(item => item.Status !== 'Archived');
                    } else if (activeFilter === 'archived') {
                        itemsToDisplay = result.data.filter(item => item.Status === 'Archived');
                    }
                    
                    displayItems(itemsToDisplay);
                    loadItemFilterSuppliers();
                    if (forceRefresh) {
                        showStatus('itemsStatus', ' Items refreshed!', 'success');
                    }
                }
            } else {
                if (itemsTable) {
                    itemsTable.innerHTML = '<div class="loading">Error loading items</div>';
                }
            }
        }

        function displayItems(items) {
            if (!items || items.length === 0) {
                document.getElementById('itemsTable').innerHTML = '<p>No items yet. Add your first item!</p>';
                return;
            }

            // Calculate totals
            let totalQty = 0;
            
            let html = '<div class="table-scroll-wrapper"><table class="data-table" id="itemsDataTable"><thead><tr>';
            html += '<th>SKU</th><th>Description</th><th>Supplier</th><th>UOM</th><th>Units/Pkg</th><th>Pkg Cost</th><th>Unit Cost</th><th>Sell Price</th><th>Qty</th><th>On Order</th><th>Backorder</th><th>Reorder</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            items.forEach(item => {
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const qtyOnOrder = parseFloat(item.Qty_On_Order) || 0;
                const qtyOnBackorder = parseFloat(item.Qty_On_Backorder) || 0;
                const unitsPerPkg = parseFloat(item.Units_Per_Package) || 1;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitCost = packageCost / unitsPerPkg;
                const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                const packages = (qty / unitsPerPkg).toFixed(1);
                const packagesOnOrder = (qtyOnOrder / unitsPerPkg).toFixed(1);
                const isArchived = item.Status === 'Archived';
                
                // Determine row styling based on stock status
                let rowBg = '';
                let qtyStyle = '';
                if (isArchived) {
                    rowBg = 'background:#f0f0f0; opacity: 0.7;';  // Grey for archived
                } else if (qty < 0) {
                    rowBg = 'background:#ffcdd2;';  // Red for negative
                    qtyStyle = 'color: #b71c1c; font-weight: bold;';
                } else if (qty <= reorderPoint) {
                    rowBg = 'background:#f0e8d0;';  // Yellow for low stock
                }
                
                totalQty += qty;
                
                html += `<tr style="${rowBg} cursor: pointer;" onclick="editItemById('${item.Item_ID}')" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
                    <td><strong>${item.SKU || '-'}</strong>${isArchived ? ' <span style="background: #a8a8a8; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">ARCHIVED</span>' : ''}</td>
                    <td>${item.Item_Description}</td>
                    <td>${getSupplierName(item.Supplier_ID)}</td>
                    <td>${item.Purchase_UOM}</td>
                    <td>${unitsPerPkg}</td>
                    <td>${formatMoney(packageCost)}</td>
                    <td>${formatMoney(unitCost)}</td>
                    <td style="color: #6b9a8d; font-weight: bold;">${formatMoney(unitSellPrice)}</td>
                    <td style="${qtyStyle}">${formatNum(qty)}</td>
                    <td><span style="background: ${qtyOnOrder > 0 ? '#b8a86b' : '#e0e0e0'}; padding: 3px 8px; border-radius: 4px; font-weight: bold;">${qtyOnOrder > 0 ? qtyOnOrder : '-'}</span></td>
                    <td><span style="background: ${qtyOnBackorder > 0 ? '#f57c00' : '#e0e0e0'}; color: ${qtyOnBackorder > 0 ? 'white' : '#999'}; padding: 3px 8px; border-radius: 4px; font-weight: bold;">${qtyOnBackorder > 0 ? qtyOnBackorder : '-'}</span></td>
                    <td>${item.Reorder_Point || 0}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="btn-delete-icon" onclick="toggleArchiveItem('${item.Item_ID}', '${item.Item_Description.replace(/'/g, "\\'")}', ${isArchived})" title="${isArchived ? 'Reactivate Item' : 'Archive Item'}" style="font-size: 18px;">${isArchived ? '' : ''}</button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table></div>'; // Close table and scroll wrapper
            document.getElementById('itemsTable').innerHTML = html;
            setTimeout(() => makeSortable('itemsDataTable'), 0);
        }
        
        // Filter items
        async function filterItems() {
            const searchFilter = document.getElementById('filterItemSearch').value.toLowerCase().trim();
            const supplierFilter = document.getElementById('filterItemSupplier').value;
            const stockFilter = document.getElementById('filterItemStock').value;
            const activeFilter = document.getElementById('filterItemActive')?.value || 'active';
            
            // Ensure items are loaded
            if (cachedItems.length === 0) {
                await loadItems();
                return;
            }
            
            const filtered = cachedItems.filter(item => {
                const matchesSearch = !searchFilter || 
                    (item.SKU && item.SKU.toString().toLowerCase().includes(searchFilter)) ||
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(searchFilter));
                // Use matchesFilter for multi-select support
                const matchesSupplier = matchesFilter(item.Supplier_ID, supplierFilter);
                
                // Active/Archived status filter
                const isArchived = item.Status === 'Archived';
                let matchesActive = true;
                if (activeFilter === 'active') {
                    matchesActive = !isArchived;
                } else if (activeFilter === 'archived') {
                    matchesActive = isArchived;
                }
                
                // Stock status calculations
                const qtyOnHand = parseFloat(item.Qty_On_Hand) || 0;
                const qtyOnOrder = parseFloat(item.Qty_On_Order) || 0;
                const committed = parseFloat(item.Qty_On_Backorder) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                const negativeStock = qtyOnHand < 0;
                const lowStock = qtyOnHand <= reorderPoint && qtyOnHand >= 0;
                const hasOnOrder = qtyOnOrder > 0;
                // Effective available = On Hand - Committed + On Order
                const effectiveAvailable = qtyOnHand - committed + qtyOnOrder;
                // Needs reorder only if effective available (with on-order) is still below reorder point
                const needsReorder = effectiveAvailable < reorderPoint && reorderPoint > 0;
                
                let matchesStock = true;
                if (stockFilter === 'negative') {
                    matchesStock = negativeStock;
                } else if (stockFilter === 'low') {
                    matchesStock = lowStock || negativeStock;
                } else if (stockFilter === 'onorder') {
                    matchesStock = hasOnOrder;
                } else if (stockFilter === 'reorder') {
                    matchesStock = needsReorder;
                } else if (stockFilter === 'ok') {
                    matchesStock = qtyOnHand > reorderPoint;
                }
                
                return matchesSearch && matchesSupplier && matchesStock && matchesActive;
            });
            
            displayItems(filtered);
        }
        
        async function clearItemFilters() {
            document.getElementById('filterItemSearch').value = '';
            document.getElementById('filterItemSupplier').value = '';
            document.getElementById('filterItemStock').value = '';
            document.getElementById('filterItemActive').value = 'active';
            // Show only active items by default after clearing
            filterItems();
        }
        
        async function loadItemFilterSuppliers() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }
            
            const select = document.getElementById('filterItemSupplier');
            select.innerHTML = '<option value="">All Suppliers</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }
        
        // Helper function to edit by ID
        function editItemById(itemId) {
            const item = cachedItems.find(i => i.Item_ID === itemId);
            if (item) {
                editItem(item);
            }
        }
        
        // Edit item
        let currentEditingItem = null; // Store original for comparison
        
        async function editItem(item) {
            currentEditingItem = item; // Store original
            
            // Hide add form first
            document.getElementById('addItemForm').style.display = 'none';
            
            // Load suppliers for dropdown
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }
            
            const select = document.getElementById('editItemSupplier');
            select.innerHTML = '<option value="">Select Supplier</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
            
            document.getElementById('editItemId').value = item.Item_ID;
            document.getElementById('editItemSupplier').value = item.Supplier_ID || '';
            document.getElementById('editItemDescription').value = item.Item_Description || '';
            document.getElementById('editItemSKU').value = item.SKU || '';
            const uomValue = item.Purchase_UOM || 'Case';
            document.getElementById('editItemPurchaseUOM').value = uomValue;
            document.getElementById('editItemPurchaseUOMDisplay').value = uomValue;
            document.getElementById('editUnitsPerPackage').value = item.Units_Per_Package || 1;
            document.getElementById('editPackageCost').value = item.Package_Cost || '';
            document.getElementById('editUnitSellPrice').value = item.Unit_Sell_Price || '';
            document.getElementById('editQtyOnHand').value = item.Qty_On_Hand || '';
            document.getElementById('editReorderPoint').value = item.Reorder_Point || '';
            document.getElementById('editItemStatus').value = item.Status || 'Active';
            document.getElementById('editItemNotes').value = item.Notes || '';
            
            // Calculate unit cost for display
            calculateEditUnitCost();
            
            const editForm = document.getElementById('editItemForm');
            editForm.style.display = 'block';
            
            // Re-enable select elements that were disabled
            editForm.querySelectorAll('select').forEach(sel => {
                sel.disabled = false;
                sel.style.pointerEvents = '';
            });
            
            // Scroll to the edit form
            editForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function goToAdjustInventory() {
            // Get the current item ID from the edit form
            const itemId = document.getElementById('editItemId').value;
            
            // Hide the edit form
            hideEditItemForm();
            
            // Switch to inventory tab
            switchTab('inventory');
            
            // Wait for tab to load, then show the adjustment form and pre-select the item
            setTimeout(async () => {
                // Show the adjustment form first (this loads fresh data)
                await showAdjustInventoryForm();
                
                // NOW populate the fields after the form has loaded
                if (itemId && cachedItems.length > 0) {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    if (item) {
                        // Set the hidden input value
                        document.getElementById('adjustItem').value = itemId;
                        // Set the display field
                        document.getElementById('adjustItemDisplay').value = `${item.SKU || ''} - ${item.Item_Description || 'Unknown'}`.trim();
                        // Set current quantity
                        const currentQty = parseInt(item.Qty_On_Hand) || 0;
                        document.getElementById('adjustCurrentQty').value = currentQty;
                        // Clear adjustment fields
                        document.getElementById('adjustQuantity').value = '';
                        document.getElementById('adjustNewQty').value = '';
                    }
                }
                
                // Scroll to the adjustment form
                const adjustForm = document.getElementById('adjustInventoryForm');
                if (adjustForm) {
                    adjustForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }
        
        function hideEditItemForm() {
            const form = document.getElementById('editItemForm');
            form.style.display = 'none';
            document.querySelector('#editItemForm form').reset();
            
            // Disable select elements to prevent iOS touch issues
            form.querySelectorAll('select').forEach(sel => {
                sel.disabled = true;
                sel.style.pointerEvents = 'none';
            });
            
            // Return to previous tab if we came from Reports
            if (returnToTab === 'reports') {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="reports"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('reports').classList.add('active');
                returnToTab = null;
            }
        }
        
        async function updateItem(e) {
            e.preventDefault();
            
            const data = {
                itemId: document.getElementById('editItemId').value,
                supplierId: document.getElementById('editItemSupplier').value,
                description: document.getElementById('editItemDescription').value,
                purchaseUOM: document.getElementById('editItemPurchaseUOM').value,
                unitsPerPackage: document.getElementById('editUnitsPerPackage').value,
                packageCost: document.getElementById('editPackageCost').value,
                unitSellPrice: document.getElementById('editUnitSellPrice').value,
                reorderPoint: document.getElementById('editReorderPoint').value,
                sku: document.getElementById('editItemSKU').value,
                notes: document.getElementById('editItemNotes').value,
                status: document.getElementById('editItemStatus').value
            };
            
            console.log('=== UPDATE ITEM DEBUG ===');
            console.log('Status field value:', document.getElementById('editItemStatus').value);
            console.log('Full data being sent:', JSON.stringify(data));
            
            // Map original data for comparison
            const originalData = currentEditingItem ? {
                description: currentEditingItem.Item_Description || '',
                purchaseUOM: currentEditingItem.Purchase_UOM || '',
                unitsPerPackage: String(currentEditingItem.Units_Per_Package || ''),
                packageCost: String(currentEditingItem.Package_Cost || ''),
                unitSellPrice: String(currentEditingItem.Unit_Sell_Price || ''),
                reorderPoint: String(currentEditingItem.Reorder_Point || ''),
                sku: currentEditingItem.SKU || '',
                notes: currentEditingItem.Notes || '',
                status: currentEditingItem.Status || 'Active'
            } : null;
            
            console.log('Original status:', currentEditingItem?.Status);
            console.log('Original data for comparison:', JSON.stringify(originalData));
            
            // Show preview of changes
            const confirmed = await showRecordPreview('item', data, originalData);
            if (!confirmed) return;
            
            console.log('Confirmed! Sending to API:', JSON.stringify(data));
            
            showLoading('Updating Item...');
            try {
                const result = await apiCall('updateItem', data);
                
                console.log('API result:', JSON.stringify(result));
                
                if (result && result.status === 'success') {
                    hideEditItemForm();
                    
                    // Force refresh items with cache bust
                    await loadItems(true);
                    
                    // If status changed to Archived, show special message and switch filter
                    if (data.status === 'Archived' && originalData && originalData.status !== 'Archived') {
                        // Switch filter to show archived items so user can see the change
                        const filterSelect = document.getElementById('filterItemActive');
                        if (filterSelect) {
                            filterSelect.value = 'all';
                            filterItems(); // Re-apply filter
                        }
                        showSuccessModal('Item Archived!', `"${data.description || data.sku}" has been archived.\n\nArchived items won't appear in PO/SO dropdowns.\nFilter changed to "All" to show archived items.`);
                    } else if (data.status === 'Active' && originalData && originalData.status === 'Archived') {
                        showSuccessModal('Item Reactivated!', `"${data.description || data.sku}" is now active again.`);
                    } else {
                        showSuccessModal('Item Updated!', 'Changes saved successfully.');
                    }
                } else {
                    showStatus('itemsStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                }
            } finally {
                hideLoading();
            }
        }
        
        async function toggleArchiveItem(itemId, itemDesc, isCurrentlyArchived) {
            const action = isCurrentlyArchived ? 'reactivate' : 'archive';
            const actionLabel = isCurrentlyArchived ? 'Reactivate' : 'Archive';
            const confirmMsg = isCurrentlyArchived 
                ? `This will make "<strong>${itemDesc}</strong>" available in dropdowns again.`
                : `This will hide "<strong>${itemDesc}</strong>" from new PO/SO dropdowns but preserve all history.<br><br>You can reactivate it later if needed.`;
            
            const confirmed = await showConfirmModal(
                isCurrentlyArchived ? ' Reactivate Item' : ' Archive Item',
                confirmMsg,
                actionLabel,
                'Cancel',
                isCurrentlyArchived ? 'success' : 'warning'
            );
            if (!confirmed) {
                return;
            }
            
            showLoading(isCurrentlyArchived ? 'Reactivating Item...' : 'Archiving Item...');
            try {
                const newStatus = isCurrentlyArchived ? 'Active' : 'Archived';
                const result = await apiCall('updateItem', { 
                    itemId: itemId,
                    status: newStatus
                });
                
                if (result && result.status === 'success') {
                    showStatus('itemsStatus', ` Item ${action}d successfully!`, 'success');
                    loadItems();
                } else {
                    showStatus('itemsStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                }
            } finally {
                hideLoading();
            }
        }

        // ==================== CUSTOMERS ====================

        function showAddCustomerForm() {
            const form = document.getElementById('addCustomerForm');
            form.style.display = 'block';
            // Re-enable selects that were disabled at startup
            form.querySelectorAll('select').forEach(sel => {
                sel.disabled = false;
                sel.style.pointerEvents = '';
            });
        }

        function hideAddCustomerForm() {
            document.getElementById('addCustomerForm').style.display = 'none';
            document.querySelector('#addCustomerForm form').reset();
        }

        async function addCustomer(e) {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('newCustomerName').value,
                contactName: document.getElementById('newCustomerContact').value,
                phone: document.getElementById('newCustomerPhone').value,
                mobile: document.getElementById('newCustomerMobile').value,
                email: document.getElementById('newCustomerEmail').value,
                address: document.getElementById('newCustomerAddress').value,
                city: document.getElementById('newCustomerCity').value,
                state: document.getElementById('newCustomerState').value,
                zip: document.getElementById('newCustomerZip').value,
                creditLimit: document.getElementById('newCreditLimit').value,
                paymentTerms: document.getElementById('newCustomerPaymentTerms').value,
                notes: document.getElementById('newCustomerNotes').value
            };
            
            // Validate required fields
            if (!data.name) {
                showWarning('Please enter a Customer Name');
                return;
            }

            // Show preview confirmation
            const confirmed = await showRecordPreview('customer', data, null);
            if (!confirmed) return;

            showLoading('Adding Customer...');
            try {
                const result = await apiCall('addCustomer', data);
                
                if (result && result.status === 'success') {
                    hideAddCustomerForm();
                    loadCustomers();
                    showSuccessModal('Customer Added!', 'New customer has been created successfully.');
                } else {
                    showStatus('customersStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                }
            } finally {
                hideLoading();
            }
        }

        async function loadCustomers() {
            document.getElementById('customersTable').innerHTML = '<div class="loading">Loading customers...</div>';
            
            const result = await apiCall('getCustomers');
            
            if (result && result.status === 'success') {
                cachedCustomers = result.data;
                
                // Calculate Top Customer rankings based on sales
                await calculateCustomerRankings();
                
                displayCustomers(cachedCustomers);
            } else {
                document.getElementById('customersTable').innerHTML = '<div class="loading">Error loading customers</div>';
            }
        }
        
        // Calculate customer rankings based on total sales
        async function calculateCustomerRankings() {
            try {
                // Get sales data if not already loaded
                const salesResult = await apiCall('getSalesOrders');
                if (!salesResult || salesResult.status !== 'success') return;
                
                const sales = salesResult.data || [];
                
                // Calculate total revenue per customer
                const customerRevenue = {};
                sales.forEach(sale => {
                    const custId = sale.Customer_ID;
                    const amount = parseFloat(sale.Total_Amount) || 0;
                    if (!customerRevenue[custId]) {
                        customerRevenue[custId] = 0;
                    }
                    customerRevenue[custId] += amount;
                });
                
                // Sort customers by revenue
                const rankedCustomers = Object.entries(customerRevenue)
                    .sort((a, b) => b[1] - a[1])
                    .map(([custId, revenue], index) => ({ custId, revenue, rank: index + 1 }));
                
                // Assign ranks to cached customers
                cachedCustomers.forEach(c => {
                    const ranked = rankedCustomers.find(r => r.custId === c.Customer_ID);
                    if (ranked) {
                        c.Top_Customer_Rank = ranked.rank;
                        c.Total_Revenue = ranked.revenue;
                    }
                });
                
            } catch (err) {
                console.log('Could not calculate customer rankings:', err);
            }
        }

        function displayCustomers(customers) {
            if (!customers || customers.length === 0) {
                document.getElementById('customersTable').innerHTML = '<p>No customers yet. Add your first customer!</p>';
                return;
            }

            let html = '<div class="table-scroll-wrapper"><table class="data-table" id="customersDataTable"><thead><tr>';
            html += '<th>Name</th><th>Contact</th><th>Phone</th><th>Email</th><th>City</th><th>Credit Limit</th>';
            html += '</tr></thead><tbody>';

            customers.forEach(c => {
                // Build badge HTML
                let badgeHtml = '';
                if (c.Top_Customer_Rank) {
                    const rank = parseInt(c.Top_Customer_Rank);
                    if (rank === 1) {
                        badgeHtml = `<span style="background: #ffd700; color: #000; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 6px;"> #1</span>`;
                    } else if (rank <= 10) {
                        badgeHtml = `<span style="background: #fff9c4; color: #f57f17; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 6px;"> Top 10</span>`;
                    } else if (rank <= 25) {
                        badgeHtml = `<span style="background: #e3f2fd; color: #1565c0; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 6px;"> Top 25</span>`;
                    }
                }
                
                html += `<tr style="cursor: pointer;" onclick='editCustomer(${JSON.stringify(c).replace(/'/g, "&#39;")})' onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                    <td><strong>${c.Customer_Name}</strong>${badgeHtml}</td>
                    <td>${c.Contact_Name || '-'}</td>
                    <td>${c.Phone || '-'}</td>
                    <td>${c.Email || '-'}</td>
                    <td>${c.City || '-'}, ${c.State || '-'}</td>
                    <td>${formatMoney(parseFloat(c.Credit_Limit || 0))}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            document.getElementById('customersTable').innerHTML = html;
            setTimeout(() => makeSortable('customersDataTable'), 0);
        }
        
        // Filter customers
        function filterCustomers() {
            const nameFilter = document.getElementById('filterCustomerName').value.toLowerCase();
            const contactFilter = document.getElementById('filterCustomerContact').value.toLowerCase();
            const cityFilter = document.getElementById('filterCustomerCity').value.toLowerCase();
            const stateFilter = document.getElementById('filterCustomerState').value.toLowerCase();
            
            const filtered = cachedCustomers.filter(c => {
                const matchesName = !nameFilter || (c.Customer_Name && c.Customer_Name.toLowerCase().includes(nameFilter));
                const matchesContact = !contactFilter || (c.Contact_Name && c.Contact_Name.toLowerCase().includes(contactFilter));
                const matchesCity = !cityFilter || (c.City && c.City.toLowerCase().includes(cityFilter));
                const matchesState = !stateFilter || (c.State && c.State.toLowerCase().includes(stateFilter));
                return matchesName && matchesContact && matchesCity && matchesState;
            });
            
            displayCustomers(filtered);
        }
        
        function clearCustomerFilters() {
            document.getElementById('filterCustomerName').value = '';
            document.getElementById('filterCustomerContact').value = '';
            document.getElementById('filterCustomerCity').value = '';
            document.getElementById('filterCustomerState').value = '';
            displayCustomers(cachedCustomers);
        }
        
        // Edit customer
        let currentEditingCustomer = null; // Store original for comparison
        
        function editCustomer(customer) {
            currentEditingCustomer = customer; // Store original
            document.getElementById('editCustomerId').value = customer.Customer_ID;
            document.getElementById('editCustomerName').value = customer.Customer_Name || '';
            document.getElementById('editCustomerContact').value = customer.Contact_Name || '';
            document.getElementById('editCustomerPhone').value = customer.Phone || '';
            document.getElementById('editCustomerMobile').value = customer.Mobile || '';
            document.getElementById('editCustomerEmail').value = customer.Email || '';
            document.getElementById('editCustomerAddress').value = customer.Address || '';
            document.getElementById('editCustomerCity').value = customer.City || '';
            document.getElementById('editCustomerState').value = customer.State || '';
            document.getElementById('editCustomerZip').value = customer.ZIP || '';
            document.getElementById('editCreditLimit').value = customer.Credit_Limit || '';
            document.getElementById('editCustomerPaymentTerms').value = customer.Payment_Terms || 'Net 30';
            document.getElementById('editCustomerNotes').value = customer.Notes || '';
            
            document.getElementById('editCustomerForm').style.display = 'block';
            document.getElementById('addCustomerForm').style.display = 'none';
        }
        
        function hideEditCustomerForm() {
            document.getElementById('editCustomerForm').style.display = 'none';
            document.querySelector('#editCustomerForm form').reset();
            
            // Return to previous tab if we came from Reports
            if (returnToTab === 'reports') {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="reports"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('reports').classList.add('active');
                returnToTab = null;
            }
        }
        
        async function updateCustomer(e) {
            e.preventDefault();
            
            const data = {
                customerId: document.getElementById('editCustomerId').value,
                name: document.getElementById('editCustomerName').value,
                address: document.getElementById('editCustomerAddress').value,
                city: document.getElementById('editCustomerCity').value,
                state: document.getElementById('editCustomerState').value,
                zip: document.getElementById('editCustomerZip').value,
                contactName: document.getElementById('editCustomerContact').value,
                phone: document.getElementById('editCustomerPhone').value,
                mobile: document.getElementById('editCustomerMobile').value,
                email: document.getElementById('editCustomerEmail').value,
                creditLimit: document.getElementById('editCreditLimit').value,
                paymentTerms: document.getElementById('editCustomerPaymentTerms').value,
                notes: document.getElementById('editCustomerNotes').value
            };
            
            // Map original data for comparison
            const originalData = currentEditingCustomer ? {
                name: currentEditingCustomer.Customer_Name || '',
                address: currentEditingCustomer.Address || '',
                city: currentEditingCustomer.City || '',
                state: currentEditingCustomer.State || '',
                zip: currentEditingCustomer.ZIP || '',
                contactName: currentEditingCustomer.Contact_Name || '',
                phone: currentEditingCustomer.Phone || '',
                mobile: currentEditingCustomer.Mobile || '',
                email: currentEditingCustomer.Email || '',
                creditLimit: currentEditingCustomer.Credit_Limit || '',
                paymentTerms: currentEditingCustomer.Payment_Terms || '',
                notes: currentEditingCustomer.Notes || ''
            } : null;
            
            // Show preview of changes
            const confirmed = await showRecordPreview('customer', data, originalData);
            if (!confirmed) return;
            
            showLoading('Updating Customer...');
            try {
                const result = await apiCall('updateCustomer', data);
                
                if (result && result.status === 'success') {
                    hideEditCustomerForm();
                    loadCustomers();
                    showSuccessModal('Customer Updated!', 'Changes saved successfully.');
                } else {
                    showStatus('customersStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                }
            } finally {
                hideLoading();
            }
        }
        
        async function deleteCustomer(customerId, customerName) {
            const confirmed = await showConfirmModal(
                'Delete Customer?',
                `Are you sure you want to delete customer "<strong>${customerName}</strong>"?<br><br> This cannot be undone!`,
                'Delete',
                'Cancel',
                'danger'
            );
            if (!confirmed) return;
            
            showLoading('Deleting Customer...');
            try {
                const result = await apiCall('deleteCustomer', { customerId });
                
                if (result && result.status === 'success') {
                    loadCustomers();
                    showSuccessModal('Customer Deleted!', `"${customerName}" has been removed.`);
                } else {
                    showStatus('customersStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                }
            } finally {
                hideLoading();
            }
        }

        // ==================== PURCHASES ====================

        function showAddPurchaseForm() {
            // Reset form first
            document.querySelector('#addPurchaseForm form').reset();
            
            const form = document.getElementById('addPurchaseForm');
            
            loadPurchaseDropdowns();
            form.style.display = 'block';
            
            // Re-enable selects that were disabled at startup
            form.querySelectorAll('select').forEach(sel => {
                sel.disabled = false;
                sel.style.pointerEvents = '';
            });
            
            // Auto-populate today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('poDate').value = today;
            
            // Reset to default "Ordering" type
            setPurchaseType('ordering');
            // Attach event listeners to initial line items
            attachPOLineItemListeners();
            // Reset invoice total
            document.getElementById('poTotal').value = '0.00';
        }
        
        function attachPOLineItemListeners() {
            // Attach listeners to all existing PO line items
            document.querySelectorAll('#poLineItems .line-item-row').forEach(row => {
                const itemSelect = row.querySelector('.po-item');
                const qtyInput = row.querySelector('.po-qty');
                const removeBtn = row.querySelector('.remove-btn');
                
                if (itemSelect && !itemSelect.dataset.listenersAttached) {
                    itemSelect.addEventListener('change', function() {
                        updatePOItemInfo(this);
                    });
                    itemSelect.dataset.listenersAttached = 'true';
                }
                
                if (qtyInput && !qtyInput.dataset.listenersAttached) {
                    qtyInput.addEventListener('input', function() {
                        updatePOLineDisplay(this);
                        calculatePOTotal();
                    });
                    qtyInput.dataset.listenersAttached = 'true';
                }
                
                if (removeBtn && !removeBtn.dataset.listenersAttached) {
                    removeBtn.addEventListener('click', function() {
                        removeLineItem(this);
                        calculatePOTotal();
                    });
                    removeBtn.dataset.listenersAttached = 'true';
                }
            });
        }

        function hideAddPurchaseForm() {
            document.getElementById('addPurchaseForm').style.display = 'none';
            document.querySelector('#addPurchaseForm form').reset();
            
            // Reset save button
            const saveBtn = document.getElementById('savePOBtn');
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = ' Create Purchase Order';
            }
            
            // Reset PO preview confirm button
            const confirmBtn = document.getElementById('poConfirmSaveBtn');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = ' Confirm & Save';
            }
        }
        
        function setPurchaseType(type) {
            const orderingLabel = document.getElementById('poTypeOrdering');
            const receivedLabel = document.getElementById('poTypeReceived');
            const dueDateGroup = document.getElementById('poDueDateGroup');
            const dateLabel = document.getElementById('poDateLabel');
            const statusHidden = document.getElementById('poStatus');
            const statusDisplay = document.getElementById('poStatus_display');
            const paymentTermsHidden = document.getElementById('poPaymentTerms');
            const paymentTermsDisplay = document.getElementById('poPaymentTerms_display');
            
            if (type === 'ordering') {
                // Placing an order - items coming later
                orderingLabel.style.border = '3px solid #3b82f6';
                orderingLabel.style.background = '#eff6ff';
                receivedLabel.style.border = '3px solid #e5e7eb';
                receivedLabel.style.background = 'white';
                orderingLabel.querySelector('input').checked = true;
                
                // Show expected delivery date and make required
                dueDateGroup.style.display = 'block';
                const dueDateInput = document.getElementById('poDueDate');
                if (dueDateInput) dueDateInput.setAttribute('required', 'required');
                dateLabel.textContent = 'Order Date *';
                
                // Set status to Ordered
                statusHidden.value = 'Ordered';
                if (statusDisplay) statusDisplay.value = ' Ordered - Sent to supplier';
                
                // Set payment terms to Net 30 (default for orders)
                if (paymentTermsHidden) paymentTermsHidden.value = 'Net 30';
                if (paymentTermsDisplay) paymentTermsDisplay.value = ' Net 30 - Due in 30 days';
                
            } else {
                // Already received - have items now
                receivedLabel.style.border = '3px solid #6b9a8d';
                receivedLabel.style.background = '#f0fdf4';
                orderingLabel.style.border = '3px solid #e5e7eb';
                orderingLabel.style.background = 'white';
                receivedLabel.querySelector('input').checked = true;
                
                // Hide expected delivery date (not needed) and remove required
                dueDateGroup.style.display = 'none';
                const dueDateInput = document.getElementById('poDueDate');
                if (dueDateInput) {
                    dueDateInput.removeAttribute('required');
                    // Set due date to match purchase date (items already received)
                    const purchaseDate = document.getElementById('poDate')?.value;
                    if (purchaseDate) {
                        dueDateInput.value = purchaseDate;
                    }
                }
                dateLabel.textContent = 'Purchase Date *';
                
                // Set status to Received
                statusHidden.value = 'Received';
                if (statusDisplay) statusDisplay.value = ' Received - All items received';
                
                // Set payment terms to COD (paid at pickup)
                if (paymentTermsHidden) paymentTermsHidden.value = 'COD';
                if (paymentTermsDisplay) paymentTermsDisplay.value = ' COD - Paid at pickup';
            }
        }
        
        // Sync due date with purchase date when "Already Received" is selected
        function syncDueDateIfReceived() {
            const purchaseType = document.querySelector('input[name="purchaseType"]:checked')?.value;
            if (purchaseType === 'received') {
                const purchaseDate = document.getElementById('poDate')?.value;
                const dueDateInput = document.getElementById('poDueDate');
                if (purchaseDate && dueDateInput) {
                    dueDateInput.value = purchaseDate;
                }
            }
        }

        async function loadPurchaseDropdowns() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }

            const select = document.getElementById('poSupplier');
            select.innerHTML = '<option value="">Select Supplier</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }

        async function loadSupplierItems() {
            const supplierId = document.getElementById('poSupplier').value;
            
            if (!supplierId) {
                // No supplier selected - disable all line item controls
                document.querySelectorAll('#poLineItems .po-item').forEach(select => {
                    select.disabled = true;
                    select.style.border = '2px solid #ccc';
                    select.style.background = '#f5f5f5';
                    select.innerHTML = '<option value=""> Select Supplier First</option>';
                });
                document.querySelectorAll('#poLineItems .po-qty').forEach(input => {
                    input.disabled = true;
                });
                // Disable eaches checkboxes
                document.querySelectorAll('#poLineItems .po-eaches').forEach(checkbox => {
                    checkbox.disabled = true;
                    const label = checkbox.closest('.eaches-toggle');
                    if (label) {
                        label.style.cursor = 'not-allowed';
                        label.style.background = '#ccc';
                        label.style.opacity = '0.5';
                        label.title = 'Select supplier first';
                    }
                });
                return;
            }
            
            if (cachedItems.length === 0) {
                const result = await apiCall('getItems');
                if (result && result.status === 'success') {
                    cachedItems = result.data;
                }
            }

            // Filter to supplier's active items only
            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId && item.Status !== 'Archived');
            
            // Enable and populate all PO item dropdowns
            document.querySelectorAll('#poLineItems .po-item').forEach(select => {
                select.disabled = false;
                select.style.border = '2px solid var(--primary, #667eea)';
                select.style.background = 'white';
                select.innerHTML = '<option value="">Select Item</option>';
                supplierItems.forEach(item => {
                    const packageCost = parseFloat(item.Package_Cost) || 0;
                    const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                    select.innerHTML += `<option value="${item.Item_ID}" data-cost="${packageCost.toFixed(2)}" data-units="${unitsPerPackage}">${item.Item_Description}</option>`;
                });
            });
            
            // Enable quantity inputs
            document.querySelectorAll('#poLineItems .po-qty').forEach(input => {
                input.disabled = false;
            });
            
            // Enable eaches checkboxes
            document.querySelectorAll('#poLineItems .po-eaches').forEach(checkbox => {
                checkbox.disabled = false;
                const label = checkbox.closest('.eaches-toggle');
                if (label) {
                    label.style.cursor = 'pointer';
                    label.style.background = '#e0e0e0';
                    label.style.opacity = '1';
                    label.title = 'Toggle to buy individual units instead of cases';
                }
            });
        }

        function addPOLineItem() {
            const container = document.getElementById('poLineItems');
            const supplierId = document.getElementById('poSupplier').value;
            
            if (!supplierId) {
                showWarning('Please select a supplier first');
                return;
            }
            
            // Get supplier items once
            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId && item.Status !== 'Archived');
            
            const newRow = document.createElement('div');
            newRow.className = 'line-item-row';
            newRow.dataset.eaches = 'false';
            newRow.style.cssText = 'display: grid; grid-template-columns: 2.2fr 0.6fr 0.9fr 0.5fr 0.7fr 0.8fr 0.8fr 45px; gap: 8px; margin-bottom: 10px; align-items: end;';
            newRow.innerHTML = `
                <div>
                    <select class="po-item" style="width: 100%; padding: 14px 12px; border: 2px solid var(--primary, #667eea); border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white;" required>
                        <option value="">Select item...</option>
                        ${supplierItems.map(item => `<option value="${item.Item_ID}" data-units="${item.Units_Per_Package || 1}" data-cost="${item.Package_Cost || 0}" data-uom="${item.Purchase_UOM || 'Case'}">${item.Item_Description}</option>`).join('')}
                    </select>
                </div>
                <div style="text-align: center;">
                    <label class="eaches-toggle" style="display: inline-flex; align-items: center; justify-content: center; cursor: pointer; background: #e0e0e0; padding: 12px; border-radius: 8px; min-height: 52px; width: 100%; box-sizing: border-box;" title="Toggle to buy individual units instead of cases">
                        <input type="checkbox" class="po-eaches" style="width: 20px; height: 20px; cursor: pointer;">
                    </label>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 11px; text-align: center;" class="po-qty-label"> Cases</label>
                    <input type="number" class="po-qty" placeholder="0" min="1" style="width: 100%; padding: 14px 8px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 18px; font-weight: bold; background: #fffde7; min-height: 52px;" required>
                </div>
                <div>
                    <div class="po-units" style="text-align: center; font-size: 13px; color: #666; padding: 6px;">-</div>
                </div>
                <div>
                    <div class="po-totalunits" style="text-align: center; font-size: 14px; font-weight: bold; color: var(--primary, #667eea); padding: 6px;">-</div>
                </div>
                <div>
                    <div class="po-cost-display" style="text-align: center; font-size: 12px; font-weight: bold; color: #6b9a8d; background: #e8f5e9; padding: 8px; border-radius: 6px;">-</div>
                    <input type="number" class="po-cost-input" step="0.01" min="0" style="display: none; width: 100%; padding: 8px 4px; border: 2px solid #9333ea; border-radius: 6px; text-align: center; font-size: 14px; font-weight: bold; background: #f3e8ff; color: #9333ea;" placeholder="0.00">
                </div>
                <div>
                    <div class="po-linetotal" style="text-align: right; font-size: 12px; font-weight: bold; color: var(--primary, #667eea); background: var(--primary-light, #E3F2FD); padding: 8px; border-radius: 6px;">$0.00</div>
                </div>
                <button type="button" class="remove-btn btn-danger" style="width: 100%; padding: 8px; font-size: 14px;"></button>
            `;
            container.appendChild(newRow);
            
            // Attach event listeners programmatically (CSP-safe)
            const itemSelect = newRow.querySelector('.po-item');
            const qtyInput = newRow.querySelector('.po-qty');
            const removeBtn = newRow.querySelector('.remove-btn');
            const eachesCheckbox = newRow.querySelector('.po-eaches');
            const costInput = newRow.querySelector('.po-cost-input');
            
            itemSelect.addEventListener('change', function() {
                updatePOItemInfo(this);
            });
            
            qtyInput.addEventListener('input', function() {
                updatePOLineDisplay(this);
                calculatePOTotal();
            });
            
            removeBtn.addEventListener('click', function() {
                removeLineItem(this);
                calculatePOTotal();
            });
            
            eachesCheckbox.addEventListener('change', function() {
                togglePOEaches(this);
            });
            
            costInput.addEventListener('input', function() {
                updatePOEachesCost(this);
            });
        }
        
        function updatePOItemInfo(selectElement) {
            const option = selectElement.options[selectElement.selectedIndex];
            const cost = parseFloat(option.getAttribute('data-cost')) || 0;
            const units = parseInt(option.getAttribute('data-units')) || 1;
            
            const row = selectElement.closest('.line-item-row');
            const unitsDiv = row.querySelector('.po-units');
            const costDisplay = row.querySelector('.po-cost-display');
            const costInput = row.querySelector('.po-cost-input');
            const isEaches = row.dataset.eaches === 'true';
            
            // Store base data on row for calculations
            row.dataset.packageCost = cost;
            row.dataset.unitsPerPackage = units;
            
            // Calculate unit cost for eaches mode
            const unitCostEach = units > 0 ? cost / units : 0;
            row.dataset.unitCostEach = unitCostEach;
            row.dataset.unitCostEachOriginal = unitCostEach; // Store original for reference
            
            if (unitsDiv) unitsDiv.textContent = units;
            
            // Show cost based on eaches mode
            if (isEaches) {
                row.dataset.unitCost = unitCostEach;
                if (costDisplay) costDisplay.style.display = 'none';
                if (costInput) {
                    costInput.style.display = 'block';
                    costInput.value = unitCostEach.toFixed(2);
                }
            } else {
                row.dataset.unitCost = cost;
                if (costDisplay) {
                    costDisplay.style.display = 'block';
                    costDisplay.innerHTML = cost > 0 ? `${formatMoney(cost)}<br><span style="font-size:10px;color:#666;">/case</span>` : '-';
                }
                if (costInput) costInput.style.display = 'none';
            }
            
            // Update line display
            const qtyInput = row.querySelector('.po-qty');
            if (qtyInput && qtyInput.value) {
                updatePOLineDisplay(qtyInput);
            }
            
            calculatePOTotal();
        }
        
        // Handle cost override input in eaches mode
        function updatePOEachesCost(costInput) {
            const row = costInput.closest('.line-item-row');
            const overrideCost = parseFloat(costInput.value) || 0;
            
            // Update the unit cost for eaches
            row.dataset.unitCostEach = overrideCost;
            row.dataset.unitCost = overrideCost;
            
            // Recalculate line total
            const qtyInput = row.querySelector('.po-qty');
            if (qtyInput) {
                updatePOLineDisplay(qtyInput);
            }
            calculatePOTotal();
        }
        
        function updatePOLineDisplay(qtyInput) {
            const row = qtyInput.closest('.line-item-row');
            const qty = parseInt(qtyInput.value) || 0;
            const unitsPerPackage = parseInt(row.dataset.unitsPerPackage) || parseInt(row.querySelector('.po-units')?.textContent) || 1;
            const isEaches = row.dataset.eaches === 'true';
            
            let totalUnits, lineTotal;
            
            if (isEaches) {
                // Eaches mode: qty is individual units, cost is per unit
                const unitCostEach = parseFloat(row.dataset.unitCostEach) || 0;
                totalUnits = qty; // qty is already in units
                lineTotal = qty * unitCostEach;
            } else {
                // Cases mode: qty is cases, cost is per case
                const packageCost = parseFloat(row.dataset.packageCost) || parseFloat(row.dataset.unitCost) || 0;
                totalUnits = qty * unitsPerPackage;
                lineTotal = qty * packageCost;
            }
            
            const totalUnitsDiv = row.querySelector('.po-totalunits');
            const lineTotalDiv = row.querySelector('.po-linetotal');
            const unitsDiv = row.querySelector('.po-units');
            
            if (totalUnitsDiv) totalUnitsDiv.textContent = qty > 0 ? totalUnits : '-';
            if (lineTotalDiv) lineTotalDiv.textContent = qty > 0 ? formatMoney(lineTotal) : '$0.00';
            
            // In eaches mode, show fractional cases as reference (e.g., "26 units = 1.08 cases")
            if (isEaches && unitsDiv && qty > 0 && unitsPerPackage > 0) {
                const fractionalCases = (qty / unitsPerPackage).toFixed(2);
                unitsDiv.innerHTML = `${unitsPerPackage}<br><span style="font-size:10px;color:#9333ea;">(${fractionalCases} cases)</span>`;
            } else if (unitsDiv) {
                unitsDiv.textContent = unitsPerPackage || '-';
            }
        }
        
        function togglePOEaches(checkbox) {
            const row = checkbox.closest('.line-item-row');
            const isEaches = checkbox.checked;
            row.dataset.eaches = isEaches ? 'true' : 'false';
            
            const qtyLabel = row.querySelector('.po-qty-label');
            const qtyInput = row.querySelector('.po-qty');
            const toggleLabel = checkbox.closest('.eaches-toggle');
            const costDisplay = row.querySelector('.po-cost-display');
            const costInput = row.querySelector('.po-cost-input');
            const unitsPerPackage = parseInt(row.dataset.unitsPerPackage) || 1;
            const packageCost = parseFloat(row.dataset.packageCost) || 0;
            const unitCostEach = parseFloat(row.dataset.unitCostEach) || (unitsPerPackage > 0 ? packageCost / unitsPerPackage : 0);
            
            if (isEaches) {
                // Switch to eaches mode
                if (qtyLabel) qtyLabel.innerHTML = ' Units';
                if (qtyInput) {
                    qtyInput.style.borderColor = '#9333ea';
                    qtyInput.style.background = '#f3e8ff';
                    qtyInput.placeholder = 'Units';
                }
                if (toggleLabel) {
                    toggleLabel.style.background = '#9333ea';
                    toggleLabel.innerHTML = '<input type="checkbox" class="po-eaches" style="width: 20px; height: 20px; cursor: pointer;" checked><span style="color:white;font-size:10px;margin-left:4px;"></span>';
                    toggleLabel.querySelector('.po-eaches').addEventListener('change', function() { togglePOEaches(this); });
                }
                // Show editable cost input, hide display
                if (costDisplay) costDisplay.style.display = 'none';
                if (costInput) {
                    costInput.style.display = 'block';
                    costInput.value = unitCostEach.toFixed(2);
                    // Add event listener if not already added
                    if (!costInput.dataset.listenerAdded) {
                        costInput.addEventListener('input', function() { updatePOEachesCost(this); });
                        costInput.dataset.listenerAdded = 'true';
                    }
                }
                row.dataset.unitCost = unitCostEach;
            } else {
                // Switch to cases mode
                if (qtyLabel) qtyLabel.innerHTML = ' Cases';
                if (qtyInput) {
                    qtyInput.style.borderColor = '#f9a825';
                    qtyInput.style.background = '#fffde7';
                    qtyInput.placeholder = '0';
                }
                if (toggleLabel) {
                    toggleLabel.style.background = '#e0e0e0';
                    toggleLabel.innerHTML = '<input type="checkbox" class="po-eaches" style="width: 20px; height: 20px; cursor: pointer;">';
                    toggleLabel.querySelector('.po-eaches').addEventListener('change', function() { togglePOEaches(this); });
                }
                // Show cost display, hide input
                if (costDisplay) {
                    costDisplay.style.display = 'block';
                    if (packageCost > 0) {
                        costDisplay.innerHTML = `${formatMoney(packageCost)}<br><span style="font-size:10px;color:#666;">/case</span>`;
                    }
                }
                if (costInput) costInput.style.display = 'none';
                row.dataset.unitCost = packageCost;
            }
            
            // Recalculate line display
            if (qtyInput && qtyInput.value) {
                updatePOLineDisplay(qtyInput);
            }
            calculatePOTotal();
        }
        
        function showPOPreview() {
            // ===== VALIDATION =====
            const missingFields = [];
            
            // Check supplier
            const supplierSelect = document.getElementById('poSupplier');
            const supplierId = supplierSelect?.value;
            const supplierName = supplierSelect?.options[supplierSelect.selectedIndex]?.text || 'Supplier';
            
            if (!supplierId) {
                missingFields.push(' Supplier');
            }
            
            // Check purchase date
            const poDate = document.getElementById('poDate')?.value;
            if (!poDate) {
                missingFields.push(' Order/Purchase Date');
            }
            
            // Get purchase type
            const purchaseType = document.querySelector('input[name="purchaseType"]:checked')?.value || 'ordering';
            const typeLabel = purchaseType === 'ordering' ? ' Placing Order' : ' Already Received';
            
            // Check due date (only for ordering type)
            const poDueDate = document.getElementById('poDueDate')?.value;
            if (purchaseType === 'ordering' && !poDueDate) {
                missingFields.push(' Expected Delivery Date');
            }
            
            // Get line items
            const lineItems = [];
            let totalCases = 0;
            let totalUnits = 0;
            let looseUnits = 0;
            let totalAmount = 0;
            
            document.querySelectorAll('#poLineItems .line-item-row').forEach(row => {
                const itemSelect = row.querySelector('.po-item');
                const itemId = itemSelect?.value;
                const itemName = itemSelect?.options[itemSelect.selectedIndex]?.text || '';
                const qty = parseInt(row.querySelector('.po-qty')?.value) || 0;
                const isEaches = row.dataset.eaches === 'true';
                const unitsPerPackage = parseInt(row.dataset.unitsPerPackage) || 1;
                
                let cost, lineTotal, displayQty;
                
                if (isEaches) {
                    // Eaches mode: qty is individual units
                    cost = parseFloat(row.dataset.unitCostEach) || 0;
                    lineTotal = qty * cost;
                    displayQty = `${qty} units`;
                    looseUnits += qty;
                    totalUnits += qty;
                } else {
                    // Cases mode: qty is cases
                    cost = parseFloat(row.dataset.packageCost) || parseFloat(row.dataset.unitCost) || 0;
                    lineTotal = qty * cost;
                    displayQty = `${qty}`;
                    totalCases += qty;
                    totalUnits += qty * unitsPerPackage;
                }
                
                if (itemId && qty > 0) {
                    // Get item details from cache
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    lineItems.push({
                        name: item?.Item_Description || itemName,
                        sku: item?.SKU || '',
                        qty: qty,
                        displayQty: displayQty,
                        cost: cost,
                        total: lineTotal,
                        isEaches: isEaches
                    });
                    totalAmount += lineTotal;
                }
            });
            
            if (lineItems.length === 0) {
                missingFields.push(' At least one line item with quantity');
            }
            
            // Show validation errors if any
            if (missingFields.length > 0) {
                showWarning(`Please complete the following required fields:\n\n${missingFields.join('\n')}`);
                return;
            }
            
            // Get payment terms
            const paymentTerms = document.getElementById('poPaymentTerms')?.value || 'Net 30';
            
            // Build preview HTML
            let html = `
                <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eee;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 4px;">Supplier</div>
                            <div style="font-size: 18px; font-weight: 600; color: #7c3aed;">${supplierName}</div>
                        </div>
                        <div style="background: ${purchaseType === 'ordering' ? '#dbeafe' : '#dcfce7'}; color: ${purchaseType === 'ordering' ? '#1d4ed8' : '#15803d'}; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                            ${typeLabel}
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #666;">Payment Terms: <strong>${paymentTerms}</strong></div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 13px; color: #666; margin-bottom: 10px; font-weight: 600;">ORDER ITEMS</div>
            `;
            
            lineItems.forEach((item, index) => {
                const qtyStyle = item.isEaches ? 'color: #9333ea; font-weight: 600;' : '';
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${index % 2 === 0 ? '#f8fafc' : 'white'}; border-radius: 8px; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333;">${item.name}</div>
                            <div style="font-size: 12px; color: #666;">${item.sku}  <span style="${qtyStyle}">${item.displayQty}</span>  ${formatMoney(item.cost)}</div>
                        </div>
                        <div style="font-weight: 700; color: #7c3aed; font-size: 16px;">${formatMoney(item.total)}</div>
                    </div>
                `;
            });
            
            // Build cases display
            let casesDisplay = '';
            if (totalCases > 0 && looseUnits > 0) {
                casesDisplay = `${totalCases}<br><span style="font-size:11px;">+ ${looseUnits} loose</span>`;
            } else if (looseUnits > 0) {
                casesDisplay = `<span style="font-size:16px;">${looseUnits} loose</span>`;
            } else {
                casesDisplay = totalCases;
            }
            
            html += `
                </div>
                
                <!-- Colorful Summary Boxes -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px;">
                    <div style="text-align: center; padding: 15px 10px; background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); border-radius: 10px; border: 2px solid #7a9bb8;">
                        <div style="font-size: 12px; color: #5a7a8a; margin-bottom: 4px; font-weight: 600;">Cases</div>
                        <div style="font-size: 24px; font-weight: bold; color: #7a9bb8;">${casesDisplay}</div>
                    </div>
                    <div style="text-align: center; padding: 15px 10px; background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); border-radius: 10px; border: 2px solid #b8a86b;">
                        <div style="font-size: 12px; color: #8a7a4a; margin-bottom: 4px; font-weight: 600;">Units</div>
                        <div style="font-size: 24px; font-weight: bold; color: #b8a86b;">${totalUnits}</div>
                    </div>
                    <div style="text-align: center; padding: 15px 10px; background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); border-radius: 10px; border: 2px solid #6b9a8d;">
                        <div style="font-size: 12px; color: #5a7a6d; margin-bottom: 4px; font-weight: 600;">Total</div>
                        <div style="font-size: 24px; font-weight: bold; color: #6b9a8d;">${formatMoney(totalAmount)}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('poPreviewContent').innerHTML = html;
            document.getElementById('poPreviewModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function calculatePOTotal() {
            let totalCases = 0;
            let totalUnits = 0;
            let totalCost = 0;
            let looseUnits = 0; // Track units bought as eaches
            
            document.querySelectorAll('#poLineItems .line-item-row').forEach(row => {
                const qty = parseInt(row.querySelector('.po-qty')?.value) || 0;
                const unitsPerPackage = parseInt(row.dataset.unitsPerPackage) || parseInt(row.querySelector('.po-units')?.textContent) || 1;
                const isEaches = row.dataset.eaches === 'true';
                
                if (qty > 0) {
                    if (isEaches) {
                        // Eaches mode: qty is units, cost is per unit
                        const unitCostEach = parseFloat(row.dataset.unitCostEach) || 0;
                        totalUnits += qty;
                        looseUnits += qty;
                        totalCost += qty * unitCostEach;
                        // Don't add to cases - these are loose units
                    } else {
                        // Cases mode: qty is cases
                        const packageCost = parseFloat(row.dataset.packageCost) || parseFloat(row.dataset.unitCost) || 0;
                        totalCases += qty;
                        totalUnits += qty * unitsPerPackage;
                        totalCost += qty * packageCost;
                    }
                }
            });
            
            // Update hidden field for form submission
            const totalField = document.getElementById('poTotal');
            if (totalField) {
                totalField.value = totalCost.toFixed(2);
            }
            
            // Update Invoice Total display
            const totalDisplay = document.getElementById('poTotalDisplay');
            if (totalDisplay) {
                totalDisplay.textContent = formatMoney(totalCost);
            }
            
            // Update summary boxes
            const casesBox = document.getElementById('poTotalCases');
            const unitsBox = document.getElementById('poTotalUnits');
            const costBox = document.getElementById('poTotalCost');
            
            // Show cases + loose units if any
            if (casesBox) {
                if (looseUnits > 0 && totalCases > 0) {
                    casesBox.innerHTML = `${totalCases}<br><span style="font-size:12px;color:#9333ea;">+ ${looseUnits} loose</span>`;
                } else if (looseUnits > 0) {
                    casesBox.innerHTML = `<span style="color:#9333ea;">${looseUnits} loose</span>`;
                } else {
                    casesBox.textContent = totalCases;
                }
            }
            if (unitsBox) unitsBox.textContent = totalUnits;
            if (costBox) costBox.textContent = formatMoney(totalCost);
        }
        
        function calculatePOLine(qtyInput) {
            const row = qtyInput.closest('.line-item-row');
            if (!row) return;
            updatePOLineDisplay(qtyInput);
        }

        function removeLineItem(btn) {
            const row = btn.closest('.line-item-row');
            if (row) row.remove();
        }
        
        // Helper functions for PO form
        function clearPOForm() {
            document.querySelector('#addPurchaseForm form').reset();
            
            // Reset line items to single empty row
            const container = document.getElementById('poLineItems');
            const rows = container.querySelectorAll('.line-item-row');
            rows.forEach((row, i) => {
                if (i > 0) row.remove();
            });
            
            // Reset first row
            const firstRow = container.querySelector('.line-item-row');
            if (firstRow) {
                const select = firstRow.querySelector('.po-item');
                if (select) select.selectedIndex = 0;
                const qty = firstRow.querySelector('.po-qty');
                if (qty) qty.value = '';
                const units = firstRow.querySelector('.po-units');
                if (units) units.textContent = '-';
                const totalUnits = firstRow.querySelector('.po-totalunits');
                if (totalUnits) totalUnits.textContent = '-';
                const cost = firstRow.querySelector('.po-cost');
                if (cost) cost.textContent = '-';
                const lineTotal = firstRow.querySelector('.po-linetotal');
                if (lineTotal) lineTotal.textContent = '$0.00';
                delete firstRow.dataset.unitCost;
                delete firstRow.dataset.unitsPerPackage;
            }
            
            // Reset summary boxes
            document.getElementById('poTotalCases').textContent = '0';
            document.getElementById('poTotalUnits').textContent = '0';
            document.getElementById('poTotalCost').textContent = '$0.00';
            
            // Reset Invoice Total display
            const totalDisplay = document.getElementById('poTotalDisplay');
            if (totalDisplay) totalDisplay.textContent = '$0.00';
            
            // Reset to ordering type
            setPurchaseType('ordering');
            
            // Auto-populate today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('poDate').value = today;
        }
        
        function printPOWithoutSave() {
            // Validate at least one item
            const lineItems = [];
            document.querySelectorAll('#poLineItems .line-item-row').forEach(row => {
                const itemSelect = row.querySelector('.po-item');
                const itemId = itemSelect?.value;
                const qty = parseInt(row.querySelector('.po-qty')?.value) || 0;
                const isEaches = row.dataset.eaches === 'true';
                if (itemId && qty > 0) {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    const unitsPerPackage = parseInt(row.dataset.unitsPerPackage) || parseInt(item?.Units_Per_Package) || 1;
                    const unitCost = parseFloat(row.dataset.unitCost) || 0;
                    const totalUnits = isEaches ? qty : (qty * unitsPerPackage);
                    lineItems.push({
                        itemId: itemId,
                        description: item?.Item_Description || '',
                        sku: item?.SKU || '',
                        qty: qty,
                        isEaches: isEaches,
                        unitsPerCase: unitsPerPackage,
                        totalUnits: totalUnits,
                        cost: unitCost,
                        total: qty * unitCost
                    });
                }
            });
            
            if (lineItems.length === 0) {
                showWarning('Please add at least one item with quantity before printing.');
                return;
            }
            
            // Get form data
            const supplierSelect = document.getElementById('poSupplier');
            const supplierId = supplierSelect.value;
            const supplierName = supplierSelect.options[supplierSelect.selectedIndex]?.text || 'Unknown';
            const poDate = document.getElementById('poDate')?.value || new Date().toISOString().split('T')[0];
            
            // Get supplier details
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId) || {};
            
            // Generate printable PO with professional format
            generatePrintablePOFromForm(supplier, supplierName, poDate, lineItems);
        }
        
        function generatePrintablePOFromForm(supplier, supplierName, poDate, lineItems) {
            const settings = getInvoiceSettings();
            const themeColors = { primary: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#667eea' };
            const dateFormatted = new Date(poDate).toLocaleDateString().replace(/\//g, '-');
            const draftPONum = 'DRAFT-' + new Date().toISOString().slice(0,10).replace(/-/g, '');
            
            let total = 0;
            let totalCases = 0;
            let totalUnits = 0;
            
            lineItems.forEach(item => {
                total += item.total;
                if (!item.isEaches) totalCases += item.qty;
                totalUnits += item.totalUnits;
            });
            
            // Build email content
            const supplierEmail = supplier.Email || '';
            const itemsList = lineItems.map(item => 
                `${item.qty}${item.isEaches ? ' units' : ' cases'} - ${item.description} @ $${item.cost.toFixed(2)}${item.isEaches ? '/unit' : '/case'} = $${item.total.toFixed(2)}`
            ).join('\n');
            
            const emailSubject = encodeURIComponent(`Purchase Order ${draftPONum} from ${settings.companyName}`);
            const emailBody = encodeURIComponent(`Dear ${supplierName},

Please find our purchase order below:

${itemsList}
---
Total: $${total.toFixed(2)}

Please confirm receipt and expected delivery date.

Best regards,
${settings.companyName}
${settings.phone}
${settings.email}

---
NOTE: Please print or save the PO as PDF from the print preview and attach it to this email.`);
            
            let linesHtml = lineItems.map(item => `
                <tr>
                    <td style="border: 1px solid #e5e7eb; padding: 10px; font-size: 11pt;">${item.sku}</td>
                    <td style="border: 1px solid #e5e7eb; padding: 10px; font-size: 11pt;">${item.description}</td>
                    <td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-size: 11pt;">${item.isEaches ? '<span style="color:#9333ea;">'+item.qty+' units</span>' : item.qty}</td>
                    <td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-size: 11pt;">${item.unitsPerCase}</td>
                    <td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold; font-size: 11pt;">${item.totalUnits}</td>
                    <td style="border: 1px solid #e5e7eb; padding: 10px; text-align: right; font-size: 11pt;">$${item.cost.toFixed(2)}${item.isEaches ? '<span style="font-size:9pt;color:#666;">/ea</span>' : ''}</td>
                    <td style="border: 1px solid #e5e7eb; padding: 10px; text-align: right; font-size: 11pt;">$${item.total.toFixed(2)}</td>
                </tr>
            `).join('');
            
            const printWindow = window.open('', '_blank');
            const poHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${settings.companyName} - Purchase Order Draft - ${dateFormatted}</title>
    <style>
        @media print {
            @page { margin: 0.3in; }
            body { margin: 0; }
            .no-print { display: none !important; }
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="no-print" style="text-align: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <button onclick="window.print()" style="padding: 12px 24px; background: ${themeColors.primary}; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-right: 10px;"> Print</button>
        ${supplierEmail ? `<a href="mailto:${supplierEmail}?subject=${emailSubject}&body=${emailBody}" style="padding: 12px 24px; background: #6b9a8d; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-right: 10px; text-decoration: none; display: inline-block;"> Email Supplier</a>` : ''}
        <button onclick="window.close()" style="padding: 12px 24px; background: #8a8a8a; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;"> Close</button>
    </div>

    <div style="text-align: center; margin-bottom: 25px; border-bottom: 3px solid ${themeColors.primary}; padding-bottom: 20px;">
        <h1 style="color: ${themeColors.primary}; margin: 0; font-size: 28pt;">PURCHASE ORDER</h1>
        <p style="font-size: 14pt; margin: 8px 0;">${settings.companyName}</p>
        <p style="margin: 5px 0; color: #666;">Date: ${new Date(poDate).toLocaleDateString()}</p>
        <p style="margin: 5px 0; color: #999; font-style: italic;">* Draft - Not Yet Saved</p>
    </div>

    <div style="display: flex; justify-content: space-between; margin-bottom: 25px;">
        <div style="flex: 1;">
            <h3 style="color: ${themeColors.primary}; margin: 0 0 8px 0; font-size: 12pt;">From:</h3>
            <p style="margin: 3px 0; font-weight: bold;">${settings.companyName}</p>
            <p style="margin: 3px 0;">Phone: ${settings.phone}</p>
            <p style="margin: 3px 0;">Email: ${settings.email}</p>
        </div>
        <div style="flex: 1; text-align: right;">
            <h3 style="color: ${themeColors.primary}; margin: 0 0 8px 0; font-size: 12pt;">To:</h3>
            <p style="margin: 3px 0; font-weight: bold;">${supplierName}</p>
            ${supplier.Address ? `<p style="margin: 3px 0;">${supplier.Address}</p>` : ''}
            ${supplier.City || supplier.State ? `<p style="margin: 3px 0;">${supplier.City || ''}, ${supplier.State || ''} ${supplier.ZIP || ''}</p>` : ''}
            ${supplier.Phone ? `<p style="margin: 3px 0;">Phone: ${supplier.Phone}</p>` : ''}
            ${supplier.Email ? `<p style="margin: 3px 0;">Email: ${supplier.Email}</p>` : ''}
        </div>
    </div>

    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
        <thead>
            <tr style="background: ${themeColors.primary}; color: white;">
                <th style="padding: 12px; text-align: left; font-size: 11pt;">SKU</th>
                <th style="padding: 12px; text-align: left; font-size: 11pt;">Description</th>
                <th style="padding: 12px; text-align: center; font-size: 11pt;">Cases</th>
                <th style="padding: 12px; text-align: center; font-size: 11pt;">Units/Case</th>
                <th style="padding: 12px; text-align: center; font-size: 11pt;">Total Units</th>
                <th style="padding: 12px; text-align: right; font-size: 11pt;">Cost/Case</th>
                <th style="padding: 12px; text-align: right; font-size: 11pt;">Total</th>
            </tr>
        </thead>
        <tbody>
            ${linesHtml}
        </tbody>
    </table>

    <div style="text-align: right; margin-top: 20px;">
        <table style="margin-left: auto;">
            <tr>
                <td style="padding: 8px 20px; font-weight: bold; font-size: 14pt;">TOTAL:</td>
                <td style="padding: 8px 20px; font-weight: bold; font-size: 18pt; color: ${themeColors.primary};">$${total.toFixed(2)}</td>
            </tr>
        </table>
    </div>

    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 10pt;">
        <p>Thank you for your business!</p>
    </div>
</body>
</html>`;

            printWindow.document.write(poHTML);
            printWindow.document.close();
        }
        
        // Multi-item picker for main PO form
        function openMultiItemPickerForMainPO() {
            const supplierId = document.getElementById('poSupplier').value;
            if (!supplierId) {
                showWarning('Please select a supplier first');
                return;
            }
            
            // Reuse the existing multi-item picker but target main PO form
            window.multiItemPickerTarget = 'mainPO';
            openMultiItemPickerForPO();
        }
        
        let isSavingPO = false; // Prevent double-click
        
        async function addPurchase(e) {
            e.preventDefault();
            
            // Prevent double-click
            if (isSavingPO) {
                console.log('Already saving PO, ignoring duplicate click');
                return;
            }
            
            // ===== COMPREHENSIVE VALIDATION =====
            const missingFields = [];
            
            // Check supplier
            const supplierId = document.getElementById('poSupplier').value;
            if (!supplierId) {
                missingFields.push(' Supplier');
            }
            
            // Check purchase date
            const poDate = document.getElementById('poDate').value;
            if (!poDate) {
                missingFields.push(' Purchase/Order Date');
            }
            
            // Check purchase type and due date
            const purchaseType = document.querySelector('input[name="purchaseType"]:checked')?.value || 'ordering';
            const poDueDate = document.getElementById('poDueDate').value;
            if (purchaseType === 'ordering' && !poDueDate) {
                missingFields.push(' Expected Delivery Date');
            }
            
            // Check line items
            const lineItems = [];
            let calculatedTotal = 0;
            let hasIncompleteLines = false;
            
            document.querySelectorAll('#poLineItems .line-item-row').forEach((row, index) => {
                const itemId = row.querySelector('.po-item').value;
                const qty = parseInt(row.querySelector('.po-qty').value) || 0;
                const isEaches = row.dataset.eaches === 'true';
                const unitsPerPackage = parseInt(row.dataset.unitsPerPackage) || 1;
                
                let unitCost, lineTotal, quantityForBackend;
                
                if (isEaches) {
                    // Eaches mode: qty is individual units, cost is per unit
                    const unitCostEach = parseFloat(row.dataset.unitCostEach) || 0;
                    unitCost = unitCostEach;
                    lineTotal = qty * unitCostEach;
                    quantityForBackend = qty; // Send actual units
                } else {
                    // Cases mode: qty is cases, cost is per case
                    const packageCost = parseFloat(row.dataset.packageCost) || parseFloat(row.dataset.unitCost) || 0;
                    unitCost = packageCost;
                    lineTotal = qty * packageCost;
                    quantityForBackend = qty; // Send cases
                }
                
                if (itemId && qty > 0) {
                    // Get unitsPerPackage from the row data or item
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    const unitsPerPackage = parseInt(row.dataset.unitsPerPackage) || parseInt(item?.Units_Per_Package) || 1;
                    
                    lineItems.push({
                        itemId: itemId,
                        quantity: quantityForBackend,
                        unitCost: unitCost,
                        isEaches: isEaches,
                        unitsPerPackage: unitsPerPackage  // Store package size at time of purchase
                    });
                    calculatedTotal += lineTotal;
                } else if (itemId || qty > 0) {
                    // Partially filled line
                    hasIncompleteLines = true;
                }
            });
            
            if (lineItems.length === 0) {
                missingFields.push(' At least one complete line item (Item + Quantity)');
            }
            
            // Show validation errors if any
            if (missingFields.length > 0) {
                showWarning(`Please complete the following required fields:\n\n${missingFields.join('\n')}`);
                return;
            }
            
            if (hasIncompleteLines) {
                const continueAnyway = await showConfirmModal(
                    ' Incomplete Line Items',
                    '<p>Some line items are incomplete and will be ignored.</p><p>Do you want to continue with only the complete items?</p>',
                    'Continue',
                    'Go Back',
                    'warning'
                );
                if (!continueAnyway) return;
            }

            // ===== VALIDATION #1: Check for Duplicate Items =====
            const itemCounts = {};
            lineItems.forEach(line => {
                itemCounts[line.itemId] = (itemCounts[line.itemId] || 0) + 1;
            });
            
            const duplicates = Object.entries(itemCounts).filter(([id, count]) => count > 1);
            if (duplicates.length > 0) {
                // Find item names for the warning message
                const duplicateNames = duplicates.map(([itemId]) => {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    return item ? item.Item_Description : itemId;
                }).join(', ');
                
                const continueWithDupes = await showConfirmModal(
                    ' Duplicate Items Detected',
                    `<p>The following items appear on multiple lines:</p>
                    <p style="background: #f0e8d0; padding: 10px; border-radius: 6px; font-weight: 600;">${duplicateNames}</p>
                    <p>This may be intentional (different costs), but could also be a mistake.</p>`,
                    'Continue Anyway',
                    'Review Order',
                    'warning'
                );
                
                if (!continueWithDupes) return;
            }
            
            // ===== VALIDATION #2: Check for Overpayment =====
            const amountPaid = parseFloat(document.getElementById('poAmountPaid').value) || 0;
            if (amountPaid > calculatedTotal + 0.01) { // Allow 1 cent rounding
                const overpayment = amountPaid - calculatedTotal;
                const continueWithOverpay = await showConfirmModal(
                    ' Overpayment Warning',
                    `<div style="text-align: left;">
                        <p><strong>Order Total:</strong> ${formatMoney(calculatedTotal)}</p>
                        <p><strong>Amount Paid:</strong> ${formatMoney(amountPaid)}</p>
                        <p style="color: #b88a8a;"><strong>Overpayment:</strong> ${formatMoney(overpayment)}</p>
                        <p style="margin-top: 15px;">You are entering MORE payment than the order total.</p>
                    </div>`,
                    'Continue (Show Overpaid)',
                    'Correct Amount',
                    'warning'
                );
                
                if (!continueWithOverpay) return;
            }

            // Create proper datetime: combine selected date with current time
            const selectedPODate = document.getElementById('poDate').value;
            const nowPO = new Date();
            const timeStrPO = nowPO.toTimeString().split(' ')[0]; // HH:MM:SS
            const poDateTime = `${selectedPODate}T${timeStrPO}`; // YYYY-MM-DDTHH:MM:SS

            // Generate invoice number: PO-MMDDYY-###
            const poDateObj = new Date(selectedPODate + 'T12:00:00');
            const poMonth = String(poDateObj.getMonth() + 1).padStart(2, '0');
            const poDay = String(poDateObj.getDate()).padStart(2, '0');
            const poYear = String(poDateObj.getFullYear()).slice(-2);
            const poDateStr = `${poMonth}${poDay}${poYear}`;
            
            // Get all existing POs to find the next number for this date
            const existingPOsForNum = await apiCall('getPurchaseOrders');
            let nextPONumber = 1;
            
            if (existingPOsForNum && existingPOsForNum.data && existingPOsForNum.data.length > 0) {
                const poPrefix = `PO-${poDateStr}-`;
                const todayPONumbers = existingPOsForNum.data
                    .filter(po => po.Invoice_Number && po.Invoice_Number.startsWith(poPrefix))
                    .map(po => {
                        const parts = po.Invoice_Number.split('-');
                        return parseInt(parts[2]) || 0;
                    });
                
                if (todayPONumbers.length > 0) {
                    nextPONumber = Math.max(...todayPONumbers) + 1;
                }
            }
            
            const generatedPONumber = `PO-${poDateStr}-${String(nextPONumber).padStart(3, '0')}`;

            const data = {
                supplierId: document.getElementById('poSupplier').value,
                poDate: poDateTime,  // Full datetime format
                dueDate: document.getElementById('poDueDate').value || null,
                invoiceNumber: generatedPONumber,  // Auto-generated PO-MMDDYY-###
                paymentTerms: document.getElementById('poPaymentTerms').value,
                totalAmount: calculatedTotal,
                amountPaid: parseFloat(document.getElementById('poAmountPaid').value) || 0,
                status: document.getElementById('poStatus').value,
                notes: document.getElementById('poNotes').value,
                lineItems: lineItems,
                poType: 'INCOMING'
            };

            // Set saving flag and disable ALL form buttons
            isSavingPO = true;
            const submitBtn = document.getElementById('savePOBtn');
            const printBtn = document.querySelector('#addPurchaseForm button[onclick*="Print"]');
            const clearBtn = document.querySelector('#addPurchaseForm button[onclick*="clearPurchaseForm"], #addPurchaseForm button[onclick*="Clear"]');
            const cancelBtn = document.querySelector('#addPurchaseForm button[onclick*="hideAddPurchaseForm"]');
            
            const allPOFormBtns = [submitBtn, printBtn, clearBtn, cancelBtn].filter(b => b);
            allPOFormBtns.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            
            if (submitBtn) {
                submitBtn.innerHTML = ' Saving...';
            }

            showLoading('Creating Purchase Order...');

            try {
                const result = await apiCall('createPurchaseOrder', data);
                
                if (result && result.status === 'success') {
                    hideAddPurchaseForm();
                    loadPurchases();
                    showSuccessModal('Purchase Order Created!', `PO #: ${generatedPONumber}\n\nInventory has been updated.`);
                } else {
                    showStatus('purchasesStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                }
            } finally {
                // Always reset the flag and ALL buttons
                hideLoading();
                isSavingPO = false;
                allPOFormBtns.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                });
                if (submitBtn) {
                    submitBtn.innerHTML = ' Save Purchase Order';
                }
            }
        }

        let purchasesData = []; // Cache for filtering
        
        async function loadPurchases(forceRefresh = false) {
            const purchasesTable = document.getElementById('purchasesTable');
            if (purchasesTable) {
                purchasesTable.innerHTML = '<div class="loading">Loading purchases...</div>';
            }
            
            // Load suppliers FIRST if not cached
            if (cachedSuppliers.length === 0) {
                const suppResult = await apiCall('getSuppliers');
                if (suppResult && suppResult.status === 'success') {
                    cachedSuppliers = suppResult.data;
                } else {
                    console.error('Failed to load suppliers:', suppResult);
                }
            }
            
            // Now load and display purchases - add timestamp to bust caching if forced
            console.log('Calling getPurchaseOrders...');
            const result = await apiCall('getPurchaseOrders', forceRefresh ? { _t: Date.now() } : {});
            console.log('getPurchaseOrders result:', result);
            
            if (result && result.status === 'success') {
                purchasesData = result.data;
                if (purchasesTable) {
                    displayPurchases(result.data);
                    loadPurchaseFilterSuppliers(); // Populate filter dropdown
                }
                if (forceRefresh) {
                    showStatus('purchasesStatus', ' Purchases refreshed!', 'success');
                }
            } else {
                console.error('getPurchaseOrders failed:', result);
                const errorMsg = result?.message || 'Unknown error - check console';
                if (purchasesTable) {
                    purchasesTable.innerHTML = `<div class="loading">Error loading purchases: ${errorMsg}</div>`;
                }
            }
        }
        
        async function loadPurchaseFilterSuppliers() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }
            
            const select = document.getElementById('filterPurchaseSupplier');
            select.innerHTML = '<option value="">All Suppliers</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }
        
        function filterPurchases() {
            const poFilter = document.getElementById('filterPurchasePO').value.toLowerCase();
            const supplierFilter = document.getElementById('filterPurchaseSupplier').value;
            const statusFilter = document.getElementById('filterPurchaseStatus').value;
            const dateFrom = document.getElementById('filterPurchaseDateFrom').value;
            const dateTo = document.getElementById('filterPurchaseDateTo').value;
            const paymentStatusFilter = document.getElementById('filterPurchasePaymentStatus').value;
            
            const filtered = purchasesData.filter(po => {
                const matchesPO = !poFilter || 
                    (po.PO_ID && po.PO_ID.toLowerCase().includes(poFilter)) ||
                    (po.Invoice_Number && po.Invoice_Number.toLowerCase().includes(poFilter));
                // Use matchesFilter for multi-select support
                const matchesSupplier = matchesFilter(po.Supplier_ID, supplierFilter);
                
                // Handle exclude-voided option
                let matchesStatus = true;
                if (statusFilter === 'exclude-voided') {
                    matchesStatus = po.Status !== 'Voided';
                } else if (statusFilter) {
                    matchesStatus = po.Status === statusFilter;
                }
                
                const poDate = new Date(po.PO_Date);
                
                // Date FROM comparison (start of day) - use global parseLocalDate helper
                let matchesDateFrom = true;
                if (dateFrom) {
                    const fromDateObj = parseLocalDate(dateFrom);
                    fromDateObj.setHours(0, 0, 0, 0);
                    matchesDateFrom = poDate >= fromDateObj;
                }
                
                // Date TO comparison (end of day - 23:59:59)
                let matchesDateTo = true;
                if (dateTo) {
                    const toDateObj = parseLocalDate(dateTo);
                    toDateObj.setHours(23, 59, 59, 999);
                    matchesDateTo = poDate <= toDateObj;
                }
                
                const matchesPaymentStatus = !paymentStatusFilter || (po.Payment_Status === paymentStatusFilter);
                return matchesPO && matchesSupplier && matchesStatus && matchesDateFrom && matchesDateTo && matchesPaymentStatus;
            });
            
            displayPurchases(filtered);
        }
        
        function clearPurchaseFilters() {
            document.getElementById('filterPurchasePO').value = '';
            document.getElementById('filterPurchasePO_display').value = '';  // Clear display input too
            document.getElementById('filterPurchaseSupplier').value = '';
            document.getElementById('filterPurchaseStatus').value = '';
            document.getElementById('filterPurchaseDateFrom').value = '';
            document.getElementById('filterPurchaseDateTo').value = '';
            document.getElementById('filterPurchasePaymentStatus').value = '';
            selectedPOsForPurchases = [];  // Reset the selection array
            displayPurchases(purchasesData);
        }
        
        let activePurchaseFilter = 'all'; // Track active filter
        
        function applyPurchasesDateFilter(period, evt) {
            console.log('Purchase date filter clicked:', period);
            activePurchaseFilter = period; // Track active filter
            
            const now = new Date();
            let fromDate = null;
            let toDate = null;
            
            switch(period) {
                case 'today':
                    fromDate = new Date(now);
                    toDate = new Date(now);
                    break;
                case 'week':
                    fromDate = new Date(now);
                    fromDate.setDate(now.getDate() - 7);
                    break;
                case '3months':
                    fromDate = new Date(now);
                    fromDate.setMonth(now.getMonth() - 3);
                    break;
                case '6months':
                    fromDate = new Date(now);
                    fromDate.setMonth(now.getMonth() - 6);
                    break;
                case '9months':
                    fromDate = new Date(now);
                    fromDate.setMonth(now.getMonth() - 9);
                    break;
                case 'ytd':
                    fromDate = new Date(now.getFullYear(), 0, 1);
                    break;
                case '1year':
                    fromDate = new Date(now);
                    fromDate.setFullYear(now.getFullYear() - 1);
                    break;
                case '3years':
                    fromDate = new Date(now);
                    fromDate.setFullYear(now.getFullYear() - 3);
                    break;
                case '5years':
                    fromDate = new Date(now);
                    fromDate.setFullYear(now.getFullYear() - 5);
                    break;
                case 'all':
                    document.getElementById('filterPurchaseDateFrom').value = '';
                    document.getElementById('filterPurchaseDateTo').value = '';
                    filterPurchases();
                    updatePurchaseFilterButtons(period);
                    return;
            }
            
            const fromDateStr = fromDate ? formatLocalDate(fromDate) : '';
            const toDateStr = toDate ? formatLocalDate(toDate) : '';
            
            document.getElementById('filterPurchaseDateFrom').value = fromDateStr;
            document.getElementById('filterPurchaseDateTo').value = toDateStr;
            
            filterPurchases();
            updatePurchaseFilterButtons(period);
        }
        
        function updatePurchaseFilterButtons(activePeriod) {
            setTimeout(() => {
                document.querySelectorAll('.oval-filter-btn-po').forEach(btn => {
                    const onclick = btn.getAttribute('onclick') || '';
                    const isActive = onclick.includes(`'${activePeriod}'`);
                    btn.style.opacity = isActive ? '1' : '0.6';
                    btn.style.transform = isActive ? 'scale(1.05)' : 'scale(1)';
                    btn.style.boxShadow = isActive ? '0 4px 12px rgba(0,0,0,0.3)' : '0 2px 4px rgba(0,0,0,0.1)';
                });
            }, 50);
        }

        function displayPurchases(orders) {
            if (!orders || orders.length === 0) {
                document.getElementById('purchasesTable').innerHTML = '<p>No purchase orders yet. Record your first purchase!</p>';
                return;
            }

            // Calculate totals first
            let totalAmount = 0;
            let totalPaid = 0;
            
            orders.forEach(po => {
                totalAmount += parseFloat(po.Total_Amount || po.Invoice_Total) || 0;
                totalPaid += parseFloat(po.Amount_Paid) || 0;
            });
            const balance = totalAmount - totalPaid;
            
            // Date filter buttons (matching Sales page style) - Muted Professional Colors
            let html = `
                <div class="purchases-data-card">
                    <!-- Oval Buttons - Date filters -->
                    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 20px;">
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; padding-bottom: 10px;">
                            <button onclick="applyPurchasesDateFilter('today', event)" class="oval-filter-btn-po" style="background: #f5f5f5; color: #666; border: 2px solid #999; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 Last Day
                            </button>
                            <button onclick="applyPurchasesDateFilter('week', event)" class="oval-filter-btn-po" style="background: #f5f0e0; color: #8a7a4a; border: 2px solid #b8a86b; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 Last Week
                            </button>
                            <button onclick="applyPurchasesDateFilter('3months', event)" class="oval-filter-btn-po" style="background: #f5f0e0; color: #8a7a4a; border: 2px solid #b8a86b; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 Last 3 Months
                            </button>
                            <button onclick="applyPurchasesDateFilter('6months', event)" class="oval-filter-btn-po" style="background: #e8f0e8; color: #5a7a6d; border: 2px solid #6b9a8d; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 6 Months
                            </button>
                            <button onclick="applyPurchasesDateFilter('9months', event)" class="oval-filter-btn-po" style="background: #e8f0f5; color: #5a7a8a; border: 2px solid #7a9bb8; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 9 Months
                            </button>
                            <button onclick="applyPurchasesDateFilter('ytd', event)" class="oval-filter-btn-po" style="background: #f0e8f0; color: #7a6a8a; border: 2px solid #9a8ab8; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 YTD
                            </button>
                            <button onclick="applyPurchasesDateFilter('1year', event)" class="oval-filter-btn-po" style="background: #f5eaea; color: #8a6a6a; border: 2px solid #b88a8a; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 1 Year
                            </button>
                            <button onclick="applyPurchasesDateFilter('3years', event)" class="oval-filter-btn-po" style="background: #e8f0f5; color: #5a7a8a; border: 2px solid #7a9bb8; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 3 Years
                            </button>
                            <button onclick="applyPurchasesDateFilter('5years', event)" class="oval-filter-btn-po" style="background: #e8f0e8; color: #5a7a6d; border: 2px solid #6b9a8d; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 5 Years
                            </button>
                            <button onclick="applyPurchasesDateFilter('all', event)" class="oval-filter-btn-po active" style="background: #4a5568; color: white; border: 2px solid #4a5568; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 All Time
                            </button>
                        </div>
                    </div>
            `;
            
            // Summary boxes - Muted Professional Colors
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="background: linear-gradient(135deg, #f5f0e0, #ede4cc); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #b8a86b;">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Total Purchases</div>
                        <div style="font-size: 28px; font-weight: bold; color: #b8a86b;">$${totalAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 12px; color: #888;">${orders.length} orders</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f0e8, #d4e8dc); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #6b9a8d;">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Paid</div>
                        <div style="font-size: 28px; font-weight: bold; color: #6b9a8d;">$${totalPaid.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 12px; color: #888;">${((totalPaid/totalAmount)*100 || 0).toFixed(0)}% paid</div>
                    </div>
                    <div style="background: linear-gradient(135deg, ${balance > 0 ? '#f5eaea, #edd8d8' : '#e8f0e8, #d4e8dc'}); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid ${balance > 0 ? '#b88a8a' : '#6b9a8d'};">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Outstanding</div>
                        <div style="font-size: 28px; font-weight: bold; color: ${balance > 0 ? '#b88a8a' : '#6b9a8d'};">$${balance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 12px; color: #888;">${balance > 0 ? 'to pay' : 'all paid!'}</div>
                    </div>
                </div>
            </div>
            `;
            
            html += '<div class="table-scroll-wrapper"><table class="data-table" id="purchasesDataTable"><thead><tr>';
            html += '<th>Invoice #</th><th>Supplier</th><th>PO Date</th><th>Total</th><th>Paid</th><th>Due Date</th><th>Paid Date</th><th>Payment</th><th>Status</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            orders.forEach(po => {
                const dueDate = formatDateSafe(po.Due_Date);
                const amountPaid = parseFloat(po.Amount_Paid) || 0;
                const total = parseFloat(po.Total_Amount || po.Invoice_Total) || 0;
                const poDateObj = parseDate(po.PO_Date);
                const sortableDate = poDateObj ? poDateObj.toISOString() : '';
                const dueDateObj = parseDate(po.Due_Date);
                const sortableDueDate = dueDateObj ? dueDateObj.toISOString().split('T')[0] : '';
                
                // Calculate payment status from actual amounts (not stored status)
                let paymentBadge = '';
                if (amountPaid > total + 0.01 && total > 0) {
                    paymentBadge = '<span style="background: #9333ea; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;"> Overpaid</span>';
                } else if (amountPaid >= total - 0.01 && total > 0) {
                    paymentBadge = '<span style="background: #6b9a8d; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Paid</span>';
                } else if (amountPaid > 0) {
                    paymentBadge = '<span style="background: #b8a86b; color: black; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Partial</span>';
                } else {
                    paymentBadge = '<span style="background: #b88a8a; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Unpaid</span>';
                }
                
                html += `<tr style="cursor: pointer;" onclick="viewPurchaseOrder('${po.PO_ID}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                    <td><strong>${po.Invoice_Number || po.PO_ID}</strong></td>
                    <td>${getSupplierName(po.Supplier_ID)}</td>
                    <td data-sort="${sortableDate}">${formatDateSafe(po.PO_Date)} <span style="color: #666;">${formatTimeSafe(po.PO_Date)}</span></td>
                    <td>${formatMoney(total)}</td>
                    <td>${formatMoney(amountPaid)}</td>
                    <td data-sort="${sortableDueDate}">${dueDate}</td>
                    <td data-sort="${po.Payment_Date ? new Date(po.Payment_Date).toISOString().split('T')[0] : ''}">${po.Payment_Date ? formatDateSafe(po.Payment_Date) : '-'}</td>
                    <td>${paymentBadge}</td>
                    <td><span style="background: ${po.Status === 'Ordered' ? '#b8a86b' : po.Status === 'In Transit' ? '#7aaab8' : po.Status === 'Void' || po.Status === 'Cancelled' || po.Status === 'Voided' ? '#b88a8a' : po.Status === 'Partial' ? '#b8a07a' : '#6b9a8d'}; color: ${po.Status === 'Ordered' ? 'black' : 'white'}; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${po.Status === 'Void' || po.Status === 'Voided' ? ' VOID' : po.Status === 'Cancelled' ? ' CANCELLED' : po.Status === 'Ordered' ? ' Ordered' : po.Status === 'In Transit' ? ' In Transit' : po.Status === 'Partial' ? ' Partial' : po.Status === 'Received' ? ' Received' : po.Status || 'Received'}</span></td>
                    <td onclick="event.stopPropagation();">
                        ${po.Status === 'Ordered' || po.Status === 'Partial' || po.Status === 'In Transit' ? `<button class="btn-small" onclick="receiveOutgoingPO('${po.PO_ID}')" style="background: #6b9a8d; color: white;"> Receive</button>` : ''}
                        ${po.Status === 'Void' || po.Status === 'Cancelled' || po.Status === 'Voided' ? `<button class="btn-small" onclick="duplicatePO('${po.PO_ID}')" style="background: #7aaab8; color: white;"> Copy to New PO</button>` : ''}
                    </td>
                </tr>`;
            });

            html += '</tbody></table></div>'; // Close table and scroll wrapper
            document.getElementById('purchasesTable').innerHTML = html;
            setTimeout(() => makeSortable('purchasesDataTable'), 0);
        }
        
        // Edit Purchase Order
        let currentEditingOrder = null;
        let currentEditingType = null; // 'purchase' or 'sales'
        let returnToTab = null; // Track which tab to return to after closing modal
        
        // View Purchase Order (from row click or button)
        function viewPurchaseOrder(poId) {
            const po = purchasesData.find(p => p.PO_ID === poId);
            if (po) {
                showPurchaseOrderDetails(po);
            }
        }
        
        async function editPurchaseOrder(poId) {
            // Find the PO in cached data or fetch it
            const result = await apiCall('getPurchaseOrders');
            if (result && result.status === 'success') {
                const po = result.data.find(p => p.PO_ID === poId);
                if (po) {
                    showPurchaseOrderDetails(po);
                }
            }
        }
        
        async function showPurchaseOrderDetails(po) {
            currentEditingOrder = po;
            currentEditingType = 'purchase';
            
            // Load items if not cached
            if (cachedItems.length === 0) {
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
            }
            
            // Get line items - try cache first, then fetch if empty
            let lines = getPurchaseLinesFromCache(po.PO_ID);
            if (lines.length === 0) {
                // Fetch lines directly from API
                const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
                if (linesResult?.data) {
                    lines = linesResult.data;
                    // Add to cache for future use
                    cachedPurchaseLines = cachedPurchaseLines.concat(lines);
                }
            }
            
            const supplierName = getSupplierName(po.Supplier_ID);
            const dueDate = po.Due_Date ? new Date(po.Due_Date).toLocaleDateString() : '-';
            const receiveDate = po.Receive_Date ? new Date(po.Receive_Date).toLocaleDateString() : '-';
            
            // Status color logic
            const statusColor = po.Status === 'Void' || po.Status === 'Cancelled' || po.Status === 'Voided' ? '#b88a8a' : 
                               po.Status === 'Ordered' ? '#b8a86b' : 
                               po.Status === 'In Transit' ? '#7aaab8' :
                               po.Status === 'Partial' ? '#b8a07a' : '#6b9a8d';
            const statusTextColor = po.Status === 'Ordered' ? '#000' : '#fff';
            const statusText = po.Status === 'Void' || po.Status === 'Voided' ? ' VOID' : 
                              po.Status === 'Cancelled' ? ' CANCELLED' : 
                              po.Status === 'Ordered' ? ' Ordered' :
                              po.Status === 'In Transit' ? ' In Transit' :
                              po.Status === 'Partial' ? ' Partial' :
                              po.Status === 'Received' ? ' Received' : po.Status;
            
            document.getElementById('modalTitle').textContent = `Purchase Order: ${po.PO_ID}`;
            
            let html = `
                <!-- Card 1: Order & Payment Information -->
                <div class="content-card" style="margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3 style="margin-top: 0; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 8px;"> Order Information</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 8px 0; font-weight: bold; width: 140px;">Supplier:</td><td>${supplierName}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Invoice #:</td><td>${po.Invoice_Number || '-'}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">PO Date:</td><td>${new Date(po.PO_Date).toLocaleDateString()}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Receive Date:</td><td>${receiveDate}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Due Date:</td><td>${dueDate}</td></tr>
                                ${po.Payment_Date ? `<tr><td style="padding: 8px 0; font-weight: bold;">Payment Date:</td><td style="color: #6b9a8d;">${new Date(po.Payment_Date).toLocaleDateString()}</td></tr>` : ''}
                                <tr><td style="padding: 8px 0; font-weight: bold;">Status:</td><td><span style="background: ${statusColor}; color: ${statusTextColor}; padding: 4px 12px; border-radius: 12px; font-size: 12px; border: 2px solid ${statusColor === '#6b9a8d' ? '#d0e0da' : '#dee2e6'};">${statusText}</span></td></tr>
                            </table>
                            ${po.Status === 'Ordered' || po.Status === 'In Transit' ? `
                            <div class="content-card" style="margin-top: 15px; background: #f0e8d0;">
                                <strong> Need to Cancel?</strong>
                                <p style="margin: 5px 0 10px 0; font-size: 13px; color: #666;">If this order needs to be cancelled or prices have changed, void this PO.</p>
                                <button class="btn" onclick="voidPurchaseOrder('${po.PO_ID}')" style="background: #b88a8a; padding: 6px 12px; font-size: 13px;">
                                     Void This PO
                                </button>
                            </div>
                            ` : ''}
                            ${po.Status === 'Void' || po.Status === 'Cancelled' || po.Status === 'Voided' ? `
                            <div class="content-card" style="margin-top: 15px; background: #e3f2fd;">
                                <strong> Need to Reorder?</strong>
                                <p style="margin: 5px 0 10px 0; font-size: 13px; color: #666;">Copy this PO's items to create a new order with current prices.</p>
                                <button class="btn" onclick="duplicatePO('${po.PO_ID}'); closeModal();" style="background: #7aaab8; padding: 6px 12px; font-size: 13px;">
                                     Copy to New PO
                                </button>
                            </div>
                            ` : ''}
                        </div>
                        <div>
                            <h3 style="margin-top: 0; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 8px;"> Payment Information</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 8px 0; font-weight: bold; width: 140px;">Total Amount:</td><td style="font-size: 18px; color: #2c3e50;">${formatMoney(parseFloat(po.Total_Amount || 0))}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Amount Paid:</td><td style="color: #6b9a8d;">${formatMoney(parseFloat(po.Amount_Paid || 0))}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Balance Due:</td><td style="color: #e74c3c; font-size: 16px; font-weight: bold;">$${(() => {
                                    const balance = parseFloat(po.Total_Amount || 0) - parseFloat(po.Amount_Paid || 0);
                                    return (Math.abs(balance) < 0.01 ? 0 : balance).toFixed(2);
                                })()}</td></tr>
                                ${po.Payment_Date ? `<tr><td style="padding: 8px 0; font-weight: bold;">Payment Date:</td><td style="color: #6b9a8d;">${new Date(po.Payment_Date).toLocaleDateString()}</td></tr>` : ''}
                                <tr><td style="padding: 8px 0; font-weight: bold;">Payment Status:</td><td><span style="background: ${po.Payment_Status === 'Paid' ? '#e0ebe7' : '#f0e8d0'}; color: ${po.Payment_Status === 'Paid' ? '#4a6b5f' : '#7a6b40'}; padding: 4px 12px; border-radius: 12px; font-size: 12px; border: 2px solid ${po.Payment_Status === 'Paid' ? '#d0e0da' : '#e8dfc0'};">${po.Payment_Status}</span></td></tr>
                            </table>
                            ${po.Payment_Status !== 'Paid' && po.Status !== 'Void' && po.Status !== 'Cancelled' && po.Status !== 'Voided' ? `
                            <div class="content-card" style="margin-top: 15px; background: #e8f5e9;">
                                <div style="margin-bottom: 10px;"><strong> Quick Payment</strong></div>
                                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                    <input type="number" id="quickPaymentAmount" step="0.01" min="0" 
                                           value="${(() => {
                                               const balance = parseFloat(po.Total_Amount || 0) - parseFloat(po.Amount_Paid || 0);
                                               return (Math.abs(balance) < 0.01 ? 0 : balance).toFixed(2);
                                           })()}"
                                           style="width: 120px; padding: 8px; border: 2px solid #d0e0da; border-radius: 4px;">
                                    <input type="date" id="quickPaymentDate" value="${getTodayLocalDate()}" 
                                           style="padding: 8px; border: 2px solid #d0e0da; border-radius: 4px;">
                                    <button class="btn" onclick="if(event && debounceButton(event.currentTarget)) recordQuickPOPayment('${po.PO_ID}')" 
                                            style="background: #6b9a8d; padding: 8px 15px;">
                                         Record Payment
                                    </button>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            if (lines.length > 0) {
                // Calculate receiving progress (using converted fractional cases for eaches)
                let totalOrdered = 0;
                let totalReceived = 0;
                lines.forEach(line => {
                    const converted = convertPOLineToDisplay(line, cachedItems);
                    totalOrdered += converted.displayQty;
                    const qtyReceivedRaw = parseFloat(line.Qty_Received) || 0;
                    totalReceived += converted.isEaches ? qtyReceivedRaw / converted.unitsPerPackage : qtyReceivedRaw;
                });
                const receivingProgress = totalOrdered > 0 ? Math.round((totalReceived / totalOrdered) * 100) : 0;
                const canReceive = po.Status === 'Ordered' || po.Status === 'Partial' || po.Status === 'In Transit';
                
                // Format totals for display (show 2 decimals if fractional)
                const totalOrderedDisplay = totalOrdered % 1 === 0 ? totalOrdered : totalOrdered.toFixed(2);
                const totalReceivedDisplay = totalReceived % 1 === 0 ? totalReceived : totalReceived.toFixed(2);
                
                html += `
                    <!-- Card 2: Line Items -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
                            <h3 style="color: #667eea; margin: 0; font-size: 18px;"> Line Items</h3>
                            ${canReceive ? `
                            <button class="btn" onclick="receiveOutgoingPO('${po.PO_ID}')" style="background: #6b9a8d; padding: 8px 16px;">
                                 Receive Items
                            </button>
                            ` : ''}
                        </div>
                        
                        ${totalReceived > 0 || po.Status === 'Partial' || po.Status === 'Received' ? `
                        <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #7a9bb8;">
                            <strong> Receiving Progress:</strong> ${totalReceivedDisplay} of ${totalOrderedDisplay} cases received (${receivingProgress}%)
                            <div style="background: #ddd; border-radius: 4px; height: 8px; margin-top: 8px; overflow: hidden;">
                                <div style="background: ${receivingProgress >= 100 ? '#6b9a8d' : '#7a9bb8'}; height: 100%; width: ${Math.min(receivingProgress, 100)}%;"></div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="overflow-x: auto;">
                        <table class="data-table" style="margin-bottom: 0; font-size: 14px;">
                            <thead>
                                <tr style="background: #667eea; color: white;">
                                    <th style="padding: 12px 15px;">Item</th>
                                    <th style="padding: 12px 15px;">Description</th>
                                    <th style="padding: 12px 15px; text-align: center;">Ordered</th>
                                    <th style="padding: 12px 15px; text-align: center;">Received</th>
                                    <th style="padding: 12px 15px; text-align: center;">Status</th>
                                    <th style="padding: 12px 15px; text-align: right;">Unit Cost</th>
                                    <th style="padding: 12px 15px; text-align: right;">Line Total</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                lines.forEach(line => {
                    const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                    const lineTotal = (parseFloat(line.Quantity) || 0) * (parseFloat(line.Unit_Cost) || 0);
                    const qtyOrdered = parseFloat(line.Quantity) || 0;
                    const qtyReceived = parseFloat(line.Qty_Received) || 0;
                    
                    // Convert eaches to fractional cases for display
                    const converted = convertPOLineToDisplay(line, cachedItems);
                    const orderedDisplay = converted.isEaches 
                        ? `<span title="${converted.tooltip}" style="color: #9333ea; cursor: help;">${converted.displayQtyFormatted}</span>`
                        : qtyOrdered;
                    const costDisplay = converted.isEaches
                        ? `<span title="$${(parseFloat(line.Unit_Cost) || 0).toFixed(2)}/unit" style="color: #9333ea;">${formatMoney(converted.displayCost)}</span>`
                        : formatMoney(parseFloat(line.Unit_Cost || 0));
                    
                    // Convert received qty too if it's eaches
                    const receivedDisplay = qtyReceived > 0 
                        ? (converted.isEaches ? (qtyReceived / converted.unitsPerPackage).toFixed(2) : qtyReceived)
                        : '-';
                    
                    // Line status
                    let lineStatus, lineStatusBg;
                    if (qtyReceived >= qtyOrdered) {
                        lineStatus = ' Complete';
                        lineStatusBg = '#e0ebe7';
                    } else if (qtyReceived > 0) {
                        lineStatus = ' Partial';
                        lineStatusBg = '#f0e8d0';
                    } else {
                        lineStatus = ' Pending';
                        lineStatusBg = '#f8f9fa';
                    }
                    
                    html += `
                        <tr style="border-bottom: 1px solid #eee; background: ${lineStatusBg};">
                            <td style="padding: 12px 15px;"><strong>${item?.SKU || line.Item_ID}</strong></td>
                            <td style="padding: 12px 15px;">${item ? item.Item_Description : '-'}</td>
                            <td style="padding: 12px 15px; text-align: center; font-weight: bold;">${orderedDisplay}</td>
                            <td style="padding: 12px 15px; text-align: center; font-weight: bold; color: ${qtyReceived > 0 ? '#6b9a8d' : '#999'};">${receivedDisplay}</td>
                            <td style="padding: 12px 15px; text-align: center; font-size: 12px;">${lineStatus}</td>
                            <td style="padding: 12px 15px; text-align: right;">${costDisplay}</td>
                            <td style="padding: 12px 15px; text-align: right; font-weight: bold;">${formatMoney(lineTotal)}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                    </div>
                    </div>
                `;
            }
            
            if (po.Notes) {
                html += `
                    <!-- Card 3: Notes -->
                    <div class="content-card">
                        <h3 style="color: var(--primary, #667eea); margin-top: 0; margin-bottom: 10px; border-bottom: 2px solid #667eea; padding-bottom: 8px;"> Notes</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #e0e0e0;">
                            ${po.Notes}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalEditBtn').style.display = 'inline-block';
            document.getElementById('modalPrintBtn').style.display = 'inline-block';
            document.getElementById('modalPrintBtn').textContent = ' Print PO';
            document.getElementById('modalPrintBtn').onclick = () => printPurchaseOrder();
            document.getElementById('modalSaveBtn').style.display = 'none';
            document.getElementById('orderModal').style.display = 'block'; document.body.classList.add('modal-open');
        }
        
        async function recordQuickPOPayment(poId) {
            const paymentInput = document.getElementById('quickPaymentAmount');
            const paymentDateInput = document.getElementById('quickPaymentDate');
            const paymentAmount = parseFloat(paymentInput.value) || 0;
            const paymentDate = paymentDateInput?.value || getTodayLocalDate();
            
            if (paymentAmount <= 0) {
                showWarning('Please enter a payment amount greater than 0');
                return;
            }
            
            // Get current amount paid from the editing order
            const currentPaid = parseFloat(currentEditingOrder?.Amount_Paid) || 0;
            const newTotalPaid = currentPaid + paymentAmount;
            
            const result = await apiCall('recordPurchasePayment', {
                poId: poId,
                amountPaid: newTotalPaid,
                paymentDate: paymentDate
            });
            
            if (result && result.status === 'success') {
                const total = parseFloat(currentEditingOrder?.Total_Amount) || 0;
                const payStatus = newTotalPaid >= total - 0.01 ? 'Paid' : (newTotalPaid > 0 ? 'Partial' : 'Unpaid');
                
                // Update the current editing order with new payment info
                currentEditingOrder.Amount_Paid = newTotalPaid;
                currentEditingOrder.Payment_Status = payStatus;
                currentEditingOrder.Paid_Date = paymentDate;
                
                // Refresh the modal display with updated payment info
                viewPurchaseOrder(poId);
                
                // Refresh the purchases list in the background
                loadPurchases();
                
                // Show success message (modal stays open)
                showSuccessModal('Payment Recorded!', `Payment: ${formatMoney(paymentAmount)}\nTotal Paid: ${formatMoney(newTotalPaid)}\nStatus: ${payStatus}\n\nYou can now print the invoice or close when done.`);
            } else {
                showError('Error: ' + (result?.message || 'Unknown error'));
            }
        }
        
        // PRINT PURCHASE ORDER FUNCTION
        async function printPurchaseOrder() {
            if (!currentEditingOrder || currentEditingType !== 'purchase') {
                showWarning('Please select a purchase order first');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                showWarning('Please allow popups for this site');
                return;
            }
            printWindow.document.write('<html><body><h2>Loading PO...</h2></body></html>');
            
            const po = currentEditingOrder;
            const settings = getInvoiceSettings();
            
            // Get supplier details
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === po.Supplier_ID);
            
            // Get line items - try cache first, then fetch if empty
            let lines = getPurchaseLinesFromCache(po.PO_ID);
            if (lines.length === 0) {
                const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
                if (linesResult?.data) {
                    lines = linesResult.data;
                    cachedPurchaseLines = cachedPurchaseLines.concat(lines);
                }
            }
            
            // Calculate totals
            let subtotal = 0;
            lines.forEach(line => {
                subtotal += (parseFloat(line.Quantity) || 0) * (parseFloat(line.Unit_Cost) || 0);
            });
            
            const total = parseFloat(po.Total_Amount || subtotal);
            const paid = parseFloat(po.Amount_Paid || 0);
            const balance = total - paid;
            
            // Calculate actual payment status based on amounts
            let actualPaymentStatus = 'Unpaid';
            if (paid >= total && total > 0) {
                actualPaymentStatus = 'Paid';
            } else if (paid > 0) {
                actualPaymentStatus = 'Partial';
            }
            
            // Get theme colors for print
            const themeColors = getThemeColors();
            
            let poHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${settings.companyName} - PO ${po.Invoice_Number || po.PO_ID} - ${new Date(po.PO_Date).toLocaleDateString().replace(/\//g, '-')}</title>
    <style>
        @media print {
            @page { margin: 0.3in; }
            body { margin: 0; }
            .no-print { display: none; }
            /* Force header info to show on ALL print */
            .po-header p {
                display: block !important;
                visibility: visible !important;
            }
        }
        /* Mobile print styles - smaller fonts for phone printing */
        @media print and (max-width: 800px) {
            body {
                font-size: 8pt !important;
            }
            .po-header h1 {
                font-size: 14pt !important;
            }
            .po-header p {
                font-size: 8pt !important;
                margin: 2px 0 !important;
                display: block !important;
                visibility: visible !important;
            }
            .po-number {
                font-size: 10pt !important;
            }
            .po-info {
                flex-direction: column !important;
            }
            .info-box {
                width: 100% !important;
            }
            .info-box h3 {
                font-size: 9pt !important;
            }
            .info-box p {
                font-size: 8pt !important;
            }
            table.items th, table.items td {
                font-size: 8pt !important;
                padding: 4px !important;
            }
            .totals td {
                font-size: 8pt !important;
            }
        }
        /* Mobile responsive styles for PO */
        @media screen and (max-width: 600px) {
            body {
                padding: 10px !important;
                font-size: 10pt !important;
            }
            .po-header h1 {
                font-size: 16pt !important;
            }
            .po-header p {
                font-size: 9pt !important;
                margin: 3px 0 !important;
            }
            .po-number {
                font-size: 12pt !important;
            }
            .po-info {
                flex-direction: column !important;
                gap: 15px !important;
            }
            .info-box {
                width: 100% !important;
                margin-bottom: 10px !important;
            }
            .info-box h3 {
                font-size: 11pt !important;
                margin-bottom: 8px !important;
            }
            .info-box p {
                font-size: 9pt !important;
                margin: 3px 0 !important;
            }
            table.items {
                font-size: 9pt !important;
            }
            table.items th, table.items td {
                padding: 6px 4px !important;
                font-size: 9pt !important;
            }
            table.items th {
                font-size: 8pt !important;
            }
            .totals {
                width: 100% !important;
                float: none !important;
                margin-top: 20px !important;
            }
            .totals td {
                font-size: 10pt !important;
                padding: 6px 8px !important;
            }
            .no-print button {
                padding: 10px 16px !important;
                font-size: 12pt !important;
            }
        }
        body {
            font-family: 'Times New Roman', Times, serif;
            font-size: 11pt;
            line-height: 1.4;
            max-width: 8in;
            margin: 0 auto;
            padding: 0.5in;
        }
        .po-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid ${themeColors.primary};
            padding-bottom: 20px;
        }
        .po-header h1 {
            color: ${themeColors.text};
            margin: 0 0 10px 0;
            font-size: 28pt;
        }
        .po-number {
            font-size: 14pt;
            font-weight: bold;
            margin: 5px 0;
        }
        .po-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .info-box {
            width: 45%;
        }
        .info-box h3 {
            color: ${themeColors.text};
            border-bottom: 2px solid ${themeColors.primary};
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .info-box p {
            margin: 5px 0;
        }
        table.items {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        table.items th {
            background: ${themeColors.primary};
            color: white;
            padding: 12px 10px;
            text-align: left;
        }
        table.items td {
            border: 1px solid #ddd;
            padding: 10px;
        }
        .totals {
            margin-top: 30px;
            float: right;
            width: 40%;
        }
        .totals table { width: 100%; }
        .totals td { padding: 8px 10px; border-bottom: 1px solid #eee; }
        .totals .label { text-align: right; font-weight: bold; }
        .totals .value { text-align: right; width: 40%; }
        .total-line { border-top: 2px solid ${themeColors.primary} !important; font-size: 14pt; font-weight: bold; }
        .footer {
            clear: both;
            margin-top: 60px;
            padding-top: 20px;
            border-top: 2px solid ${themeColors.primary};
            text-align: center;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="po-header">
        <h1>${settings.companyName || 'Nowak Distributing'}</h1>
        <p class="header-location">${settings.cityStateZip || 'Sherwood, WI 54169'}</p>
        <p class="header-contact">Phone: ${settings.phone || '(920)634-4351'}${settings.email ? ` | Email: ${settings.email}` : ''}</p>
    </div>

    <div class="po-number">PURCHASE ORDER: ${po.Invoice_Number || po.PO_ID}</div>
    <p style="margin: 5px 0 15px 0;"><strong>PO Date:</strong> ${new Date(po.PO_Date).toLocaleDateString()} | <strong>Status:</strong> ${actualPaymentStatus}</p>

    <div class="po-info">
        <div class="info-box">
            <h3>Supplier:</h3>
            <p><strong>${supplier?.Supplier_Name || 'Unknown Supplier'}</strong></p>
            ${supplier?.Contact_Name ? `<p>Attn: ${supplier.Contact_Name}</p>` : ''}
            ${supplier?.Address ? `<p>${supplier.Address}</p>` : ''}
            ${supplier?.City || supplier?.State || supplier?.ZIP ? `<p>${supplier.City || ''}${supplier.City && supplier.State ? ', ' : ''}${supplier.State || ''} ${supplier.ZIP || ''}</p>` : ''}
            ${supplier?.Phone ? `<p>Phone: ${supplier.Phone}</p>` : ''}
        </div>
        <div class="info-box">
            <h3>Payment Info:</h3>
            <p><strong>Terms:</strong> ${supplier?.Payment_Terms || 'Net 30'}</p>
            <p><strong>Due Date:</strong> ${po.Due_Date ? new Date(po.Due_Date).toLocaleDateString() : '-'}</p>
            <p><strong>Status:</strong> ${actualPaymentStatus}</p>
            ${paid > 0 && po.Payment_Date ? `<p><strong>Paid:</strong> ${new Date(po.Payment_Date).toLocaleDateString()}</p>` : ''}
        </div>
    </div>

    <table class="items">
        <thead>
            <tr>
                <th style="width: 10%;">QTY</th>
                <th style="width: 50%;">DESCRIPTION</th>
                <th style="width: 20%; text-align: right;">UNIT COST</th>
                <th style="width: 20%; text-align: right;">AMOUNT</th>
            </tr>
        </thead>
        <tbody>`;
            
            lines.forEach(line => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                const lineTotal = (parseFloat(line.Quantity) || 0) * (parseFloat(line.Unit_Cost) || 0);
                
                // Convert eaches to fractional cases
                const converted = convertPOLineToDisplay(line, cachedItems);
                const qtyDisplay = converted.isEaches ? converted.displayQtyFormatted : line.Quantity;
                const costDisplay = converted.isEaches ? formatMoney(converted.displayCost) : formatMoney(parseFloat(line.Unit_Cost || 0));
                
                poHTML += `
            <tr>
                <td style="text-align: center;">${qtyDisplay}</td>
                <td>${item?.Item_Description || line.Item_ID}</td>
                <td style="text-align: right;">${costDisplay}</td>
                <td style="text-align: right;">${formatMoney(lineTotal)}</td>
            </tr>`;
            });
            
            poHTML += `
        </tbody>
    </table>

    <div class="totals">
        <table>
            <tr>
                <td class="label">SUBTOTAL:</td>
                <td class="value">${formatMoney(subtotal)}</td>
            </tr>
            <tr class="total-line">
                <td class="label">TOTAL:</td>
                <td class="value">${formatMoney(total)}</td>
            </tr>
            ${paid > 0 ? `
            <tr>
                <td class="label">PAID:</td>
                <td class="value">${formatMoney(paid)}</td>
            </tr>` : ''}
            ${balance > 0 ? `
            <tr>
                <td class="label" style="color: #c62828;">BALANCE DUE:</td>
                <td class="value" style="color: #c62828; font-weight: bold;">${formatMoney(balance)}</td>
            </tr>` : ''}
        </table>
    </div>

    <div class="footer">
        ${po.Notes ? `<p><strong>Notes:</strong> ${po.Notes}</p>` : ''}
    </div>

    <div class="no-print" style="position: fixed; top: 20px; right: 20px;">
        <button onclick="window.print()" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: ${themeColors.primary}; color: white; border: none; border-radius: 5px; margin-right: 10px;"> Print</button>
        <button onclick="window.close()" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: var(--primary, #667eea); color: white; border: none; border-left: 4px solid rgba(255,255,255,0.4); border-radius: 5px;"> Close</button>
    </div>

</body>
</html>`;
            
            printWindow.document.open();
            printWindow.document.write(poHTML);
            printWindow.document.close();
        }
        
        // PRINT INVOICE FUNCTION
        async function printInvoice() {
            if (!currentEditingOrder || currentEditingType !== 'sales') {
                showWarning('Please select a sales order first');
                return;
            }
            
            // CRITICAL: Open window BEFORE any async calls to avoid iPhone popup blocker
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                showWarning('Please allow popups for this site');
                return;
            }
            printWindow.document.write('<html><body><h2>Loading invoice...</h2></body></html>');
            
            const so = currentEditingOrder;
            const settings = getInvoiceSettings();
            
            // Get customer details
            const customersResult = await apiCall('getCustomers');
            const customer = customersResult.data.find(c => c.Customer_ID === so.Customer_ID);
            
            // Get line items - try cache first, then fetch if empty
            let lines = getSalesLinesFromCache(so.SO_ID);
            if (lines.length === 0) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    lines = linesResult.data;
                    cachedSalesLines = cachedSalesLines.concat(lines);
                }
            }
            
            // Calculate totals
            let subtotal = 0;
            lines.forEach(line => {
                subtotal += parseFloat(line.Line_Total || 0);
            });
            
            const total = parseFloat(so.Total_Amount || 0);
            const paid = parseFloat(so.Amount_Paid || 0);
            const balance = total - paid;
            
            // Calculate actual payment status based on amounts
            let actualPaymentStatus = 'Unpaid';
            if (paid >= total && total > 0) {
                actualPaymentStatus = 'Paid';
            } else if (paid > 0) {
                actualPaymentStatus = 'Partial';
            }
            
            // Get theme colors for print
            const themeColors = getThemeColors();
            
            // Build email content for customer
            const customerEmail = customer?.Email || '';
            const customerName = customer?.Customer_Name || 'Customer';
            const invoiceNum = so.Invoice_Number || so.SO_ID;
            
            // Build item list for email body
            let itemsList = lines.map(line => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                const desc = item?.Item_Description || line.Item_ID;
                return ` ${desc} - ${line.Quantity} @ $${parseFloat(line.Unit_Price || 0).toFixed(2)}`;
            }).join('\\n');
            
            const emailSubject = encodeURIComponent(`Invoice ${invoiceNum} from ${settings.companyName}`);
            const emailBody = encodeURIComponent(`Dear ${customerName},

Please find your invoice details below:

Invoice #: ${invoiceNum}
Date: ${new Date(so.Sale_Date).toLocaleDateString()}

${itemsList}
---
Total: $${total.toFixed(2)}
Amount Paid: $${paid.toFixed(2)}
Balance Due: $${balance.toFixed(2)}

${balance > 0 ? 'Payment is due by ' + (so.Due_Date ? new Date(so.Due_Date).toLocaleDateString() : 'upon receipt') + '.' : 'Thank you for your payment!'}

Best regards,
${settings.companyName}
${settings.phone}
${settings.email}

---
NOTE: Please see the attached invoice PDF for full details.`);
            
            // Build invoice HTML with PO-style layout
            let invoiceHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${settings.companyName} - Invoice ${so.Invoice_Number || so.SO_ID} - ${new Date(so.Sale_Date).toLocaleDateString().replace(/\//g, '-')}</title>
    <style>
        @media print {
            @page { margin: 0.3in; }
            body { margin: 0; }
            .no-print { display: none; }
            /* Force header info to show on ALL print */
            .invoice-header p {
                display: block !important;
                visibility: visible !important;
            }
        }
        /* Mobile print styles - smaller fonts for phone printing */
        @media print and (max-width: 800px) {
            body {
                font-size: 8pt !important;
            }
            .invoice-header h1 {
                font-size: 14pt !important;
            }
            .invoice-header p {
                font-size: 8pt !important;
                margin: 2px 0 !important;
                display: block !important;
                visibility: visible !important;
            }
            .invoice-number {
                font-size: 10pt !important;
            }
            .invoice-info {
                flex-direction: column !important;
            }
            .info-box {
                width: 100% !important;
            }
            .info-box h3 {
                font-size: 9pt !important;
            }
            .info-box p {
                font-size: 8pt !important;
            }
            table.items th, table.items td {
                font-size: 8pt !important;
                padding: 4px !important;
            }
            .totals td {
                font-size: 8pt !important;
            }
        }
        /* Mobile responsive styles for invoice */
        @media screen and (max-width: 600px) {
            body {
                padding: 10px !important;
                font-size: 10pt !important;
            }
            .invoice-header h1 {
                font-size: 18pt !important;
            }
            .invoice-header p {
                font-size: 11pt !important;
            }
            .invoice-info {
                flex-direction: column !important;
                gap: 15px !important;
            }
            .info-box {
                margin-bottom: 10px !important;
                width: 100% !important;
                padding-left: 0 !important;
                padding-right: 0 !important;
                border-left: none !important;
                border-bottom: 1px solid #eee !important;
                padding-bottom: 15px !important;
            }
            .info-box:last-child {
                border-bottom: none !important;
            }
            .info-box h3 {
                font-size: 12pt !important;
                margin-bottom: 8px !important;
            }
            .info-box p {
                font-size: 10pt !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                margin: 3px 0 !important;
            }
            table.items {
                font-size: 9pt !important;
            }
            table.items th, table.items td {
                padding: 6px 4px !important;
                font-size: 9pt !important;
            }
            table.items th {
                font-size: 8pt !important;
            }
            table.items .desc { 
                word-wrap: break-word !important;
                max-width: 100px !important;
            }
            table.items .qty { width: 12% !important; }
            table.items .price { width: 22% !important; }
            table.items .amount { width: 22% !important; }
            .totals {
                width: 100% !important;
                float: none !important;
                margin-top: 10px !important;
            }
            .totals td {
                font-size: 10pt !important;
                padding: 4px 8px !important;
            }
            .signature-line {
                flex: 1 !important;
                min-width: 100px !important;
            }
            .footer {
                font-size: 9pt !important;
                margin-top: 15px !important;
            }
            .signature {
                margin-top: 15px !important;
            }
            .no-print button {
                padding: 10px 16px !important;
                font-size: 12pt !important;
            }
        }
        /* Print-specific mobile optimization */
        @media print and (max-width: 600px) {
            body {
                font-size: 9pt !important;
            }
            .invoice-info {
                flex-direction: column !important;
            }
            .info-box {
                border-left: none !important;
                padding-left: 0 !important;
            }
        }
        body {
            font-family: 'Times New Roman', Times, serif;
            font-size: 10pt;
            line-height: 1.3;
            max-width: 8in;
            margin: 0 auto;
            padding: 0.3in;
        }
        .invoice-header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 3px solid ${themeColors.primary};
            padding-bottom: 10px;
        }
        .invoice-header h1 {
            color: ${themeColors.text};
            margin: 0 0 5px 0;
            font-size: 22pt;
        }
        .invoice-header p {
            margin: 3px 0;
            font-size: 10pt;
        }
        .invoice-number {
            font-size: 12pt;
            font-weight: bold;
            margin: 5px 0;
        }
        .invoice-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .info-box {
            width: 45%;
        }
        .info-box h3 {
            color: ${themeColors.text};
            border-bottom: 2px solid ${themeColors.primary};
            padding-bottom: 3px;
            margin-bottom: 5px;
            margin-top: 0;
            font-size: 11pt;
        }
        .info-box p {
            margin: 3px 0;
            font-size: 9pt;
        }
        table.items {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        table.items th {
            background: ${themeColors.primary};
            color: white;
            padding: 6px 8px;
            text-align: left;
            font-weight: bold;
            font-size: 9pt;
        }
        table.items td {
            border: 1px solid #ddd;
            padding: 5px 8px;
            font-size: 9pt;
        }
        table.items .qty { text-align: center; width: 10%; }
        table.items .desc { width: 50%; }
        table.items .price { text-align: right; width: 20%; }
        table.items .amount { text-align: right; width: 20%; }
        .totals {
            margin-top: 15px;
            float: right;
            width: 40%;
        }
        .totals table {
            width: 100%;
        }
        .totals td {
            padding: 4px 8px;
            border-bottom: 1px solid #eee;
            font-size: 9pt;
        }
        .totals .label {
            text-align: right;
            font-weight: bold;
        }
        .totals .value {
            text-align: right;
            width: 40%;
        }
        .total-line {
            border-top: 2px solid ${themeColors.primary} !important;
            border-bottom: 3px double ${themeColors.primary} !important;
            font-size: 11pt;
            font-weight: bold;
        }
        .footer {
            clear: both;
            margin-top: 25px;
            padding-top: 10px;
            border-top: 2px solid ${themeColors.primary};
            text-align: center;
            font-style: italic;
            color: #666;
            font-size: 9pt;
        }
        .signature {
            margin-top: 20px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        .signature-label {
            white-space: nowrap;
            font-size: 9pt;
        }
        .signature-line {
            flex: 0 0 200px;
            border-bottom: 1px solid #000;
            height: 15px;
        }
    </style>
</head>
<body>

    <div class="invoice-header">
        <h1>${settings.companyName || 'Nowak Distributing'}</h1>
        <p class="header-location">${settings.cityStateZip || 'Sherwood, WI 54169'}</p>
        <p class="header-contact">Phone: ${settings.phone || '(920)634-4351'}${settings.email ? ` | Email: ${settings.email}` : ''}</p>
    </div>

    <div class="invoice-number">SALES INVOICE: ${so.Invoice_Number || so.SO_ID}</div>
    <p style="margin: 5px 0 15px 0;"><strong>Invoice Date:</strong> ${so.Sale_Date ? new Date(so.Sale_Date).toLocaleDateString() : new Date(so.SO_Date).toLocaleDateString()} | <strong>Status:</strong> ${actualPaymentStatus}</p>

    <div class="invoice-info">
        <div class="info-box">
            <h3>Bill To:</h3>
            <p><strong>${customer?.Customer_Name || 'Unknown Customer'}</strong></p>
            ${customer?.Contact_Name ? `<p>Attn: ${customer.Contact_Name}</p>` : ''}
            ${customer?.Address ? `<p>${customer.Address}</p>` : ''}
            ${customer?.City || customer?.State || customer?.ZIP ? `<p>${customer.City || ''}${customer.City && customer.State ? ', ' : ''}${customer.State || ''} ${customer.ZIP || ''}</p>` : ''}
            ${customer?.Phone ? `<p>Phone: ${customer.Phone}</p>` : ''}
        </div>
        <div class="info-box">
            <h3>Payment Info:</h3>
            <p><strong>Terms:</strong> ${customer?.Payment_Terms || 'Net 30'}</p>
            <p><strong>Due Date:</strong> ${so.Due_Date ? new Date(so.Due_Date).toLocaleDateString() : '-'}</p>
            <p><strong>Status:</strong> ${actualPaymentStatus}</p>
            ${paid > 0 && so.Payment_Date ? `<p><strong>Paid:</strong> ${new Date(so.Payment_Date).toLocaleDateString()}</p>` : ''}
        </div>
    </div>

    <table class="items">
        <thead>
            <tr>
                <th class="qty">QTY</th>
                <th class="desc">DESCRIPTION</th>
                <th class="price">PRICE</th>
                <th class="amount">AMOUNT</th>
            </tr>
        </thead>
        <tbody>`;
            
            // Add line items - CALCULATE line total from qty  price (don't rely on Line_Total field)
            let calculatedSubtotal = 0;
            let totalDiscount = 0;
            lines.forEach(line => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                const qty = parseFloat(line.Quantity) || 0;
                const price = parseFloat(line.Unit_Price) || 0;
                const standardPrice = parseFloat(item?.Unit_Sell_Price) || 0;
                const lineTotal = qty * price;
                calculatedSubtotal += lineTotal;
                
                // Calculate discount if price is less than standard price
                const hasDiscount = standardPrice > 0 && price < standardPrice;
                const discountPerUnit = hasDiscount ? (standardPrice - price) : 0;
                const lineDiscount = discountPerUnit * qty;
                totalDiscount += lineDiscount;
                
                // Build price display with original price if discounted
                let priceDisplay = formatMoney(price);
                if (hasDiscount) {
                    priceDisplay = `<span style="text-decoration: line-through; color: #999; font-size: 9pt;">${formatMoney(standardPrice)}</span> <span style="color: #27ae60; font-weight: bold;">${formatMoney(price)}</span>`;
                }
                
                invoiceHTML += `
            <tr>
                <td class="qty">${line.Quantity}</td>
                <td class="desc">${item?.Item_Description || line.Item_ID}</td>
                <td class="price">${priceDisplay}</td>
                <td class="amount">${formatMoney(lineTotal)}${hasDiscount ? `<br><span style="color: #27ae60; font-size: 8pt;">Save ${formatMoney(lineDiscount)}</span>` : ''}</td>
            </tr>`;
            });
            
            // Use calculated subtotal instead of summing Line_Total
            subtotal = calculatedSubtotal;
            
            invoiceHTML += `
        </tbody>
    </table>

    <div class="totals">
        <table>
            <tr>
                <td class="label">SUBTOTAL:</td>
                <td class="value">${formatMoney(subtotal)}</td>
            </tr>
            ${totalDiscount > 0 ? `
            <tr style="color: #27ae60;">
                <td class="label">YOUR SAVINGS:</td>
                <td class="value">-${formatMoney(totalDiscount)}</td>
            </tr>` : ''}
            <tr class="total-line">
                <td class="label">TOTAL:</td>
                <td class="value">${formatMoney(total)}</td>
            </tr>
            ${paid > 0 ? `
            <tr>
                <td class="label">PAID:</td>
                <td class="value">${formatMoney(paid)}</td>
            </tr>` : ''}
            ${balance > 0 ? `
            <tr style="background: #f0e8d0;">
                <td class="label">BALANCE DUE:</td>
                <td class="value" style="color: #e74c3c; font-weight: bold;">${formatMoney(balance)}</td>
            </tr>` : ''}
        </table>
    </div>

    <div class="footer">
        Thank you for doing Business with ${settings.companyName}
    </div>

    <div class="signature">
        <span class="signature-label">Signature:</span>
        <div class="signature-line"></div>
    </div>

    <p style="clear: both; text-align: center; margin-top: 15px; font-size: 8pt; color: #999;">
        KEEP THIS SLIP FOR REFERENCE
    </p>

    <div class="no-print" style="position: fixed; top: 20px; right: 20px;">
        <button onclick="window.print()" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: ${themeColors.primary}; color: white; border: none; border-radius: 5px; margin-right: 10px;"> Print</button>
        ${customerEmail ? `<a href="mailto:${customerEmail}?subject=${emailSubject}&body=${emailBody}" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: #6b9a8d; color: white; border: none; border-radius: 5px; margin-right: 10px; text-decoration: none; display: inline-block;"> Email Customer</a>` : ''}
        <button onclick="window.close()" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: #8a8a8a; color: white; border: none; border-radius: 5px;"> Close</button>
    </div>

</body>
</html>`;
            
            // Clear the loading message and write the final invoice
            printWindow.document.open();
            printWindow.document.write(invoiceHTML);
            printWindow.document.close();
        }
        
        // ==================== MODAL SIZE PERSISTENCE ====================
        // Save and restore modal sizes from localStorage
        
        function saveModalSize(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                const size = {
                    width: modal.offsetWidth,
                    height: modal.offsetHeight,
                    maximized: modal.classList.contains('modal-maximized')
                };
                localStorage.setItem('modalSize_' + modalId, JSON.stringify(size));
            }
        }
        
        function restoreModalSize(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                try {
                    const saved = localStorage.getItem('modalSize_' + modalId);
                    if (saved) {
                        const size = JSON.parse(saved);
                        
                        // If it was maximized, restore to maximized state
                        if (size.maximized && modalId === 'reportSetupModalInner') {
                            // Trigger maximize
                            setTimeout(() => {
                                if (!reportModalMaximized) {
                                    toggleReportModalSize();
                                }
                            }, 50);
                        } else if (size.width && size.height) {
                            modal.style.width = size.width + 'px';
                            modal.style.height = size.height + 'px';
                            modal.style.maxWidth = 'none'; // Override max-width to allow custom size
                        }
                    }
                } catch (e) {
                    console.log('Error restoring modal size:', e);
                }
            }
        }
        
        // Set up resize observers for modals
        document.addEventListener('DOMContentLoaded', function() {
            // Order Modal size observer
            const orderModalInner = document.getElementById('orderModalInner');
            if (orderModalInner) {
                let resizeTimeout;
                new ResizeObserver(() => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        if (document.getElementById('orderModal').style.display !== 'none') {
                            saveModalSize('orderModalInner');
                        }
                    }, 200);
                }).observe(orderModalInner);
            }
            
            // Report Setup Modal size observer
            const reportModalInner = document.getElementById('reportSetupModalInner');
            if (reportModalInner) {
                let resizeTimeout;
                new ResizeObserver(() => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        if (document.getElementById('reportSetupModal').style.display !== 'none') {
                            saveModalSize('reportSetupModalInner');
                        }
                    }, 200);
                }).observe(reportModalInner);
            }
            
            // Watch for modal open events to restore size
            const orderModal = document.getElementById('orderModal');
            if (orderModal) {
                new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === 'style' && orderModal.style.display === 'block') {
                            restoreModalSize('orderModalInner');
                        }
                    });
                }).observe(orderModal, { attributes: true, attributeFilter: ['style'] });
            }
            
            const reportModal = document.getElementById('reportSetupModal');
            if (reportModal) {
                new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === 'style' && 
                            (reportModal.style.display === 'block' || reportModal.style.display === 'flex')) {
                            restoreModalSize('reportSetupModalInner');
                        }
                    });
                }).observe(reportModal, { attributes: true, attributeFilter: ['style'] });
            }
        });
        
        function closeOrderModal() {
            const modal = document.getElementById('orderModal');
            modal.style.display = 'none';
            
            // Don't reset modal position - we want to remember it for next open
            // Position is saved to localStorage when drag ends
            
            currentEditingOrder = null;
            currentEditingType = null;
            
            // Only remove modal-open if no other modals are open
            const reportModal = document.getElementById('reportSetupModal');
            if (!reportModal || reportModal.style.display === 'none') {
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
            }
            
            // Return to previous tab if we came from Reports
            if (returnToTab === 'reports') {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="reports"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('reports').classList.add('active');
                returnToTab = null;
            }
        }
        
        function enableEditMode() {
            if (currentEditingType === 'purchase') {
                enablePurchaseOrderEdit();
            } else if (currentEditingType === 'sales') {
                enableSalesOrderEdit();
            }
        }
        
        async function enablePurchaseOrderEdit() {
            const po = currentEditingOrder;
            
            // Load items and suppliers if not cached
            if (cachedItems.length === 0) {
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
            }
            if (cachedSuppliers.length === 0) {
                const suppResult = await apiCall('getSuppliers');
                if (suppResult && suppResult.status === 'success') {
                    cachedSuppliers = suppResult.data;
                }
            }
            
            // Get line items - try cache first, then fetch if empty
            let lines = getPurchaseLinesFromCache(po.PO_ID);
            if (lines.length === 0) {
                const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
                if (linesResult?.data) {
                    lines = linesResult.data;
                    cachedPurchaseLines = cachedPurchaseLines.concat(lines);
                }
            }
            
            const supplierName = getSupplierName(po.Supplier_ID);
            
            document.getElementById('modalTitle').textContent = `Edit Purchase Order: ${po.PO_ID}`;
            
            // Build supplier dropdown
            let supplierOptions = '<option value="">Select Supplier</option>';
            cachedSuppliers.forEach(s => {
                supplierOptions += `<option value="${s.Supplier_ID}" ${s.Supplier_ID === po.Supplier_ID ? 'selected' : ''}>${s.Supplier_Name}</option>`;
            });
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Order Information</h3>
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="editPOSupplier" required>${supplierOptions}</select>
                        </div>
                        <div class="form-group">
                            <label>Invoice Number</label>
                            <input type="text" id="editPOInvoiceNumber" value="${po.Invoice_Number || ''}">
                        </div>
                        <div class="form-group">
                            <label>PO Date</label>
                            <input type="date" id="editPODate" value="${po.PO_Date ? new Date(po.PO_Date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="editPODueDate" value="${po.Due_Date ? new Date(po.Due_Date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <input type="text" id="editPOStatus_display" value="${getStatusDisplayText('poStatus', po.Status)}" onclick="openStatusPicker('poStatus', 'editPOStatus')" readonly style="cursor: pointer; background: #fff; font-weight: 600;">
                            <input type="hidden" id="editPOStatus" value="${po.Status}">
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Payment Information</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="margin-bottom: 10px;">
                                <strong>Current Total:</strong> ${formatMoney(parseFloat(po.Total_Amount || 0))}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Previously Paid:</strong> ${formatMoney(parseFloat(po.Amount_Paid || 0))}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Balance Due:</strong> <span style="color: #e74c3c;">$${(() => {
                                    const balance = parseFloat(po.Total_Amount || 0) - parseFloat(po.Amount_Paid || 0);
                                    return (Math.abs(balance) < 0.01 ? 0 : balance).toFixed(2);
                                })()}</span>
                            </div>
                            ${po.Payment_Date ? `<div style="color: #6b9a8d;">
                                <strong>Payment Date:</strong> ${new Date(po.Payment_Date).toLocaleDateString()}
                            </div>` : ''}
                        </div>
                        <div class="form-group">
                            <label> Amount Paid</label>
                            <div style="position: relative; display: flex; align-items: center;">
                                <span style="position: absolute; left: 12px; font-size: 16px; font-weight: bold; color: #666;">$</span>
                                <input type="number" id="editPOAmountPaid" step="0.01" min="0" placeholder="0.00" value="${parseFloat(po.Amount_Paid || 0).toFixed(2)}" style="padding-left: 28px; font-size: 16px; font-weight: 600;">
                            </div>
                            <small style="color: #666;"> Enter numbers only (e.g., 115.46 for $115.46)</small>
                        </div>
                        <div style="color: #666; font-size: 13px; background: #f0e8d0; padding: 10px; border-radius: 6px;">
                             Total will recalculate based on line items below
                        </div>
                    </div>
                </div>
                
                <h3 style="color: #667eea; margin-bottom: 15px;">Line Items</h3>
                <div id="editPOLineItems">
            `;
            
            // Add existing line items as editable rows
            lines.forEach((line, index) => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                html += createEditableLineItem('PO', line, index, item);
            });
            
            html += `
                </div>
                <button type="button" class="btn" onclick="addEditLineItem('PO')" style="margin-top: 10px; background: var(--primary, #667eea); color: white;">+ Add Line Item</button>
                
                <div class="form-group" style="margin-top: 30px;">
                    <label>Notes</label>
                    <textarea id="editPONotes" rows="3" style="width: 100%;">${po.Notes || ''}</textarea>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            
            // Check if PO is received - if so, disable line item editing
            const isReceived = po.Status === 'Received';
            if (isReceived) {
                // Disable all line item inputs
                document.querySelectorAll('#editPOLineItems .edit-item, #editPOLineItems .edit-qty, #editPOLineItems .edit-price').forEach(el => {
                    el.disabled = true;
                    el.style.opacity = '0.6';
                    el.style.cursor = 'not-allowed';
                });
                // Disable delete buttons (grey out instead of hide)
                document.querySelectorAll('#editPOLineItems .remove-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.4';
                    btn.style.cursor = 'not-allowed';
                    btn.onclick = null;
                });
                // Hide add line item button
                const addBtn = document.querySelector('button[onclick="addEditLineItem(\'PO\')"]');
                if (addBtn) addBtn.style.display = 'none';
                
                // Add notice
                const lineItemsHeader = document.querySelector('#editPOLineItems')?.previousElementSibling;
                if (lineItemsHeader) {
                    const notice = document.createElement('div');
                    notice.style.cssText = 'background: #f0e8d0; border: 1px solid #b8a86b; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #7a6b40;';
                    notice.innerHTML = ' <strong>Line items locked</strong> - This PO has been received into inventory. Change status to edit lines.';
                    lineItemsHeader.insertAdjacentElement('afterend', notice);
                }
            }
            
            // Attach event listeners to all PO line items in the edit modal
            console.log('Attaching listeners to PO edit modal line items'); // DEBUG
            document.querySelectorAll('#editPOLineItems .edit-line-item').forEach(row => {
                attachEditLineItemListeners(row);
            });
            
            document.getElementById('modalEditBtn').style.display = 'none';
            // Reset save button to proper state (may have been changed by PO receive)
            const saveBtn = document.getElementById('modalSaveBtn');
            saveBtn.style.display = 'inline-block';
            saveBtn.textContent = ' Save Changes';
            saveBtn.onclick = function(event) { if(event && debounceButton(event.currentTarget)) saveOrderChanges(); };
        }
        
        function createEditableLineItem(type, line, index, item) {
            // Make sure items are loaded
            if (cachedItems.length === 0) {
                console.error('cachedItems is empty!');
            }
            
            const itemOptions = cachedItems
                .filter(i => type === 'PO' ? i.Supplier_ID === currentEditingOrder.Supplier_ID : true)
                .map(i => {
                    const priceAttr = type === 'PO' ? `data-cost="${i.Package_Cost}"` : `data-price="${i.Unit_Sell_Price}"`;
                    return `<option value="${i.Item_ID}" ${priceAttr} ${i.Item_ID === line.Item_ID ? 'selected' : ''}>${i.Item_Description}</option>`;
                })
                .join('');
            
            console.log('Items for dropdown:', cachedItems.length, 'Filtered:', itemOptions.length);
            
            const qtyField = type === 'PO' ? 'Quantity' : 'Quantity';
            const priceField = type === 'PO' ? 'Unit_Cost' : 'Unit_Price';
            const originalQty = parseFloat(line[qtyField]) || 0;
            const originalPrice = parseFloat(line[priceField]) || 0;
            
            return `
                <div class="edit-line-item" data-type="${type}" data-original-item="${line.Item_ID}" data-original-qty="${originalQty}" data-line-id="${line.Line_ID || ''}" style="display: grid; grid-template-columns: 2.5fr 0.8fr 0.8fr 0.8fr 50px; gap: 10px; margin-bottom: 12px; align-items: end; padding: 15px; background: linear-gradient(135deg, #f8f9fa, #fff); border-radius: 10px; border: 2px solid #e0e0e0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px; color: #667eea;"> Item</label>
                        <select class="edit-item" required style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; min-height: 48px; background: white;">
                            <option value="">Select Item</option>
                            ${itemOptions}
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px; color: #333;"> Qty</label>
                        <input type="number" class="edit-qty" placeholder="Qty" min="1" required value="${originalQty}" style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; min-height: 48px; font-weight: 600; text-align: center;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px; color: #333;"> ${type === 'PO' ? 'Cost' : 'Price'}</label>
                        <input type="number" class="edit-price" placeholder="${type === 'PO' ? 'Cost' : 'Price'}" step="0.01" min="0" required value="${originalPrice.toFixed(2)}" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; min-height: 48px;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px; color: #333;"> Total</label>
                        <input type="text" class="edit-total" readonly value="${formatMoney(originalQty * originalPrice)}" style="width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; font-size: 14px; min-height: 48px; background: #e8f5e9; font-weight: 600; color: #2e7d32; text-align: center;">
                    </div>
                    <button type="button" class="remove-btn" style="background: #b88a8a; color: white; border: none; border-radius: 8px; padding: 12px 0; cursor: pointer; font-size: 16px; min-height: 48px; align-self: end;"></button>
                </div>
            `;
        }
        
        function calculateEditLineTotal(input) {
            const row = input.closest('.edit-line-item');
            const qty = parseFloat(row.querySelector('.edit-qty').value) || 0;
            const price = parseFloat(row.querySelector('.edit-price').value) || 0;
            const total = qty * price;
            row.querySelector('.edit-total').value = '$' + total.toFixed(2);
            
            // Update payment info if this is a sales order
            if (row.getAttribute('data-type') === 'SO') {
                updateEditPaymentInfo();
            }
        }
        
        function updateEditPaymentInfo() {
            // Calculate new total from all line items
            let newTotal = 0;
            document.querySelectorAll('#editSOLineItems .edit-line-item').forEach(row => {
                const qty = parseFloat(row.querySelector('.edit-qty').value) || 0;
                const price = parseFloat(row.querySelector('.edit-price').value) || 0;
                newTotal += qty * price;
            });
            
            // Get previously paid amount
            const previouslyPaid = parseFloat(document.getElementById('editSOAmountPaid')?.value) || 0;
            
            // Calculate balance due and fix rounding errors
            let balanceDue = newTotal - previouslyPaid;
            if (Math.abs(balanceDue) < 0.01) balanceDue = 0;
            
            // Update the display fields using IDs
            const currentTotalDiv = document.getElementById('editSOCurrentTotal');
            const balanceDueDiv = document.getElementById('editSOBalanceDue');
            
            if (currentTotalDiv) {
                currentTotalDiv.innerHTML = `<strong>Current Total:</strong> ${formatMoney(newTotal)}`;
            }
            
            if (balanceDueDiv) {
                balanceDueDiv.innerHTML = `<strong>Balance Due:</strong> <span style="color: #e74c3c;">${formatMoney(balanceDue)}</span>`;
            }
        }
        
        function attachEditLineItemListeners(row) {
            const type = row.getAttribute('data-type');
            const itemSelect = row.querySelector('.edit-item');
            const qtyInput = row.querySelector('.edit-qty');
            const priceInput = row.querySelector('.edit-price');
            const removeBtn = row.querySelector('.remove-btn');
            
            console.log('Attaching edit modal listeners, type:', type); // DEBUG
            
            // Auto-fill price when item selected
            itemSelect.addEventListener('change', function() {
                console.log('Edit modal item changed!'); // DEBUG
                const option = this.options[this.selectedIndex];
                const priceAttr = type === 'PO' ? 'data-cost' : 'data-price';
                const price = option.getAttribute(priceAttr);
                console.log('Price from data attribute:', price); // DEBUG
                
                if (price) {
                    priceInput.value = price;
                    calculateEditLineTotal(qtyInput);
                }
            });
            
            // Recalculate when qty or price changes
            qtyInput.addEventListener('input', function() {
                calculateEditLineTotal(this);
            });
            
            priceInput.addEventListener('input', function() {
                calculateEditLineTotal(this);
            });
            
            // Remove button
            removeBtn.addEventListener('click', async function() {
                const confirmed = await showConfirmModal(
                    ' Remove Line Item',
                    'Are you sure you want to remove this line item?',
                    'Remove',
                    'Cancel',
                    'warning'
                );
                if (confirmed) {
                    row.remove();
                    // Update payment info if this is a sales order
                    if (type === 'SO') {
                        updateEditPaymentInfo();
                    }
                }
            });
            
            console.log('Edit modal listeners attached!'); // DEBUG
        }
        
        function addEditLineItem(type) {
            const container = document.getElementById(type === 'PO' ? 'editPOLineItems' : 'editSOLineItems');
            const newLine = {
                Item_ID: '',
                Quantity: 0,
                [type === 'PO' ? 'Unit_Cost' : 'Unit_Price']: 0
            };
            const newItem = createEditableLineItem(type, newLine, -1, null);
            container.insertAdjacentHTML('beforeend', newItem);
            
            // Attach listeners to the newly added item
            const newRow = container.lastElementChild;
            attachEditLineItemListeners(newRow);
        }
        
        async function removeEditLineItem(btn) {
            const confirmed = await showConfirmModal(
                ' Remove Line Item',
                'Are you sure you want to remove this line item?',
                'Remove',
                'Cancel',
                'warning'
            );
            if (confirmed) {
                btn.closest('.edit-line-item').remove();
            }
        }
        
        async function saveOrderChanges() {
            if (currentEditingType === 'purchase') {
                await savePurchaseOrderChanges();
            } else if (currentEditingType === 'sales') {
                await saveSalesOrderChanges();
            }
        }
        
        let isSavingPOEdit = false; // Prevent double-click on PO edit
        
        async function savePurchaseOrderChanges() {
            // Prevent double-click
            if (isSavingPOEdit) {
                console.log('Already saving PO edit, ignoring duplicate click');
                return;
            }
            
            const po = currentEditingOrder;
            
            // Collect line items
            const newLines = [];
            let totalAmount = 0;
            
            document.querySelectorAll('#editPOLineItems .edit-line-item').forEach(row => {
                const itemId = row.querySelector('.edit-item').value;
                const qty = parseInt(row.querySelector('.edit-qty').value) || 0;
                const cost = parseFloat(row.querySelector('.edit-price').value) || 0;
                
                if (itemId && qty > 0) {
                    newLines.push({
                        itemId: itemId,
                        quantity: qty,
                        unitCost: cost,
                        originalItem: row.dataset.originalItem,
                        originalQty: parseInt(row.dataset.originalQty) || 0,
                        lineId: row.dataset.lineId
                    });
                    totalAmount += qty * cost;
                }
            });
            
            console.log('Total lines collected:', newLines.length);
            
            if (newLines.length === 0) {
                const rowCount = document.querySelectorAll('#editPOLineItems .edit-line-item').length;
                showWarning(`No valid line items found!<br><br>Rows found: ${rowCount}<br><br>Please make sure each line has:<br> An item selected<br> A quantity > 0`);
                return;
            }
            
            // ===== VALIDATION #1: Check for Duplicate Items =====
            const itemCounts = {};
            newLines.forEach(line => {
                itemCounts[line.itemId] = (itemCounts[line.itemId] || 0) + 1;
            });
            
            const duplicates = Object.entries(itemCounts).filter(([id, count]) => count > 1);
            if (duplicates.length > 0) {
                // Find item names for the warning message
                const duplicateNames = duplicates.map(([itemId]) => {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    return item ? item.Item_Description : itemId;
                }).join(', ');
                
                const continueWithDupes = await showConfirmModal(
                    ' Duplicate Items Detected',
                    `<p>The following items appear on multiple lines:</p>
                    <p style="background: #f0e8d0; padding: 10px; border-radius: 6px; font-weight: 600;">${duplicateNames}</p>
                    <p>This may be intentional (different costs), but could also be a mistake.</p>`,
                    'Continue Anyway',
                    'Review Order',
                    'warning'
                );
                
                if (!continueWithDupes) return;
            }
            
            // ===== VALIDATION #2: Check for Overpayment =====
            const amountPaid = parseFloat(document.getElementById('editPOAmountPaid').value) || 0;
            if (amountPaid > totalAmount + 0.01) { // Allow 1 cent rounding
                const overpayment = amountPaid - totalAmount;
                const continueWithOverpay = await showConfirmModal(
                    ' Overpayment Warning',
                    `<div style="text-align: left;">
                        <p><strong>Order Total:</strong> ${formatMoney(totalAmount)}</p>
                        <p><strong>Amount Paid:</strong> ${formatMoney(amountPaid)}</p>
                        <p style="color: #b88a8a;"><strong>Overpayment:</strong> ${formatMoney(overpayment)}</p>
                        <p style="margin-top: 15px;">You are entering MORE payment than the order total.</p>
                    </div>`,
                    'Continue (Show Overpaid)',
                    'Correct Amount',
                    'warning'
                );
                
                if (!continueWithOverpay) return;
            }
            
            const data = {
                poId: po.PO_ID,
                supplierId: document.getElementById('editPOSupplier').value,
                invoiceNumber: document.getElementById('editPOInvoiceNumber').value,
                poDate: document.getElementById('editPODate').value,
                dueDate: document.getElementById('editPODueDate').value,
                status: document.getElementById('editPOStatus').value,
                notes: document.getElementById('editPONotes').value,
                totalAmount: totalAmount,
                amountPaid: parseFloat(document.getElementById('editPOAmountPaid').value) || 0,
                lineItems: newLines,  // FIXED: was 'lines', backend expects 'lineItems'
                oldLines: currentEditingOrder._originalLines || []
            };
            
            // Show changes preview before saving
            const confirmChanges = await showOrderChangesPreview('po', data, po);
            if (!confirmChanges) return;
            
            // Check if voiding - show confirmation
            const newStatus = document.getElementById('editPOStatus').value;
            const oldStatus = po.Status;
            if (newStatus === 'Voided' && oldStatus !== 'Voided') {
                let message = `<div style="text-align: left;">
                    <p>This will:</p>
                    <ul style="margin: 10px 0 10px 20px;">
                        <li>Mark the order as <strong style="color: #b88a8a;">VOIDED</strong></li>`;
                
                if (oldStatus === 'Received') {
                    message += '<li><strong style="color: #b88a8a;">REMOVE inventory</strong> for all line items</li>';
                }
                message += `<li>Create adjustment log entries</li>
                        <li>Exclude from tax reports</li>
                    </ul>
                    <p style="color: #b88a8a; font-weight: 600;">This action cannot be easily undone.</p>
                </div>`;
                
                const confirmVoid = await showConfirmModal(
                    ' Void Purchase Order?',
                    message,
                    'Yes, Void ' + (po.Invoice_Number || po.PO_ID),
                    'Cancel',
                    'danger'
                );
                if (!confirmVoid) return;
            }
            
            showStatus('purchasesStatus', ' Saving changes...', 'info');
            
            // Set saving flag
            isSavingPOEdit = true;
            
            // Disable ALL modal buttons during save
            const saveBtn = document.getElementById('modalSaveBtn');
            const printBtn = document.getElementById('modalPrintBtn');
            const closeBtn = document.getElementById('modalCloseBtn');
            const editBtn = document.getElementById('modalEditBtn');
            
            const allModalBtns = [saveBtn, printBtn, closeBtn, editBtn].filter(b => b);
            allModalBtns.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            
            // Update save button text
            if (saveBtn) {
                saveBtn.innerHTML = ' Saving...';
            }
            
            showLoading('Updating Purchase Order...');
            
            try {
                const result = await apiCall('updatePurchaseOrder', data);
                
                if (result && result.status === 'success') {
                    showSuccessModal('Purchase Order Updated!', 'Changes saved successfully.\n\nYou can now print the PO or continue editing.');
                // DON'T close the modal - let user print or close manually
                // closeOrderModal();  // Removed - user will use Close button
                
                // Refresh the data in the modal to show updated values
                const updatedResult = await apiCall('getPurchaseOrders');
                if (updatedResult?.data) {
                    const updatedPO = updatedResult.data.find(p => p.PO_ID === po.PO_ID);
                    if (updatedPO) {
                        currentEditingOrder = updatedPO;
                        
                        // Update Payment Information display (find by looking for the Payment Information section)
                        const paymentInfoSection = document.querySelector('#modalContent h3[style*="Payment Information"]')?.closest('div')?.querySelector('div[style*="background: #f8f9fa"]');
                        
                        if (paymentInfoSection) {
                            const newTotal = parseFloat(updatedPO.Total_Amount || 0);
                            const newPaid = parseFloat(updatedPO.Amount_Paid || 0);
                            const newBalance = Math.abs(newTotal - newPaid) < 0.01 ? 0 : (newTotal - newPaid);
                            
                            // Rebuild the Payment Info section content
                            let paymentInfoHTML = `
                                <div style="margin-bottom: 10px;">
                                    <strong>Current Total:</strong> ${formatMoney(newTotal)}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>Previously Paid:</strong> ${formatMoney(newPaid)}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>Balance Due:</strong> <span style="color: ${newBalance > 0 ? '#e74c3c' : '#6b9a8d'};">$${newBalance.toFixed(2)}</span>
                                </div>
                            `;
                            if (updatedPO.Payment_Date) {
                                paymentInfoHTML += `<div style="color: #6b9a8d;">
                                    <strong>Payment Date:</strong> ${new Date(updatedPO.Payment_Date).toLocaleDateString()}
                                </div>`;
                            }
                            paymentInfoSection.innerHTML = paymentInfoHTML;
                        }
                        
                        // Update the Amount Paid input
                        const amountPaidInput = document.getElementById('editPOAmountPaid');
                        if (amountPaidInput) {
                            amountPaidInput.value = parseFloat(updatedPO.Amount_Paid || 0).toFixed(2);
                        }
                    }
                }
                
                loadPurchases();
                } else {
                    showStatus('purchasesStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                }
            } finally {
                // Always reset the flag and restore ALL buttons
                hideLoading();
                isSavingPOEdit = false;
                allModalBtns.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                });
                if (saveBtn) {
                    saveBtn.innerHTML = ' Save Changes';
                }
            }
        }
        
        async function enableSalesOrderEdit() {
            const so = currentEditingOrder;
            
            // Load items and customers if not cached
            if (cachedItems.length === 0) {
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
            }
            if (cachedCustomers.length === 0) {
                const custResult = await apiCall('getCustomers');
                if (custResult && custResult.status === 'success') {
                    cachedCustomers = custResult.data;
                }
            }
            
            // Get line items - try cache first, then fetch if empty
            let lines = getSalesLinesFromCache(so.SO_ID);
            if (lines.length === 0) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    lines = linesResult.data;
                    cachedSalesLines = cachedSalesLines.concat(lines);
                }
            }
            
            document.getElementById('modalTitle').textContent = `Edit Sales Order: ${so.Invoice_Number || so.SO_ID}`;
            
            // Build customer dropdown
            let customerOptions = '<option value="">Select Customer</option>';
            cachedCustomers.forEach(c => {
                customerOptions += `<option value="${c.Customer_ID}" ${c.Customer_ID === so.Customer_ID ? 'selected' : ''}>${c.Customer_Name}</option>`;
            });
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Order Information</h3>
                        <div class="form-group">
                            <label>Customer * <span style="font-size: 11px; color: #999;">(locked)</span></label>
                            <select id="editSOCustomer" required disabled style="background: #f0f0f0; cursor: not-allowed;">${customerOptions}</select>
                            <input type="hidden" id="editSOCustomerHidden" value="${so.Customer_ID}">
                        </div>
                        <div class="form-group">
                            <label>Invoice Number <span style="font-size: 11px; color: #999;">(locked)</span></label>
                            <input type="text" id="editSOInvoiceNumber" value="${so.Invoice_Number || ''}" readonly style="background: #f0f0f0; cursor: not-allowed;">
                        </div>
                        <div class="form-group">
                            <label>Sale Date</label>
                            <input type="date" id="editSODate" value="${so.Sale_Date ? new Date(so.Sale_Date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="editSODueDate" value="${so.Due_Date ? new Date(so.Due_Date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <input type="text" id="editSOPaymentMethod_display" value="${getStatusDisplayText('paymentMethod', so.Payment_Method)}" onclick="openStatusPicker('paymentMethod', 'editSOPaymentMethod')" readonly style="cursor: pointer; background: #fff; font-weight: 600;">
                            <input type="hidden" id="editSOPaymentMethod" value="${so.Payment_Method || 'Cash'}">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <input type="text" id="editSOStatus_display" value="${getStatusDisplayText('soStatus', so.Status)}" onclick="openStatusPicker('soStatus', 'editSOStatus')" readonly style="cursor: pointer; background: #fff; font-weight: 600;">
                            <input type="hidden" id="editSOStatus" value="${so.Status}">
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Payment Information</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div id="editSOCurrentTotal" style="margin-bottom: 10px;">
                                <strong>Current Total:</strong> ${formatMoney(parseFloat(so.Total_Amount || 0))}
                            </div>
                            <div id="editSOPreviouslyPaid" style="margin-bottom: 10px;">
                                <strong>Previously Paid:</strong> ${formatMoney(parseFloat(so.Amount_Paid || 0))}
                            </div>
                            <div id="editSOBalanceDue" style="margin-bottom: 10px;">
                                <strong>Balance Due:</strong> <span style="color: #e74c3c;">$${(() => {
                                    const balance = parseFloat(so.Total_Amount || 0) - parseFloat(so.Amount_Paid || 0);
                                    return (Math.abs(balance) < 0.01 ? 0 : balance).toFixed(2);
                                })()}</span>
                            </div>
                            ${so.Payment_Date ? `<div id="editSOPaymentDate" style="color: #6b9a8d;">
                                <strong>Payment Date:</strong> ${new Date(so.Payment_Date).toLocaleDateString()}
                            </div>` : ''}
                        </div>
                        <div class="form-group">
                            <label> Amount Paid</label>
                            <div style="position: relative; display: flex; align-items: center;">
                                <span style="position: absolute; left: 12px; font-size: 16px; font-weight: bold; color: #666;">$</span>
                                <input type="number" id="editSOAmountPaid" step="0.01" min="0" placeholder="0.00" value="${parseFloat(so.Amount_Paid || 0).toFixed(2)}" style="padding-left: 28px; font-size: 16px; font-weight: 600;">
                            </div>
                            <small style="color: #666;"> Enter numbers only (e.g., 115.46 for $115.46)</small>
                        </div>
                        <div style="color: #666; font-size: 13px; background: #f0e8d0; padding: 10px; border-radius: 6px;">
                             Total will recalculate based on line items below
                        </div>
                    </div>
                </div>
                
                <h3 style="color: #667eea; margin-bottom: 15px;">Line Items</h3>
                <div id="editSOLineItems">
            `;
            
            // Add existing line items as editable rows
            lines.forEach((line, index) => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                html += createEditableLineItem('SO', line, index, item);
            });
            
            html += `
                </div>
                <button type="button" class="btn" onclick="addEditLineItem('SO')" style="margin-top: 10px; background: var(--primary, #667eea); color: white;">+ Add Line Item</button>
                
                <div class="form-group" style="margin-top: 30px;">
                    <label>Notes</label>
                    <textarea id="editSONotes" rows="3" style="width: 100%;">${so.Notes || ''}</textarea>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            
            // Check if SO is completed/delivered - if so, disable line item editing
            const isLocked = so.Status === 'Completed' || so.Status === 'Delivered';
            if (isLocked) {
                // Disable all line item inputs
                document.querySelectorAll('#editSOLineItems .edit-item, #editSOLineItems .edit-qty, #editSOLineItems .edit-price').forEach(el => {
                    el.disabled = true;
                    el.style.opacity = '0.6';
                    el.style.cursor = 'not-allowed';
                });
                // Disable delete buttons (grey out instead of hide)
                document.querySelectorAll('#editSOLineItems .remove-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.4';
                    btn.style.cursor = 'not-allowed';
                    btn.onclick = null;
                });
                // Hide add line item button
                const addBtn = document.querySelector('button[onclick="addEditLineItem(\'SO\')"]');
                if (addBtn) addBtn.style.display = 'none';
                
                // Add notice
                const lineItemsHeader = document.querySelector('#editSOLineItems')?.previousElementSibling;
                if (lineItemsHeader) {
                    const notice = document.createElement('div');
                    notice.style.cssText = 'background: #f0e8d0; border: 1px solid #b8a86b; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #7a6b40;';
                    notice.innerHTML = ' <strong>Line items locked</strong> - This order has been completed. Change status to edit lines.';
                    lineItemsHeader.insertAdjacentElement('afterend', notice);
                }
            }
            
            // Attach event listeners to all SO line items in the edit modal
            console.log('Attaching listeners to SO edit modal line items'); // DEBUG
            document.querySelectorAll('#editSOLineItems .edit-line-item').forEach(row => {
                attachEditLineItemListeners(row);
            });
            
            document.getElementById('modalEditBtn').style.display = 'none';
            // Reset save button to proper state (may have been changed by PO receive)
            const saveBtn = document.getElementById('modalSaveBtn');
            saveBtn.style.display = 'inline-block';
            saveBtn.textContent = ' Save Changes';
            saveBtn.onclick = function(event) { if(event && debounceButton(event.currentTarget)) saveOrderChanges(); };
        }
        
        let isSavingSOEdit = false; // Prevent double-click on SO edit
        
        async function saveSalesOrderChanges() {
            // Prevent double-click
            if (isSavingSOEdit) {
                console.log('Already saving SO edit, ignoring duplicate click');
                return;
            }
            
            const so = currentEditingOrder;
            
            // Collect line items
            const newLines = [];
            let totalAmount = 0;
            
            document.querySelectorAll('#editSOLineItems .edit-line-item').forEach(row => {
                const itemId = row.querySelector('.edit-item').value;
                const qty = parseInt(row.querySelector('.edit-qty').value) || 0;
                const price = parseFloat(row.querySelector('.edit-price').value) || 0;
                
                if (itemId && qty > 0) {
                    newLines.push({
                        itemId: itemId,
                        quantity: qty,
                        unitPrice: price,
                        originalItem: row.dataset.originalItem,
                        originalQty: parseInt(row.dataset.originalQty) || 0,
                        lineId: row.dataset.lineId
                    });
                    totalAmount += qty * price;
                }
            });
            
            if (newLines.length === 0) {
                showWarning('Please add at least one line item');
                return;
            }
            
            // ===== VALIDATION #1: Check for Duplicate Items =====
            const itemCounts = {};
            newLines.forEach(line => {
                itemCounts[line.itemId] = (itemCounts[line.itemId] || 0) + 1;
            });
            
            const duplicates = Object.entries(itemCounts).filter(([id, count]) => count > 1);
            if (duplicates.length > 0) {
                // Find item names for the warning message
                const duplicateNames = duplicates.map(([itemId]) => {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    return item ? item.Item_Description : itemId;
                }).join(', ');
                
                const continueWithDupes = await showConfirmModal(
                    ' Duplicate Items Detected',
                    `<p>The following items appear on multiple lines:</p>
                    <p style="background: #f0e8d0; padding: 10px; border-radius: 6px; font-weight: 600;">${duplicateNames}</p>
                    <p>This may be intentional (different prices), but could also be a mistake.</p>`,
                    'Continue Anyway',
                    'Review Order',
                    'warning'
                );
                
                if (!continueWithDupes) return;
            }
            
            // ===== VALIDATION #2: Check for Overpayment =====
            const amountPaid = parseFloat(document.getElementById('editSOAmountPaid').value) || 0;
            if (amountPaid > totalAmount + 0.01) { // Allow 1 cent rounding
                const overpayment = amountPaid - totalAmount;
                const continueWithOverpay = await showConfirmModal(
                    ' Overpayment Warning',
                    `<div style="text-align: left;">
                        <p><strong>Order Total:</strong> ${formatMoney(totalAmount)}</p>
                        <p><strong>Amount Paid:</strong> ${formatMoney(amountPaid)}</p>
                        <p style="color: #b88a8a;"><strong>Overpayment:</strong> ${formatMoney(overpayment)}</p>
                        <p style="margin-top: 15px;">You are entering MORE payment than the order total.</p>
                    </div>`,
                    'Continue (Show Overpaid)',
                    'Correct Amount',
                    'warning'
                );
                
                if (!continueWithOverpay) return;
            }
            
            const data = {
                soId: so.SO_ID,
                customerId: document.getElementById('editSOCustomerHidden')?.value || document.getElementById('editSOCustomer').value,
                invoiceNumber: document.getElementById('editSOInvoiceNumber').value,
                soDate: document.getElementById('editSODate').value,
                dueDate: document.getElementById('editSODueDate').value,
                paymentMethod: document.getElementById('editSOPaymentMethod').value,
                status: document.getElementById('editSOStatus').value,
                notes: document.getElementById('editSONotes').value,
                totalAmount: totalAmount,
                amountPaid: parseFloat(document.getElementById('editSOAmountPaid').value) || 0,
                lineItems: newLines  // FIXED: was 'lines', backend expects 'lineItems'
            };
            
            // Show changes preview before saving
            const confirmChanges = await showOrderChangesPreview('so', data, so);
            if (!confirmChanges) return;
            
            // Check if voiding - show confirmation
            const newStatus = document.getElementById('editSOStatus').value;
            const oldStatus = so.Status;
            if (newStatus === 'Voided' && oldStatus !== 'Voided') {
                const confirmVoid = await showConfirmModal(
                    ' Void Sales Order?',
                    `<div style="text-align: left;">
                        <p>This will:</p>
                        <ul style="margin: 10px 0 10px 20px;">
                            <li>Mark the order as <strong style="color: #b88a8a;">VOIDED</strong></li>
                            <li><strong style="color: #10b981;">ADD inventory back</strong> for all line items</li>
                            <li>Create adjustment log entries</li>
                            <li>Exclude from tax reports</li>
                        </ul>
                        <p style="color: #b88a8a; font-weight: 600;">This action cannot be easily undone.</p>
                    </div>`,
                    'Yes, Void ' + (so.Invoice_Number || so.SO_ID),
                    'Cancel',
                    'danger'
                );
                if (!confirmVoid) return;
            }
            
            showStatus('salesStatus', ' Saving changes...', 'info');
            
            // Set saving flag
            isSavingSOEdit = true;
            
            // Disable ALL modal buttons during save
            const saveBtn = document.getElementById('modalSaveBtn');
            const printBtn = document.getElementById('modalPrintBtn');
            const closeBtn = document.getElementById('modalCloseBtn');
            const editBtn = document.getElementById('modalEditBtn');
            
            const allModalBtns = [saveBtn, printBtn, closeBtn, editBtn].filter(b => b);
            allModalBtns.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            
            // Update save button text
            if (saveBtn) {
                saveBtn.innerHTML = ' Saving...';
            }
            
            showLoading('Updating Sales Order...');
            
            try {
                const result = await apiCall('updateSalesOrder', data);
                
                if (result && result.status === 'success') {
                showSuccessModal('Sales Order Updated!', 'Changes saved successfully.\n\nYou can now print the invoice or continue editing.');
                // DON'T close the modal - let user print or close manually
                // closeOrderModal();  // Removed - user will use Close button
                
                // Refresh the data in the modal to show updated values
                const updatedResult = await apiCall('getSalesOrders');
                if (updatedResult?.data) {
                    const updatedSO = updatedResult.data.find(s => s.SO_ID === so.SO_ID);
                    if (updatedSO) {
                        currentEditingOrder = updatedSO;
                        
                        // Update Payment Information display
                        const currentTotalDiv = document.getElementById('editSOCurrentTotal');
                        const previouslyPaidDiv = document.getElementById('editSOPreviouslyPaid');
                        const balanceDueDiv = document.getElementById('editSOBalanceDue');
                        const paymentDateDiv = document.getElementById('editSOPaymentDate');
                        
                        const newTotal = parseFloat(updatedSO.Total_Amount || 0);
                        const newPaid = parseFloat(updatedSO.Amount_Paid || 0);
                        const newBalance = newTotal - newPaid;
                        
                        if (currentTotalDiv) {
                            currentTotalDiv.innerHTML = `<strong>Current Total:</strong> ${formatMoney(newTotal)}`;
                        }
                        if (previouslyPaidDiv) {
                            previouslyPaidDiv.innerHTML = `<strong>Previously Paid:</strong> ${formatMoney(newPaid)}`;
                        }
                        if (balanceDueDiv) {
                            const balanceDisplay = Math.abs(newBalance) < 0.01 ? 0 : newBalance;
                            balanceDueDiv.innerHTML = `<strong>Balance Due:</strong> <span style="color: ${balanceDisplay > 0 ? '#e74c3c' : '#6b9a8d'};">$${balanceDisplay.toFixed(2)}</span>`;
                        }
                        
                        // Add or update Payment Date display
                        if (updatedSO.Payment_Date) {
                            if (paymentDateDiv) {
                                paymentDateDiv.innerHTML = `<strong>Payment Date:</strong> ${new Date(updatedSO.Payment_Date).toLocaleDateString()}`;
                            } else {
                                // Insert Payment Date if it doesn't exist
                                if (balanceDueDiv && balanceDueDiv.parentElement) {
                                    const newPaymentDateDiv = document.createElement('div');
                                    newPaymentDateDiv.id = 'editSOPaymentDate';
                                    newPaymentDateDiv.style.color = '#6b9a8d';
                                    newPaymentDateDiv.innerHTML = `<strong>Payment Date:</strong> ${new Date(updatedSO.Payment_Date).toLocaleDateString()}`;
                                    balanceDueDiv.parentElement.appendChild(newPaymentDateDiv);
                                }
                            }
                        }
                        
                        // Update the Amount Paid input
                        const amountPaidInput = document.getElementById('editSOAmountPaid');
                        if (amountPaidInput) {
                            amountPaidInput.value = newPaid.toFixed(2);
                        }
                    }
                }
                
                loadSales();
                } else {
                    showStatus('salesStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                }
            } finally {
                // Always reset the flag and restore ALL buttons
                hideLoading();
                isSavingSOEdit = false;
                allModalBtns.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                });
                if (saveBtn) {
                    saveBtn.innerHTML = ' Save Changes';
                }
            }
        }
        
        async function recordPurchasePayment(poId, total, amountPaid) {
            let remaining = total - amountPaid;
            if (Math.abs(remaining) < 0.01) remaining = 0;
            
            // Create better formatted prompt
            let message = ` Record Payment for ${poId}\n\n`;
            message += `Invoice Total:    ${formatMoney(total)}\n`;
            message += `Already Paid:     ${formatMoney(amountPaid)}\n`;
            message += `\n`;
            message += `Balance Due:      ${formatMoney(remaining)}\n\n`;
            
            // Suggest full payment if unpaid
            if (amountPaid === 0) {
                message += `Tip: Enter ${remaining.toFixed(2)} to pay in full\n\n`;
            }
            
            message += `Enter payment amount:`;
            
            const payment = prompt(message);
            
            if (payment === null) return; // Cancelled
            
            const paymentAmount = parseFloat(payment);
            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                showWarning('Please enter a valid payment amount');
                return;
            }
            
            if (paymentAmount > remaining + 0.01) { // Allow 1 cent rounding
                const confirmed = await showConfirmModal(
                    ' Overpayment',
                    `<p>Payment <strong>${formatMoney(paymentAmount)}</strong> is more than balance due <strong>${formatMoney(remaining)}</strong>.</p><p>Continue anyway?</p>`,
                    'Continue',
                    'Cancel',
                    'warning'
                );
                if (!confirmed) {
                    return;
                }
            }
            
            // Call backend - send TOTAL amount paid (existing + new payment)
            const newTotalPaid = amountPaid + paymentAmount;
            const paymentDate = getTodayLocalDate(); // Default to today
            apiCall('recordPurchasePayment', { poId: poId, amountPaid: newTotalPaid, paymentDate: paymentDate })
                .then(result => {
                    if (result && result.status === 'success') {
                        const statusMsg = result.paymentStatus === 'Paid' ? 'PAID IN FULL!' : `Status: ${result.paymentStatus}`;
                        loadPurchases();
                        showSuccessModal('Payment Recorded!', `${formatMoney(newTotalPaid)} total paid.\n\n${statusMsg}`);
                    } else {
                        showStatus('purchasesStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                    }
                })
                .catch(err => {
                    showStatus('purchasesStatus', ' Error recording payment: ' + err.message, 'error');
                });
        }

        // ==================== SALES ====================

        function showAddSaleForm() {
            // MOBILE FIX: Always reset the save lock when opening form
            isSavingSale = false;
            
            // Reset form first
            document.querySelector('#addSaleForm form').reset();
            
            loadSaleDropdowns();
            
            // FIX #1: Clear any previous line items and errors before showing
            const lineItemsContainer = document.getElementById('soLineItems');
            if (lineItemsContainer) {
                lineItemsContainer.innerHTML = '';
            }
            
            document.getElementById('addSaleForm').style.display = 'block';
            
            // Re-enable selects that were disabled at startup (when form was hidden)
            const form = document.getElementById('addSaleForm');
            form.querySelectorAll('select').forEach(sel => {
                sel.disabled = false;
                sel.style.pointerEvents = '';
            });
            
            // Auto-populate today's date for Sale Date
            const today = new Date().toISOString().split('T')[0];
            const soDateField = document.getElementById('soDate');
            if (soDateField) {
                soDateField.value = today;
            }
            
            // Auto-populate Due Date (default to 30 days from now)
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            const soDueDateField = document.getElementById('soDueDate');
            if (soDueDateField) {
                soDueDateField.value = dueDate.toISOString().split('T')[0];
            }
            
            // Auto-populate Status (default to Pending)
            const soStatusField = document.getElementById('soStatus');
            const soStatusDisplay = document.getElementById('soStatus_display');
            if (soStatusField) {
                soStatusField.value = 'Pending';
            }
            if (soStatusDisplay) {
                soStatusDisplay.value = ' Pending - Order placed';
            }
            
            // Add fresh line item (skip customer check since form just opened)
            addSOLineItem(true);
            
            // Setup event listeners for the initial line item
            setTimeout(() => {
                const firstRow = document.querySelector('#soLineItems .line-item-row');
                if (firstRow) {
                    const itemSelect = firstRow.querySelector('.so-item');
                    const qtyInput = firstRow.querySelector('.so-qty');
                    const priceInput = firstRow.querySelector('.so-price');
                    const removeBtn = firstRow.querySelector('.remove-btn');
                    
                    if (itemSelect) {
                        itemSelect.addEventListener('change', function() {
                            updateSOItemInfo(this);
                        });
                    }
                    
                    if (qtyInput) {
                        qtyInput.addEventListener('input', function() {
                            const row = this.closest('.line-item-row');
                            const itemSelect = row.querySelector('.so-item');
                            if (itemSelect.value) {
                                updateSOItemInfo(itemSelect);
                            }
                            calculateSOTotal();
                        });
                    }
                    
                    if (priceInput) {
                        priceInput.addEventListener('input', function() {
                            calculateSOTotal();
                        });
                    }
                    
                    if (removeBtn) {
                        removeBtn.addEventListener('click', function() {
                            removeLineItem(this);
                            calculateSOTotal();
                        });
                    }
                }
                
                // Initialize summary boxes
                calculateSOTotal();
            }, 100);
        }

        function hideAddSaleForm() {
            document.getElementById('addSaleForm').style.display = 'none';
            document.querySelector('#addSaleForm form').reset();
            
            // MOBILE FIX: Always reset save lock and button state
            isSavingSale = false;
            const submitBtn = document.querySelector('#addSaleForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = ' Save Sale';
            }
            
            // Reset Create Sale button
            const createBtn = document.getElementById('createSaleBtn');
            if (createBtn) {
                createBtn.disabled = false;
                createBtn.innerHTML = ' Create Sale';
            }
            
            // Reset summary boxes
            const qtyBox = document.getElementById('soTotalQty');
            const amountBox = document.getElementById('soTotalAmount');
            if (qtyBox) qtyBox.textContent = '0';
            if (amountBox) amountBox.textContent = '$0.00';
            
            // FIX #1: Clear all error messages and line items
            const lineItemsContainer = document.getElementById('soLineItems');
            if (lineItemsContainer) {
                // Remove all line items completely
                lineItemsContainer.innerHTML = '';
                // Add back one fresh line item (skip customer check since form is being reset)
                addSOLineItem(true);
            }
        }

        async function loadSaleDropdowns() {
            if (cachedCustomers.length === 0) {
                const result = await apiCall('getCustomers');
                if (result && result.status === 'success') {
                    cachedCustomers = result.data;
                }
            }

            const select = document.getElementById('soCustomer');
            select.innerHTML = '<option value="">Select Customer</option>';
            cachedCustomers.forEach(c => {
                select.innerHTML += `<option value="${c.Customer_ID}">${c.Customer_Name}</option>`;
            });
            
            // Add change handler to enable line items when customer is selected
            select.onchange = function() {
                enableSOLineItems();
            };

            // ALWAYS refresh items to get current stock quantities
            const result = await apiCall('getItems');
            if (result && result.status === 'success') {
                cachedItems = result.data;
                console.log('loadSaleDropdowns: Refreshed items with current stock'); // DEBUG
            }

            console.log('loadSaleDropdowns: Populating dropdowns with', cachedItems.length, 'items'); // DEBUG
            
            document.querySelectorAll('.so-item').forEach(select => {
                select.innerHTML = '<option value="">Select Item</option>';
                cachedItems.forEach(item => {
                    select.innerHTML += `<option value="${item.Item_ID}" data-price="${item.Unit_Sell_Price}" data-stock="${item.Qty_On_Hand || 0}">${item.Item_Description}</option>`;
                });
            });
            
            console.log('loadSaleDropdowns: Dropdown populated!'); // DEBUG
        }
        
        // Enable SO line items when customer is selected
        function enableSOLineItems() {
            const customerId = document.getElementById('soCustomer').value;
            if (!customerId) return;
            
            // Filter to only show active items
            const activeItems = cachedItems.filter(item => item.Status !== 'Archived');
            
            // Enable and populate all SO item dropdowns
            document.querySelectorAll('#soLineItems .so-item').forEach(select => {
                select.disabled = false;
                select.style.border = '2px solid #667eea';
                select.style.background = 'white';
                select.innerHTML = '<option value="">Select Item</option>';
                activeItems.forEach(item => {
                    select.innerHTML += `<option value="${item.Item_ID}" data-price="${item.Unit_Sell_Price}" data-stock="${item.Qty_On_Hand || 0}">${item.Item_Description}</option>`;
                });
            });
            
            // Enable quantity and price inputs
            document.querySelectorAll('#soLineItems .so-qty, #soLineItems .so-price').forEach(input => {
                input.disabled = false;
            });
        }

        function addSOLineItem(skipCustomerCheck = false) {
            const container = document.getElementById('soLineItems');
            const customerId = document.getElementById('soCustomer').value;
            
            // Check if customer is selected first (unless skipped for initial form setup)
            if (!skipCustomerCheck && !customerId) {
                showWarning('Please select a customer first');
                return;
            }
            
            // Get all items once
            if (cachedItems.length === 0 && customerId) {
                showWarning('Please wait for items to load');
                return;
            }
            
            // Filter to only show active items
            const activeItems = cachedItems.filter(item => item.Status !== 'Archived');
            
            // If no customer selected, show placeholder dropdown
            const itemOptions = customerId 
                ? `<option value="">Select Item</option>${activeItems.map(item => {
                    return `<option value="${item.Item_ID}" data-price="${item.Unit_Sell_Price}" data-stock="${item.Qty_On_Hand || 0}">${item.Item_Description}</option>`;
                  }).join('')}`
                : `<option value=""> Select Customer First</option>`;
            
            const isDisabled = !customerId;
            
            const newRow = document.createElement('div');
            newRow.className = 'line-item-row';
            newRow.style.cssText = 'display: grid; grid-template-columns: 2.5fr 1fr 1fr 50px; gap: 10px; margin-bottom: 10px; align-items: end;';
            newRow.innerHTML = `
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                    <select class="so-item" required style="padding: 14px 12px; border: 2px solid ${isDisabled ? '#ccc' : '#667eea'}; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: ${isDisabled ? '#f5f5f5' : 'white'}; width: 100%;" ${isDisabled ? 'disabled' : ''}>
                        ${itemOptions}
                    </select>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Quantity</label>
                    <input type="number" class="so-qty" placeholder="0" min="1" required style="padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px; width: 100%;" ${isDisabled ? 'disabled' : ''}>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Price</label>
                    <input type="number" class="so-price" placeholder="0.00" step="0.01" min="0" required style="padding: 14px 10px; border: 2px solid #667eea; border-radius: 8px; text-align: center; font-size: 16px; min-height: 52px; background: white; width: 100%;" ${isDisabled ? 'disabled' : ''}>
                </div>
                <button type="button" class="remove-btn" style="min-height: 52px; font-size: 18px; margin-top: 26px;"></button>
                <div class="so-stock-info" style="grid-column: 1 / -1; font-size: 13px; padding: 5px 10px; margin-top: -5px; display: none;"></div>
            `;
            container.appendChild(newRow);
            
            // Attach event listeners programmatically (CSP-safe)
            const itemSelect = newRow.querySelector('.so-item');
            const qtyInput = newRow.querySelector('.so-qty');
            const priceInput = newRow.querySelector('.so-price');
            const removeBtn = newRow.querySelector('.remove-btn');
            
            console.log('Attaching listeners to:', itemSelect); // DEBUG
            
            itemSelect.addEventListener('change', function() {
                console.log('CHANGE EVENT FIRED!'); // DEBUG
                updateSOItemInfo(this);
            });
            
            qtyInput.addEventListener('input', function() {
                // Update stock info when quantity changes
                const row = this.closest('.line-item-row');
                const itemSelect = row.querySelector('.so-item');
                if (itemSelect.value) {
                    updateSOItemInfo(itemSelect);
                }
                calculateSOTotal();
            });
            
            priceInput.addEventListener('input', function() {
                calculateSOTotal();
            });
            
            removeBtn.addEventListener('click', function() {
                removeLineItem(this);
                calculateSOTotal();
            });
            
            console.log('Event listeners attached successfully!'); // DEBUG
        }
        
        function updateSOItemInfo(selectElement) {
            console.log('updateSOItemInfo called!'); // DEBUG
            const option = selectElement.options[selectElement.selectedIndex];
            
            const price = option.getAttribute('data-price');
            const stock = parseFloat(option.getAttribute('data-stock')) || 0;
            
            // Get item data for additional fields
            const itemId = option.value;
            const item = (cachedItems || []).find(i => i.Item_ID === itemId);
            const onOrder = item ? (parseInt(item.Qty_On_Order) || 0) : 0;
            const onBackorder = item ? (parseInt(item.Qty_On_Backorder) || 0) : 0;
            const expectedArrival = window.itemExpectedArrivals?.[itemId] || null;
            const expectedQty = window.itemExpectedQty?.[itemId] || 0;
            
            const row = selectElement.closest('.line-item-row');
            const priceInput = row.querySelector('.so-price');
            const qtyInput = row.querySelector('.so-qty');
            const stockInfoDiv = row.querySelector('.so-stock-info');
            
            if (price) {
                console.log('Setting price to:', price); // DEBUG
                priceInput.value = price;
            }
            
            // Show comprehensive stock info
            if (stockInfoDiv && option.value) {
                stockInfoDiv.style.display = 'block';
                
                const qty = parseFloat(qtyInput.value) || 0;
                const remaining = stock - qty;
                
                // Build status HTML
                let statusHtml = `<div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">`;
                statusHtml += `<span> <strong>On Hand:</strong> ${stock}</span>`;
                if (onOrder > 0) {
                    statusHtml += `<span style="color: #b8a86b;"> <strong>On Order:</strong> ${onOrder}`;
                    if (expectedArrival) {
                        statusHtml += ` (${expectedArrival})`;
                    }
                    statusHtml += `</span>`;
                }
                if (onBackorder > 0) {
                    statusHtml += `<span style="color: #b88a8a;"> <strong>Committed:</strong> ${onBackorder}</span>`;
                }
                statusHtml += `</div>`;
                
                let bgColor = '#e3f2fd';
                let borderColor = '#90caf9';
                
                if (qty > 0) {
                    statusHtml += `<div style="margin-top: 6px; font-weight: 600;">`;
                    
                    if (remaining < 0) {
                        const shortage = Math.abs(remaining);
                        bgColor = '#ffebee';
                        borderColor = '#ef5350';
                        
                        if (onOrder >= shortage) {
                            statusHtml += `<span style="color: #b8a86b;"> Short ${shortage} units - but ${onOrder} on order`;
                            if (expectedArrival) {
                                statusHtml += ` (arriving ${expectedArrival})`;
                            }
                            statusHtml += `</span>`;
                        } else {
                            statusHtml += `<span style="color: #c62828;"> INSUFFICIENT STOCK! Short ${shortage} units</span>`;
                        }
                    } else if (remaining === 0) {
                        bgColor = '#fff3e0';
                        borderColor = '#ffb74d';
                        statusHtml += `<span style="color: #e65100;"> Will deplete stock to zero</span>`;
                    } else if (remaining < 10) {
                        bgColor = '#fff3e0';
                        borderColor = '#ffb74d';
                        statusHtml += `<span style="color: #ef6c00;"> Low stock after sale: ${remaining} remaining</span>`;
                    } else {
                        statusHtml += `<span style="color: #2e7d32;"> OK - ${remaining} will remain after sale</span>`;
                    }
                    
                    statusHtml += `</div>`;
                }
                
                stockInfoDiv.innerHTML = statusHtml;
                stockInfoDiv.style.background = bgColor;
                stockInfoDiv.style.border = `2px solid ${borderColor}`;
                stockInfoDiv.style.borderRadius = '6px';
            }
            
            calculateSOTotal();
        }
        
        function calculateSOTotal() {
            let total = 0;
            let totalItems = 0;
            let totalUnits = 0;
            
            document.querySelectorAll('#soLineItems .line-item-row').forEach(row => {
                const qty = parseInt(row.querySelector('.so-qty')?.value) || 0;
                const price = parseFloat(row.querySelector('.so-price')?.value) || 0;
                const lineTotal = qty * price;
                total += lineTotal;
                totalItems += qty > 0 ? 1 : 0; // Count number of different items
                totalUnits += qty; // Total units being sold
            });
            
            // Update hidden total field (if exists)
            const totalField = document.getElementById('soTotal');
            if (totalField) {
                totalField.value = total.toFixed(2);
            }
            
            // Update summary boxes
            const qtyBox = document.getElementById('soTotalQty');
            const unitsBox = document.getElementById('soTotalUnits');
            const amountBox = document.getElementById('soTotalAmount');
            
            if (qtyBox) qtyBox.textContent = totalItems;
            if (unitsBox) unitsBox.textContent = totalUnits;
            if (amountBox) amountBox.textContent = formatMoney(total);
        }

        let isSavingSale = false; // Prevent double-click
        
        function showOrderPreview() {
            // ===== VALIDATION =====
            const missingFields = [];
            
            // Check customer
            const customerSelect = document.getElementById('soCustomer');
            const customerId = customerSelect?.value;
            const customerName = customerSelect?.options[customerSelect.selectedIndex]?.text || 'Customer';
            
            if (!customerId) {
                missingFields.push(' Customer');
            }
            
            // Check sale date
            const soDate = document.getElementById('soDate')?.value;
            if (!soDate) {
                missingFields.push(' Sale Date');
            }
            
            // Check due date
            const soDueDate = document.getElementById('soDueDate')?.value;
            if (!soDueDate) {
                missingFields.push(' Due Date');
            }
            
            // Check status
            const soStatus = document.getElementById('soStatus')?.value;
            if (!soStatus) {
                missingFields.push(' Status');
            }
            
            // Get line items
            const lineItems = [];
            let totalQty = 0;
            let totalAmount = 0;
            
            document.querySelectorAll('#soLineItems .line-item-row').forEach(row => {
                const itemSelect = row.querySelector('.so-item');
                const itemId = itemSelect?.value;
                const itemName = itemSelect?.options[itemSelect.selectedIndex]?.text || '';
                const qty = parseInt(row.querySelector('.so-qty')?.value) || 0;
                const price = parseFloat(row.querySelector('.so-price')?.value) || 0;
                const lineTotal = qty * price;
                
                if (itemId && qty > 0) {
                    // Get item details from cache
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    lineItems.push({
                        name: item?.Item_Description || itemName,
                        sku: item?.SKU || '',
                        qty: qty,
                        price: price,
                        total: lineTotal
                    });
                    totalQty += qty;
                    totalAmount += lineTotal;
                }
            });
            
            if (lineItems.length === 0) {
                missingFields.push(' At least one line item with quantity');
            }
            
            // Show validation errors if any
            if (missingFields.length > 0) {
                showWarning(`Please complete the following required fields:\n\n${missingFields.join('\n')}`);
                return;
            }
            
            // Build preview HTML
            let html = `
                <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eee;">
                    <div style="font-size: 13px; color: #666; margin-bottom: 4px;">Customer</div>
                    <div style="font-size: 18px; font-weight: 600; color: #1e3a5f;">${customerName}</div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 13px; color: #666; margin-bottom: 10px; font-weight: 600;">ORDER ITEMS</div>
            `;
            
            lineItems.forEach((item, index) => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${index % 2 === 0 ? '#f8fafc' : 'white'}; border-radius: 8px; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333;">${item.name}</div>
                            <div style="font-size: 12px; color: #666;">${item.sku}  ${item.qty}  ${formatMoney(item.price)}</div>
                        </div>
                        <div style="font-weight: 700; color: #1e3a5f; font-size: 16px;">${formatMoney(item.total)}</div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <!-- Colorful Summary Boxes -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px;">
                    <div style="text-align: center; padding: 15px 10px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 10px; border: 2px solid #1e88e5;">
                        <div style="font-size: 12px; color: #1565c0; margin-bottom: 4px; font-weight: 600;">Items</div>
                        <div style="font-size: 24px; font-weight: bold; color: #1e88e5;">${lineItems.length}</div>
                    </div>
                    <div style="text-align: center; padding: 15px 10px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 10px; border: 2px solid #f9a825;">
                        <div style="font-size: 12px; color: #ef6c00; margin-bottom: 4px; font-weight: 600;">Units</div>
                        <div style="font-size: 24px; font-weight: bold; color: #f9a825;">${totalQty}</div>
                    </div>
                    <div style="text-align: center; padding: 15px 10px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 10px; border: 2px solid #6b9a8d;">
                        <div style="font-size: 12px; color: #2e7d32; margin-bottom: 4px; font-weight: 600;">Total</div>
                        <div style="font-size: 24px; font-weight: bold; color: #6b9a8d;">${formatMoney(totalAmount)}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('orderPreviewContent').innerHTML = html;
            
            // Reset the confirm button state before showing modal
            const confirmBtn = document.getElementById('soConfirmSaveBtn');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = ' Confirm & Save';
                confirmBtn.dataset.saving = 'false';
            }
            
            document.getElementById('orderPreviewModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closeOrderPreview() {
            document.getElementById('orderPreviewModal').style.display = 'none';
            document.body.style.overflow = '';
            // Reset button state when closing
            const btn = document.getElementById('soConfirmSaveBtn');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = ' Confirm & Save';
                btn.dataset.saving = 'false';
            }
        }
        
        async function submitSaleWithLoading(btn) {
            // Guard: Only proceed if user actually clicked the button
            if (!btn || btn.disabled) {
                console.log('submitSaleWithLoading called but button is invalid or disabled');
                return;
            }
            
            // Prevent double-click
            if (btn.dataset.saving === 'true') {
                console.log('Already saving, ignoring duplicate call');
                return;
            }
            btn.dataset.saving = 'true';
            
            // Show loading state on preview button
            btn.disabled = true;
            btn.innerHTML = ' Saving...';
            
            // Also disable back button
            const backBtn = btn.previousElementSibling;
            if (backBtn) backBtn.disabled = true;
            
            // Update main Create Sale button too
            const mainBtn = document.getElementById('createSaleBtn');
            if (mainBtn) {
                mainBtn.disabled = true;
                mainBtn.innerHTML = ' Saving Sale...';
            }
            
            // Close preview and submit form
            document.getElementById('orderPreviewModal').style.display = 'none';
            document.body.style.overflow = '';
            document.querySelector('#addSaleForm form').requestSubmit();
        }
        
        function submitPOWithLoading(btn) {
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = ' Saving PO...';
            
            // Also disable back button
            const backBtn = btn.previousElementSibling;
            if (backBtn) backBtn.disabled = true;
            
            // Update main Create PO button too
            const mainBtn = document.getElementById('savePOBtn');
            if (mainBtn) {
                mainBtn.disabled = true;
                mainBtn.innerHTML = ' Saving PO...';
            }
            
            // Close preview and submit form
            document.getElementById('poPreviewModal').style.display = 'none';
            document.body.style.overflow = '';
            
            // Submit the form
            const form = document.querySelector('#addPurchaseForm form');
            if (form) {
                form.requestSubmit();
            } else {
                console.error('Could not find #addPurchaseForm form');
                showWarning('Error: Could not submit form');
            }
        }
        
        function closePOPreview() {
            document.getElementById('poPreviewModal').style.display = 'none';
            document.body.style.overflow = '';
            // Reset button state when closing
            const btn = document.getElementById('poConfirmSaveBtn');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = ' Confirm & Save';
            }
        }

        async function addSale(e) {
            e.preventDefault();
            
            // Prevent double-click
            if (isSavingSale) {
                console.log('Already saving sale, ignoring duplicate click');
                return;
            }
            
            const lineItems = [];
            let calculatedTotal = 0;
            
            document.querySelectorAll('#soLineItems .line-item-row').forEach(row => {
                const itemId = row.querySelector('.so-item').value;
                const qty = parseInt(row.querySelector('.so-qty').value) || 0;
                const price = parseFloat(row.querySelector('.so-price').value) || 0;
                const lineTotal = qty * price;
                
                // Only add valid line items (has item selected, qty > 0)
                if (itemId && qty > 0) {
                    // Look up cost info from cached items to store at time of sale
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    const packageCost = parseFloat(item?.Package_Cost) || 0;
                    const unitsPerPackage = parseFloat(item?.Units_Per_Package) || 1;
                    const unitCost = packageCost / unitsPerPackage;
                    
                    lineItems.push({
                        itemId: itemId,
                        quantity: qty,
                        unitPrice: price,
                        unitCost: unitCost,              // Cost at time of sale
                        unitsPerPackage: unitsPerPackage  // Package size at time of sale
                    });
                    calculatedTotal += lineTotal;
                }
            });

            // Validate at least one line item
            if (lineItems.length === 0) {
                showWarning('Please add at least one item to the sale.\n\nSelect an item and enter a quantity before saving.');
                return;
            }

            // ===== VALIDATION #1: Check for Duplicate Items =====
            const itemCounts = {};
            lineItems.forEach(line => {
                itemCounts[line.itemId] = (itemCounts[line.itemId] || 0) + 1;
            });
            
            const duplicates = Object.entries(itemCounts).filter(([id, count]) => count > 1);
            if (duplicates.length > 0) {
                // Find item names for the warning message
                const duplicateNames = duplicates.map(([itemId]) => {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    return item ? item.Item_Description : itemId;
                }).join(', ');
                
                const continueWithDupes = await showConfirmModal(
                    ' Duplicate Items Detected',
                    `<p>The following items appear on multiple lines:</p>
                    <p style="background: #f0e8d0; padding: 10px; border-radius: 6px; font-weight: 600;">${duplicateNames}</p>
                    <p>This may be intentional (different prices), but could also be a mistake.</p>`,
                    'Continue Anyway',
                    'Review Order',
                    'warning'
                );
                
                if (!continueWithDupes) return;
            }
            
            // ===== VALIDATION #2: Check for Overpayment =====
            const amountPaid = parseFloat(document.getElementById('soAmountPaid').value) || 0;
            if (amountPaid > calculatedTotal + 0.01) { // Allow 1 cent rounding
                const overpayment = amountPaid - calculatedTotal;
                const continueWithOverpay = await showConfirmModal(
                    ' Overpayment Warning',
                    `<div style="text-align: left;">
                        <p><strong>Order Total:</strong> ${formatMoney(calculatedTotal)}</p>
                        <p><strong>Amount Paid:</strong> ${formatMoney(amountPaid)}</p>
                        <p style="color: #b88a8a;"><strong>Overpayment:</strong> ${formatMoney(overpayment)}</p>
                        <p style="margin-top: 15px;">You are entering MORE payment than the order total.</p>
                    </div>`,
                    'Continue (Show Overpaid)',
                    'Correct Amount',
                    'warning'
                );
                
                if (!continueWithOverpay) return;
            }

            // LOCK - Prevent double submit
            isSavingSale = true;
            
            // Find and disable ALL form buttons
            const submitBtn = document.querySelector('#addSaleForm button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : '';
            const printBtn = document.querySelector('#addSaleForm button[onclick*="Print"]');
            const clearBtn = document.querySelector('#addSaleForm button[onclick*="clearSaleForm"], #addSaleForm button[onclick*="Clear"]');
            const cancelBtn = document.querySelector('#addSaleForm button[onclick*="hideAddSaleForm"]');
            
            const allSOFormBtns = [submitBtn, printBtn, clearBtn, cancelBtn].filter(b => b);
            allSOFormBtns.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            
            if (submitBtn) {
                submitBtn.textContent = ' Saving...';
            }
            
            showLoading('Creating Sales Order...');
            
            try {
                // Validate required fields
                const status = document.getElementById('soStatus').value;
                const dueDate = document.getElementById('soDueDate').value;
                
                // Helper to re-enable buttons on validation failure
                const reEnableSOFormBtns = () => {
                    hideLoading();
                    isSavingSale = false;
                    allSOFormBtns.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    });
                    if (submitBtn) submitBtn.textContent = originalText;
                };
                
                if (!status) {
                    showStatus('salesStatus', ' Please select a Status', 'error');
                    reEnableSOFormBtns();
                    document.getElementById('soStatus').focus();
                    return;
                }
                
                if (!dueDate) {
                    showStatus('salesStatus', ' Please select a Due Date', 'error');
                    reEnableSOFormBtns();
                    document.getElementById('soDueDate').focus();
                    return;
                }
                
                // AUTO-GENERATE INVOICE NUMBER
                // Format: INV-MMDDYY-XXX (e.g., INV-120725-001)
                const saleDate = document.getElementById('soDate').value;
                const dateObj = saleDate ? new Date(saleDate) : new Date();
                
                // Format date as MMDDYY
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                const year = String(dateObj.getFullYear()).slice(-2); // Last 2 digits
                const dateStr = `${month}${day}${year}`;
                
                // Get all existing sales orders to find the next number for this date
                const existingSales = await apiCall('getSalesOrders');
                let nextNumber = 1;
                
                if (existingSales && existingSales.data && existingSales.data.length > 0) {
                    // Find highest invoice number for this date
                    const prefix = `INV-${dateStr}-`;
                    const todayInvoices = existingSales.data
                        .filter(so => so.Invoice_Number && so.Invoice_Number.startsWith(prefix))
                        .map(so => {
                            const parts = so.Invoice_Number.split('-');
                            return parseInt(parts[2]) || 0;
                        });
                    
                    if (todayInvoices.length > 0) {
                        nextNumber = Math.max(...todayInvoices) + 1;
                    }
                }
                
                // Generate invoice number: INV-120725-001
                const invoiceNumber = `INV-${dateStr}-${String(nextNumber).padStart(3, '0')}`;

                // Get the selected date and add current time in local format
                const selectedDate = document.getElementById('soDate').value;
                const now = new Date();
                const timeStr = now.toTimeString().split(' ')[0]; // HH:MM:SS
                const saleDateWithTime = `${selectedDate}T${timeStr}`; // YYYY-MM-DDTHH:MM:SS (local time)

                const data = {
                    customerId: document.getElementById('soCustomer').value,
                    saleDate: saleDateWithTime,
                    invoiceNumber: invoiceNumber,
                    paymentMethod: document.getElementById('soPayment').value,
                    dueDate: document.getElementById('soDueDate').value || null,
                    totalAmount: calculatedTotal,
                    amountPaid: parseFloat(document.getElementById('soAmountPaid').value) || 0,
                    status: document.getElementById('soStatus').value,
                    notes: document.getElementById('soNotes').value,
                    lineItems: lineItems  // FIXED: was "lines", backend expects "lineItems"
                };

                const result = await apiCall('createSalesOrder', data);
                
                if (result && result.status === 'success') {
                    hideAddSaleForm();
                    loadSales();
                    // Refresh items to update stock quantities
                    loadItems();
                    showSuccessModal('Sale Recorded!', `Invoice #: ${invoiceNumber}\n\nInventory has been updated.`);
                } else {
                    showStatus('salesStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                }
            } finally {
                // UNLOCK and re-enable ALL buttons
                hideLoading();
                isSavingSale = false;
                
                allSOFormBtns.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                });
                
                if (submitBtn) {
                    submitBtn.textContent = originalText || ' Save Sale';
                }
            }
        }

        let salesData = []; // Cache for filtering
        window.salesData = salesData; // Also expose globally for COGS calculation
        
        // Helper function for mobile-safe date formatting
        function formatDateSafe(dateValue) {
            if (!dateValue) return '-';
            try {
                const date = new Date(dateValue);
                if (isNaN(date.getTime())) return '-';
                // Use manual formatting instead of toLocaleDateString for mobile compatibility
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const year = date.getFullYear();
                return `${month}/${day}/${year}`;
            } catch (e) {
                return '-';
            }
        }
        
        function formatTimeSafe(dateValue) {
            if (!dateValue) return '-';
            try {
                const date = new Date(dateValue);
                if (isNaN(date.getTime())) return '-';
                // Format time in 12-hour format
                let hours = date.getHours();
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // 0 becomes 12
                return `${hours}:${minutes} ${ampm}`;
            } catch (e) {
                return '-';
            }
        }
        
        // Get sortable date string (YYYY-MM-DD) for proper sorting
        function getSortableDate(dateValue) {
            if (!dateValue) return '';
            try {
                const date = new Date(dateValue);
                if (isNaN(date.getTime())) return '';
                return date.toISOString();
            } catch (e) {
                return '';
            }
        }
        
        async function loadSales(forceRefresh = false) {
            const salesTable = document.getElementById('salesTable');
            if (salesTable) {
                salesTable.innerHTML = '<div class="loading">Loading sales...</div>';
            }
            
            // Load customers FIRST if not cached
            if (cachedCustomers.length === 0) {
                const custResult = await apiCall('getCustomers');
                if (custResult && custResult.status === 'success') {
                    cachedCustomers = custResult.data;
                } else {
                    console.error('Failed to load customers:', custResult);
                }
            }
            
            // Now load and display sales - add timestamp to bust caching if forced
            console.log('Calling getSalesOrders...');
            const result = await apiCall('getSalesOrders', forceRefresh ? { _t: Date.now() } : {});
            console.log('getSalesOrders result:', result);
            
            if (result && result.status === 'success') {
                salesData = result.data;
                window.salesData = salesData; // Keep global reference updated
                if (salesTable) {
                    displaySales(result.data);
                    loadSaleFilterCustomers(); // Populate filter dropdown
                }
                // COGS is calculated from existing sales data - no separate load needed
                if (forceRefresh) {
                    showStatus('salesStatus', ' Sales refreshed!', 'success');
                }
            } else {
                console.error('getSalesOrders failed:', result);
                const errorMsg = result?.message || 'Unknown error - check console';
                if (salesTable) {
                    salesTable.innerHTML = `<div class="loading">Error loading sales: ${errorMsg}</div>`;
                }
            }
        }
        
        async function loadSaleFilterCustomers() {
            if (cachedCustomers.length === 0) {
                const result = await apiCall('getCustomers');
                if (result && result.status === 'success') {
                    cachedCustomers = result.data;
                }
            }
            
            const select = document.getElementById('filterSaleCustomer');
            select.innerHTML = '<option value="">All Customers</option>';
            cachedCustomers.forEach(c => {
                select.innerHTML += `<option value="${c.Customer_ID}">${c.Customer_Name}</option>`;
            });
        }
        
        function filterSales() {
            const customerFilter = document.getElementById('filterSaleCustomer').value;
            const invoiceNumberFilter = document.getElementById('filterInvoiceNumber').value.trim().toLowerCase();
            const dateFrom = document.getElementById('filterSaleDateFrom').value;
            const dateTo = document.getElementById('filterSaleDateTo').value;
            const statusFilter = document.getElementById('filterSaleStatus')?.value || '';
            
            console.log('Filtering sales with dates:', dateFrom, 'to', dateTo); // Debug
            
            const filtered = salesData.filter(so => {
                // Use matchesFilter for multi-select support
                const matchesCustomer = matchesFilter(so.Customer_ID, customerFilter);
                const matchesInvoice = !invoiceNumberFilter || (so.Invoice_Number && so.Invoice_Number.toLowerCase().includes(invoiceNumberFilter));
                
                // FIX: Check both Sale_Date and SO_Date (like displaySales does)
                const soDate = new Date(so.Sale_Date || so.SO_Date);
                
                // Date FROM comparison (start of day) - use global parseLocalDate helper
                let matchesDateFrom = true;
                if (dateFrom) {
                    const fromDateObj = parseLocalDate(dateFrom);
                    fromDateObj.setHours(0, 0, 0, 0);
                    matchesDateFrom = soDate >= fromDateObj;
                }
                
                // Date TO comparison (end of day - 23:59:59)
                let matchesDateTo = true;
                if (dateTo) {
                    const toDateObj = parseLocalDate(dateTo);
                    toDateObj.setHours(23, 59, 59, 999);
                    matchesDateTo = soDate <= toDateObj;
                }
                
                // Status filter
                let matchesStatus = true;
                if (statusFilter === 'exclude-voided') {
                    matchesStatus = so.Status !== 'Voided';
                } else if (statusFilter) {
                    matchesStatus = so.Status === statusFilter;
                }
                
                return matchesCustomer && matchesInvoice && matchesDateFrom && matchesDateTo && matchesStatus;
            });
            
            console.log('Filtered results:', filtered.length, 'orders'); // Debug
            displaySales(filtered);
        }
        
        function clearSaleFilters() {
            document.getElementById('filterSaleCustomer').value = '';
            document.getElementById('filterInvoiceNumber').value = '';
            document.getElementById('filterInvoiceNumber_display').value = '';  // Clear display input too
            document.getElementById('filterSaleDateFrom').value = '';
            document.getElementById('filterSaleDateTo').value = '';
            if (document.getElementById('filterSaleStatus')) {
                document.getElementById('filterSaleStatus').value = '';
            }
            selectedInvoicesForSales = [];  // Reset the selection array
            displaySales(salesData);
        }
        
        // Apply date filter from oval buttons
        function applySalesDateFilter(period, evt) {
            console.log('Date filter clicked:', period); // Debug
            activeSalesFilter = period; // Track active filter
            
            const now = new Date();
            let fromDate = null;
            let toDate = null; // Leave null to include future-dated orders
            
            // Calculate date ranges - only set fromDate, leave toDate open
            switch(period) {
                case 'today':
                    fromDate = new Date(now);
                    toDate = new Date(now); // Today only - both dates same
                    break;
                case 'week':
                    fromDate = new Date(now);
                    fromDate.setDate(now.getDate() - 7);
                    // No toDate - include future orders
                    break;
                case '3months':
                    fromDate = new Date(now);
                    fromDate.setMonth(now.getMonth() - 3);
                    break;
                case '6months':
                    fromDate = new Date(now);
                    fromDate.setMonth(now.getMonth() - 6);
                    break;
                case '9months':
                    fromDate = new Date(now);
                    fromDate.setMonth(now.getMonth() - 9);
                    break;
                case 'ytd':
                    fromDate = new Date(now.getFullYear(), 0, 1); // Jan 1st this year
                    break;
                case '1year':
                    fromDate = new Date(now);
                    fromDate.setFullYear(now.getFullYear() - 1);
                    break;
                case '3years':
                    fromDate = new Date(now);
                    fromDate.setFullYear(now.getFullYear() - 3);
                    break;
                case '5years':
                    fromDate = new Date(now);
                    fromDate.setFullYear(now.getFullYear() - 5);
                    break;
                case 'all':
                    // Show everything - set date range fields to empty
                    console.log('Clearing date filters'); // Debug
                    document.getElementById('filterSaleDateFrom').value = '';
                    document.getElementById('filterSaleDateTo').value = '';
                    filterSales();
                    updateSalesFilterButtons(period);
                    return;
            }
            
            // Format dates for input fields using LOCAL time (global helper)
            const fromDateStr = fromDate ? formatLocalDate(fromDate) : '';
            const toDateStr = toDate ? formatLocalDate(toDate) : '';
            
            console.log('Setting dates:', fromDateStr, 'to', toDateStr || '(open)'); // Debug
            
            // Set filter fields
            document.getElementById('filterSaleDateFrom').value = fromDateStr;
            document.getElementById('filterSaleDateTo').value = toDateStr;
            
            // Apply filter
            filterSales();
            
            console.log('Filter applied'); // Debug
            
            // Update button active state
            updateSalesFilterButtons(period);
        }
        
        // Track active sales filter
        let activeSalesFilter = 'all';
        
        function updateSalesFilterButtons(activePeriod) {
            setTimeout(() => {
                document.querySelectorAll('.oval-filter-btn-so').forEach(btn => {
                    const onclick = btn.getAttribute('onclick') || '';
                    const isActive = onclick.includes(`'${activePeriod}'`);
                    btn.style.opacity = isActive ? '1' : '0.6';
                    btn.style.transform = isActive ? 'scale(1.05)' : 'scale(1)';
                    btn.style.boxShadow = isActive ? '0 4px 12px rgba(0,0,0,0.3)' : '0 2px 4px rgba(0,0,0,0.1)';
                });
            }, 50);
        }

        function displaySales(orders) {
            if (!orders || orders.length === 0) {
                document.getElementById('salesTable').innerHTML = '<p>No sales yet. Record your first sale!</p>';
                return;
            }

            // Calculate totals
            let totalAmount = 0;
            let totalPaid = 0;
            
            // Cache sales for row click
            window.cachedSales = orders;
            
            // Calculate totals first
            orders.forEach(so => {
                totalAmount += parseFloat(so.Total_Amount || so.Order_Total) || 0;
                totalPaid += parseFloat(so.Amount_Paid) || 0;
            });
            const balance = totalAmount - totalPaid;
            
            // SINGLE CARD - Buttons directly above boxes (like Inventory)
            let html = `
                <div class="sales-data-card">
                    <!-- Oval Buttons - Muted Professional Colors -->
                    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 20px;">
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; padding-bottom: 10px;">
                            <button onclick="applySalesDateFilter('today', event)" class="oval-filter-btn-so" style="background: #f5f5f5; color: #666; border: 2px solid #999; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 Last Day
                            </button>
                            <button onclick="applySalesDateFilter('week', event)" class="oval-filter-btn-so" style="background: #f5f0e0; color: #8a7a4a; border: 2px solid #b8a86b; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 Last Week
                            </button>
                            <button onclick="applySalesDateFilter('3months', event)" class="oval-filter-btn-so" style="background: #f5f0e0; color: #8a7a4a; border: 2px solid #b8a86b; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 Last 3 Months
                            </button>
                            <button onclick="applySalesDateFilter('6months', event)" class="oval-filter-btn-so" style="background: #e8f0e8; color: #5a7a6d; border: 2px solid #6b9a8d; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 6 Months
                            </button>
                            <button onclick="applySalesDateFilter('9months', event)" class="oval-filter-btn-so" style="background: #e8f0f5; color: #5a7a8a; border: 2px solid #7a9bb8; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 9 Months
                            </button>
                            <button onclick="applySalesDateFilter('ytd', event)" class="oval-filter-btn-so" style="background: #f0e8f0; color: #7a6a8a; border: 2px solid #9a8ab8; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 YTD
                            </button>
                            <button onclick="applySalesDateFilter('1year', event)" class="oval-filter-btn-so" style="background: #f5eaea; color: #8a6a6a; border: 2px solid #b88a8a; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 1 Year
                            </button>
                            <button onclick="applySalesDateFilter('3years', event)" class="oval-filter-btn-so" style="background: #e8f0f5; color: #5a7a8a; border: 2px solid #7a9bb8; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 3 Years
                            </button>
                            <button onclick="applySalesDateFilter('5years', event)" class="oval-filter-btn-so" style="background: #e8f0e8; color: #5a7a6d; border: 2px solid #6b9a8d; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 5 Years
                            </button>
                            <button onclick="applySalesDateFilter('all', event)" class="oval-filter-btn-so active" style="background: #4a5568; color: white; border: 2px solid #4a5568; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 All Time
                            </button>
                        </div>
                    </div>
            `;
            
            // Summary boxes (directly below buttons) - Muted Professional Colors
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="background: linear-gradient(135deg, #e8f0f5, #d4e4ef); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #7a9bb8;">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Total Sales</div>
                        <div style="font-size: 28px; font-weight: bold; color: #7a9bb8;">$${totalAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 12px; color: #888;">${orders.length} orders</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f0e8, #d4e8dc); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #6b9a8d;">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Collected</div>
                        <div style="font-size: 28px; font-weight: bold; color: #6b9a8d;">$${totalPaid.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 12px; color: #888;">${((totalPaid/totalAmount)*100 || 0).toFixed(0)}% collected</div>
                    </div>
                    <div style="background: linear-gradient(135deg, ${balance > 0 ? '#f5eaea, #edd8d8' : '#e8f0e8, #d4e8dc'}); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid ${balance > 0 ? '#b88a8a' : '#6b9a8d'};">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Outstanding</div>
                        <div style="font-size: 28px; font-weight: bold; color: ${balance > 0 ? '#b88a8a' : '#6b9a8d'};">$${balance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 12px; color: #888;">${balance > 0 ? 'to collect' : 'all paid!'}</div>
                    </div>
                </div>
            `;
            
            html += '<div class="table-scroll-wrapper"><table class="data-table" id="salesDataTable"><thead><tr>';
            html += '<th>Invoice #</th><th>Customer</th><th>Sale Date</th><th>Total</th><th>Paid</th><th>Due Date</th><th>Paid Date</th><th>Payment</th><th>Status</th>';
            html += '</tr></thead><tbody>';

            orders.forEach(so => {
                const dueDate = formatDateSafe(so.Due_Date);
                const amountPaid = parseFloat(so.Amount_Paid) || 0;
                const total = parseFloat(so.Total_Amount || so.Order_Total) || 0;
                const invoiceNum = so.Invoice_Number || so.SO_ID;
                const saleDateTime = so.Sale_Date || so.SO_Date;
                
                // Debug logging for status
                if (orders.indexOf(so) < 3) {
                    console.log(`SO ${invoiceNum} Status from API:`, so.Status, '| Full SO:', so);
                }
                
                // Calculate payment status from actual amounts (don't rely on stored field)
                let paymentStatus;
                if (amountPaid > total + 0.01 && total > 0) {
                    paymentStatus = 'Overpaid';
                } else if (amountPaid >= total - 0.01 && total > 0) {
                    paymentStatus = 'Paid';
                } else if (amountPaid > 0) {
                    paymentStatus = 'Partial';
                } else {
                    paymentStatus = 'Unpaid';
                }
                
                // Color code payment status badge
                let paymentBadge = '';
                if (paymentStatus === 'Overpaid') paymentBadge = '<span style="background: #9333ea; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;"> Overpaid</span>';
                else if (paymentStatus === 'Paid') paymentBadge = '<span style="background: #6b9a8d; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Paid</span>';
                else if (paymentStatus === 'Partial') paymentBadge = '<span style="background: #b8a86b; color: black; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Partial</span>';
                else paymentBadge = '<span style="background: #b88a8a; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Unpaid</span>';
                
                // Order status badge
                const orderStatus = so.Status || 'Pending';
                let statusBadge = '';
                if (orderStatus === 'Delivered') statusBadge = '<span style="background: #6b9a8d; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;"> Delivered</span>';
                else if (orderStatus === 'Completed') statusBadge = '<span style="background: #6b9a8d; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;"> Completed</span>';
                else if (orderStatus === 'Out for Delivery') statusBadge = '<span style="background: #7aaab8; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;"> Out for Delivery</span>';
                else if (orderStatus === 'Ready') statusBadge = '<span style="background: #6f42c1; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;"> Ready</span>';
                else if (orderStatus === 'Voided') statusBadge = '<span style="background: #8a8a8a; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;"> Voided</span>';
                else if (orderStatus === 'Pending') statusBadge = '<span style="background: #b8a07a; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;"> Pending</span>';
                else statusBadge = `<span style="background: #8a8a8a; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${orderStatus}</span>`;
                
                html += `<tr style="cursor: pointer;" onclick="viewSalesOrder('${so.SO_ID}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                    <td><strong>${invoiceNum}</strong></td>
                    <td>${getCustomerName(so.Customer_ID)}</td>
                    <td data-sort="${getSortableDate(saleDateTime)}">${formatDateSafe(saleDateTime)} <span style="color: #666;">${formatTimeSafe(saleDateTime)}</span></td>
                    <td>${formatMoney(total)}</td>
                    <td>${formatMoney(amountPaid)}</td>
                    <td data-sort="${getSortableDate(so.Due_Date)}">${dueDate}</td>
                    <td data-sort="${getSortableDate(so.Payment_Date)}">${so.Payment_Date ? formatDateSafe(so.Payment_Date) : '-'}</td>
                    <td>${paymentBadge}</td>
                    <td>${statusBadge}</td>
                </tr>`;
            });

            html += '</tbody></table></div>'; // Close table and scroll wrapper
            html += '</div>'; // Close data card wrapper
            document.getElementById('salesTable').innerHTML = html;
            setTimeout(() => makeSortable('salesDataTable'), 0);
        }
        
        // View Sales Order (opens modal with print option)
        function viewSalesOrder(soId) {
            const so = window.cachedSales?.find(s => s.SO_ID === soId);
            if (so) {
                showSalesOrderDetails(so);
            }
        }
        
        // Edit Sales Order
        async function editSalesOrder(soId) {
            // Find the SO in cached data or fetch it
            const result = await apiCall('getSalesOrders');
            if (result && result.status === 'success') {
                const so = result.data.find(s => s.SO_ID === soId);
                if (so) {
                    showSalesOrderDetails(so);
                }
            }
        }
        
        async function showSalesOrderDetails(so) {
            currentEditingOrder = so;
            currentEditingType = 'sales';
            
            // Load items if not cached
            if (cachedItems.length === 0) {
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
            }
            
            // Load customers if not cached (for address display)
            if (cachedCustomers.length === 0) {
                const custResult = await apiCall('getCustomers');
                if (custResult && custResult.status === 'success') {
                    cachedCustomers = custResult.data;
                }
            }
            
            // Get line items - try cache first, then fetch if empty
            let lines = getSalesLinesFromCache(so.SO_ID);
            if (lines.length === 0) {
                // Fetch lines directly from API
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    lines = linesResult.data;
                    // Add to cache for future use
                    cachedSalesLines = cachedSalesLines.concat(lines);
                }
            }
            
            const customerName = getCustomerName(so.Customer_ID);
            // Get full customer object for address
            const customer = cachedCustomers.find(c => c.Customer_ID === so.Customer_ID);
            const customerAddress = customer ? [
                customer.Address,
                [customer.City, customer.State, customer.Zip].filter(Boolean).join(', ')
            ].filter(Boolean).join('<br>') : '';
            
            const dueDate = so.Due_Date ? new Date(so.Due_Date).toLocaleDateString() : '-';
            const invoiceDate = so.Invoice_Date ? new Date(so.Invoice_Date).toLocaleDateString() : '-';
            
            document.getElementById('modalTitle').textContent = `Sales Order: ${so.Invoice_Number || so.SO_ID}`;
            
            let html = `
                <!-- Card 1: Order & Payment Information -->
                <div class="content-card" style="margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3 style="margin-top: 0; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 8px;"> Order Information</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 8px 0; font-weight: bold; width: 140px;">Customer:</td><td><strong>${customerName}</strong>${customerAddress ? `<br><span style="font-size: 12px; color: #666;">${customerAddress}</span>` : ''}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Invoice #:</td><td>${so.Invoice_Number || '-'}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Sale Date:</td><td>${new Date(so.Sale_Date).toLocaleDateString()}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Invoice Date:</td><td>${invoiceDate}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Due Date:</td><td>${dueDate}</td></tr>
                                ${so.Payment_Date ? `<tr><td style="padding: 8px 0; font-weight: bold;">Payment Date:</td><td style="color: #6b9a8d;">${new Date(so.Payment_Date).toLocaleDateString()}</td></tr>` : ''}
                                <tr><td style="padding: 8px 0; font-weight: bold;">Payment Method:</td><td>${so.Payment_Method}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Status:</td><td><span style="background: #e0ebe7; color: #4a6b5f; padding: 4px 12px; border-radius: 12px; font-size: 12px; border: 2px solid #d0e0da;">${so.Status}</span></td></tr>
                            </table>
                        </div>
                        <div>
                            <h3 style="margin-top: 0; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 8px;"> Payment Information</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 8px 0; font-weight: bold; width: 140px;">Total Amount:</td><td style="font-size: 18px; color: #2c3e50;">${formatMoney(parseFloat(so.Total_Amount || 0))}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Amount Paid:</td><td style="color: #6b9a8d;">${formatMoney(parseFloat(so.Amount_Paid || 0))}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Balance Due:</td><td style="color: #e74c3c; font-size: 16px; font-weight: bold;">$${(() => {
                                    const balance = parseFloat(so.Total_Amount || 0) - parseFloat(so.Amount_Paid || 0);
                                    return (Math.abs(balance) < 0.01 ? 0 : balance).toFixed(2);
                                })()}</td></tr>
                                ${so.Payment_Date ? `<tr><td style="padding: 8px 0; font-weight: bold;">Payment Date:</td><td style="color: #6b9a8d;">${new Date(so.Payment_Date).toLocaleDateString()}</td></tr>` : ''}
                                <tr><td style="padding: 8px 0; font-weight: bold;">Payment Status:</td><td><span style="background: ${so.Payment_Status === 'Paid' ? '#e0ebe7' : '#f0e8d0'}; color: ${so.Payment_Status === 'Paid' ? '#4a6b5f' : '#7a6b40'}; padding: 4px 12px; border-radius: 12px; font-size: 12px; border: 2px solid ${so.Payment_Status === 'Paid' ? '#d0e0da' : '#e8dfc0'};">${so.Payment_Status}</span></td></tr>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            if (lines.length > 0) {
                // Calculate total discount for this order
                let orderListTotal = 0;
                let orderActualTotal = 0;
                lines.forEach(line => {
                    const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                    const qty = parseInt(line.Quantity) || 0;
                    const unitPrice = parseFloat(line.Unit_Price) || 0;
                    const listPrice = parseFloat(item?.Unit_Sell_Price) || 0;
                    orderListTotal += qty * listPrice;
                    orderActualTotal += qty * unitPrice;
                });
                const orderDiscount = orderListTotal - orderActualTotal;
                
                html += `
                    <!-- Card 2: Line Items -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin-top: 0; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 8px;"> Line Items${orderDiscount > 0.01 ? ` <span style="font-size: 13px; font-weight: normal; color: #b88a8a; margin-left: 10px;">(${formatMoney(orderDiscount)} discount)</span>` : ''}</h3>
                        <div style="overflow-x: auto;">
                        <table class="data-table" style="margin-bottom: 0; font-size: 14px;">
                            <thead>
                                <tr style="background: #667eea; color: white;">
                                    <th style="padding: 12px 15px;">Item</th>
                                    <th style="padding: 12px 15px;">Description</th>
                                    <th style="padding: 12px 15px;">Qty</th>
                                    <th style="padding: 12px 15px;">List Price</th>
                                    <th style="padding: 12px 15px;">Sold Price</th>
                                    <th style="padding: 12px 15px;">Discount</th>
                                    <th style="padding: 12px 15px;">Line Total</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                lines.forEach(line => {
                    const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                    const qty = parseInt(line.Quantity) || 0;
                    const unitPrice = parseFloat(line.Unit_Price) || 0;
                    const listPrice = parseFloat(item?.Unit_Sell_Price) || 0;
                    const lineTotal = qty * unitPrice;
                    const lineListTotal = qty * listPrice;
                    const lineDiscount = lineListTotal - lineTotal;
                    const hasDiscount = lineDiscount > 0.01;
                    
                    html += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px 15px;"><strong>${item?.SKU || line.Item_ID}</strong></td>
                            <td style="padding: 12px 15px;">${item ? item.Item_Description : '-'}</td>
                            <td style="padding: 12px 15px; text-align: center; font-weight: bold;">${qty}</td>
                            <td style="padding: 12px 15px; text-align: right; color: #b8a86b;">${formatMoney(listPrice)}</td>
                            <td style="padding: 12px 15px; text-align: right;${hasDiscount ? ' color: #6b9a8d; font-weight: 600;' : ''}">${formatMoney(unitPrice)}</td>
                            <td style="padding: 12px 15px; text-align: right; color: ${hasDiscount ? '#b88a8a' : '#999'}; font-weight: ${hasDiscount ? '600' : 'normal'};">${hasDiscount ? formatMoney(lineDiscount) : '-'}</td>
                            <td style="padding: 12px 15px; text-align: right; font-weight: bold;">${formatMoney(lineTotal)}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                    </div>
                    </div>
                `;
            }
            
            if (so.Notes) {
                html += `
                    <!-- Card 3: Notes -->
                    <div class="content-card">
                        <h3 style="color: var(--primary, #667eea); margin-top: 0; margin-bottom: 10px; border-bottom: 2px solid #667eea; padding-bottom: 8px;"> Notes</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #e0e0e0;">
                            ${so.Notes}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalEditBtn').style.display = 'inline-block';
            document.getElementById('modalPrintBtn').style.display = 'inline-block';
            document.getElementById('modalPrintBtn').textContent = ' Print Invoice';
            document.getElementById('modalPrintBtn').onclick = () => printInvoice();
            document.getElementById('modalSaveBtn').style.display = 'none';
            document.getElementById('orderModal').style.display = 'block'; document.body.classList.add('modal-open');
        }
        
        function recordSalesPayment(soId, total, amountPaid) {
            let remaining = total - amountPaid;
            if (Math.abs(remaining) < 0.01) remaining = 0;
            
            // Create beautiful payment modal
            const modalHtml = `
                <div id="paymentModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: white; border-radius: 16px; max-width: 420px; width: 100%; box-shadow: 0 25px 50px rgba(0,0,0,0.25); overflow: hidden;">
                        <!-- Header -->
                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px 25px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; font-size: 18px;"> Record Payment</h3>
                                <button onclick="document.getElementById('paymentModal').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px;"></button>
                            </div>
                            <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">${soId}</div>
                        </div>
                        
                        <!-- Summary Cards -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; border-bottom: 1px solid #e5e7eb;">
                            <div style="padding: 20px; text-align: center; background: #f0fdf4; border-right: 1px solid #e5e7eb;">
                                <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Invoice Total</div>
                                <div style="font-size: 24px; font-weight: bold; color: #333;">${formatMoney(total)}</div>
                            </div>
                            <div style="padding: 20px; text-align: center; background: ${remaining > 0 ? '#fef2f2' : '#f0fdf4'};">
                                <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Balance Due</div>
                                <div style="font-size: 24px; font-weight: bold; color: ${remaining > 0 ? '#b88a8a' : '#6b9a8d'};">${formatMoney(remaining)}</div>
                            </div>
                        </div>
                        
                        <!-- Already Paid -->
                        <div style="padding: 15px 25px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #666;">Already Paid:</span>
                                <span style="font-weight: 600; color: #6b9a8d;">${formatMoney(amountPaid)}</span>
                            </div>
                        </div>
                        
                        <!-- Payment Input -->
                        <div style="padding: 25px;">
                            <label style="display: block; font-weight: 600; color: #333; margin-bottom: 8px;">Payment Amount *</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span style="font-size: 24px; color: #666;">$</span>
                                <input type="number" id="paymentAmountInput" step="0.01" min="0" placeholder="${remaining.toFixed(2)}" value="${remaining.toFixed(2)}"
                                    style="flex: 1; padding: 15px; font-size: 24px; border: 2px solid #e5e7eb; border-radius: 12px; text-align: right; font-weight: bold;"
                                    onkeypress="if(event.key==='Enter')document.getElementById('submitPaymentBtn').click()">
                            </div>
                            <div style="margin-top: 8px; font-size: 13px; color: #666;">
                                ${remaining > 0 ? ` Tip: Enter <strong>${remaining.toFixed(2)}</strong> to pay in full` : ' Already paid in full!'}
                            </div>
                        </div>
                        
                        <!-- Quick Amount Buttons -->
                        ${remaining > 0 ? `
                        <div style="padding: 0 25px 20px 25px;">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="document.getElementById('paymentAmountInput').value='${remaining.toFixed(2)}'" 
                                    style="flex: 1; padding: 10px; background: #ecfdf5; border: 2px solid #10b981; border-radius: 8px; color: #059669; font-weight: 600; cursor: pointer;">
                                    Pay in Full
                                </button>
                                ${remaining > 10 ? `<button onclick="document.getElementById('paymentAmountInput').value='${(remaining/2).toFixed(2)}'" 
                                    style="flex: 1; padding: 10px; background: #fff7ed; border: 2px solid #b8a07a; border-radius: 8px; color: #ea580c; font-weight: 600; cursor: pointer;">
                                    Half (${formatMoney(remaining/2)})
                                </button>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Buttons -->
                        <div style="padding: 20px 25px; background: #f9fafb; display: flex; gap: 12px;">
                            <button id="paymentCancelBtn" onclick="document.getElementById('paymentModal').remove()" 
                                style="flex: 1; padding: 14px; background: white; border: 2px solid #d1d5db; border-radius: 10px; font-weight: 600; cursor: pointer; color: #374151;">
                                Cancel
                            </button>
                            <button id="submitPaymentBtn" onclick="submitPaymentFromModal('${soId}', ${total}, ${amountPaid})" 
                                style="flex: 2; padding: 14px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; font-size: 16px;">
                                 Record Payment
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove any existing modal
            const existing = document.getElementById('paymentModal');
            if (existing) existing.remove();
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Focus on input
            setTimeout(() => {
                const input = document.getElementById('paymentAmountInput');
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 100);
        }
        
        async function submitPaymentFromModal(soId, total, amountPaid) {
            const input = document.getElementById('paymentAmountInput');
            const paymentAmount = parseFloat(input.value);
            
            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                input.style.borderColor = '#b88a8a';
                input.focus();
                return;
            }
            
            const remaining = total - amountPaid;
            
            if (paymentAmount > remaining + 0.01) {
                const confirmed = await showConfirmModal(
                    ' Overpayment',
                    `<p>Payment <strong>${formatMoney(paymentAmount)}</strong> is more than balance due <strong>${formatMoney(remaining)}</strong>.</p><p>Continue anyway?</p>`,
                    'Continue',
                    'Cancel',
                    'warning'
                );
                if (!confirmed) {
                    return;
                }
            }
            
            // Close modal
            document.getElementById('paymentModal').remove();
            
            // Call backend
            const newTotalPaid = amountPaid + paymentAmount;
            const invoiceTotal = total;
            
            apiCall('recordSalesPayment', { soId: soId, amountPaid: newTotalPaid })
                .then(result => {
                    if (result && result.status === 'success') {
                        const remaining = invoiceTotal - newTotalPaid;
                        const isPaidInFull = remaining < 0.01;
                        
                        if (isPaidInFull) {
                            showSuccessModal('Payment Recorded!', `Payment Applied: ${formatMoney(paymentAmount)}\nInvoice Total: ${formatMoney(invoiceTotal)}\nTotal Paid: ${formatMoney(newTotalPaid)}\n\n PAID IN FULL!`);
                        } else {
                            showSuccessModal('Payment Recorded!', `Payment Applied: ${formatMoney(paymentAmount)}\nInvoice Total: ${formatMoney(invoiceTotal)}\nTotal Paid: ${formatMoney(newTotalPaid)}\nRemaining: ${formatMoney(remaining)}`);
                        }
                        
                        // Refresh the report if we're in Action Dashboard or any report
                        reportDataCacheTime = null;  // Clear report cache
                        if (document.getElementById('reportSetupModal')?.style.display !== 'none') {
                            setTimeout(() => executeReport(), 100);
                        }
                        
                        loadSales();
                    } else {
                        showError('Error: ' + (result?.message || 'Unknown error'));
                    }
                })
                .catch(err => {
                    showError('Error recording payment: ' + err.message);
                });
        }

        // ==================== INVENTORY ====================

        let inventoryData = []; // Cache for filtering
        
        async function loadInventory(forceRefresh = false) {
            document.getElementById('inventoryTable').innerHTML = '<div class="loading">Loading inventory...</div>';
            
            // If force refresh, clear cached items too
            if (forceRefresh) {
                cachedItems = [];
                console.log(' Force refresh: Cleared cachedItems');
            }
            
            // Load suppliers FIRST if not cached
            if (cachedSuppliers.length === 0) {
                const suppResult = await apiCall('getSuppliers');
                if (suppResult && suppResult.status === 'success') {
                    cachedSuppliers = suppResult.data;
                }
            }
            
            // Now load and display inventory - add timestamp to bust any caching
            const result = await apiCall('getInventoryReport', forceRefresh ? { _t: Date.now() } : {});
            
            if (result && result.status === 'success') {
                inventoryData = result.data;
                // Also update cachedItems to keep in sync
                cachedItems = result.data;
                // Filter out archived items by default
                const activeItems = result.data.filter(item => item.Status !== 'Archived');
                displayInventory(activeItems);
                loadInventoryFilterSuppliers(); // Populate filter dropdown
                if (forceRefresh) {
                    showStatus('inventoryStatus', ' Inventory refreshed!', 'success');
                }
            } else {
                document.getElementById('inventoryTable').innerHTML = '<div class="loading">Error loading inventory</div>';
            }
        }
        
        async function loadInventoryFilterSuppliers() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }
            
            const select = document.getElementById('filterInventorySupplier');
            select.innerHTML = '<option value="">All Suppliers</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }
        
        function filterInventory() {
            const searchFilter = document.getElementById('filterInventorySearch').value.toLowerCase();
            const supplierFilter = document.getElementById('filterInventorySupplier').value;
            const stockFilter = document.getElementById('filterInventoryStock').value;
            
            const filtered = inventoryData.filter(item => {
                // Hide archived items in inventory view
                if (item.Status === 'Archived') return false;
                
                // Search filter - handles both Item_ID selections from picker and text search
                let matchesSearch = true;
                if (searchFilter) {
                    // Check if it looks like Item_IDs (comma-separated or single ID)
                    const searchValues = searchFilter.split(',').map(v => v.trim()).filter(v => v);
                    
                    // If any of the search values match an Item_ID exactly, treat as ID filter
                    const isItemIdFilter = searchValues.some(v => 
                        cachedItems && cachedItems.some(i => i.Item_ID && i.Item_ID.toLowerCase() === v)
                    );
                    
                    if (isItemIdFilter) {
                        // Match by Item_ID
                        matchesSearch = searchValues.some(v => 
                            item.Item_ID && item.Item_ID.toLowerCase() === v
                        );
                    } else {
                        // Text search in SKU and Description
                        matchesSearch = 
                            (item.SKU && item.SKU.toString().toLowerCase().includes(searchFilter)) ||
                            (item.Item_Description && item.Item_Description.toLowerCase().includes(searchFilter));
                    }
                }
                
                // Supplier filter - use matchesFilter for multi-select support
                const matchesSupplier = matchesFilter(item.Supplier_ID, supplierFilter);
                
                // Stock status filter - calculate dynamically based on qty vs reorder point
                let matchesStock = true;
                if (stockFilter) {
                    const qty = parseFloat(item.Qty_On_Hand) || 0;
                    const onOrder = parseFloat(item.Qty_On_Order) || 0;
                    const committed = parseFloat(item.Qty_On_Backorder) || 0;
                    const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                    const effectiveAvailable = qty - committed + onOrder;
                    
                    if (stockFilter === 'negative') matchesStock = qty < 0;
                    else if (stockFilter === 'out') matchesStock = qty === 0;
                    // Low stock = physical qty is low (shows current shelf state)
                    else if (stockFilter === 'low') matchesStock = qty > 0 && qty <= reorderPoint;
                    else if (stockFilter === 'ok') matchesStock = qty > reorderPoint;
                    // Needs reorder = effective available (with on-order) is still below reorder
                    else if (stockFilter === 'reorder') matchesStock = effectiveAvailable < reorderPoint && reorderPoint > 0;
                }
                
                return matchesSearch && matchesSupplier && matchesStock;
            });
            
            displayInventory(filtered);
        }
        
        function clearInventoryFilters() {
            document.getElementById('filterInventorySearch').value = '';
            document.getElementById('filterInventorySupplier').value = '';
            document.getElementById('filterInventoryStock').value = '';
            // Filter out archived items by default
            displayInventory(inventoryData.filter(item => item.Status !== 'Archived'));
        }
        
        function filterInventoryByStatus(status, event) {
            // Prevent scroll jump
            if (event) event.preventDefault();
            
            // Save scroll position
            const scrollPos = window.scrollY;
            
            // Set the dropdown to match
            const stockDropdown = document.getElementById('filterInventoryStock');
            if (stockDropdown) stockDropdown.value = status;
            
            // Use the unified filter function that respects ALL filters
            filterInventory();
            
            // Restore scroll position after render
            setTimeout(() => window.scrollTo(0, scrollPos), 0);
        }

        function displayInventory(items) {
            if (!items || items.length === 0) {
                document.getElementById('inventoryTable').innerHTML = '<p>No inventory yet.</p>';
                return;
            }

            // Calculate totals FIRST for summary
            let totalQty = 0;
            let totalCostValue = 0;
            let totalSellValue = 0;
            let totalCOGS = 0;
            let totalUnitsSold = 0;
            let negativeCount = 0;
            let outOfStockCount = 0;
            let lowStockCount = 0;
            let inStockCount = 0;
            
            // Check if COGS data is available
            const cogsAvailable = window.cogsCalculated === true;
            
            items.forEach(item => {
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const onOrder = parseFloat(item.Qty_On_Order) || 0;
                const committed = parseFloat(item.Qty_On_Backorder) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                const effectiveAvailable = qty - committed + onOrder;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPackage;
                const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                
                // Get COGS for this item (if calculated)
                const itemCogs = window.itemCOGS?.[item.Item_ID] || 0;
                const itemUnitsSold = window.itemUnitsSold?.[item.Item_ID] || 0;
                totalCOGS += itemCogs;
                totalUnitsSold += itemUnitsSold;
                
                totalQty += qty;
                // Use absolute value - negative inventory still has positive value
                totalCostValue += Math.abs(qty) * unitCost;
                totalSellValue += Math.abs(qty) * unitSellPrice;
                
                // Count based on physical qty for Negative/Out/In Stock
                // But "Low Stock" means needs reorder (effective available below reorder point)
                if (qty < 0) negativeCount++;
                else if (qty === 0) outOfStockCount++;
                else if (effectiveAvailable < reorderPoint && reorderPoint > 0) lowStockCount++;
                else inStockCount++;
            });
            
            // BUILD STATUS TAGS FIRST (clickable filters) - above summary boxes
            let html = `
                <div class="data-display-card">
                    <!-- Oval Filter Buttons -->
                    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 20px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${negativeCount > 0 ? `<span onclick="filterInventoryByStatus('negative', event)" class="oval-filter-btn" style="background: #b88a8a; color: white; padding: 8px 15px; border-radius: 20px; border: 3px solid #b88a8a; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"> ${negativeCount} Negative</span>` : ''}
                            ${outOfStockCount > 0 ? `<span onclick="filterInventoryByStatus('out', event)" class="oval-filter-btn" style="background: #b88a8a; color: white; padding: 8px 15px; border-radius: 20px; border: 3px solid #b88a8a; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"> ${outOfStockCount} Out of Stock</span>` : ''}
                            ${lowStockCount > 0 ? `<span onclick="filterInventoryByStatus('low', event)" class="oval-filter-btn" style="background: #b8a86b; color: white; padding: 8px 15px; border-radius: 20px; border: 3px solid #b8a86b; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"> ${lowStockCount} Low Stock</span>` : ''}
                            <span onclick="filterInventoryByStatus('ok', event)" class="oval-filter-btn" style="background: #6b9a8d; color: white; padding: 8px 15px; border-radius: 20px; border: 3px solid #6b9a8d; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"> ${inStockCount} In Stock</span>
                            <span onclick="filterInventoryByStatus('', event)" class="oval-filter-btn" style="background: #8a8a8a; color: white; padding: 8px 15px; border-radius: 20px; border: 3px solid #8a8a8a; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">Show All</span>
                        </div>
                    </div>
                    
                    <!-- Summary Boxes -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin: 20px 0;">
                        <div style="background: #f8f9fa; border: 2px solid #e0e0e0; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                            <div class="inv-summary-number" style="font-size: 28px; font-weight: bold; color: #212529; word-wrap: break-word; overflow-wrap: break-word;">${items.length}</div>
                            <div style="font-size: 13px; color: #8a8a8a;">Total Items</div>
                        </div>
                        <div style="background: #f8f9fa; border: 2px solid #e0e0e0; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                            <div class="inv-summary-number" style="font-size: 28px; font-weight: bold; color: #212529; word-wrap: break-word; overflow-wrap: break-word;">${totalQty.toLocaleString()}</div>
                            <div style="font-size: 13px; color: #8a8a8a;">Total Units</div>
                        </div>
                        <div style="background: #f8f9fa; border: 2px solid #e0e0e0; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                            <div class="inv-summary-number" style="font-size: 28px; font-weight: bold; color: #b88a8a; word-wrap: break-word; overflow-wrap: break-word;">$${totalCostValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div style="font-size: 13px; color: #8a8a8a;">Inventory Cost</div>
                        </div>
                        <div style="background: #f8f9fa; border: 2px solid #e0e0e0; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                            <div class="inv-summary-number" style="font-size: 28px; font-weight: bold; color: #6b9a8d; word-wrap: break-word; overflow-wrap: break-word;">$${totalSellValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div style="font-size: 13px; color: #8a8a8a;">Inventory Value</div>
                        </div>
                        <div style="background: ${cogsAvailable ? '#fff3e0' : '#f5f5f5'}; border: 2px solid ${cogsAvailable ? '#b8a86b' : '#e0e0e0'}; color: #495057; padding: 20px; border-radius: 12px; text-align: center;" title="Cost of Goods Sold - based on current item costs">
                            <div class="inv-summary-number" style="font-size: 28px; font-weight: bold; color: #e65100; word-wrap: break-word; overflow-wrap: break-word;">${cogsAvailable ? '$' + totalCOGS.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '...'}</div>
                            <div style="font-size: 13px; color: #8a8a8a;">COGS (All Time)</div>
                        </div>
                        <div style="background: #f8f9fa; border: 2px solid #e0e0e0; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                            <div class="inv-summary-number" style="font-size: 28px; font-weight: bold; color: ${(totalSellValue - totalCostValue) >= 0 ? '#1565c0' : '#c62828'}; word-wrap: break-word; overflow-wrap: break-word;">$${(totalSellValue - totalCostValue).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div style="font-size: 13px; color: #8a8a8a;">Potential Profit</div>
                        </div>
                    </div>
                    
                    <!-- COGS Methodology Note -->
                    ${cogsAvailable ? `
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 1px solid #6b9a8d; border-left: 4px solid #2e7d32; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 10px;">
                            <span style="font-size: 18px;"></span>
                            <div>
                                <strong style="color: #1b5e20;">COGS - Cost of Goods Sold</strong>
                                <p style="margin: 5px 0 0 0; font-size: 13px; color: #33691e;">
                                    Total COGS: <strong>$${totalCOGS.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong> 
                                    (${totalUnitsSold.toLocaleString()} units sold across ${window.cogsTotalOrders || 0} orders).
                                    Uses <strong>historical cost at time of sale</strong> when available, with current cost as fallback for older orders.
                                </p>
                            </div>
                        </div>
                    </div>
                    ` : `
                    <div style="background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 18px;"></span>
                            <div>
                                <strong style="color: #666;">Loading COGS Data...</strong>
                                <p style="margin: 5px 0 0 0; font-size: 13px; color: #888;">
                                    COGS data is loading from sales history. Visit the Sales tab to trigger data load.
                                </p>
                            </div>
                        </div>
                    </div>
                    `}
            `;
            
            // BUILD TABLE
            html += '<div class="table-scroll-wrapper"><table class="data-table" id="inventoryDataTable"><thead><tr>';
            html += '<th>SKU</th><th>Description</th><th>Supplier</th><th>Qty</th><th>On Order</th><th>Backorder</th><th>Reorder</th><th>Cost</th><th>Sell</th><th>Cost Value</th><th>Sell Value</th><th>Net Profit</th><th>Updated</th><th>Status</th>';
            html += '</tr></thead><tbody>';

            items.forEach(item => {
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const onOrder = parseFloat(item.Qty_On_Order) || 0;
                const backorder = parseFloat(item.Qty_On_Backorder) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                const lastUpdated = item.Last_Updated ? new Date(item.Last_Updated).toLocaleDateString() : '-';
                
                // Calculate values
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPackage;
                const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                // Use absolute value - negative inventory still has positive value
                const costValue = Math.abs(qty) * unitCost;
                const sellValue = Math.abs(qty) * unitSellPrice;
                const netProfit = sellValue - costValue;
                
                // Determine status with color coding
                let status = '';
                let statusStyle = '';
                let rowStyle = '';
                
                if (qty < 0) {
                    status = 'NEGATIVE';
                    statusStyle = 'background: #b88a8a; color: white;';
                    rowStyle = 'background: #f5eaea;';
                } else if (qty === 0) {
                    status = 'OUT OF STOCK';
                    statusStyle = 'background: #b88a8a; color: white;';
                    rowStyle = 'background: #f5eaea;';
                } else if (qty <= reorderPoint) {
                    status = 'LOW STOCK';
                    statusStyle = 'background: #b8a86b; color: white;';
                    rowStyle = 'background: #f5f0e0;';
                } else {
                    status = 'IN STOCK';
                    statusStyle = 'background: #6b9a8d; color: white;';
                }
                
                html += `<tr style="${rowStyle} cursor: pointer;" onclick="openItem('${item.Item_ID}')" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                    <td><strong>${item.SKU || '-'}</strong></td>
                    <td style="color: #667eea;"><strong>${item.Item_Description}</strong></td>
                    <td>${getSupplierName(item.Supplier_ID)}</td>
                    <td><strong style="${qty < 0 ? 'color: #b88a8a;' : ''}">${qty}</strong></td>
                    <td style="${onOrder > 0 ? 'color: #1976d2; font-weight: 600;' : 'color: #999;'}">${onOrder > 0 ? onOrder : '-'}</td>
                    <td style="${backorder > 0 ? 'color: #f57c00; font-weight: 600;' : 'color: #999;'}">${backorder > 0 ? backorder : '-'}</td>
                    <td>${reorderPoint}</td>
                    <td>$${unitCost.toFixed(3)}</td>
                    <td>${formatMoney(unitSellPrice)}</td>
                    <td>${formatMoney(costValue)}</td>
                    <td style="color: #6b9a8d; font-weight: bold;">${formatMoney(sellValue)}</td>
                    <td style="color: ${netProfit >= 0 ? '#7a9bb8' : '#b88a8a'}; font-weight: bold;">${formatMoney(netProfit)}</td>
                    <td style="font-size: 13px; color: #666;">${lastUpdated}</td>
                    <td><span style="${statusStyle} padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap;">${status}</span></td>
                </tr>`;
            });

            html += '</tbody></table></div>'; // Close table and scroll wrapper
            html += '</div>'; // Close data-display-card
            document.getElementById('inventoryTable').innerHTML = html;
            setTimeout(() => makeSortable('inventoryDataTable'), 0);
        }
        
        // Wrap displayInventory in error handler
        const originalDisplayInventory = displayInventory;
        displayInventory = function(items) {
            try {
                originalDisplayInventory(items);
            } catch(e) {
                console.error('Error displaying inventory:', e);
                document.getElementById('inventoryTable').innerHTML = '<div class="loading" style="color: red;">Error displaying inventory: ' + e.message + '</div>';
            }
        };
        
        // ==================== EXPENSE MANAGEMENT ====================
        
        let cachedExpenses = [];
        let cachedExpenseCategories = [];
        let cachedRecurringExpenses = [];
        let cachedMileageRates = [];
        
        // Show expense subtab
        function showExpenseSubtab(subtab) {
            // Update button states
            document.querySelectorAll('.expense-subtab').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#9333ea';
            });
            event.target.style.background = '#9333ea';
            event.target.style.color = 'white';
            
            // Hide all content
            document.querySelectorAll('.expense-content').forEach(el => el.style.display = 'none');
            
            // Show selected content
            if (subtab === 'log') {
                document.getElementById('expenseLogSubtab').style.display = 'block';
            } else if (subtab === 'recurring') {
                document.getElementById('expenseRecurringSubtab').style.display = 'block';
                displayRecurringExpenses();
            } else if (subtab === 'categories') {
                document.getElementById('expenseCategoriesSubtab').style.display = 'block';
                displayExpenseCategories();
            } else if (subtab === 'mileage') {
                document.getElementById('expenseMileageSubtab').style.display = 'block';
                displayMileageRates();
            }
        }
        
        // Load all expense data
        async function loadExpenses(options = {}) {
            const { categoriesOnly, expensesOnly, recurringOnly, mileageOnly } = options;
            const loadAll = !categoriesOnly && !expensesOnly && !recurringOnly && !mileageOnly;
            
            showLoading('Loading Expenses...');
            try {
                // Run API calls in parallel for speed
                const promises = [];
                
                if (loadAll || categoriesOnly) {
                    promises.push(apiCall('getExpenseCategories').then(result => {
                        if (result && result.status === 'success') {
                            cachedExpenseCategories = result.data || [];
                            populateCategoryFilter();
                        }
                    }));
                }
                
                if (loadAll || expensesOnly) {
                    promises.push(apiCall('getExpenses').then(result => {
                        if (result && result.status === 'success') {
                            cachedExpenses = result.data || [];
                        }
                    }));
                }
                
                if (loadAll || recurringOnly) {
                    promises.push(apiCall('getRecurringExpenses').then(result => {
                        if (result && result.status === 'success') {
                            cachedRecurringExpenses = result.data || [];
                        }
                    }));
                }
                
                if (loadAll || mileageOnly) {
                    promises.push(apiCall('getMileageRates').then(result => {
                        if (result && result.status === 'success') {
                            cachedMileageRates = result.data || [];
                        }
                    }));
                }
                
                // Wait for all to complete
                await Promise.all(promises);
                
                // Display expense log if we loaded expenses
                if (loadAll || expensesOnly) {
                    displayExpenseLog(cachedExpenses);
                }
                
            } catch (error) {
                showError('Error loading expenses: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Populate category filter dropdown
        function populateCategoryFilter() {
            const select = document.getElementById('expenseCategoryFilter');
            if (!select) return;
            select.innerHTML = '<option value="">All Categories</option>';
            cachedExpenseCategories.forEach(cat => {
                if (String(cat.Is_Active).toUpperCase() === 'TRUE') {
                    select.innerHTML += `<option value="${cat.Category_ID}">${cat.Category_Name}</option>`;
                }
            });
        }
        
        // Get category name by ID
        function getCategoryName(categoryId) {
            const cat = cachedExpenseCategories.find(c => c.Category_ID === categoryId);
            return cat ? cat.Category_Name : categoryId || 'Uncategorized';
        }
        
        // Filter expenses
        function filterExpenses() {
            const fromDate = document.getElementById('expenseFromDate').value;
            const toDate = document.getElementById('expenseToDate').value;
            const categoryId = document.getElementById('expenseCategoryFilter').value;
            
            let filtered = cachedExpenses;
            
            if (fromDate) {
                filtered = filtered.filter(exp => {
                    const expDate = new Date(exp.Expense_Date);
                    return expDate >= new Date(fromDate);
                });
            }
            
            if (toDate) {
                filtered = filtered.filter(exp => {
                    const expDate = new Date(exp.Expense_Date);
                    return expDate <= new Date(toDate + 'T23:59:59');
                });
            }
            
            if (categoryId) {
                filtered = filtered.filter(exp => exp.Category_ID === categoryId);
            }
            
            displayExpenseLog(filtered);
        }
        
        // Display expense log
        function displayExpenseLog(expenses) {
            const container = document.getElementById('expenseLogTable');
            if (!container) return;
            
            if (!expenses || expenses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">No expenses found. Click "Add Expense" to record your first expense.</p>';
                return;
            }
            
            // Sort by date descending
            expenses.sort((a, b) => new Date(b.Expense_Date) - new Date(a.Expense_Date));
            
            // Calculate total
            const total = expenses.reduce((sum, exp) => sum + (parseFloat(exp.Amount) || 0), 0);
            
            let html = `
                <div style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff); padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #9333ea;">
                    <div style="font-size: 12px; color: #666; text-transform: uppercase;">Total Expenses</div>
                    <div style="font-size: 28px; font-weight: bold; color: #9333ea;">${formatMoney(total)}</div>
                    <div style="font-size: 12px; color: #888;">${expenses.length} expense${expenses.length !== 1 ? 's' : ''}</div>
                </div>
            `;
            
            html += '<div class="table-scroll-wrapper"><table class="data-table" id="expenseDataTable"><thead><tr>';
            html += '<th>Date</th><th>Category</th><th>Description</th><th>Vendor</th><th>Amount</th><th>Actions</th>';
            html += '</tr></thead><tbody>';
            
            expenses.forEach(exp => {
                const isRecurring = exp.Recurring_ID ? '' : '';
                html += `<tr>
                    <td>${formatDateSafe(exp.Expense_Date)}</td>
                    <td>${getCategoryName(exp.Category_ID)}</td>
                    <td>${exp.Description || ''} ${isRecurring}</td>
                    <td>${exp.Vendor || '-'}</td>
                    <td style="font-weight: bold; color: #9333ea;">${formatMoney(parseFloat(exp.Amount) || 0)}</td>
                    <td>
                        <button class="btn-small" onclick="editExpense('${exp.Expense_ID}')" style="background: #7aaab8;"></button>
                        <button class="btn-small" onclick="deleteExpense('${exp.Expense_ID}')" style="background: #b88a8a;"></button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        // Display expense categories
        function displayExpenseCategories() {
            const container = document.getElementById('expenseCategoryTable');
            if (!container) return;
            
            if (!cachedExpenseCategories || cachedExpenseCategories.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">No categories found. Click "Add Category" to create your first expense category.</p>';
                return;
            }
            
            let html = '<div class="table-scroll-wrapper"><table class="data-table"><thead><tr>';
            html += '<th>Category Name</th><th>Type</th><th>P&L Impact</th><th>Status</th><th>Actions</th>';
            html += '</tr></thead><tbody>';
            
            cachedExpenseCategories.forEach(cat => {
                const isActive = String(cat.Is_Active).toUpperCase() === 'TRUE';
                const excludeFromProfit = String(cat.Exclude_From_Profit).toUpperCase() === 'TRUE';
                const isReimbursement = String(cat.Is_Reimbursement).toUpperCase() === 'TRUE';
                const typeColor = cat.Category_Type === 'Fixed' ? '#6b9a8d' : cat.Category_Type === 'Variable' ? '#b8a86b' : '#7aaab8';
                
                // Determine P&L impact display
                let plImpact;
                if (isReimbursement) {
                    plImpact = '<span style="background: #059669; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;"> Credit</span>';
                } else if (excludeFromProfit) {
                    plImpact = '<span style="background: #f59e0b; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;"> Tax Only</span>';
                } else {
                    plImpact = '<span style="background: #dc2626; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;"> Expense</span>';
                }
                
                html += `<tr>
                    <td><strong>${cat.Category_Name}</strong></td>
                    <td><span style="background: ${typeColor}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${cat.Category_Type || 'Variable'}</span></td>
                    <td>${plImpact}</td>
                    <td><span style="background: ${isActive ? '#6b9a8d' : '#b88a8a'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${isActive ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn-small" onclick="editCategory('${cat.Category_ID}')" style="background: #7aaab8;"></button>
                        <button class="btn-small" onclick="deleteCategory('${cat.Category_ID}')" style="background: #b88a8a;"></button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        // Display recurring expenses
        function displayRecurringExpenses() {
            const container = document.getElementById('recurringExpenseTable');
            if (!container) return;
            
            if (!cachedRecurringExpenses || cachedRecurringExpenses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">No recurring expenses set up. Click "Add Recurring" to create a recurring expense template.</p>';
                return;
            }
            
            let html = '<div class="table-scroll-wrapper"><table class="data-table"><thead><tr>';
            html += '<th>Description</th><th>Category</th><th>Amount</th><th>Frequency</th><th>Day</th><th>Status</th><th>Actions</th>';
            html += '</tr></thead><tbody>';
            
            cachedRecurringExpenses.forEach(rec => {
                const isActive = String(rec.Is_Active).toUpperCase() === 'TRUE';
                html += `<tr>
                    <td><strong>${rec.Description}</strong></td>
                    <td>${getCategoryName(rec.Category_ID)}</td>
                    <td style="font-weight: bold; color: #9333ea;">${formatMoney(parseFloat(rec.Amount) || 0)}</td>
                    <td>${rec.Frequency || 'Monthly'}</td>
                    <td>${rec.Day_Of_Month || 1}</td>
                    <td><span style="background: ${isActive ? '#6b9a8d' : '#b88a8a'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${isActive ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn-small" onclick="editRecurring('${rec.Recurring_ID}')" style="background: #7aaab8;"></button>
                        <button class="btn-small" onclick="deleteRecurring('${rec.Recurring_ID}')" style="background: #b88a8a;"></button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        // Display mileage rates
        function displayMileageRates() {
            const container = document.getElementById('mileageRateTable');
            if (!container) return;
            
            if (!cachedMileageRates || cachedMileageRates.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">No mileage rates configured. Click "Add Year" to set up IRS mileage rates.</p>';
                return;
            }
            
            // Sort by year descending
            cachedMileageRates.sort((a, b) => (parseInt(b.Year) || 0) - (parseInt(a.Year) || 0));
            
            let html = '<div class="table-scroll-wrapper"><table class="data-table"><thead><tr>';
            html += '<th>Year</th><th>Rate Per Mile</th><th>Effective Date</th><th>Notes</th><th>Actions</th>';
            html += '</tr></thead><tbody>';
            
            cachedMileageRates.forEach(rate => {
                html += `<tr>
                    <td><strong>${rate.Year}</strong></td>
                    <td style="font-weight: bold; color: #9333ea;">$${(parseFloat(rate.Rate_Per_Mile) || 0).toFixed(3)}</td>
                    <td>${formatDateSafe(rate.Effective_Date)}</td>
                    <td>${rate.Notes || ''}</td>
                    <td>
                        <button class="btn-small" onclick="editMileageRate('${rate.Year}')" style="background: #7aaab8;"></button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        // Show Add Expense Modal
        function showAddExpenseModal(expenseId = null) {
            const expense = expenseId ? cachedExpenses.find(e => e.Expense_ID === expenseId) : null;
            const isEdit = !!expense;
            
            let categoryOptions = '<option value="">Select Category</option>';
            cachedExpenseCategories.forEach(cat => {
                if (String(cat.Is_Active).toUpperCase() === 'TRUE') {
                    const selected = expense && expense.Category_ID === cat.Category_ID ? 'selected' : '';
                    categoryOptions += `<option value="${cat.Category_ID}" ${selected}>${cat.Category_Name}</option>`;
                }
            });
            
            const modalHtml = `
                <div id="expenseModal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100001; overflow-y: auto; padding: 20px; box-sizing: border-box;">
                    <div style="max-width: 500px; margin: 20px auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%); color: white; padding: 20px; text-align: center;">
                            <h2 style="margin: 0; font-size: 24px;"> ${isEdit ? 'Edit' : 'Add'} Expense</h2>
                        </div>
                        <div style="padding: 20px;">
                            <input type="hidden" id="editExpenseId" value="${expense?.Expense_ID || ''}">
                            <div class="form-group">
                                <label> Date *</label>
                                <input type="date" id="expenseDate" value="${expense?.Expense_Date ? new Date(expense.Expense_Date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]}" required>
                            </div>
                            <div class="form-group">
                                <label> Category *</label>
                                <select id="expenseCategory" required>${categoryOptions}</select>
                            </div>
                            <div class="form-group">
                                <label> Description *</label>
                                <input type="text" id="expenseDescription" value="${expense?.Description || ''}" placeholder="What is this expense for?" required>
                            </div>
                            <div class="form-group">
                                <label> Amount *</label>
                                <input type="number" id="expenseAmount" value="${expense?.Amount || ''}" placeholder="0.00" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label> Vendor</label>
                                <input type="text" id="expenseVendor" value="${expense?.Vendor || ''}" placeholder="Who did you pay?">
                            </div>
                            <div class="form-group">
                                <label> Notes</label>
                                <textarea id="expenseNotes" rows="2" placeholder="Additional notes...">${expense?.Notes || ''}</textarea>
                            </div>
                        </div>
                        <div style="padding: 15px 20px 20px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                            <button onclick="closeExpenseModal()" style="flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 10px; background: white; color: #333; font-size: 15px; font-weight: 600; cursor: pointer;">Cancel</button>
                            <button onclick="saveExpense()" style="flex: 1; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%); color: white; font-size: 15px; font-weight: 600; cursor: pointer;"> Save</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeExpenseModal() {
            const modal = document.getElementById('expenseModal');
            if (modal) modal.remove();
        }
        
        async function saveExpense() {
            const expenseId = document.getElementById('editExpenseId').value;
            const data = {
                expenseDate: document.getElementById('expenseDate').value,
                categoryId: document.getElementById('expenseCategory').value,
                description: document.getElementById('expenseDescription').value,
                amount: parseFloat(document.getElementById('expenseAmount').value) || 0,
                vendor: document.getElementById('expenseVendor').value,
                notes: document.getElementById('expenseNotes').value
            };
            
            if (!data.expenseDate || !data.categoryId || !data.description || !data.amount) {
                showError('Please fill in all required fields');
                return;
            }
            
            showLoading(expenseId ? 'Updating Expense...' : 'Adding Expense...');
            try {
                let result;
                if (expenseId) {
                    data.expenseId = expenseId;
                    result = await apiCall('updateExpense', data);
                } else {
                    result = await apiCall('addExpense', data);
                }
                
                if (result && result.status === 'success') {
                    showSuccess(result.message);
                    closeExpenseModal();
                    await loadExpenses({ expensesOnly: true });
                } else {
                    showError(result?.message || 'Failed to save expense');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        function editExpense(expenseId) {
            showAddExpenseModal(expenseId);
        }
        
        async function deleteExpense(expenseId) {
            if (!confirm('Are you sure you want to delete this expense?')) return;
            
            showLoading('Deleting Expense...');
            try {
                const result = await apiCall('deleteExpense', { expenseId });
                if (result && result.status === 'success') {
                    showSuccess('Expense deleted');
                    await loadExpenses({ expensesOnly: true });
                } else {
                    showError(result?.message || 'Failed to delete expense');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Show Add Category Modal
        function showAddCategoryModal(categoryId = null) {
            const category = categoryId ? cachedExpenseCategories.find(c => c.Category_ID === categoryId) : null;
            const isEdit = !!category;
            const excludeFromProfit = category && String(category.Exclude_From_Profit).toUpperCase() === 'TRUE';
            const isReimbursement = category && String(category.Is_Reimbursement).toUpperCase() === 'TRUE';
            
            const modalHtml = `
                <div id="categoryModal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100001; overflow-y: auto; padding: 20px; box-sizing: border-box;">
                    <div style="max-width: 400px; margin: 50px auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%); color: white; padding: 20px; text-align: center;">
                            <h2 style="margin: 0; font-size: 24px;"> ${isEdit ? 'Edit' : 'Add'} Category</h2>
                        </div>
                        <div style="padding: 20px;">
                            <input type="hidden" id="editCategoryId" value="${category?.Category_ID || ''}">
                            <div class="form-group">
                                <label> Category Name *</label>
                                <input type="text" id="categoryName" value="${category?.Category_Name || ''}" placeholder="e.g., Fuel, Insurance, Rent" required>
                            </div>
                            <div class="form-group">
                                <label> Type</label>
                                <select id="categoryType">
                                    <option value="Fixed" ${category?.Category_Type === 'Fixed' ? 'selected' : ''}>Fixed (same each month)</option>
                                    <option value="Variable" ${!category || category?.Category_Type === 'Variable' ? 'selected' : ''}>Variable (changes)</option>
                                    <option value="One-Time" ${category?.Category_Type === 'One-Time' ? 'selected' : ''}>One-Time</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="categoryActive">
                                    <option value="true" ${!category || String(category?.Is_Active).toUpperCase() === 'TRUE' ? 'selected' : ''}>Active</option>
                                    <option value="false" ${category && String(category?.Is_Active).toUpperCase() === 'FALSE' ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                            <div class="form-group" style="padding: 12px; background: #f0fdf4; border-radius: 8px; border: 1px solid #bbf7d0;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="categoryIsReimbursement" ${isReimbursement ? 'checked' : ''} style="width: 18px; height: 18px;">
                                    <span> Reimbursement/Credit (reduces expenses)</span>
                                </label>
                                <small style="color: #166534; display: block; margin-top: 5px;">Check this for money coming BACK to you (e.g., IRS mileage reimbursement, refunds). This will be subtracted from total expenses.</small>
                            </div>
                            <div class="form-group" style="padding: 12px; background: #fffbeb; border-radius: 8px; border: 1px solid #fcd34d;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="categoryExcludeFromProfit" ${excludeFromProfit ? 'checked' : ''} style="width: 18px; height: 18px;">
                                    <span> Tax Record Only (exclude from P&L)</span>
                                </label>
                                <small style="color: #92400e; display: block; margin-top: 5px;">Check this for items that are only for tax documentation, not actual business expenses.</small>
                            </div>
                        </div>
                        <div style="padding: 15px 20px 20px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                            <button onclick="closeCategoryModal()" style="flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 10px; background: white; color: #333; font-size: 15px; font-weight: 600; cursor: pointer;">Cancel</button>
                            <button onclick="saveCategory()" style="flex: 1; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%); color: white; font-size: 15px; font-weight: 600; cursor: pointer;"> Save</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeCategoryModal() {
            const modal = document.getElementById('categoryModal');
            if (modal) modal.remove();
        }
        
        async function saveCategory() {
            const categoryId = document.getElementById('editCategoryId').value;
            const data = {
                categoryName: document.getElementById('categoryName').value,
                categoryType: document.getElementById('categoryType').value,
                isActive: document.getElementById('categoryActive').value === 'true',
                excludeFromProfit: document.getElementById('categoryExcludeFromProfit').checked,
                isReimbursement: document.getElementById('categoryIsReimbursement').checked
            };
            
            if (!data.categoryName) {
                showError('Please enter a category name');
                return;
            }
            
            showLoading(categoryId ? 'Updating Category...' : 'Adding Category...');
            try {
                let result;
                if (categoryId) {
                    data.categoryId = categoryId;
                    result = await apiCall('updateExpenseCategory', data);
                } else {
                    result = await apiCall('addExpenseCategory', data);
                }
                
                if (result && result.status === 'success') {
                    showSuccess(result.message);
                    closeCategoryModal();
                    await loadExpenses({ categoriesOnly: true });
                    displayExpenseCategories();
                } else {
                    showError(result?.message || 'Failed to save category');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        function editCategory(categoryId) {
            showAddCategoryModal(categoryId);
        }
        
        async function deleteCategory(categoryId) {
            if (!confirm('Are you sure you want to delete this category? This may affect existing expenses.')) return;
            
            showLoading('Deleting Category...');
            try {
                const result = await apiCall('deleteExpenseCategory', { categoryId });
                if (result && result.status === 'success') {
                    showSuccess('Category deleted');
                    await loadExpenses({ categoriesOnly: true });
                    displayExpenseCategories();
                } else {
                    showError(result?.message || 'Failed to delete category');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Show Add Recurring Modal
        function showAddRecurringModal(recurringId = null) {
            const recurring = recurringId ? cachedRecurringExpenses.find(r => r.Recurring_ID === recurringId) : null;
            const isEdit = !!recurring;
            
            let categoryOptions = '<option value="">Select Category</option>';
            cachedExpenseCategories.forEach(cat => {
                if (String(cat.Is_Active).toUpperCase() === 'TRUE') {
                    const selected = recurring && recurring.Category_ID === cat.Category_ID ? 'selected' : '';
                    categoryOptions += `<option value="${cat.Category_ID}" ${selected}>${cat.Category_Name}</option>`;
                }
            });
            
            const modalHtml = `
                <div id="recurringModal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100001; overflow-y: auto; padding: 20px; box-sizing: border-box;">
                    <div style="max-width: 500px; margin: 30px auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%); color: white; padding: 20px; text-align: center;">
                            <h2 style="margin: 0; font-size: 24px;"> ${isEdit ? 'Edit' : 'Add'} Recurring Expense</h2>
                        </div>
                        <div style="padding: 20px;">
                            <input type="hidden" id="editRecurringId" value="${recurring?.Recurring_ID || ''}">
                            <div class="form-group">
                                <label> Description *</label>
                                <input type="text" id="recurringDescription" value="${recurring?.Description || ''}" placeholder="e.g., Monthly Rent" required>
                            </div>
                            <div class="form-group">
                                <label> Category *</label>
                                <select id="recurringCategory" required>${categoryOptions}</select>
                            </div>
                            <div class="form-group">
                                <label> Amount *</label>
                                <input type="number" id="recurringAmount" value="${recurring?.Amount || ''}" placeholder="0.00" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label> Frequency</label>
                                <select id="recurringFrequency">
                                    <option value="Monthly" ${!recurring || recurring?.Frequency === 'Monthly' ? 'selected' : ''}>Monthly</option>
                                    <option value="Quarterly" ${recurring?.Frequency === 'Quarterly' ? 'selected' : ''}>Quarterly</option>
                                    <option value="Annual" ${recurring?.Frequency === 'Annual' ? 'selected' : ''}>Annual</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label> Day of Month</label>
                                <input type="number" id="recurringDayOfMonth" value="${recurring?.Day_Of_Month || 1}" min="1" max="28" placeholder="1-28">
                                <small style="color: #666;">Day 1-28 recommended to avoid month-end issues</small>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="recurringActive">
                                    <option value="true" ${!recurring || String(recurring?.Is_Active).toUpperCase() === 'TRUE' ? 'selected' : ''}>Active</option>
                                    <option value="false" ${recurring && String(recurring?.Is_Active).toUpperCase() === 'FALSE' ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                        </div>
                        <div style="padding: 15px 20px 20px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                            <button onclick="closeRecurringModal()" style="flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 10px; background: white; color: #333; font-size: 15px; font-weight: 600; cursor: pointer;">Cancel</button>
                            <button onclick="saveRecurring()" style="flex: 1; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%); color: white; font-size: 15px; font-weight: 600; cursor: pointer;"> Save</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeRecurringModal() {
            const modal = document.getElementById('recurringModal');
            if (modal) modal.remove();
        }
        
        async function saveRecurring() {
            const recurringId = document.getElementById('editRecurringId').value;
            const data = {
                description: document.getElementById('recurringDescription').value,
                categoryId: document.getElementById('recurringCategory').value,
                amount: parseFloat(document.getElementById('recurringAmount').value) || 0,
                frequency: document.getElementById('recurringFrequency').value,
                dayOfMonth: parseInt(document.getElementById('recurringDayOfMonth').value) || 1,
                isActive: document.getElementById('recurringActive').value === 'true'
            };
            
            if (!data.description || !data.categoryId || !data.amount) {
                showError('Please fill in all required fields');
                return;
            }
            
            showLoading(recurringId ? 'Updating Recurring Expense...' : 'Adding Recurring Expense...');
            try {
                let result;
                if (recurringId) {
                    data.recurringId = recurringId;
                    result = await apiCall('updateRecurringExpense', data);
                } else {
                    result = await apiCall('addRecurringExpense', data);
                }
                
                if (result && result.status === 'success') {
                    showSuccess(result.message);
                    closeRecurringModal();
                    await loadExpenses({ recurringOnly: true });
                    displayRecurringExpenses();
                } else {
                    showError(result?.message || 'Failed to save recurring expense');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        function editRecurring(recurringId) {
            showAddRecurringModal(recurringId);
        }
        
        async function deleteRecurring(recurringId) {
            if (!confirm('Are you sure you want to delete this recurring expense?')) return;
            
            showLoading('Deleting Recurring Expense...');
            try {
                const result = await apiCall('deleteRecurringExpense', { recurringId });
                if (result && result.status === 'success') {
                    showSuccess('Recurring expense deleted');
                    await loadExpenses({ recurringOnly: true });
                    displayRecurringExpenses();
                } else {
                    showError(result?.message || 'Failed to delete recurring expense');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Show Add Mileage Rate Modal
        function showAddMileageRateModal(year = null) {
            const rate = year ? cachedMileageRates.find(r => String(r.Year) === String(year)) : null;
            const isEdit = !!rate;
            const currentYear = new Date().getFullYear();
            
            const modalHtml = `
                <div id="mileageRateModal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100001; overflow-y: auto; padding: 20px; box-sizing: border-box;">
                    <div style="max-width: 400px; margin: 50px auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="background: linear-gradient(135deg, #7aaab8 0%, #5a9aaa 100%); color: white; padding: 20px; text-align: center;">
                            <h2 style="margin: 0; font-size: 24px;"> ${isEdit ? 'Edit' : 'Add'} Mileage Rate</h2>
                        </div>
                        <div style="padding: 20px;">
                            <input type="hidden" id="editMileageYear" value="${rate?.Year || ''}">
                            <div class="form-group">
                                <label> Year *</label>
                                <input type="number" id="mileageYear" value="${rate?.Year || currentYear}" min="2000" max="2099" ${isEdit ? 'readonly' : ''} required>
                            </div>
                            <div class="form-group">
                                <label> Rate Per Mile * (e.g., 0.70)</label>
                                <input type="number" id="mileageRate" value="${rate?.Rate_Per_Mile || '0.70'}" step="0.001" min="0" placeholder="0.70" required>
                            </div>
                            <div class="form-group">
                                <label> Effective Date</label>
                                <input type="date" id="mileageEffectiveDate" value="${rate?.Effective_Date ? new Date(rate.Effective_Date).toISOString().split('T')[0] : currentYear + '-01-01'}">
                            </div>
                            <div class="form-group">
                                <label> Notes</label>
                                <input type="text" id="mileageNotes" value="${rate?.Notes || 'IRS Standard Mileage Rate'}" placeholder="IRS Standard Mileage Rate">
                            </div>
                        </div>
                        <div style="padding: 15px 20px 20px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                            <button onclick="closeMileageRateModal()" style="flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 10px; background: white; color: #333; font-size: 15px; font-weight: 600; cursor: pointer;">Cancel</button>
                            <button onclick="saveMileageRate()" style="flex: 1; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, #7aaab8 0%, #5a9aaa 100%); color: white; font-size: 15px; font-weight: 600; cursor: pointer;"> Save</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeMileageRateModal() {
            const modal = document.getElementById('mileageRateModal');
            if (modal) modal.remove();
        }
        
        async function saveMileageRate() {
            const existingYear = document.getElementById('editMileageYear').value;
            const data = {
                year: parseInt(document.getElementById('mileageYear').value),
                ratePerMile: parseFloat(document.getElementById('mileageRate').value) || 0,
                effectiveDate: document.getElementById('mileageEffectiveDate').value,
                notes: document.getElementById('mileageNotes').value
            };
            
            if (!data.year || !data.ratePerMile) {
                showError('Please enter year and rate');
                return;
            }
            
            showLoading(existingYear ? 'Updating Mileage Rate...' : 'Adding Mileage Rate...');
            try {
                let result;
                if (existingYear) {
                    result = await apiCall('updateMileageRate', data);
                } else {
                    result = await apiCall('addMileageRate', data);
                }
                
                if (result && result.status === 'success') {
                    showSuccess(result.message);
                    closeMileageRateModal();
                    await loadExpenses({ mileageOnly: true });
                    displayMileageRates();
                } else {
                    showError(result?.message || 'Failed to save mileage rate');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        function editMileageRate(year) {
            showAddMileageRateModal(year);
        }
        
        // Show Add Mileage Expense Modal
        async function showAddMileageModal() {
            // Get current mileage rate
            const currentYear = new Date().getFullYear();
            let ratePerMile = 0.70; // Default
            
            const rateResult = await apiCall('getCurrentMileageRate', { year: currentYear });
            if (rateResult && rateResult.status === 'success' && rateResult.data) {
                ratePerMile = parseFloat(rateResult.data.ratePerMile) || 0.70;
            }
            
            // Find mileage category
            let mileageCategoryId = '';
            const mileageCat = cachedExpenseCategories.find(c => 
                c.Category_Name.toLowerCase().includes('mileage') && 
                String(c.Is_Active).toUpperCase() === 'TRUE'
            );
            if (mileageCat) mileageCategoryId = mileageCat.Category_ID;
            
            const modalHtml = `
                <div id="mileageModal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100001; overflow-y: auto; padding: 20px; box-sizing: border-box;">
                    <div style="max-width: 450px; margin: 30px auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="background: linear-gradient(135deg, #7aaab8 0%, #5a9aaa 100%); color: white; padding: 20px; text-align: center;">
                            <h2 style="margin: 0; font-size: 24px;"> Log Mileage</h2>
                            <p style="margin: 8px 0 0; opacity: 0.9;">Current rate: $${ratePerMile.toFixed(3)}/mile (${currentYear})</p>
                        </div>
                        <div style="padding: 20px;">
                            <input type="hidden" id="mileageCategoryId" value="${mileageCategoryId}">
                            <input type="hidden" id="currentMileageRate" value="${ratePerMile}">
                            <div class="form-group">
                                <label> Date *</label>
                                <input type="date" id="mileageDate" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                            <div class="form-group">
                                <label> Miles Driven *</label>
                                <input type="number" id="milesDriven" placeholder="0" min="0" step="0.1" oninput="calculateMileageAmount()" required>
                            </div>
                            <div class="form-group">
                                <label> Description</label>
                                <input type="text" id="mileageDescription" placeholder="e.g., Delivery route, Customer visit">
                            </div>
                            <div style="background: linear-gradient(135deg, #e0f2f1, #b2dfdb); padding: 20px; border-radius: 12px; text-align: center; margin: 15px 0;">
                                <div style="font-size: 12px; color: #666; text-transform: uppercase;">Calculated Expense</div>
                                <div id="mileageAmountDisplay" style="font-size: 32px; font-weight: bold; color: #00796b;">$0.00</div>
                                <div style="font-size: 12px; color: #888;"><span id="milesDisplay">0</span> miles  $${ratePerMile.toFixed(3)}</div>
                            </div>
                        </div>
                        <div style="padding: 15px 20px 20px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                            <button onclick="closeMileageModal()" style="flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 10px; background: white; color: #333; font-size: 15px; font-weight: 600; cursor: pointer;">Cancel</button>
                            <button onclick="saveMileageExpense()" style="flex: 1; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, #7aaab8 0%, #5a9aaa 100%); color: white; font-size: 15px; font-weight: 600; cursor: pointer;"> Save</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeMileageModal() {
            const modal = document.getElementById('mileageModal');
            if (modal) modal.remove();
        }
        
        function calculateMileageAmount() {
            const miles = parseFloat(document.getElementById('milesDriven').value) || 0;
            const rate = parseFloat(document.getElementById('currentMileageRate').value) || 0.70;
            const amount = miles * rate;
            document.getElementById('mileageAmountDisplay').textContent = formatMoney(amount);
            document.getElementById('milesDisplay').textContent = miles.toFixed(1);
        }
        
        async function saveMileageExpense() {
            const miles = parseFloat(document.getElementById('milesDriven').value) || 0;
            const rate = parseFloat(document.getElementById('currentMileageRate').value) || 0.70;
            const amount = miles * rate;
            const categoryId = document.getElementById('mileageCategoryId').value;
            
            if (!miles) {
                showError('Please enter miles driven');
                return;
            }
            
            if (!categoryId) {
                showError('No mileage category found. Please create a "Mileage" category first.');
                return;
            }
            
            const description = document.getElementById('mileageDescription').value || `${miles} miles @ $${rate.toFixed(3)}/mile`;
            
            const data = {
                expenseDate: document.getElementById('mileageDate').value,
                categoryId: categoryId,
                description: description,
                amount: Math.round(amount * 100) / 100,
                vendor: 'Mileage Reimbursement',
                notes: `${miles} miles at IRS rate $${rate.toFixed(3)}/mile`
            };
            
            showLoading('Logging Mileage...');
            try {
                const result = await apiCall('addExpense', data);
                if (result && result.status === 'success') {
                    showSuccess(`Mileage logged: ${miles} miles = ${formatMoney(amount)}`);
                    closeMileageModal();
                    await loadExpenses({ expensesOnly: true });
                } else {
                    showError(result?.message || 'Failed to log mileage');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Show Generate Monthly Expenses Modal
        function showGenerateMonthlyModal() {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            
            let monthOptions = '';
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            for (let i = 1; i <= 12; i++) {
                const selected = i === currentMonth ? 'selected' : '';
                monthOptions += `<option value="${i}" ${selected}>${monthNames[i-1]}</option>`;
            }
            
            let yearOptions = '';
            for (let y = currentYear - 1; y <= currentYear + 1; y++) {
                const selected = y === currentYear ? 'selected' : '';
                yearOptions += `<option value="${y}" ${selected}>${y}</option>`;
            }
            
            const modalHtml = `
                <div id="generateMonthlyModal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100001; overflow-y: auto; padding: 20px; box-sizing: border-box;">
                    <div style="max-width: 400px; margin: 50px auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="background: linear-gradient(135deg, #b8a86b 0%, #9a8a5b 100%); color: white; padding: 20px; text-align: center;">
                            <h2 style="margin: 0; font-size: 24px;"> Generate Monthly Expenses</h2>
                        </div>
                        <div style="padding: 20px;">
                            <p style="color: #666; margin-bottom: 20px;">This will create expense entries from your active recurring expense templates for the selected month.</p>
                            <div class="form-group">
                                <label> Month</label>
                                <select id="generateMonth">${monthOptions}</select>
                            </div>
                            <div class="form-group">
                                <label> Year</label>
                                <select id="generateYear">${yearOptions}</select>
                            </div>
                            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-top: 15px;">
                                <strong> Note:</strong> Expenses that already exist for this month will be skipped.
                            </div>
                        </div>
                        <div style="padding: 15px 20px 20px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                            <button onclick="closeGenerateMonthlyModal()" style="flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 10px; background: white; color: #333; font-size: 15px; font-weight: 600; cursor: pointer;">Cancel</button>
                            <button onclick="generateMonthlyExpenses()" style="flex: 1; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, #b8a86b 0%, #9a8a5b 100%); color: white; font-size: 15px; font-weight: 600; cursor: pointer;"> Generate</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeGenerateMonthlyModal() {
            const modal = document.getElementById('generateMonthlyModal');
            if (modal) modal.remove();
        }
        
        async function generateMonthlyExpenses() {
            const month = parseInt(document.getElementById('generateMonth').value);
            const year = parseInt(document.getElementById('generateYear').value);
            
            showLoading('Generating Monthly Expenses...');
            try {
                const result = await apiCall('generateMonthlyExpenses', { year, month });
                if (result && result.status === 'success') {
                    showSuccess(result.message);
                    closeGenerateMonthlyModal();
                    await loadExpenses({ expensesOnly: true });
                } else {
                    showError(result?.message || 'Failed to generate expenses');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // ==================== PRICE SIMULATOR ====================
        
        let pricesimItems = [];
        let pricesimFiltered = [];
        let simulatedNewItems = []; // Track new items added for simulation
        
        // New Item Simulation Functions
        function calcNewSimUnitCost() {
            const packageCost = parseFloat(document.getElementById('newSimPackageCost').value) || 0;
            const unitsPerPkg = parseFloat(document.getElementById('newSimUnitsPerPkg').value) || 1;
            const unitCost = packageCost / unitsPerPkg;
            document.getElementById('newSimUnitCost').value = '$' + unitCost.toFixed(2);
            calcNewSimSellPrice();
        }
        
        function calcNewSimSellPrice() {
            const packageCost = parseFloat(document.getElementById('newSimPackageCost').value) || 0;
            const unitsPerPkg = parseFloat(document.getElementById('newSimUnitsPerPkg').value) || 1;
            const markup = parseFloat(document.getElementById('newSimMarkup').value) || 0;
            const unitCost = packageCost / unitsPerPkg;
            const sellPrice = unitCost * (1 + markup / 100);
            document.getElementById('newSimSellPrice').value = '$' + sellPrice.toFixed(2);
        }
        
        function clearNewSimForm() {
            document.getElementById('newSimSupplier').value = '';
            document.getElementById('newSimSKU').value = '';
            document.getElementById('newSimDescription').value = '';
            document.getElementById('newSimPackageCost').value = '';
            document.getElementById('newSimUnitsPerPkg').value = '1';
            document.getElementById('newSimMarkup').value = '30';
            document.getElementById('newSimUnitCost').value = '$0.00';
            document.getElementById('newSimSellPrice').value = '$0.00';
        }
        
        function addNewItemToSimulation() {
            const supplierId = document.getElementById('newSimSupplier').value;
            const sku = document.getElementById('newSimSKU').value.trim();
            const description = document.getElementById('newSimDescription').value.trim();
            const packageCost = parseFloat(document.getElementById('newSimPackageCost').value) || 0;
            const unitsPerPkg = parseFloat(document.getElementById('newSimUnitsPerPkg').value) || 1;
            const markup = parseFloat(document.getElementById('newSimMarkup').value) || 0;
            
            // Validation with alerts
            if (!supplierId) {
                showWarning('Please select a supplier');
                return false;
            }
            if (!description) {
                showWarning('Please enter a description');
                return false;
            }
            if (packageCost <= 0) {
                showWarning('Please enter a package cost greater than 0');
                return false;
            }
            
            const unitCost = packageCost / unitsPerPkg;
            const sellPrice = unitCost * (1 + markup / 100);
            
            // Create a simulated item object
            const newItem = {
                Item_ID: 'NEW_' + Date.now(), // Temporary ID
                Supplier_ID: supplierId,
                SKU: sku || 'NEW',
                Item_Description: description,
                Package_Cost: packageCost,
                Units_Per_Package: unitsPerPkg,
                Unit_Sell_Price: sellPrice,
                Qty_On_Hand: 0,
                Reorder_Point: 0,
                isNew: true, // Flag to identify new items
                markup: markup
            };
            
            // Initialize arrays if needed
            if (!simulatedNewItems) simulatedNewItems = [];
            if (!pricesimItems) pricesimItems = [];
            if (!pricesimFiltered) pricesimFiltered = [];
            
            simulatedNewItems.push(newItem);
            pricesimItems.push(newItem);
            pricesimFiltered = [...pricesimItems];
            
            displayPriceSimItems();
            clearNewSimForm();
            
            showStatus('pricesimStatus', ` Added "${description}" to simulation. ${simulatedNewItems.length} new item(s) pending.`, 'success');
            
            // Scroll to show the table
            document.getElementById('pricesimTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            return false;
        }
        
        function removeSimulatedItem(tempId) {
            simulatedNewItems = simulatedNewItems.filter(item => item.Item_ID !== tempId);
            pricesimItems = pricesimItems.filter(item => item.Item_ID !== tempId);
            pricesimFiltered = pricesimFiltered.filter(item => item.Item_ID !== tempId);
            displayPriceSimItems();
            showStatus('pricesimStatus', `Removed item. ${simulatedNewItems.length} new item(s) pending.`, 'info');
        }
        
        async function saveNewItemsToDatabase() {
            if (simulatedNewItems.length === 0) {
                showWarning('No new items to save!');
                return;
            }
            
            const confirmed = await showConfirmModal(
                ' Save New Items',
                `<p>Save <strong>${simulatedNewItems.length} new item(s)</strong> to your database?</p>`,
                'Save Items',
                'Cancel',
                'info'
            );
            if (!confirmed) {
                return;
            }
            
            showStatus('pricesimStatus', ' Saving new items...', 'info');
            
            let savedCount = 0;
            for (const item of simulatedNewItems) {
                const result = await apiCall('addItem', {
                    supplierId: item.Supplier_ID,
                    sku: item.SKU,
                    description: item.Item_Description,
                    purchaseUOM: 'Each',
                    unitsPerPackage: item.Units_Per_Package,
                    packageCost: item.Package_Cost,
                    unitSellPrice: item.Unit_Sell_Price,
                    qtyOnHand: 0,
                    reorderPoint: 0
                });
                if (result?.status === 'success') savedCount++;
            }
            
            simulatedNewItems = [];
            showStatus('pricesimStatus', ` Saved ${savedCount} new items to database!`, 'success');
            
            // Reload to get fresh data with real IDs
            await loadPriceSimItems();
        }
        
        async function loadPriceSimItems() {
            showStatus('pricesimStatus', ' Loading items...', 'info');
            document.getElementById('pricesimTable').innerHTML = '<div class="loading">Loading items...</div>';
            
            try {
                // Load suppliers for filter
                if (cachedSuppliers.length === 0) {
                    const suppResult = await apiCall('getSuppliers');
                    if (suppResult?.status === 'success') cachedSuppliers = suppResult.data;
                }
                
                // Populate both supplier dropdowns
                const supplierSelect = document.getElementById('pricesimSupplier');
                const newSimSupplier = document.getElementById('newSimSupplier');
                
                if (supplierSelect) {
                    supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
                    cachedSuppliers.forEach(s => {
                        supplierSelect.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                    });
                }
                
                if (newSimSupplier) {
                    newSimSupplier.innerHTML = '<option value="">Select Supplier</option>';
                    cachedSuppliers.forEach(s => {
                        newSimSupplier.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                    });
                }
                
                // Load items
                const result = await apiCall('getItems');
                if (result?.status === 'success' && result.data && result.data.length > 0) {
                    pricesimItems = result.data;
                    // Add any simulated new items back
                    simulatedNewItems.forEach(item => {
                        pricesimItems.push(item);
                    });
                    pricesimFiltered = [...pricesimItems];
                    displayPriceSimItems();
                    showStatus('pricesimStatus', ` Loaded ${pricesimItems.length} items (${simulatedNewItems.length} new)`, 'success');
                } else {
                    document.getElementById('pricesimTable').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No items found. Add items in the Items tab first.</p>';
                    showStatus('pricesimStatus', ' No items found in database', 'info');
                }
            } catch (error) {
                console.error('Price Sim load error:', error);
                showStatus('pricesimStatus', ' Error loading items: ' + error.message, 'error');
            }
        }
        
        function filterPriceSimItems() {
            const search = document.getElementById('pricesimSearch').value.toLowerCase();
            const supplier = document.getElementById('pricesimSupplier').value;
            const stock = document.getElementById('pricesimStock').value;
            
            pricesimFiltered = pricesimItems.filter(item => {
                const matchSearch = !search || 
                    (item.SKU && item.SKU.toString().toLowerCase().includes(search)) ||
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(search));
                // Use matchesFilter for multi-select support
                const matchSupplier = matchesFilter(item.Supplier_ID, supplier);
                
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const reorder = parseFloat(item.Reorder_Point) || 0;
                let matchStock = true;
                if (stock === 'instock') matchStock = qty > 0 && !item.isNew;
                else if (stock === 'low') matchStock = qty > 0 && qty <= reorder && !item.isNew;
                else if (stock === 'out') matchStock = qty <= 0 && !item.isNew;
                else if (stock === 'new') matchStock = item.isNew === true;
                
                return matchSearch && matchSupplier && matchStock;
            });
            
            displayPriceSimItems();
        }
        
        function displayPriceSimItems() {
            const percent = parseFloat(document.getElementById('pricesimPercent').value) || 0;
            const flat = parseFloat(document.getElementById('pricesimFlat').value) || 0;
            
            // Debug info
            console.log('Price Sim Display - pricesimFiltered:', pricesimFiltered?.length, 'pricesimItems:', pricesimItems?.length);
            
            if (!pricesimFiltered || pricesimFiltered.length === 0) {
                if (!pricesimItems || pricesimItems.length === 0) {
                    document.getElementById('pricesimTable').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No items loaded yet. Click  Refresh to load items.</p>';
                } else {
                    document.getElementById('pricesimTable').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No items match your current filters. Try clearing the filters.</p>';
                }
                return;
            }
            
            // FIX #8: Show new items notification at TOP before table
            let html = '';
            if (simulatedNewItems.length > 0) {
                html += `
                    <div style="margin-bottom: 15px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 2px solid #b8a86b;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <strong style="color: #e65100;"> ${simulatedNewItems.length} New Item(s) Ready to Save</strong>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">These items are only in simulation. Click to add them to your database.</p>
                            </div>
                            <button class="btn" onclick="if(event && debounceButton(event.currentTarget)) saveNewItemsToDatabase()" style="background: #b8a86b;">
                                 Save ${simulatedNewItems.length} New Item(s) to Database
                            </button>
                        </div>
                    </div>
                `;
            }
            
            html += `
                <table class="data-table" id="pricesimDataTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;"></th>
                            <th>SKU</th>
                            <th>Description</th>
                            <th>Supplier</th>
                            <th>Unit Cost</th>
                            <th>Current Sell</th>
                            <th>NEW Sell</th>
                            <th>Change</th>
                            <th>Current Margin</th>
                            <th>NEW Margin</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            pricesimFiltered.forEach((item, idx) => {
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPkg = parseFloat(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPkg;
                const currentSell = parseFloat(item.Unit_Sell_Price) || 0;
                
                // Calculate new price
                let newSell = currentSell;
                if (!item.isNew) {
                    // Only apply bulk adjustment to existing items
                    if (percent > 0) {
                        newSell = currentSell * (1 + percent / 100);
                    } else if (flat > 0) {
                        newSell = currentSell + flat;
                    }
                }
                newSell = Math.round(newSell * 100) / 100; // Round to cents
                
                const change = newSell - currentSell;
                const currentMargin = currentSell > 0 ? ((currentSell - unitCost) / currentSell * 100) : 0;
                const newMargin = newSell > 0 ? ((newSell - unitCost) / newSell * 100) : 0;
                
                const hasChange = change > 0 || item.isNew;
                const isNew = item.isNew === true;
                const rowStyle = isNew ? 'background: #fff3e0;' : '';
                
                html += `
                    <tr style="${rowStyle}">
                        <td>
                            ${isNew ? 
                                `<button class="btn-delete-icon" onclick="removeSimulatedItem('${item.Item_ID}')" title="Remove"></button>` : 
                                `<input type="checkbox" class="pricesim-check" data-idx="${idx}" data-itemid="${item.Item_ID}" data-newprice="${newSell}" data-isnew="${isNew}" onchange="updatePriceSimSummary()" ${hasChange ? 'checked' : ''}>`
                            }
                        </td>
                        <td>
                            ${isNew ? '<span style="background: #b8a86b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 5px;">NEW</span>' : ''}
                            <strong>${item.SKU || '-'}</strong>
                        </td>
                        <td>${item.Item_Description}</td>
                        <td>${getSupplierName(item.Supplier_ID)}</td>
                        <td>${formatMoney(unitCost)}</td>
                        <td>${isNew ? '-' : '$' + currentSell.toFixed(2)}</td>
                        <td style="color: #6b9a8d; font-weight: bold;">${formatMoney(newSell)}</td>
                        <td style="color: ${hasChange ? '#6b9a8d' : '#666'};">${isNew ? `+${item.markup || 0}% markup` : (hasChange ? '+$' + change.toFixed(2) : '-')}</td>
                        <td>${isNew ? '-' : currentMargin.toFixed(1) + '%'}</td>
                        <td style="color: #6b9a8d; font-weight: bold;">${newMargin.toFixed(1)}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            document.getElementById('pricesimTable').innerHTML = html;
            
            // Make table sortable
            setTimeout(() => makeSortable('pricesimDataTable'), 0);
            
            updatePriceSimSummary();
        }
        
        // Revenue Impact Calculator
        function updateRevenueCalc() {
            calculateRevenueImpact();
        }
        
        function calculateRevenueImpact() {
            const saleAmount = parseFloat(document.getElementById('revCalcSaleAmount').value) || 100;
            const percent = parseFloat(document.getElementById('revCalcPercent').value) || 0;
            
            // Update percent label
            document.getElementById('revCalcPercentLabel').textContent = percent + '%';
            
            // Calculate values
            const afterAmount = saleAmount * (1 + percent / 100);
            const extraProfit = afterAmount - saleAmount;
            
            // Update display
            document.getElementById('revCalcBefore').textContent = '$' + saleAmount.toFixed(2);
            document.getElementById('revCalcAfter').textContent = '$' + afterAmount.toFixed(2);
            document.getElementById('revCalcProfit').textContent = '+$' + extraProfit.toFixed(2);
            
            // Projected impact (assuming 10 sales per week)
            const weekly = extraProfit * 10;
            const monthly = extraProfit * 40;
            const yearly = extraProfit * 520;
            
            document.getElementById('revCalc10Sales').textContent = '+$' + weekly.toFixed(0) + '/week';
            document.getElementById('revCalcMonthly').textContent = '+$' + monthly.toFixed(0) + '/month';
            document.getElementById('revCalcYearly').textContent = '+$' + yearly.toLocaleString() + '/year';
        }
        
        // Initialize revenue calculator on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById('revCalcSaleAmount')) {
                calculateRevenueImpact();
            }
        });
        
        function previewPriceChanges() {
            displayPriceSimItems();
            document.getElementById('pricesimSummary').style.display = 'block';
        }
        
        // Helper functions to clear one when the other is used
        function clearFlatAmount() {
            document.getElementById('pricesimFlat').value = '0';
        }
        
        function clearPercentAmount() {
            document.getElementById('pricesimPercent').value = '0';
            updatePercentLabel();
        }
        
        function updatePercentLabel() {
            const value = document.getElementById('pricesimPercent').value;
            document.getElementById('pricesimPercentLabel').textContent = value + '%';
        }
        
        function toggleAllPriceSimItems() {
            const selectAll = document.getElementById('pricesimSelectAll').checked;
            document.querySelectorAll('.pricesim-check').forEach(cb => {
                cb.checked = selectAll;
            });
            updatePriceSimSummary();
        }
        
        function updatePriceSimSummary() {
            const checkboxes = document.querySelectorAll('.pricesim-check:checked');
            const percent = parseFloat(document.getElementById('pricesimPercent').value) || 0;
            const flat = parseFloat(document.getElementById('pricesimFlat').value) || 0;
            
            let selectedCount = 0;
            let currentRevenue = 0;
            let newRevenue = 0;
            
            // For inventory impact calculation
            let currentInvValue = 0;
            let newInvValue = 0;
            let itemsWithStock = 0;
            
            checkboxes.forEach(cb => {
                const idx = parseInt(cb.dataset.idx);
                const item = pricesimFiltered[idx];
                if (!item) return;
                
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const currentSell = parseFloat(item.Unit_Sell_Price) || 0;
                
                let newSell = currentSell;
                if (percent > 0) {
                    newSell = currentSell * (1 + percent / 100);
                } else if (flat > 0) {
                    newSell = currentSell + flat;
                }
                
                selectedCount++;
                // Use absolute value - negative inventory still represents positive revenue
                currentRevenue += Math.abs(qty) * currentSell;
                newRevenue += Math.abs(qty) * newSell;
                
                // Calculate inventory impact for items with stock
                if (qty > 0) {
                    itemsWithStock++;
                    currentInvValue += qty * currentSell;
                    newInvValue += qty * newSell;
                }
            });
            
            const increase = newRevenue - currentRevenue;
            const invProfit = newInvValue - currentInvValue;
            
            document.getElementById('simSelectedCount').textContent = selectedCount;
            document.getElementById('simCurrentRevenue').textContent = '$' + currentRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('simNewRevenue').textContent = '$' + newRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('simIncrease').textContent = '+$' + increase.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('applyCount').textContent = selectedCount;
            
            // Update inventory impact section
            document.getElementById('simCurrentInvValue').textContent = '$' + currentInvValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('simNewInvValue').textContent = '$' + newInvValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('simInvProfit').textContent = '+$' + invProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // Show/hide sections
            const applySection = document.getElementById('pricesimApplySection');
            const summarySection = document.getElementById('pricesimSummary');
            const invImpactSection = document.getElementById('pricesimInventoryImpact');
            
            if (selectedCount > 0 && (percent > 0 || flat > 0)) {
                applySection.style.display = 'block';
                summarySection.style.display = 'block';
                // Show inventory impact if there are items with stock
                invImpactSection.style.display = itemsWithStock > 0 ? 'block' : 'none';
            } else {
                applySection.style.display = 'none';
                invImpactSection.style.display = 'none';
            }
        }
        
        async function applyPriceChanges() {
            const checkboxes = document.querySelectorAll('.pricesim-check:checked');
            const count = checkboxes.length;
            
            if (count === 0) {
                showWarning('No items selected!');
                return;
            }
            
            const confirmed = await showConfirmModal(
                ' Update Sell Prices',
                `<p>Update the sell price for <strong>${count} items</strong>?</p>
                <p style="color: #666; font-size: 14px;">This will modify your database.</p>`,
                'Update Prices',
                'Cancel',
                'warning'
            );
            if (!confirmed) {
                return;
            }
            
            showStatus('pricesimStatus', ` Updating ${count} items...`, 'info');
            
            // Collect updates
            const updates = [];
            checkboxes.forEach(cb => {
                updates.push({
                    itemId: cb.dataset.itemid,
                    newPrice: parseFloat(cb.dataset.newprice)
                });
            });
            
            // Send to backend
            const result = await apiCall('bulkUpdateSellPrices', { updates });
            
            if (result?.status === 'success') {
                showStatus('pricesimStatus', ` Successfully updated ${count} items! Screen refreshed with new prices.`, 'success');
                
                // FIX #10: RESET ALL CONTROLS TO PREVENT DOUBLE-APPLY
                // Reset percentage slider
                document.getElementById('pricesimPercent').value = '0';
                updatePercentLabel();
                
                // Reset flat amount
                document.getElementById('pricesimFlat').value = '0';
                
                // Uncheck "Select All"
                document.getElementById('pricesimSelectAll').checked = false;
                
                // Uncheck all individual items
                document.querySelectorAll('.pricesim-check').forEach(cb => {
                    cb.checked = false;
                });
                
                // Hide apply section
                document.getElementById('pricesimApplySection').style.display = 'none';
                document.getElementById('pricesimSummary').style.display = 'none';
                document.getElementById('pricesimInventoryImpact').style.display = 'none';
                
                // Reload items to show new prices
                await loadPriceSimItems();
                
                // Show prominent warning message
                setTimeout(() => {
                    showStatus('pricesimStatus', ' Prices updated successfully! Controls have been reset. Adjust settings before applying again.', 'success');
                }, 100);
            } else {
                showStatus('pricesimStatus', ' Error: ' + (result?.message || 'Failed to update'), 'error');
            }
        }
        
        // ==================== MANUAL INVENTORY ADJUSTMENT ====================
        
        async function showAdjustInventoryForm() {
            // ALWAYS load fresh inventory data from database
            showStatus('inventoryStatus', 'Loading current inventory...', 'info');
            const result = await apiCall('getInventoryReport');
            
            if (result && result.status === 'success') {
                cachedItems = result.data;
                
                // Clear fields
                document.getElementById('adjustItemDisplay').value = '';
                document.getElementById('adjustItem').value = '';
                document.getElementById('adjustCurrentQty').value = '';
                document.getElementById('adjustNewQty').value = '';
                document.getElementById('adjustQuantity').value = '';
                
                const form = document.getElementById('adjustInventoryForm');
                form.style.display = 'block';
                
                // Re-enable selects that were disabled at startup
                form.querySelectorAll('select').forEach(sel => {
                    sel.disabled = false;
                    sel.style.pointerEvents = '';
                });
                
                showStatus('inventoryStatus', '', '');
            } else {
                showStatus('inventoryStatus', ' Error loading inventory', 'error');
            }
        }
        
        // Open item picker for inventory adjustment
        function openItemPickerForAdjustment() {
            window.adjustmentPickerActive = true;
            window.itemPickerIsFilter = false; // Reset filter mode
            window.itemPickerSupplierContext = ''; // No supplier context for adjustments
            window.itemPickerCallback = {
                tagName: 'ADJUSTMENT_FORM',
                value: document.getElementById('adjustItem').value
            };
            
            // Show supplier filter
            const supplierFilterDiv = document.getElementById('itemPickerSupplierFilter');
            if (supplierFilterDiv) {
                supplierFilterDiv.style.display = 'block';
            }
            
            // Populate supplier filter
            const supplierSelect = document.getElementById('itemPickerSupplier');
            supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
            if (cachedSuppliers && cachedSuppliers.length > 0) {
                cachedSuppliers.forEach(s => {
                    supplierSelect.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                });
            }
            
            // Get items from cache
            window.itemPickerItems = cachedItems || [];
            
            // Clear search
            document.getElementById('itemPickerSearch').value = '';
            document.getElementById('itemPickerSupplier').value = '';
            
            // Render items
            renderItemPickerList();
            
            // Show modal
            document.getElementById('itemPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            
            // Focus search - only on desktop to prevent mobile keyboard popup
            document.activeElement?.blur();
            focusOnDesktop('itemPickerSearch');
        }
        
        function onAdjustItemSelected() {
            const itemId = document.getElementById('adjustItem').value;
            if (itemId) {
                const item = cachedItems.find(i => i.Item_ID === itemId);
                if (item) {
                    const currentQty = parseInt(item.Qty_On_Hand) || 0;
                    document.getElementById('adjustCurrentQty').value = currentQty;
                    document.getElementById('adjustItemDisplay').value = `${item.SKU} - ${item.Item_Description}`;
                    updateAdjustNewQty();
                }
            }
        }
        
        function updateAdjustNewQty() {
            const currentQty = parseInt(document.getElementById('adjustCurrentQty').value) || 0;
            const adjustment = parseInt(document.getElementById('adjustQuantity').value) || 0;
            const newQty = currentQty + adjustment;
            
            document.getElementById('adjustNewQty').value = newQty;
            
            // Color code the new quantity
            const newQtyInput = document.getElementById('adjustNewQty');
            if (newQty < 0) {
                newQtyInput.style.background = '#ffebee';
                newQtyInput.style.color = '#c62828';
            } else if (adjustment < 0) {
                newQtyInput.style.background = '#fff3e0';
                newQtyInput.style.color = '#ef6c00';
            } else {
                newQtyInput.style.background = '#e8f5e9';
                newQtyInput.style.color = '#2e7d32';
            }
        }
        
        // (Removed old adjustItemResults click handler - now uses card picker)
        
        function hideAdjustInventoryForm() {
            document.getElementById('adjustInventoryForm').style.display = 'none';
            document.querySelector('#adjustInventoryForm form').reset();
            document.getElementById('adjustCurrentQty').value = '';
            document.getElementById('adjustNewQty').value = '';
            document.getElementById('adjustItemDisplay').value = '';
            document.getElementById('adjustItem').value = '';
            document.getElementById('adjustReasonDisplay').value = '';
            document.getElementById('adjustReason').value = '';
            // Reset reason field styling
            document.getElementById('adjustReasonDisplay').style.borderColor = '#f39c12';
            document.getElementById('adjustReasonDisplay').style.background = '#fff';
            
            // Check if we should return to a report (e.g., Action Dashboard)
            if (returnToReport) {
                const reportToOpen = returnToReport;
                returnToReport = null; // Clear it so we don't loop
                // Delay to allow user to see any success/status messages
                setTimeout(() => {
                    showReport(reportToOpen);
                }, 800);
            }
        }
        
        function updateAdjustmentCalc() {
            const itemId = document.getElementById('adjustItem').value;
            
            if (itemId) {
                const item = cachedItems.find(i => i.Item_ID === itemId);
                const currentQty = item ? parseInt(item.Qty_On_Hand) : 0;
                const adjustment = parseInt(document.getElementById('adjustQuantity').value) || 0;
                const newQty = currentQty + adjustment;
                
                document.getElementById('adjustCurrentQty').value = currentQty;
                document.getElementById('adjustNewQty').value = newQty;
                
                // Color code the new quantity
                const newQtyInput = document.getElementById('adjustNewQty');
                if (newQty < 0) {
                    newQtyInput.style.background = '#ffebee';
                    newQtyInput.style.color = '#c62828';
                } else if (newQty < currentQty) {
                    newQtyInput.style.background = '#fff3e0';
                } else {
                    newQtyInput.style.background = '#e8f5e9';
                }
            }
        }
        
        async function submitInventoryAdjustment(e) {
            e.preventDefault();
            
            const itemId = document.getElementById('adjustItem').value;
            const adjustment = parseInt(document.getElementById('adjustQuantity').value);
            const currentQty = parseInt(document.getElementById('adjustCurrentQty').value);
            const newQty = parseInt(document.getElementById('adjustNewQty').value);
            const reason = document.getElementById('adjustReason').value;
            const notes = document.getElementById('adjustNotes').value;
            
            // Validation - Item is required
            if (!itemId) {
                showWarning('Please select an item to adjust.');
                return;
            }
            
            // Validation - Reason is required
            if (!reason || reason.trim() === '') {
                showWarning('Please select a reason for this adjustment.');
                document.getElementById('adjustReasonDisplay').focus();
                return;
            }
            
            // Validation - Adjustment amount is required
            if (isNaN(adjustment) || adjustment === 0) {
                showWarning('Please enter an adjustment amount (positive or negative).');
                document.getElementById('adjustQuantity').focus();
                return;
            }
            
            if (newQty < 0) {
                const confirmed = await showConfirmModal(
                    ' Negative Inventory Warning',
                    `<p style="color: #b88a8a;">This will set inventory to <strong>${newQty}</strong> (NEGATIVE).</p><p>Are you sure?</p>`,
                    'Yes, Continue',
                    'Cancel',
                    'danger'
                );
                if (!confirmed) {
                    return;
                }
            }
            
            // Confirm the adjustment
            const item = cachedItems.find(i => i.Item_ID === itemId);
            const confirmed = await showConfirmModal(
                ' Confirm Adjustment',
                `<div style="text-align: left;">
                    <p><strong>${item.Item_Description}</strong></p>
                    <hr style="margin: 10px 0;">
                    <p>Current: <strong>${currentQty}</strong></p>
                    <p>Adjustment: <strong style="color: ${adjustment > 0 ? '#10b981' : '#b88a8a'};">${adjustment > 0 ? '+' : ''}${adjustment}</strong></p>
                    <p>New Total: <strong>${newQty}</strong></p>
                    <hr style="margin: 10px 0;">
                    <p>Reason: ${reason}</p>
                </div>`,
                'Apply Adjustment',
                'Cancel',
                'warning'
            );
            
            if (!confirmed) {
                return;
            }
            
            const data = {
                itemId: itemId,
                quantity: adjustment,  // Backend expects 'quantity' not 'adjustment'
                adjustmentType: 'Manual',
                reason: reason + (notes ? ' - ' + notes : ''),
                user: 'Manual'
            };
            
            console.log(' Submitting inventory adjustment:', data);
            
            showLoading('Adjusting Inventory...');
            try {
                const result = await apiCall('adjustInventory', data);
                
                console.log(' Adjustment result:', result);
                
                if (result && result.status === 'success') {
                    // Force refresh to get updated quantities - clear cache and reload
                    cachedItems = [];
                    
                    // Note: hideAdjustInventoryForm will handle returning to report if returnToReport is set
                    hideAdjustInventoryForm();
                    loadInventory(true);  // Force refresh
                    showSuccessModal('Inventory Adjusted!', `${item.Item_Description}\n\n${currentQty}  ${newQty}`);
                } else {
                    showStatus('inventoryStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                    console.error('Adjustment failed:', result);
                }
            } finally {
                hideLoading();
            }
        }
        
        // ==================== REPORTS ====================
        
        let currentReport = null;
        let reportData = {};
        let rawReportData = {}; // Store unfiltered data for re-filtering
        let reportFilters = {}; // Store current filter values
        let returnToReport = null; // Store report to return to after action (e.g., from Action Dashboard)
        
        // Helper: Build filter UI HTML
        function buildFilterUI(reportType, options = {}) {
            const filterId = `filter-panel-${reportType}`;
            let html = '<div style="background: #f0f0f0; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;"> Filters</h4>
                    <button class="btn-small" onclick="toggleFilters('${filterId}')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="${filterId}-toggle"> Hide</span>
                    </button>
                </div>`;
            html += `<div id="${filterId}" class="form-grid">`;
            
            // Date Range (common to most reports)
            if (options.dateRange) {
                const dateLabel = options.dateLabel || 'Date';
                html += `
                    <div class="form-group">
                        <label>${dateLabel} From</label>
                        <input type="date" id="filter_fromDate" value="${reportFilters.fromDate || ''}">
                    </div>
                    <div class="form-group">
                        <label>${dateLabel} To</label>
                        <input type="date" id="filter_toDate" value="${reportFilters.toDate || ''}">
                    </div>`;
            }
            
            // Customer dropdown
            if (options.customer) {
                html += `
                    <div class="form-group">
                        <label>Customer</label>
                        <select id="filter_customer">
                            <option value="">All Customers</option>
                            ${options.customerList.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>`;
            }
            
            // Supplier dropdown - NEW PICKER STYLE
            if (options.supplier) {
                html += `
                    <div class="form-group">
                        <label>Supplier</label>
                        <input type="text" id="filter_supplier_display" placeholder=" Click to select..." 
                               onclick="openReportSupplierPicker()" readonly 
                               style="cursor: pointer; background: #fff; border: 2px solid #e0e0e0;">
                        <input type="hidden" id="filter_supplier" value="">
                    </div>`;
            }
            
            // Item dropdown
            if (options.item) {
                html += `
                    <div class="form-group">
                        <label>Product</label>
                        <select id="filter_item">
                            <option value="">All Products</option>
                            ${options.itemList.map(i => `<option value="${i.id}">${i.name}</option>`).join('')}
                        </select>
                    </div>`;
            }
            
            // Payment Status
            if (options.paymentStatus) {
                html += `
                    <div class="form-group">
                        <label>Payment Status</label>
                        <select id="filter_paymentStatus">
                            <option value="">All</option>
                            <option value="Paid">Paid</option>
                            <option value="Partial">Partial</option>
                            <option value="Unpaid">Unpaid</option>
                            <option value="Overdue">Overdue</option>
                        </select>
                    </div>`;
            }
            
            // Stock Status
            if (options.stockStatus) {
                html += `
                    <div class="form-group">
                        <label>Stock Status</label>
                        <select id="filter_stockStatus">
                            <option value="">All Items</option>
                            <option value="negative"> Negative Inventory</option>
                            <option value="out"> Out of Stock</option>
                            <option value="low"> Low Stock</option>
                            <option value="ok"> In Stock</option>
                        </select>
                    </div>`;
            }
            
            // Turnover Status
            if (options.turnoverStatus) {
                html += `
                    <div class="form-group">
                        <label>Movement</label>
                        <select id="filter_turnoverStatus">
                            <option value="">All</option>
                            <option value="Fast">Fast Movers</option>
                            <option value="Normal">Normal</option>
                            <option value="Slow">Slow Movers</option>
                        </select>
                    </div>`;
            }
            
            // Aging Filter (for AR/AP)
            if (options.aging) {
                html += `
                    <div class="form-group">
                        <label>Aging</label>
                        <select id="filter_aging">
                            <option value="">All</option>
                            <option value="Current">Current</option>
                            <option value="1-30">1-30 days</option>
                            <option value="31-60">31-60 days</option>
                            <option value="60+">60+ days</option>
                        </select>
                    </div>`;
            }
            
            // Minimum Amount
            if (options.minAmount) {
                html += `
                    <div class="form-group">
                        <label>Min Amount ($)</label>
                        <input type="number" id="filter_minAmount" step="0.01" placeholder="0.00">
                    </div>`;
            }
            
            html += `
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn" onclick="applyReportFilters('${reportType}')"> Apply Filters</button>
                    <button class="btn" onclick="clearReportFilters('${reportType}')" style="background: var(--secondary, #764ba2); color: white;"> Clear Filters</button>
                </div>
            </div>`;
            html += '</div>';
            
            return html;
        }
        
        // Apply filters to current report
        async function applyReportFilters(reportType) {
            // Capture filter values
            reportFilters = {
                fromDate: document.getElementById('filter_fromDate')?.value || '',
                toDate: document.getElementById('filter_toDate')?.value || '',
                customer: document.getElementById('filter_customer')?.value || '',
                supplier: document.getElementById('filter_supplier')?.value || '',
                item: document.getElementById('filter_item')?.value || '',
                paymentStatus: document.getElementById('filter_paymentStatus')?.value || '',
                stockStatus: document.getElementById('filter_stockStatus')?.value || '',
                turnoverStatus: document.getElementById('filter_turnoverStatus')?.value || '',
                aging: document.getElementById('filter_aging')?.value || '',
                minAmount: parseFloat(document.getElementById('filter_minAmount')?.value) || 0
            };
            
            // Re-render report with filters
            await showReport(reportType);
        }
        
        // Clear all filters
        function clearReportFilters(reportType) {
            reportFilters = {};
            showReport(reportType);
        }
        
        // Toggle filter panel visibility
        function toggleFilters(panelId) {
            const panel = document.getElementById(panelId);
            const toggle = document.getElementById(`${panelId}-toggle`);
            
            if (panel.style.display === 'none') {
                panel.style.display = 'grid';
                toggle.textContent = ' Hide';
                
                // Re-enable selects that were disabled at startup
                panel.querySelectorAll('select').forEach(sel => {
                    sel.disabled = false;
                    sel.style.pointerEvents = '';
                });
            } else {
                panel.style.display = 'none';
                toggle.textContent = ' Show';
            }
        }
        
        // Universal table sorting function
        function sortTable(tableId, columnIndex) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determine sort direction
            const header = table.querySelectorAll('th')[columnIndex];
            const currentDir = header.dataset.sortDir || 'asc';
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';
            
            // Clear all header indicators
            table.querySelectorAll('th').forEach(th => {
                th.style.cursor = 'pointer';
                th.dataset.sortDir = '';
                th.innerHTML = th.innerHTML.replace(' ', '').replace(' ', '');
            });
            
            // Sort rows
            rows.sort((a, b) => {
                // Safety checks for undefined cells
                const aCell = a.cells[columnIndex];
                const bCell = b.cells[columnIndex];
                
                if (!aCell || !bCell) return 0;
                
                // Check for data-sort attribute first (for dates)
                const aSortVal = aCell.dataset.sort;
                const bSortVal = bCell.dataset.sort;
                
                if (aSortVal !== undefined && bSortVal !== undefined) {
                    // Use data-sort values for comparison
                    if (!aSortVal && !bSortVal) return 0;
                    if (!aSortVal) return 1;
                    if (!bSortVal) return -1;
                    return newDir === 'asc' 
                        ? aSortVal.localeCompare(bSortVal)
                        : bSortVal.localeCompare(aSortVal);
                }
                
                const aCellText = (aCell.textContent || '').trim();
                const bCellText = (bCell.textContent || '').trim();
                
                // Handle empty cells
                if (!aCellText && !bCellText) return 0;
                if (!aCellText) return 1;
                if (!bCellText) return -1;
                
                // Try numeric comparison first
                const aNum = parseFloat(aCellText.replace(/[$,]/g, ''));
                const bNum = parseFloat(bCellText.replace(/[$,]/g, ''));
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return newDir === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // Try date comparison
                const aDate = new Date(aCellText);
                const bDate = new Date(bCellText);
                if (!isNaN(aDate.getTime()) && !isNaN(bDate.getTime()) && aCellText.match(/\d/)) {
                    return newDir === 'asc' ? aDate - bDate : bDate - aDate;
                }
                
                // String comparison
                return newDir === 'asc' 
                    ? aCellText.localeCompare(bCellText)
                    : bCellText.localeCompare(aCellText);
            });
            
            // Update table
            rows.forEach(row => tbody.appendChild(row));
            
            // Update header
            header.dataset.sortDir = newDir;
            header.innerHTML += newDir === 'asc' ? ' ' : ' ';
        }
        
        // Make table sortable
        function makeSortable(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                header.style.cursor = 'pointer';
                header.style.userSelect = 'none';
                header.onclick = () => sortTable(tableId, index);
                header.title = 'Click to sort';
            });
        }
        
        async function showReport(reportType) {
            // Mobile debugging - show what's happening
            console.log(' showReport called with:', reportType);
            
            // Open the report setup modal instead of running immediately
            try {
                openReportSetup(reportType);
            } catch (e) {
                showError('Error opening report setup: ' + e.message);
                console.error('Error in showReport:', e);
            }
        }
        
        // Report configuration for each report type
        const reportConfig = {
            'action-dashboard': {
                title: ' Action Dashboard',
                filters: [], // No filters needed - shows all critical actions
                dateLabel: '',
                description: {
                    purpose: 'View all critical business issues that need immediate attention in one place.',
                    insights: [
                        'Past due customer payments that need follow-up',
                        'Pending deliveries that need to be scheduled or completed',
                        'Items that are running low and need to be reordered',
                        'Purchase orders waiting to be received'
                    ]
                }
            },
            'customer-backorders': {
                title: ' Customer Backorders',
                filters: ['customer', 'supplier'],
                dateLabel: '',
                description: {
                    purpose: 'View items on backorder for customers and create POs to fulfill those orders.',
                    insights: [
                        'See which customers are waiting for products',
                        'Create POs for just the backorder quantity (not up to reorder point)',
                        'Ideal for discontinuing items - only order what\'s needed to fulfill existing orders',
                        'Consolidated view across all customers needing the same product'
                    ]
                }
            },
            'business-overview': {
                title: ' Business Overview',
                filters: ['dateRange'],
                dateLabel: 'Date Range',
                description: {
                    purpose: 'Get a high-level snapshot of your business performance with key metrics and trends.',
                    insights: [
                        'Total sales, purchases, and profit for the period',
                        'Operating expenses breakdown by category',
                        'Net profit after all expenses',
                        'Top selling products and best customers',
                        'Revenue trends and growth indicators'
                    ]
                }
            },
            'sales-by-customer': {
                title: ' Sales by Customer',
                filters: ['quickDateOnly', 'customer', 'minAmount', 'transactionStatus'],
                dateLabel: 'Sale Date',
                description: {
                    purpose: 'Analyze sales performance grouped by customer to understand your revenue sources.',
                    insights: [
                        'Which customers generate the most revenue',
                        'Customer purchasing patterns and frequency',
                        'Identify your VIP customers for better service',
                        'Spot customers who may need attention or follow-up'
                    ]
                }
            },
            'sales-order-detail': {
                title: ' Sales Order Detail',
                filters: ['quickDateOnly', 'customer', 'item', 'salesInvoice', 'paymentStatus', 'transactionStatus'],
                dateLabel: 'Sale Date',
                description: {
                    purpose: 'View detailed information on all sales orders with line items and payment status.',
                    insights: [
                        'Complete order history with all items sold',
                        'Payment status and amounts due per order',
                        'Delivery status tracking',
                        'Drill down into any order for full details'
                    ]
                }
            },
            'sales-by-product': {
                title: ' Sales by Item',
                filters: ['quickDateOnly', 'item', 'transactionStatus'],
                dateLabel: 'Sale Date',
                description: {
                    purpose: 'Analyze which products are selling best and their revenue contribution.',
                    insights: [
                        'Best and worst selling products',
                        'Revenue and quantity sold by product',
                        'Identify opportunities to promote slow movers',
                        'Track seasonal product trends'
                    ]
                }
            },
            'pick-list': {
                title: ' Inventory Pick List',
                filters: ['dateRange', 'customer', 'salesInvoice', 'deliveryStatus'],
                dateLabel: 'Date Range',
                description: {
                    purpose: 'Generate a consolidated list of items to pick from your warehouse for pending deliveries.',
                    insights: [
                        'See all items needed across multiple orders in one organized list',
                        'Group picks by customer or route for efficient warehouse picking',
                        'Track delivery status and prioritize urgent orders',
                        'Print pick sheets to take to the warehouse floor'
                    ]
                }
            },
            'dormant-customers': {
                title: ' Dormant Customers',
                filters: ['dormantDays'],
                dateLabel: 'Dormancy Threshold',
                description: {
                    purpose: 'Identify customers who haven\'t ordered recently so you can reach out and win back their business.',
                    insights: [
                        'See customers sorted by how long since their last order',
                        'View their last purchase details to personalize your outreach',
                        'Understand buying patterns and average order values',
                        'Get addresses and contact info for sales calls or visits'
                    ]
                }
            },
            'purchase-order-detail': {
                title: ' Purchase Order Detail',
                filters: ['quickDateOnly', 'supplier', 'item', 'purchaseInvoice', 'poType', 'paymentStatus', 'transactionStatus'],
                dateLabel: 'PO Date',
                description: {
                    purpose: 'View all purchase orders with complete details including items, costs, and status.',
                    insights: [
                        'Track what you\'ve ordered from each supplier',
                        'See payment status and amounts owed',
                        'Monitor expected delivery dates',
                        'View line item details for each order'
                    ]
                }
            },
            'purchase-by-supplier': {
                title: ' Purchase by Supplier',
                filters: ['quickDateOnly', 'supplier', 'poType', 'transactionStatus'],
                dateLabel: 'PO Date',
                description: {
                    purpose: 'Analyze your purchasing patterns grouped by supplier.',
                    insights: [
                        'Total spend with each supplier',
                        'Compare supplier pricing and volume',
                        'Identify your key supplier relationships',
                        'Track ordering frequency by supplier'
                    ]
                }
            },
            'supplier-performance': {
                title: ' Supplier Performance',
                filters: ['dateRange', 'supplier'],
                dateLabel: 'Date Range',
                description: {
                    purpose: 'Evaluate supplier reliability based on delivery times and order fulfillment.',
                    insights: [
                        'On-time delivery rates by supplier',
                        'Average lead times and fulfillment rates',
                        'Identify reliable vs problematic suppliers',
                        'Data to support supplier negotiations'
                    ]
                }
            },
            'inventory-turnover': {
                title: ' Inventory Turnover',
                filters: ['dateRange', 'supplier'],
                dateLabel: 'Analysis Period',
                description: {
                    purpose: 'Measure how quickly your inventory sells and identify slow-moving items.',
                    insights: [
                        'Turnover rate for each product',
                        'Days of supply remaining',
                        'Fast movers vs dead stock',
                        'Optimize inventory investment'
                    ]
                }
            },
            'gross-margin': {
                title: ' Gross Margin',
                filters: ['supplier', 'stockStatus'],
                dateLabel: '',
                description: {
                    purpose: 'Analyze profitability by comparing your cost vs selling price for each item.',
                    insights: [
                        'Profit margin percentage by product',
                        'Most and least profitable items',
                        'Identify pricing opportunities',
                        'Compare margins across suppliers'
                    ]
                }
            },
            'accounts-receivable': {
                title: ' Accounts Receivable',
                filters: ['customer', 'aging'],
                dateLabel: '',
                description: {
                    purpose: 'Track money owed to you by customers and aging of outstanding invoices.',
                    insights: [
                        'Total outstanding receivables',
                        'Aging breakdown (current, 30, 60, 90+ days)',
                        'Which customers owe you money',
                        'Prioritize collection efforts'
                    ]
                }
            },
            'accounts-payable': {
                title: ' Accounts Payable',
                filters: ['supplier', 'aging'],
                dateLabel: '',
                description: {
                    purpose: 'Track money you owe to suppliers and when payments are due.',
                    insights: [
                        'Total outstanding payables',
                        'Aging breakdown by due date',
                        'Plan cash flow for upcoming payments',
                        'Avoid late payment penalties'
                    ]
                }
            },
            'simple-inventory': {
                title: ' Inventory List / Bulk Order',
                filters: ['supplier', 'item', 'stockStatus'],
                dateLabel: '',
                description: {
                    purpose: 'View your current inventory levels with stock status for all products.',
                    insights: [
                        'Current quantity on hand for each item',
                        'Items below reorder point',
                        'Quantities on order from suppliers',
                        'Quick inventory snapshot'
                    ]
                }
            },
            'inventory-flow': {
                title: ' Inventory Flow Dashboard',
                filters: [],
                dateLabel: '',
                description: {
                    purpose: 'Real-time visibility into inventory movement and stock alerts.',
                    insights: [
                        'Critical alerts for stock issues',
                        'Items on backorder',
                        'Pending purchase order arrivals',
                        'Critical items needing attention'
                    ]
                }
            },
            'inventory-adjustments': {
                title: ' Inventory Adjustment History',
                filters: ['quickDateOnly', 'item', 'adjustmentType'],
                dateLabel: 'Adjustment Date',
                description: {
                    purpose: 'Review all inventory adjustments made for auditing and tracking purposes.',
                    insights: [
                        'History of all inventory changes',
                        'Reasons for each adjustment',
                        'Track shrinkage and corrections',
                        'Audit trail for inventory accuracy'
                    ]
                }
            },
            'profit-loss': {
                title: ' Profit & Loss Statement',
                filters: ['yearSelect', 'quarterSelect', 'cogsMethod'],
                dateLabel: '',
                description: {
                    purpose: 'View your profit and loss statement with revenue, costs, and net income.',
                    insights: [
                        'Total revenue and cost of goods sold',
                        'Gross profit and net income',
                        'Monthly or quarterly breakdown',
                        'Compare performance across periods'
                    ]
                }
            },
            'annual-sales-summary': {
                title: ' Annual Sales Summary',
                filters: ['yearSelect'],
                dateLabel: '',
                description: {
                    purpose: 'Review your annual sales performance with monthly breakdown.',
                    insights: [
                        'Total sales for the year',
                        'Month-by-month sales trends',
                        'Seasonal patterns in your business',
                        'Year-over-year comparison data'
                    ]
                }
            },
            'annual-purchase-summary': {
                title: ' Annual Purchase Summary',
                filters: ['yearSelect'],
                dateLabel: '',
                description: {
                    purpose: 'Review your annual purchasing with monthly breakdown by supplier.',
                    insights: [
                        'Total purchases for the year',
                        'Monthly purchasing patterns',
                        'Supplier spending breakdown',
                        'Plan future purchasing needs'
                    ]
                }
            },
            'inventory-valuation': {
                title: ' Inventory Valuation',
                filters: ['supplier'],
                dateLabel: '',
                description: {
                    purpose: 'Calculate the total value of your current inventory at cost.',
                    insights: [
                        'Total inventory value on hand',
                        'Value breakdown by supplier',
                        'Identify high-value stock items',
                        'Data for financial reporting'
                    ]
                }
            },
            'cash-flow-summary': {
                title: ' Cash Flow Summary',
                filters: ['yearSelect', 'quarterSelect'],
                dateLabel: '',
                description: {
                    purpose: 'Track cash coming in from sales and going out for purchases.',
                    insights: [
                        'Cash received from customers',
                        'Cash paid to suppliers',
                        'Net cash flow for the period',
                        'Plan for cash needs'
                    ]
                }
            },
            'daily-dashboard': {
                title: ' Daily Sales Dashboard',
                filters: ['quickDateOnly', 'customer'],
                dateLabel: 'Date',
                description: {
                    purpose: 'View today\'s sales activity and key performance indicators.',
                    insights: [
                        'Today\'s sales and orders',
                        'Comparison to daily average',
                        'Top products sold today',
                        'Quick daily performance check'
                    ]
                }
            },
            'product-dashboard': {
                title: ' Product Performance Dashboard',
                filters: ['dateRange', 'item', 'supplier'],
                dateLabel: 'Date Range',
                description: {
                    purpose: 'Deep dive into individual product performance with sales and inventory metrics.',
                    insights: [
                        'Product sales history and trends',
                        'Current stock levels and turnover',
                        'Profit margin analysis',
                        'Reorder recommendations'
                    ]
                }
            },
            'customer-dashboard': {
                title: ' Customer Dashboard',
                filters: ['customer', 'dateRange'],
                dateLabel: 'Date Range',
                customerRequired: true,
                description: {
                    purpose: 'View a complete profile of a customer including purchase history and account status.',
                    insights: [
                        'Customer purchase history and patterns',
                        'Account balance and payment history',
                        'Most purchased products',
                        'Customer lifetime value'
                    ]
                }
            },
            'supplier-dashboard': {
                title: ' Supplier Performance Dashboard',
                filters: ['supplier', 'dateRange'],
                dateLabel: 'Date Range',
                description: {
                    purpose: 'View supplier performance metrics, purchase trends, and payment status.',
                    insights: [
                        'Total purchases and trends',
                        'Top suppliers by spend',
                        'Payment status and outstanding',
                        'Product purchases breakdown',
                        'Supplier scorecard'
                    ]
                }
            }
        };
        
        function openReportSetup(reportType) {
            console.log(' openReportSetup called with:', reportType);
            currentReport = reportType;
            reportFilters = {}; // Reset filters
            
            // CRITICAL: Clear any existing content first
            document.getElementById('reportSetupContent').innerHTML = '';
            document.getElementById('reportSetupFilters').innerHTML = '';
            
            const config = reportConfig[reportType] || { title: 'Report', filters: [] };
            console.log(' Report config:', config);
            
            // If report has noFilters flag, show modal then generate directly
            if (config.noFilters) {
                // Set title
                document.getElementById('reportSetupTitle').textContent = config.title;
                
                // Clear filters area
                document.getElementById('reportSetupFilters').innerHTML = '';
                
                // Reset content area with loading message
                document.getElementById('reportSetupContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #888;">
                        <div style="font-size: 48px; margin-bottom: 15px;"></div>
                        <p>Loading...</p>
                    </div>`;
                
                // Show modal FIRST
                const modalElement = document.getElementById('reportSetupModal');
                modalElement.style.display = 'block';
                document.body.style.overflow = 'hidden';
                document.body.classList.add('modal-open');
                
                // Then execute report
                executeReport();
                return;
            }
            
            // Set title
            document.getElementById('reportSetupTitle').textContent = config.title;
            
            // Build filter UI
            let filterHtml = '';
            
            // Add collapsible wrapper for entire setup section
            filterHtml += `
                <div id="reportSetupToggle" onclick="toggleReportSetup()" style="
                    background: linear-gradient(135deg, var(--primary, #667eea) 0%, var(--secondary, #764ba2) 100%);
                    color: white;
                    padding: 10px 15px;
                    border-radius: 8px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin-bottom: 15px;
                    user-select: none;
                ">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <span class="setup-toggle-icon"></span>
                        <strong> Report Setup & Filters</strong>
                    </span>
                    <span style="font-size: 11px; opacity: 0.8;">tap to hide/show</span>
                </div>
            `;
            
            // Quick Date Select - OUTSIDE collapsible so always visible on mobile
            if (config.filters.includes('dateRange') || config.filters.includes('quickDateOnly')) {
                filterHtml += `
                    <div id="quickDateSelectBar" style="
                        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
                        border: 2px solid #6b9a8d;
                        border-radius: 10px;
                        padding: 12px 15px;
                        margin-bottom: 15px;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        flex-wrap: wrap;
                        gap: 10px;
                    ">
                        <span style="color: #2e7d32; font-weight: 600; font-size: 14px;"> Quick Date:</span>
                        <div style="position: relative; display: inline-block;">
                            <button type="button" class="btn" onclick="event.stopPropagation(); toggleDatePresetPicker()" 
                                    style="padding: 10px 18px; font-size: 14px; display: flex; align-items: center; gap: 8px; background: #6b9a8d; color: white; border: none; font-weight: 600;">
                                <span></span>
                                <span id="datePresetLabel">Choose Period</span>
                                <span style="opacity: 0.8;"></span>
                            </button>
                            <div id="datePresetDropdown" style="display: none; position: absolute; top: 100%; left: 0; z-index: 10001; margin-top: 5px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); min-width: 180px; overflow: hidden;">
                                <div onclick="event.stopPropagation(); selectDatePreset('today', ' Today')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span></span> Today
                                </div>
                                <div onclick="event.stopPropagation(); selectDatePreset('week', ' This Week')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span></span> This Week
                                </div>
                                <div onclick="event.stopPropagation(); selectDatePreset('month', ' This Month')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span></span> This Month
                                </div>
                                <div onclick="event.stopPropagation(); selectDatePreset('quarter', ' This Quarter')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span></span> This Quarter
                                </div>
                                <div onclick="event.stopPropagation(); selectDatePreset('year', ' This Year')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span></span> This Year
                                </div>
                                <div onclick="event.stopPropagation(); selectDatePreset('all', ' All Time')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span></span> All Time
                                </div>
                                <div onclick="event.stopPropagation(); selectDatePreset('clear', ' Clear Dates')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; background: #f8f9fa;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                    <span></span> <strong>Clear Dates</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Start collapsible section
            filterHtml += `<div id="reportSetupCollapsible" style="display: none;">`;
            
            // Add report description/help section if available (collapsed by default on mobile)
            if (config.description) {
                filterHtml += `
                    <div class="report-help-section" style="margin-bottom: 15px;">
                        <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.help-toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                             style="
                                background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%);
                                border: 1px solid #c5d5f7;
                                border-radius: 8px;
                                padding: 10px 14px;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                user-select: none;
                            ">
                            <span class="help-toggle-icon"></span>
                            <span style="font-size: 18px;"></span>
                            <span style="font-weight: 600; color: #1a365d; font-size: 13px;">What This Report Does</span>
                            <span style="color: #666; font-size: 11px; margin-left: auto;">tap for details</span>
                        </div>
                        <div style="display: none; background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%); border: 1px solid #c5d5f7; border-top: none; border-radius: 0 0 8px 8px; padding: 12px 14px;">
                            <div style="color: #4a5568; font-size: 13px; line-height: 1.5; margin-bottom: 10px;">
                                ${config.description.purpose}
                            </div>
                            ${config.description.insights ? `
                                <div style="background: white; border-radius: 8px; padding: 10px 12px; border: 1px solid #e2e8f0;">
                                    <div style="font-weight: 600; color: #2d3748; font-size: 11px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">
                                         What You'll Learn
                                    </div>
                                    <ul style="margin: 0; padding-left: 16px; color: #4a5568; font-size: 12px; line-height: 1.5;">
                                        ${config.description.insights.map(insight => `<li>${insight}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            filterHtml += '<div class="form-grid" style="gap: 15px;">';
            
            // Date Range
            if (config.filters.includes('dateRange')) {
                // Don't set default dates - show ALL records by default
                // User can add filters if they want to narrow it down
                
                filterHtml += `
                    <div class="form-group">
                        <label> ${config.dateLabel || 'Date'} From</label>
                        <input type="date" id="rptFilter_fromDate" value="" placeholder="All dates">
                    </div>
                    <div class="form-group">
                        <label> ${config.dateLabel || 'Date'} To</label>
                        <input type="date" id="rptFilter_toDate" value="" placeholder="All dates">
                    </div>`;
            }
            
            // Quick Date Only - just hidden fields for Sales Dashboard
            if (config.filters.includes('quickDateOnly')) {
                filterHtml += `
                    <input type="hidden" id="rptFilter_fromDate" value="">
                    <input type="hidden" id="rptFilter_toDate" value="">`;
            }
            
            // Customer dropdown - use card picker
            if (config.filters.includes('customer')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Customer</label>
                        <input type="text" id="rptFilter_customer_display" placeholder=" Click to select customer..." 
                            onclick="openCustomerPickerForReport()" readonly 
                            style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_customer" value="">
                    </div>`;
            }
            
            // Supplier dropdown - use card picker
            if (config.filters.includes('supplier')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Supplier</label>
                        <input type="text" id="rptFilter_supplier_display" placeholder=" Click to select supplier..." 
                            onclick="openSupplierPickerForReport()" readonly 
                            style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_supplier" value="">
                    </div>`;
            }
            
            // Item/Product picker (smart search)
            if (config.filters.includes('item')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Item</label>
                        <input type="text" id="rptFilter_item_display" placeholder=" All Items (click to filter)" onclick="openItemPickerForReport()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_item" value="">
                    </div>`;
            }
            
            // Purchase Invoice Picker
            if (config.filters.includes('purchaseInvoice')) {
                filterHtml += `
                    <div class="form-group">
                        <label> PO Invoice</label>
                        <input type="text" id="rptFilter_purchaseInvoice_display" placeholder=" All POs (click to filter)" onclick="openPurchaseInvoicePickerForReport()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_purchaseInvoice" value="">
                    </div>`;
            }
            
            // Payment Status
            if (config.filters.includes('paymentStatus')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Payment Status</label>
                        <input type="text" id="rptFilter_paymentStatus_display" placeholder=" Click to select..." onclick="openStatusPicker('paymentStatus', 'rptFilter_paymentStatus')" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_paymentStatus" value="">
                    </div>`;
            }
            
            // PO Type (Incoming/Outgoing)
            if (config.filters.includes('poType')) {
                filterHtml += `
                    <div class="form-group">
                        <label> PO Type</label>
                        <input type="text" id="rptFilter_poType_display" placeholder=" All Types (click to select)" onclick="openPOTypePicker()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_poType" value="">
                    </div>`;
            }
            
            // Stock Status - use card picker
            if (config.filters.includes('stockStatus')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Stock Status</label>
                        <input type="text" id="rptFilter_stockStatus_display" placeholder=" Click to select..." onclick="openStockStatusPicker()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_stockStatus" value="">
                    </div>`;
            }
            
            // Top N Products
            if (config.filters.includes('topN')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Show Top/Bottom</label>
                        <select id="rptFilter_topN">
                            <option value="5">Top 5</option>
                            <option value="10" selected>Top 10</option>
                            <option value="15">Top 15</option>
                            <option value="20">Top 20</option>
                            <option value="25">Top 25</option>
                            <option value="50">Top 50</option>
                        </select>
                    </div>`;
            }
            
            // Turnover Status
            if (config.filters.includes('turnoverStatus')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Turnover</label>
                        <select id="rptFilter_turnoverStatus">
                            <option value="">All</option>
                            <option value="dead"> Dead Stock (0 sold)</option>
                            <option value="slow"> Slow Moving</option>
                            <option value="fast"> Fast Moving</option>
                        </select>
                    </div>`;
            }
            
            // Aging
            if (config.filters.includes('aging')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Aging</label>
                        <select id="rptFilter_aging">
                            <option value="">All</option>
                            <option value="current">Current (0-30 days)</option>
                            <option value="30">31-60 days</option>
                            <option value="60">61-90 days</option>
                            <option value="90">90+ days</option>
                        </select>
                    </div>`;
            }
            
            // Min Amount
            if (config.filters.includes('minAmount')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Min Amount</label>
                        <input type="number" id="rptFilter_minAmount" placeholder="0.00" min="0" step="0.01">
                    </div>`;
            }
            
            // Transaction Status (for filtering voided transactions)
            if (config.filters.includes('transactionStatus')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Transaction Status</label>
                        <input type="text" id="rptFilter_transactionStatus_display" value=" Exclude Voided" onclick="openStatusPicker('transactionStatus', 'rptFilter_transactionStatus')" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_transactionStatus" value="exclude-voided">
                    </div>`;
            }
            
            // Delivery Status (for pick list)
            if (config.filters.includes('deliveryStatus')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Delivery Status</label>
                        <input type="text" id="rptFilter_deliveryStatus_display" value=" Needs Delivery" onclick="openStatusPicker('deliveryStatus', 'rptFilter_deliveryStatus')" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_deliveryStatus" value="needs-delivery">
                    </div>`;
            }
            
            // Sales Invoice Search (for pick list) - Smart Lookup
            if (config.filters.includes('salesInvoice')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Sales Invoice #</label>
                        <input type="text" id="rptFilter_salesInvoice_display" placeholder=" Click to select invoice..." 
                            onclick="openInvoicePickerForReport()" readonly 
                            style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_salesInvoice" value="">
                    </div>`;
            }
            
            // Dormant Days threshold (for dormant customers report)
            if (config.filters.includes('dormantDays')) {
                filterHtml += `
                    <div class="form-group" style="grid-column: span 2;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 15px; border: 2px solid #b8a86b;">
                                <label style="display: block; font-weight: 600; color: #92400e; margin-bottom: 8px; font-size: 14px;"> No Orders In Last...</label>
                                <select id="rptFilter_dormantDays" style="width: 100%; padding: 12px; border: 2px solid #b8a86b; border-radius: 8px; font-size: 15px; font-weight: 500; background: white; cursor: pointer;">
                                    <option value="14"> 2 Weeks (14 days)</option>
                                    <option value="30" selected> 1 Month (30 days)</option>
                                    <option value="60"> 2 Months (60 days)</option>
                                    <option value="90"> 3 Months (90 days)</option>
                                    <option value="180"> 6 Months (180 days)</option>
                                    <option value="365"> 1 Year (365 days)</option>
                                </select>
                            </div>
                            <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-radius: 12px; padding: 15px; border: 2px solid #6366f1;">
                                <label style="display: block; font-weight: 600; color: #4338ca; margin-bottom: 8px; font-size: 14px;"> Sort Results By</label>
                                <select id="rptFilter_dormantSort" style="width: 100%; padding: 12px; border: 2px solid #6366f1; border-radius: 8px; font-size: 15px; font-weight: 500; background: white; cursor: pointer;">
                                    <option value="days-desc"> Most Dormant First</option>
                                    <option value="days-asc"> Least Dormant First</option>
                                    <option value="city"> City (A-Z)</option>
                                    <option value="value-desc"> Highest Value First</option>
                                    <option value="orders-desc"> Most Orders First</option>
                                </select>
                            </div>
                        </div>
                    </div>`;
            }
            
            // Adjustment Type (for inventory adjustments report) - use card picker
            if (config.filters.includes('adjustmentType')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Adjustment Type</label>
                        <input type="text" id="rptFilter_adjustmentType_display" placeholder=" Click to select..." onclick="openAdjustmentTypePicker()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_adjustmentType" value="">
                    </div>`;
            }
            
            // Year Select (for tax reports)
            if (config.filters.includes('yearSelect')) {
                const currentYear = new Date().getFullYear();
                const years = [];
                for (let y = currentYear; y >= currentYear - 5; y--) {
                    years.push(y);
                }
                filterHtml += `
                    <div class="form-group">
                        <label> Year</label>
                        <select id="rptFilter_year">
                            ${years.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('')}
                        </select>
                    </div>`;
            }
            
            // Quarter Select (for tax reports)
            if (config.filters.includes('quarterSelect')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Period</label>
                        <select id="rptFilter_quarter">
                            <option value="annual">Full Year</option>
                            <option value="Q1">Q1 (Jan-Mar)</option>
                            <option value="Q2">Q2 (Apr-Jun)</option>
                            <option value="Q3">Q3 (Jul-Sep)</option>
                            <option value="Q4">Q4 (Oct-Dec)</option>
                        </select>
                    </div>`;
            }
            
            // COGS Method (for P&L report)
            if (config.filters.includes('cogsMethod')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Cost of Goods Method</label>
                        <select id="rptFilter_cogsMethod">
                            <option value="actual">Actual Purchase Costs (from POs)</option>
                            <option value="standard">Standard Costs (from Items table)</option>
                        </select>
                    </div>`;
            }
            
            filterHtml += '</div>';
            
            // Add Clear Filters button
            filterHtml += `
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="clearReportFilters()" 
                        style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 8px 16px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                         Clear All Filters
                    </button>
                </div>
            `;
            
            // Close the collapsible wrapper
            filterHtml += `</div>`;
            
            document.getElementById('reportSetupFilters').innerHTML = filterHtml;
            
            // Reset content area
            document.getElementById('reportSetupContent').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #888;">
                    <div style="font-size: 48px; margin-bottom: 15px;"></div>
                    <p>Configure filters above and click <strong>Run Report</strong></p>
                </div>`;
            
            // Show modal
            console.log(' About to show report setup modal...');
            const modalElement = document.getElementById('reportSetupModal');
            console.log(' Modal element:', modalElement ? 'Found' : 'NOT FOUND');
            
            if (!modalElement) {
                showError('ERROR: Report modal element not found in DOM!');
                return;
            }
            
            modalElement.style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            console.log(' Modal should now be visible');
            
            // Apply default settings for specific reports
            if (reportType === 'daily-dashboard') {
                // Default Daily Sales Dashboard to "Today"
                setTimeout(() => {
                    selectDatePreset('today', ' Today');
                }, 50);
            }
            
            if (reportType === 'supplier-dashboard') {
                // Default Supplier Performance Dashboard to "All Suppliers"
                setTimeout(() => {
                    const displayEl = document.getElementById('rptFilter_supplier_display');
                    const hiddenEl = document.getElementById('rptFilter_supplier');
                    if (displayEl) displayEl.value = ' All Suppliers';
                    if (hiddenEl) hiddenEl.value = '';
                }, 50);
            }
        }
        
        function setDatePreset(preset) {
            const today = new Date();
            let fromDate = new Date();
            let toDate = new Date();
            
            switch(preset) {
                case 'today':
                    fromDate = today;
                    toDate = today;
                    break;
                case 'week':
                    fromDate.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
                    toDate = today;
                    break;
                case 'month':
                    fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    // End of current month (last day)
                    toDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'quarter':
                    const quarter = Math.floor(today.getMonth() / 3);
                    fromDate = new Date(today.getFullYear(), quarter * 3, 1);
                    // End of quarter (last day of 3rd month in quarter)
                    toDate = new Date(today.getFullYear(), quarter * 3 + 3, 0);
                    break;
                case 'year':
                    fromDate = new Date(today.getFullYear(), 0, 1);
                    // End of year (Dec 31)
                    toDate = new Date(today.getFullYear(), 11, 31);
                    break;
                case 'all':
                case 'clear':
                    // For "All Time" or "Clear Dates", CLEAR the date filters completely
                    // This shows ALL records without any date filtering
                    const fromEl = document.getElementById('rptFilter_fromDate');
                    const toEl = document.getElementById('rptFilter_toDate');
                    if (fromEl) fromEl.value = '';
                    if (toEl) toEl.value = '';
                    console.log(' Dates cleared - will show all records');
                    return; // Exit early, don't set dates below
            }
            
            const fromEl = document.getElementById('rptFilter_fromDate');
            const toEl = document.getElementById('rptFilter_toDate');
            if (fromEl) fromEl.value = fromDate.toISOString().split('T')[0];
            if (toEl) toEl.value = toDate.toISOString().split('T')[0];
            console.log(' Date preset applied:', preset, 'From:', fromDate.toISOString().split('T')[0], 'To:', toDate.toISOString().split('T')[0]);
        }
        
        function toggleDatePresetPicker() {
            const dropdown = document.getElementById('datePresetDropdown');
            console.log(' Toggle dropdown clicked, dropdown element:', dropdown);
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                console.log(' Dropdown opened');
                // Close when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', closeDatePresetOnClickOutside);
                }, 10);
            } else {
                dropdown.style.display = 'none';
                console.log(' Dropdown closed');
            }
        }
        
        function closeDatePresetOnClickOutside(e) {
            const dropdown = document.getElementById('datePresetDropdown');
            if (!e.target.closest('#datePresetDropdown') && !e.target.closest('[onclick*="toggleDatePresetPicker"]')) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeDatePresetOnClickOutside);
            }
        }
        
        function selectDatePreset(preset, label) {
            console.log(' Date preset selected:', preset, label);
            // Update the button label
            const labelEl = document.getElementById('datePresetLabel');
            if (labelEl) {
                labelEl.textContent = label;
                console.log(' Button label updated to:', label);
            }
            // Close dropdown
            const dropdown = document.getElementById('datePresetDropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
                console.log(' Dropdown closed');
            }
            document.removeEventListener('click', closeDatePresetOnClickOutside);
            // Apply the preset
            setDatePreset(preset);
        }
        
        function clearReportFilters() {
            // Clear date inputs
            const fromDate = document.getElementById('rptFilter_fromDate');
            const toDate = document.getElementById('rptFilter_toDate');
            if (fromDate) fromDate.value = '';
            if (toDate) toDate.value = '';
            
            // Reset date preset label
            const dateLabel = document.getElementById('datePresetLabel');
            if (dateLabel) dateLabel.textContent = 'Choose Period';
            
            // Clear all picker-style inputs (display + hidden pairs)
            const pickerFields = [
                'rptFilter_customer',
                'rptFilter_supplier', 
                'rptFilter_item',
                'rptFilter_purchaseInvoice',
                'rptFilter_paymentStatus',
                'rptFilter_poType',
                'rptFilter_stockStatus',
                'rptFilter_adjustmentType',
                'rptFilter_salesInvoice'
            ];
            
            pickerFields.forEach(id => {
                const display = document.getElementById(id + '_display');
                const hidden = document.getElementById(id);
                if (display) display.value = '';
                if (hidden) hidden.value = '';
            });
            
            // Reset transaction status to default (exclude voided)
            const transStatusDisplay = document.getElementById('rptFilter_transactionStatus_display');
            const transStatusHidden = document.getElementById('rptFilter_transactionStatus');
            if (transStatusDisplay) transStatusDisplay.value = ' Exclude Voided';
            if (transStatusHidden) transStatusHidden.value = 'exclude-voided';
            
            // Reset delivery status to default (needs delivery)
            const deliveryStatusDisplay = document.getElementById('rptFilter_deliveryStatus_display');
            const deliveryStatusHidden = document.getElementById('rptFilter_deliveryStatus');
            if (deliveryStatusDisplay) deliveryStatusDisplay.value = ' Needs Delivery';
            if (deliveryStatusHidden) deliveryStatusHidden.value = 'needs-delivery';
            
            // Clear number inputs
            const minAmount = document.getElementById('rptFilter_minAmount');
            if (minAmount) minAmount.value = '';
            
            // Reset select dropdowns to first option
            const selects = [
                'rptFilter_year', 
                'rptFilter_quarter', 
                'rptFilter_cogsMethod', 
                'rptFilter_topN',
                'rptFilter_turnoverStatus',
                'rptFilter_aging',
                'rptFilter_dormantDays',
                'rptFilter_dormantSort'
            ];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.selectedIndex = 0;
            });
            
            // Reset reportFilters object
            reportFilters = {};
            
            // Clear selection arrays
            if (typeof selectedPOsForReport !== 'undefined') selectedPOsForReport = [];
            if (typeof selectedItemsForReport !== 'undefined') selectedItemsForReport = [];
            
            // Show confirmation
            showSuccess('All filters cleared');
        }
        
        function closeReportSetup() {
            const modal = document.getElementById('reportSetupModal');
            if (modal) modal.style.display = 'none';
            
            // Always reset body state
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.classList.remove('modal-open');
            
            // Reset maximize state only (position is saved to localStorage)
            reportModalMaximized = false;
            
            const modalInner = document.getElementById('reportSetupModalInner');
            const icon = document.getElementById('reportMaximizeIcon');
            
            // Only reset maximize state, not position
            if (modalInner) {
                modalInner.classList.remove('modal-maximized');
                // Don't remove modal-dragged or reset position - we want to remember it
            }
            if (icon) icon.textContent = '';
            
            // Safety: also close any picker modals that might be open
            const pickerModals = ['itemPickerModal', 'customerPickerModal', 'supplierPickerModal', 'invoicePickerModal', 'poPickerModal'];
            pickerModals.forEach(id => {
                const picker = document.getElementById(id);
                if (picker) picker.classList.remove('modal-open');
            });
        }
        
        // Toggle report modal between maximized and normal size
        let reportModalMaximized = false;
        let reportModalSavedPosition = null; // Save position before maximizing
        
        function toggleReportModalSize() {
            const modalOuter = document.getElementById('reportSetupModal');
            const modal = document.getElementById('reportSetupModalInner');
            const icon = document.getElementById('reportMaximizeIcon');
            
            if (!modal || !icon || !modalOuter) return;
            
            if (reportModalMaximized) {
                // RESTORE to centered modal
                modal.classList.remove('modal-maximized');
                modal.classList.remove('modal-dragged');
                modalOuter.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: block; padding: 20px; box-sizing: border-box; overflow-y: auto;';
                modal.style.cssText = 'background: white; width: 100%; max-width: 1400px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: calc(100vh - 40px); display: flex; flex-direction: column; overflow: hidden; resize: both; min-width: 500px; min-height: 400px; margin: 0 auto; position: relative;';
                
                icon.textContent = '';
                reportModalMaximized = false;
            } else {
                // MAXIMIZE to full screen
                modal.classList.add('modal-maximized');
                modalOuter.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: block; padding: 0; box-sizing: border-box; overflow: hidden;';
                modal.style.cssText = 'background: white; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; max-width: 100vw; max-height: 100vh; border-radius: 0; margin: 0; min-width: 0; min-height: 0; display: flex; flex-direction: column; overflow: hidden; resize: none; box-shadow: none;';
                
                icon.textContent = '';
                reportModalMaximized = true;
            }
            
            // Save the maximized state
            saveModalSize('reportSetupModalInner');
        }
        
        // Sort report table by column
        function sortReportTable(headerEl, colIndex) {
            const table = headerEl.closest('table');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const tfoot = table.querySelector('tfoot');
            if (!tbody) return;
            
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determine sort direction
            const currentDir = headerEl.dataset.sortDir || 'none';
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';
            
            // Reset all headers
            table.querySelectorAll('th').forEach(th => {
                th.dataset.sortDir = 'none';
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Set new direction
            headerEl.dataset.sortDir = newDir;
            headerEl.classList.add(newDir === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // Sort rows
            rows.sort((a, b) => {
                const aCell = a.cells[colIndex];
                const bCell = b.cells[colIndex];
                if (!aCell || !bCell) return 0;
                
                let aVal = aCell.textContent.trim();
                let bVal = bCell.textContent.trim();
                
                // Remove $ and , for numeric comparison
                const aNum = parseFloat(aVal.replace(/[$,%]/g, '').replace(/,/g, ''));
                const bNum = parseFloat(bVal.replace(/[$,%]/g, '').replace(/,/g, ''));
                
                // Check if both are numbers
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return newDir === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // String comparison
                return newDir === 'asc' 
                    ? aVal.localeCompare(bVal) 
                    : bVal.localeCompare(aVal);
            });
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }
        
        // Add sort styles to document
        (function addSortStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .sortable-header {
                    cursor: pointer;
                    user-select: none;
                    position: relative;
                    padding-right: 20px !important;
                }
                .sortable-header:hover {
                    background: rgba(0,0,0,0.1) !important;
                }
                .sortable-header::after {
                    content: '';
                    position: absolute;
                    right: 5px;
                    opacity: 0.4;
                    font-size: 12px;
                }
                .sortable-header.sort-asc::after {
                    content: '';
                    opacity: 1;
                }
                .sortable-header.sort-desc::after {
                    content: '';
                    opacity: 1;
                }
            `;
            document.head.appendChild(style);
        })();
        
        // Make all tables in report content sortable
        function makeReportTablesSortable() {
            const content = document.getElementById('reportSetupContent');
            if (!content) return;
            
            content.querySelectorAll('table.data-table thead th').forEach((th, idx) => {
                // Skip if already sortable
                if (th.classList.contains('sortable-header')) return;
                
                th.classList.add('sortable-header');
                th.onclick = function() { sortReportTable(this, idx); };
            });
        }
        
        // Print report in-place (no new window)
        function printReport() {
            const content = document.getElementById('reportSetupContent');
            const title = document.getElementById('reportSetupTitle').textContent;
            
            if (!content.innerHTML || content.innerHTML.includes('Configure filters')) {
                showWarning('Please run the report first before printing.');
                return;
            }
            
            // Clone content to avoid modifying original
            const contentClone = content.cloneNode(true);
            
            // Expand all hidden sections in clone
            contentClone.querySelectorAll('div').forEach(div => {
                if (div.style.display === 'none') {
                    div.style.display = div.parentElement?.querySelector('[onclick*="grid"]') ? 'grid' : 'block';
                }
            });
            
            // Convert canvases to images (use JPEG for smaller file size)
            const originalCanvases = content.querySelectorAll('canvas');
            const cloneCanvases = contentClone.querySelectorAll('canvas');
            originalCanvases.forEach((canvas, i) => {
                try {
                    // Create a new canvas with white background
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = canvas.height;
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    // Fill with white background first
                    tempCtx.fillStyle = '#FFFFFF';
                    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                    
                    // Draw the original chart on top
                    tempCtx.drawImage(canvas, 0, 0);
                    
                    const img = document.createElement('img');
                    // Use JPEG for white background support and smaller file size
                    img.src = tempCanvas.toDataURL('image/jpeg', 0.92);
                    img.style.cssText = 'max-width: 100%; height: auto; margin: 10px auto; display: block; background: white;';
                    if (cloneCanvases[i]) {
                        cloneCanvases[i].parentNode.replaceChild(img, cloneCanvases[i]);
                    }
                } catch(e) {
                    console.warn('Could not convert chart:', e);
                    // Remove failed canvas from print
                    if (cloneCanvases[i]) {
                        cloneCanvases[i].remove();
                    }
                }
            });
            
            // Get current theme colors
            const styles = getComputedStyle(document.documentElement);
            const primaryColor = styles.getPropertyValue('--primary').trim() || '#667eea';
            
            // Extract any <style> tags from the cloned content
            const styleElements = contentClone.querySelectorAll('style');
            let extractedStyles = '';
            styleElements.forEach(styleEl => {
                extractedStyles += styleEl.innerHTML;
            });
            
            // Open print window with clean HTML
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Nowak Distributing - ${title.replace(/^[^\w]+/, '')} - ${new Date().toLocaleDateString().replace(/\//g, '-')}</title>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        * { box-sizing: border-box; }
                        body { 
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            margin: 0; padding: 20px; color: #333;
                        }
                        h1 { color: ${primaryColor}; margin: 0 0 20px 0; font-size: 24px; }
                        h2, h3 { color: #333; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 11px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background: #f5f5f5; font-weight: 600; }
                        tr:nth-child(even) { background: #fafafa; }
                        .summary-box, [style*="background: linear-gradient"] { 
                            padding: 15px; margin: 10px 0; border-radius: 8px; 
                        }
                        img { max-width: 100%; height: auto; }
                        
                        /* Include extracted styles from report */
                        ${extractedStyles}
                        
                        /* Close button for mobile - floats at top right */
                        .print-close-btn {
                            position: fixed;
                            top: 10px;
                            right: 10px;
                            width: 50px;
                            height: 50px;
                            background: #b88a8a;
                            color: white;
                            border: none;
                            border-radius: 50%;
                            font-size: 28px;
                            font-weight: bold;
                            cursor: pointer;
                            z-index: 99999;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                        .print-close-btn:hover {
                            background: #b88a8a;
                        }
                        
                        @media print {
                            body { padding: 0; }
                            table { page-break-inside: auto; }
                            tr { page-break-inside: avoid; }
                            .print-close-btn { display: none !important; }
                            
                            /* Ensure colors print */
                            * {
                                -webkit-print-color-adjust: exact !important;
                                print-color-adjust: exact !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    <button class="print-close-btn" onclick="window.close()" title="Close">&times;</button>
                    <h1>${title.replace(/^[^\w]+/, '')}</h1>
                    ${contentClone.innerHTML}
                    <script>
                        // Wait for images to load before printing
                        window.onload = function() {
                            var printed = false;
                            function doPrint() {
                                if (printed) return;
                                printed = true;
                                setTimeout(function() { window.print(); }, 300);
                            }
                            
                            var images = document.querySelectorAll('img');
                            var loaded = 0;
                            var total = images.length;
                            
                            if (total === 0) {
                                doPrint();
                                return;
                            }
                            
                            images.forEach(function(img) {
                                if (img.complete) {
                                    loaded++;
                                    if (loaded >= total) doPrint();
                                } else {
                                    img.onload = img.onerror = function() {
                                        loaded++;
                                        if (loaded >= total) doPrint();
                                    };
                                }
                            });
                            
                            // Fallback - print after 2 seconds regardless
                            setTimeout(function() { doPrint(); }, 2000);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // Helper to get current theme colors for printing
        function getCurrentThemeColors() {
            const root = document.documentElement;
            const styles = getComputedStyle(root);
            return {
                primary: styles.getPropertyValue('--primary').trim() || '#667eea',
                secondary: styles.getPropertyValue('--secondary').trim() || '#764ba2',
                text: styles.getPropertyValue('--text-dark').trim() || '#333333'
            };
        }
        
        // Email report
        function emailReport() {
            const title = document.getElementById('reportSetupTitle').textContent;
            const content = document.getElementById('reportSetupContent');
            
            if (!content.innerHTML || content.innerHTML.includes('Configure filters')) {
                showWarning('Please run the report first before emailing.');
                return;
            }
            
            const companyName = document.getElementById('invoiceCompanyName')?.value || 'Nowak Distributing';
            
            // Extract text content for email body
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content.innerHTML;
            const textContent = tempDiv.innerText.substring(0, 1500) + '...';
            
            const subject = encodeURIComponent(`${title} - ${companyName} - ${new Date().toLocaleDateString()}`);
            const body = encodeURIComponent(`${title}\n${companyName}\nGenerated: ${new Date().toLocaleString()}\n\n${textContent}\n\n---\nFull report available in the ERP system.`);
            
            window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
        }
        
        // Text/SMS report
        function textReport() {
            const title = document.getElementById('reportSetupTitle').textContent;
            const content = document.getElementById('reportSetupContent');
            
            if (!content.innerHTML || content.innerHTML.includes('Configure filters')) {
                showWarning('Please run the report first before texting.');
                return;
            }
            
            const companyName = document.getElementById('invoiceCompanyName')?.value || 'Nowak Distributing';
            
            // Extract key numbers for SMS
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content.innerHTML;
            const textContent = tempDiv.innerText.substring(0, 250);
            
            const message = encodeURIComponent(`${companyName}\n${title}\n${new Date().toLocaleDateString()}\n\n${textContent}...`);
            
            // Try SMS on mobile, fallback to prompt
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                window.open(`sms:?body=${message}`, '_blank');
            } else {
                const phone = prompt('Enter phone number to text:');
                if (phone) {
                    window.open(`sms:${phone}?body=${message}`, '_blank');
                }
            }
        }
        
        // Save report as PDF (print to PDF)
        function saveReportPDF() {
            const content = document.getElementById('reportSetupContent');
            
            if (!content.innerHTML || content.innerHTML.includes('Configure filters')) {
                showWarning('Please run the report first before saving.');
                return;
            }
            
            showInfo('Tip: Use the Print button and select "Save as PDF" as your printer to save this report.');
            printReport();
        }
        
        // Toggle report setup section visibility
        function toggleReportSetup() {
            const collapsible = document.getElementById('reportSetupCollapsible');
            const toggleIcon = document.querySelector('.setup-toggle-icon');
            if (collapsible) {
                const isHidden = collapsible.style.display === 'none';
                collapsible.style.display = isHidden ? 'block' : 'none';
                if (toggleIcon) toggleIcon.textContent = isHidden ? '' : '';
            }
        }
        
        async function executeReport() {
            console.log(' executeReport called for:', currentReport);
            
            // CRITICAL: Destroy all existing charts before generating new ones
            destroyAllCharts();
            
            // AUTO-COLLAPSE the setup section when running report (especially helpful on mobile)
            const collapsible = document.getElementById('reportSetupCollapsible');
            const toggleIcon = document.querySelector('.setup-toggle-icon');
            if (collapsible) {
                collapsible.style.display = 'none';
                if (toggleIcon) toggleIcon.textContent = '';
            }
            
            // Gather filter values
            reportFilters = {
                fromDate: document.getElementById('rptFilter_fromDate')?.value || '',
                toDate: document.getElementById('rptFilter_toDate')?.value || '',
                customer: document.getElementById('rptFilter_customer')?.value || '',
                supplier: document.getElementById('rptFilter_supplier')?.value || '',
                item: document.getElementById('rptFilter_item')?.value || '',
                purchaseInvoice: document.getElementById('rptFilter_purchaseInvoice')?.value || '',
                paymentStatus: document.getElementById('rptFilter_paymentStatus')?.value || '',
                poType: document.getElementById('rptFilter_poType')?.value || '',
                stockStatus: document.getElementById('rptFilter_stockStatus')?.value || '',
                topN: parseInt(document.getElementById('rptFilter_topN')?.value) || 10,
                turnoverStatus: document.getElementById('rptFilter_turnoverStatus')?.value || '',
                aging: document.getElementById('rptFilter_aging')?.value || '',
                minAmount: parseFloat(document.getElementById('rptFilter_minAmount')?.value) || 0,
                year: document.getElementById('rptFilter_year')?.value || new Date().getFullYear(),
                quarter: document.getElementById('rptFilter_quarter')?.value || 'annual',
                cogsMethod: document.getElementById('rptFilter_cogsMethod')?.value || 'actual',
                transactionStatus: document.getElementById('rptFilter_transactionStatus')?.value || 'exclude-voided',
                adjustmentType: document.getElementById('rptFilter_adjustmentType')?.value || '',
                deliveryStatus: document.getElementById('rptFilter_deliveryStatus')?.value || 'needs-delivery',
                salesInvoice: document.getElementById('rptFilter_salesInvoice')?.value?.trim() || '',
                dormantDays: parseInt(document.getElementById('rptFilter_dormantDays')?.value) || 30,
                dormantSort: document.getElementById('rptFilter_dormantSort')?.value || 'days-desc'
            };
            
            console.log(' Report filters:', reportFilters);
            
            const container = document.getElementById('reportSetupContent');
            
            // CRITICAL: Clear any existing content completely
            container.innerHTML = '';
            
            // Show loading
            container.innerHTML = '<div style="padding: 40px; text-align: center;"><div style="font-size: 24px; margin-bottom: 10px;"></div>Generating report...</div>';
            
            // Scroll to top of content area on mobile
            container.scrollTop = 0;
            
            try {
                console.log(' About to generate report:', currentReport);
                let reportHtml = '';
                
                switch(currentReport) {
                    case 'sales-by-customer':
                        reportHtml = await generateSalesByCustomerModal();
                        break;
                    case 'sales-order-detail':
                        reportHtml = await generateSalesOrderDetailModal();
                        break;
                    case 'sales-by-product':
                        reportHtml = await generateSalesByProductModal();
                        break;
                    case 'pick-list':
                        reportHtml = await generatePickListModal();
                        break;
                    case 'dormant-customers':
                        reportHtml = await generateDormantCustomersModal();
                        break;
                    case 'purchase-order-detail':
                        reportHtml = await generatePurchaseOrderDetailModal();
                        break;
                    case 'purchase-by-supplier':
                        reportHtml = await generatePurchaseBySupplierModal();
                        break;
                    case 'supplier-performance':
                        reportHtml = await generateSupplierPerformanceModal();
                        break;
                    case 'inventory-turnover':
                        reportHtml = await generateInventoryTurnoverModal();
                        break;
                    case 'gross-margin':
                        reportHtml = await generateGrossMarginModal();
                        break;
                    case 'accounts-receivable':
                        reportHtml = await generateAccountsReceivableModal();
                        break;
                    case 'accounts-payable':
                        reportHtml = await generateAccountsPayableModal();
                        break;
                    case 'simple-inventory':
                        reportHtml = await generateSimpleInventoryModal();
                        break;
                    case 'inventory-flow':
                        reportHtml = await generateInventoryFlowModal();
                        break;
                    case 'inventory-adjustments':
                        reportHtml = await generateInventoryAdjustmentsModal();
                        break;
                    case 'profit-loss':
                        reportHtml = await generateProfitLossModal();
                        break;
                    case 'annual-sales-summary':
                        reportHtml = await generateAnnualSalesSummaryModal();
                        break;
                    case 'annual-purchase-summary':
                        reportHtml = await generateAnnualPurchaseSummaryModal();
                        break;
                    case 'inventory-valuation':
                        reportHtml = await generateInventoryValuationModal();
                        break;
                    case 'cash-flow-summary':
                        reportHtml = await generateCashFlowSummaryModal();
                        break;
                    case 'action-dashboard':
                        reportHtml = await generateActionDashboard();
                        break;
                    case 'customer-backorders':
                        reportHtml = await generateCustomerBackordersModal();
                        break;
                    case 'daily-dashboard':
                        reportHtml = await generateDailyDashboardModal();
                        break;
                    case 'business-overview':
                        reportHtml = await generateBusinessOverviewModal();
                        break;
                    case 'product-dashboard':
                        reportHtml = await generateProductDashboardModal();
                        break;
                    case 'customer-dashboard':
                        if (!reportFilters.customer) {
                            throw new Error('Please select a customer first');
                        }
                        reportHtml = await generateCustomerDashboardModal();
                        break;
                    case 'supplier-dashboard':
                        if (!reportFilters.supplier) {
                            throw new Error('Please select a supplier first');
                        }
                        reportHtml = await generateSupplierDashboardModal();
                        break;
                }
                
                // CRITICAL: Clear container completely first
                container.innerHTML = '';
                
                // Small delay to ensure DOM is clear
                await new Promise(resolve => setTimeout(resolve, 50));
                
                container.innerHTML = reportHtml;
                
                // Remove all script tags - we'll use a different approach
                const scripts = container.querySelectorAll('script');
                const scriptContents = [];
                scripts.forEach(script => {
                    scriptContents.push(script.textContent);
                    script.remove();
                });
                
                // Execute chart scripts ONCE with a single timeout
                // Clear any previous chart init timeout
                if (window.chartInitTimeout) {
                    clearTimeout(window.chartInitTimeout);
                }
                
                window.chartInitTimeout = setTimeout(() => {
                    scriptContents.forEach(content => {
                        try {
                            // Remove the setTimeout wrapper from the content if present
                            let cleanContent = content;
                            // Execute the content directly (the setTimeout inside will fire once)
                            const fn = new Function(cleanContent);
                            fn();
                        } catch(e) {
                            console.warn('Chart init error:', e);
                        }
                    });
                }, 200);
                
                // Make tables sortable
                makeReportTablesSortable();
                
            } catch (error) {
                container.innerHTML = `<div style="padding: 40px; text-align: center; color: red;"><div style="font-size: 24px; margin-bottom: 10px;"></div>Error: ${error.message}</div>`;
            }
        }
        
        // Modal versions of report generators that return HTML instead of writing to reportContainer
        async function generateSalesByCustomerModal() {
            // Load all report data in parallel (uses cache if available)
            await loadReportData();
            
            const customers = cachedCustomers;
            const items = cachedItems;
            const suppliers = cachedSuppliers;
            let sales = [...cachedSalesOrders]; // Clone to avoid modifying cache
            
            if (!sales.length || !customers.length || !items.length) {
                throw new Error('Failed to load data');
            }
            
            // Apply transaction status filter to sales orders first
            const statusFilter = reportFilters.transactionStatus || 'exclude-voided';
            if (statusFilter === 'exclude-voided') {
                sales = sales.filter(s => s.Status !== 'Voided');
            } else if (statusFilter && statusFilter !== '') {
                sales = sales.filter(s => s.Status === statusFilter);
            }
            
            // Use cached sales lines instead of individual API calls
            const allDetails = [];
            for (const so of sales) {
                const lines = getSalesLinesFromCache(so.SO_ID);
                lines.forEach(line => {
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const unitsPerPackage = parseFloat(item?.Units_Per_Package) || 1;
                        const packageCost = parseFloat(item?.Package_Cost) || 0;
                        const unitCost = packageCost / unitsPerPackage;
                        const quantity = parseInt(line.Quantity || 0);
                        // Calculate line total from qty * price (Line_Total may not exist)
                        const unitPrice = parseFloat(line.Unit_Price) || 0;
                        const lineTotal = quantity * unitPrice;
                        const lineCost = quantity * unitCost;
                        // Get listed sell price for discount calculation
                        const listPrice = parseFloat(item?.Unit_Sell_Price) || 0;
                        const listTotal = quantity * listPrice;
                        const discount = listTotal - lineTotal; // Positive = discount given
                        
                        allDetails.push({
                            soId: so.SO_ID,
                            soDate: so.Sale_Date || so.SO_Date,
                            customerId: so.Customer_ID,
                            customerName: getCustomerName(so.Customer_ID),
                            itemId: line.Item_ID,
                            itemDescription: item?.Item_Description || line.Item_ID,
                            quantity: quantity,
                            unitPrice: unitPrice,
                            listPrice: listPrice,
                            lineTotal: lineTotal,
                            listTotal: listTotal,
                            discount: discount,
                            lineCost: lineCost,
                            profit: lineTotal - lineCost
                        });
                });
            }
            
            // Helper function to parse dates in various formats
            function parseFlexibleDate(dateVal) {
                if (!dateVal) return null;
                
                // If already a Date object
                if (dateVal instanceof Date) return dateVal;
                
                // Convert to string
                const dateStr = String(dateVal).trim();
                if (!dateStr) return null;
                
                // Try ISO format first (2025-12-09)
                let parsed = new Date(dateStr);
                if (!isNaN(parsed.getTime())) return parsed;
                
                // Try parsing MM/DD/YYYY or M/D/YYYY format (with optional time)
                const usMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (usMatch) {
                    const month = parseInt(usMatch[1]) - 1;
                    const day = parseInt(usMatch[2]);
                    const year = parseInt(usMatch[3]);
                    return new Date(year, month, day);
                }
                
                return null;
            }
            
            // Apply filters with mobile-safe date parsing
            let filtered = allDetails;
            
            // Date filters
            if (reportFilters.fromDate && reportFilters.fromDate.trim() !== '') {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                if (!isNaN(fromDate.getTime())) {
                    fromDate.setHours(0, 0, 0, 0);
                    filtered = filtered.filter(d => {
                        const soDate = parseDateSafe(d.soDate);
                        return soDate && soDate >= fromDate;
                    });
                }
            }
            if (reportFilters.toDate && reportFilters.toDate.trim() !== '') {
                const toDate = parseLocalDate(reportFilters.toDate);
                if (!isNaN(toDate.getTime())) {
                    toDate.setHours(23, 59, 59, 999);
                    filtered = filtered.filter(d => {
                        const soDate = parseDateSafe(d.soDate);
                        return soDate && soDate <= toDate;
                    });
                }
            }
            if (reportFilters.customer) {
                filtered = filtered.filter(d => matchesFilter(d.customerId, reportFilters.customer));
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(d => d.lineTotal >= reportFilters.minAmount);
            }
            
            // Group by customer
            const byCustomer = {};
            const byProduct = {};
            const byCity = {};
            filtered.forEach(d => {
                // Find customer for address/city info
                const cust = customers.find(c => c.Customer_ID === d.customerId);
                const custCity = cust?.City || 'Unknown';
                const custState = cust?.State || '';
                
                if (!byCustomer[d.customerId]) {
                    const addressParts = [];
                    if (cust?.Address) addressParts.push(cust.Address);
                    const cityStateZip = [cust?.City, cust?.State, cust?.ZIP].filter(Boolean).join(', ');
                    if (cityStateZip) addressParts.push(cityStateZip);
                    
                    byCustomer[d.customerId] = { 
                        name: d.customerName, 
                        address: addressParts.join(', ') || '-',
                        location: cityStateZip || '-',
                        phone: cust?.Phone || '',
                        sales: 0, 
                        cost: 0, 
                        profit: 0,
                        listTotal: 0,
                        discount: 0,
                        qty: 0,
                        orders: new Set() 
                    };
                }
                byCustomer[d.customerId].sales += d.lineTotal;
                byCustomer[d.customerId].cost += d.lineCost;
                byCustomer[d.customerId].profit += d.profit;
                byCustomer[d.customerId].listTotal += d.listTotal;
                byCustomer[d.customerId].discount += d.discount;
                byCustomer[d.customerId].qty += d.quantity;
                byCustomer[d.customerId].orders.add(d.soId);
                
                // Track by product
                if (!byProduct[d.itemId]) {
                    const item = items.find(i => i.Item_ID === d.itemId);
                    const supp = suppliers.find(s => s.Supplier_ID === item?.Supplier_ID);
                    byProduct[d.itemId] = {
                        name: d.itemDescription,
                        supplierName: supp?.Supplier_Name || 'Unknown',
                        sales: 0,
                        cost: 0,
                        profit: 0,
                        qty: 0
                    };
                }
                byProduct[d.itemId].sales += d.lineTotal;
                byProduct[d.itemId].cost += d.lineCost;
                byProduct[d.itemId].profit += d.profit;
                byProduct[d.itemId].qty += d.quantity;
                
                // Track by city
                const cityKey = custCity + (custState ? ', ' + custState : '');
                if (!byCity[cityKey]) {
                    byCity[cityKey] = {
                        city: custCity,
                        state: custState,
                        sales: 0,
                        cost: 0,
                        profit: 0,
                        orders: 0,
                        customers: new Set()
                    };
                }
                byCity[cityKey].sales += d.lineTotal;
                byCity[cityKey].cost += d.lineCost;
                byCity[cityKey].profit += d.profit;
                byCity[cityKey].orders++;
                byCity[cityKey].customers.add(d.customerId);
            });
            
            // Calculate totals FIRST for KPI cards
            let totalSales = 0, totalCost = 0, totalProfit = 0, totalOrders = 0, totalListTotal = 0, totalDiscount = 0, totalQty = 0;
            Object.values(byCustomer).forEach(data => {
                totalSales += data.sales;
                totalCost += data.cost;
                totalProfit += data.profit;
                totalListTotal += data.listTotal;
                totalDiscount += data.discount;
                totalQty += data.qty;
                totalOrders += data.orders.size;
            });
            const totalMargin = totalSales > 0 ? (totalProfit / totalSales * 100) : 0;
            const avgOrderValue = totalOrders > 0 ? (totalSales / totalOrders) : 0;
            
            // Build inline filter summary for oval header
            const filterSummaryInline = generateFilterSummary({ inline: true });
            
            // Sort for Top 10 lists - BY SALES
            const sortedCustomers = Object.entries(byCustomer)
                .sort((a, b) => b[1].sales - a[1].sales);
            const top10Customers = sortedCustomers.slice(0, 10);
            const topProducts = Object.values(byProduct).sort((a, b) => b.sales - a.sales).slice(0, 10);
            const topCities = Object.values(byCity)
                .map(c => ({ ...c, customerCount: c.customers.size }))
                .sort((a, b) => b.sales - a.sales)
                .slice(0, 10);
            
            // Sort for Top 10 lists - BY MARGIN
            const customersWithMargin = Object.entries(byCustomer)
                .map(([id, c]) => ({ id, ...c, margin: c.sales > 0 ? (c.profit / c.sales * 100) : 0 }))
                .filter(c => c.sales > 0);
            const top10CustomersByMargin = customersWithMargin.sort((a, b) => b.margin - a.margin).slice(0, 10);
            
            const productsWithMargin = Object.values(byProduct)
                .map(p => ({ ...p, margin: p.sales > 0 ? (p.profit / p.sales * 100) : 0 }))
                .filter(p => p.sales > 0);
            const topProductsByMargin = productsWithMargin.sort((a, b) => b.margin - a.margin).slice(0, 10);
            
            const citiesWithMargin = Object.values(byCity)
                .map(c => ({ ...c, customerCount: c.customers.size, margin: c.sales > 0 ? (c.profit / c.sales * 100) : 0 }))
                .filter(c => c.sales > 0);
            const topCitiesByMargin = citiesWithMargin.sort((a, b) => b.margin - a.margin).slice(0, 10);
            
            // Group by date for Sales Trend chart
            const byDate = {};
            filtered.forEach(d => {
                const dateObj = parseDateSafe(d.soDate);
                if (dateObj) {
                    const dateKey = dateObj.toISOString().split('T')[0];
                    if (!byDate[dateKey]) byDate[dateKey] = 0;
                    byDate[dateKey] += d.lineTotal;
                }
            });
            const sortedDates = Object.entries(byDate).sort((a, b) => a[0].localeCompare(b[0]));
            const trendChartId = 'salesCustTrendChart_' + Date.now();
            
            // Calculate max values for bar charts
            const maxCustomerOrders = Math.max(...top10Customers.map(([id, c]) => c.orders.size), 1);
            const maxProductQty = Math.max(...topProducts.map(p => p.qty), 1);
            const maxCityOrders = Math.max(...topCities.map(c => c.orders), 1);
            const maxCustomerMargin = Math.max(...top10CustomersByMargin.map(c => c.margin), 1);
            const maxProductMargin = Math.max(...topProductsByMargin.map(p => p.margin), 1);
            const maxCityMargin = Math.max(...topCitiesByMargin.map(c => c.margin), 1);
            
            // Bar colors
            const barColors = ['#6b9a8d', '#7a9bb8', '#b8a86b', '#b88a8a', '#9a8ab8', '#b89aaa', '#7aaab8', '#9ab88a', '#b8a07a', '#8a8ab0'];
            
            // Build HTML with oval gradient header
            let html = `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #7a9bb8 0%, #9a8ab8 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(122, 155, 184, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Sales by Customer Report</h2>
                    <p style="margin: 0 0 ${filterSummaryInline ? '10px' : '0'} 0; font-size: 14px; opacity: 0.95;">${Object.keys(byCustomer).length} customers | ${totalOrders} orders | ${totalMargin.toFixed(1)}% avg margin${totalDiscount > 0 ? ' | ' + formatMoney(totalDiscount) + ' discounts' : ''}</p>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px;">${filterSummaryInline}</div>` : ''}
                </div>`;
            
            // KPI Summary Cards - Muted Professional Colors
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #7a9bb8;">
                        <div style="font-size: 11px; color: #5a7a8a; margin-bottom: 5px;"> Revenue</div>
                        <div style="font-size: 20px; font-weight: bold; color: #7a9bb8;">${formatMoney(totalSales)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b8a86b;">
                        <div style="font-size: 11px; color: #8a7a4a; margin-bottom: 5px;"> List Price</div>
                        <div style="font-size: 20px; font-weight: bold; color: #b8a86b;">${formatMoney(totalListTotal)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, ${totalDiscount > 0 ? '#ffebee 0%, #ffcdd2 100%' : '#f5f5f5 0%, #e8e8e8 100%'}); padding: 15px; border-radius: 8px; border-left: 4px solid ${totalDiscount > 0 ? '#b88a8a' : '#999'};">
                        <div style="font-size: 11px; color: ${totalDiscount > 0 ? '#8a6a6a' : '#666'}; margin-bottom: 5px;"> Discounts</div>
                        <div style="font-size: 20px; font-weight: bold; color: ${totalDiscount > 0 ? '#b88a8a' : '#999'};">${formatMoney(totalDiscount)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #6b9a8d;">
                        <div style="font-size: 11px; color: #5a7a6d; margin-bottom: 5px;"> Cost</div>
                        <div style="font-size: 20px; font-weight: bold; color: #6b9a8d;">${formatMoney(totalCost)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e8 0%, #d0e8d4 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #5a8a6d;">
                        <div style="font-size: 11px; color: #4a7a5d; margin-bottom: 5px;"> Profit</div>
                        <div style="font-size: 20px; font-weight: bold; color: #5a8a6d;">${formatMoney(totalProfit)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ede7f6 0%, #d1c4e9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9a8ab8;">
                        <div style="font-size: 11px; color: #7a6a8a; margin-bottom: 5px;"> Margin</div>
                        <div style="font-size: 20px; font-weight: bold; color: #9a8ab8;">${totalMargin.toFixed(1)}%</div>
                    </div>
                </div>
            `;
            
            // Top 10 Charts Section (collapsible) - Dashboard Style
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts & Top 10</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: block;">
                        <!-- Sales Trend Chart - Full Width -->
                        <div style="margin-top: 15px; margin-bottom: 15px;">
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Sales Trend</strong>
                                </div>
                                <canvas id="${trendChartId}" class="print-chart" height="180"></canvas>
                            </div>
                        </div>
                        
                        <!-- Section Header: By Sales -->
                        <div style="margin-bottom: 10px; padding: 8px 12px; background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); border-radius: 8px; border-left: 4px solid #7a9bb8;">
                            <strong style="color: #5a7a8a; font-size: 14px;"> Top 10 by Sales</strong>
                        </div>
                        
                        <!-- First Row: Top 10 Customers + Products BY SALES -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <!-- Top 10 Customers by Sales -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Top 10 Customers by Sales</strong>
                                </div>
                                ${top10Customers.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No sales in this period</p>' : `
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${top10Customers.map(([id, c], i) => `
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                <div style="overflow: hidden;">
                                                    <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.name.substring(0, 15)}</div>
                                                    <div style="font-size: 10px; color: #9ca3af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.location}</div>
                                                </div>
                                            </div>
                                            <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                <div style="height: 100%; width: ${(c.orders.size / maxCustomerOrders * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                    <span style="font-size: 10px; font-weight: 600; color: white;">${c.orders.size}</span>
                                                </div>
                                            </div>
                                            <div style="font-weight: 600; font-size: 12px; color: #1f2937; width: 65px; text-align: right;">${formatMoney(c.sales)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                `}
                            </div>
                            
                            <!-- Top 10 Products by Sales -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Top 10 Products by Sales</strong>
                                </div>
                                ${topProducts.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No sales in this period</p>' : `
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${topProducts.map((p, i) => `
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                <div style="overflow: hidden;">
                                                    <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.name.substring(0, 15)}</div>
                                                    <div style="font-size: 10px; color: #9ca3af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.qty} units  ${p.supplierName.substring(0, 10)}</div>
                                                </div>
                                            </div>
                                            <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                <div style="height: 100%; width: ${(p.qty / maxProductQty * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                    <span style="font-size: 10px; font-weight: 600; color: white;">${p.qty}</span>
                                                </div>
                                            </div>
                                            <div style="font-weight: 600; font-size: 12px; color: #1f2937; width: 65px; text-align: right;">${formatMoney(p.sales)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                `}
                            </div>
                        </div>
                    
                        <!-- Second Row: Top 10 Cities by Sales + Quick Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <!-- Top 10 Cities by Sales -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                <span style="font-size: 20px;"></span>
                                <strong style="font-size: 15px; color: #1f2937;">Top 10 Cities by Sales</strong>
                            </div>
                            ${topCities.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No sales in this period</p>' : `
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                ${topCities.map((c, i) => `
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                            <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                            <div style="overflow: hidden;">
                                                <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.city}${c.state ? ', ' + c.state : ''}</div>
                                                <div style="font-size: 10px; color: #9ca3af;">${c.customerCount} customer${c.customerCount !== 1 ? 's' : ''}</div>
                                            </div>
                                        </div>
                                        <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                            <div style="height: 100%; width: ${(c.orders / maxCityOrders * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                <span style="font-size: 10px; font-weight: 600; color: white;">${c.orders}</span>
                                            </div>
                                        </div>
                                        <div style="font-weight: 600; font-size: 12px; color: #1f2937; width: 65px; text-align: right;">${formatMoney(c.sales)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            `}
                        </div>
                    </div>
                        
                        <!-- Section Header: By Margin -->
                        <div style="margin-top: 20px; margin-bottom: 10px; padding: 8px 12px; background: linear-gradient(135deg, #e8f5e8 0%, #d0e8d4 100%); border-radius: 8px; border-left: 4px solid #5a8a6d;">
                            <strong style="color: #4a7a5d; font-size: 14px;"> Top 10 by Margin</strong>
                        </div>
                        
                        <!-- Third Row: Top 10 by Margin - Customers + Products -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <!-- Top 10 Customers by Margin -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Top 10 Customers by Margin</strong>
                                </div>
                                ${top10CustomersByMargin.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No qualifying customers</p>' : `
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${top10CustomersByMargin.map((c, i) => `
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                <div style="overflow: hidden;">
                                                    <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.name.substring(0, 15)}</div>
                                                    <div style="font-size: 10px; color: #9ca3af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${formatMoney(c.sales)} sales</div>
                                                </div>
                                            </div>
                                            <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                <div style="height: 100%; width: ${(c.margin / maxCustomerMargin * 100).toFixed(0)}%; background: ${c.margin >= 30 ? '#5a8a6d' : c.margin >= 15 ? '#b8a86b' : '#b88a8a'}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                    <span style="font-size: 10px; font-weight: 600; color: white;">${c.margin.toFixed(1)}%</span>
                                                </div>
                                            </div>
                                            <div style="font-weight: 600; font-size: 12px; color: #5a8a6d; width: 65px; text-align: right;">${formatMoney(c.profit)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                `}
                            </div>
                            
                            <!-- Top 10 Products by Margin -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Top 10 Products by Margin</strong>
                                </div>
                                ${topProductsByMargin.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No qualifying products</p>' : `
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${topProductsByMargin.map((p, i) => `
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                <div style="overflow: hidden;">
                                                    <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.name.substring(0, 15)}</div>
                                                    <div style="font-size: 10px; color: #9ca3af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${formatMoney(p.sales)} sales</div>
                                                </div>
                                            </div>
                                            <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                <div style="height: 100%; width: ${(p.margin / maxProductMargin * 100).toFixed(0)}%; background: ${p.margin >= 30 ? '#5a8a6d' : p.margin >= 15 ? '#b8a86b' : '#b88a8a'}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                    <span style="font-size: 10px; font-weight: 600; color: white;">${p.margin.toFixed(1)}%</span>
                                                </div>
                                            </div>
                                            <div style="font-weight: 600; font-size: 12px; color: #5a8a6d; width: 65px; text-align: right;">${formatMoney(p.profit)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                `}
                            </div>
                        </div>
                        
                        <!-- Fourth Row: Top 10 Cities by Margin -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px;">
                            <!-- Top 10 Cities by Margin -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Top 10 Cities by Margin</strong>
                                </div>
                                ${topCitiesByMargin.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No qualifying cities</p>' : `
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${topCitiesByMargin.map((c, i) => `
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                <div style="overflow: hidden;">
                                                    <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.city}${c.state ? ', ' + c.state : ''}</div>
                                                    <div style="font-size: 10px; color: #9ca3af;">${formatMoney(c.sales)} sales</div>
                                                </div>
                                            </div>
                                            <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                <div style="height: 100%; width: ${(c.margin / maxCityMargin * 100).toFixed(0)}%; background: ${c.margin >= 30 ? '#5a8a6d' : c.margin >= 15 ? '#b8a86b' : '#b88a8a'}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                    <span style="font-size: 10px; font-weight: 600; color: white;">${c.margin.toFixed(1)}%</span>
                                                </div>
                                            </div>
                                            <div style="font-weight: 600; font-size: 12px; color: #5a8a6d; width: 65px; text-align: right;">${formatMoney(c.profit)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Quick Stats Section (collapsible)
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Quick Stats</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: block; margin-top: 15px;">
                        <!-- Quick Stats -->
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; max-width: 500px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                <span style="font-size: 20px;"></span>
                                <strong style="font-size: 15px; color: #1f2937;">Quick Stats</strong>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Total Revenue</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${formatMoney(totalSales)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Total Cost</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${formatMoney(totalCost)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> List Price Total</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #b8a86b;">${formatMoney(totalListTotal)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Discounts Given</span>
                                    <span style="font-size: 14px; font-weight: 600; color: ${totalDiscount > 0 ? '#b88a8a' : '#9ca3af'};">${totalDiscount > 0 ? formatMoney(totalDiscount) : '-'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Gross Profit</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #10b981;">${formatMoney(totalProfit)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Profit Margin</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${totalMargin.toFixed(1)}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Total Orders</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${totalOrders.toLocaleString()}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Avg Order Value</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${formatMoney(avgOrderValue)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Active Customers</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${Object.keys(byCustomer).length}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Products Sold</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${Object.keys(byProduct).length}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                    <span style="font-size: 13px; color: #4b5563;"> Cities Served</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${Object.keys(byCity).length}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Detail Table Section (collapsible)
            html += `
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Detail Table</strong>
                        <span style="color: #666; font-size: 12px;">(${Object.keys(byCustomer).length} customers - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>Customer</th>
                                <th>Address</th>
                                <th style="text-align: right;">Orders</th>
                                <th style="text-align: right;">Qty</th>
                                <th style="text-align: right;">List Price</th>
                                <th style="text-align: right;">Discount</th>
                                <th style="text-align: right;">Sales</th>
                                <th style="text-align: right;">Cost</th>
                                <th style="text-align: right;">Profit</th>
                                <th style="text-align: right;">Margin</th>
                            </tr></thead><tbody>`;
            
            sortedCustomers.forEach(([id, data]) => {
                const margin = data.sales > 0 ? (data.profit / data.sales * 100) : 0;
                html += `<tr>
                    <td>${data.name}</td>
                    <td style="font-size: 12px; color: #666;">${data.address}</td>
                    <td style="text-align: right;">${data.orders.size}</td>
                    <td style="text-align: right;">${data.qty}</td>
                    <td style="text-align: right; color: #b8a86b;">${formatMoney(data.listTotal)}</td>
                    <td style="text-align: right; color: ${data.discount > 0 ? '#b88a8a' : '#999'}; font-weight: ${data.discount > 0 ? '600' : 'normal'};">${data.discount > 0 ? formatMoney(data.discount) : '-'}</td>
                    <td style="text-align: right;">${formatMoney(data.sales)}</td>
                    <td style="text-align: right;">${formatMoney(data.cost)}</td>
                    <td style="text-align: right; color: ${data.profit >= 0 ? '#6b9a8d' : '#b88a8a'};">${formatMoney(data.profit)}</td>
                    <td style="text-align: right;">${margin.toFixed(1)}%</td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td>TOTAL</td>
                <td></td>
                <td style="text-align: right;">${totalOrders}</td>
                <td style="text-align: right;">${totalQty}</td>
                <td style="text-align: right; color: #b8a86b;">${formatMoney(totalListTotal)}</td>
                <td style="text-align: right; color: ${totalDiscount > 0 ? '#b88a8a' : '#999'};">${totalDiscount > 0 ? formatMoney(totalDiscount) : '-'}</td>
                <td style="text-align: right;">${formatMoney(totalSales)}</td>
                <td style="text-align: right;">${formatMoney(totalCost)}</td>
                <td style="text-align: right; color: ${totalProfit >= 0 ? '#6b9a8d' : '#b88a8a'};">${formatMoney(totalProfit)}</td>
                <td style="text-align: right;">${totalMargin.toFixed(1)}%</td>
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            
            // Chart.js initialization for Sales Trend
            html += `
                <scr` + `ipt>
                    setTimeout(() => {
                        // Sales Trend Line Chart
                        const ctx = document.getElementById('${trendChartId}');
                        if (ctx) {
                            if(Chart.getChart(ctx))Chart.getChart(ctx).destroy(); new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: [${sortedDates.map(([date]) => `'${date.substring(5)}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Daily Sales',
                                        data: [${sortedDates.map(([, amt]) => amt.toFixed(2)).join(', ')}],
                                        borderColor: '#10b981',
                                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                        fill: true,
                                        tension: 0.3,
                                        pointRadius: 4,
                                        pointBackgroundColor: '#10b981'
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        y: { 
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        // Simplified modal generators for other reports - they use the same data but return HTML
        async function generateSalesOrderDetailModal() {
            // Load all report data (uses cache if available)
            await loadReportData();
            
            let sales = [...cachedSalesOrders];
            const items = cachedItems;
            
            if (!sales.length) throw new Error('Failed to load sales data');
            
            // Helper to get item name
            function getItemName(itemId) {
                const item = items.find(i => i.Item_ID == itemId);
                return item ? item.Item_Description : itemId;
            }
            
            // Helper function to parse dates in various formats
            function parseFlexibleDate(dateVal) {
                if (!dateVal) return null;
                if (dateVal instanceof Date) return dateVal;
                const dateStr = String(dateVal).trim();
                if (!dateStr) return null;
                let parsed = new Date(dateStr);
                if (!isNaN(parsed.getTime())) return parsed;
                const usMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (usMatch) {
                    return new Date(parseInt(usMatch[3]), parseInt(usMatch[1]) - 1, parseInt(usMatch[2]));
                }
                return null;
            }
            
            // Apply filters with mobile-safe date parsing
            if (reportFilters.fromDate && reportFilters.fromDate.trim() !== '') {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                if (!isNaN(fromDate.getTime())) {
                    fromDate.setHours(0, 0, 0, 0);
                    sales = sales.filter(s => {
                        const saleDate = parseDateSafe(s.Sale_Date || s.SO_Date);
                        return saleDate && saleDate >= fromDate;
                    });
                }
            }
            if (reportFilters.toDate && reportFilters.toDate.trim() !== '') {
                const toDate = parseLocalDate(reportFilters.toDate);
                if (!isNaN(toDate.getTime())) {
                    toDate.setHours(23, 59, 59, 999);
                    sales = sales.filter(s => {
                        const saleDate = parseDateSafe(s.Sale_Date || s.SO_Date);
                        return saleDate && saleDate <= toDate;
                    });
                }
            }
            if (reportFilters.customer) {
                sales = sales.filter(s => matchesFilter(s.Customer_ID, reportFilters.customer));
            }
            if (reportFilters.paymentStatus) {
                sales = sales.filter(s => s.Payment_Status === reportFilters.paymentStatus);
            }
            
            // If item filter is specified, filter sales to only those containing the item(s)
            if (reportFilters.item) {
                sales = sales.filter(so => {
                    const lines = getSalesLinesFromCache(so.SO_ID || so.SO_Number);
                    return lines.some(line => matchesFilter(line.Item_ID, reportFilters.item));
                });
            }
            
            // Filter by sales invoice(s)
            if (reportFilters.salesInvoice) {
                const selectedInvoices = reportFilters.salesInvoice.split(',').filter(v => v.trim());
                if (selectedInvoices.length > 0) {
                    sales = sales.filter(s => {
                        const invoiceNum = s.Invoice_Number || s.SO_Number || s.SO_ID;
                        return selectedInvoices.some(inv => invoiceNum && invoiceNum.toLowerCase().includes(inv.toLowerCase().trim()));
                    });
                }
            }
            
            // Calculate totals FIRST for KPI cards
            let totalAmount = 0, totalPaid = 0, paidCount = 0, unpaidCount = 0;
            let totalListPrice = 0, totalDiscount = 0, totalCost = 0, totalQtyOrdered = 0;
            const distinctItemIds = new Set();
            sales.forEach(s => {
                const amt = parseFloat(s.Total_Amount) || 0;
                const paid = parseFloat(s.Amount_Paid) || 0;
                totalAmount += amt;
                totalPaid += paid;
                // Check if actually paid: Payment_Status is 'Paid', OR amount paid covers total
                const balance = amt - paid;
                const isPaid = s.Payment_Status === 'Paid' || (balance <= 0.01 && amt > 0);
                if (isPaid) paidCount++;
                else if (amt > 0) unpaidCount++;
                
                // Calculate discount and cost from line items
                // Uses stored Unit_Cost if available (accurate at time of sale)
                const lines = getSalesLinesFromCache(s.SO_ID);
                lines.forEach(line => {
                    const qty = parseInt(line.Quantity) || 0;
                    const unitPrice = parseFloat(line.Unit_Price) || 0;
                    const item = items.find(i => i.Item_ID === line.Item_ID);
                    const listPrice = parseFloat(item?.Unit_Sell_Price) || 0;
                    
                    // Track distinct items
                    if (line.Item_ID) distinctItemIds.add(line.Item_ID);
                    
                    // Use stored Unit_Cost if available, fall back to current item cost
                    let unitCost;
                    const storedUnitCost = parseFloat(line.Unit_Cost);
                    if (!isNaN(storedUnitCost) && storedUnitCost > 0) {
                        unitCost = storedUnitCost;
                    } else {
                        const unitsPerPkg = parseFloat(item?.Units_Per_Package) || 1;
                        const pkgCost = parseFloat(item?.Package_Cost) || 0;
                        unitCost = pkgCost / unitsPerPkg;
                    }
                    
                    totalListPrice += qty * listPrice;
                    totalDiscount += (qty * listPrice) - (qty * unitPrice);
                    totalCost += qty * unitCost;
                    totalQtyOrdered += qty;
                });
            });
            const totalOwed = totalAmount - totalPaid;
            const totalProfit = totalAmount - totalCost;
            const profitMargin = totalAmount > 0 ? (totalProfit / totalAmount * 100) : 0;
            const distinctItemCount = distinctItemIds.size;
            
            // Build inline filter summary for oval header
            const filterSummaryInline = generateFilterSummary({ inline: true });
            
            let html = `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #7a9bb8 0%, #9a8ab8 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(122, 155, 184, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Sales Order Detail</h2>
                    <p style="margin: 0 0 ${filterSummaryInline ? '10px' : '0'} 0; font-size: 14px; opacity: 0.95;">${sales.length} orders | ${totalQtyOrdered.toLocaleString()} units | ${formatMoney(totalProfit)} profit (${profitMargin.toFixed(1)}%)${totalDiscount > 0 ? ' | ' + formatMoney(totalDiscount) + ' discounts' : ''}</p>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px;">${filterSummaryInline}</div>` : ''}
                </div>`;
            
            // KPI Summary Cards
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(115px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); padding: 12px; border-radius: 8px; border-left: 4px solid #7a9bb8;">
                        <div style="font-size: 10px; color: #5a7a8a; margin-bottom: 4px;"> Total Sales</div>
                        <div style="font-size: 18px; font-weight: bold; color: #7a9bb8;">${formatMoney(totalAmount)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); padding: 12px; border-radius: 8px; border-left: 4px solid #6b9a8d;">
                        <div style="font-size: 10px; color: #5a7a6d; margin-bottom: 4px;"> Cost</div>
                        <div style="font-size: 18px; font-weight: bold; color: #6b9a8d;">${formatMoney(totalCost)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e8 0%, #d0e8d4 100%); padding: 12px; border-radius: 8px; border-left: 4px solid #5a8a6d;">
                        <div style="font-size: 10px; color: #4a7a5d; margin-bottom: 4px;"> Profit</div>
                        <div style="font-size: 18px; font-weight: bold; color: #5a8a6d;">${formatMoney(totalProfit)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, ${totalDiscount > 0 ? '#ffebee 0%, #ffcdd2 100%' : '#f5f5f5 0%, #e8e8e8 100%'}); padding: 12px; border-radius: 8px; border-left: 4px solid ${totalDiscount > 0 ? '#b88a8a' : '#999'};">
                        <div style="font-size: 10px; color: ${totalDiscount > 0 ? '#8a6a6a' : '#666'}; margin-bottom: 4px;"> Discounts</div>
                        <div style="font-size: 18px; font-weight: bold; color: ${totalDiscount > 0 ? '#b88a8a' : '#999'};">${totalDiscount > 0 ? formatMoney(totalDiscount) : '$0.00'}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%); padding: 12px; border-radius: 8px; border-left: 4px solid #26a69a;">
                        <div style="font-size: 10px; color: #00796b; margin-bottom: 4px;"> Collected</div>
                        <div style="font-size: 18px; font-weight: bold; color: #26a69a;">${formatMoney(totalPaid)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); padding: 12px; border-radius: 8px; border-left: 4px solid #b8a86b;">
                        <div style="font-size: 10px; color: #8a7a4a; margin-bottom: 4px;"> Outstanding</div>
                        <div style="font-size: 18px; font-weight: bold; color: #b8a86b;">${formatMoney(totalOwed)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 12px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 10px; color: #1565c0; margin-bottom: 4px;"> Units Sold</div>
                        <div style="font-size: 18px; font-weight: bold; color: #2196f3;">${totalQtyOrdered.toLocaleString()}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); padding: 12px; border-radius: 8px; border-left: 4px solid #e91e63;">
                        <div style="font-size: 10px; color: #ad1457; margin-bottom: 4px;"> Products</div>
                        <div style="font-size: 18px; font-weight: bold; color: #e91e63;">${distinctItemCount}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f0e8f0 0%, #e4d8e8 100%); padding: 12px; border-radius: 8px; border-left: 4px solid #9a8ab8;">
                        <div style="font-size: 10px; color: #7a6a8a; margin-bottom: 4px;"> Paid / Total</div>
                        <div style="font-size: 18px; font-weight: bold; color: #9a8ab8;">${paidCount} / ${sales.length}</div>
                    </div>
                </div>
            `;
            
            // Group by payment status for chart (BEFORE table)
            const byStatus = {};
            sales.forEach(s => {
                const status = s.Payment_Status || 'Unpaid';
                if (!byStatus[status]) byStatus[status] = { count: 0, amount: 0 };
                byStatus[status].count++;
                byStatus[status].amount += parseFloat(s.Total_Amount) || 0;
            });
            
            const soChartId = 'soStatusChart_' + Date.now();
            const soLabels = Object.keys(byStatus);
            const soData = soLabels.map(s => byStatus[s].count);
            const soColors = {
                'Paid': '#6b9a8d',
                'Partial': '#7a9bb8',
                'Unpaid': '#b8a86b',
                'Overdue': '#b88a8a'
            };
            const chartColors = soLabels.map(s => soColors[s] || '#9c27b0');
            
            // Group by ORDER status (Pending, Shipped, Completed, etc.)
            const byOrderStatus = {};
            sales.forEach(s => {
                const orderStatus = s.Status || 'Pending';
                if (!byOrderStatus[orderStatus]) byOrderStatus[orderStatus] = { count: 0, amount: 0 };
                byOrderStatus[orderStatus].count++;
                byOrderStatus[orderStatus].amount += parseFloat(s.Total_Amount) || 0;
            });
            
            const orderStatusChartId = 'soOrderStatusChart_' + Date.now();
            const orderStatusLabels = Object.keys(byOrderStatus);
            const orderStatusData = orderStatusLabels.map(s => byOrderStatus[s].count);
            const orderStatusColors = {
                'Pending': '#b8a86b',
                'Processing': '#7a9bb8',
                'Shipped': '#9a8ab8',
                'Completed': '#6b9a8d',
                'Cancelled': '#b88a8a',
                'Voided': '#8a8a8a'
            };
            const orderChartColors = orderStatusLabels.map(s => orderStatusColors[s] || '#9c27b0');
            
            // Group by customer for bar chart - respect item filter
            const byCustomer = {};
            sales.forEach(s => {
                const custName = getCustomerName(s.Customer_ID);
                if (!byCustomer[custName]) byCustomer[custName] = 0;
                
                if (reportFilters.item) {
                    // When item filter active, only count filtered line items
                    const lines = getSalesLinesFromCache(s.SO_ID || s.SO_Number);
                    lines.forEach(line => {
                        if (matchesFilter(line.Item_ID, reportFilters.item)) {
                            const qty = parseFloat(line.Quantity) || 0;
                            const amount = parseFloat(line.Line_Total) || (qty * (parseFloat(line.Unit_Price) || 0));
                            byCustomer[custName] += amount;
                        }
                    });
                } else {
                    byCustomer[custName] += parseFloat(s.Total_Amount) || 0;
                }
            });
            const sortedCustomers = Object.entries(byCustomer).filter(([_, amt]) => amt > 0).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const customerChartId = 'soCustomerChart_' + Date.now();
            
            // Group by date for trend chart - respect item filter
            const byDate = {};
            sales.forEach(s => {
                const dateObj = parseDateSafe(s.Sale_Date || s.SO_Date);
                if (dateObj) {
                    const dateKey = dateObj.toISOString().split('T')[0];
                    if (!byDate[dateKey]) byDate[dateKey] = 0;
                    
                    if (reportFilters.item) {
                        // When item filter active, only count filtered line items
                        const lines = getSalesLinesFromCache(s.SO_ID || s.SO_Number);
                        lines.forEach(line => {
                            if (matchesFilter(line.Item_ID, reportFilters.item)) {
                                const qty = parseFloat(line.Quantity) || 0;
                                const amount = parseFloat(line.Line_Total) || (qty * (parseFloat(line.Unit_Price) || 0));
                                byDate[dateKey] += amount;
                            }
                        });
                    } else {
                        byDate[dateKey] += parseFloat(s.Total_Amount) || 0;
                    }
                }
            });
            const sortedDates = Object.entries(byDate).sort((a, b) => a[0].localeCompare(b[0]));
            const trendChartId = 'soTrendChart_' + Date.now();
            
            // Use cached sales order lines for Top Products chart - respect item filter
            const byProduct = {};
            for (const so of sales) {
                try {
                    const lines = getSalesLinesFromCache(so.SO_ID || so.SO_Number);
                    if (lines.length > 0) {
                        lines.forEach(line => {
                            // Apply item filter if specified
                            if (reportFilters.item && !matchesFilter(line.Item_ID, reportFilters.item)) {
                                return;
                            }
                            
                            const itemName = getItemName(line.Item_ID);
                            const qty = parseFloat(line.Quantity) || 0;
                            const amount = parseFloat(line.Line_Total) || (qty * (parseFloat(line.Unit_Price) || 0));
                            if (!byProduct[itemName]) byProduct[itemName] = { qty: 0, amount: 0 };
                            byProduct[itemName].qty += qty;
                            byProduct[itemName].amount += amount;
                        });
                    }
                } catch(e) {
                    // Skip if can't fetch lines
                }
            }
            const sortedProducts = Object.entries(byProduct).sort((a, b) => b[1].amount - a[1].amount).slice(0, 10);
            const productsChartId = 'soProductsChart_' + Date.now();
            
            // Group by city for Top 10 Cities - respect item filter
            const byCity = {};
            sales.forEach(s => {
                const cust = cachedCustomers.find(c => c.Customer_ID === s.Customer_ID);
                const city = cust?.City || 'Unknown';
                const state = cust?.State || '';
                const cityKey = city + (state ? ', ' + state : '');
                if (!byCity[cityKey]) {
                    byCity[cityKey] = { city, state, sales: 0, orders: 0, customers: new Set() };
                }
                
                if (reportFilters.item) {
                    // When item filter active, only count filtered line items
                    const lines = getSalesLinesFromCache(s.SO_ID || s.SO_Number);
                    lines.forEach(line => {
                        if (matchesFilter(line.Item_ID, reportFilters.item)) {
                            const qty = parseFloat(line.Quantity) || 0;
                            const amount = parseFloat(line.Line_Total) || (qty * (parseFloat(line.Unit_Price) || 0));
                            byCity[cityKey].sales += amount;
                        }
                    });
                } else {
                    byCity[cityKey].sales += parseFloat(s.Total_Amount) || 0;
                }
                byCity[cityKey].orders++;
                byCity[cityKey].customers.add(s.Customer_ID);
            });
            const topCities = Object.values(byCity)
                .map(c => ({ ...c, customerCount: c.customers.size }))
                .filter(c => c.sales > 0)
                .sort((a, b) => b.sales - a.sales)
                .slice(0, 10);
            
            // Calculate max values for HTML bar charts
            const maxCustomerSales = sortedCustomers.length > 0 ? sortedCustomers[0][1] : 1;
            const maxProductSales = sortedProducts.length > 0 ? sortedProducts[0][1].amount : 1;
            const maxCitySales = topCities.length > 0 ? topCities[0].sales : 1;
            
            // Bar colors for Top 10 charts
            const barColors = ['#6b9a8d', '#7a9bb8', '#b8a86b', '#b88a8a', '#9a8ab8', '#b89aaa', '#7aaab8', '#9ab88a', '#b8a07a', '#8a8ab0'];
            
            // Quick Stats calculations
            const avgOrderValue = sales.length > 0 ? totalAmount / sales.length : 0;
            const uniqueCustomers = new Set(sales.map(s => s.Customer_ID)).size;
            const uniqueProducts = Object.keys(byProduct).length;
            const uniqueCities = Object.keys(byCity).length;
            
            // Charts Section - restructured with Top 10 style
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: block; margin-top: 15px;">
                        <!-- First Row: Sales Trend - Full Width -->
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 15px;">
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #555;"> Sales Trend</h4>
                                <canvas id="${trendChartId}" class="print-chart" height="150"></canvas>
                            </div>
                        </div>
                        
                        <!-- Second Row: Status Charts -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <!-- Payment Status Donut -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #555;"> Payment Status</h4>
                                <canvas id="${soChartId}" class="print-chart" height="200"></canvas>
                            </div>
                            <!-- Order Status Donut -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #555;"> Order Status</h4>
                                <canvas id="${orderStatusChartId}" class="print-chart" height="200"></canvas>
                            </div>
                        </div>
                        
                        <!-- Third Row: Top 10 Charts (HTML bars) -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <!-- Top 10 Customers -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Top 10 Customers</strong>
                                </div>
                                ${sortedCustomers.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No sales data</p>' : `
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${sortedCustomers.map(([name, amt], i) => `
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="width: 100px; flex-shrink: 0; display: flex; align-items: flex-start; gap: 4px;">
                                                <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                <span style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name.substring(0, 12)}</span>
                                            </div>
                                            <div style="flex: 1; height: 20px; background: #f3f4f6; border-radius: 10px; overflow: hidden; min-width: 40px;">
                                                <div style="height: 100%; width: ${(amt / maxCustomerSales * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]}; border-radius: 10px;"></div>
                                            </div>
                                            <div style="font-weight: 600; font-size: 12px; color: #1f2937; width: 65px; text-align: right;">${formatMoney(amt)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                `}
                            </div>
                            
                            <!-- Top 10 Products -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Top 10 Products</strong>
                                </div>
                                ${sortedProducts.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No product data</p>' : `
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${sortedProducts.map(([name, data], i) => `
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="width: 100px; flex-shrink: 0; display: flex; align-items: flex-start; gap: 4px;">
                                                <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                <div style="overflow: hidden;">
                                                    <div style="font-weight: 600; font-size: 11px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name.substring(0, 12)}</div>
                                                    <div style="font-size: 9px; color: #9ca3af;">${data.qty} units</div>
                                                </div>
                                            </div>
                                            <div style="flex: 1; height: 20px; background: #f3f4f6; border-radius: 10px; overflow: hidden; min-width: 40px;">
                                                <div style="height: 100%; width: ${(data.amount / maxProductSales * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]}; border-radius: 10px;"></div>
                                            </div>
                                            <div style="font-weight: 600; font-size: 12px; color: #1f2937; width: 65px; text-align: right;">${formatMoney(data.amount)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                `}
                            </div>
                        </div>
                        
                        <!-- Fourth Row: Top 10 Cities + Quick Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                            <!-- Top 10 Cities -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Top 10 Cities</strong>
                                </div>
                                ${topCities.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No city data</p>' : `
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${topCities.map((c, i) => `
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="width: 100px; flex-shrink: 0; display: flex; align-items: flex-start; gap: 4px;">
                                                <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                <div style="overflow: hidden;">
                                                    <div style="font-weight: 600; font-size: 11px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.city}${c.state ? ', ' + c.state : ''}</div>
                                                    <div style="font-size: 9px; color: #9ca3af;">${c.customerCount} customer${c.customerCount !== 1 ? 's' : ''}</div>
                                                </div>
                                            </div>
                                            <div style="flex: 1; height: 20px; background: #f3f4f6; border-radius: 10px; overflow: hidden; min-width: 40px;">
                                                <div style="height: 100%; width: ${(c.sales / maxCitySales * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]}; border-radius: 10px;"></div>
                                            </div>
                                            <div style="font-weight: 600; font-size: 12px; color: #1f2937; width: 65px; text-align: right;">${formatMoney(c.sales)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                `}
                            </div>
                            
                            <!-- Quick Stats -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Quick Stats</strong>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Total Revenue</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${formatMoney(totalAmount)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Total Cost</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${formatMoney(totalCost)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Gross Profit</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #10b981;">${formatMoney(totalProfit)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Profit Margin</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${profitMargin.toFixed(1)}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Discounts Given</span>
                                        <span style="font-size: 14px; font-weight: 600; color: ${totalDiscount > 0 ? '#b88a8a' : '#9ca3af'};">${totalDiscount > 0 ? formatMoney(totalDiscount) : '-'}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Total Orders</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${sales.length}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Avg Order Value</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${formatMoney(avgOrderValue)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Unique Customers</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${uniqueCustomers}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Products Sold</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${uniqueProducts}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                        <span style="font-size: 13px; color: #4b5563;"> Cities Served</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${uniqueCities}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Detail Table Section (collapsible) - Show Line Items
            html += `
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Detail Table</strong>
                        <span style="color: #666; font-size: 12px;">(${sales.length} orders - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
            `;
            
            // Helper to get item info
            function getItemInfo(itemId) {
                const item = items.find(i => i.Item_ID == itemId);
                return item ? { 
                    name: item.Item_Description, 
                    sku: item.SKU,
                    listPrice: parseFloat(item.Unit_Sell_Price) || 0,
                    unitsPerPkg: parseFloat(item.Units_Per_Package) || 1,
                    pkgCost: parseFloat(item.Package_Cost) || 0
                } : { name: itemId, sku: '', listPrice: 0, unitsPerPkg: 1, pkgCost: 0 };
            }
            
            // Helper to get customer address
            function getCustomerAddress(customerId) {
                const cust = cachedCustomers.find(c => c.Customer_ID === customerId);
                if (!cust) return '-';
                const parts = [];
                if (cust.City) parts.push(cust.City);
                if (cust.State) parts.push(cust.State);
                return parts.join(', ') || '-';
            }
            
            html += `<div style="overflow-x: auto;"><table class="data-table">
                <thead><tr>
                    <th>Invoice # / Item</th>
                    <th>Date / SKU</th>
                    <th>Customer / Description</th>
                    <th style="text-align: center;">Qty</th>
                    <th style="text-align: right;">Unit Price</th>
                    <th style="text-align: right;">Line Total</th>
                    <th style="text-align: right;">Discount</th>
                    <th style="text-align: right;">Cost</th>
                    <th style="text-align: right;">Profit</th>
                    <th style="text-align: right;">Margin</th>
                    <th>Payment</th>
                </tr></thead><tbody>`;
            
            let grandTotal = 0;
            let grandTotalCost = 0;
            let grandTotalDiscount = 0;
            let grandTotalQty = 0;
            
            sales.sort((a, b) => new Date(b.Sale_Date || b.SO_Date) - new Date(a.Sale_Date || a.SO_Date))
                .forEach(so => {
                    const soTotal = parseFloat(so.Total_Amount) || 0;
                    const paid = parseFloat(so.Amount_Paid) || 0;
                    const balance = soTotal - paid;
                    const paymentStatus = so.Payment_Status || (paid >= soTotal ? 'Paid' : paid > 0 ? 'Partial' : 'Unpaid');
                    const paymentColor = paymentStatus === 'Paid' ? '#6b9a8d' : paymentStatus === 'Partial' ? '#b8a86b' : '#b88a8a';
                    const statusColor = so.Status === 'Delivered' ? '#6b9a8d' : so.Status === 'Pending' ? '#b8a86b' : '#6b7280';
                    
                    // Format date (mobile-safe)
                    const formattedDate = formatDateSafe(so.Sale_Date || so.SO_Date);
                    
                    // Get line items for this SO and calculate totals
                    const lines = getSalesLinesFromCache(so.SO_ID || so.SO_Number);
                    let soFilteredTotal = 0;
                    let soCost = 0;
                    let soDiscount = 0;
                    let soQty = 0;
                    let filteredLines = [];
                    
                    if (lines.length > 0) {
                        lines.forEach(line => {
                            // Apply item filter if specified
                            if (reportFilters.item && !matchesFilter(line.Item_ID, reportFilters.item)) {
                                return;
                            }
                            
                            const itemInfo = getItemInfo(line.Item_ID);
                            const qty = parseInt(line.Quantity) || 0;
                            const unitPrice = parseFloat(line.Unit_Price) || 0;
                            const lineTotal = qty * unitPrice;
                            
                            // Use stored Unit_Cost if available, fall back to current item cost
                            let unitCost;
                            const storedUnitCost = parseFloat(line.Unit_Cost);
                            if (!isNaN(storedUnitCost) && storedUnitCost > 0) {
                                unitCost = storedUnitCost;
                            } else {
                                unitCost = itemInfo.pkgCost / itemInfo.unitsPerPkg;
                            }
                            
                            const lineCost = qty * unitCost;
                            const listTotal = qty * itemInfo.listPrice;
                            const lineDiscount = listTotal - lineTotal;
                            
                            soFilteredTotal += lineTotal;
                            soCost += lineCost;
                            soDiscount += lineDiscount > 0 ? lineDiscount : 0;
                            soQty += qty;
                            filteredLines.push({ itemInfo, qty, unitPrice, lineTotal, lineCost, lineDiscount });
                        });
                    }
                    
                    // Add to grand total
                    grandTotal += reportFilters.item ? soFilteredTotal : soTotal;
                    grandTotalCost += soCost;
                    grandTotalDiscount += soDiscount;
                    grandTotalQty += soQty;
                    
                    // Calculate SO profit and margin
                    const soProfit = (reportFilters.item ? soFilteredTotal : soTotal) - soCost;
                    const soMargin = (reportFilters.item ? soFilteredTotal : soTotal) > 0 ? (soProfit / (reportFilters.item ? soFilteredTotal : soTotal) * 100) : 0;
                    
                    // SO Header Row - show filtered total when item filter is active
                    const displayTotal = reportFilters.item ? soFilteredTotal : soTotal;
                    const hasSODiscount = soDiscount > 0.01;
                    html += `<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); font-weight: 600;">
                        <td>
                            <span style="color: #667eea; font-weight: bold;">${so.Invoice_Number || so.SO_Number || '-'}</span>
                        </td>
                        <td>${formattedDate}</td>
                        <td>
                            <div>${getCustomerName(so.Customer_ID)}</div>
                            <div style="font-size: 11px; color: #888; font-weight: normal;">${getCustomerAddress(so.Customer_ID)}</div>
                        </td>
                        <td style="text-align: center; font-weight: bold;">${soQty % 1 === 0 ? soQty : soQty.toFixed(2)}</td>
                        <td></td>
                        <td style="text-align: right; color: #667eea;">${formatMoney(displayTotal)}</td>
                        <td style="text-align: right; color: ${hasSODiscount ? '#b88a8a' : '#999'};">${hasSODiscount ? formatMoney(soDiscount) : '-'}</td>
                        <td style="text-align: right; color: #6b7280;">${formatMoney(soCost)}</td>
                        <td style="text-align: right; color: ${soProfit >= 0 ? '#6b9a8d' : '#b88a8a'};">${formatMoney(soProfit)}</td>
                        <td style="text-align: right; color: ${soMargin >= 20 ? '#6b9a8d' : soMargin >= 10 ? '#b8a86b' : '#b88a8a'};">${soMargin.toFixed(1)}%</td>
                        <td>
                            <span style="background: ${paymentColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${paymentStatus}</span>
                            ${so.Status ? `<span style="background: ${statusColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 4px;">${so.Status}</span>` : ''}
                        </td>
                    </tr>`;
                    
                    // Render line items
                    if (filteredLines.length > 0) {
                        filteredLines.forEach(({ itemInfo, qty, unitPrice, lineTotal, lineCost, lineDiscount }) => {
                            const lineProfit = lineTotal - lineCost;
                            const lineMargin = lineTotal > 0 ? (lineProfit / lineTotal * 100) : 0;
                            const hasDiscount = lineDiscount > 0.01;
                            html += `<tr style="font-size: 13px;">
                                <td style="padding-left: 30px; color: #6b7280;"></td>
                                <td style="color: #6b7280; font-size: 12px;">${itemInfo.sku || '-'}</td>
                                <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${itemInfo.name}">${itemInfo.name}</td>
                                <td style="text-align: center;">${qty}</td>
                                <td style="text-align: right;">${formatMoney(unitPrice)}</td>
                                <td style="text-align: right;">${formatMoney(lineTotal)}</td>
                                <td style="text-align: right; color: ${hasDiscount ? '#b88a8a' : '#999'};">${hasDiscount ? formatMoney(lineDiscount) : '-'}</td>
                                <td style="text-align: right; color: #6b7280;">${formatMoney(lineCost)}</td>
                                <td style="text-align: right; color: ${lineProfit >= 0 ? '#6b9a8d' : '#b88a8a'};">${formatMoney(lineProfit)}</td>
                                <td style="text-align: right; color: ${lineMargin >= 20 ? '#6b9a8d' : lineMargin >= 10 ? '#b8a86b' : '#b88a8a'};">${lineMargin.toFixed(1)}%</td>
                                <td></td>
                            </tr>`;
                        });
                    } else if (lines.length === 0) {
                        html += `<tr style="font-size: 13px; color: #9ca3af;">
                            <td style="padding-left: 30px;"></td>
                            <td colspan="10" style="font-style: italic;">No line items</td>
                        </tr>`;
                    }
                });
            
            const grandProfit = grandTotal - grandTotalCost;
            const grandMargin = grandTotal > 0 ? (grandProfit / grandTotal * 100) : 0;
            const hasGrandDiscount = grandTotalDiscount > 0.01;
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="3">GRAND TOTAL</td>
                <td style="text-align: center;">${grandTotalQty % 1 === 0 ? grandTotalQty : grandTotalQty.toFixed(2)}</td>
                <td></td>
                <td style="text-align: right;">${formatMoney(grandTotal)}</td>
                <td style="text-align: right; color: ${hasGrandDiscount ? '#b88a8a' : '#999'};">${hasGrandDiscount ? formatMoney(grandTotalDiscount) : '-'}</td>
                <td style="text-align: right;">${formatMoney(grandTotalCost)}</td>
                <td style="text-align: right; color: ${grandProfit >= 0 ? '#6b9a8d' : '#b88a8a'};">${formatMoney(grandProfit)}</td>
                <td style="text-align: right; color: ${grandMargin >= 20 ? '#6b9a8d' : grandMargin >= 10 ? '#b8a86b' : '#b88a8a'};">${grandMargin.toFixed(1)}%</td>
                <td></td>
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            
            // Chart.js initialization for all 4 charts
            html += `
                <scr` + `ipt>
                    setTimeout(() => {
                        // Payment Status Donut
                        const ctx = document.getElementById('${soChartId}');
                        if (ctx) {
                            if(Chart.getChart(ctx))Chart.getChart(ctx).destroy(); new Chart(ctx, {
                                type: 'doughnut',
                                data: {
                                    labels: ['${soLabels.join("', '")}'],
                                    datasets: [{
                                        data: [${soData.join(', ')}],
                                        backgroundColor: ['${chartColors.join("', '")}'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { position: 'right', labels: { padding: 15, usePointStyle: true, font: { size: 11 } } },
                                        datalabels: {
                                            display: true,
                                            color: '#fff',
                                            font: { weight: 'bold', size: 12 },
                                            formatter: (value) => value > 0 ? value : ''
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Order Status Donut Chart
                        const ctxOrderStatus = document.getElementById('${orderStatusChartId}');
                        if (ctxOrderStatus) {
                            if(Chart.getChart(ctxOrderStatus))Chart.getChart(ctxOrderStatus).destroy(); new Chart(ctxOrderStatus, {
                                type: 'doughnut',
                                data: {
                                    labels: ['${orderStatusLabels.join("', '")}'],
                                    datasets: [{
                                        data: [${orderStatusData.join(', ')}],
                                        backgroundColor: ['${orderChartColors.join("', '")}'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { position: 'right', labels: { padding: 15, usePointStyle: true, font: { size: 11 } } },
                                        datalabels: {
                                            display: true,
                                            color: '#fff',
                                            font: { weight: 'bold', size: 12 },
                                            formatter: (value) => value > 0 ? value : ''
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Sales Trend Line Chart
                        const ctx3 = document.getElementById('${trendChartId}');
                        if (ctx3) {
                            if(Chart.getChart(ctx3))Chart.getChart(ctx3).destroy(); new Chart(ctx3, {
                                type: 'line',
                                data: {
                                    labels: [${sortedDates.map(([date]) => `'${date.substring(5)}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Daily Sales',
                                        data: [${sortedDates.map(([, amt]) => amt.toFixed(2)).join(', ')}],
                                        borderColor: '#10b981',
                                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                        fill: true,
                                        tension: 0.3,
                                        pointRadius: 4,
                                        pointBackgroundColor: '#10b981'
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        y: { 
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        async function generateSalesByProductModal() {
            // Load all report data (uses cache if available)
            await loadReportData();
            
            const items = cachedItems;
            const suppliers = cachedSuppliers;
            let sales = [...cachedSalesOrders];
            
            if (!items.length || !suppliers.length) {
                throw new Error('Failed to load data');
            }
            
            // Apply transaction status filter to sales orders
            const statusFilter = reportFilters.transactionStatus || 'exclude-voided';
            if (statusFilter === 'exclude-voided') {
                sales = sales.filter(so => so.Status !== 'Voided');
            } else if (statusFilter && statusFilter !== '') {
                sales = sales.filter(so => so.Status === statusFilter);
            }
            
            // Use cached sales lines
            const allLines = [];
            for (const so of sales) {
                const lines = getSalesLinesFromCache(so.SO_ID);
                if (lines.length > 0) {
                    lines.forEach(line => {
                        line.SO_Date = so.Sale_Date || so.SO_Date;
                        line.Customer_ID = so.Customer_ID; // Add customer ID for grouping
                        // Calculate line total (Line_Total may not exist in API response)
                        const qty = parseInt(line.Quantity || 0);
                        const unitPrice = parseFloat(line.Unit_Price || 0);
                        line.Line_Total = qty * unitPrice;
                        // Store actual unit price for discount calculation
                        line.Actual_Unit_Price = unitPrice;
                        allLines.push(line);
                    });
                }
            }
            
            // APPLY DATE FILTERS to sales lines using safe parsing
            let filteredLines = allLines;
            filteredLines = applyDateRangeFilter(filteredLines, 'SO_Date');
            
            // APPLY ITEM FILTER if specified
            if (reportFilters.item) {
                filteredLines = filteredLines.filter(line => matchesFilter(line.Item_ID, reportFilters.item));
            }
            
            // Calculate units sold per item and track discounts
            const unitsSoldByItem = {};
            const revenueBYItem = {};
            const listTotalByItem = {};
            const discountByItem = {};
            const byDate = {};
            const bySupplier = {};
            const byCustomer = {};
            const customers = cachedCustomers || [];
            filteredLines.forEach(line => {
                const itemId = line.Item_ID;
                const qty = parseInt(line.Quantity || 0);
                const lineTotal = parseFloat(line.Line_Total || 0);
                const actualUnitPrice = parseFloat(line.Actual_Unit_Price || 0);
                const item = items.find(i => i.Item_ID === itemId);
                const listPrice = parseFloat(item?.Unit_Sell_Price) || 0;
                const listTotal = qty * listPrice;
                const lineDiscount = listTotal - lineTotal;
                
                // Calculate cost for this line
                const unitsPerPackage = parseFloat(item?.Units_Per_Package) || 1;
                const packageCost = parseFloat(item?.Package_Cost) || 0;
                const unitCost = packageCost / unitsPerPackage;
                const lineCost = qty * unitCost;
                const lineProfit = lineTotal - lineCost;
                
                unitsSoldByItem[itemId] = (unitsSoldByItem[itemId] || 0) + qty;
                revenueBYItem[itemId] = (revenueBYItem[itemId] || 0) + lineTotal;
                listTotalByItem[itemId] = (listTotalByItem[itemId] || 0) + listTotal;
                discountByItem[itemId] = (discountByItem[itemId] || 0) + lineDiscount;
                
                // Group by date for Sales Trend chart
                const soDate = line.SO_Date ? new Date(line.SO_Date) : null;
                if (soDate && !isNaN(soDate.getTime())) {
                    const dateKey = soDate.toISOString().split('T')[0];
                    if (!byDate[dateKey]) byDate[dateKey] = 0;
                    byDate[dateKey] += lineTotal;
                }
                
                // Group by supplier
                const supplierId = item?.Supplier_ID || 'Unknown';
                const supplierName = suppliers.find(s => s.Supplier_ID === supplierId)?.Supplier_Name || 'Unknown';
                if (!bySupplier[supplierId]) {
                    bySupplier[supplierId] = { name: supplierName, sales: 0, cost: 0, profit: 0, qty: 0 };
                }
                bySupplier[supplierId].sales += lineTotal;
                bySupplier[supplierId].cost += lineCost;
                bySupplier[supplierId].profit += lineProfit;
                bySupplier[supplierId].qty += qty;
                
                // Group by customer
                const customerId = line.Customer_ID || 'Unknown';
                const customer = customers.find(c => c.Customer_ID === customerId);
                const customerName = customer?.Customer_Name || customerId;
                if (!byCustomer[customerId]) {
                    byCustomer[customerId] = { name: customerName, sales: 0, cost: 0, profit: 0, qty: 0 };
                }
                byCustomer[customerId].sales += lineTotal;
                byCustomer[customerId].cost += lineCost;
                byCustomer[customerId].profit += lineProfit;
                byCustomer[customerId].qty += qty;
            });
            
            // Sort dates for trend chart
            const sortedDates = Object.entries(byDate).sort((a, b) => a[0].localeCompare(b[0]));
            
            // Build product list with margins - ONLY items that were sold
            const productData = items
                .filter(item => unitsSoldByItem[item.Item_ID] > 0) // Only items with sales
                .map(item => {
                    const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                    const packageCost = parseFloat(item.Package_Cost) || 0;
                    const unitCost = packageCost / unitsPerPackage;
                    const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                    const margin = unitSellPrice - unitCost;
                    const marginPercent = unitSellPrice > 0 ? (margin / unitSellPrice) * 100 : 0;
                    const unitsSold = unitsSoldByItem[item.Item_ID] || 0;
                    const revenue = revenueBYItem[item.Item_ID] || 0;
                    const listTotal = listTotalByItem[item.Item_ID] || 0;
                    const discount = discountByItem[item.Item_ID] || 0;
                    const cost = unitsSold * unitCost;
                    const totalProfit = revenue - cost;
                    
                    return {
                        id: item.Item_ID,
                        description: item.Item_Description || '',
                        sku: item.SKU || '',
                        supplierId: item.Supplier_ID || '',
                        supplierName: suppliers.find(s => s.Supplier_ID === item.Supplier_ID)?.Supplier_Name || '',
                        unitCost: unitCost,
                        unitSellPrice: unitSellPrice,
                        margin: margin,
                        marginPercent: marginPercent,
                        unitsSold: unitsSold,
                        revenue: revenue,
                        listTotal: listTotal,
                        discount: discount,
                        cost: cost,
                        totalProfit: totalProfit,
                        qtyOnHand: parseInt(item.Qty_On_Hand) || 0,
                        reorderPoint: parseInt(item.Reorder_Point) || 0
                    };
                });
            
            // Sort by units sold (highest first)
            const sorted = productData.sort((a, b) => b.unitsSold - a.unitsSold);
            
            // Calculate totals
            const totalUnits = sorted.reduce((sum, p) => sum + p.unitsSold, 0);
            const totalRevenue = sorted.reduce((sum, p) => sum + p.revenue, 0);
            const totalListPrice = sorted.reduce((sum, p) => sum + p.listTotal, 0);
            const totalDiscount = sorted.reduce((sum, p) => sum + p.discount, 0);
            const totalCost = sorted.reduce((sum, p) => sum + p.cost, 0);
            const totalProfit = sorted.reduce((sum, p) => sum + p.totalProfit, 0);
            const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
            
            // Top 10 for charts
            const top10Items = sorted.slice(0, 10);
            const trendChartId = 'salesItemTrendChart_' + Date.now();
            
            // Bar colors for charts
            const barColors = ['#7a9bb8', '#9a8ab8', '#7aaab8', '#6b9a8d', '#b8a86b', '#a8a8a8', '#8ab89a', '#b8887a', '#8a8ab8', '#b8b87a'];
            
            // Top 10 Items by Sales (revenue)
            const top10BySales = sorted.slice(0, 10);
            const maxItemSales = top10BySales.length > 0 ? Math.max(...top10BySales.map(p => p.revenue)) : 0;
            
            // Top 10 Suppliers by Sales
            const sortedSuppliers = Object.entries(bySupplier)
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 10);
            const maxSupplierSales = sortedSuppliers.length > 0 ? Math.max(...sortedSuppliers.map(([, s]) => s.sales)) : 0;
            
            // Top 10 Items by Margin
            const topItemsByMargin = sorted
                .filter(p => p.revenue > 0)
                .map(p => ({
                    ...p,
                    margin: p.revenue > 0 ? (p.totalProfit / p.revenue * 100) : 0
                }))
                .sort((a, b) => b.margin - a.margin)
                .slice(0, 10);
            const maxItemMargin = topItemsByMargin.length > 0 ? Math.max(...topItemsByMargin.map(p => p.margin)) : 0;
            
            // Top 10 Suppliers by Margin
            const topSuppliersByMargin = Object.entries(bySupplier)
                .filter(([, s]) => s.sales > 0)
                .map(([id, s]) => ({
                    id,
                    name: s.name,
                    sales: s.sales,
                    profit: s.profit,
                    margin: s.sales > 0 ? (s.profit / s.sales * 100) : 0
                }))
                .sort((a, b) => b.margin - a.margin)
                .slice(0, 10);
            const maxSupplierMargin = topSuppliersByMargin.length > 0 ? Math.max(...topSuppliersByMargin.map(s => s.margin)) : 0;
            
            // Top 10 Customers by Sales
            const sortedCustomers = Object.entries(byCustomer)
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 10);
            const maxCustomerSales = sortedCustomers.length > 0 ? Math.max(...sortedCustomers.map(([, c]) => c.sales)) : 0;
            
            // Top 10 Customers by Margin
            const topCustomersByMargin = Object.entries(byCustomer)
                .filter(([, c]) => c.sales > 0)
                .map(([id, c]) => ({
                    id,
                    name: c.name,
                    sales: c.sales,
                    profit: c.profit,
                    margin: c.sales > 0 ? (c.profit / c.sales * 100) : 0
                }))
                .sort((a, b) => b.margin - a.margin)
                .slice(0, 10);
            const maxCustomerMargin = topCustomersByMargin.length > 0 ? Math.max(...topCustomersByMargin.map(c => c.margin)) : 0;
            
            // Build inline filter summary for oval header
            const filterSummaryInline = generateFilterSummary({ inline: true });
            
            let html = `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #7a9bb8 0%, #9a8ab8 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(122, 155, 184, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Sales by Item</h2>
                    <p style="margin: 0 0 ${filterSummaryInline ? '10px' : '0'} 0; font-size: 14px; opacity: 0.95;">${sorted.length} items sold | ${totalUnits.toLocaleString()} units | ${avgMargin.toFixed(1)}% avg margin${totalDiscount > 0 ? ' | ' + formatMoney(totalDiscount) + ' discounts' : ''}</p>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px;">${filterSummaryInline}</div>` : ''}
                </div>
                
                <!-- KPI Cards - Muted Professional Colors -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #7a9bb8;">
                        <div style="font-size: 11px; color: #5a7a8a; margin-bottom: 5px;"> Revenue</div>
                        <div style="font-size: 20px; font-weight: bold; color: #7a9bb8;">${formatMoney(totalRevenue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b8a86b;">
                        <div style="font-size: 11px; color: #8a7a4a; margin-bottom: 5px;"> List Price</div>
                        <div style="font-size: 20px; font-weight: bold; color: #b8a86b;">${formatMoney(totalListPrice)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, ${totalDiscount > 0 ? '#ffebee 0%, #ffcdd2 100%' : '#f5f5f5 0%, #e8e8e8 100%'}); padding: 15px; border-radius: 8px; border-left: 4px solid ${totalDiscount > 0 ? '#b88a8a' : '#999'};">
                        <div style="font-size: 11px; color: ${totalDiscount > 0 ? '#8a6a6a' : '#666'}; margin-bottom: 5px;"> Discounts</div>
                        <div style="font-size: 20px; font-weight: bold; color: ${totalDiscount > 0 ? '#b88a8a' : '#999'};">${totalDiscount > 0 ? formatMoney(totalDiscount) : '$0.00'}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #6b9a8d;">
                        <div style="font-size: 11px; color: #5a7a6d; margin-bottom: 5px;"> Cost</div>
                        <div style="font-size: 20px; font-weight: bold; color: #6b9a8d;">${formatMoney(totalCost)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e8 0%, #d0e8d4 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #5a8a6d;">
                        <div style="font-size: 11px; color: #4a7a5d; margin-bottom: 5px;"> Profit</div>
                        <div style="font-size: 20px; font-weight: bold; color: #5a8a6d;">${formatMoney(totalProfit)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ede7f6 0%, #d1c4e9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9a8ab8;">
                        <div style="font-size: 11px; color: #7a6a8a; margin-bottom: 5px;"> Margin</div>
                        <div style="font-size: 20px; font-weight: bold; color: #9a8ab8;">${avgMargin.toFixed(1)}%</div>
                    </div>
                </div>
            `;
            
            if (sorted.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No sales found for the selected period</p>';
            } else {
                // Charts Section (collapsible) - Dashboard Style matching Sales by Customer
                html += `
                    <div style="margin-bottom: 20px;">
                        <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                             style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                            <span class="toggle-icon"></span>
                            <strong> Charts & Top 10</strong>
                            <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                        </div>
                        <div style="display: block;">
                            <!-- Sales Trend Chart - Full Width -->
                            <div style="margin-top: 15px; margin-bottom: 15px;">
                                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                        <span style="font-size: 20px;"></span>
                                        <strong style="font-size: 15px; color: #1f2937;">Sales Trend</strong>
                                    </div>
                                    <canvas id="${trendChartId}" class="print-chart" height="180"></canvas>
                                </div>
                            </div>
                            
                            <!-- Section Header: By Sales -->
                            <div style="margin-bottom: 10px; padding: 8px 12px; background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); border-radius: 8px; border-left: 4px solid #7a9bb8;">
                                <strong style="color: #5a7a8a; font-size: 14px;"> Top 10 by Sales</strong>
                            </div>
                            
                            <!-- First Row: Top 10 Items + Suppliers BY SALES -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                <!-- Top 10 Items by Sales -->
                                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                        <span style="font-size: 20px;"></span>
                                        <strong style="font-size: 15px; color: #1f2937;">Top 10 Items by Sales</strong>
                                    </div>
                                    ${top10BySales.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No sales in this period</p>' : `
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        ${top10BySales.map((p, i) => `
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                    <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                    <div style="overflow: hidden;">
                                                        <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.description.substring(0, 15)}</div>
                                                        <div style="font-size: 10px; color: #9ca3af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.unitsSold} units</div>
                                                    </div>
                                                </div>
                                                <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                    <div style="height: 100%; width: ${(p.revenue / maxItemSales * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                        <span style="font-size: 10px; font-weight: 600; color: white;">${p.unitsSold}</span>
                                                    </div>
                                                </div>
                                                <div style="font-weight: 600; font-size: 12px; color: #1f2937; width: 65px; text-align: right;">${formatMoney(p.revenue)}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    `}
                                </div>
                                
                                <!-- Top 10 Suppliers by Sales -->
                                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                        <span style="font-size: 20px;"></span>
                                        <strong style="font-size: 15px; color: #1f2937;">Top 10 Suppliers by Sales</strong>
                                    </div>
                                    ${sortedSuppliers.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No supplier data</p>' : `
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        ${sortedSuppliers.map(([id, s], i) => `
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                    <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                    <div style="overflow: hidden;">
                                                        <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${s.name.substring(0, 15)}</div>
                                                        <div style="font-size: 10px; color: #9ca3af;">${s.qty} units</div>
                                                    </div>
                                                </div>
                                                <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                    <div style="height: 100%; width: ${(s.sales / maxSupplierSales * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                        <span style="font-size: 10px; font-weight: 600; color: white;">${s.qty}</span>
                                                    </div>
                                                </div>
                                                <div style="font-weight: 600; font-size: 12px; color: #1f2937; width: 65px; text-align: right;">${formatMoney(s.sales)}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    `}
                                </div>
                                
                                <!-- Top 10 Customers by Sales -->
                                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                        <span style="font-size: 20px;"></span>
                                        <strong style="font-size: 15px; color: #1f2937;">Top 10 Customers by Sales</strong>
                                    </div>
                                    ${sortedCustomers.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No customer data</p>' : `
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        ${sortedCustomers.map(([id, c], i) => `
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                    <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                    <div style="overflow: hidden;">
                                                        <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.name.substring(0, 15)}</div>
                                                        <div style="font-size: 10px; color: #9ca3af;">${c.qty} units</div>
                                                    </div>
                                                </div>
                                                <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                    <div style="height: 100%; width: ${(c.sales / maxCustomerSales * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                        <span style="font-size: 10px; font-weight: 600; color: white;">${c.qty}</span>
                                                    </div>
                                                </div>
                                                <div style="font-weight: 600; font-size: 12px; color: #1f2937; width: 65px; text-align: right;">${formatMoney(c.sales)}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    `}
                                </div>
                            </div>
                            
                            <!-- Section Header: By Margin -->
                            <div style="margin-top: 20px; margin-bottom: 10px; padding: 8px 12px; background: linear-gradient(135deg, #e8f5e8 0%, #d0e8d4 100%); border-radius: 8px; border-left: 4px solid #5a8a6d;">
                                <strong style="color: #4a7a5d; font-size: 14px;"> Top 10 by Margin</strong>
                            </div>
                            
                            <!-- Second Row: Top 10 by Margin - Items + Suppliers -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                <!-- Top 10 Items by Margin -->
                                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                        <span style="font-size: 20px;"></span>
                                        <strong style="font-size: 15px; color: #1f2937;">Top 10 Items by Margin</strong>
                                    </div>
                                    ${topItemsByMargin.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No qualifying items</p>' : `
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        ${topItemsByMargin.map((p, i) => `
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                    <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                    <div style="overflow: hidden;">
                                                        <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.description.substring(0, 15)}</div>
                                                        <div style="font-size: 10px; color: #9ca3af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${formatMoney(p.revenue)} sales</div>
                                                    </div>
                                                </div>
                                                <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                    <div style="height: 100%; width: ${(p.margin / maxItemMargin * 100).toFixed(0)}%; background: ${p.margin >= 30 ? '#5a8a6d' : p.margin >= 15 ? '#b8a86b' : '#b88a8a'}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                        <span style="font-size: 10px; font-weight: 600; color: white;">${p.margin.toFixed(1)}%</span>
                                                    </div>
                                                </div>
                                                <div style="font-weight: 600; font-size: 12px; color: #5a8a6d; width: 65px; text-align: right;">${formatMoney(p.totalProfit)}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    `}
                                </div>
                                
                                <!-- Top 10 Suppliers by Margin -->
                                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                        <span style="font-size: 20px;"></span>
                                        <strong style="font-size: 15px; color: #1f2937;">Top 10 Suppliers by Margin</strong>
                                    </div>
                                    ${topSuppliersByMargin.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No qualifying suppliers</p>' : `
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        ${topSuppliersByMargin.map((s, i) => `
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                    <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                    <div style="overflow: hidden;">
                                                        <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${s.name.substring(0, 15)}</div>
                                                        <div style="font-size: 10px; color: #9ca3af;">${formatMoney(s.sales)} sales</div>
                                                    </div>
                                                </div>
                                                <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                    <div style="height: 100%; width: ${(s.margin / maxSupplierMargin * 100).toFixed(0)}%; background: ${s.margin >= 30 ? '#5a8a6d' : s.margin >= 15 ? '#b8a86b' : '#b88a8a'}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                        <span style="font-size: 10px; font-weight: 600; color: white;">${s.margin.toFixed(1)}%</span>
                                                    </div>
                                                </div>
                                                <div style="font-weight: 600; font-size: 12px; color: #5a8a6d; width: 65px; text-align: right;">${formatMoney(s.profit)}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    `}
                                </div>
                                
                                <!-- Top 10 Customers by Margin -->
                                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                        <span style="font-size: 20px;"></span>
                                        <strong style="font-size: 15px; color: #1f2937;">Top 10 Customers by Margin</strong>
                                    </div>
                                    ${topCustomersByMargin.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No qualifying customers</p>' : `
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        ${topCustomersByMargin.map((c, i) => `
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                    <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                    <div style="overflow: hidden;">
                                                        <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.name.substring(0, 15)}</div>
                                                        <div style="font-size: 10px; color: #9ca3af;">${formatMoney(c.sales)} sales</div>
                                                    </div>
                                                </div>
                                                <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                    <div style="height: 100%; width: ${(c.margin / maxCustomerMargin * 100).toFixed(0)}%; background: ${c.margin >= 30 ? '#5a8a6d' : c.margin >= 15 ? '#b8a86b' : '#b88a8a'}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                        <span style="font-size: 10px; font-weight: 600; color: white;">${c.margin.toFixed(1)}%</span>
                                                    </div>
                                                </div>
                                                <div style="font-weight: 600; font-size: 12px; color: #5a8a6d; width: 65px; text-align: right;">${formatMoney(c.profit)}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Quick Stats Section (collapsible)
                html += `
                    <div style="margin-bottom: 20px;">
                        <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                             style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                            <span class="toggle-icon"></span>
                            <strong> Quick Stats</strong>
                            <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                        </div>
                        <div style="display: block; margin-top: 15px;">
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; max-width: 500px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Quick Stats</strong>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Total Revenue</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${formatMoney(totalRevenue)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Total Cost</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${formatMoney(totalCost)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> List Price Total</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #b8a86b;">${formatMoney(totalListPrice)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Discounts Given</span>
                                        <span style="font-size: 14px; font-weight: 600; color: ${totalDiscount > 0 ? '#b88a8a' : '#9ca3af'};">${totalDiscount > 0 ? formatMoney(totalDiscount) : '-'}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Gross Profit</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #10b981;">${formatMoney(totalProfit)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Profit Margin</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${avgMargin.toFixed(1)}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Items Sold</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${sorted.length}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Total Units</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${totalUnits.toLocaleString()}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-size: 13px; color: #4b5563;"> Suppliers</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${Object.keys(bySupplier).length}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                        <span style="font-size: 13px; color: #4b5563;"> Customers</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${Object.keys(byCustomer).length}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Detail Table Section (collapsible)
                html += `
                    <div>
                        <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                             style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                            <span class="toggle-icon"></span>
                            <strong> Detail Table</strong>
                            <span style="color: #666; font-size: 12px;">(${sorted.length} items - click to hide/show)</span>
                        </div>
                        <div style="margin-top: 15px;">
                            <div style="overflow-x: auto;"><table class="data-table">
                                <thead><tr>
                                    <th>SKU</th>
                                    <th>Item</th>
                                    <th>Supplier</th>
                                    <th style="text-align: right;">Units Sold</th>
                                    <th style="text-align: center;"> Stock</th>
                                    <th style="text-align: center;">Status</th>
                                    <th style="text-align: right;">Revenue</th>
                                    <th style="text-align: right;">Discount</th>
                                    <th style="text-align: right;">Cost</th>
                                    <th style="text-align: right;">Profit</th>
                                    <th style="text-align: right;">Margin %</th>
                                </tr></thead>
                                <tbody>`;
                
                let tableTotalDiscount = 0;
                sorted.forEach(item => {
                    let stockIcon = '';
                    if (item.qtyOnHand <= 0) {
                        stockIcon = '';
                    } else if (item.qtyOnHand <= item.reorderPoint) {
                        stockIcon = '';
                    } else {
                        stockIcon = '';
                    }
                    tableTotalDiscount += item.discount;
                    const hasDiscount = item.discount > 0.01;
                    
                    html += `<tr>
                        <td><strong>${item.sku}</strong></td>
                        <td>${item.description}</td>
                        <td>${item.supplierName}</td>
                        <td style="text-align: right;"><strong>${item.unitsSold.toLocaleString()}</strong></td>
                        <td style="text-align: center;">${item.qtyOnHand}</td>
                        <td style="text-align: center; font-size: 16px;">${stockIcon}</td>
                        <td style="text-align: right;">${formatMoney(item.revenue)}</td>
                        <td style="text-align: right; color: ${hasDiscount ? '#b88a8a' : '#999'}; font-weight: ${hasDiscount ? '600' : 'normal'};">${hasDiscount ? formatMoney(item.discount) : '-'}</td>
                        <td style="text-align: right; color: #b8a86b;">${formatMoney(item.cost)}</td>
                        <td style="text-align: right; color: ${item.totalProfit >= 0 ? '#6b9a8d' : '#b88a8a'};">${formatMoney(item.totalProfit)}</td>
                        <td style="text-align: right; font-weight: bold;">${item.marginPercent.toFixed(1)}%</td>
                    </tr>`;
                });
                
                html += `</tbody>
                    <tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                        <td colspan="6">TOTAL</td>
                        <td style="text-align: right;">${formatMoney(totalRevenue)}</td>
                        <td style="text-align: right; color: ${tableTotalDiscount > 0.01 ? '#b88a8a' : '#999'};">${tableTotalDiscount > 0.01 ? formatMoney(tableTotalDiscount) : '-'}</td>
                        <td style="text-align: right; color: #b8a86b;">${formatMoney(totalCost)}</td>
                        <td style="text-align: right; color: ${totalProfit >= 0 ? '#6b9a8d' : '#b88a8a'};">${formatMoney(totalProfit)}</td>
                        <td style="text-align: right;">${avgMargin.toFixed(1)}%</td>
                    </tr></tfoot>
                </table></div>
                        </div>
                    </div>
                `;
                
                // Sales Order Detail Section (collapsible) - Grouped by Item, showing invoices under each item
                // Build data grouped by item with their sales order details
                const itemSalesData = {};
                for (const so of sales) {
                    const lines = getSalesLinesFromCache(so.SO_ID);
                    lines.forEach(line => {
                        // Apply item filter if specified
                        if (reportFilters.item && !matchesFilter(line.Item_ID, reportFilters.item)) {
                            return;
                        }
                        
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const itemId = line.Item_ID;
                        const qty = parseInt(line.Quantity) || 0;
                        const unitPrice = parseFloat(line.Unit_Price) || 0;
                        const lineTotal = qty * unitPrice;
                        
                        // Use stored Unit_Cost if available, fall back to current item cost
                        let unitCost;
                        const storedUnitCost = parseFloat(line.Unit_Cost);
                        if (!isNaN(storedUnitCost) && storedUnitCost > 0) {
                            unitCost = storedUnitCost;
                        } else {
                            const unitsPerPkg = parseFloat(item?.Units_Per_Package) || 1;
                            const pkgCost = parseFloat(item?.Package_Cost) || 0;
                            unitCost = pkgCost / unitsPerPkg;
                        }
                        
                        const lineCost = qty * unitCost;
                        const lineProfit = lineTotal - lineCost;
                        const lineMargin = lineTotal > 0 ? (lineProfit / lineTotal * 100) : 0;
                        const listPrice = parseFloat(item?.Unit_Sell_Price) || 0;
                        const listTotal = qty * listPrice;
                        const lineDiscount = listTotal - lineTotal;
                        
                        const customer = cachedCustomers.find(c => c.Customer_ID === so.Customer_ID);
                        const custCity = customer?.City || '';
                        const custState = customer?.State || '';
                        const custLocation = [custCity, custState].filter(Boolean).join(', ');
                        
                        if (!itemSalesData[itemId]) {
                            itemSalesData[itemId] = {
                                itemId,
                                sku: item?.SKU || '-',
                                name: item?.Item_Description || itemId,
                                supplierName: suppliers.find(s => s.Supplier_ID === item?.Supplier_ID)?.Supplier_Name || '-',
                                totalQty: 0,
                                totalRevenue: 0,
                                totalDiscount: 0,
                                totalCost: 0,
                                totalProfit: 0,
                                invoices: []
                            };
                        }
                        
                        itemSalesData[itemId].totalQty += qty;
                        itemSalesData[itemId].totalRevenue += lineTotal;
                        itemSalesData[itemId].totalDiscount += lineDiscount > 0 ? lineDiscount : 0;
                        itemSalesData[itemId].totalCost += lineCost;
                        itemSalesData[itemId].totalProfit += lineProfit;
                        
                        itemSalesData[itemId].invoices.push({
                            invoiceNum: so.Invoice_Number || so.SO_Number || so.SO_ID,
                            date: so.Sale_Date || so.SO_Date,
                            customerName: customer?.Customer_Name || so.Customer_ID,
                            custLocation,
                            paymentStatus: so.Payment_Status || 'Unpaid',
                            orderStatus: so.Status || 'Pending',
                            qty,
                            unitPrice,
                            lineTotal,
                            lineDiscount,
                            lineCost,
                            lineProfit,
                            lineMargin
                        });
                    });
                }
                
                // Sort items by total revenue (highest first)
                const sortedItemSales = Object.values(itemSalesData).sort((a, b) => b.totalRevenue - a.totalRevenue);
                
                // Sort invoices within each item by date (newest first)
                sortedItemSales.forEach(item => {
                    item.invoices.sort((a, b) => new Date(b.date) - new Date(a.date));
                    item.margin = item.totalRevenue > 0 ? (item.totalProfit / item.totalRevenue * 100) : 0;
                });
                
                // Calculate grand totals
                let itemGrandQty = 0, itemGrandRevenue = 0, itemGrandDiscount = 0, itemGrandCost = 0, itemGrandProfit = 0;
                sortedItemSales.forEach(item => {
                    itemGrandQty += item.totalQty;
                    itemGrandRevenue += item.totalRevenue;
                    itemGrandDiscount += item.totalDiscount;
                    itemGrandCost += item.totalCost;
                    itemGrandProfit += item.totalProfit;
                });
                const itemGrandMargin = itemGrandRevenue > 0 ? (itemGrandProfit / itemGrandRevenue * 100) : 0;
                
                // Count total invoices
                const totalInvoiceCount = sortedItemSales.reduce((sum, item) => sum + item.invoices.length, 0);
                
                const itemDetailTableId = 'salesByItemDetailTable_' + Date.now();
                
                html += `
                    <div style="margin-top: 20px;">
                        <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                             style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                            <span class="toggle-icon"></span>
                            <strong> Sales by Item Detail</strong>
                            <span style="color: #666; font-size: 12px;">(${sortedItemSales.length} items, ${totalInvoiceCount} invoice lines - click to hide/show)</span>
                        </div>
                        <div style="display: block; margin-top: 15px;">
                            <div style="overflow-x: auto;"><table id="${itemDetailTableId}" class="data-table">
                                <thead><tr>
                                    <th>Item / Invoice</th>
                                    <th>SKU / Date</th>
                                    <th>Supplier / Customer</th>
                                    <th style="text-align: center;">Qty</th>
                                    <th style="text-align: right;">Unit Price</th>
                                    <th style="text-align: right;">Revenue</th>
                                    <th style="text-align: right;">Discount</th>
                                    <th style="text-align: right;">Cost</th>
                                    <th style="text-align: right;">Profit</th>
                                    <th style="text-align: right;">Margin</th>
                                    <th>Status</th>
                                </tr></thead>
                                <tbody>`;
                
                sortedItemSales.forEach(item => {
                    const hasItemDiscount = item.totalDiscount > 0.01;
                    // Item Header Row
                    html += `<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); font-weight: 600;">
                        <td>
                            <span style="color: #667eea; font-weight: bold;">${item.name}</span>
                        </td>
                        <td style="color: #6b7280;">${item.sku}</td>
                        <td style="color: #888;">${item.supplierName}</td>
                        <td style="text-align: center; font-weight: bold;">${item.totalQty}</td>
                        <td></td>
                        <td style="text-align: right; color: #667eea;">${formatMoney(item.totalRevenue)}</td>
                        <td style="text-align: right; color: ${hasItemDiscount ? '#b88a8a' : '#999'};">${hasItemDiscount ? formatMoney(item.totalDiscount) : '-'}</td>
                        <td style="text-align: right; color: #6b7280;">${formatMoney(item.totalCost)}</td>
                        <td style="text-align: right; color: ${item.totalProfit >= 0 ? '#6b9a8d' : '#b88a8a'};">${formatMoney(item.totalProfit)}</td>
                        <td style="text-align: right; color: ${item.margin >= 20 ? '#6b9a8d' : item.margin >= 10 ? '#b8a86b' : '#b88a8a'};">${item.margin.toFixed(1)}%</td>
                        <td><span style="background: #7a9bb8; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${item.invoices.length} orders</span></td>
                    </tr>`;
                    
                    // Invoice Lines for this item
                    item.invoices.forEach(inv => {
                        const formattedDate = formatDateSafe(inv.date);
                        const paymentColor = inv.paymentStatus === 'Paid' ? '#6b9a8d' : inv.paymentStatus === 'Partial' ? '#b8a86b' : '#b88a8a';
                        const hasInvDiscount = inv.lineDiscount > 0.01;
                        
                        html += `<tr style="font-size: 13px;">
                            <td style="padding-left: 30px; color: #6b7280;"> <span style="color: #667eea;">${inv.invoiceNum}</span></td>
                            <td style="color: #6b7280; font-size: 12px;">${formattedDate}</td>
                            <td>
                                <div style="font-size: 13px;">${inv.customerName}</div>
                                <div style="font-size: 11px; color: #888;">${inv.custLocation || '-'}</div>
                            </td>
                            <td style="text-align: center;">${inv.qty}</td>
                            <td style="text-align: right;">${formatMoney(inv.unitPrice)}</td>
                            <td style="text-align: right;">${formatMoney(inv.lineTotal)}</td>
                            <td style="text-align: right; color: ${hasInvDiscount ? '#b88a8a' : '#999'};">${hasInvDiscount ? formatMoney(inv.lineDiscount) : '-'}</td>
                            <td style="text-align: right; color: #6b7280;">${formatMoney(inv.lineCost)}</td>
                            <td style="text-align: right; color: ${inv.lineProfit >= 0 ? '#6b9a8d' : '#b88a8a'};">${formatMoney(inv.lineProfit)}</td>
                            <td style="text-align: right; color: ${inv.lineMargin >= 20 ? '#6b9a8d' : inv.lineMargin >= 10 ? '#b8a86b' : '#b88a8a'};">${inv.lineMargin.toFixed(1)}%</td>
                            <td><span style="background: ${paymentColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">${inv.paymentStatus}</span></td>
                        </tr>`;
                    });
                });
                
                const hasGrandItemDiscount = itemGrandDiscount > 0.01;
                html += `</tbody>
                    <tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                        <td colspan="3">GRAND TOTAL</td>
                        <td style="text-align: center;">${itemGrandQty}</td>
                        <td></td>
                        <td style="text-align: right;">${formatMoney(itemGrandRevenue)}</td>
                        <td style="text-align: right; color: ${hasGrandItemDiscount ? '#b88a8a' : '#999'};">${hasGrandItemDiscount ? formatMoney(itemGrandDiscount) : '-'}</td>
                        <td style="text-align: right;">${formatMoney(itemGrandCost)}</td>
                        <td style="text-align: right; color: ${itemGrandProfit >= 0 ? '#6b9a8d' : '#b88a8a'};">${formatMoney(itemGrandProfit)}</td>
                        <td style="text-align: right; color: ${itemGrandMargin >= 20 ? '#6b9a8d' : itemGrandMargin >= 10 ? '#b8a86b' : '#b88a8a'};">${itemGrandMargin.toFixed(1)}%</td>
                        <td></td>
                    </tr></tfoot>
                </table></div>
                        </div>
                    </div>
                `;
                
                // Chart.js initialization for Sales Trend
                html += `
                    <scr` + `ipt>
                        setTimeout(() => {
                            // Make Sales by Item Detail table sortable
                            if (typeof makeSortable === 'function') {
                                makeSortable('${itemDetailTableId}');
                            }
                            
                            // Sales Trend Line Chart
                            const ctx = document.getElementById('${trendChartId}');
                            if (ctx) {
                                if(Chart.getChart(ctx))Chart.getChart(ctx).destroy(); new Chart(ctx, {
                                    type: 'line',
                                    data: {
                                        labels: [${sortedDates.map(([date]) => `'${date.substring(5)}'`).join(', ')}],
                                        datasets: [{
                                            label: 'Daily Sales',
                                            data: [${sortedDates.map(([, amt]) => amt.toFixed(2)).join(', ')}],
                                            borderColor: '#10b981',
                                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                            fill: true,
                                            tension: 0.3,
                                            pointRadius: 4,
                                            pointHoverRadius: 6
                                        }]
                                    },
                                    options: {
                                        responsive: false,
                                        animation: false,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: { display: false },
                                            tooltip: {
                                                callbacks: {
                                                    label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                                }
                                            }
                                        },
                                        scales: {
                                            y: {
                                                beginAtZero: true,
                                                ticks: { callback: (val) => '$' + val.toLocaleString() }
                                            }
                                        }
                                    }
                                });
                            }
                        }, 100);
                    <` + `/script>
                `;
            }
            
            return html;
        }
        
        async function generatePurchaseOrderDetailModal() {
            // Load all report data (uses cache if available)
            await loadReportData();
            
            let purchases = [...cachedPurchaseOrders];
            const suppliers = cachedSuppliers;
            const items = cachedItems;
            
            if (!purchases.length) throw new Error('Failed to load PO data');
            
            // Helper to get supplier name
            function getSupplierName(supplierId) {
                const supplier = suppliers.find(s => s.Supplier_ID == supplierId);
                return supplier ? supplier.Supplier_Name : supplierId;
            }
            
            // Helper to get item info
            function getItemInfo(itemId) {
                const item = items.find(i => i.Item_ID == itemId);
                return item ? { name: item.Item_Description, sku: item.SKU, supplierId: item.Supplier_ID } : { name: itemId, sku: '', supplierId: '' };
            }
            
            // Helper function to parse dates in various formats
            function parseFlexibleDate(dateVal) {
                if (!dateVal) return null;
                if (dateVal instanceof Date) return dateVal;
                const dateStr = String(dateVal).trim();
                if (!dateStr) return null;
                let parsed = new Date(dateStr);
                if (!isNaN(parsed.getTime())) return parsed;
                const usMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (usMatch) {
                    return new Date(parseInt(usMatch[3]), parseInt(usMatch[1]) - 1, parseInt(usMatch[2]));
                }
                return null;
            }
            
            // Apply date filters
            if (reportFilters.fromDate) {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                fromDate.setHours(0, 0, 0, 0);
                purchases = purchases.filter(p => {
                    const poDate = parseFlexibleDate(p.PO_Date);
                    return poDate && poDate >= fromDate;
                });
            }
            if (reportFilters.toDate) {
                const toDate = parseLocalDate(reportFilters.toDate);
                toDate.setHours(23, 59, 59, 999);
                purchases = purchases.filter(p => {
                    const poDate = parseFlexibleDate(p.PO_Date);
                    return poDate && poDate <= toDate;
                });
            }
            if (reportFilters.supplier) {
                purchases = purchases.filter(p => matchesFilter(p.Supplier_ID, reportFilters.supplier));
            }
            if (reportFilters.paymentStatus) {
                purchases = purchases.filter(p => p.Payment_Status === reportFilters.paymentStatus);
            }
            
            // Filter by PO Invoice(s)
            if (reportFilters.purchaseInvoice) {
                const selectedPOs = reportFilters.purchaseInvoice.split(',').filter(v => v);
                if (selectedPOs.length > 0) {
                    purchases = purchases.filter(p => {
                        const poNum = p.PO_Number || p.Invoice_Number || p.PO_ID;
                        return selectedPOs.includes(poNum);
                    });
                }
            }
            
            // Filter by PO Type
            if (reportFilters.poType) {
                purchases = purchases.filter(p => (p.PO_Type || 'INCOMING') === reportFilters.poType);
            }
            
            // Apply transaction status filter
            const statusFilter = reportFilters.transactionStatus || 'exclude-voided';
            if (statusFilter === 'exclude-voided') {
                purchases = purchases.filter(p => p.Status !== 'Voided');
            } else if (statusFilter && statusFilter !== '') {
                purchases = purchases.filter(p => p.Status === statusFilter);
            }
            
            // If item filter is specified, filter purchases to only those containing the item(s)
            if (reportFilters.item) {
                purchases = purchases.filter(po => {
                    const lines = getPurchaseLinesFromCache(po.PO_ID);
                    return lines.some(line => matchesFilter(line.Item_ID, reportFilters.item));
                });
            }
            
            // Collect all PO lines and apply item filter
            const byDate = {};
            const byProduct = {};
            const bySupplier = {};
            let allFilteredLines = [];
            
            for (const po of purchases) {
                const lines = getPurchaseLinesFromCache(po.PO_ID);
                const poDate = parseFlexibleDate(po.PO_Date);
                
                lines.forEach(line => {
                    const itemId = line.Item_ID;
                    
                    // Apply item filter if specified
                    if (reportFilters.item && !matchesFilter(itemId, reportFilters.item)) {
                        return; // Skip this line
                    }
                    
                    const itemInfo = getItemInfo(itemId);
                    const rawQty = parseInt(line.Quantity) || 0;
                    const unitCost = parseFloat(line.Unit_Cost) || 0;
                    const lineTotal = rawQty * unitCost;
                    
                    // Detect eaches and convert to fractional cases (same logic as detail table)
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    const packageCost = parseFloat(item?.Package_Cost) || 0;
                    const unitsPerPackage = parseFloat(item?.Units_Per_Package) || 1;
                    
                    // Check for stored Is_Eaches flag first, then fall back to detection
                    let isEaches = false;
                    if (line.Is_Eaches !== undefined && line.Is_Eaches !== null && line.Is_Eaches !== '') {
                        isEaches = line.Is_Eaches === true || line.Is_Eaches === 'true';
                    } else {
                        isEaches = packageCost > 0 && unitCost < (packageCost * 0.5);
                    }
                    
                    // Convert eaches to fractional cases
                    let qty = rawQty;
                    if (isEaches && unitsPerPackage > 1) {
                        qty = Math.round((rawQty / unitsPerPackage) * 10000) / 10000;
                    }
                    
                    // Add to filtered lines for detail table
                    allFilteredLines.push({
                        ...line,
                        PO_Number: po.PO_Number || po.Invoice_Number,
                        PO_Date: po.PO_Date,
                        PO_ID: po.PO_ID,
                        Supplier_ID: po.Supplier_ID,
                        PO_Type: po.PO_Type,
                        Status: po.Status,
                        itemName: itemInfo.name,
                        lineTotal: lineTotal
                    });
                    
                    // Group by date for trend chart
                    if (poDate && !isNaN(poDate.getTime())) {
                        const dateKey = poDate.toISOString().split('T')[0];
                        if (!byDate[dateKey]) byDate[dateKey] = 0;
                        byDate[dateKey] += lineTotal;
                    }
                    
                    // Group by product
                    if (!byProduct[itemId]) {
                        byProduct[itemId] = { 
                            name: itemInfo.name, 
                            sku: itemInfo.sku,
                            supplierId: itemInfo.supplierId,
                            purchases: 0, 
                            qty: 0 
                        };
                    }
                    byProduct[itemId].purchases += lineTotal;
                    byProduct[itemId].qty += qty;
                    
                    // Group by supplier
                    const supplierId = po.Supplier_ID;
                    const supplierName = getSupplierName(supplierId);
                    if (!bySupplier[supplierId]) {
                        bySupplier[supplierId] = { name: supplierName, purchases: 0, qty: 0, orderCount: 0 };
                    }
                    bySupplier[supplierId].purchases += lineTotal;
                    bySupplier[supplierId].qty += qty;
                });
            }
            
            // Count orders per supplier (unique POs)
            const supplierOrders = {};
            purchases.forEach(po => {
                const suppId = po.Supplier_ID;
                if (!supplierOrders[suppId]) supplierOrders[suppId] = new Set();
                supplierOrders[suppId].add(po.PO_ID);
            });
            Object.keys(bySupplier).forEach(suppId => {
                bySupplier[suppId].orderCount = supplierOrders[suppId]?.size || 0;
            });
            
            // Sort dates for trend chart
            const sortedDates = Object.entries(byDate).sort((a, b) => a[0].localeCompare(b[0]));
            
            // Calculate totals
            const totalPurchases = Object.values(byProduct).reduce((sum, p) => sum + p.purchases, 0);
            const totalQty = Object.values(byProduct).reduce((sum, p) => sum + p.qty, 0);
            const totalOrders = purchases.length;
            const avgOrderValue = totalOrders > 0 ? totalPurchases / totalOrders : 0;
            
            // Status counts
            let receivedCount = 0, pendingCount = 0;
            purchases.forEach(p => {
                if (p.Status === 'Received') receivedCount++;
                else if (p.Status !== 'Voided') pendingCount++;
            });
            
            // Top 10 Items by Purchases
            const top10ItemsByPurchases = Object.entries(byProduct)
                .sort((a, b) => b[1].purchases - a[1].purchases)
                .slice(0, 10);
            const maxItemPurchases = top10ItemsByPurchases.length > 0 ? Math.max(...top10ItemsByPurchases.map(([, p]) => p.purchases)) : 0;
            
            // Top 10 Suppliers by Purchases
            const top10SuppliersByPurchases = Object.entries(bySupplier)
                .sort((a, b) => b[1].purchases - a[1].purchases)
                .slice(0, 10);
            const maxSupplierPurchases = top10SuppliersByPurchases.length > 0 ? Math.max(...top10SuppliersByPurchases.map(([, s]) => s.purchases)) : 0;
            
            // Top 10 Items by Quantity
            const top10ItemsByQty = Object.entries(byProduct)
                .sort((a, b) => b[1].qty - a[1].qty)
                .slice(0, 10);
            const maxItemQty = top10ItemsByQty.length > 0 ? Math.max(...top10ItemsByQty.map(([, p]) => p.qty)) : 0;
            
            // Top 10 Suppliers by Quantity
            const top10SuppliersByQty = Object.entries(bySupplier)
                .sort((a, b) => b[1].qty - a[1].qty)
                .slice(0, 10);
            const maxSupplierQty = top10SuppliersByQty.length > 0 ? Math.max(...top10SuppliersByQty.map(([, s]) => s.qty)) : 0;
            
            // Show PO type filter in header
            const poTypeLabel = reportFilters.poType === 'INCOMING' ? ' Received Only' : 
                               reportFilters.poType === 'OUTGOING' ? ' On Order Only' : ' All Types';
            
            // Build inline filter summary for oval header
            const filterSummaryInline = generateFilterSummary({ inline: true });
            
            // Count by type (Incoming vs Outgoing)
            let incomingCount = 0, outgoingCount = 0;
            purchases.forEach(p => {
                const poType = p.PO_Type || 'INCOMING';
                if (poType === 'OUTGOING') outgoingCount++;
                else incomingCount++;
            });
            
            // Chart IDs
            const trendChartId = 'poDetailTrendChart_' + Date.now();
            const statusPieChartId = 'poDetailStatusPie_' + Date.now();
            const typePieChartId = 'poDetailTypePie_' + Date.now();
            const barColors = ['#7a9bb8', '#9a8ab8', '#7aaab8', '#6b9a8d', '#b8a86b', '#a8a8a8', '#8ab89a', '#b8887a', '#8a8ab8', '#b8b87a'];
            
            let html = `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Purchase Order Detail</h2>
                    <p style="margin: 0 0 ${filterSummaryInline ? '10px' : '0'} 0; font-size: 14px; opacity: 0.95;">${purchases.length} orders | ${Object.keys(byProduct).length} products | ${poTypeLabel}</p>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px;">${filterSummaryInline}</div>` : ''}
                </div>`;
            
            // KPI Summary Cards
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #7a9bb8;">
                        <div style="font-size: 11px; color: #5a7a8a; margin-bottom: 5px;"> Total Purchases</div>
                        <div style="font-size: 20px; font-weight: bold; color: #7a9bb8;">${formatMoney(totalPurchases)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #6b9a8d;">
                        <div style="font-size: 11px; color: #5a7a6d; margin-bottom: 5px;"> Total Units</div>
                        <div style="font-size: 20px; font-weight: bold; color: #6b9a8d;">${totalQty % 1 === 0 ? totalQty.toLocaleString() : totalQty.toFixed(2)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b8a86b;">
                        <div style="font-size: 11px; color: #8a7a4a; margin-bottom: 5px;"> Orders</div>
                        <div style="font-size: 20px; font-weight: bold; color: #b8a86b;">${totalOrders}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f0e8f0 0%, #e4d8e8 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9a8ab8;">
                        <div style="font-size: 11px; color: #7a6a8a; margin-bottom: 5px;"> Avg Order</div>
                        <div style="font-size: 20px; font-weight: bold; color: #9a8ab8;">${formatMoney(avgOrderValue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5f5 0%, #d4efef 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #5a9a9a;">
                        <div style="font-size: 11px; color: #4a7a7a; margin-bottom: 5px;"> Received/Pending</div>
                        <div style="font-size: 20px; font-weight: bold; color: #5a9a9a;">${receivedCount} / ${pendingCount}</div>
                    </div>
                </div>
            `;
            
            // Charts Section - Dashboard Style
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts & Top 10</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: block;">
                        <!-- Purchase Trend Chart - Full Width -->
                        <div style="margin-top: 15px; margin-bottom: 15px;">
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Purchase Trend</strong>
                                </div>
                                <canvas id="${trendChartId}" class="print-chart" height="180"></canvas>
                            </div>
                        </div>
                        
                        <!-- Order Status and Type Pie Charts -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Order Status</strong>
                                </div>
                                <canvas id="${statusPieChartId}" class="print-chart" height="200"></canvas>
                            </div>
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Order Type</strong>
                                </div>
                                <canvas id="${typePieChartId}" class="print-chart" height="200"></canvas>
                            </div>
                        </div>
                        
                        <!-- Section Header: Top 10 by Purchases -->
                        <div style="margin-bottom: 10px; padding: 8px 12px; background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); border-radius: 8px; border-left: 4px solid #7a9bb8;">
                            <strong style="color: #5a7a8a; font-size: 14px;"> Top 10 by Purchases</strong>
                        </div>
                        
                        <!-- Top 10 by Purchases Row -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <!-- Top 10 Items by Purchases -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Top 10 Items by Purchases</strong>
                                </div>
                                ${top10ItemsByPurchases.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No purchase data</p>' : `
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${top10ItemsByPurchases.map(([id, p], i) => `
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                <div style="overflow: hidden;">
                                                    <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.name.substring(0, 15)}</div>
                                                    <div style="font-size: 10px; color: #9ca3af;">${p.qty} units</div>
                                                </div>
                                            </div>
                                            <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                <div style="height: 100%; width: ${(p.purchases / maxItemPurchases * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                    <span style="font-size: 10px; font-weight: 600; color: white;">${p.qty}</span>
                                                </div>
                                            </div>
                                            <div style="font-weight: 600; font-size: 12px; color: #1f2937; width: 65px; text-align: right;">${formatMoney(p.purchases)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                `}
                            </div>
                            
                            <!-- Top 10 Suppliers by Purchases -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Top 10 Suppliers by Purchases</strong>
                                </div>
                                ${top10SuppliersByPurchases.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No supplier data</p>' : `
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${top10SuppliersByPurchases.map(([id, s], i) => `
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                <div style="overflow: hidden;">
                                                    <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${s.name.substring(0, 15)}</div>
                                                    <div style="font-size: 10px; color: #9ca3af;">${s.orderCount} orders</div>
                                                </div>
                                            </div>
                                            <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                <div style="height: 100%; width: ${(s.purchases / maxSupplierPurchases * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                    <span style="font-size: 10px; font-weight: 600; color: white;">${s.orderCount}</span>
                                                </div>
                                            </div>
                                            <div style="font-weight: 600; font-size: 12px; color: #1f2937; width: 65px; text-align: right;">${formatMoney(s.purchases)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                `}
                            </div>
                        </div>
                        
                        <!-- Section Header: Top 10 by Quantity -->
                        <div style="margin-top: 20px; margin-bottom: 10px; padding: 8px 12px; background: linear-gradient(135deg, #e8f5e8 0%, #d0e8d4 100%); border-radius: 8px; border-left: 4px solid #5a8a6d;">
                            <strong style="color: #4a7a5d; font-size: 14px;"> Top 10 by Quantity</strong>
                        </div>
                        
                        <!-- Top 10 by Quantity Row -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <!-- Top 10 Items by Quantity -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Top 10 Items by Quantity</strong>
                                </div>
                                ${top10ItemsByQty.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No quantity data</p>' : `
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${top10ItemsByQty.map(([id, p], i) => `
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                <div style="overflow: hidden;">
                                                    <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.name.substring(0, 15)}</div>
                                                    <div style="font-size: 10px; color: #9ca3af;">${formatMoney(p.purchases)}</div>
                                                </div>
                                            </div>
                                            <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                <div style="height: 100%; width: ${(p.qty / maxItemQty * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                    <span style="font-size: 10px; font-weight: 600; color: white;">${p.qty}</span>
                                                </div>
                                            </div>
                                            <div style="font-weight: 600; font-size: 12px; color: #5a8a6d; width: 55px; text-align: right;">${p.qty} units</div>
                                        </div>
                                    `).join('')}
                                </div>
                                `}
                            </div>
                            
                            <!-- Top 10 Suppliers by Quantity -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Top 10 Suppliers by Quantity</strong>
                                </div>
                                ${top10SuppliersByQty.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No supplier data</p>' : `
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${top10SuppliersByQty.map(([id, s], i) => `
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                <div style="overflow: hidden;">
                                                    <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${s.name.substring(0, 15)}</div>
                                                    <div style="font-size: 10px; color: #9ca3af;">${formatMoney(s.purchases)}</div>
                                                </div>
                                            </div>
                                            <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                <div style="height: 100%; width: ${(s.qty / maxSupplierQty * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                    <span style="font-size: 10px; font-weight: 600; color: white;">${s.qty}</span>
                                                </div>
                                            </div>
                                            <div style="font-weight: 600; font-size: 12px; color: #5a8a6d; width: 55px; text-align: right;">${s.qty} units</div>
                                        </div>
                                    `).join('')}
                                </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Quick Stats Section (collapsible)
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Quick Stats</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: block; margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; max-width: 500px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                <span style="font-size: 20px;"></span>
                                <strong style="font-size: 15px; color: #1f2937;">Quick Stats</strong>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Total Purchases</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${formatMoney(totalPurchases)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Total Units</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${totalQty % 1 === 0 ? totalQty.toLocaleString() : totalQty.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Total Orders</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${totalOrders}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Avg Order Value</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${formatMoney(avgOrderValue)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Received Orders</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #6b9a8d;">${receivedCount}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Pending Orders</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #b8a86b;">${pendingCount}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Suppliers</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${Object.keys(bySupplier).length}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                    <span style="font-size: 13px; color: #4b5563;"> Products</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${Object.keys(byProduct).length}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Detail Table Section (collapsible) - Show Line Items
            html += `
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Detail Table</strong>
                        <span style="color: #666; font-size: 12px;">(${purchases.length} orders - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
            `;
            
            html += `<div style="overflow-x: auto;"><table class="data-table">
                <thead><tr>
                    <th>PO # / Item</th>
                    <th>Date / SKU</th>
                    <th>Supplier / Description</th>
                    <th style="text-align: center;">Qty</th>
                    <th style="text-align: right;">Unit Cost</th>
                    <th style="text-align: right;">Line Total</th>
                    <th>Status</th>
                </tr></thead><tbody>`;
            
            let grandTotal = 0;
            let grandTotalQty = 0;
            purchases.sort((a, b) => new Date(b.PO_Date) - new Date(a.PO_Date))
                .forEach(po => {
                    const poType = po.PO_Type || 'INCOMING';
                    const typeStyle = poType === 'OUTGOING' 
                        ? 'background: #e3f2fd; color: #1565c0;' 
                        : 'background: #e8f5e9; color: #2e7d32;';
                    const statusColor = po.Status === 'Received' ? '#6b9a8d' : po.Status === 'Voided' ? '#b88a8a' : '#b8a86b';
                    
                    // Format date (mobile-safe)
                    const formattedDate = formatDateSafe(po.PO_Date) + ' ' + formatTimeSafe(po.PO_Date);
                    
                    // Get line items for this PO and calculate filtered total
                    const lines = getPurchaseLinesFromCache(po.PO_ID);
                    let poFilteredTotal = 0;
                    let poQty = 0;
                    let filteredLines = [];
                    
                    if (lines.length > 0) {
                        lines.forEach(line => {
                            // Apply item filter if specified
                            if (reportFilters.item && !matchesFilter(line.Item_ID, reportFilters.item)) {
                                return;
                            }
                            
                            const itemInfo = getItemInfo(line.Item_ID);
                            const qty = parseInt(line.Quantity) || 0;
                            const unitCost = parseFloat(line.Unit_Cost) || 0;
                            const lineTotal = qty * unitCost;
                            
                            // Check for stored values first (V22+), then fall back to detection
                            const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                            const packageCost = parseFloat(item?.Package_Cost) || 0;
                            
                            // Use stored Units_Per_Package if available
                            const storedUnitsPerPkg = parseFloat(line.Units_Per_Package);
                            const unitsPerPackage = (!isNaN(storedUnitsPerPkg) && storedUnitsPerPkg > 0) 
                                ? storedUnitsPerPkg 
                                : (parseFloat(item?.Units_Per_Package) || 1);
                            
                            // Check for stored Is_Eaches flag first, then fall back to detection
                            let isEaches = false;
                            if (line.Is_Eaches !== undefined && line.Is_Eaches !== null && line.Is_Eaches !== '') {
                                isEaches = line.Is_Eaches === true || line.Is_Eaches === 'true';
                            } else {
                                isEaches = packageCost > 0 && unitCost < (packageCost * 0.5);
                            }
                            
                            // Convert eaches to fractional cases for display
                            let displayQty = qty;
                            if (isEaches && unitsPerPackage > 1) {
                                displayQty = Math.round((qty / unitsPerPackage) * 10000) / 10000; // Round to avoid floating point errors
                            }
                            
                            poFilteredTotal += lineTotal;
                            poQty += displayQty; // Add fractional cases to total
                            filteredLines.push({ itemInfo, qty: displayQty, unitCost, lineTotal, isEaches, originalQty: qty, unitsPerPackage });
                        });
                    }
                    
                    // Add to grand total (only filtered lines)
                    grandTotal += poFilteredTotal;
                    grandTotalQty += poQty;
                    
                    // PO Header Row - show filtered total when item filter is active
                    const displayTotal = reportFilters.item ? poFilteredTotal : (parseFloat(po.Total_Amount) || 0);
                    html += `<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); font-weight: 600;">
                        <td>
                            <span style="${typeStyle} padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 6px;">${poType === 'OUTGOING' ? '' : ''}</span>
                            ${po.PO_Number || po.Invoice_Number || '-'}
                        </td>
                        <td>${formattedDate}</td>
                        <td>${getSupplierName(po.Supplier_ID)}</td>
                        <td style="text-align: center; font-weight: bold;">${poQty % 1 === 0 ? poQty : poQty.toFixed(2)}</td>
                        <td></td>
                        <td style="text-align: right; color: #667eea;">${formatMoney(displayTotal)}</td>
                        <td><span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${po.Status || '-'}</span></td>
                    </tr>`;
                    
                    // Render line items
                    if (filteredLines.length > 0) {
                        filteredLines.forEach(({ itemInfo, qty, unitCost, lineTotal, isEaches, originalQty, unitsPerPackage }) => {
                            // For eaches: show fractional cases with tooltip showing original units
                            let qtyDisplay, costDisplay;
                            if (isEaches) {
                                // Show as fractional case (e.g., 0.15) with tooltip showing "4 of 26 units"
                                qtyDisplay = `<span title="${originalQty} of ${unitsPerPackage} units" style="color: #9333ea; cursor: help;">${qty.toFixed(2)}</span>`;
                                costDisplay = `<span title="$${unitCost.toFixed(2)}/unit" style="color: #9333ea;">${formatMoney(unitCost * unitsPerPackage)}</span>`;
                            } else {
                                qtyDisplay = qty;
                                costDisplay = formatMoney(unitCost);
                            }
                            
                            html += `<tr style="font-size: 13px;">
                                <td style="padding-left: 30px; color: #6b7280;"></td>
                                <td style="color: #6b7280; font-size: 12px;">${itemInfo.sku || '-'}</td>
                                <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${itemInfo.name}">${itemInfo.name}</td>
                                <td style="text-align: center;">${qtyDisplay}</td>
                                <td style="text-align: right;">${costDisplay}</td>
                                <td style="text-align: right;">${formatMoney(lineTotal)}</td>
                                <td></td>
                            </tr>`;
                        });
                    } else if (lines.length === 0) {
                        html += `<tr style="font-size: 13px; color: #9ca3af;">
                            <td style="padding-left: 30px;"></td>
                            <td colspan="6" style="font-style: italic;">No line items</td>
                        </tr>`;
                    }
                });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="3">GRAND TOTAL</td>
                <td style="text-align: center;">${grandTotalQty % 1 === 0 ? grandTotalQty : grandTotalQty.toFixed(2)}</td>
                <td></td>
                <td style="text-align: right;">${formatMoney(grandTotal)}</td>
                <td></td>
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            
            // Chart.js initialization for Purchase Trend and Status Pie
            html += `
                <scr` + `ipt>
                    setTimeout(() => {
                        // Purchase Trend Line Chart
                        const ctx = document.getElementById('${trendChartId}');
                        if (ctx) {
                            if(Chart.getChart(ctx))Chart.getChart(ctx).destroy(); new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: [${sortedDates.map(([date]) => `'${date.substring(5)}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Daily Purchases',
                                        data: [${sortedDates.map(([, amt]) => amt.toFixed(2)).join(', ')}],
                                        borderColor: '#667eea',
                                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                        fill: true,
                                        tension: 0.3,
                                        pointRadius: 4,
                                        pointBackgroundColor: '#667eea'
                                    }]
                                },
                                options: {
                                    responsive: false,
                                    animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        y: { 
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Order Status Pie Chart
                        const ctx2 = document.getElementById('${statusPieChartId}');
                        if (ctx2) {
                            if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                type: 'doughnut',
                                data: {
                                    labels: ['Received', 'Pending'],
                                    datasets: [{
                                        data: [${receivedCount}, ${pendingCount}],
                                        backgroundColor: ['#6b9a8d', '#b8a86b'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false,
                                    animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 12 } } },
                                        datalabels: {
                                            display: true,
                                            color: '#fff',
                                            font: { weight: 'bold', size: 14 },
                                            formatter: (value, ctx) => {
                                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                                const pct = total > 0 ? ((value / total) * 100).toFixed(0) : 0;
                                                return value > 0 ? value + ' (' + pct + '%)' : '';
                                            }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Order Type Pie Chart (Incoming vs Outgoing)
                        const ctx3 = document.getElementById('${typePieChartId}');
                        if (ctx3) {
                            if(Chart.getChart(ctx3))Chart.getChart(ctx3).destroy(); new Chart(ctx3, {
                                type: 'doughnut',
                                data: {
                                    labels: [' Incoming', ' Outgoing'],
                                    datasets: [{
                                        data: [${incomingCount}, ${outgoingCount}],
                                        backgroundColor: ['#7a9bb8', '#9a8ab8'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false,
                                    animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 12 } } },
                                        datalabels: {
                                            display: true,
                                            color: '#fff',
                                            font: { weight: 'bold', size: 14 },
                                            formatter: (value, ctx) => {
                                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                                const pct = total > 0 ? ((value / total) * 100).toFixed(0) : 0;
                                                return value > 0 ? value + ' (' + pct + '%)' : '';
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        async function generatePurchaseBySupplierModal() {
            // Load all report data (uses cache if available)
            await loadReportData();
            
            let purchases = [...cachedPurchaseOrders];
            const items = cachedItems || [];
            const suppliers = cachedSuppliers || [];
            let sales = [...cachedSalesOrders];
            
            if (!purchases.length) throw new Error('Failed to load PO data');
            
            // Helper function to parse dates in various formats
            function parseFlexibleDate(dateVal) {
                if (!dateVal) return null;
                if (dateVal instanceof Date) return dateVal;
                const dateStr = String(dateVal).trim();
                if (!dateStr) return null;
                let parsed = new Date(dateStr);
                if (!isNaN(parsed.getTime())) return parsed;
                const usMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (usMatch) {
                    return new Date(parseInt(usMatch[3]), parseInt(usMatch[1]) - 1, parseInt(usMatch[2]));
                }
                return null;
            }
            
            if (reportFilters.fromDate) {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                fromDate.setHours(0, 0, 0, 0);
                purchases = purchases.filter(p => {
                    const poDate = parseFlexibleDate(p.PO_Date);
                    return poDate && poDate >= fromDate;
                });
                sales = sales.filter(s => {
                    const soDate = parseFlexibleDate(s.Sale_Date || s.SO_Date);
                    return soDate && soDate >= fromDate;
                });
            }
            if (reportFilters.toDate) {
                const toDate = parseLocalDate(reportFilters.toDate);
                toDate.setHours(23, 59, 59, 999);
                purchases = purchases.filter(p => {
                    const poDate = parseFlexibleDate(p.PO_Date);
                    return poDate && poDate <= toDate;
                });
                sales = sales.filter(s => {
                    const soDate = parseFlexibleDate(s.Sale_Date || s.SO_Date);
                    return soDate && soDate <= toDate;
                });
            }
            if (reportFilters.supplier) {
                purchases = purchases.filter(p => matchesFilter(p.Supplier_ID, reportFilters.supplier));
            }
            
            // Filter by PO Type
            if (reportFilters.poType) {
                purchases = purchases.filter(p => (p.PO_Type || 'INCOMING') === reportFilters.poType);
            }
            
            // Apply transaction status filter
            const statusFilter = reportFilters.transactionStatus || 'exclude-voided';
            if (statusFilter === 'exclude-voided') {
                purchases = purchases.filter(p => p.Status !== 'Voided');
                sales = sales.filter(s => s.Status !== 'Voided');
            } else if (statusFilter && statusFilter !== '') {
                purchases = purchases.filter(p => p.Status === statusFilter);
            }
            
            // Group purchases by date for trend chart
            const byDate = {};
            purchases.forEach(p => {
                const poDate = parseFlexibleDate(p.PO_Date);
                if (poDate && !isNaN(poDate.getTime())) {
                    const dateKey = poDate.toISOString().split('T')[0];
                    if (!byDate[dateKey]) byDate[dateKey] = 0;
                    byDate[dateKey] += parseFloat(p.Total_Amount) || 0;
                }
            });
            const sortedDates = Object.entries(byDate).sort((a, b) => a[0].localeCompare(b[0]));
            
            // Get supplier IDs from filtered purchases for product filtering
            const supplierIds = new Set(purchases.map(p => p.Supplier_ID));
            
            // Group by product (from PO lines) - only from filtered suppliers
            const byProduct = {};
            purchases.forEach(po => {
                const lines = getPurchaseLinesFromCache(po.PO_ID);
                lines.forEach(line => {
                    const itemId = line.Item_ID;
                    const item = items.find(i => i.Item_ID === itemId);
                    const qty = parseInt(line.Quantity) || 0;
                    const unitCost = parseFloat(line.Unit_Cost) || 0;
                    const lineTotal = qty * unitCost;
                    
                    if (!byProduct[itemId]) {
                        byProduct[itemId] = {
                            name: item?.Item_Description || itemId,
                            sku: item?.SKU || '',
                            supplierId: item?.Supplier_ID || '',
                            purchases: 0,
                            purchaseQty: 0,
                            sales: 0,
                            salesQty: 0
                        };
                    }
                    byProduct[itemId].purchases += lineTotal;
                    byProduct[itemId].purchaseQty += qty;
                });
            });
            
            // Add sales data for products from these suppliers
            sales.forEach(so => {
                const lines = getSalesLinesFromCache(so.SO_ID);
                lines.forEach(line => {
                    const itemId = line.Item_ID;
                    const item = items.find(i => i.Item_ID === itemId);
                    // Only include if item belongs to one of the filtered suppliers
                    if (item && supplierIds.has(item.Supplier_ID)) {
                        const qty = parseInt(line.Quantity) || 0;
                        const unitPrice = parseFloat(line.Unit_Price) || 0;
                        const lineTotal = qty * unitPrice;
                        
                        if (!byProduct[itemId]) {
                            byProduct[itemId] = {
                                name: item?.Item_Description || itemId,
                                sku: item?.SKU || '',
                                supplierId: item?.Supplier_ID || '',
                                purchases: 0,
                                purchaseQty: 0,
                                sales: 0,
                                salesQty: 0
                            };
                        }
                        byProduct[itemId].sales += lineTotal;
                        byProduct[itemId].salesQty += qty;
                    }
                });
            });
            
            // Group by supplier
            const bySupplier = {};
            purchases.forEach(p => {
                const suppId = p.Supplier_ID;
                if (!bySupplier[suppId]) {
                    bySupplier[suppId] = { name: getSupplierName(suppId), total: 0, count: 0, paid: 0 };
                }
                bySupplier[suppId].total += parseFloat(p.Total_Amount) || 0;
                bySupplier[suppId].paid += parseFloat(p.Amount_Paid) || 0;
                bySupplier[suppId].count++;
            });
            
            // Calculate totals for KPI cards
            let grandTotal = 0, totalOrderCount = 0, totalPaid = 0;
            Object.values(bySupplier).forEach(data => {
                grandTotal += data.total;
                totalPaid += data.paid;
                totalOrderCount += data.count;
            });
            const totalOwed = grandTotal - totalPaid;
            const avgPerOrder = totalOrderCount > 0 ? grandTotal / totalOrderCount : 0;
            
            // Calculate total sales from supplier products
            const totalSales = Object.values(byProduct).reduce((sum, p) => sum + p.sales, 0);
            
            // Top 10 Products by Purchases
            const top10ByPurchases = Object.entries(byProduct)
                .sort((a, b) => b[1].purchases - a[1].purchases)
                .slice(0, 10);
            const maxPurchases = top10ByPurchases.length > 0 ? Math.max(...top10ByPurchases.map(([, p]) => p.purchases)) : 0;
            
            // Top 10 Products by Sales
            const top10BySales = Object.entries(byProduct)
                .filter(([, p]) => p.sales > 0)
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 10);
            const maxSales = top10BySales.length > 0 ? Math.max(...top10BySales.map(([, p]) => p.sales)) : 0;
            
            // Show PO type filter in header
            const poTypeLabel = reportFilters.poType === 'INCOMING' ? ' Received Only' : 
                               reportFilters.poType === 'OUTGOING' ? ' On Order Only' : ' All Types';
            
            // Build inline filter summary for oval header
            const filterSummaryInline = generateFilterSummary({ inline: true });
            
            // Chart IDs
            const trendChartId = 'purchBySuppTrendChart_' + Date.now();
            const barColors = ['#7a9bb8', '#9a8ab8', '#7aaab8', '#6b9a8d', '#b8a86b', '#a8a8a8', '#8ab89a', '#b8887a', '#8a8ab8', '#b8b87a'];
            
            let html = `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Purchase by Supplier</h2>
                    <p style="margin: 0 0 ${filterSummaryInline ? '10px' : '0'} 0; font-size: 14px; opacity: 0.95;">${Object.keys(bySupplier).length} suppliers | ${purchases.length} orders | ${poTypeLabel}</p>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px;">${filterSummaryInline}</div>` : ''}
                </div>`;
            
            // KPI Summary Cards - Muted Professional Colors
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #7a9bb8;">
                        <div style="font-size: 11px; color: #5a7a8a; margin-bottom: 5px;"> Total Purchases</div>
                        <div style="font-size: 20px; font-weight: bold; color: #7a9bb8;">${formatMoney(grandTotal)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e8 0%, #d0e8d4 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #5a8a6d;">
                        <div style="font-size: 11px; color: #4a7a5d; margin-bottom: 5px;"> Total Sales</div>
                        <div style="font-size: 20px; font-weight: bold; color: #5a8a6d;">${formatMoney(totalSales)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #6b9a8d;">
                        <div style="font-size: 11px; color: #5a7a6d; margin-bottom: 5px;"> Amount Paid</div>
                        <div style="font-size: 20px; font-weight: bold; color: #6b9a8d;">${formatMoney(totalPaid)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b8a86b;">
                        <div style="font-size: 11px; color: #8a7a4a; margin-bottom: 5px;"> Amount Owed</div>
                        <div style="font-size: 20px; font-weight: bold; color: #b8a86b;">${formatMoney(totalOwed)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f0e8f0 0%, #e4d8e8 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9a8ab8;">
                        <div style="font-size: 11px; color: #7a6a8a; margin-bottom: 5px;"> Avg/Order</div>
                        <div style="font-size: 20px; font-weight: bold; color: #9a8ab8;">${formatMoney(avgPerOrder)}</div>
                    </div>
                </div>
            `;
            
            // Charts Section - Dashboard Style
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts & Top 10</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: block;">
                        <!-- Purchase Trend Chart - Full Width -->
                        <div style="margin-top: 15px; margin-bottom: 15px;">
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Purchase Trend</strong>
                                </div>
                                <canvas id="${trendChartId}" class="print-chart" height="180"></canvas>
                            </div>
                        </div>
                        
                        <!-- Section Header: Top 10 by Purchases -->
                        <div style="margin-bottom: 10px; padding: 8px 12px; background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); border-radius: 8px; border-left: 4px solid #7a9bb8;">
                            <strong style="color: #5a7a8a; font-size: 14px;"> Top 10 Products by Purchases</strong>
                        </div>
                        
                        <!-- Top 10 Products by Purchases -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Top 10 by Purchase Cost</strong>
                                </div>
                                ${top10ByPurchases.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No purchase data</p>' : `
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${top10ByPurchases.map(([id, p], i) => `
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                <div style="overflow: hidden;">
                                                    <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.name.substring(0, 15)}</div>
                                                    <div style="font-size: 10px; color: #9ca3af;">${p.purchaseQty} units</div>
                                                </div>
                                            </div>
                                            <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                <div style="height: 100%; width: ${(p.purchases / maxPurchases * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                    <span style="font-size: 10px; font-weight: 600; color: white;">${p.purchaseQty}</span>
                                                </div>
                                            </div>
                                            <div style="font-weight: 600; font-size: 12px; color: #1f2937; width: 65px; text-align: right;">${formatMoney(p.purchases)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                `}
                            </div>
                        </div>
                        
                        <!-- Section Header: Top 10 by Sales -->
                        <div style="margin-top: 20px; margin-bottom: 10px; padding: 8px 12px; background: linear-gradient(135deg, #e8f5e8 0%, #d0e8d4 100%); border-radius: 8px; border-left: 4px solid #5a8a6d;">
                            <strong style="color: #4a7a5d; font-size: 14px;"> Top 10 Products by Sales</strong>
                        </div>
                        
                        <!-- Top 10 Products by Sales -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="font-size: 20px;"></span>
                                    <strong style="font-size: 15px; color: #1f2937;">Top 10 by Sales Revenue</strong>
                                </div>
                                ${top10BySales.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No sales data for these suppliers</p>' : `
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${top10BySales.map(([id, p], i) => `
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="display: flex; align-items: flex-start; gap: 4px; width: 110px; flex-shrink: 0;">
                                                <span style="font-weight: 600; color: #6b7280; font-size: 13px; min-width: 18px;">${i + 1}.</span>
                                                <div style="overflow: hidden;">
                                                    <div style="font-weight: 600; font-size: 12px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.name.substring(0, 15)}</div>
                                                    <div style="font-size: 10px; color: #9ca3af;">${p.salesQty} units</div>
                                                </div>
                                            </div>
                                            <div style="flex: 1; height: 22px; background: #f3f4f6; border-radius: 12px; overflow: hidden; min-width: 50px;">
                                                <div style="height: 100%; width: ${(p.sales / maxSales * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; min-width: 30px;">
                                                    <span style="font-size: 10px; font-weight: 600; color: white;">${p.salesQty}</span>
                                                </div>
                                            </div>
                                            <div style="font-weight: 600; font-size: 12px; color: #5a8a6d; width: 65px; text-align: right;">${formatMoney(p.sales)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Quick Stats Section (collapsible)
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Quick Stats</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: block; margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; max-width: 500px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                <span style="font-size: 20px;"></span>
                                <strong style="font-size: 15px; color: #1f2937;">Quick Stats</strong>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Total Purchases</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${formatMoney(grandTotal)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Total Sales</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #5a8a6d;">${formatMoney(totalSales)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Amount Paid</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #6b9a8d;">${formatMoney(totalPaid)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Amount Owed</span>
                                    <span style="font-size: 14px; font-weight: 600; color: ${totalOwed > 0 ? '#b8a86b' : '#9ca3af'};">${totalOwed > 0 ? formatMoney(totalOwed) : '-'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Total Orders</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${totalOrderCount}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Avg Order Value</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${formatMoney(avgPerOrder)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="font-size: 13px; color: #4b5563;"> Suppliers</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${Object.keys(bySupplier).length}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                    <span style="font-size: 13px; color: #4b5563;"> Products</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${Object.keys(byProduct).length}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Detail Table Section
            html += `
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Detail Table</strong>
                        <span style="color: #666; font-size: 12px;">(${Object.keys(bySupplier).length} suppliers - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>Supplier</th>
                                <th style="text-align: right;">Orders</th>
                                <th style="text-align: right;">Total</th>
                                <th style="text-align: right;">Paid</th>
                                <th style="text-align: right;">Balance</th>
                            </tr></thead><tbody>`;
            
            Object.entries(bySupplier)
                .sort((a, b) => b[1].total - a[1].total)
                .forEach(([id, data]) => {
                    const balance = data.total - data.paid;
                    html += `<tr>
                        <td>${data.name}</td>
                        <td style="text-align: right;">${data.count}</td>
                        <td style="text-align: right;">${formatMoney(data.total)}</td>
                        <td style="text-align: right;">${formatMoney(data.paid)}</td>
                        <td style="text-align: right; color: ${balance > 0 ? '#c62828' : '#2e7d32'};">${formatMoney(balance)}</td>
                    </tr>`;
                });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td>TOTAL</td>
                <td style="text-align: right;">${totalOrderCount}</td>
                <td style="text-align: right;">${formatMoney(grandTotal)}</td>
                <td style="text-align: right;">${formatMoney(totalPaid)}</td>
                <td style="text-align: right; color: ${totalOwed > 0 ? '#c62828' : '#2e7d32'};">${formatMoney(totalOwed)}</td>
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            
            // Chart.js initialization for Purchase Trend
            html += `
                <scr` + `ipt>
                    setTimeout(() => {
                        // Purchase Trend Line Chart
                        const ctx = document.getElementById('${trendChartId}');
                        if (ctx) {
                            if(Chart.getChart(ctx))Chart.getChart(ctx).destroy(); new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: [${sortedDates.map(([date]) => `'${date.substring(5)}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Daily Purchases',
                                        data: [${sortedDates.map(([, amt]) => amt.toFixed(2)).join(', ')}],
                                        borderColor: '#667eea',
                                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                        fill: true,
                                        tension: 0.3,
                                        pointRadius: 4,
                                        pointBackgroundColor: '#667eea'
                                    }]
                                },
                                options: {
                                    responsive: false,
                                    animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        y: { 
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        async function generateInventoryTurnoverModal() {
            // Load all report data (uses cache if available)
            await loadReportData();
            
            let items = [...cachedItems];
            const suppliers = cachedSuppliers;
            let sales = cachedSalesOrders.filter(s => s.Status !== 'Voided');
            
            if (!items.length || !sales.length) {
                throw new Error('Failed to load data');
            }
            
            // Apply supplier filter
            if (reportFilters.supplier) {
                items = items.filter(i => matchesFilter(i.Supplier_ID, reportFilters.supplier));
            }
            
            // Get date range for turnover calculation (default last 90 days)
            const now = new Date();
            const fromDate = reportFilters.fromDate ? parseLocalDate(reportFilters.fromDate) : new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
            let toDate = reportFilters.toDate ? parseLocalDate(reportFilters.toDate) : now;
            fromDate.setHours(0, 0, 0, 0);
            toDate.setHours(23, 59, 59, 999);
            
            const daysPeriod = Math.max(1, Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24)));
            
            // Filter sales by date range
            sales = sales.filter(s => {
                const d = parseDate(s.Sale_Date || s.SO_Date);
                return d && d >= fromDate && d <= toDate;
            });
            
            // Calculate units sold per item in the period
            const unitsSoldByItem = {};
            const lastSaleDate = {};
            
            for (const so of sales) {
                const soDate = parseDate(so.Sale_Date || so.SO_Date);
                const lines = getSalesLinesFromCache(so.SO_ID);
                if (lines.length > 0) {
                    lines.forEach(line => {
                        const itemId = line.Item_ID;
                        const qty = parseInt(line.Quantity) || 0;
                        unitsSoldByItem[itemId] = (unitsSoldByItem[itemId] || 0) + qty;
                        
                        // Track last sale date
                        if (!lastSaleDate[itemId] || soDate > lastSaleDate[itemId]) {
                            lastSaleDate[itemId] = soDate;
                        }
                    });
                }
            }
            
            // Build turnover data for each item
            const turnoverData = items.map(item => {
                const itemId = item.Item_ID;
                const qtyOnHand = parseInt(item.Qty_On_Hand) || 0;
                const qtyOnBackorder = parseInt(item.Qty_On_Backorder) || 0;
                const unitsSold = unitsSoldByItem[itemId] || 0;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPkg = parseInt(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPkg;
                const inventoryValue = Math.abs(qtyOnHand) * unitCost;
                const supplier = suppliers.find(s => s.Supplier_ID === item.Supplier_ID);
                
                // Calculate daily sales rate
                const dailySalesRate = unitsSold / daysPeriod;
                
                // Days of supply (how long current inventory will last)
                const daysOfSupply = dailySalesRate > 0 ? Math.round(qtyOnHand / dailySalesRate) : (qtyOnHand > 0 ? 999 : 0);
                
                // Annualized turnover rate (times per year inventory sells)
                const annualizedSales = dailySalesRate * 365;
                const avgInventory = Math.max(qtyOnHand, 1); // Use current as proxy
                const turnoverRate = annualizedSales / avgInventory;
                
                // Days since last sale
                const daysSinceLastSale = lastSaleDate[itemId] 
                    ? Math.floor((now - lastSaleDate[itemId]) / (1000 * 60 * 60 * 24))
                    : 999;
                
                // Velocity classification
                let velocity = 'dead';
                let velocityColor = '#b88a8a';
                let velocityIcon = '';
                if (unitsSold === 0 && qtyOnHand === 0) {
                    velocity = 'none';
                    velocityColor = '#9ca3af';
                    velocityIcon = '';
                } else if (dailySalesRate >= 2) {
                    velocity = 'fast';
                    velocityColor = '#6b9a8d';
                    velocityIcon = '';
                } else if (dailySalesRate >= 0.5) {
                    velocity = 'medium';
                    velocityColor = '#3b82f6';
                    velocityIcon = '';
                } else if (dailySalesRate >= 0.1) {
                    velocity = 'slow';
                    velocityColor = '#b8a86b';
                    velocityIcon = '';
                } else if (unitsSold > 0) {
                    velocity = 'slow';
                    velocityColor = '#b8a86b';
                    velocityIcon = '';
                }
                
                return {
                    itemId,
                    sku: item.SKU || '-',
                    description: item.Item_Description || itemId,
                    supplier: supplier?.Supplier_Name || 'Unknown',
                    qtyOnHand,
                    qtyOnBackorder,
                    unitsSold,
                    dailySalesRate,
                    daysOfSupply,
                    turnoverRate,
                    daysSinceLastSale,
                    velocity,
                    velocityColor,
                    velocityIcon,
                    inventoryValue,
                    unitCost
                };
            });
            
            // Sort by velocity priority then by value
            const velocityOrder = { fast: 0, medium: 1, slow: 2, dead: 3, none: 4 };
            turnoverData.sort((a, b) => {
                if (velocityOrder[a.velocity] !== velocityOrder[b.velocity]) {
                    return velocityOrder[a.velocity] - velocityOrder[b.velocity];
                }
                return b.inventoryValue - a.inventoryValue;
            });
            
            // Calculate velocity summary
            const velocityCounts = { fast: 0, medium: 0, slow: 0, dead: 0, none: 0 };
            const velocityValue = { fast: 0, medium: 0, slow: 0, dead: 0, none: 0 };
            let totalValue = 0;
            let totalUnitsSold = 0;
            
            turnoverData.forEach(item => {
                velocityCounts[item.velocity]++;
                velocityValue[item.velocity] += item.inventoryValue;
                totalValue += item.inventoryValue;
                totalUnitsSold += item.unitsSold;
            });
            
            const avgTurnover = turnoverData.length > 0 
                ? turnoverData.reduce((sum, i) => sum + i.turnoverRate, 0) / turnoverData.length 
                : 0;
            
            // Generate unique chart ID
            const chartId = 'turnoverChart_' + Date.now();
            const pieChartId = 'turnoverPieChart_' + Date.now();
            
            // Build inline filter summary for oval header
            const filterSummaryInline = generateFilterSummary({ inline: true });
            
            let html = `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #9a8ab8 0%, #7a9bb8 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(154, 138, 184, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Inventory Turnover Analysis</h2>
                    <p style="margin: 0 0 ${filterSummaryInline ? '10px' : '0'} 0; font-size: 14px; opacity: 0.95;">Analyzing ${daysPeriod} days of sales data (${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()})</p>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px;">${filterSummaryInline}</div>` : ''}
                </div>
                
                <!-- KPI Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #7a9bb8;">
                        <div style="font-size: 12px; color: #1565c0; margin-bottom: 5px;"> Total Items</div>
                        <div style="font-size: 22px; font-weight: bold; color: #7a9bb8;">${turnoverData.length}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #6b9a8d;">
                        <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px;"> Units Sold</div>
                        <div style="font-size: 22px; font-weight: bold; color: #6b9a8d;">${totalUnitsSold.toLocaleString()}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ede7f6 0%, #d1c4e9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9a8ab8;">
                        <div style="font-size: 12px; color: #7e57c2; margin-bottom: 5px;"> Avg Turnover</div>
                        <div style="font-size: 22px; font-weight: bold; color: #9a8ab8;">${avgTurnover.toFixed(1)}x/yr</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b88a8a;">
                        <div style="font-size: 12px; color: #b88a8a; margin-bottom: 5px;"> Dead Stock Value</div>
                        <div style="font-size: 22px; font-weight: bold; color: #b88a8a;">${formatMoney(velocityValue.dead)}</div>
                    </div>
                </div>
                
                <!-- Velocity Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: white; border: 2px solid #6b9a8d; border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 32px;"></div>
                        <div style="font-size: 24px; font-weight: bold; color: #6b9a8d;">${velocityCounts.fast}</div>
                        <div style="font-size: 12px; color: #666;">Fast Movers</div>
                        <div style="font-size: 11px; color: #6b9a8d;">(2+ units/day)</div>
                        <div style="font-size: 13px; color: #333; margin-top: 5px;">${formatMoney(velocityValue.fast)}</div>
                    </div>
                    <div style="background: white; border: 2px solid #7a9bb8; border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 32px;"></div>
                        <div style="font-size: 24px; font-weight: bold; color: #7a9bb8;">${velocityCounts.medium}</div>
                        <div style="font-size: 12px; color: #666;">Medium Movers</div>
                        <div style="font-size: 11px; color: #7a9bb8;">(0.5-2 units/day)</div>
                        <div style="font-size: 13px; color: #333; margin-top: 5px;">${formatMoney(velocityValue.medium)}</div>
                    </div>
                    <div style="background: white; border: 2px solid #b8a86b; border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 32px;"></div>
                        <div style="font-size: 24px; font-weight: bold; color: #b8a86b;">${velocityCounts.slow}</div>
                        <div style="font-size: 12px; color: #666;">Slow Movers</div>
                        <div style="font-size: 11px; color: #b8a86b;">(<0.5 units/day)</div>
                        <div style="font-size: 13px; color: #333; margin-top: 5px;">${formatMoney(velocityValue.slow)}</div>
                    </div>
                    <div style="background: white; border: 2px solid #b88a8a; border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 32px;"></div>
                        <div style="font-size: 24px; font-weight: bold; color: #b88a8a;">${velocityCounts.dead}</div>
                        <div style="font-size: 12px; color: #666;">Dead Stock</div>
                        <div style="font-size: 11px; color: #b88a8a;">(No sales in period)</div>
                        <div style="font-size: 13px; color: #333; margin-top: 5px;">${formatMoney(velocityValue.dead)}</div>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; color: #333;"> Inventory Value by Velocity</h4>
                        <canvas id="${chartId}" height="220"></canvas>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; color: #333;"> Item Count Distribution</h4>
                        <canvas id="${pieChartId}" height="220"></canvas>
                    </div>
                </div>
                
                <!-- Detail Table -->
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 15px 0;"> Item Details</h4>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Velocity</th>
                                    <th>SKU</th>
                                    <th>Description</th>
                                    <th>Supplier</th>
                                    <th style="text-align: right;">On Hand</th>
                                    <th style="text-align: right;">Backorder</th>
                                    <th style="text-align: right;">Sold (${daysPeriod}d)</th>
                                    <th style="text-align: right;">Daily Rate</th>
                                    <th style="text-align: right;">Days Supply</th>
                                    <th style="text-align: right;">Turnover</th>
                                    <th style="text-align: right;">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${turnoverData.map(item => `
                                    <tr>
                                        <td>
                                            <span style="display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 15px; background: ${item.velocityColor}20; color: ${item.velocityColor}; font-weight: 600; font-size: 12px;">
                                                ${item.velocityIcon} ${item.velocity.charAt(0).toUpperCase() + item.velocity.slice(1)}
                                            </span>
                                        </td>
                                        <td style="font-family: monospace;">${item.sku}</td>
                                        <td>${item.description}</td>
                                        <td>${item.supplier}</td>
                                        <td style="text-align: right; color: ${item.qtyOnHand <= 0 ? '#b88a8a' : '#333'};">${item.qtyOnHand}</td>
                                        <td style="text-align: right; color: ${item.qtyOnBackorder > 0 ? '#b88a8a' : '#666'}; font-weight: ${item.qtyOnBackorder > 0 ? '600' : 'normal'};">${item.qtyOnBackorder > 0 ? item.qtyOnBackorder : '-'}</td>
                                        <td style="text-align: right; font-weight: ${item.unitsSold > 0 ? 'bold' : 'normal'}; color: ${item.unitsSold > 0 ? '#6b9a8d' : '#999'};">${item.unitsSold}</td>
                                        <td style="text-align: right;">${item.dailySalesRate.toFixed(2)}</td>
                                        <td style="text-align: right;">
                                            ${item.daysOfSupply >= 999 ? '<span style="color: #b88a8a;"></span>' : 
                                              item.daysOfSupply <= 7 ? `<span style="color: #b88a8a; font-weight: bold;">${item.daysOfSupply}d</span>` :
                                              item.daysOfSupply <= 30 ? `<span style="color: #b8a86b;">${item.daysOfSupply}d</span>` :
                                              `${item.daysOfSupply}d`}
                                        </td>
                                        <td style="text-align: right;">${item.turnoverRate.toFixed(1)}x</td>
                                        <td style="text-align: right;">${formatMoney(item.inventoryValue)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <scr` + `ipt>
                    setTimeout(() => {
                        // Bar Chart - Value by Velocity
                        const ctx1 = document.getElementById('${chartId}');
                        if (ctx1) {
                            if(Chart.getChart(ctx1))Chart.getChart(ctx1).destroy(); new Chart(ctx1, {
                                type: 'bar',
                                data: {
                                    labels: [' Fast', ' Medium', ' Slow', ' Dead'],
                                    datasets: [{
                                        label: 'Inventory Value',
                                        data: [${velocityValue.fast.toFixed(2)}, ${velocityValue.medium.toFixed(2)}, ${velocityValue.slow.toFixed(2)}, ${velocityValue.dead.toFixed(2)}],
                                        backgroundColor: ['#6b9a8d', '#7a9bb8', '#b8a86b', '#b88a8a'],
                                        borderRadius: 8
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: {
                                                callback: (val) => '$' + val.toLocaleString()
                                            }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Pie Chart - Item Count
                        const ctx2 = document.getElementById('${pieChartId}');
                        if (ctx2) {
                            if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                type: 'doughnut',
                                data: {
                                    labels: ['Fast Movers', 'Medium Movers', 'Slow Movers', 'Dead Stock'],
                                    datasets: [{
                                        data: [${velocityCounts.fast}, ${velocityCounts.medium}, ${velocityCounts.slow}, ${velocityCounts.dead}],
                                        backgroundColor: ['#6b9a8d', '#7a9bb8', '#b8a86b', '#b88a8a'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            position: 'bottom',
                                            labels: { padding: 15, usePointStyle: true }
                                        },
                                        datalabels: {
                                            display: true,
                                            color: '#fff',
                                            font: { weight: 'bold', size: 12 },
                                            formatter: (value) => value > 0 ? value : ''
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        async function generateGrossMarginModal() {
            return await generateInventoryReportModal('margin');
        }
        
        // ==================== SUPPLIER PERFORMANCE DASHBOARD ====================
        
        async function generateSupplierPerformanceModal() {
            const fromDate = reportFilters.fromDate ? parseLocalDate(reportFilters.fromDate) : null;
            let toDate = reportFilters.toDate ? parseLocalDate(reportFilters.toDate) : null;
            if (toDate) toDate.setHours(23, 59, 59, 999);
            if (fromDate) fromDate.setHours(0, 0, 0, 0);
            const supplierFilter = reportFilters.supplier || '';
            
            // Fetch data
            const [poResult, suppliersResult, itemsResult] = await Promise.all([
                apiCall('getPurchaseOrders'),
                apiCall('getSuppliers'),
                apiCall('getItems')
            ]);
            
            if (!poResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            const items = itemsResult?.data || [];
            let purchases = poResult.data;
            
            // Date range label
            let dateLabel = 'All Time';
            if (fromDate && toDate) {
                dateLabel = `${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`;
            } else if (fromDate) {
                dateLabel = `Since ${fromDate.toLocaleDateString()}`;
            } else if (toDate) {
                dateLabel = `Through ${toDate.toLocaleDateString()}`;
            }
            
            // Filter by date
            if (fromDate) {
                purchases = purchases.filter(po => {
                    const d = parseDate(po.PO_Date);
                    return d && d >= fromDate;
                });
            }
            if (toDate) {
                purchases = purchases.filter(po => {
                    const d = parseDate(po.PO_Date);
                    return d && d <= toDate;
                });
            }
            
            // Filter by supplier if specified
            if (supplierFilter) {
                purchases = purchases.filter(po => po.Supplier_ID === supplierFilter);
            }
            
            // Exclude voided/cancelled
            purchases = purchases.filter(po => po.Status !== 'Void' && po.Status !== 'Cancelled' && po.Status !== 'Voided');
            
            // Calculate metrics per supplier
            const supplierStats = {};
            const allFulfillmentDays = [];
            let totalOnTime = 0, totalLate = 0, totalPending = 0;
            const lateOrders = [];
            const monthlyData = {};
            
            purchases.forEach(po => {
                const suppId = po.Supplier_ID;
                const supplier = suppliers.find(s => s.Supplier_ID === suppId);
                const supplierName = supplier?.Supplier_Name || suppId;
                
                if (!supplierStats[suppId]) {
                    supplierStats[suppId] = {
                        id: suppId,
                        name: supplierName,
                        totalPOs: 0,
                        receivedPOs: 0,
                        pendingPOs: 0,
                        onTime: 0,
                        late: 0,
                        totalAmount: 0,
                        fulfillmentDays: [],
                        lateDays: []
                    };
                }
                
                const stats = supplierStats[suppId];
                stats.totalPOs++;
                stats.totalAmount += parseFloat(po.Total_Amount || po.Invoice_Total) || 0;
                
                const poDate = parseDate(po.PO_Date);
                const dueDate = parseDate(po.Due_Date);
                const isReceived = po.Status === 'Received' || po.Status === 'Partial';
                
                // Track monthly data
                if (poDate) {
                    const monthKey = `${poDate.getFullYear()}-${String(poDate.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { total: 0, onTime: 0, late: 0 };
                    }
                    monthlyData[monthKey].total++;
                }
                
                if (isReceived) {
                    stats.receivedPOs++;
                    
                    // Calculate actual lead time using Receive_Date
                    const receiveDate = parseDate(po.Receive_Date);
                    
                    if (receiveDate && poDate) {
                        // Actual lead time = Receive_Date - PO_Date
                        const actualLeadDays = Math.ceil((receiveDate - poDate) / (1000 * 60 * 60 * 24));
                        stats.fulfillmentDays.push(actualLeadDays);
                        allFulfillmentDays.push(actualLeadDays);
                        
                        // Check if on-time: compare Receive_Date to Due_Date (expected delivery)
                        if (dueDate) {
                            if (receiveDate <= dueDate) {
                                stats.onTime++;
                                totalOnTime++;
                                if (poDate) {
                                    const monthKey = `${poDate.getFullYear()}-${String(poDate.getMonth() + 1).padStart(2, '0')}`;
                                    if (monthlyData[monthKey]) monthlyData[monthKey].onTime++;
                                }
                            } else {
                                // Received late
                                const daysLate = Math.ceil((receiveDate - dueDate) / (1000 * 60 * 60 * 24));
                                stats.late++;
                                stats.lateDays.push(daysLate);
                                totalLate++;
                                if (poDate) {
                                    const monthKey = `${poDate.getFullYear()}-${String(poDate.getMonth() + 1).padStart(2, '0')}`;
                                    if (monthlyData[monthKey]) monthlyData[monthKey].late++;
                                }
                            }
                        } else {
                            // No due date set, count as on-time
                            stats.onTime++;
                            totalOnTime++;
                        }
                    } else if (dueDate && poDate) {
                        // Fallback if no Receive_Date: use expected days
                        const expectedDays = Math.ceil((dueDate - poDate) / (1000 * 60 * 60 * 24));
                        stats.fulfillmentDays.push(expectedDays);
                        allFulfillmentDays.push(expectedDays);
                        stats.onTime++;
                        totalOnTime++;
                    } else {
                        stats.onTime++;
                        totalOnTime++;
                    }
                } else if (po.Status === 'Ordered') {
                    stats.pendingPOs++;
                    totalPending++;
                    
                    // Check if overdue
                    const today = new Date();
                    if (dueDate && today > dueDate) {
                        const daysLate = Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24));
                        stats.late++;
                        stats.lateDays.push(daysLate);
                        totalLate++;
                        
                        lateOrders.push({
                            poId: po.Invoice_Number || po.PO_ID,
                            supplier: supplierName,
                            poDate: poDate,
                            dueDate: dueDate,
                            daysLate: daysLate,
                            amount: parseFloat(po.Total_Amount || po.Invoice_Total) || 0,
                            status: po.Status
                        });
                        
                        if (poDate) {
                            const monthKey = `${poDate.getFullYear()}-${String(poDate.getMonth() + 1).padStart(2, '0')}`;
                            if (monthlyData[monthKey]) monthlyData[monthKey].late++;
                        }
                    }
                }
            });
            
            // Calculate overall metrics
            const totalPOs = purchases.length;
            const totalWithTiming = totalOnTime + totalLate;
            const onTimeRate = totalWithTiming > 0 ? ((totalOnTime / totalWithTiming) * 100) : 0;
            const avgFulfillmentDays = allFulfillmentDays.length > 0 
                ? allFulfillmentDays.reduce((a, b) => a + b, 0) / allFulfillmentDays.length 
                : 0;
            
            // Sort suppliers by total POs
            const sortedSuppliers = Object.values(supplierStats).sort((a, b) => b.totalPOs - a.totalPOs);
            
            // Sort late orders by days late
            lateOrders.sort((a, b) => b.daysLate - a.daysLate);
            
            // Get monthly trend (last 6 months)
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const now = new Date();
            const trendMonths = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const data = monthlyData[key] || { total: 0, onTime: 0, late: 0 };
                trendMonths.push({
                    label: monthNames[d.getMonth()],
                    ...data,
                    onTimeRate: data.total > 0 ? ((data.onTime / data.total) * 100) : 0
                });
            }
            
            // Colors - muted professional palette
            const barColors = ['#7a9bb8', '#9a8ab8', '#7aaab8', '#6b9a8d', '#b8a86b', '#a8a8a8', '#8ab89a', '#b8887a', '#8a8ab8', '#b8b87a'];
            
            let html = `
                <style>
                    .sp-header {
                        padding: 25px 30px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border-radius: 16px;
                        margin-bottom: 25px;
                        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
                    }
                    .sp-header h2 { margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px; }
                    .sp-header p { margin: 0; font-size: 14px; opacity: 0.95; }
                    
                    .sp-kpi-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                        gap: 12px;
                        margin-bottom: 20px;
                    }
                    .sp-kpi {
                        background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%);
                        border-radius: 8px;
                        padding: 15px;
                        text-align: center;
                        border-left: 4px solid #7a9bb8;
                    }
                    .sp-kpi .value { font-size: 20px; font-weight: bold; color: #7a9bb8; }
                    .sp-kpi .label { font-size: 11px; color: #5a7a8a; margin-top: 5px; }
                    
                    .sp-section {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        border: 1px solid #e5e7eb;
                    }
                    .sp-section h3 {
                        margin: 0 0 15px 0;
                        color: #1f2937;
                        font-size: 16px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    
                    .sp-gauge {
                        width: 120px;
                        height: 60px;
                        margin: 0 auto 10px;
                        position: relative;
                        overflow: hidden;
                    }
                    .sp-gauge-bg {
                        width: 120px;
                        height: 60px;
                        border-radius: 60px 60px 0 0;
                        background: #e5e7eb;
                    }
                    .sp-gauge-fill {
                        position: absolute;
                        bottom: 0;
                        left: 0;
                        width: 120px;
                        height: 60px;
                        border-radius: 60px 60px 0 0;
                        transform-origin: center bottom;
                    }
                    
                    .sp-bar {
                        height: 24px;
                        border-radius: 12px;
                        margin-bottom: 8px;
                        display: flex;
                        overflow: hidden;
                    }
                    .sp-bar-segment {
                        height: 100%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 11px;
                        font-weight: 600;
                        color: white;
                        min-width: 30px;
                    }
                    
                    .sp-supplier-row {
                        display: grid;
                        grid-template-columns: 150px 1fr 80px 80px 80px;
                        gap: 10px;
                        align-items: center;
                        padding: 12px;
                        border-bottom: 1px solid #f3f4f6;
                    }
                    .sp-supplier-row:hover {
                        background: #f9fafb;
                    }
                    .sp-supplier-name {
                        font-weight: 600;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .sp-mini-bar {
                        height: 20px;
                        background: #f3f4f6;
                        border-radius: 10px;
                        overflow: hidden;
                        display: flex;
                    }
                    .sp-mini-bar-fill {
                        height: 100%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 10px;
                        color: white;
                        font-weight: 600;
                        min-width: 25px;
                    }
                    
                    .sp-trend-chart {
                        display: flex;
                        align-items: flex-end;
                        justify-content: space-around;
                        height: 120px;
                        padding: 10px;
                        background: #f9fafb;
                        border-radius: 8px;
                    }
                    .sp-trend-bar {
                        flex: 1;
                        margin: 0 5px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: flex-end;
                        height: 100%;
                    }
                    .sp-trend-fill {
                        width: 100%;
                        max-width: 40px;
                        border-radius: 4px 4px 0 0;
                        transition: height 0.3s;
                        flex-shrink: 0;
                    }
                    .sp-trend-label {
                        font-size: 11px;
                        color: #666;
                        margin-top: 5px;
                    }
                    
                    .sp-late-card {
                        background: #fef2f2;
                        border: 1px solid #fecaca;
                        border-radius: 8px;
                        padding: 12px;
                        margin-bottom: 10px;
                    }
                    .sp-late-card .days-late {
                        background: #b88a8a;
                        color: white;
                        padding: 2px 8px;
                        border-radius: 10px;
                        font-size: 12px;
                        font-weight: 600;
                    }
                    
                    @media (max-width: 768px) {
                        .sp-supplier-row {
                            grid-template-columns: 1fr;
                            gap: 5px;
                        }
                        .sp-supplier-row > div:not(:first-child) {
                            font-size: 12px;
                        }
                    }
                </style>
                
                <div class="sp-header">
                    <h2> Supplier Performance Dashboard</h2>
                    <p>${dateLabel}${supplierFilter ? '  Filtered by supplier' : ''}</p>
                </div>
                
                <!-- KPI Cards -->
                <div class="sp-kpi-grid">
                    <div class="sp-kpi" style="background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); border-left-color: #7a9bb8;">
                        <div class="value" style="color: #7a9bb8;">${totalPOs}</div>
                        <div class="label">Total POs</div>
                    </div>
                    <div class="sp-kpi" style="background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); border-left-color: #6b9a8d;">
                        <div class="value" style="color: #6b9a8d;">${totalOnTime}</div>
                        <div class="label">Received</div>
                    </div>
                    <div class="sp-kpi" style="background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); border-left-color: #b8a86b;">
                        <div class="value" style="color: #b8a86b;">${totalPending}</div>
                        <div class="label">Pending</div>
                    </div>
                    <div class="sp-kpi" style="background: linear-gradient(135deg, #f5e8e8 0%, #efdcdc 100%); border-left-color: #b88a8a;">
                        <div class="value" style="color: #b88a8a;">${totalLate}</div>
                        <div class="label">Overdue</div>
                    </div>
                    <div class="sp-kpi" style="background: linear-gradient(135deg, #f0e8f0 0%, #e4d8e8 100%); border-left-color: #9a8ab8;">
                        <div class="value" style="color: #9a8ab8;">${onTimeRate.toFixed(0)}%</div>
                        <div class="label">On-Time Rate</div>
                    </div>
                    <div class="sp-kpi" style="background: linear-gradient(135deg, #e8f5f5 0%, #d4efef 100%); border-left-color: #5a9a9a;">
                        <div class="value" style="color: #5a9a9a;">${avgFulfillmentDays.toFixed(0)}</div>
                        <div class="label">Avg Lead Time (days)</div>
                    </div>
                </div>
                
                <!-- Overall Performance Bar -->
                <div class="sp-section">
                    <h3> Overall Fulfillment Status</h3>
                    <div class="sp-bar">
                        ${totalOnTime > 0 ? `<div class="sp-bar-segment" style="width: ${(totalOnTime/totalPOs)*100}%; background: #6b9a8d;"> ${totalOnTime}</div>` : ''}
                        ${totalPending > 0 ? `<div class="sp-bar-segment" style="width: ${(totalPending/totalPOs)*100}%; background: #b8a86b;"> ${totalPending}</div>` : ''}
                        ${totalLate > 0 ? `<div class="sp-bar-segment" style="width: ${(totalLate/totalPOs)*100}%; background: #b88a8a;"> ${totalLate}</div>` : ''}
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px; font-size: 12px; color: #666;">
                        <span> Received: ${totalOnTime}</span>
                        <span> Pending: ${totalPending}</span>
                        <span> Overdue: ${totalLate}</span>
                    </div>
                </div>
                
                <!-- Monthly Trend -->
                <div class="sp-section">
                    <h3> Monthly Order Trend (Last 6 Months)</h3>
                    <div class="sp-trend-chart">
                        ${trendMonths.map(m => {
                            const maxOrders = Math.max(...trendMonths.map(x => x.total), 1);
                            const height = (m.total / maxOrders) * 80;
                            return `
                                <div class="sp-trend-bar">
                                    <div style="font-size: 11px; margin-bottom: 5px; color: #666;">${m.total}</div>
                                    <div class="sp-trend-fill" style="height: ${Math.max(height, 5)}px; background: linear-gradient(to top, #667eea, #764ba2);"></div>
                                    <div class="sp-trend-label">${m.label}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Supplier Breakdown -->
                <div class="sp-section">
                    <h3> Performance by Supplier</h3>
                    ${sortedSuppliers.length === 0 ? '<p style="color: #666; text-align: center;">No supplier data</p>' : `
                        <div style="overflow-x: auto;">
                            <div style="min-width: 500px;">
                                <div class="sp-supplier-row" style="background: #f3f4f6; font-weight: 600; font-size: 12px;">
                                    <div>Supplier</div>
                                    <div>Fulfillment</div>
                                    <div style="text-align: center;">POs</div>
                                    <div style="text-align: center;">On-Time</div>
                                    <div style="text-align: center;">Overdue</div>
                                </div>
                                ${sortedSuppliers.map((s, i) => {
                                    const onTimeWidth = s.totalPOs > 0 ? ((s.receivedPOs / s.totalPOs) * 100) : 0;
                                    const pendingWidth = s.totalPOs > 0 ? ((s.pendingPOs / s.totalPOs) * 100) : 0;
                                    const lateWidth = s.totalPOs > 0 ? ((s.late / s.totalPOs) * 100) : 0;
                                    return `
                                        <div class="sp-supplier-row">
                                            <div class="sp-supplier-name" title="${s.name}">${s.name}</div>
                                            <div>
                                                <div class="sp-mini-bar">
                                                    ${s.receivedPOs > 0 ? `<div class="sp-mini-bar-fill" style="width: ${onTimeWidth}%; background: #6b9a8d;">${s.receivedPOs}</div>` : ''}
                                                    ${s.pendingPOs > 0 ? `<div class="sp-mini-bar-fill" style="width: ${pendingWidth}%; background: #b8a86b;">${s.pendingPOs}</div>` : ''}
                                                    ${s.late > 0 ? `<div class="sp-mini-bar-fill" style="width: ${lateWidth}%; background: #b88a8a;">${s.late}</div>` : ''}
                                                </div>
                                            </div>
                                            <div style="text-align: center; font-weight: 600;">${s.totalPOs}</div>
                                            <div style="text-align: center; color: #6b9a8d; font-weight: 600;">${s.receivedPOs}</div>
                                            <div style="text-align: center; color: ${s.late > 0 ? '#b88a8a' : '#666'}; font-weight: 600;">${s.late}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `}
                </div>
                
                <!-- Overdue Orders Alert -->
                ${lateOrders.length > 0 ? `
                    <div class="sp-section" style="border-left: 4px solid #b88a8a;">
                        <h3> Overdue Purchase Orders (${lateOrders.length})</h3>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">These orders have passed their due date and have not been received.</p>
                        ${lateOrders.slice(0, 10).map(o => `
                            <div class="sp-late-card">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                    <div>
                                        <strong style="color: #991b1b;">${o.poId}</strong>
                                        <span style="color: #666; margin-left: 10px;">${o.supplier}</span>
                                    </div>
                                    <span class="days-late"> ${o.daysLate} days late</span>
                                </div>
                                <div style="margin-top: 8px; font-size: 13px; color: #666;">
                                    <span> Due: ${o.dueDate?.toLocaleDateString() || '-'}</span>
                                    <span style="margin-left: 15px;"> ${formatMoney(o.amount)}</span>
                                </div>
                            </div>
                        `).join('')}
                        ${lateOrders.length > 10 ? `<p style="color: #666; font-size: 12px; text-align: center;">... and ${lateOrders.length - 10} more overdue orders</p>` : ''}
                    </div>
                ` : `
                    <div class="sp-section" style="border-left: 4px solid #6b9a8d; background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%);">
                        <h3 style="color: #5a7a6d;"> No Overdue Orders!</h3>
                        <p style="color: #666; margin: 0;">All pending orders are within their due dates. Great job!</p>
                    </div>
                `}
                
                <!-- Summary Table -->
                <div class="sp-section">
                    <h3> Supplier Summary</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Supplier</th>
                                    <th style="text-align: right;">Total POs</th>
                                    <th style="text-align: right;">Received</th>
                                    <th style="text-align: right;">Pending</th>
                                    <th style="text-align: right;">Overdue</th>
                                    <th style="text-align: right;">Total Spend</th>
                                    <th style="text-align: right;">Avg Days</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedSuppliers.map(s => {
                                    const avgDays = s.fulfillmentDays.length > 0 
                                        ? (s.fulfillmentDays.reduce((a,b) => a+b, 0) / s.fulfillmentDays.length).toFixed(0)
                                        : '-';
                                    return `
                                        <tr>
                                            <td><strong>${s.name}</strong></td>
                                            <td style="text-align: right;">${s.totalPOs}</td>
                                            <td style="text-align: right; color: #6b9a8d;">${s.receivedPOs}</td>
                                            <td style="text-align: right; color: #b8a86b;">${s.pendingPOs}</td>
                                            <td style="text-align: right; color: ${s.late > 0 ? '#b88a8a' : '#666'}; font-weight: ${s.late > 0 ? 'bold' : 'normal'};">${s.late}</td>
                                            <td style="text-align: right;">$${s.totalAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                            <td style="text-align: right;">${avgDays}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <p style="margin: 0; font-size: 12px; color: #666;">
                        <strong> Note:</strong> On-time rate is calculated by comparing Receive Date to Due Date. "Avg Days" shows the average lead time from PO creation to receipt.
                    </p>
                </div>
            `;
            
            return html;
        }
        
        // ==================== INVENTORY PICK LIST ====================
        
        async function generatePickListModal() {
            // Ensure cached data is loaded (includes sales lines)
            await loadReportData();
            
            const fromDate = reportFilters.fromDate ? parseLocalDate(reportFilters.fromDate) : null;
            let toDate = reportFilters.toDate ? parseLocalDate(reportFilters.toDate) : null;
            if (toDate) toDate.setHours(23, 59, 59, 999);
            if (fromDate) fromDate.setHours(0, 0, 0, 0);
            const customerFilter = reportFilters.customer || '';
            const deliveryStatus = reportFilters.deliveryStatus || 'needs-delivery';
            const salesInvoiceFilter = reportFilters.salesInvoice || '';
            
            // Use cached data instead of fetching fresh
            const customers = cachedCustomers || [];
            const items = cachedItems || [];
            const suppliers = cachedSuppliers || [];
            let sales = cachedSalesOrders || [];
            
            // Exclude voided orders
            sales = sales.filter(so => so.Status !== 'Voided' && so.Status !== 'Void');
            
            // Date range label
            let dateLabel = 'All Time';
            if (fromDate && toDate) {
                dateLabel = `${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`;
            } else if (fromDate) {
                dateLabel = `Since ${fromDate.toLocaleDateString()}`;
            } else if (toDate) {
                dateLabel = `Through ${toDate.toLocaleDateString()}`;
            }
            
            // Filter by date
            if (fromDate) {
                sales = sales.filter(so => {
                    const d = parseDate(so.Sale_Date || so.SO_Date);
                    return d && d >= fromDate;
                });
            }
            if (toDate) {
                sales = sales.filter(so => {
                    const d = parseDate(so.Sale_Date || so.SO_Date);
                    return d && d <= toDate;
                });
            }
            
            // Filter by customer if specified
            if (customerFilter) {
                sales = sales.filter(so => so.Customer_ID === customerFilter);
            }
            
            // Filter by delivery status
            if (deliveryStatus === 'needs-delivery') {
                // Show Pending, Ready, Out for Delivery (not yet completed/delivered)
                sales = sales.filter(so => 
                    so.Status === 'Pending' || 
                    so.Status === 'Ready' || 
                    so.Status === 'Out for Delivery'
                );
            } else if (deliveryStatus === 'pending') {
                sales = sales.filter(so => so.Status === 'Pending');
            } else if (deliveryStatus === 'ready') {
                sales = sales.filter(so => so.Status === 'Ready');
            } else if (deliveryStatus === 'out') {
                sales = sales.filter(so => so.Status === 'Out for Delivery');
            } else if (deliveryStatus === 'delivered') {
                sales = sales.filter(so => so.Status === 'Completed' || so.Status === 'Delivered');
            }
            
            // Filter by invoice number if specified
            if (salesInvoiceFilter) {
                const searchTerm = salesInvoiceFilter.toLowerCase();
                sales = sales.filter(so => {
                    const invoiceNum = (so.Invoice_Number || so.SO_Number || so.SO_ID || '').toLowerCase();
                    return invoiceNum.includes(searchTerm);
                });
            }
            
            // Build item lookup map
            const itemMap = {};
            items.forEach(item => {
                itemMap[item.Item_ID] = {
                    ...item,
                    supplierName: suppliers.find(s => s.Supplier_ID === item.Supplier_ID)?.Supplier_Name || 'Unknown'
                };
            });
            
            // Gather all line items grouped by CUSTOMER -> ITEM -> INVOICES
            // New structure: customerPickData[customerId].items[itemId].invoices[]
            const customerPickData = {};
            let totalCost = 0, totalSale = 0, totalUnits = 0, totalCases = 0;
            const itemQuantities = {}; // Track total quantities needed per item (for consolidated list)
            const allInvoices = new Set(); // Track unique invoices
            
            for (const so of sales) {
                const customer = customers.find(c => c.Customer_ID === so.Customer_ID);
                const customerName = customer?.Customer_Name || so.Customer_ID;
                const soDate = parseDate(so.Sale_Date || so.SO_Date);
                
                // Initialize customer if not exists
                if (!customerPickData[so.Customer_ID]) {
                    customerPickData[so.Customer_ID] = {
                        customerId: so.Customer_ID,
                        customerName: customerName,
                        customerAddress: customer?.Address || '',
                        customerCity: customer?.City || '',
                        customerState: customer?.State || '',
                        customerZip: customer?.Zip || '',
                        customerPhone: customer?.Phone || '',
                        items: {},
                        totalCost: 0,
                        totalSale: 0,
                        totalUnits: 0,
                        totalCases: 0,
                        invoiceCount: 0
                    };
                }
                
                // Get line items
                const lines = getSalesLinesFromCache(so.SO_ID);
                if (lines && lines.length > 0) {
                    allInvoices.add(so.Invoice_Number || so.SO_ID);
                    customerPickData[so.Customer_ID].invoiceCount++;
                    
                    for (const line of lines) {
                        const item = itemMap[line.Item_ID];
                        const qty = parseInt(line.Quantity) || 0;
                        const unitPrice = parseFloat(line.Unit_Price) || 0;
                        const unitsPerPkg = parseFloat(item?.Units_Per_Package) || 1;
                        
                        // Use stored Unit_Cost if available, fall back to current item cost
                        let unitCost;
                        const storedUnitCost = parseFloat(line.Unit_Cost);
                        if (!isNaN(storedUnitCost) && storedUnitCost > 0) {
                            unitCost = storedUnitCost;
                        } else {
                            const pkgCost = parseFloat(item?.Package_Cost) || 0;
                            unitCost = pkgCost / unitsPerPkg;
                        }
                        
                        const lineCost = qty * unitCost;
                        const lineSale = qty * unitPrice;
                        const qtyOnHand = parseInt(item?.Qty_On_Hand) || 0;
                        const exactCases = Math.round((qty / unitsPerPkg) * 10000) / 10000; // Round to avoid floating point errors
                        const uom = item?.Unit_of_Measure || item?.UOM || 'case';
                        
                        // Initialize item for this customer if not exists
                        if (!customerPickData[so.Customer_ID].items[line.Item_ID]) {
                            customerPickData[so.Customer_ID].items[line.Item_ID] = {
                                itemId: line.Item_ID,
                                sku: item?.SKU || '-',
                                description: item?.Item_Description || line.Item_ID,
                                supplier: item?.supplierName || 'Unknown',
                                unitsPerPkg: unitsPerPkg,
                                uom: uom,
                                unitCost: unitCost,
                                qtyOnHand: qtyOnHand,
                                invoices: [],
                                totalQty: 0,
                                totalCases: 0,
                                totalCost: 0,
                                totalSale: 0
                            };
                        }
                        
                        // Add invoice detail for this item
                        customerPickData[so.Customer_ID].items[line.Item_ID].invoices.push({
                            invoiceNum: so.Invoice_Number || so.SO_ID,
                            soId: so.SO_ID,
                            date: soDate,
                            status: so.Status || 'Pending',
                            qty: qty,
                            exactCases: exactCases,
                            unitPrice: unitPrice,
                            lineCost: lineCost,
                            lineSale: lineSale
                        });
                        
                        // Update item totals
                        customerPickData[so.Customer_ID].items[line.Item_ID].totalQty += qty;
                        customerPickData[so.Customer_ID].items[line.Item_ID].totalCases += exactCases;
                        customerPickData[so.Customer_ID].items[line.Item_ID].totalCost += lineCost;
                        customerPickData[so.Customer_ID].items[line.Item_ID].totalSale += lineSale;
                        
                        // Update customer totals
                        customerPickData[so.Customer_ID].totalCost += lineCost;
                        customerPickData[so.Customer_ID].totalSale += lineSale;
                        customerPickData[so.Customer_ID].totalUnits += qty;
                        customerPickData[so.Customer_ID].totalCases += exactCases;
                        
                        // Update grand totals
                        totalCost += lineCost;
                        totalSale += lineSale;
                        totalUnits += qty;
                        totalCases += exactCases;
                        
                        // Track quantities per item (for consolidated pick list)
                        if (!itemQuantities[line.Item_ID]) {
                            itemQuantities[line.Item_ID] = {
                                description: item?.Item_Description || line.Item_ID,
                                sku: item?.SKU || '-',
                                supplier: item?.supplierName || 'Unknown',
                                qtyNeeded: 0,
                                exactCases: 0,
                                unitsPerPkg: unitsPerPkg,
                                uom: uom,
                                qtyOnHand: qtyOnHand
                            };
                        }
                        itemQuantities[line.Item_ID].qtyNeeded += qty;
                        itemQuantities[line.Item_ID].exactCases += exactCases;
                    }
                }
            }
            
            const totalProfit = totalSale - totalCost;
            const totalOrders = allInvoices.size;
            const customerCount = Object.keys(customerPickData).length;
            
            // Check for stock issues
            const stockIssues = Object.entries(itemQuantities).filter(([id, data]) => data.qtyNeeded > data.qtyOnHand);
            
            // Running inventory tracker - tracks cumulative picks across customers
            const runningInventory = {};
            
            let html = `
                <style>
                    .pl-header {
                        text-align: center;
                        padding: 25px;
                        background: linear-gradient(135deg, #0891b2, #06b6d4);
                        color: white;
                        border-radius: 16px;
                        margin-bottom: 20px;
                    }
                    .pl-header h2 { margin: 0; font-size: 26px; }
                    .pl-header p { margin: 10px 0 0 0; opacity: 0.9; }
                    
                    .pl-summary {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                        gap: 12px;
                        margin-bottom: 20px;
                    }
                    .pl-stat {
                        background: white;
                        border-radius: 10px;
                        padding: 15px;
                        text-align: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        border-top: 3px solid #0891b2;
                    }
                    .pl-stat .value { font-size: 24px; font-weight: bold; color: #0891b2; }
                    .pl-stat .label { font-size: 11px; color: #666; text-transform: uppercase; margin-top: 3px; }
                    
                    .pl-order {
                        background: white;
                        border-radius: 12px;
                        margin-bottom: 15px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        overflow: hidden;
                    }
                    .pl-order-header {
                        background: #f8fafc;
                        padding: 15px;
                        border-bottom: 1px solid #e2e8f0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-wrap: wrap;
                        gap: 10px;
                    }
                    .pl-order-header .customer { font-weight: 700; font-size: 16px; color: #0f172a; }
                    .pl-order-header .invoice { font-size: 13px; color: #0891b2; }
                    .pl-order-header .date { font-size: 13px; color: #64748b; }
                    .pl-order-header .status {
                        padding: 4px 12px;
                        border-radius: 20px;
                        font-size: 12px;
                        font-weight: 600;
                    }
                    .pl-order-header .status.pending { background: #fef3c7; color: #92400e; }
                    .pl-order-header .status.ready { background: #dbeafe; color: #1e40af; }
                    .pl-order-header .status.out { background: #e0e7ff; color: #4338ca; }
                    .pl-order-header .status.delivered { background: #d1fae5; color: #065f46; }
                    .pl-order-header .status.completed { background: #d1fae5; color: #065f46; }
                    
                    .pl-items {
                        padding: 0;
                    }
                    .pl-item {
                        display: grid;
                        grid-template-columns: 1fr 70px 70px 70px 70px 80px;
                        gap: 8px;
                        padding: 12px 15px;
                        border-bottom: 1px solid #f1f5f9;
                        align-items: center;
                        font-size: 13px;
                    }
                    .pl-item:last-child { border-bottom: none; }
                    .pl-item:hover { background: #f8fafc; }
                    .pl-item-desc { font-weight: 500; }
                    .pl-item-sku { font-size: 11px; color: #64748b; font-family: monospace; }
                    .pl-item-supplier { font-size: 11px; color: #0891b2; }
                    .pl-item .qty { font-weight: 700; text-align: center; }
                    .pl-item .cases { font-weight: 700; text-align: center; color: #7c3aed; }
                    .pl-item .stock { text-align: center; }
                    .pl-item .stock.low { color: #b88a8a; font-weight: 600; }
                    .pl-item .stock.ok { color: #059669; }
                    .pl-item .price { text-align: right; }
                    
                    .pl-order-footer {
                        background: #f1f5f9;
                        padding: 12px 15px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-wrap: wrap;
                        gap: 10px;
                        font-size: 13px;
                    }
                    .pl-order-footer .cost { color: #b88a8a; }
                    .pl-order-footer .sale { color: #059669; font-weight: 700; }
                    .pl-order-footer .profit { color: #7c3aed; font-weight: 600; }
                    
                    .pl-alert {
                        background: #fef2f2;
                        border: 1px solid #fecaca;
                        border-radius: 10px;
                        padding: 15px;
                        margin-bottom: 20px;
                    }
                    .pl-alert h4 { margin: 0 0 10px 0; color: #991b1b; }
                    .pl-alert-item {
                        display: flex;
                        justify-content: space-between;
                        padding: 8px 0;
                        border-bottom: 1px solid #fecaca;
                        font-size: 13px;
                    }
                    .pl-alert-item:last-child { border-bottom: none; }
                    
                    .pl-totals {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        margin-top: 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    }
                    .pl-totals h3 { margin: 0 0 15px 0; }
                    .pl-total-row {
                        display: flex;
                        justify-content: space-between;
                        padding: 8px 0;
                        border-bottom: 1px solid #f1f5f9;
                    }
                    .pl-total-row:last-child { border-bottom: none; font-weight: bold; font-size: 18px; }
                    
                    .pl-print-btn {
                        background: #0891b2;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    .pl-print-btn:hover { background: #0e7490; }
                    
                    @media (max-width: 768px) {
                        .pl-item {
                            grid-template-columns: 1fr;
                            gap: 8px;
                            padding: 15px;
                            background: white;
                            border-bottom: 2px solid #e2e8f0;
                        }
                        .pl-item > div { text-align: left !important; }
                        
                        /* Hide the header row on mobile */
                        .pl-item.pl-item-header {
                            display: none !important;
                        }
                        
                        /* Style data rows as cards on mobile */
                        .pl-item .pl-item-desc {
                            font-size: 15px;
                            font-weight: 600;
                            color: #0f172a;
                            margin-bottom: 4px;
                        }
                        .pl-item .pl-item-sku {
                            font-size: 12px;
                            color: #64748b;
                        }
                        .pl-item .pl-item-supplier {
                            font-size: 12px;
                            color: #0891b2;
                            margin-bottom: 8px;
                        }
                        
                        /* Inline labels on mobile */
                        .pl-item .qty::before { content: 'Units: '; font-weight: 500; color: #64748b; }
                        .pl-item .cases::before { content: ' Cases: '; font-weight: 500; color: #64748b; }
                        .pl-item .stock::before { content: 'Stock: '; font-weight: 500; color: #64748b; }
                        .pl-item .after::before { content: 'After: '; font-weight: 500; color: #64748b; }
                        .pl-item .price::before { content: 'Price: '; font-weight: 500; color: #64748b; }
                        
                        /* Make values stand out */
                        .pl-item .qty, .pl-item .cases, .pl-item .stock, .pl-item .after, .pl-item .price {
                            display: inline-block;
                            margin-right: 15px;
                            padding: 4px 0;
                        }
                        
                        /* Order header on mobile */
                        .pl-order-header {
                            flex-direction: column;
                            align-items: flex-start;
                        }
                        .pl-order-header > div:last-child {
                            text-align: left !important;
                            margin-top: 8px;
                        }
                    }
                    
                    @media print {
                        /* CRITICAL: Reset all positioning and centering */
                        * {
                            position: static !important;
                            transform: none !important;
                            left: auto !important;
                            right: auto !important;
                        }
                        
                        /* Hide buttons */
                        .pl-print-btn { display: none !important; }
                        
                        /* Make everything visible and print-friendly */
                        .pl-header {
                            background: #0891b2 !important;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                            padding: 15px !important;
                            margin: 0 0 15px 0 !important;
                            width: 100% !important;
                            box-sizing: border-box !important;
                        }
                        
                        .pl-header h2 {
                            font-size: 18pt !important;
                            margin: 0 !important;
                        }
                        
                        .pl-header p {
                            font-size: 10pt !important;
                        }
                        
                        /* Summary stats - 3 per row for print */
                        .pl-summary {
                            display: flex !important;
                            flex-wrap: wrap !important;
                            gap: 8px !important;
                            margin: 0 0 15px 0 !important;
                            padding: 0 !important;
                            width: 100% !important;
                            box-sizing: border-box !important;
                        }
                        
                        .pl-stat {
                            flex: 1 1 100px !important;
                            padding: 8px !important;
                            border: 1px solid #ddd !important;
                            margin: 0 !important;
                        }
                        
                        .pl-stat .value {
                            font-size: 14pt !important;
                        }
                        
                        .pl-stat .label {
                            font-size: 8pt !important;
                        }
                        
                        /* Stock alert */
                        .pl-alert {
                            border: 2px solid #b88a8a !important;
                            padding: 10px !important;
                            margin: 0 0 15px 0 !important;
                            page-break-inside: avoid !important;
                            width: 100% !important;
                            box-sizing: border-box !important;
                        }
                        
                        .pl-alert h4 {
                            font-size: 12pt !important;
                            margin-bottom: 8px !important;
                        }
                        
                        .pl-alert-item {
                            font-size: 10pt !important;
                            padding: 5px 0 !important;
                        }
                        
                        /* Orders */
                        .pl-order {
                            page-break-inside: avoid !important;
                            margin: 0 0 15px 0 !important;
                            border: 1px solid #ddd !important;
                            width: 100% !important;
                            box-sizing: border-box !important;
                        }
                        
                        .pl-order-header {
                            padding: 10px !important;
                            background: #f8f8f8 !important;
                        }
                        
                        .pl-order-header .customer {
                            font-size: 12pt !important;
                            font-weight: bold !important;
                        }
                        
                        .pl-order-header .invoice,
                        .pl-order-header .date {
                            font-size: 9pt !important;
                        }
                        
                        /* Item rows - table layout for print */
                        .pl-items {
                            display: table !important;
                            width: 100% !important;
                            box-sizing: border-box !important;
                            table-layout: fixed !important;
                        }
                        
                        .pl-item {
                            display: table-row !important;
                            font-size: 9pt !important;
                        }
                        
                        .pl-item > div {
                            display: table-cell !important;
                            padding: 4px 6px !important;
                            border-bottom: 1px solid #eee !important;
                            vertical-align: middle !important;
                        }
                        
                        .pl-item.pl-item-header {
                            display: table-row !important;
                            background: #f0f0f0 !important;
                            font-size: 8pt !important;
                            font-weight: bold !important;
                        }
                        
                        /* Remove ::before labels in print */
                        .pl-item .qty::before,
                        .pl-item .cases::before,
                        .pl-item .stock::before,
                        .pl-item .after::before,
                        .pl-item .price::before {
                            content: none !important;
                        }
                        
                        /* Order footer */
                        .pl-order-footer {
                            padding: 8px 10px !important;
                            font-size: 9pt !important;
                            background: #f8f8f8 !important;
                            width: 100% !important;
                            box-sizing: border-box !important;
                        }
                        
                        /* Pick list totals */
                        .pl-totals {
                            width: 100% !important;
                            box-sizing: border-box !important;
                            margin: 15px 0 0 0 !important;
                            padding: 15px !important;
                            border: 1px solid #ddd !important;
                        }
                    }
                </style>
                
                <div class="pl-header">
                    <h2> Pick List / Delivery Manifest</h2>
                    <p>${dateLabel}  ${
                        deliveryStatus === 'needs-delivery' ? ' Needs Delivery' : 
                        deliveryStatus === 'pending' ? ' Pending Orders' : 
                        deliveryStatus === 'ready' ? ' Ready for Pickup' : 
                        deliveryStatus === 'out' ? ' Out for Delivery' : 
                        deliveryStatus === 'delivered' ? ' Delivered/Completed' : 
                        'All Orders'
                    }${customerFilter ? '  Filtered by customer' : ''}${salesInvoiceFilter ? `  Invoice: ${salesInvoiceFilter}` : ''}</p>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <div style="font-size: 14px; color: #666;">
                         Generated: ${new Date().toLocaleString()}
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="pl-print-btn" style="background: #7c3aed;" onclick="printShippingLabels()">
                             Print Labels
                        </button>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="pl-summary">
                    <div class="pl-stat">
                        <div class="value">${totalOrders}</div>
                        <div class="label">Orders</div>
                    </div>
                    <div class="pl-stat" style="border-top-color: #7c3aed;">
                        <div class="value" style="color: #7c3aed;">${totalCases % 1 === 0 ? totalCases : totalCases.toFixed(1)}</div>
                        <div class="label"> Cases to Load</div>
                    </div>
                    <div class="pl-stat" style="border-top-color: #059669;">
                        <div class="value" style="color: #059669;">${totalUnits}</div>
                        <div class="label">Total Units</div>
                    </div>
                    <div class="pl-stat" style="border-top-color: #b88a8a;">
                        <div class="value" style="color: #b88a8a;">${formatMoney(totalCost)}</div>
                        <div class="label">Your Cost</div>
                    </div>
                    <div class="pl-stat" style="border-top-color: #059669;">
                        <div class="value" style="color: #059669;">${formatMoney(totalSale)}</div>
                        <div class="label">Sale Value</div>
                    </div>
                    <div class="pl-stat" style="border-top-color: #7c3aed;">
                        <div class="value" style="color: #7c3aed;">${formatMoney(totalProfit)}</div>
                        <div class="label">Gross Profit</div>
                    </div>
                </div>
                
                ${stockIssues.length > 0 ? `
                    <div class="pl-alert">
                        <h4> Stock Warning - ${stockIssues.length} Item(s) Need Attention</h4>
                        ${stockIssues.map(([id, data]) => `
                            <div class="pl-alert-item">
                                <div>
                                    <strong>${data.description}</strong>
                                    <span style="color: #666; margin-left: 10px;">${data.sku}</span>
                                </div>
                                <div>
                                    <span style="color: #b88a8a;">Need: ${data.qtyNeeded}</span>
                                    <span style="margin: 0 10px;">|</span>
                                    <span>Have: ${data.qtyOnHand}</span>
                                    <span style="margin: 0 10px;">|</span>
                                    <span style="color: #b88a8a; font-weight: 600;">Short: ${data.qtyNeeded - data.qtyOnHand}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <!-- Consolidated Pick Summary -->
                ${Object.keys(itemQuantities).length > 0 ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #0891b2;">
                        <h3 style="margin: 0 0 15px 0; color: #0f172a;"> Consolidated Pick List - What to Grab</h3>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">Total items to pick across all orders:</p>
                        <div style="overflow-x: auto;">
                            <table class="data-table" style="margin: 0;">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>SKU</th>
                                        <th>Supplier</th>
                                        <th style="text-align: center;"> Cases</th>
                                        <th style="text-align: center;">Units</th>
                                        <th style="text-align: center;">In Stock</th>
                                        <th style="text-align: center;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(itemQuantities)
                                        .sort((a, b) => b[1].exactCases - a[1].exactCases)
                                        .map(([itemId, data]) => {
                                            const isShort = data.qtyNeeded > data.qtyOnHand;
                                            const remaining = data.qtyOnHand - data.qtyNeeded;
                                            // Format cases display
                                            let casesDisplay;
                                            if (data.exactCases >= 1) {
                                                const wholeCases = Math.floor(data.exactCases);
                                                const partialUnits = data.qtyNeeded - (wholeCases * data.unitsPerPkg);
                                                if (partialUnits > 0) {
                                                    casesDisplay = `${wholeCases}<span style="font-size: 10px; color: #666;"> + ${partialUnits}</span>`;
                                                } else {
                                                    casesDisplay = `${wholeCases}`;
                                                }
                                            } else {
                                                casesDisplay = `<span style="font-size: 12px; color: #666;">${data.qtyNeeded} unit${data.qtyNeeded !== 1 ? 's' : ''}</span>`;
                                            }
                                            return `
                                                <tr style="${isShort ? 'background: #fef2f2;' : ''}">
                                                    <td><strong>${data.description}</strong></td>
                                                    <td style="font-family: monospace; font-size: 12px; color: #64748b;">${data.sku}</td>
                                                    <td style="font-size: 12px; color: #0891b2;">${data.supplier}</td>
                                                    <td style="text-align: center; font-weight: 700; color: #7c3aed; font-size: 16px;">
                                                        ${casesDisplay}
                                                        <span style="font-size: 10px; font-weight: normal; color: #666;">${data.exactCases >= 1 ? data.uom + (Math.floor(data.exactCases) !== 1 ? 's' : '') : ''}</span>
                                                    </td>
                                                    <td style="text-align: center;">${data.qtyNeeded}</td>
                                                    <td style="text-align: center; color: ${isShort ? '#b88a8a' : '#059669'}; font-weight: ${isShort ? '600' : 'normal'};">${data.qtyOnHand}</td>
                                                    <td style="text-align: center;">
                                                        ${isShort 
                                                            ? `<span style="background: #b88a8a; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;"> Short ${Math.abs(remaining)}</span>`
                                                            : `<span style="background: #059669; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;"> OK</span>`
                                                        }
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
                
                ${customerCount === 0 ? `
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 15px;"></div>
                        <h3 style="margin: 0; color: #666;">No Orders Found</h3>
                        <p style="color: #999;">Try adjusting your filters to see orders.</p>
                    </div>
                ` : Object.values(customerPickData).map(customer => {
                    // Build address string
                    const addressParts = [];
                    if (customer.customerAddress) addressParts.push(customer.customerAddress);
                    const cityStateZip = [customer.customerCity, customer.customerState, customer.customerZip].filter(Boolean).join(', ');
                    if (cityStateZip) addressParts.push(cityStateZip);
                    const fullAddress = addressParts.join('<br>');
                    const itemCount = Object.keys(customer.items).length;
                    
                    // Build items HTML
                    const itemsHtml = Object.values(customer.items)
                        .sort((a, b) => b.totalCases - a.totalCases)
                        .map(item => {
                            // Use running inventory tracker for cumulative "After" calculation
                            if (!runningInventory[item.itemId]) {
                                runningInventory[item.itemId] = item.qtyOnHand;
                            }
                            const stockBefore = runningInventory[item.itemId];
                            const afterPick = stockBefore - item.totalQty;
                            runningInventory[item.itemId] = afterPick; // Update for next customer
                            const isShort = afterPick < 0;
                            
                            // Format cases display for item total
                            let casesDisplay;
                            if (item.totalCases >= 1) {
                                const wholeCases = Math.floor(item.totalCases);
                                const partialUnits = item.totalQty - (wholeCases * item.unitsPerPkg);
                                if (partialUnits > 0) {
                                    casesDisplay = wholeCases + '<span style="font-size: 10px; color: #666;"> + ' + partialUnits + '</span>';
                                } else {
                                    casesDisplay = '' + wholeCases;
                                }
                            } else {
                                casesDisplay = '<span style="color: #666;">' + item.totalQty + ' unit' + (item.totalQty !== 1 ? 's' : '') + '</span>';
                            }
                            
                            // Build invoice lines HTML
                            const invoicesHtml = item.invoices.map(inv => {
                                let invCasesDisplay;
                                if (inv.exactCases >= 1) {
                                    const wholeCases = Math.floor(inv.exactCases);
                                    const partialUnits = inv.qty - (wholeCases * item.unitsPerPkg);
                                    if (partialUnits > 0) {
                                        invCasesDisplay = wholeCases + '<span style="font-size: 9px; color: #888;"> + ' + partialUnits + '</span>';
                                    } else {
                                        invCasesDisplay = '' + wholeCases;
                                    }
                                } else {
                                    invCasesDisplay = '<span style="color: #888;">' + inv.qty + 'u</span>';
                                }
                                
                                const statusClass = inv.status === 'Completed' ? 'completed' : 
                                    inv.status === 'Delivered' ? 'delivered' : 
                                    inv.status === 'Out for Delivery' ? 'out' : 
                                    inv.status === 'Ready' ? 'ready' : 'pending';
                                
                                const statusIcon = inv.status === 'Out for Delivery' ? '' : 
                                    inv.status === 'Ready' ? '' : 
                                    (inv.status === 'Delivered' || inv.status === 'Completed') ? '' : '';
                                
                                return '<div class="pl-item" style="background: #fafafa; padding-left: 30px; font-size: 12px; border-left: 3px solid #e2e8f0;">' +
                                    '<div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">' +
                                        '<span style="color: #0891b2; font-weight: 500;"> ' + inv.invoiceNum + '</span>' +
                                        '<span style="color: #94a3b8;"></span>' +
                                        '<span style="color: #64748b;">' + (inv.date?.toLocaleDateString() || '-') + '</span>' +
                                        '<span class="status ' + statusClass + '" style="padding: 2px 8px; font-size: 10px;">' + statusIcon + ' ' + inv.status + '</span>' +
                                    '</div>' +
                                    '<div class="qty" style="color: #64748b;">' + inv.qty + '</div>' +
                                    '<div class="cases" style="color: #9ca3af; font-size: 12px;">' + invCasesDisplay + '</div>' +
                                    '<div></div>' +
                                    '<div></div>' +
                                    '<div class="price" style="color: #64748b;">' + formatMoney(inv.lineSale) + '</div>' +
                                '</div>';
                            }).join('');
                            
                            const uomDisplay = item.totalCases >= 1 ? item.uom + (Math.floor(item.totalCases) !== 1 ? 's' : '') : '';
                            
                            return '<div class="pl-item" style="background: #f0fdf4; border-left: 3px solid #059669;">' +
                                '<div>' +
                                    '<div class="pl-item-desc">' + item.description + '</div>' +
                                    '<div class="pl-item-sku">' + item.sku + '</div>' +
                                    '<div class="pl-item-supplier"> ' + item.supplier + '</div>' +
                                '</div>' +
                                '<div class="qty" style="font-size: 18px; color: #059669;">' + item.totalQty + '</div>' +
                                '<div class="cases" title="' + item.unitsPerPkg + ' per ' + item.uom + '" style="font-size: 16px;">' +
                                    casesDisplay + ' <span style="font-size: 10px; font-weight: normal; color: #666;">' + uomDisplay + '</span>' +
                                '</div>' +
                                '<div class="stock ' + (stockBefore < item.totalQty ? 'low' : 'ok') + '">' + stockBefore + '</div>' +
                                '<div class="after ' + (isShort ? 'low' : 'ok') + '">' + afterPick + '</div>' +
                                '<div class="price" style="font-weight: 600;">' + formatMoney(item.totalSale) + '</div>' +
                            '</div>' + invoicesHtml;
                        }).join('');
                    
                    return '<div class="pl-order">' +
                        '<div class="pl-order-header">' +
                            '<div>' +
                                '<div class="customer"> ' + customer.customerName + '</div>' +
                                (fullAddress ? '<div style="font-size: 13px; color: #475569; margin-top: 4px; line-height: 1.4;"> ' + fullAddress + '</div>' : '') +
                            '</div>' +
                            '<div style="text-align: right;">' +
                                '<div style="font-size: 13px; color: #64748b;">' + customer.invoiceCount + ' Invoice' + (customer.invoiceCount !== 1 ? 's' : '') + '</div>' +
                                '<div style="margin-top: 4px; font-size: 14px; font-weight: 600; color: #7c3aed;">' +
                                    ' ' + (customer.totalCases % 1 === 0 ? customer.totalCases : customer.totalCases.toFixed(1)) + ' Cases' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="pl-items">' +
                            '<div class="pl-item pl-item-header" style="background: #f8fafc; font-weight: 600; font-size: 11px; text-transform: uppercase; color: #64748b;">' +
                                '<div>Item</div>' +
                                '<div style="text-align: center;">Total Pick</div>' +
                                '<div style="text-align: center;"> Cases</div>' +
                                '<div style="text-align: center;">Stock</div>' +
                                '<div style="text-align: center;">After</div>' +
                                '<div style="text-align: right;">Total</div>' +
                            '</div>' +
                            itemsHtml +
                        '</div>' +
                        '<div class="pl-order-footer">' +
                            '<div>' +
                                '<span style="color: #666;">' + itemCount + ' item(s) across ' + customer.invoiceCount + ' invoice(s)</span>' +
                            '</div>' +
                            '<div style="display: flex; gap: 20px;">' +
                                '<span class="cost">Cost: ' + formatMoney(customer.totalCost) + '</span>' +
                                '<span class="sale">Sale: ' + formatMoney(customer.totalSale) + '</span>' +
                                '<span class="profit">Profit: ' + formatMoney(customer.totalSale - customer.totalCost) + '</span>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                }).join('') + `
                    
                    <!-- Totals -->
                    <div class="pl-totals">
                        <h3> Pick List Summary</h3>
                        <div class="pl-total-row">
                            <span>Total Orders</span>
                            <span>${totalOrders}</span>
                        </div>
                        <div class="pl-total-row">
                            <span> Total Cases to Load</span>
                            <span style="color: #7c3aed; font-weight: 600;">${totalCases % 1 === 0 ? totalCases : totalCases.toFixed(1)}</span>
                        </div>
                        <div class="pl-total-row">
                            <span>Total Units to Pick</span>
                            <span>${totalUnits}</span>
                        </div>
                        <div class="pl-total-row">
                            <span>Your Cost (COGS)</span>
                            <span style="color: #b88a8a;">${formatMoney(totalCost)}</span>
                        </div>
                        <div class="pl-total-row">
                            <span>Total Sale Value</span>
                            <span style="color: #059669;">${formatMoney(totalSale)}</span>
                        </div>
                        <div class="pl-total-row">
                            <span> Gross Profit</span>
                            <span style="color: #7c3aed;">${formatMoney(totalProfit)}</span>
                        </div>
                    </div>
                `}
            `;
            
            // Store label data for printing - need to flatten back to per-invoice format
            const labelDataArray = [];
            Object.values(customerPickData).forEach(customer => {
                // Group all invoices for this customer
                const invoiceMap = {};
                Object.values(customer.items).forEach(item => {
                    item.invoices.forEach(inv => {
                        if (!invoiceMap[inv.invoiceNum]) {
                            invoiceMap[inv.invoiceNum] = {
                                customerName: customer.customerName,
                                customerAddress: customer.customerAddress,
                                customerCity: customer.customerCity,
                                customerState: customer.customerState,
                                customerZip: customer.customerZip,
                                invoiceNum: inv.invoiceNum,
                                date: inv.date,
                                status: inv.status,
                                lines: [],
                                totalCases: 0
                            };
                        }
                        invoiceMap[inv.invoiceNum].lines.push({
                            description: item.description,
                            sku: item.sku,
                            exactCases: inv.exactCases,
                            unitsPerPkg: item.unitsPerPkg,
                            uom: item.uom,
                            qty: inv.qty
                        });
                        invoiceMap[inv.invoiceNum].totalCases += inv.exactCases;
                    });
                });
                labelDataArray.push(...Object.values(invoiceMap));
            });
            window.pickListLabelData = labelDataArray;
            
            return html;
        }
        
        // Print Shipping Labels Function - Aggregated by Customer + Item
        function printShippingLabels() {
            const labelData = window.pickListLabelData || [];
            
            if (labelData.length === 0) {
                showWarning('No orders to print labels for!');
                return;
            }
            
            // First, aggregate by customer + item (not per invoice)
            const aggregated = {};
            const today = new Date().toLocaleDateString();
            
            labelData.forEach(order => {
                const customerKey = order.customerName;
                
                // Build full address
                const addressParts = [];
                if (order.customerAddress) addressParts.push(order.customerAddress);
                const cityStateZip = [order.customerCity, order.customerState, order.customerZip].filter(Boolean).join(', ');
                if (cityStateZip) addressParts.push(cityStateZip);
                const fullAddress = addressParts.join('<br>');
                
                if (!aggregated[customerKey]) {
                    aggregated[customerKey] = {
                        customerName: order.customerName,
                        customerAddress: fullAddress,
                        items: {}
                    };
                }
                
                // Aggregate items for this customer
                order.lines.forEach(line => {
                    const itemKey = line.sku || line.description;
                    if (!aggregated[customerKey].items[itemKey]) {
                        aggregated[customerKey].items[itemKey] = {
                            description: line.description,
                            sku: line.sku || '-',
                            unitsPerPkg: line.unitsPerPkg || 1,
                            uom: line.uom || 'case',
                            totalQty: 0,
                            invoices: []
                        };
                    }
                    aggregated[customerKey].items[itemKey].totalQty += line.qty;
                    aggregated[customerKey].items[itemKey].invoices.push(order.invoiceNum);
                });
            });
            
            // Now generate labels based on aggregated cases
            const allLabels = [];
            
            Object.values(aggregated).forEach(customer => {
                Object.values(customer.items).forEach(item => {
                    const unitsPerPkg = item.unitsPerPkg;
                    const totalQty = item.totalQty;
                    const fullCases = Math.floor(totalQty / unitsPerPkg);
                    const partialUnits = totalQty % unitsPerPkg;
                    const totalLabels = fullCases + (partialUnits > 0 ? 1 : 0);
                    
                    // Invoice reference (combine if multiple)
                    const invoiceRef = [...new Set(item.invoices)].join(', ');
                    
                    // Create labels for full cases only
                    for (let box = 1; box <= fullCases; box++) {
                        allLabels.push({
                            customerName: customer.customerName,
                            customerAddress: customer.customerAddress,
                            invoiceNum: invoiceRef,
                            date: today,
                            itemName: item.description,
                            itemSku: item.sku,
                            itemQty: unitsPerPkg,
                            isPartial: false,
                            unitsPerPkg: unitsPerPkg,
                            boxNum: box,
                            totalBoxesForItem: totalLabels,
                            uom: item.uom
                        });
                    }
                    
                    // Create label for partial case if any
                    if (partialUnits > 0) {
                        allLabels.push({
                            customerName: customer.customerName,
                            customerAddress: customer.customerAddress,
                            invoiceNum: invoiceRef,
                            date: today,
                            itemName: item.description,
                            itemSku: item.sku,
                            itemQty: partialUnits,
                            isPartial: true,
                            unitsPerPkg: unitsPerPkg,
                            boxNum: fullCases + 1,
                            totalBoxesForItem: totalLabels,
                            uom: item.uom
                        });
                    }
                });
            });
            
            if (allLabels.length === 0) {
                showWarning('No cases to print labels for! All orders are partial units only.');
                return;
            }
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Nowak Distributing - Shipping Labels - ${new Date().toLocaleDateString().replace(/\//g, '-')}</title>
                    <style>
                        @page {
                            size: letter;
                            margin: 0.25in;
                        }
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        body {
                            font-family: Arial, sans-serif;
                            background: white;
                        }
                        .label-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 0.2in;
                            padding: 0.2in;
                        }
                        .label {
                            border: 2px solid #333;
                            border-radius: 8px;
                            padding: 12px;
                            height: 3.2in;
                            display: flex;
                            flex-direction: column;
                            page-break-inside: avoid;
                            background: white;
                        }
                        .label-header {
                            text-align: center;
                            border-bottom: 2px solid #333;
                            padding-bottom: 6px;
                            margin-bottom: 8px;
                        }
                        .label-header .company {
                            font-size: 12px;
                            font-weight: bold;
                            color: #333;
                        }
                        .label-body {
                            flex: 1;
                            display: flex;
                            flex-direction: column;
                        }
                        .customer-section {
                            margin-bottom: 8px;
                        }
                        .customer-name {
                            font-size: 18px;
                            font-weight: bold;
                            color: #000;
                            margin-bottom: 3px;
                        }
                        .customer-address {
                            font-size: 11px;
                            color: #444;
                            line-height: 1.3;
                        }
                        .order-info {
                            font-size: 10px;
                            color: #666;
                            margin-bottom: 8px;
                            display: flex;
                            justify-content: space-between;
                        }
                        .item-section {
                            background: #f5f5f5;
                            border: 2px solid #666;
                            border-radius: 6px;
                            padding: 8px;
                            margin-bottom: 8px;
                            flex: 1;
                        }
                        .item-label {
                            font-size: 9px;
                            color: #666;
                            text-transform: uppercase;
                            margin-bottom: 2px;
                        }
                        .item-name {
                            font-size: 14px;
                            font-weight: bold;
                            color: #000;
                            line-height: 1.2;
                        }
                        .item-sku {
                            font-size: 10px;
                            font-family: monospace;
                            color: #666;
                            margin-top: 2px;
                        }
                        .item-qty {
                            font-size: 11px;
                            color: #444;
                            margin-top: 4px;
                        }
                        .label-footer {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            border-top: 2px solid #333;
                            padding-top: 8px;
                        }
                        .box-indicator {
                            font-size: 16px;
                            font-weight: bold;
                            color: #000;
                            background: #e0e0e0;
                            padding: 4px 10px;
                            border-radius: 5px;
                            border: 2px solid #333;
                        }
                        .box-indicator.partial {
                            background: #f0e8d0;
                            border-color: #b8a86b;
                            color: #92400e;
                        }
                        .box-indicator.full {
                            background: #d1fae5;
                            border-color: #10b981;
                            color: #065f46;
                        }
                        .box-total {
                            font-size: 11px;
                            color: #666;
                            text-align: center;
                        }
                        .checkbox-area {
                            display: flex;
                            align-items: center;
                            gap: 4px;
                        }
                        .checkbox {
                            width: 18px;
                            height: 18px;
                            border: 2px solid #333;
                            border-radius: 3px;
                        }
                        .checkbox-label {
                            font-size: 10px;
                            color: #666;
                        }
                        @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            .label { break-inside: avoid; }
                            .print-controls { display: none !important; }
                        }
                        .print-controls {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            display: flex;
                            gap: 10px;
                            z-index: 1000;
                        }
                        .print-controls button {
                            padding: 12px 24px;
                            font-size: 16px;
                            font-weight: 600;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                        }
                        .print-controls .print-btn {
                            background: #6b9a8d;
                            color: white;
                        }
                        .print-controls .print-btn:hover {
                            background: #218838;
                        }
                        .print-controls .cancel-btn {
                            background: #b88a8a;
                            color: white;
                        }
                        .print-controls .cancel-btn:hover {
                            background: #c82333;
                        }
                    </style>
                </head>
                <body>
                    <div class="print-controls">
                        <button class="print-btn" onclick="window.print()"> Print Labels</button>
                        <button class="cancel-btn" onclick="window.close()"> Cancel</button>
                    </div>
                    <div class="label-grid">
                        ${allLabels.map(label => `
                            <div class="label">
                                <div class="label-header">
                                    <div class="company"> NOWAK DISTRIBUTING</div>
                                </div>
                                <div class="label-body">
                                    <div class="customer-section">
                                        <div class="customer-name">${label.customerName}</div>
                                        ${label.customerAddress ? `<div class="customer-address">${label.customerAddress}</div>` : ''}
                                    </div>
                                    <div class="order-info">
                                        <span> ${label.invoiceNum}</span>
                                        <span> ${label.date}</span>
                                    </div>
                                    <div class="item-section">
                                        <div class="item-label">Contents:</div>
                                        <div class="item-name">${label.itemName}</div>
                                        <div class="item-sku">SKU: ${label.itemSku}</div>
                                        <div class="item-qty">${label.itemQty} units ${label.isPartial ? `(of ${label.unitsPerPkg} per ${label.uom})` : ''}</div>
                                    </div>
                                </div>
                                <div class="label-footer">
                                    <div class="box-indicator ${label.isPartial ? 'partial' : 'full'}">
                                        ${label.isPartial 
                                            ? ` PARTIAL` 
                                            : ` FULL ${label.uom.toUpperCase()}`
                                        }
                                    </div>
                                    <div class="box-total">
                                        ${label.isPartial 
                                            ? `${label.itemQty} of ${label.unitsPerPkg}` 
                                            : `#${label.boxNum} of ${label.totalBoxesForItem}`
                                        }
                                    </div>
                                    <div class="checkbox-area">
                                        <div class="checkbox"></div>
                                        <div class="checkbox-label"></div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // Dormant Customers Report - Win back inactive customers
        async function generateDormantCustomersModal() {
            const dormantThreshold = reportFilters.dormantDays || 30;
            const sortBy = reportFilters.dormantSort || 'days-desc';
            
            // Try to use cached data first, fall back to API calls
            let sales, customers, items;
            
            // Always fetch fresh data for reports to ensure accuracy
            let salesResult, customersResult, itemsResult;
            try {
                [salesResult, customersResult, itemsResult] = await Promise.all([
                    apiCall('getSalesOrders'),
                    apiCall('getCustomers'),
                    apiCall('getItems')
                ]);
            } catch(e) {
                console.error('Error fetching data for Dormant Customers:', e);
                throw new Error('Failed to load data: ' + e.message);
            }
            
            // Check results - be more lenient
            if (!salesResult || !salesResult.data) {
                // Try using cached data as fallback
                if (cachedCustomers && cachedCustomers.length > 0) {
                    console.warn('Using cached data for Dormant Customers report');
                    sales = [];
                    customers = cachedCustomers;
                    items = cachedItems || [];
                } else {
                    throw new Error('Failed to load sales data and no cached data available');
                }
            } else {
                sales = (salesResult.data || []).filter(s => s && s.Status !== 'Voided');
                customers = customersResult?.data || cachedCustomers || [];
                items = itemsResult?.data || cachedItems || [];
            }
            
            // Build item lookup
            const itemMap = {};
            items.forEach(item => {
                itemMap[item.Item_ID] = item.Item_Description || item.SKU || item.Item_ID;
            });
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const thresholdDate = new Date(today);
            thresholdDate.setDate(thresholdDate.getDate() - dormantThreshold);
            
            // Analyze each customer's buying history
            const customerAnalysis = [];
            
            for (const customer of customers) {
                // Get all orders for this customer
                const customerOrders = sales.filter(s => s.Customer_ID === customer.Customer_ID);
                
                if (customerOrders.length === 0) continue; // Skip customers who never ordered
                
                // Sort by date to find latest order
                customerOrders.sort((a, b) => new Date(b.Sale_Date || b.SO_Date) - new Date(a.Sale_Date || a.SO_Date));
                
                const lastOrder = customerOrders[0];
                const lastOrderDate = new Date(lastOrder.Sale_Date || lastOrder.SO_Date);
                lastOrderDate.setHours(0, 0, 0, 0);
                
                // Only include if last order was before threshold
                if (lastOrderDate >= thresholdDate) continue;
                
                const daysSinceOrder = Math.floor((today - lastOrderDate) / (1000 * 60 * 60 * 24));
                
                // Calculate stats
                const totalOrders = customerOrders.length;
                const totalSpent = customerOrders.reduce((sum, o) => sum + (parseFloat(o.Total_Amount) || 0), 0);
                const avgOrderValue = totalSpent / totalOrders;
                
                // Find first order date for customer lifetime
                const firstOrderDate = new Date(customerOrders[customerOrders.length - 1].Sale_Date || customerOrders[customerOrders.length - 1].SO_Date);
                const customerLifetimeDays = Math.floor((lastOrderDate - firstOrderDate) / (1000 * 60 * 60 * 24)) + 1;
                const orderFrequency = totalOrders > 1 ? Math.round(customerLifetimeDays / (totalOrders - 1)) : 0;
                
                // Get last order line items
                let lastOrderItems = [];
                try {
                    const linesResult = await apiCall('getSalesOrderLines', { soId: lastOrder.SO_ID });
                    if (lines.length > 0) {
                        lastOrderItems = lines.map(line => ({
                            name: itemMap[line.Item_ID] || line.Item_ID,
                            qty: parseInt(line.Quantity) || 0,
                            price: parseFloat(line.Unit_Price) || 0,
                            total: (parseInt(line.Quantity) || 0) * (parseFloat(line.Unit_Price) || 0)
                        }));
                    }
                } catch(e) {
                    // Skip if can't fetch lines
                }
                
                // Build address
                const addressParts = [];
                if (customer.Address) addressParts.push(customer.Address);
                const cityStateZip = [customer.City, customer.State, customer.Zip].filter(Boolean).join(', ');
                if (cityStateZip) addressParts.push(cityStateZip);
                
                customerAnalysis.push({
                    customerId: customer.Customer_ID,
                    name: customer.Customer_Name || customer.Customer_ID,
                    phone: customer.Phone || '',
                    mobile: customer.Mobile || '',
                    email: customer.Email || '',
                    address: customer.Address || '',
                    city: customer.City || '',
                    state: customer.State || '',
                    zip: customer.Zip || '',
                    fullAddress: addressParts.join(', '),
                    lastOrderDate: lastOrderDate,
                    daysSinceOrder: daysSinceOrder,
                    totalOrders: totalOrders,
                    totalSpent: totalSpent,
                    avgOrderValue: avgOrderValue,
                    orderFrequency: orderFrequency,
                    lastOrderItems: lastOrderItems,
                    lastOrderTotal: parseFloat(lastOrder.Total_Amount) || 0,
                    lastInvoice: lastOrder.Invoice_Number || lastOrder.SO_ID
                });
            }
            
            // Sort based on user selection
            switch(sortBy) {
                case 'days-asc':
                    customerAnalysis.sort((a, b) => a.daysSinceOrder - b.daysSinceOrder);
                    break;
                case 'city':
                    customerAnalysis.sort((a, b) => (a.city || '').localeCompare(b.city || ''));
                    break;
                case 'value-desc':
                    customerAnalysis.sort((a, b) => b.totalSpent - a.totalSpent);
                    break;
                case 'orders-desc':
                    customerAnalysis.sort((a, b) => b.totalOrders - a.totalOrders);
                    break;
                default: // days-desc
                    customerAnalysis.sort((a, b) => b.daysSinceOrder - a.daysSinceOrder);
            }
            
            // Calculate summary stats
            const totalDormant = customerAnalysis.length;
            const totalAtRisk = customerAnalysis.reduce((sum, c) => sum + c.totalSpent, 0);
            const avgDormantDays = totalDormant > 0 ? Math.round(customerAnalysis.reduce((sum, c) => sum + c.daysSinceOrder, 0) / totalDormant) : 0;
            const highValueDormant = customerAnalysis.filter(c => c.totalSpent > 500).length;
            
            // Determine dormancy level
            function getDormancyLevel(days) {
                if (days >= 180) return { label: ' Critical', color: '#b88a8a', bg: '#fef2f2' };
                if (days >= 90) return { label: ' High Risk', color: '#ea580c', bg: '#fff7ed' };
                if (days >= 60) return { label: ' At Risk', color: '#ca8a04', bg: '#fefce8' };
                return { label: ' Watch', color: '#6b9a8d', bg: '#f0fdf4' };
            }
            
            let html = `
                <style>
                    .dormant-header {
                        text-align: center;
                        padding: 25px;
                        background: linear-gradient(135deg, #b8a86b, #d97706);
                        color: white;
                        border-radius: 16px;
                        margin-bottom: 20px;
                    }
                    .dormant-header h2 { margin: 0; font-size: 26px; }
                    .dormant-header p { margin: 10px 0 0 0; opacity: 0.9; }
                    
                    .dormant-summary {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    .dormant-stat {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        text-align: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        border-top: 4px solid #b8a86b;
                    }
                    .dormant-stat .value { font-size: 28px; font-weight: bold; color: #b8a86b; }
                    .dormant-stat .label { font-size: 12px; color: #666; text-transform: uppercase; margin-top: 5px; }
                    
                    .insight-box {
                        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
                        border: 2px solid #b8a86b;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 25px;
                    }
                    .insight-box h3 { margin: 0 0 15px 0; color: #92400e; }
                    .insight-item {
                        display: flex;
                        align-items: flex-start;
                        gap: 10px;
                        margin-bottom: 10px;
                        font-size: 14px;
                        color: #78350f;
                    }
                    .insight-item:last-child { margin-bottom: 0; }
                    
                    .customer-card {
                        background: white;
                        border-radius: 12px;
                        margin-bottom: 15px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        overflow: hidden;
                        border-left: 5px solid #b8a86b;
                    }
                    .customer-card-header {
                        padding: 15px 20px;
                        background: #fafafa;
                        border-bottom: 1px solid #e5e7eb;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        flex-wrap: wrap;
                        gap: 10px;
                    }
                    .customer-name { font-size: 18px; font-weight: 700; color: #1f2937; }
                    .customer-address { font-size: 13px; color: #6b7280; margin-top: 4px; line-height: 1.4; }
                    .customer-contact { font-size: 13px; color: #3b82f6; margin-top: 4px; }
                    .dormancy-badge {
                        padding: 6px 14px;
                        border-radius: 20px;
                        font-size: 13px;
                        font-weight: 600;
                    }
                    
                    .customer-stats {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                        gap: 15px;
                        padding: 15px 20px;
                        background: #f9fafb;
                    }
                    .stat-item {
                        text-align: center;
                    }
                    .stat-item .stat-value { font-size: 18px; font-weight: 700; color: #1f2937; }
                    .stat-item .stat-label { font-size: 11px; color: #6b7280; text-transform: uppercase; }
                    
                    .last-order-section {
                        padding: 15px 20px;
                        border-top: 1px solid #e5e7eb;
                    }
                    .last-order-title { font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px; }
                    .last-order-items {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 8px;
                    }
                    .order-item-chip {
                        background: #e0e7ff;
                        color: #3730a3;
                        padding: 5px 12px;
                        border-radius: 15px;
                        font-size: 12px;
                        font-weight: 500;
                    }
                    
                    .action-section {
                        padding: 15px 20px;
                        background: #fefce8;
                        border-top: 1px solid #fde047;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-wrap: wrap;
                        gap: 10px;
                    }
                    .action-hint { font-size: 13px; color: #854d0e; }
                    .action-btn {
                        background: #b8a86b;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 20px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 13px;
                    }
                    .action-btn:hover { background: #d97706; }
                    
                    @media print {
                        .action-section { display: none; }
                        .customer-card { break-inside: avoid; }
                    }
                </style>
                
                <div class="dormant-header">
                    <h2> Dormant Customers Report</h2>
                    <p>Customers with no orders in the last ${dormantThreshold} days  Time to reconnect!</p>
                </div>
                
                <div class="dormant-summary">
                    <div class="dormant-stat">
                        <div class="value">${totalDormant}</div>
                        <div class="label">Dormant Customers</div>
                    </div>
                    <div class="dormant-stat" style="border-top-color: #b88a8a;">
                        <div class="value" style="color: #b88a8a;">${formatMoney(totalAtRisk)}</div>
                        <div class="label"> Revenue at Risk</div>
                    </div>
                    <div class="dormant-stat" style="border-top-color: #7c3aed;">
                        <div class="value" style="color: #7c3aed;">${avgDormantDays}</div>
                        <div class="label"> Avg Days Dormant</div>
                    </div>
                    <div class="dormant-stat" style="border-top-color: #059669;">
                        <div class="value" style="color: #059669;">${highValueDormant}</div>
                        <div class="label"> High Value ($500+)</div>
                    </div>
                </div>
                
                <div class="insight-box">
                    <h3> Sales Call Strategy</h3>
                    <div class="insight-item">
                        <span></span>
                        <span><strong>Review their last order</strong> below before calling - know what they typically buy so you can suggest reorders.</span>
                    </div>
                    <div class="insight-item">
                        <span></span>
                        <span><strong>Prioritize high-value customers</strong> - Sort by "Highest Value First" to focus on your most important relationships.</span>
                    </div>
                    <div class="insight-item">
                        <span></span>
                        <span><strong>Check their order frequency</strong> - If they usually order every 14 days and it's been 30, they're overdue!</span>
                    </div>
                    <div class="insight-item">
                        <span></span>
                        <span><strong>Plan your route</strong> - Sort by City to group nearby customers for efficient in-person visits.</span>
                    </div>
                </div>
            `;
            
            if (customerAnalysis.length === 0) {
                html += `
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 15px;"></div>
                        <h3 style="margin: 0; color: #059669;">Great News!</h3>
                        <p style="color: #666;">No dormant customers in this time period. Everyone's been ordering!</p>
                    </div>
                `;
            } else {
                // Customer detail cards
                html += `<h3 style="margin: 0 0 15px 0; color: #1f2937;"> Customer Details (${customerAnalysis.length} customers)</h3>`;
                
                customerAnalysis.forEach(customer => {
                    const level = getDormancyLevel(customer.daysSinceOrder);
                    
                    // Build contact info section
                    let contactHtml = '';
                    if (customer.phone || customer.mobile) {
                        contactHtml += '<div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 8px;">';
                        if (customer.phone) {
                            contactHtml += `<a href="tel:${customer.phone.replace(/[^0-9+]/g, '')}" style="color: #2563eb; text-decoration: none; font-size: 13px; display: flex; align-items: center; gap: 4px;"> <span style="text-decoration: underline;">${customer.phone}</span></a>`;
                        }
                        if (customer.mobile) {
                            contactHtml += `<a href="tel:${customer.mobile.replace(/[^0-9+]/g, '')}" style="color: #2563eb; text-decoration: none; font-size: 13px; display: flex; align-items: center; gap: 4px;"> <span style="text-decoration: underline;">${customer.mobile}</span></a>`;
                        }
                        contactHtml += '</div>';
                    }
                    if (customer.email) {
                        contactHtml += `<div style="margin-top: 4px;"><a href="mailto:${customer.email}" style="color: #2563eb; text-decoration: none; font-size: 13px; display: flex; align-items: center; gap: 4px;"> <span style="text-decoration: underline;">${customer.email}</span></a></div>`;
                    }
                    
                    html += `
                        <div class="customer-card" style="border-left-color: ${level.color};">
                            <div class="customer-card-header">
                                <div style="flex: 1;">
                                    <div class="customer-name"> ${customer.name}</div>
                                    ${customer.fullAddress ? `
                                        <div style="margin-top: 8px; padding: 10px 12px; background: #f8fafc; border-radius: 8px; border-left: 3px solid #3b82f6;">
                                            <div style="font-size: 12px; color: #64748b; text-transform: uppercase; margin-bottom: 4px; font-weight: 600;"> Delivery Address</div>
                                            <div style="font-size: 14px; color: #1f2937; line-height: 1.5;">
                                                ${customer.address ? customer.address + '<br>' : ''}
                                                ${[customer.city, customer.state].filter(Boolean).join(', ')}${customer.zip ? ' ' + customer.zip : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${contactHtml}
                                </div>
                                <div style="text-align: right;">
                                    <div class="dormancy-badge" style="background: ${level.bg}; color: ${level.color};">
                                        ${level.label}  ${customer.daysSinceOrder} days
                                    </div>
                                    <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                        Last order: ${(customer.lastOrderDate.getMonth()+1) + '/' + customer.lastOrderDate.getDate() + '/' + customer.lastOrderDate.getFullYear()}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="customer-stats">
                                <div class="stat-item">
                                    <div class="stat-value">${formatMoney(customer.totalSpent)}</div>
                                    <div class="stat-label">Lifetime Value</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${customer.totalOrders}</div>
                                    <div class="stat-label">Total Orders</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${formatMoney(customer.avgOrderValue)}</div>
                                    <div class="stat-label">Avg Order</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${customer.orderFrequency > 0 ? customer.orderFrequency + ' days' : 'N/A'}</div>
                                    <div class="stat-label">Order Frequency</div>
                                </div>
                            </div>
                            
                            <div class="last-order-section">
                                <div class="last-order-title"> Last Order (${customer.lastInvoice}) - ${formatMoney(customer.lastOrderTotal)}</div>
                                <div class="last-order-items">
                                    ${customer.lastOrderItems.length > 0 
                                        ? customer.lastOrderItems.map(item => 
                                            `<span class="order-item-chip">${item.qty}x ${item.name}</span>`
                                        ).join('')
                                        : '<span style="color: #666; font-size: 13px;">No line items recorded</span>'
                                    }
                                </div>
                            </div>
                            
                            <div class="action-section">
                                <div class="action-hint">
                                    ${customer.orderFrequency > 0 && customer.daysSinceOrder > customer.orderFrequency * 1.5
                                        ? ` Usually orders every ${customer.orderFrequency} days - ${Math.round(customer.daysSinceOrder / customer.orderFrequency)}x overdue!`
                                        : ` ${customer.totalOrders} orders over their history`
                                    }
                                </div>
                                <button class="action-btn" onclick="createSalesOrderForCustomer('${customer.customerId}')">
                                     New Order
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            return html;
        }
        
        async function generateSimpleInventoryModal() {
            return await generateInventoryReportModal('simple');
        }
        
        // Inventory Adjustments Report
        async function generateInventoryAdjustmentsModal() {
            try {
                console.log(' Loading inventory adjustments report...');
                console.log(' User agent:', navigator.userAgent);
                console.log(' Report filters:', reportFilters);
                
                const [adjustmentsResult, itemsResult] = await Promise.all([
                    apiCall('getInventoryAdjustments'),
                    apiCall('getItems')
                ]);
                
                console.log(' Adjustments API result:', adjustmentsResult);
                console.log(' Items API result:', itemsResult);
                
                if (!adjustmentsResult) {
                    console.error(' adjustmentsResult is null/undefined');
                    return `<h3 style="margin-top: 0;"> Inventory Adjustment History</h3>
                        <div style="background: #ffebee; border: 2px solid #b88a8a; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <p style="color: #c62828; margin: 0;"><strong> Error:</strong> Failed to load adjustments data.</p>
                            <p style="color: #666; font-size: 13px; margin: 10px 0 0 0;">This might be a network issue or the Inventory_Adjustments sheet doesn't exist. Check your Google Sheets.</p>
                        </div>`;
                }
                
                if (!adjustmentsResult?.data) {
                    console.log(' adjustmentsResult.data is undefined');
                    return `<h3 style="margin-top: 0;"> Inventory Adjustment History</h3>
                        <div style="background: #fff3e0; border: 2px solid #b8a86b; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <p style="color: #e65100; margin: 0;"><strong> No Data:</strong> The adjustments table exists but is empty.</p>
                            <p style="color: #666; font-size: 13px; margin: 10px 0 0 0;">Adjustments are logged automatically when:<br>
                             You create sales orders<br>
                             You receive purchase orders<br>
                             You manually adjust inventory</p>
                        </div>`;
                }
                
                const items = itemsResult?.data || [];
                let adjustments = adjustmentsResult.data;
                
                console.log(' Total adjustments retrieved:', adjustments.length);
                if (adjustments.length > 0) {
                    console.log(' Sample adjustment:', adjustments[0]);
                    console.log(' All column names in sample:', Object.keys(adjustments[0]));
                }
                
                // Helper to get item description
                function getItemDesc(itemId) {
                    const item = items.find(i => String(i.Item_ID) === String(itemId));
                    return item ? item.Item_Description : itemId;
                }
                
                function getItemSKU(itemId) {
                    const item = items.find(i => String(i.Item_ID) === String(itemId));
                    return item ? item.SKU : '-';
                }
                
                // More robust date parsing for mobile
                function parseDateSafe(dateVal) {
                    if (!dateVal) return null;
                    if (dateVal instanceof Date) return dateVal;
                    
                    try {
                        // Try standard parsing
                        const d = new Date(dateVal);
                        if (!isNaN(d.getTime())) return d;
                        
                        // Try parsing common formats manually (mobile Safari can be picky)
                        if (typeof dateVal === 'string') {
                            // Handle YYYY-MM-DD format
                            const parts = dateVal.split(/[-/]/);
                            if (parts.length === 3) {
                                const year = parseInt(parts[0]);
                                const month = parseInt(parts[1]) - 1; // JS months are 0-indexed
                                const day = parseInt(parts[2]);
                                const d2 = new Date(year, month, day);
                                if (!isNaN(d2.getTime())) return d2;
                            }
                        }
                        
                        console.warn('Could not parse date:', dateVal);
                        return null;
                    } catch (e) {
                        console.error('Error parsing date:', dateVal, e);
                        return null;
                    }
                }
                
                // Apply date filters with better error handling
                try {
                    if (reportFilters.fromDate && reportFilters.fromDate.trim() !== '') {
                        console.log('Applying fromDate filter:', reportFilters.fromDate);
                        const fromDate = parseLocalDate(reportFilters.fromDate);
                        if (!isNaN(fromDate.getTime())) {
                            fromDate.setHours(0, 0, 0, 0);
                            adjustments = adjustments.filter(a => {
                                const adjDate = parseDateSafe(a.Adjustment_Date || a.Date);
                                return adjDate && adjDate >= fromDate;
                            });
                            console.log('After fromDate filter:', adjustments.length);
                        } else {
                            console.warn('Invalid fromDate:', reportFilters.fromDate);
                        }
                    } else {
                        console.log('No fromDate filter - showing all dates');
                    }
                    
                    if (reportFilters.toDate && reportFilters.toDate.trim() !== '') {
                        console.log('Applying toDate filter:', reportFilters.toDate);
                        const toDate = parseLocalDate(reportFilters.toDate);
                        if (!isNaN(toDate.getTime())) {
                            toDate.setHours(23, 59, 59, 999);
                            adjustments = adjustments.filter(a => {
                                const adjDate = parseDateSafe(a.Adjustment_Date || a.Date);
                                return adjDate && adjDate <= toDate;
                            });
                            console.log('After toDate filter:', adjustments.length);
                        } else {
                            console.warn('Invalid toDate:', reportFilters.toDate);
                        }
                    } else {
                        console.log('No toDate filter - showing all dates');
                    }
                } catch (e) {
                    console.error('Error applying date filters:', e);
                }
                
                // Apply item filter
                if (reportFilters.item) {
                    console.log('Applying item filter:', reportFilters.item);
                    adjustments = adjustments.filter(a => matchesFilter(a.Item_ID, reportFilters.item));
                    console.log('After item filter:', adjustments.length);
                }
                
                // Apply adjustment type filter
                if (reportFilters.adjustmentType) {
                    console.log('Applying adjustment type filter:', reportFilters.adjustmentType);
                    adjustments = adjustments.filter(a => {
                        const reason = String(a.Reason || '').toUpperCase();
                        const filterType = String(reportFilters.adjustmentType).toUpperCase();
                        return reason.includes(filterType);
                    });
                    console.log('After adjustment type filter:', adjustments.length);
                }
                
                console.log('Total adjustments after all filtering:', adjustments.length);
                
                // Sort by date (newest first)
                adjustments.sort((a, b) => {
                    const dateA = parseDateSafe(a.Adjustment_Date || a.Date) || new Date(0);
                    const dateB = parseDateSafe(b.Adjustment_Date || b.Date) || new Date(0);
                    return dateB - dateA;
                });
                
                // Build inline filter summary for oval header
                const filterSummaryInline = generateFilterSummary({ inline: true });
                
                // Calculate summary stats
                let totalPositive = 0, totalNegative = 0;
                const byType = {};
                adjustments.forEach(a => {
                    // Backend column is Quantity_Change
                    const qty = parseFloat(
                        a.Quantity_Change || a.Qty_Change || a.Adjustment || a.Change || 0
                    ) || 0;
                    if (qty > 0) totalPositive += qty;
                    else totalNegative += Math.abs(qty);
                    
                    // Group by reason/type
                    let reason = String(a.Reason || a.Adjustment_Type || 'Other').trim();
                    if (reason.includes('Sale') || reason.includes('SALE')) reason = 'Sales';
                    else if (reason.includes('Purchase') || reason.includes('Received') || reason.includes('PURCHASE')) reason = 'Purchases';
                    else if (reason.includes('VOID')) reason = 'Voids';
                    else if (reason.includes('Manual')) reason = 'Manual';
                    else if (reason.includes('OUTGOING')) reason = 'Outgoing';
                    
                    if (!byType[reason]) byType[reason] = { count: 0, netChange: 0 };
                    byType[reason].count++;
                    byType[reason].netChange += qty;
                });
                
                const chartId = 'adjChart_' + Date.now();
                const typeLabels = Object.keys(byType);
                const typeCounts = typeLabels.map(t => byType[t].count);
                const typeColors = ['#3b82f6', '#10b981', '#b8a86b', '#b88a8a', '#8b5cf6', '#06b6d4'];
                
                let html = `
                    <div style="padding: 25px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                        <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Inventory Adjustment History</h2>
                        <p style="margin: 0 0 ${filterSummaryInline ? '10px' : '0'} 0; font-size: 14px; opacity: 0.95;">${adjustments.length} adjustments | Net change: ${(totalPositive - totalNegative).toLocaleString()} units</p>
                        ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px;">${filterSummaryInline}</div>` : ''}
                    </div>`;
                
                // Summary cards
                html += `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #1565c0;">${adjustments.length}</div>
                            <div style="font-size: 12px; color: #666;">Total Adjustments</div>
                        </div>
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">+${totalPositive.toLocaleString()}</div>
                            <div style="font-size: 12px; color: #666;">Units Added</div>
                        </div>
                        <div style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #c62828;">-${totalNegative.toLocaleString()}</div>
                            <div style="font-size: 12px; color: #666;">Units Removed</div>
                        </div>
                        <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">${(totalPositive - totalNegative).toLocaleString()}</div>
                            <div style="font-size: 12px; color: #666;">Net Change</div>
                        </div>
                    </div>
                `;
                
                if (adjustments.length === 0) {
                    html += `<p style="color: #888; text-align: center; padding: 40px;">No adjustments found for the selected filters.</p>`;
                    return html;
                }
                
                // Chart Section
                if (typeLabels.length > 0) {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                                 style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                                <span class="toggle-icon"></span>
                                <strong> Adjustments by Type</strong>
                                <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                            </div>
                            <div style="margin-top: 15px;">
                                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 350px;">
                                    <canvas id="${chartId}" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <scr` + `ipt>
                            setTimeout(() => {
                                const ctx = document.getElementById('${chartId}');
                                if (ctx) {
                                    if(Chart.getChart(ctx))Chart.getChart(ctx).destroy(); new Chart(ctx, {
                                        type: 'doughnut',
                                        data: {
                                            labels: ['${typeLabels.join("', '")}'],
                                            datasets: [{
                                                data: [${typeCounts.join(', ')}],
                                                backgroundColor: ['${typeColors.slice(0, typeLabels.length).join("', '")}'],
                                                borderWidth: 0
                                            }]
                                        },
                                        options: {
                                            responsive: false, animation: false,
                                            maintainAspectRatio: false,
                                            plugins: {
                                                legend: { position: 'right', labels: { padding: 10, usePointStyle: true, font: { size: 11 } } },
                                                datalabels: {
                                                    display: true,
                                                    color: '#fff',
                                                    font: { weight: 'bold', size: 12 },
                                                    formatter: (value) => value > 0 ? value : ''
                                                }
                                            }
                                        }
                                    });
                                }
                            }, 100);
                        <` + `/script>
                    `;
                }
                
                // Detail Table Section
                html += `
                    <div>
                        <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                             style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                            <span class="toggle-icon"></span>
                            <strong> Detail Table</strong>
                            <span style="color: #666; font-size: 12px;">(${adjustments.length} adjustments - click to hide/show)</span>
                        </div>
                        <div style="margin-top: 15px;">
                `;
                
                html += `<div style="overflow-x: auto; -webkit-overflow-scrolling: touch;"><table class="data-table" style="min-width: 100%; width: auto;">
                    <thead><tr>
                        <th style="white-space: nowrap;">Date</th>
                        <th style="white-space: nowrap;">Item</th>
                        <th style="white-space: nowrap;">SKU</th>
                        <th style="white-space: nowrap;">Reason</th>
                        <th style="text-align: right; white-space: nowrap;">Before</th>
                        <th style="text-align: right; white-space: nowrap;">Change</th>
                        <th style="text-align: right; white-space: nowrap;">After</th>
                        <th style="white-space: nowrap;">Notes</th>
                    </tr></thead><tbody>`;
                
                adjustments.forEach(a => {
                    const adjDate = parseDateSafe(a.Adjustment_Date || a.Date);
                    const dateStr = adjDate ? adjDate.toLocaleDateString() : '-';
                    
                    // Backend columns: Adjustment_ID, Item_ID, Adjustment_Date, Adjustment_Type, Quantity_Change, New_Qty_On_Hand, Reason, User
                    const qtyChange = parseFloat(
                        a.Quantity_Change || a.Qty_Change || a.Adjustment || a.Change || 0
                    ) || 0;
                    
                    // New_Qty_On_Hand is the "after" value - backend doesn't store "before"
                    const qtyAfter = parseFloat(
                        a.New_Qty_On_Hand || a.Qty_After || a.New_Qty || a.After || 0
                    ) || 0;
                    
                    // Calculate "before" from after - change
                    const qtyBefore = qtyAfter - qtyChange;
                    
                    const reason = String(a.Reason || a.Adjustment_Type || '-');
                    const notes = a.User || a.Notes || '';
                    
                    // Color code the reason
                    let reasonBadge = reason;
                    if (reason.includes('VOID')) {
                        reasonBadge = `<span style="background: #ffcdd2; color: #c62828; padding: 2px 8px; border-radius: 10px; font-size: 11px; white-space: nowrap;"> ${reason}</span>`;
                    } else if (reason.includes('Sale') || reason.includes('SALE')) {
                        reasonBadge = `<span style="background: #fff3e0; color: #e65100; padding: 2px 8px; border-radius: 10px; font-size: 11px; white-space: nowrap;"> ${reason}</span>`;
                    } else if (reason.includes('Purchase') || reason.includes('PURCHASE') || reason.includes('Received')) {
                        reasonBadge = `<span style="background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 10px; font-size: 11px; white-space: nowrap;"> ${reason}</span>`;
                    } else if (reason.includes('Manual')) {
                        reasonBadge = `<span style="background: #e3f2fd; color: #1565c0; padding: 2px 8px; border-radius: 10px; font-size: 11px; white-space: nowrap;"> ${reason}</span>`;
                    } else if (reason.includes('OUTGOING')) {
                        reasonBadge = `<span style="background: #f3e5f5; color: #7b1fa2; padding: 2px 8px; border-radius: 10px; font-size: 11px; white-space: nowrap;"> ${reason}</span>`;
                    }
                    
                    html += `<tr>
                        <td style="white-space: nowrap;">${dateStr}</td>
                        <td style="min-width: 150px;">${getItemDesc(a.Item_ID)}</td>
                        <td style="font-family: monospace; font-size: 11px; white-space: nowrap;">${getItemSKU(a.Item_ID)}</td>
                        <td>${reasonBadge}</td>
                        <td style="text-align: right; white-space: nowrap;">${qtyBefore}</td>
                        <td style="text-align: right; font-weight: bold; color: ${qtyChange >= 0 ? '#2e7d32' : '#c62828'}; white-space: nowrap;">
                            ${qtyChange >= 0 ? '+' : ''}${qtyChange}
                        </td>
                        <td style="text-align: right; white-space: nowrap;">${qtyAfter}</td>
                        <td style="max-width: 200px; min-width: 100px; font-size: 11px; color: #666;">${notes}</td>
                    </tr>`;
                });
                
                html += `</tbody></table></div>
                        </div>
                    </div>`;
                
                return html;
                
            } catch (error) {
                console.error('Error in generateInventoryAdjustmentsModal:', error);
                console.error('Error stack:', error.stack);
                return `<h3 style="margin-top: 0;"> Inventory Adjustment History</h3>
                    <div style="background: #ffebee; border: 2px solid #b88a8a; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <p style="color: #c62828; margin: 0;"><strong>Error loading adjustments:</strong></p>
                        <p style="color: #666; font-size: 13px; margin: 10px 0 0 0;">${error.message}</p>
                        <p style="color: #888; font-size: 11px; margin: 10px 0 0 0;">Check browser console (F12) for more details.</p>
                    </div>`;
            }
        }
        
        async function generateInventoryReportModal(type) {
            // Route to appropriate report
            if (type === 'margin') {
                return await generateGrossMarginReport();
            } else {
                return await generateInventoryListReport();
            }
        }
        
        // ========== INVENTORY LIST REPORT ==========
        // Focus: Stock levels, availability, reorder status
        async function generateInventoryListReport() {
            const itemsResult = await apiCall('getItems');
            const suppliersResult = await apiCall('getSuppliers');
            if (!itemsResult?.data) throw new Error('Failed to load items');
            
            let items = itemsResult.data.filter(i => i.Status === 'Active');
            const suppliers = suppliersResult?.data || [];
            
            // Cache suppliers for bulk PO
            cachedSuppliers = suppliers;
            cachedItems = itemsResult.data;
            
            function getSupplierNameLocal(supplierId) {
                const supplier = suppliers.find(s => s.Supplier_ID == supplierId);
                return supplier ? supplier.Supplier_Name : '-';
            }
            
            // Apply filters
            if (reportFilters.supplier) {
                items = items.filter(i => matchesFilter(i.Supplier_ID, reportFilters.supplier));
            }
            if (reportFilters.item) {
                items = items.filter(i => matchesFilter(i.Item_ID, reportFilters.item));
            }
            if (reportFilters.stockStatus) {
                items = items.filter(i => {
                    const qty = parseInt(i.Qty_On_Hand) || 0;
                    const reorder = parseInt(i.Reorder_Point) || 0;
                    switch(reportFilters.stockStatus) {
                        case 'negative': return qty < 0;
                        case 'out': return qty === 0;
                        case 'low': return qty > 0 && qty <= reorder;
                        case 'ok': return qty > reorder;
                        default: return true;
                    }
                });
            }
            
            // Calculate stock health metrics
            let totalQty = 0, totalOnOrder = 0, totalBackorder = 0, totalValue = 0;
            let negativeCount = 0, outOfStockCount = 0, lowStockCount = 0, inStockCount = 0;
            let itemsOnOrderCount = 0, itemsOnBackorderCount = 0;
            
            items.forEach(item => {
                const qty = parseInt(item.Qty_On_Hand) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                const backorder = parseInt(item.Qty_On_Backorder) || 0;
                const reorder = parseInt(item.Reorder_Point) || 0;
                const cost = parseFloat(item.Package_Cost) || 0;
                const units = parseInt(item.Units_Per_Package) || 1;
                const unitCost = cost / units;
                const available = qty - backorder + onOrder;
                
                totalQty += qty;
                totalOnOrder += onOrder;
                totalBackorder += backorder;
                totalValue += Math.abs(qty) * unitCost;
                
                if (onOrder > 0) itemsOnOrderCount++;
                if (backorder > 0) itemsOnBackorderCount++;
                
                if (qty < 0) negativeCount++;
                else if (qty === 0) outOfStockCount++;
                else if (available < reorder && reorder > 0) lowStockCount++;
                else inStockCount++;
            });
            
            const filterSummaryInline = generateFilterSummary({ inline: true });
            
            let html = `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #6b9a8d 0%, #7a9bb8 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(107, 154, 141, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px;"> Inventory List</h2>
                    <p style="margin: 0; font-size: 14px; opacity: 0.95;">${items.length} active items | Stock Health Overview</p>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;">${filterSummaryInline}</div>` : ''}
                </div>
                
                <!-- Stock Health KPIs -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #6b9a8d; text-align: center;">
                        <div style="font-size: 11px; color: #2e7d32; margin-bottom: 5px;"> In Stock</div>
                        <div style="font-size: 24px; font-weight: bold; color: #6b9a8d;">${inStockCount}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, ${lowStockCount > 0 ? '#fff8e1 0%, #ffecb3 100%' : '#f5f5f5 0%, #e5e5e5 100%'}); padding: 15px; border-radius: 8px; border-left: 4px solid ${lowStockCount > 0 ? '#b8a86b' : '#9ca3af'}; text-align: center;">
                        <div style="font-size: 11px; color: ${lowStockCount > 0 ? '#b8a86b' : '#6b7280'}; margin-bottom: 5px;"> Low Stock</div>
                        <div style="font-size: 24px; font-weight: bold; color: ${lowStockCount > 0 ? '#b8a86b' : '#9ca3af'};">${lowStockCount}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, ${outOfStockCount > 0 ? '#ffebee 0%, #ffcdd2 100%' : '#f5f5f5 0%, #e5e5e5 100%'}); padding: 15px; border-radius: 8px; border-left: 4px solid ${outOfStockCount > 0 ? '#b88a8a' : '#9ca3af'}; text-align: center;">
                        <div style="font-size: 11px; color: ${outOfStockCount > 0 ? '#b88a8a' : '#6b7280'}; margin-bottom: 5px;"> Out of Stock</div>
                        <div style="font-size: 24px; font-weight: bold; color: ${outOfStockCount > 0 ? '#b88a8a' : '#9ca3af'};">${outOfStockCount}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, ${negativeCount > 0 ? '#f5eaea 0%, #f0dede 100%' : '#f5f5f5 0%, #e5e5e5 100%'}); padding: 15px; border-radius: 8px; border-left: 4px solid ${negativeCount > 0 ? '#b88a8a' : '#9ca3af'}; text-align: center;">
                        <div style="font-size: 11px; color: ${negativeCount > 0 ? '#b88a8a' : '#6b7280'}; margin-bottom: 5px;"> Negative</div>
                        <div style="font-size: 24px; font-weight: bold; color: ${negativeCount > 0 ? '#b88a8a' : '#9ca3af'};">${negativeCount}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, ${itemsOnOrderCount > 0 ? '#e3f2fd 0%, #bbdefb 100%' : '#f5f5f5 0%, #e5e5e5 100%'}); padding: 15px; border-radius: 8px; border-left: 4px solid ${itemsOnOrderCount > 0 ? '#7a9bb8' : '#9ca3af'}; text-align: center;">
                        <div style="font-size: 11px; color: ${itemsOnOrderCount > 0 ? '#1565c0' : '#6b7280'}; margin-bottom: 5px;"> Items On Order</div>
                        <div style="font-size: 24px; font-weight: bold; color: ${itemsOnOrderCount > 0 ? '#7a9bb8' : '#9ca3af'};">${itemsOnOrderCount}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, ${totalOnOrder > 0 ? '#e3f2fd 0%, #bbdefb 100%' : '#f5f5f5 0%, #e5e5e5 100%'}); padding: 15px; border-radius: 8px; border-left: 4px solid ${totalOnOrder > 0 ? '#7a9bb8' : '#9ca3af'}; text-align: center;">
                        <div style="font-size: 11px; color: ${totalOnOrder > 0 ? '#1565c0' : '#6b7280'}; margin-bottom: 5px;"> Qty On Order</div>
                        <div style="font-size: 24px; font-weight: bold; color: ${totalOnOrder > 0 ? '#7a9bb8' : '#9ca3af'};">${totalOnOrder.toLocaleString()}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, ${totalBackorder > 0 ? '#ffebee 0%, #ffcdd2 100%' : '#f5f5f5 0%, #e5e5e5 100%'}); padding: 15px; border-radius: 8px; border-left: 4px solid ${totalBackorder > 0 ? '#b88a8a' : '#9ca3af'}; text-align: center;">
                        <div style="font-size: 11px; color: ${totalBackorder > 0 ? '#b88a8a' : '#6b7280'}; margin-bottom: 5px;"> On Backorder</div>
                        <div style="font-size: 24px; font-weight: bold; color: ${totalBackorder > 0 ? '#b88a8a' : '#9ca3af'};">${totalBackorder.toLocaleString()}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ede7f6 0%, #d1c4e9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9a8ab8; text-align: center;">
                        <div style="font-size: 11px; color: #5e35b1; margin-bottom: 5px;"> Inv Value</div>
                        <div style="font-size: 20px; font-weight: bold; color: #9a8ab8;">${formatMoney(totalValue)}</div>
                    </div>
                </div>
                
                <!-- Bulk PO Action Bar -->
                <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #6b9a8d; display: flex; flex-wrap: wrap; align-items: center; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;"></span>
                        <strong style="color: #2e7d32;">Bulk Purchase Order</strong>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 13px; color: #333;">Supplier:</label>
                        <select id="invBulkPOSupplier" onchange="filterInventoryBySupplier()" style="padding: 8px 12px; border: 2px solid #6b9a8d; border-radius: 6px; font-size: 13px; min-width: 180px;">
                            <option value="">-- Select Supplier --</option>
                            ${suppliers.map(s => `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`).join('')}
                        </select>
                    </div>
                    <div style="display: flex; gap: 8px; margin-left: auto;">
                        <button onclick="selectAllInventoryItems()" class="oval-action-btn oval-action-primary" style="padding: 8px 16px;"> Select All</button>
                        <button onclick="clearAllInventoryItems()" class="oval-action-btn oval-action-warning" style="padding: 8px 16px;"> Clear</button>
                        <button onclick="createInventoryBulkPO()" class="oval-action-btn oval-action-success" style="padding: 8px 16px; font-weight: 600;"> Create PO</button>
                    </div>
                    <div id="invSelectedCount" style="font-size: 13px; color: #666; width: 100%; margin-top: 5px;">Select a supplier and items to create a purchase order</div>
                </div>
                
                <!-- Detail Table -->
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Item Details</strong>
                        <span style="color: #666; font-size: 12px;">(${items.length} items - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table" id="inventoryListTable">
                            <thead><tr>
                                <th style="width: 40px; text-align: center;">
                                    <input type="checkbox" id="invSelectAllCheckbox" onchange="toggleAllInventoryCheckboxes(this)" style="width: 18px; height: 18px; cursor: pointer;">
                                </th>
                                <th>SKU</th>
                                <th>Description</th>
                                <th>Supplier</th>
                                <th style="text-align: right;">On Hand</th>
                                <th style="text-align: right;">On Order</th>
                                <th style="text-align: right;">Backorder</th>
                                <th style="text-align: right;">Reorder Pt</th>
                                <th style="text-align: center;">Status</th>
                            </tr></thead><tbody>`;
            
            items.forEach(item => {
                const qty = parseInt(item.Qty_On_Hand) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                const backorder = parseInt(item.Qty_On_Backorder) || 0;
                const reorder = parseInt(item.Reorder_Point) || 0;
                const available = qty - backorder + onOrder;
                
                // Determine status
                let status, statusColor, statusBg;
                if (qty < 0) {
                    status = ' Negative'; statusColor = '#be185d'; statusBg = '#fce7f3';
                } else if (qty === 0) {
                    status = ' Out'; statusColor = '#b88a8a'; statusBg = '#fee2e2';
                } else if (available < reorder && reorder > 0) {
                    status = ' Low'; statusColor = '#d97706'; statusBg = '#fef3c7';
                } else {
                    status = ' OK'; statusColor = '#059669'; statusBg = '#ecfdf5';
                }
                
                // Calculate suggested order qty (to reach reorder point + buffer)
                const suggestedQty = Math.max(0, (reorder * 2) - available);
                
                html += `<tr data-supplier-id="${item.Supplier_ID}" data-item-id="${item.Item_ID}">
                    <td style="text-align: center;">
                        <input type="checkbox" class="inv-item-checkbox" 
                               data-item-id="${item.Item_ID}" 
                               data-supplier-id="${item.Supplier_ID}"
                               data-suggested-qty="${suggestedQty}"
                               onchange="updateInventorySelectedCount()"
                               style="width: 18px; height: 18px; cursor: pointer;">
                    </td>
                    <td style="font-weight: 600;">${item.SKU || '-'}</td>
                    <td>${item.Item_Description || '-'}</td>
                    <td style="font-size: 12px; color: #666;">${getSupplierNameLocal(item.Supplier_ID)}</td>
                    <td style="text-align: right; font-weight: 600; color: ${qty <= 0 ? '#b88a8a' : '#333'};">${qty}</td>
                    <td style="text-align: right; color: ${onOrder > 0 ? '#2563eb' : '#999'}; font-weight: ${onOrder > 0 ? '600' : 'normal'};">${onOrder > 0 ? onOrder : '-'}</td>
                    <td style="text-align: right; color: ${backorder > 0 ? '#b88a8a' : '#999'}; font-weight: ${backorder > 0 ? '600' : 'normal'};">${backorder > 0 ? backorder : '-'}</td>
                    <td style="text-align: right; color: #666;">${reorder > 0 ? reorder : '-'}</td>
                    <td style="text-align: center;"><span style="background: ${statusBg}; color: ${statusColor}; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">${status}</span></td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td></td>
                <td colspan="3">TOTALS</td>
                <td style="text-align: right;">${totalQty.toLocaleString()}</td>
                <td style="text-align: right; color: #2563eb;">${totalOnOrder > 0 ? totalOnOrder.toLocaleString() : '-'}</td>
                <td style="text-align: right; color: #b88a8a;">${totalBackorder > 0 ? totalBackorder.toLocaleString() : '-'}</td>
                <td colspan="2"></td>
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            return html;
        }
        
        // Inventory Flow Dashboard Modal Generator
        async function generateInventoryFlowModal() {
            // Load all required data
            await loadReportData();
            
            const items = cachedItems || [];
            const pos = cachedPurchaseOrders || [];
            const suppliers = cachedSuppliers || [];
            
            // Calculate summary metrics
            let totalOnOrder = 0, totalBackorder = 0, totalValue = 0;
            let itemsOnBackorder = [];
            let criticalItems = [];
            
            items.forEach(item => {
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                const backorder = parseInt(item.Qty_On_Backorder) || 0;
                const qtyOnHand = parseInt(item.Qty_On_Hand) || 0;
                const reorderPoint = parseInt(item.Reorder_Point) || 0;
                
                totalOnOrder += onOrder;
                totalBackorder += backorder;
                
                // Only show in backorder section if there's a gap (backorder not covered by on-order)
                if (backorder > 0 && backorder > onOrder) {
                    itemsOnBackorder.push({
                        ...item,
                        backorder,
                        onOrder,
                        qtyOnHand,
                        gap: backorder - onOrder
                    });
                }
                
                // Critical items logic
                const isOutOfStock = qtyOnHand <= 0;
                const isBelowReorderNoOrders = qtyOnHand <= reorderPoint && reorderPoint > 0 && onOrder === 0;
                const hasUnfulfillableBackorder = backorder > 0 && backorder > onOrder;
                
                if (isOutOfStock || isBelowReorderNoOrders || hasUnfulfillableBackorder) {
                    criticalItems.push({
                        ...item,
                        qtyOnHand,
                        onOrder,
                        backorder,
                        reorderPoint,
                        gap: backorder - onOrder,
                        reason: isOutOfStock ? ' OUT OF STOCK' : 
                               isBelowReorderNoOrders ? ' LOW STOCK - NO ORDERS' : ' BACKORDER GAP'
                    });
                }
            });
            
            // Sort backorder items by gap (worst first)
            itemsOnBackorder.sort((a, b) => b.gap - a.gap);
            
            // Sort critical items
            criticalItems.sort((a, b) => {
                if (a.qtyOnHand <= 0 && b.qtyOnHand > 0) return -1;
                if (b.qtyOnHand <= 0 && a.qtyOnHand > 0) return 1;
                return (b.backorder - b.onOrder) - (a.backorder - a.onOrder);
            });
            
            // Pending POs (Ordered status)
            const pendingPOs = pos.filter(po => po.Status === 'Ordered').sort((a, b) => {
                const dateA = new Date(a.Expected_Date || a.PO_Date);
                const dateB = new Date(b.Expected_Date || b.PO_Date);
                return dateA - dateB;
            });
            
            // Calculate pending value
            pendingPOs.forEach(po => {
                totalValue += parseFloat(po.Total_Amount) || 0;
            });
            
            // Count POs expected this week
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            const posThisWeek = pendingPOs.filter(po => {
                const expectedDate = new Date(po.Expected_Date || po.PO_Date);
                return expectedDate >= today && expectedDate <= nextWeek;
            }).length;
            
            // Count critical gap items
            const criticalGapCount = items.filter(item => {
                const backorder = parseInt(item.Qty_On_Backorder) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                return backorder > 0 && backorder > onOrder;
            }).length;
            
            // Build alerts HTML
            let alertsHtml = '';
            if (criticalGapCount > 0 || itemsOnBackorder.length > 0) {
                if (criticalGapCount > 0) {
                    alertsHtml += `
                        <div style="background: #fee2e2; border: 2px solid #b88a8a; border-radius: 12px; padding: 15px; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 28px;"></span>
                                <div>
                                    <strong style="color: #b88a8a;">${criticalGapCount} Item${criticalGapCount > 1 ? 's' : ''} with Backorder Gap!</strong>
                                    <p style="margin: 4px 0 0 0; color: #991b1b; font-size: 13px;">Customer backorders exceed incoming stock</p>
                                </div>
                            </div>
                        </div>`;
                }
                if (itemsOnBackorder.length > 0) {
                    alertsHtml += `
                        <div style="background: #fff3e0; border: 2px solid #f57c00; border-radius: 12px; padding: 15px; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 28px;"></span>
                                <div>
                                    <strong style="color: #e65100;">${itemsOnBackorder.length} Item${itemsOnBackorder.length > 1 ? 's' : ''} on Backorder</strong>
                                    <p style="margin: 4px 0 0 0; color: #bf360c; font-size: 13px;">Customers waiting for ${totalBackorder.toLocaleString()} units</p>
                                </div>
                            </div>
                        </div>`;
                }
            } else {
                alertsHtml = `
                    <div style="background: #e8f5e9; border: 2px solid #6b9a8d; border-radius: 12px; padding: 20px; text-align: center;">
                        <span style="font-size: 36px;"></span>
                        <p style="margin: 10px 0 0 0; color: #2e7d32; font-weight: 600;">All Clear!</p>
                        <p style="margin: 4px 0 0 0; color: #388e3c; font-size: 13px;">No critical inventory alerts</p>
                    </div>`;
            }
            
            // Build HTML
            let html = `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px;"> Inventory Flow Dashboard</h2>
                    <p style="margin: 0; font-size: 14px; opacity: 0.95;">Real-time visibility into inventory movement and stock alerts</p>
                </div>
                
                <!-- Critical Alerts -->
                <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 12px; border: 2px solid #b88a8a;">
                    <h3 style="margin: 0 0 10px 0; color: #b88a8a; display: flex; align-items: center; gap: 8px;">
                         Critical Alerts
                    </h3>
                    <div style="background: #fef2f2; border-radius: 6px; padding: 10px 12px; margin-bottom: 15px; font-size: 12px; color: #7f1d1d; border-left: 3px solid #b88a8a;">
                        <strong> Alert triggers:</strong> Alerts appear when items have <strong>backorder gaps</strong> (customer backorders exceed incoming purchase orders) or when there are <strong>items on backorder</strong> waiting for stock.
                    </div>
                    ${alertsHtml}
                </div>
                
                <!-- Summary Metrics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); border-radius: 12px; border: 2px solid #7a9bb8;">
                        <div style="font-size: 32px; margin-bottom: 8px;"></div>
                        <div style="font-size: 28px; font-weight: bold; color: #5a7a8a;">${totalOnOrder.toLocaleString()}</div>
                        <div style="font-size: 13px; color: #7a9bb8; margin-top: 4px;">Total On Order</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, ${totalBackorder > 0 ? '#fff3e0 0%, #ffe0b2 100%' : '#f5f5f5 0%, #e5e5e5 100%'}); border-radius: 12px; border: 2px solid ${totalBackorder > 0 ? '#f57c00' : '#9ca3af'};">
                        <div style="font-size: 32px; margin-bottom: 8px;"></div>
                        <div style="font-size: 28px; font-weight: bold; color: ${totalBackorder > 0 ? '#e65100' : '#9ca3af'};">${totalBackorder.toLocaleString()}</div>
                        <div style="font-size: 13px; color: ${totalBackorder > 0 ? '#f57c00' : '#9ca3af'}; margin-top: 4px;">Total Backorder</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 12px; border: 2px solid #6b9a8d;">
                        <div style="font-size: 32px; margin-bottom: 8px;"></div>
                        <div style="font-size: 28px; font-weight: bold; color: #4a7a6d;">${posThisWeek}</div>
                        <div style="font-size: 13px; color: #6b9a8d; margin-top: 4px;">POs This Week</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #ede7f6 0%, #d1c4e9 100%); border-radius: 12px; border: 2px solid #9a8ab8;">
                        <div style="font-size: 32px; margin-bottom: 8px;"></div>
                        <div style="font-size: 24px; font-weight: bold; color: #6a5a8a;">${formatMoney(totalValue)}</div>
                        <div style="font-size: 13px; color: #9a8ab8; margin-top: 4px;">Value Pending</div>
                    </div>
                </div>
            `;
            
            // Items On Backorder Section - Card Style with Action Buttons
            html += `
                <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 12px; border: 2px solid #f57c00;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                        <h3 style="margin: 0; color: #f57c00; display: flex; align-items: center; gap: 8px;">
                             Items On Backorder
                            <span style="background: #f57c00; color: white; padding: 2px 10px; border-radius: 12px; font-size: 13px;">${itemsOnBackorder.length}</span>
                        </h3>
                        <button onclick="switchTab('createpo');" class="btn-small" style="background: #f57c00; color: white; font-size: 12px;"> Restock Items</button>
                    </div>
                    <div style="background: #fff8e1; border-radius: 6px; padding: 10px 12px; margin-bottom: 15px; font-size: 12px; color: #6d5200; border-left: 3px solid #f57c00;">
                        <strong> How items appear here:</strong> Items where <strong>Qty_On_Backorder > Qty_On_Order</strong> (backorder not fully covered by incoming POs). When you create a PO that covers the backorder, the item disappears from this list. Gap = Backorder  On Order.
                    </div>`;
            
            if (itemsOnBackorder.length === 0) {
                html += `
                    <div style="text-align: center; padding: 30px; color: #999; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                        <div style="font-size: 16px; color: #666;">No items on backorder</div>
                        <div style="font-size: 14px; color: #999; margin-top: 8px;">All customer orders can be fulfilled!</div>
                    </div>`;
            } else {
                itemsOnBackorder.slice(0, 10).forEach(item => {
                    html += `
                        <div style="padding: 15px; border: 2px solid #ffe0b2; border-radius: 8px; margin-bottom: 10px; background: #fffaf0;">
                            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <div style="font-weight: 600; font-size: 15px; color: #333; margin-bottom: 8px;">${item.Item_Description || item.SKU}</div>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span style="background: ${item.qtyOnHand <= 0 ? '#fee2e2' : '#e8f5e9'}; color: ${item.qtyOnHand <= 0 ? '#b88a8a' : '#2e7d32'}; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                            Stock: ${item.qtyOnHand}
                                        </span>
                                        <span style="background: #e3f2fd; color: #1976d2; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                            On Order: ${item.onOrder}
                                        </span>
                                        <span style="background: #fff3e0; color: #f57c00; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                             Backorder: ${item.backorder}
                                        </span>
                                        ${item.gap > 0 ? `<span style="background: #ffebee; color: #c62828; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;"> Gap: ${item.gap}</span>` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="createPOForItem('${item.Item_ID}', ${item.backorder});" class="btn-small" style="background: #f57c00; color: white; font-size: 11px; padding: 6px 12px;"> CREATE PO</button>
                                    <button onclick="editItemById('${item.Item_ID}');" class="btn-small" style="background: #6b7280; color: white; font-size: 11px; padding: 6px 12px;">View</button>
                                </div>
                            </div>
                        </div>`;
                });
                
                if (itemsOnBackorder.length > 10) {
                    html += `<div style="text-align: center; padding: 10px; color: #666; background: #f8f9fa; border-radius: 6px;">+${itemsOnBackorder.length - 10} more items on backorder</div>`;
                }
            }
            
            html += `</div>`;
            
            // Pending Arrivals Section - Card Style with Action Buttons
            html += `
                <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 12px; border: 2px solid #1976d2;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                        <h3 style="margin: 0; color: #1976d2; display: flex; align-items: center; gap: 8px;">
                             Pending Arrivals
                            <span style="background: #1976d2; color: white; padding: 2px 10px; border-radius: 12px; font-size: 13px;">${pendingPOs.length}</span>
                        </h3>
                        <button onclick="switchTab('purchases');" class="btn-small" style="background: #1976d2; color: white; font-size: 12px;">View All POs</button>
                    </div>
                    <div style="background: #e3f2fd; border-radius: 6px; padding: 10px 12px; margin-bottom: 15px; font-size: 12px; color: #0d47a1; border-left: 3px solid #1976d2;">
                        <strong> How POs appear here:</strong> Purchase Orders with <strong>Status = "Ordered"</strong>. When you create a PO, it starts as "Ordered". Click <strong>Receive</strong> to mark items as received, which updates inventory and changes status to "Received" or "Partial".
                    </div>`;
            
            if (pendingPOs.length === 0) {
                html += `
                    <div style="text-align: center; padding: 30px; color: #999; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                        <div style="font-size: 16px; color: #666;">No pending arrivals</div>
                        <div style="font-size: 14px; color: #999; margin-top: 8px;">No purchase orders expected</div>
                    </div>`;
            } else {
                pendingPOs.slice(0, 10).forEach(po => {
                    const supplier = suppliers.find(s => s.Supplier_ID == po.Supplier_ID);
                    const supplierName = supplier ? supplier.Supplier_Name : po.Supplier_ID;
                    const expectedDate = po.Expected_Date ? formatDateSafe(po.Expected_Date) : 'No date specified';
                    const amount = parseFloat(po.Total_Amount) || 0;
                    
                    html += `
                        <div style="padding: 15px; border: 2px solid #bbdefb; border-radius: 8px; margin-bottom: 10px; background: #f8fbff;">
                            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <div style="font-weight: 600; font-size: 15px; color: #333; margin-bottom: 6px;">PO #${po.PO_Number || po.Invoice_Number || '-'} - ${supplierName}</div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; font-size: 13px; color: #666;">
                                        <span>${expectedDate}</span>
                                        <span style="background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 8px; font-weight: 600;"> ${formatMoney(amount)}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="viewPurchaseOrder('${po.PO_ID}');" class="btn-small" style="background: #1976d2; color: white; font-size: 11px; padding: 6px 12px;">View PO</button>
                                    <button onclick="receivePO('${po.PO_ID}');" class="btn-small" style="background: #6b9a8d; color: white; font-size: 11px; padding: 6px 12px;">Receive</button>
                                </div>
                            </div>
                        </div>`;
                });
                
                if (pendingPOs.length > 10) {
                    html += `<div style="text-align: center; padding: 10px; color: #666; background: #f8f9fa; border-radius: 6px;">+${pendingPOs.length - 10} more pending POs</div>`;
                }
            }
            
            html += `</div>`;
            
            // Critical Items Section - Card Style with Action Buttons
            html += `
                <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 12px; border: 2px solid #b88a8a;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <h3 style="margin: 0; color: #b88a8a; display: flex; align-items: center; gap: 8px;">
                             Critical Items
                            <span style="background: #b88a8a; color: white; padding: 2px 10px; border-radius: 12px; font-size: 13px;">${criticalItems.length}</span>
                        </h3>
                        <button onclick="showReport('simple-inventory');" class="btn-small" style="background: #b88a8a; color: white; font-size: 12px;"> View Report</button>
                    </div>
                    <div style="background: #ffebee; border-radius: 6px; padding: 10px 12px; margin-bottom: 15px; font-size: 12px; color: #7f1d1d; border-left: 3px solid #b88a8a;">
                        <strong> How items appear here:</strong> Items meeting ANY of these conditions: <strong>(1)</strong> Out of stock (Qty  0), <strong>(2)</strong> Below reorder point with no incoming orders (Qty  Reorder_Point AND Qty_On_Order = 0), <strong>(3)</strong> Backorder exceeds on-order (Qty_On_Backorder > Qty_On_Order).
                    </div>`;
            
            if (criticalItems.length === 0) {
                html += `
                    <div style="text-align: center; padding: 30px; color: #999; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                        <div style="font-size: 16px; color: #666;">No critical items</div>
                        <div style="font-size: 14px; color: #999; margin-top: 8px;">All items have adequate stock levels</div>
                    </div>`;
            } else {
                criticalItems.slice(0, 10).forEach(item => {
                    html += `
                        <div style="padding: 15px; border: 2px solid #ffcdd2; border-radius: 8px; margin-bottom: 10px; background: #fff5f5;">
                            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <div style="font-weight: 600; font-size: 15px; color: #333; margin-bottom: 4px;">${item.Item_Description || item.SKU}</div>
                                    <div style="font-size: 12px; color: #b88a8a; font-weight: 600; margin-bottom: 8px;">${item.reason}</div>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span style="background: ${item.qtyOnHand <= 0 ? '#fee2e2' : '#fff3e0'}; color: ${item.qtyOnHand <= 0 ? '#b88a8a' : '#f57c00'}; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                            Stock: ${item.qtyOnHand}
                                        </span>
                                        <span style="background: #f3f4f6; color: #6b7280; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                                            Reorder: ${item.reorderPoint}
                                        </span>
                                        ${item.backorder > 0 ? `<span style="background: #fff3e0; color: #f57c00; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">Backorder: ${item.backorder}</span>` : ''}
                                        ${item.gap > 0 ? `<span style="background: #ffebee; color: #c62828; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">GAP: -${item.gap}!</span>` : ''}
                                    </div>
                                </div>
                                <div>
                                    <button onclick="createPOForItem('${item.Item_ID}', ${Math.max(item.backorder, item.reorderPoint - item.qtyOnHand)});" class="btn-small" style="background: #b88a8a; color: white; font-size: 11px; padding: 6px 12px;"> ORDER MORE!</button>
                                </div>
                            </div>
                        </div>`;
                });
                
                if (criticalItems.length > 10) {
                    html += `<div style="text-align: center; padding: 10px; color: #666; background: #f8f9fa; border-radius: 6px;">+${criticalItems.length - 10} more critical items</div>`;
                }
            }
            
            html += `</div>`;
            
            return html;
        }
        
        
        // Inventory List Bulk PO helper functions
        function filterInventoryBySupplier() {
            const supplierId = document.getElementById('invBulkPOSupplier')?.value || '';
            const rows = document.querySelectorAll('#inventoryListTable tbody tr');
            
            rows.forEach(row => {
                const rowSupplierId = row.dataset.supplierId;
                if (!supplierId || rowSupplierId === supplierId) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                    // Uncheck hidden items
                    const checkbox = row.querySelector('.inv-item-checkbox');
                    if (checkbox) checkbox.checked = false;
                }
            });
            
            updateInventorySelectedCount();
        }
        
        function selectAllInventoryItems() {
            const supplierId = document.getElementById('invBulkPOSupplier')?.value || '';
            if (!supplierId) {
                showWarning('Please select a supplier first');
                return;
            }
            
            const checkboxes = document.querySelectorAll('.inv-item-checkbox');
            checkboxes.forEach(cb => {
                if (cb.dataset.supplierId === supplierId) {
                    cb.checked = true;
                }
            });
            updateInventorySelectedCount();
        }
        
        function clearAllInventoryItems() {
            const checkboxes = document.querySelectorAll('.inv-item-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('invSelectAllCheckbox').checked = false;
            updateInventorySelectedCount();
        }
        
        function toggleAllInventoryCheckboxes(masterCheckbox) {
            const supplierId = document.getElementById('invBulkPOSupplier')?.value || '';
            const checkboxes = document.querySelectorAll('.inv-item-checkbox');
            
            checkboxes.forEach(cb => {
                const row = cb.closest('tr');
                if (row.style.display !== 'none') {
                    if (!supplierId || cb.dataset.supplierId === supplierId) {
                        cb.checked = masterCheckbox.checked;
                    }
                }
            });
            updateInventorySelectedCount();
        }
        
        function updateInventorySelectedCount() {
            const checkboxes = document.querySelectorAll('.inv-item-checkbox:checked');
            const countDiv = document.getElementById('invSelectedCount');
            
            if (checkboxes.length === 0) {
                countDiv.textContent = 'Select a supplier and items to create a purchase order';
                countDiv.style.color = '#666';
            } else {
                // Check if all from same supplier
                const suppliers = new Set();
                checkboxes.forEach(cb => suppliers.add(cb.dataset.supplierId));
                
                if (suppliers.size > 1) {
                    countDiv.innerHTML = `<span style="color: #b88a8a;"> ${checkboxes.length} items selected from ${suppliers.size} different suppliers - select items from ONE supplier only</span>`;
                } else {
                    const supplierName = getSupplierName(Array.from(suppliers)[0]);
                    countDiv.innerHTML = `<span style="color: #6b9a8d;"> ${checkboxes.length} item(s) selected from <strong>${supplierName}</strong></span>`;
                }
            }
        }
        
        function createInventoryBulkPO() {
            const checkboxes = document.querySelectorAll('.inv-item-checkbox:checked');
            
            if (checkboxes.length === 0) {
                showWarning('Please select items to order first.\n\nUse the checkboxes next to each item.');
                return;
            }
            
            // Get selected items
            const selectedItems = Array.from(checkboxes).map(cb => ({
                itemId: cb.dataset.itemId,
                supplierId: cb.dataset.supplierId,
                suggestedQty: parseInt(cb.dataset.suggestedQty) || 1
            }));
            
            // Check if all from same supplier
            const suppliers = [...new Set(selectedItems.map(i => i.supplierId))];
            
            if (suppliers.length > 1) {
                const supplierNames = suppliers.map(supId => {
                    const sup = (cachedSuppliers || []).find(s => s.Supplier_ID === supId);
                    const itemCount = selectedItems.filter(i => i.supplierId === supId).length;
                    return ` ${sup?.Supplier_Name || 'Unknown'}: ${itemCount} item${itemCount > 1 ? 's' : ''}`;
                }).join('<br>');
                
                showError(`Cannot create a single PO with items from multiple suppliers!<br><br>You selected items from ${suppliers.length} different suppliers:<br><br>${supplierNames}<br><br>Please filter by supplier first, or select items from a single supplier.`);
                return;
            }
            
            // Get item details
            const items = selectedItems.map(sel => {
                const item = (cachedItems || []).find(i => i.Item_ID === sel.itemId);
                if (item) {
                    return { ...item, _suggestedQty: sel.suggestedQty };
                }
                return null;
            }).filter(Boolean);
            
            if (items.length === 0) {
                showError('Could not find selected items. Please refresh and try again.');
                return;
            }
            
            // Build bulk PO modal (same as Critical Items report)
            const supplierId = suppliers[0];
            const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === supplierId);
            const supplierName = supplier?.Supplier_Name || 'Unknown Supplier';
            
            // Build line items HTML
            let lineItemsHtml = '';
            let grandTotal = 0;
            
            items.forEach((item, index) => {
                const cost = parseFloat(item.Package_Cost) || 0;
                const units = parseInt(item.Units_Per_Package) || 1;
                const suggestedUnits = item._suggestedQty || 1;
                const casesNeeded = Math.max(1, Math.ceil(suggestedUnits / units));
                const lineTotal = casesNeeded * cost;
                grandTotal += lineTotal;
                
                lineItemsHtml += `
                    <tr data-item-id="${item.Item_ID}" data-cost="${cost}" data-units="${units}">
                        <td style="font-size: 13px;">${item.SKU || ''}</td>
                        <td style="font-size: 12px;">${item.Item_Description?.substring(0, 30) || ''}</td>
                        <td style="text-align: center;">
                            <input type="number" class="bulk-po-qty" value="${casesNeeded}" min="1" 
                                   onchange="updateBulkPOLine(this)" 
                                   style="width: 60px; padding: 6px; text-align: center; border: 2px solid #6b9a8d; border-radius: 4px; font-weight: bold;">
                        </td>
                        <td style="text-align: center; color: #666;">${units}</td>
                        <td style="text-align: center; color: #6b9a8d; font-weight: 600;">$${cost.toFixed(2)}</td>
                        <td style="text-align: right; font-weight: 600;" class="bulk-line-total">$${lineTotal.toFixed(2)}</td>
                        <td style="text-align: center;">
                            <button type="button" onclick="removeBulkPOLine(this)" style="background: #b88a8a; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;"></button>
                        </td>
                    </tr>
                `;
            });
            
            // Show Bulk PO Modal
            const modalHtml = `
                <div id="bulkPOModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;">
                    <div style="background: white; border-radius: 16px; padding: 25px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #6b9a8d; padding-bottom: 15px;">
                            <h2 style="margin: 0; color: #6b9a8d;"> Create Purchase Order (${items.length} items)</h2>
                            <button onclick="closeBulkPOModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;"></button>
                        </div>
                        
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #6b9a8d;">
                            <div style="font-weight: 600; color: #2e7d32;"> Supplier: ${supplierName}</div>
                        </div>
                        
                        <form id="bulkPOForm" onsubmit="submitBulkPO(event, '${supplierId}')">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 5px;"> Order Date <span style="color: #b88a8a;">*</span></label>
                                    <input type="date" id="bulkPODate" value="${getTodayLocalDate()}" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                                </div>
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 5px;"> Expected Arrival <span style="color: #b88a8a;">*</span></label>
                                    <input type="date" id="bulkPOExpected" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                                </div>
                            </div>
                            
                            <div style="overflow-x: auto; margin-bottom: 15px;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 14px;" id="bulkPOTable">
                                    <thead>
                                        <tr style="background: #6b9a8d; color: white;">
                                            <th style="padding: 10px; text-align: left;">SKU</th>
                                            <th style="padding: 10px; text-align: left;">Description</th>
                                            <th style="padding: 10px; text-align: center;">Cases</th>
                                            <th style="padding: 10px; text-align: center;">Units/Pkg</th>
                                            <th style="padding: 10px; text-align: center;">Cost</th>
                                            <th style="padding: 10px; text-align: right;">Total</th>
                                            <th style="padding: 10px; width: 40px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${lineItemsHtml}
                                    </tbody>
                                    <tfoot>
                                        <tr style="background: #f8f9fa; font-weight: bold;">
                                            <td colspan="5" style="padding: 12px; text-align: right;">Grand Total:</td>
                                            <td style="padding: 12px; text-align: right; font-size: 18px; color: #6b9a8d;" id="bulkPOGrandTotal">$${grandTotal.toFixed(2)}</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="font-weight: 600; display: block; margin-bottom: 5px;"> Notes (optional)</label>
                                <textarea id="bulkPONotes" rows="2" placeholder="Special instructions..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" onclick="closeBulkPOModal()" style="padding: 12px 24px; background: #8a8a8a; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Cancel</button>
                                <button type="submit" style="padding: 12px 24px; background: #6b9a8d; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;"> Create Purchase Order</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Add modal to page
            const modalContainer = document.createElement('div');
            modalContainer.id = 'bulkPOModalContainer';
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
        }
        
        // ========== GROSS MARGIN ANALYSIS REPORT ==========
        // Focus: Profitability, margin analysis, cost vs sell
        async function generateGrossMarginReport() {
            const itemsResult = await apiCall('getItems');
            const suppliersResult = await apiCall('getSuppliers');
            if (!itemsResult?.data) throw new Error('Failed to load items');
            
            let items = itemsResult.data.filter(i => i.Status === 'Active');
            const suppliers = suppliersResult?.data || [];
            
            // Load sales data for actual margin calculation
            await loadReportData();
            let sales = cachedSalesOrders.filter(so => so.Status !== 'Voided');
            
            // Apply date filters to sales
            if (reportFilters.fromDate && reportFilters.fromDate.trim() !== '') {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                if (!isNaN(fromDate.getTime())) {
                    fromDate.setHours(0, 0, 0, 0);
                    sales = sales.filter(s => {
                        const saleDate = parseDateSafe(s.Sale_Date || s.SO_Date);
                        return saleDate && saleDate >= fromDate;
                    });
                }
            }
            if (reportFilters.toDate && reportFilters.toDate.trim() !== '') {
                const toDate = parseLocalDate(reportFilters.toDate);
                if (!isNaN(toDate.getTime())) {
                    toDate.setHours(23, 59, 59, 999);
                    sales = sales.filter(s => {
                        const saleDate = parseDateSafe(s.Sale_Date || s.SO_Date);
                        return saleDate && saleDate <= toDate;
                    });
                }
            }
            
            // Calculate actual sales metrics (list price vs actual price)
            // Uses stored Unit_Cost from SO line if available (accurate historical cost)
            // Falls back to current item cost for older orders without stored cost
            let actualSalesTotal = 0, listPriceTotal = 0, actualCostTotal = 0;
            for (const so of sales) {
                const lines = getSalesLinesFromCache(so.SO_ID);
                lines.forEach(line => {
                    const qty = parseInt(line.Quantity) || 0;
                    const unitPrice = parseFloat(line.Unit_Price) || 0;
                    const item = items.find(i => i.Item_ID === line.Item_ID);
                    const listPrice = parseFloat(item?.Unit_Sell_Price) || 0;
                    
                    // Use stored Unit_Cost if available (accurate at time of sale)
                    // Fall back to current item cost for historical data
                    let unitCost;
                    const storedUnitCost = parseFloat(line.Unit_Cost);
                    if (!isNaN(storedUnitCost) && storedUnitCost > 0) {
                        unitCost = storedUnitCost;
                    } else {
                        // Fall back to current item cost
                        const unitsPerPkg = parseFloat(item?.Units_Per_Package) || 1;
                        const pkgCost = parseFloat(item?.Package_Cost) || 0;
                        unitCost = pkgCost / unitsPerPkg;
                    }
                    
                    // Apply supplier filter if set
                    if (reportFilters.supplier && item?.Supplier_ID !== reportFilters.supplier) {
                        return; // Skip this line
                    }
                    
                    actualSalesTotal += qty * unitPrice;
                    listPriceTotal += qty * listPrice;
                    actualCostTotal += qty * unitCost;
                });
            }
            
            const totalDiscount = listPriceTotal - actualSalesTotal;
            const actualProfit = actualSalesTotal - actualCostTotal;
            const listProfit = listPriceTotal - actualCostTotal;
            const actualMargin = actualSalesTotal > 0 ? (actualProfit / actualSalesTotal * 100) : 0;
            const listMargin = listPriceTotal > 0 ? (listProfit / listPriceTotal * 100) : 0;
            const marginLost = listMargin - actualMargin;
            const profitLost = listProfit - actualProfit;
            
            function getSupplierNameLocal(supplierId) {
                const supplier = suppliers.find(s => s.Supplier_ID == supplierId);
                return supplier ? supplier.Supplier_Name : '-';
            }
            
            // Apply supplier filter
            if (reportFilters.supplier) {
                items = items.filter(i => matchesFilter(i.Supplier_ID, reportFilters.supplier));
            }
            
            // Calculate margin metrics (for inventory/catalog analysis)
            let totalCostValue = 0, totalSellValue = 0;
            let highMarginCount = 0, medMarginCount = 0, lowMarginCount = 0, negMarginCount = 0;
            const marginData = [];
            
            items.forEach(item => {
                const qty = parseInt(item.Qty_On_Hand) || 0;
                const cost = parseFloat(item.Package_Cost) || 0;
                const sell = parseFloat(item.Unit_Sell_Price) || parseFloat(item.Sell_Price) || 0;
                const units = parseInt(item.Units_Per_Package) || 1;
                const unitCost = cost / units;
                const margin = sell > 0 ? ((sell - unitCost) / sell * 100) : 0;
                const profit = sell - unitCost;
                
                totalCostValue += Math.abs(qty) * unitCost;
                totalSellValue += Math.abs(qty) * sell;
                
                if (margin >= 30) highMarginCount++;
                else if (margin >= 20) medMarginCount++;
                else if (margin >= 0) lowMarginCount++;
                else negMarginCount++;
                
                if (sell > 0) {
                    marginData.push({
                        sku: item.SKU || '-',
                        name: item.Item_Description || '-',
                        shortName: (item.Item_Description || item.SKU || '-').substring(0, 20),
                        supplier: getSupplierNameLocal(item.Supplier_ID),
                        unitCost: unitCost,
                        sell: sell,
                        margin: margin,
                        profit: profit,
                        value: Math.abs(qty) * unitCost
                    });
                }
            });
            
            const avgMargin = totalSellValue > 0 ? ((totalSellValue - totalCostValue) / totalSellValue * 100) : 0;
            const totalProfit = totalSellValue - totalCostValue;
            
            // Sort for charts
            marginData.sort((a, b) => b.margin - a.margin);
            const top10Margins = marginData.slice(0, 10);
            const bottom5Margins = marginData.slice(-5).reverse();
            
            const filterSummaryInline = generateFilterSummary({ inline: true });
            const topChartId = 'marginTopChart_' + Date.now();
            const bottomChartId = 'marginBottomChart_' + Date.now();
            const pieChartId = 'marginPieChart_' + Date.now();
            const histogramChartId = 'marginHistogram_' + Date.now();
            const scatterChartId = 'marginScatter_' + Date.now();
            const paretoChartId = 'marginPareto_' + Date.now();
            
            // Prepare histogram data (margin distribution in 5% buckets)
            const histogramBuckets = {};
            for (let i = 0; i <= 60; i += 5) {
                histogramBuckets[i] = 0;
            }
            marginData.forEach(item => {
                const bucket = Math.floor(item.margin / 5) * 5;
                const key = Math.min(Math.max(bucket, 0), 60);
                histogramBuckets[key] = (histogramBuckets[key] || 0) + 1;
            });
            const histogramLabels = Object.keys(histogramBuckets).map(k => k + '-' + (parseInt(k) + 5) + '%');
            const histogramValues = Object.values(histogramBuckets);
            
            // Prepare Pareto data (top 10 by profit contribution)
            const profitSorted = [...marginData].sort((a, b) => b.profit - a.profit);
            const top10Profit = profitSorted.slice(0, 10);
            const totalProfitAll = marginData.reduce((sum, item) => sum + Math.max(0, item.profit), 0);
            let cumulativePct = 0;
            const paretoCumulative = top10Profit.map(item => {
                cumulativePct += (item.profit / totalProfitAll) * 100;
                return Math.min(cumulativePct, 100);
            });
            
            let html = `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #6b9a8d 0%, #8a9a6b 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(107, 154, 141, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px;"> Gross Margin Analysis</h2>
                    <p style="margin: 0; font-size: 14px; opacity: 0.95;">${items.length} items | ${sales.length} orders analyzed${totalDiscount > 0 ? ' | ' + formatMoney(totalDiscount) + ' in discounts' : ''}</p>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;">${filterSummaryInline}</div>` : ''}
                </div>
                
                <!-- Actual Sales Margin Comparison -->
                ${sales.length > 0 ? `
                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 2px solid #dee2e6;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #495057; display: flex; align-items: center; gap: 8px;">
                        <span></span> Actual Sales Margin Analysis
                        <span style="font-size: 12px; font-weight: normal; color: #6c757d;">(${sales.length} orders)</span>
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                        <!-- At List Price -->
                        <div style="background: white; border-radius: 10px; padding: 15px; border-left: 4px solid #b8a86b; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="font-size: 11px; color: #6c757d; margin-bottom: 3px; text-transform: uppercase;"> At List Price</div>
                            <div style="font-size: 24px; font-weight: bold; color: #b8a86b;">${listMargin.toFixed(1)}%</div>
                            <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                                Revenue: ${formatMoney(listPriceTotal)}<br>
                                Profit: ${formatMoney(listProfit)}
                            </div>
                        </div>
                        <!-- At Actual Price -->
                        <div style="background: white; border-radius: 10px; padding: 15px; border-left: 4px solid #6b9a8d; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="font-size: 11px; color: #6c757d; margin-bottom: 3px; text-transform: uppercase;"> At Actual Price</div>
                            <div style="font-size: 24px; font-weight: bold; color: #6b9a8d;">${actualMargin.toFixed(1)}%</div>
                            <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                                Revenue: ${formatMoney(actualSalesTotal)}<br>
                                Profit: ${formatMoney(actualProfit)}
                            </div>
                        </div>
                        <!-- Discount Impact -->
                        <div style="background: ${totalDiscount > 0 ? 'linear-gradient(135deg, #fff5f5 0%, #ffe3e3 100%)' : 'white'}; border-radius: 10px; padding: 15px; border-left: 4px solid ${totalDiscount > 0 ? '#b88a8a' : '#6c757d'}; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="font-size: 11px; color: #6c757d; margin-bottom: 3px; text-transform: uppercase;"> Discount Impact</div>
                            <div style="font-size: 24px; font-weight: bold; color: ${totalDiscount > 0 ? '#b88a8a' : '#6c757d'};">${totalDiscount > 0 ? '-' : ''}${formatMoney(totalDiscount)}</div>
                            <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                                Margin Lost: ${marginLost.toFixed(1)}%<br>
                                Profit Lost: ${formatMoney(profitLost)}
                            </div>
                        </div>
                        <!-- Cost Basis -->
                        <div style="background: white; border-radius: 10px; padding: 15px; border-left: 4px solid #9a8ab8; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="font-size: 11px; color: #6c757d; margin-bottom: 3px; text-transform: uppercase;"> Cost of Goods</div>
                            <div style="font-size: 24px; font-weight: bold; color: #9a8ab8;">${formatMoney(actualCostTotal)}</div>
                            <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                                Base cost for<br>
                                all ${sales.length} orders
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <!-- Inventory/Catalog Profitability KPIs -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #6b9a8d;">
                        <div style="font-size: 11px; color: #2e7d32; margin-bottom: 5px;"> Catalog Avg Margin</div>
                        <div style="font-size: 26px; font-weight: bold; color: #6b9a8d;">${avgMargin.toFixed(1)}%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b8a86b;">
                        <div style="font-size: 11px; color: #b8a86b; margin-bottom: 5px;"> Inventory Cost</div>
                        <div style="font-size: 22px; font-weight: bold; color: #a09050;">${formatMoney(totalCostValue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ede7f6 0%, #d1c4e9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9a8ab8;">
                        <div style="font-size: 11px; color: #7e57c2; margin-bottom: 5px;"> Retail Value</div>
                        <div style="font-size: 22px; font-weight: bold; color: #9a8ab8;">${formatMoney(totalSellValue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #c48a9a;">
                        <div style="font-size: 11px; color: #ad1457; margin-bottom: 5px;"> Potential Profit</div>
                        <div style="font-size: 22px; font-weight: bold; color: #c48a9a;">${formatMoney(totalProfit)}</div>
                    </div>
                </div>
                
                <!-- Margin Distribution with Pie Chart -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: stretch;">
                    <div style="flex: 1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                        <div style="background: #dcfce7; padding: 20px 15px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; justify-content: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #6b9a8d;">${highMarginCount}</div>
                            <div style="font-size: 11px; color: #15803d; margin-top: 5px;">High (30%)</div>
                        </div>
                        <div style="background: #fef9c3; padding: 20px 15px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; justify-content: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #ca8a04;">${medMarginCount}</div>
                            <div style="font-size: 11px; color: #a16207; margin-top: 5px;">Medium (20-30%)</div>
                        </div>
                        <div style="background: #fed7aa; padding: 20px 15px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; justify-content: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #ea580c;">${lowMarginCount}</div>
                            <div style="font-size: 11px; color: #c2410c; margin-top: 5px;">Low (0-20%)</div>
                        </div>
                        <div style="background: ${negMarginCount > 0 ? '#fecaca' : '#f5f5f5'}; padding: 20px 15px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; justify-content: center;">
                            <div style="font-size: 28px; font-weight: bold; color: ${negMarginCount > 0 ? '#b88a8a' : '#999'};">${negMarginCount}</div>
                            <div style="font-size: 11px; color: ${negMarginCount > 0 ? '#b91c1c' : '#666'}; margin-top: 5px;">Negative</div>
                        </div>
                    </div>
                    <div style="flex: 0 0 140px; background: white; border-radius: 12px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;">
                        <canvas id="${pieChartId}" width="120" height="120"></canvas>
                    </div>
                </div>
                
                <scr` + `ipt>
                    setTimeout(() => {
                        const pieCtx = document.getElementById('${pieChartId}');
                        if (pieCtx) {
                            if(Chart.getChart(pieCtx)) Chart.getChart(pieCtx).destroy();
                            new Chart(pieCtx, {
                                type: 'doughnut',
                                data: {
                                    labels: ['High (30%)', 'Medium (20-30%)', 'Low (0-20%)'${negMarginCount > 0 ? ", 'Negative'" : ''}],
                                    datasets: [{
                                        data: [${highMarginCount}, ${medMarginCount}, ${lowMarginCount}${negMarginCount > 0 ? `, ${negMarginCount}` : ''}],
                                        backgroundColor: ['#6b9a8d', '#b8a86b', '#b8a07a'${negMarginCount > 0 ? ", '#b88a8a'" : ''}],
                                        borderWidth: 2,
                                        borderColor: '#fff'
                                    }]
                                },
                                options: {
                                    responsive: false,
                                    animation: false,
                                    plugins: {
                                        legend: { display: false },
                                        datalabels: {
                                            color: '#fff',
                                            font: { weight: 'bold', size: 11 },
                                            formatter: (value, ctx) => {
                                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                                const pct = total > 0 ? Math.round((value / total) * 100) : 0;
                                                return pct > 5 ? pct + '%' : '';
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
                
                <!-- Margin Charts -->
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'grid' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Margin Charts</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #6b9a8d;"> Top 10 Margins</h4>
                            <canvas id="${topChartId}" height="220"></canvas>
                        </div>
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #b88a8a;"> Bottom 5 Margins</h4>
                            <canvas id="${bottomChartId}" height="220"></canvas>
                        </div>
                    </div>
                </div>
                
                <scr` + `ipt>
                    setTimeout(() => {
                        const ctx1 = document.getElementById('${topChartId}');
                        if (ctx1) {
                            if(Chart.getChart(ctx1))Chart.getChart(ctx1).destroy(); new Chart(ctx1, {
                                type: 'bar',
                                data: {
                                    labels: [${top10Margins.map(d => `'${d.shortName.replace(/'/g, "\\'")}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Margin %',
                                        data: [${top10Margins.map(d => d.margin.toFixed(1)).join(', ')}],
                                        backgroundColor: '#6b9a8d',
                                        borderRadius: 6
                                    }]
                                },
                                options: {
                                    indexAxis: 'y',
                                    responsive: false, 
                                    animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        datalabels: {
                                            display: true,
                                            color: '#fff',
                                            font: { weight: 'bold', size: 11 },
                                            anchor: 'end',
                                            align: 'start',
                                            formatter: (value) => Math.round(value) + '%'
                                        }
                                    },
                                    scales: { 
                                        x: { beginAtZero: true, max: 100, ticks: { callback: (val) => val + '%' } },
                                        y: { ticks: { font: { size: 10 } } }
                                    }
                                }
                            });
                        }
                        const ctx2 = document.getElementById('${bottomChartId}');
                        if (ctx2) {
                            if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                type: 'bar',
                                data: {
                                    labels: [${bottom5Margins.map(d => `'${d.shortName.replace(/'/g, "\\'")}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Margin %',
                                        data: [${bottom5Margins.map(d => d.margin.toFixed(1)).join(', ')}],
                                        backgroundColor: [${bottom5Margins.map(d => d.margin < 10 ? "'#b88a8a'" : d.margin < 20 ? "'#b8a86b'" : "'#6b9a8d'").join(', ')}],
                                        borderRadius: 6
                                    }]
                                },
                                options: {
                                    indexAxis: 'y',
                                    responsive: false, 
                                    animation: false,
                                    maintainAspectRatio: false,
                                    plugins: { 
                                        legend: { display: false },
                                        datalabels: {
                                            display: true,
                                            color: '#fff',
                                            font: { weight: 'bold', size: 11 },
                                            anchor: 'end',
                                            align: 'start',
                                            formatter: (value) => Math.round(value) + '%'
                                        }
                                    },
                                    scales: { 
                                        x: { beginAtZero: true, max: 100, ticks: { callback: (val) => val + '%' } },
                                        y: { ticks: { font: { size: 10 } } }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
                
                <!-- Advanced Analysis Charts -->
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Advanced Analysis</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <!-- Top row: Histogram and Scatter -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <!-- Histogram -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 5px 0; color: #6366f1;"> Margin Distribution</h4>
                                <p style="margin: 0 0 15px 0; font-size: 11px; color: #666;">How margins are spread across items</p>
                                <canvas id="${histogramChartId}" height="200"></canvas>
                            </div>
                            <!-- Scatter Plot -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 5px 0; color: #8b5cf6;"> Cost vs Price Analysis</h4>
                                <p style="margin: 0 0 15px 0; font-size: 11px; color: #666;">Bubble size = profit per unit</p>
                                <canvas id="${scatterChartId}" height="200"></canvas>
                            </div>
                        </div>
                        <!-- Full width: Pareto Chart -->
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 5px 0; color: #ec4899;"> Pareto: Top Profit Contributors</h4>
                            <p style="margin: 0 0 15px 0; font-size: 11px; color: #666;">Items driving most of your profit (80/20 rule)</p>
                            <div style="height: 280px;"><canvas id="${paretoChartId}"></canvas></div>
                        </div>
                    </div>
                </div>
                
                <scr` + `ipt>
                    setTimeout(() => {
                        // Histogram Chart
                        const histCtx = document.getElementById('${histogramChartId}');
                        if (histCtx) {
                            if(Chart.getChart(histCtx)) Chart.getChart(histCtx).destroy();
                            new Chart(histCtx, {
                                type: 'bar',
                                data: {
                                    labels: [${histogramLabels.map(l => `'${l}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Items',
                                        data: [${histogramValues.join(', ')}],
                                        backgroundColor: [${histogramLabels.map((l, i) => {
                                            const val = parseInt(l);
                                            if (val >= 30) return "'#6b9a8d'";
                                            if (val >= 20) return "'#b8a86b'";
                                            if (val >= 0) return "'#b8a07a'";
                                            return "'#b88a8a'";
                                        }).join(', ')}],
                                        borderRadius: 4
                                    }]
                                },
                                options: {
                                    responsive: false,
                                    animation: false,
                                    plugins: {
                                        legend: { display: false },
                                        datalabels: {
                                            display: true,
                                            color: '#374151',
                                            anchor: 'end',
                                            align: 'top',
                                            font: { size: 10, weight: 'bold' },
                                            formatter: (val) => val > 0 ? val : ''
                                        }
                                    },
                                    scales: {
                                        y: { beginAtZero: true, title: { display: true, text: '# Items', font: { size: 10 } } },
                                        x: { title: { display: true, text: 'Margin Range', font: { size: 10 } } }
                                    }
                                }
                            });
                        }
                        
                        // Scatter Plot
                        const scatterCtx = document.getElementById('${scatterChartId}');
                        if (scatterCtx) {
                            if(Chart.getChart(scatterCtx)) Chart.getChart(scatterCtx).destroy();
                            const scatterData = [${marginData.slice(0, 50).map(d => `{x: ${d.unitCost.toFixed(2)}, y: ${d.sell.toFixed(2)}, r: ${Math.max(3, Math.min(15, d.profit * 3))}}`).join(', ')}];
                            new Chart(scatterCtx, {
                                type: 'bubble',
                                data: {
                                    datasets: [{
                                        label: 'Items',
                                        data: scatterData,
                                        backgroundColor: 'rgba(139, 92, 246, 0.6)',
                                        borderColor: 'rgba(139, 92, 246, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: false,
                                    animation: false,
                                    plugins: {
                                        legend: { display: false },
                                        datalabels: { display: false }
                                    },
                                    scales: {
                                        x: { title: { display: true, text: 'Unit Cost ($)', font: { size: 10 } }, beginAtZero: true },
                                        y: { title: { display: true, text: 'Sell Price ($)', font: { size: 10 } }, beginAtZero: true }
                                    }
                                }
                            });
                        }
                        
                        // Pareto Chart
                        const paretoCtx = document.getElementById('${paretoChartId}');
                        if (paretoCtx) {
                            if(Chart.getChart(paretoCtx)) Chart.getChart(paretoCtx).destroy();
                            new Chart(paretoCtx, {
                                type: 'bar',
                                data: {
                                    labels: [${top10Profit.map(d => `'${d.shortName.replace(/'/g, "\\'")}'`).join(', ')}],
                                    datasets: [{
                                        type: 'bar',
                                        label: 'Profit/Unit',
                                        data: [${top10Profit.map(d => d.profit.toFixed(2)).join(', ')}],
                                        backgroundColor: '#b89aaa',
                                        borderRadius: 4,
                                        yAxisID: 'y'
                                    }, {
                                        type: 'line',
                                        label: 'Cumulative %',
                                        data: [${paretoCumulative.map(v => v.toFixed(1)).join(', ')}],
                                        borderColor: '#6366f1',
                                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                        borderWidth: 3,
                                        pointBackgroundColor: '#6366f1',
                                        pointRadius: 4,
                                        fill: true,
                                        tension: 0.3,
                                        yAxisID: 'y1',
                                        datalabels: {
                                            display: true,
                                            align: 'top',
                                            offset: 5,
                                            color: '#4f46e5',
                                            font: { size: 10, weight: 'bold' },
                                            formatter: (value) => Math.round(value) + '%'
                                        }
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    animation: false,
                                    plugins: {
                                        legend: { display: true, position: 'top', labels: { font: { size: 11 } } },
                                        datalabels: {
                                            display: function(context) {
                                                return context.datasetIndex === 0; // Only show for bars
                                            },
                                            anchor: 'end',
                                            align: 'top',
                                            color: '#be185d',
                                            font: { size: 11, weight: 'bold' },
                                            formatter: (value) => '$' + parseFloat(value).toFixed(2)
                                        }
                                    },
                                    scales: {
                                        x: { ticks: { font: { size: 10 } } },
                                        y: { 
                                            type: 'linear', 
                                            position: 'left', 
                                            title: { display: true, text: 'Profit ($)', font: { size: 11 } },
                                            beginAtZero: true
                                        },
                                        y1: { 
                                            type: 'linear', 
                                            position: 'right', 
                                            title: { display: true, text: 'Cumulative %', font: { size: 10 } },
                                            min: 0,
                                            max: 100,
                                            grid: { drawOnChartArea: false }
                                        }
                                    }
                                }
                            });
                        }
                    }, 150);
                <` + `/script>
                
                <!-- Detail Table -->
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Margin Details</strong>
                        <span style="color: #666; font-size: 12px;">(${marginData.length} items - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>SKU</th>
                                <th>Description</th>
                                <th>Supplier</th>
                                <th style="text-align: right;">Unit Cost</th>
                                <th style="text-align: right;">Sell Price</th>
                                <th style="text-align: right;">Profit/Unit</th>
                                <th style="text-align: right;">Margin %</th>
                            </tr></thead><tbody>`;
            
            // Sort by margin descending for table
            marginData.sort((a, b) => b.margin - a.margin);
            
            marginData.forEach(item => {
                const marginColor = item.margin >= 30 ? '#6b9a8d' : item.margin >= 20 ? '#ca8a04' : item.margin >= 0 ? '#ea580c' : '#b88a8a';
                const marginBg = item.margin >= 30 ? '#dcfce7' : item.margin >= 20 ? '#fef9c3' : item.margin >= 0 ? '#fed7aa' : '#fecaca';
                
                html += `<tr>
                    <td style="font-weight: 600;">${item.sku}</td>
                    <td>${item.name}</td>
                    <td style="font-size: 12px; color: #666;">${item.supplier}</td>
                    <td style="text-align: right;">${formatMoney(item.unitCost)}</td>
                    <td style="text-align: right;">${formatMoney(item.sell)}</td>
                    <td style="text-align: right; color: ${item.profit >= 0 ? '#6b9a8d' : '#b88a8a'};">${formatMoney(item.profit)}</td>
                    <td style="text-align: right;"><span style="background: ${marginBg}; color: ${marginColor}; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">${item.margin.toFixed(1)}%</span></td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="6" style="text-align: right;">Average Gross Margin:</td>
                <td style="text-align: right;"><span style="background: #dcfce7; color: #6b9a8d; padding: 4px 12px; border-radius: 12px; font-weight: 700; font-size: 14px;">${avgMargin.toFixed(1)}%</span></td>
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            return html;
        }
        
        async function generateAccountsReceivableModal() {
            // Load all report data (uses cache if available)
            await loadReportData();
            
            const customers = cachedCustomers;
            
            // Helper to get customer info with address
            function getCustomerInfo(custId) {
                const customer = customers.find(c => c.Customer_ID == custId);
                if (!customer) return { name: custId, address: '' };
                const addressParts = [];
                if (customer.Address) addressParts.push(customer.Address);
                if (customer.City) addressParts.push(customer.City);
                if (customer.State) addressParts.push(customer.State);
                return {
                    name: customer.Customer_Name || custId,
                    address: addressParts.join(', ')
                };
            }
            
            // Filter to only show invoices with outstanding balance
            let unpaid = cachedSalesOrders.filter(s => {
                if (s.Status === 'Voided') return false;
                const amt = parseFloat(s.Total_Amount) || 0;
                const paid = parseFloat(s.Amount_Paid) || 0;
                const balance = amt - paid;
                return balance > 0.01; // Has outstanding balance
            });
            
            if (reportFilters.customer) {
                unpaid = unpaid.filter(s => matchesFilter(s.Customer_ID, reportFilters.customer));
            }
            
            // Calculate totals and aging
            let totalAmount = 0, totalPaid = 0, totalDue = 0;
            let current = 0, over30 = 0, over60 = 0, over90 = 0;
            const today = new Date();
            const byCustomer = {};
            
            unpaid.forEach(s => {
                const amt = parseFloat(s.Total_Amount) || 0;
                const paid = parseFloat(s.Amount_Paid) || 0;
                const due = amt - paid;
                totalAmount += amt;
                totalPaid += paid;
                totalDue += due;
                
                // Track by customer
                const custId = s.Customer_ID;
                if (!byCustomer[custId]) {
                    byCustomer[custId] = { name: getCustomerName(custId), owed: 0 };
                }
                byCustomer[custId].owed += due;
                
                // Calculate aging
                const dueDate = parseDate(s.Due_Date || s.Sale_Date);
                if (dueDate) {
                    const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
                    if (daysOverdue > 90) over90 += due;
                    else if (daysOverdue > 60) over60 += due;
                    else if (daysOverdue > 30) over30 += due;
                    else current += due;
                } else {
                    current += due;
                }
            });
            
            const agingChartId = 'arAgingChart_' + Date.now();
            const custChartId = 'arCustChart_' + Date.now();
            const topCustomers = Object.entries(byCustomer).sort((a, b) => b[1].owed - a[1].owed).slice(0, 5);
            
            // Build inline filter summary for oval header
            const filterSummaryInline = generateFilterSummary({ inline: true });
            
            let html = `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Accounts Receivable</h2>
                    <p style="margin: 0 0 ${filterSummaryInline ? '10px' : '0'} 0; font-size: 14px; opacity: 0.95;">${unpaid.length} unpaid invoices | ${formatMoney(totalDue)} outstanding</p>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px;">${filterSummaryInline}</div>` : ''}
                </div>`;
            
            // KPI Summary Cards - Muted Professional Colors
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #f5eaea 0%, #edd8d8 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b88a8a;">
                        <div style="font-size: 12px; color: #8a6a6a; margin-bottom: 5px;"> Total Owed</div>
                        <div style="font-size: 22px; font-weight: bold; color: #b88a8a;">${formatMoney(totalDue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #6b9a8d;">
                        <div style="font-size: 12px; color: #5a7a6d; margin-bottom: 5px;"> Current</div>
                        <div style="font-size: 22px; font-weight: bold; color: #6b9a8d;">${formatMoney(current)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b8a86b;">
                        <div style="font-size: 12px; color: #8a7a4a; margin-bottom: 5px;"> 31-60 Days</div>
                        <div style="font-size: 22px; font-weight: bold; color: #b8a86b;">${formatMoney(over30)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f5e8ea 0%, #e8d4d8 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b89aaa;">
                        <div style="font-size: 12px; color: #8a6a7a; margin-bottom: 5px;"> 90+ Days</div>
                        <div style="font-size: 22px; font-weight: bold; color: #b89aaa;">${formatMoney(over90)}</div>
                    </div>
                </div>
            `;
            
            // Charts Section (collapsible)
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'grid' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Aging Analysis</h4>
                            <canvas id="${agingChartId}" height="200"></canvas>
                        </div>
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Top 5 Outstanding</h4>
                            <canvas id="${custChartId}" height="200"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // Detail Table Section (collapsible)
            html += `
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Detail Table</strong>
                        <span style="color: #666; font-size: 12px;">(${unpaid.length} invoices - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>Invoice</th>
                                <th>Customer</th>
                                <th>Address</th>
                                <th>Sale Date</th>
                                <th style="text-align: right;">Total</th>
                                <th style="text-align: right;">Paid</th>
                                <th style="text-align: right;">Balance Due</th>
                                <th>Status</th>
                            </tr></thead><tbody>`;
            
            unpaid.forEach(s => {
                const amt = parseFloat(s.Total_Amount) || 0;
                const paid = parseFloat(s.Amount_Paid) || 0;
                const due = amt - paid;
                const custInfo = getCustomerInfo(s.Customer_ID);
                const saleDate = parseDate(s.Sale_Date);
                const saleDateStr = saleDate ? saleDate.toLocaleDateString() : '-';
                html += `<tr>
                    <td>${s.Invoice_Number || s.SO_Number || '-'}</td>
                    <td>${custInfo.name}</td>
                    <td style="font-size: 12px; color: #666;">${custInfo.address || '-'}</td>
                    <td>${saleDateStr}</td>
                    <td style="text-align: right;">${formatMoney(amt)}</td>
                    <td style="text-align: right;">${formatMoney(paid)}</td>
                    <td style="text-align: right; color: #c62828; font-weight: bold;">${formatMoney(due)}</td>
                    <td>${s.Payment_Status || 'Unpaid'}</td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="4">TOTAL</td>
                <td style="text-align: right;">${formatMoney(totalAmount)}</td>
                <td style="text-align: right;">${formatMoney(totalPaid)}</td>
                <td style="text-align: right; color: #c62828;">${formatMoney(totalDue)}</td>
                <td></td>
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            
            // Chart.js initialization
            html += `
                <scr` + `ipt>
                    setTimeout(() => {
                        // Aging Bar Chart
                        const ctx1 = document.getElementById('${agingChartId}');
                        if (ctx1) {
                            if(Chart.getChart(ctx1))Chart.getChart(ctx1).destroy(); new Chart(ctx1, {
                                type: 'bar',
                                data: {
                                    labels: ['Current', '31-60 Days', '61-90 Days', '90+ Days'],
                                    datasets: [{
                                        label: 'Amount',
                                        data: [${current.toFixed(2)}, ${over30.toFixed(2)}, ${over60.toFixed(2)}, ${over90.toFixed(2)}],
                                        backgroundColor: ['#6b9a8d', '#b8a86b', '#b8a07a', '#b88a8a'],
                                        borderRadius: 6
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Customer Pie Chart
                        const ctx2 = document.getElementById('${custChartId}');
                        if (ctx2) {
                            if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                type: 'doughnut',
                                data: {
                                    labels: [${topCustomers.map(([id, d]) => `'${d.name.replace(/'/g, "\\'").substring(0, 15)}'`).join(', ')}${topCustomers.length < Object.keys(byCustomer).length ? ", 'Others'" : ''}],
                                    datasets: [{
                                        data: [${topCustomers.map(([id, d]) => d.owed.toFixed(2)).join(', ')}${topCustomers.length < Object.keys(byCustomer).length ? ', ' + Object.entries(byCustomer).slice(5).reduce((sum, [id, d]) => sum + d.owed, 0).toFixed(2) : ''}],
                                        backgroundColor: ['#b88a8a', '#b8a86b', '#7a9bb8', '#9a8ab8', '#6b9a8d', '#a8a8a8'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { position: 'right', labels: { padding: 8, usePointStyle: true, font: { size: 10 } } },
                                        datalabels: {
                                            display: true,
                                            color: '#fff',
                                            font: { weight: 'bold', size: 11 },
                                            formatter: (value, ctx) => {
                                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                                const pct = total > 0 ? ((value / total) * 100).toFixed(0) : 0;
                                                return pct > 5 ? pct + '%' : '';
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        async function generateAccountsPayableModal() {
            const poResult = await apiCall('getPurchaseOrders');
            if (!poResult?.data) throw new Error('Failed to load POs');
            
            let unpaid = poResult.data.filter(p => p.Payment_Status !== 'Paid' && p.Status !== 'Void');
            
            if (reportFilters.supplier) {
                unpaid = unpaid.filter(p => matchesFilter(p.Supplier_ID, reportFilters.supplier));
            }
            
            // Calculate totals and aging
            let totalAmount = 0, totalPaid = 0, totalDue = 0;
            let current = 0, over30 = 0, over60 = 0, over90 = 0;
            const today = new Date();
            const bySupplier = {};
            
            unpaid.forEach(p => {
                const amt = parseFloat(p.Total_Amount) || 0;
                const paid = parseFloat(p.Amount_Paid) || 0;
                const due = amt - paid;
                totalAmount += amt;
                totalPaid += paid;
                totalDue += due;
                
                // Track by supplier
                const suppId = p.Supplier_ID;
                if (!bySupplier[suppId]) {
                    bySupplier[suppId] = { name: getSupplierName(suppId), owed: 0 };
                }
                bySupplier[suppId].owed += due;
                
                // Calculate aging
                const dueDate = parseDate(p.Due_Date || p.PO_Date);
                if (dueDate) {
                    const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
                    if (daysOverdue > 90) over90 += due;
                    else if (daysOverdue > 60) over60 += due;
                    else if (daysOverdue > 30) over30 += due;
                    else current += due;
                } else {
                    current += due;
                }
            });
            
            const agingChartId = 'apAgingChart_' + Date.now();
            const suppChartId = 'apSuppChart_' + Date.now();
            const topSuppliers = Object.entries(bySupplier).sort((a, b) => b[1].owed - a[1].owed).slice(0, 5);
            
            // Build inline filter summary for oval header
            const filterSummaryInline = generateFilterSummary({ inline: true });
            
            let html = `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Accounts Payable</h2>
                    <p style="margin: 0 0 ${filterSummaryInline ? '10px' : '0'} 0; font-size: 14px; opacity: 0.95;">${unpaid.length} unpaid POs | ${formatMoney(totalDue)} outstanding</p>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px;">${filterSummaryInline}</div>` : ''}
                </div>`;
            
            // KPI Summary Cards - Muted Professional Colors
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #f5eaea 0%, #edd8d8 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b88a8a;">
                        <div style="font-size: 12px; color: #8a6a6a; margin-bottom: 5px;"> Total Owed</div>
                        <div style="font-size: 22px; font-weight: bold; color: #b88a8a;">${formatMoney(totalDue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #6b9a8d;">
                        <div style="font-size: 12px; color: #5a7a6d; margin-bottom: 5px;"> Current</div>
                        <div style="font-size: 22px; font-weight: bold; color: #6b9a8d;">${formatMoney(current)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b8a86b;">
                        <div style="font-size: 12px; color: #8a7a4a; margin-bottom: 5px;"> 31-60 Days</div>
                        <div style="font-size: 22px; font-weight: bold; color: #b8a86b;">${formatMoney(over30)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f5e8ea 0%, #e8d4d8 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b89aaa;">
                        <div style="font-size: 12px; color: #8a6a7a; margin-bottom: 5px;"> 90+ Days</div>
                        <div style="font-size: 22px; font-weight: bold; color: #b89aaa;">${formatMoney(over90)}</div>
                    </div>
                </div>
            `;
            
            // Charts Section (collapsible)
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'grid' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Aging Analysis</h4>
                            <canvas id="${agingChartId}" height="200"></canvas>
                        </div>
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Top 5 Owed To</h4>
                            <canvas id="${suppChartId}" height="200"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // Detail Table Section (collapsible)
            html += `
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Detail Table</strong>
                        <span style="color: #666; font-size: 12px;">(${unpaid.length} POs - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>PO #</th>
                                <th>Supplier</th>
                                <th>PO Date</th>
                                <th style="text-align: right;">Total</th>
                                <th style="text-align: right;">Paid</th>
                                <th style="text-align: right;">Balance Due</th>
                                <th>Status</th>
                            </tr></thead><tbody>`;
            
            unpaid.forEach(p => {
                const amt = parseFloat(p.Total_Amount) || 0;
                const paid = parseFloat(p.Amount_Paid) || 0;
                const due = amt - paid;
                const formattedDate = formatDateSafe(p.PO_Date) + ' ' + formatTimeSafe(p.PO_Date);
                html += `<tr>
                    <td>${p.PO_ID || '-'}</td>
                    <td>${getSupplierName(p.Supplier_ID)}</td>
                    <td>${formattedDate}</td>
                    <td style="text-align: right;">${formatMoney(amt)}</td>
                    <td style="text-align: right;">${formatMoney(paid)}</td>
                    <td style="text-align: right; color: #c62828; font-weight: bold;">${formatMoney(due)}</td>
                    <td>${p.Payment_Status || 'Unpaid'}</td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="3">TOTAL</td>
                <td style="text-align: right;">${formatMoney(totalAmount)}</td>
                <td style="text-align: right;">${formatMoney(totalPaid)}</td>
                <td style="text-align: right; color: #c62828;">${formatMoney(totalDue)}</td>
                <td></td>
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            
            // Chart.js initialization
            const suppLabels = topSuppliers.map(([id, d]) => d.name.replace(/'/g, "\\'").substring(0, 15));
            const suppData = topSuppliers.map(([id, d]) => d.owed);
            const othersOwed = Object.entries(bySupplier).slice(5).reduce((sum, [id, d]) => sum + d.owed, 0);
            
            html += `
                <scr` + `ipt>
                    setTimeout(() => {
                        const ctx1 = document.getElementById('${agingChartId}');
                        if (ctx1) {
                            if(Chart.getChart(ctx1))Chart.getChart(ctx1).destroy(); new Chart(ctx1, {
                                type: 'bar',
                                data: {
                                    labels: ['Current', '31-60 Days', '61-90 Days', '90+ Days'],
                                    datasets: [{
                                        label: 'Amount',
                                        data: [${current.toFixed(2)}, ${over30.toFixed(2)}, ${over60.toFixed(2)}, ${over90.toFixed(2)}],
                                        backgroundColor: ['#6b9a8d', '#b8a86b', '#b8a07a', '#b88a8a'],
                                        borderRadius: 6
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: false } },
                                    scales: { y: { beginAtZero: true, ticks: { callback: (val) => '$' + val.toLocaleString() } } }
                                }
                            });
                        }
                        const ctx2 = document.getElementById('${suppChartId}');
                        if (ctx2) {
                            if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                type: 'doughnut',
                                data: {
                                    labels: ['${suppLabels.join("', '")}' ${othersOwed > 0 ? ", 'Others'" : ''}],
                                    datasets: [{
                                        data: [${suppData.join(', ')}${othersOwed > 0 ? ', ' + othersOwed.toFixed(2) : ''}],
                                        backgroundColor: ['#b88a8a', '#b8a86b', '#7a9bb8', '#9a8ab8', '#6b9a8d', '#a8a8a8'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: { 
                                        legend: { position: 'right', labels: { padding: 8, usePointStyle: true, font: { size: 10 } } },
                                        datalabels: {
                                            display: true,
                                            color: '#fff',
                                            font: { weight: 'bold', size: 11 },
                                            formatter: (value, ctx) => {
                                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                                const pct = total > 0 ? ((value / total) * 100).toFixed(0) : 0;
                                                return pct > 5 ? pct + '%' : '';
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        // ==================== TAX & ANNUAL REPORT GENERATORS ====================
        
        // Helper function to get date range for year/quarter
        function getDateRangeForPeriod(year, quarter) {
            year = parseInt(year);
            let startDate, endDate;
            
            if (quarter === 'annual' || !quarter) {
                startDate = new Date(year, 0, 1);  // Jan 1
                endDate = new Date(year, 11, 31, 23, 59, 59);  // Dec 31
            } else if (quarter === 'Q1') {
                startDate = new Date(year, 0, 1);  // Jan 1
                endDate = new Date(year, 2, 31, 23, 59, 59);  // Mar 31
            } else if (quarter === 'Q2') {
                startDate = new Date(year, 3, 1);  // Apr 1
                endDate = new Date(year, 5, 30, 23, 59, 59);  // Jun 30
            } else if (quarter === 'Q3') {
                startDate = new Date(year, 6, 1);  // Jul 1
                endDate = new Date(year, 8, 30, 23, 59, 59);  // Sep 30
            } else if (quarter === 'Q4') {
                startDate = new Date(year, 9, 1);  // Oct 1
                endDate = new Date(year, 11, 31, 23, 59, 59);  // Dec 31
            }
            
            return { startDate, endDate };
        }
        
        // Helper to parse dates flexibly
        function parseDate(dateVal) {
            if (!dateVal) return null;
            if (dateVal instanceof Date) return dateVal;
            const d = new Date(dateVal);
            return isNaN(d.getTime()) ? null : d;
        }
        
        // Enhanced date parsing for mobile Safari compatibility - used by all reports
        function parseDateSafe(dateVal) {
            if (!dateVal) return null;
            if (dateVal instanceof Date) return dateVal;
            
            try {
                // Try standard parsing first
                const d = new Date(dateVal);
                if (!isNaN(d.getTime())) return d;
                
                // Mobile Safari fallback: Try parsing common formats manually
                if (typeof dateVal === 'string') {
                    // Handle YYYY-MM-DD, MM/DD/YYYY, etc.
                    const parts = dateVal.split(/[-/]/);
                    if (parts.length === 3) {
                        const year = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // JS months are 0-indexed
                        const day = parseInt(parts[2]);
                        const d2 = new Date(year, month, day);
                        if (!isNaN(d2.getTime())) return d2;
                    }
                }
                
                return null;
            } catch (e) {
                console.error('Error parsing date:', dateVal, e);
                return null;
            }
        }
        
        // Apply date range filter with mobile-safe parsing
        function applyDateRangeFilter(items, dateField) {
            let filtered = items;
            
            try {
                // From date
                if (reportFilters.fromDate && reportFilters.fromDate.trim() !== '') {
                    const fromDate = parseLocalDate(reportFilters.fromDate);
                    if (!isNaN(fromDate.getTime())) {
                        fromDate.setHours(0, 0, 0, 0);
                        filtered = filtered.filter(item => {
                            const itemDate = parseDateSafe(item[dateField]);
                            return itemDate && itemDate >= fromDate;
                        });
                    }
                }
                
                // To date
                if (reportFilters.toDate && reportFilters.toDate.trim() !== '') {
                    const toDate = parseLocalDate(reportFilters.toDate);
                    if (!isNaN(toDate.getTime())) {
                        toDate.setHours(23, 59, 59, 999);
                        filtered = filtered.filter(item => {
                            const itemDate = parseDateSafe(item[dateField]);
                            return itemDate && itemDate <= toDate;
                        });
                    }
                }
            } catch (e) {
                console.error('Error applying date filter:', e);
            }
            
            return filtered;
        }
        
        // Helper to filter transactions by status
        function filterByTransactionStatus(items, statusField = 'Status') {
            const statusFilter = reportFilters.transactionStatus || 'exclude-voided';
            
            if (statusFilter === 'exclude-voided') {
                return items.filter(item => item[statusField] !== 'Voided');
            } else if (statusFilter === '') {
                return items; // All transactions
            } else {
                return items.filter(item => item[statusField] === statusFilter);
            }
        }
        
        // Helper to generate filter summary HTML
        function generateFilterSummary(options = {}) {
            const parts = [];
            
            // Date range
            if (reportFilters.fromDate && reportFilters.toDate) {
                parts.push(` ${new Date(reportFilters.fromDate).toLocaleDateString()} - ${new Date(reportFilters.toDate).toLocaleDateString()}`);
            } else if (reportFilters.fromDate) {
                parts.push(` From ${new Date(reportFilters.fromDate).toLocaleDateString()}`);
            } else if (reportFilters.toDate) {
                parts.push(` Through ${new Date(reportFilters.toDate).toLocaleDateString()}`);
            }
            
            // Year/Quarter for tax reports
            if (options.showYear && reportFilters.year) {
                const periodLabel = reportFilters.quarter === 'annual' ? `Year ${reportFilters.year}` : `${reportFilters.quarter} ${reportFilters.year}`;
                parts.push(` ${periodLabel}`);
            }
            
            // Customer (handle multi-select)
            if (reportFilters.customer) {
                const customerIds = reportFilters.customer.split(',').filter(id => id.trim());
                if (customerIds.length === 1) {
                    parts.push(` ${getCustomerName(customerIds[0])}`);
                } else if (customerIds.length > 1) {
                    // Show names instead of just codes
                    const names = customerIds.map(id => getCustomerName(id)).join(', ');
                    if (names.length > 50) {
                        // If too long, abbreviate
                        parts.push(` ${customerIds.length} customers`);
                    } else {
                        parts.push(` ${names}`);
                    }
                }
            }
            
            // Supplier (handle multi-select)
            if (reportFilters.supplier) {
                const supplierIds = reportFilters.supplier.split(',').filter(id => id.trim());
                if (supplierIds.length === 1) {
                    parts.push(` ${getSupplierName(supplierIds[0])}`);
                } else if (supplierIds.length > 1) {
                    // Show names instead of just codes
                    const names = supplierIds.map(id => getSupplierName(id)).join(', ');
                    if (names.length > 50) {
                        parts.push(` ${supplierIds.length} suppliers`);
                    } else {
                        parts.push(` ${names}`);
                    }
                }
            }
            
            // Payment Status
            if (reportFilters.paymentStatus) {
                const statusLabels = { 'Paid': ' Paid', 'Partial': ' Partial', 'Unpaid': ' Unpaid' };
                parts.push(statusLabels[reportFilters.paymentStatus] || reportFilters.paymentStatus);
            }
            
            // Transaction Status
            if (reportFilters.transactionStatus) {
                const statusLabels = {
                    'exclude-voided': ' Excluding Voided',
                    'Completed': ' Completed Only',
                    'Pending': ' Pending Only',
                    'Voided': ' Voided Only'
                };
                if (reportFilters.transactionStatus !== 'exclude-voided' || options.showVoidedFilter) {
                    parts.push(statusLabels[reportFilters.transactionStatus] || reportFilters.transactionStatus);
                }
            }
            
            // Min Amount
            if (reportFilters.minAmount > 0) {
                parts.push(` Min ${formatMoney(reportFilters.minAmount)}`);
            }
            
            // Stock Status
            if (reportFilters.stockStatus) {
                const labels = { 'negative': ' Negative', 'out': ' Out of Stock', 'low': ' Low Stock', 'ok': ' In Stock' };
                parts.push(labels[reportFilters.stockStatus] || reportFilters.stockStatus);
            }
            
            // Sales Invoice
            if (reportFilters.salesInvoice) {
                parts.push(` Invoice: ${reportFilters.salesInvoice}`);
            }
            
            // COGS Method
            if (options.showCogsMethod && reportFilters.cogsMethod) {
                parts.push(` COGS: ${reportFilters.cogsMethod === 'actual' ? 'Actual Costs' : 'Standard Costs'}`);
            }
            
            if (parts.length === 0) {
                return '';
            }
            
            // Return inline format for oval headers
            if (options.inline) {
                return parts.map(p => `<span style="background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 12px; font-size: 12px; margin-right: 5px;">${p}</span>`).join('');
            }
            
            // Return standalone box format (legacy)
            return `
                <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    <span style="font-weight: 600; color: #666; font-size: 12px;">FILTERS:</span>
                    ${parts.map(p => `<span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;">${p}</span>`).join('')}
                </div>
            `;
        }
        
        // Profit & Loss Statement
        async function generateProfitLossModal() {
            const year = reportFilters.year || new Date().getFullYear();
            const quarter = reportFilters.quarter || 'annual';
            const cogsMethod = reportFilters.cogsMethod || 'actual';
            
            const { startDate, endDate } = getDateRangeForPeriod(year, quarter);
            
            // Load all report data (uses cache if available)
            await loadReportData();
            
            const items = cachedItems;
            
            if (!cachedSalesOrders.length || !cachedPurchaseOrders.length || !items.length) {
                throw new Error('Failed to load data');
            }
            
            // Filter sales by date AND exclude voided (tax reports always exclude voided)
            const salesInPeriod = cachedSalesOrders.filter(s => {
                if (s.Status === 'Voided') return false; // Always exclude voided for tax reports
                const saleDate = parseDate(s.Sale_Date || s.SO_Date);
                return saleDate && saleDate >= startDate && saleDate <= endDate;
            });
            
            // Filter purchases by date AND exclude voided
            const purchasesInPeriod = cachedPurchaseOrders.filter(p => {
                if (p.Status === 'Voided') return false; // Always exclude voided for tax reports
                const poDate = parseDate(p.PO_Date);
                return poDate && poDate >= startDate && poDate <= endDate;
            });
            
            // Calculate Revenue (total sales)
            let totalRevenue = 0;
            salesInPeriod.forEach(s => {
                totalRevenue += parseFloat(s.Total_Amount) || 0;
            });
            
            // Calculate COGS based on method
            let totalCOGS = 0;
            
            if (cogsMethod === 'actual') {
                // COGS from actual purchase orders (both INCOMING and OUTGOING)
                purchasesInPeriod.forEach(p => {
                    totalCOGS += parseFloat(p.Total_Amount) || 0;
                });
            } else {
                // COGS from standard costs based on units sold
                for (const so of salesInPeriod) {
                    const lines = getSalesLinesFromCache(so.SO_ID);
                    if (lines.length > 0) {
                        lines.forEach(line => {
                            const item = items.find(i => i.Item_ID === line.Item_ID);
                            const unitsPerPackage = parseFloat(item?.Units_Per_Package) || 1;
                            const packageCost = parseFloat(item?.Package_Cost) || 0;
                            const unitCost = packageCost / unitsPerPackage;
                            const qty = parseInt(line.Quantity) || 0;
                            totalCOGS += qty * unitCost;
                        });
                    }
                }
            }
            
            // Calculate Gross Profit
            const grossProfit = totalRevenue - totalCOGS;
            const grossMargin = totalRevenue > 0 ? (grossProfit / totalRevenue * 100) : 0;
            
            // Period label
            const periodLabel = quarter === 'annual' ? `Year ${year}` : `${quarter} ${year}`;
            const cogsLabel = cogsMethod === 'actual' ? 'Actual Purchase Costs' : 'Standard Costs';
            
            let html = `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Profit & Loss Statement</h2>
                    <p style="margin: 0 0 10px 0; font-size: 14px; opacity: 0.95;">${periodLabel} | COGS: ${cogsLabel}</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        <span style="background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 12px; font-size: 12px;"> ${periodLabel}</span>
                        <span style="background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 12px; font-size: 12px;"> ${cogsLabel}</span>
                        <span style="background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 12px; font-size: 12px;"> Voided Excluded</span>
                    </div>
                </div>`;
            
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #7a9bb8;">
                        <div style="font-size: 12px; color: #5a7a8a; margin-bottom: 5px;"> Revenue</div>
                        <div style="font-size: 22px; font-weight: bold; color: #7a9bb8;">${formatMoney(totalRevenue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f5eaea 0%, #edd8d8 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b88a8a;">
                        <div style="font-size: 12px; color: #8a6a6a; margin-bottom: 5px;"> COGS</div>
                        <div style="font-size: 22px; font-weight: bold; color: #b88a8a;">${formatMoney(totalCOGS)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #6b9a8d;">
                        <div style="font-size: 12px; color: #5a7a6d; margin-bottom: 5px;"> Gross Profit</div>
                        <div style="font-size: 22px; font-weight: bold; color: ${grossProfit >= 0 ? '#6b9a8d' : '#b88a8a'};">${formatMoney(grossProfit)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b8a86b;">
                        <div style="font-size: 12px; color: #8a7a4a; margin-bottom: 5px;"> Margin</div>
                        <div style="font-size: 22px; font-weight: bold; color: #b8a86b;">${grossMargin.toFixed(1)}%</div>
                    </div>
                </div>
                
                <div style="max-width: 500px; margin: 0 auto;">
                    <table class="data-table" style="width: 100%;">
                        <tbody>
                            <tr style="background: #e8f5e9;">
                                <td style="padding: 15px; font-weight: bold; font-size: 16px;"> REVENUE</td>
                                <td style="padding: 15px; text-align: right; font-weight: bold; font-size: 16px; color: #2e7d32;">${formatMoney(totalRevenue)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; padding-left: 30px; color: #666;">Sales Orders (${salesInPeriod.length})</td>
                                <td style="padding: 12px; text-align: right;">${formatMoney(totalRevenue)}</td>
                            </tr>
                            
                            <tr style="background: #ffebee;">
                                <td style="padding: 15px; font-weight: bold; font-size: 16px;"> COST OF GOODS SOLD</td>
                                <td style="padding: 15px; text-align: right; font-weight: bold; font-size: 16px; color: #c62828;">(${formatMoney(totalCOGS)})</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; padding-left: 30px; color: #666;">
                                    ${cogsMethod === 'actual' ? `Purchase Orders (${purchasesInPeriod.length})` : 'Standard unit costs  units sold'}
                                </td>
                                <td style="padding: 12px; text-align: right;">${formatMoney(totalCOGS)}</td>
                            </tr>
                            
                            <tr style="background: linear-gradient(135deg, #667eea15, #764ba215); border-top: 3px solid #667eea;">
                                <td style="padding: 20px; font-weight: bold; font-size: 18px;"> GROSS PROFIT</td>
                                <td style="padding: 20px; text-align: right; font-weight: bold; font-size: 18px; color: ${grossProfit >= 0 ? '#2e7d32' : '#c62828'};">
                                    ${formatMoney(grossProfit)}
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; padding-left: 30px; color: #666;">Gross Margin</td>
                                <td style="padding: 12px; text-align: right; font-weight: bold; color: ${grossMargin >= 20 ? '#2e7d32' : '#b8a86b'};">${grossMargin.toFixed(1)}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 30px; padding: 15px; background: #f5f5f5; border-radius: 8px; font-size: 12px; color: #666;">
                    <strong>Note:</strong> This is a simplified P&L showing gross profit only. Operating expenses, taxes, and net income are not tracked in this system.
                </div>
            `;
            
            // Add P&L Chart
            const plChartId = 'plChart_' + Date.now();
            
            html += `
                <div style="margin-top: 20px; margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Visual Summary</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 450px;">
                            <canvas id="${plChartId}" height="180"></canvas>
                        </div>
                    </div>
                </div>
                
                <scr` + `ipt>
                    setTimeout(() => {
                        const ctx = document.getElementById('${plChartId}');
                        if (ctx) {
                            if(Chart.getChart(ctx))Chart.getChart(ctx).destroy(); new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: ['Revenue', 'COGS', 'Gross Profit'],
                                    datasets: [{
                                        data: [${totalRevenue.toFixed(2)}, ${totalCOGS.toFixed(2)}, ${grossProfit.toFixed(2)}],
                                        backgroundColor: ['#6b9a8d', '#b88a8a', '${grossProfit >= 0 ? '#7a9bb8' : '#b8a86b'}'],
                                        borderRadius: 8
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + Math.abs(ctx.raw).toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        // Annual Sales Summary
        async function generateAnnualSalesSummaryModal() {
            const year = parseInt(reportFilters.year) || new Date().getFullYear();
            const { startDate, endDate } = getDateRangeForPeriod(year, 'annual');
            
            const salesResult = await apiCall('getSalesOrders');
            if (!salesResult?.data) throw new Error('Failed to load sales data');
            
            // Filter by year AND exclude voided
            const salesInYear = salesResult.data.filter(s => {
                if (s.Status === 'Voided') return false;
                const saleDate = parseDate(s.Sale_Date || s.SO_Date);
                return saleDate && saleDate >= startDate && saleDate <= endDate;
            });
            
            // Group by month
            const byMonth = {};
            for (let m = 0; m < 12; m++) {
                byMonth[m] = { sales: 0, orders: 0, paid: 0 };
            }
            
            salesInYear.forEach(s => {
                const saleDate = parseDate(s.Sale_Date || s.SO_Date);
                if (saleDate) {
                    const month = saleDate.getMonth();
                    byMonth[month].sales += parseFloat(s.Total_Amount) || 0;
                    byMonth[month].orders++;
                    byMonth[month].paid += parseFloat(s.Amount_Paid) || 0;
                }
            });
            
            // Group by customer - include address info
            const byCustomer = {};
            
            // First get customer details for addresses
            let customerDetails = {};
            try {
                const custResult = await apiCall('getCustomers');
                if (custResult?.data) {
                    custResult.data.forEach(c => {
                        customerDetails[c.Customer_ID] = c;
                    });
                }
            } catch(e) {
                // Use cached if available
                if (cachedCustomers) {
                    cachedCustomers.forEach(c => {
                        customerDetails[c.Customer_ID] = c;
                    });
                }
            }
            
            salesInYear.forEach(s => {
                const custId = s.Customer_ID;
                if (!byCustomer[custId]) {
                    const custInfo = customerDetails[custId] || {};
                    // Build address string
                    let addressParts = [];
                    if (custInfo.Address) addressParts.push(custInfo.Address);
                    if (custInfo.City) addressParts.push(custInfo.City);
                    if (custInfo.State) addressParts.push(custInfo.State);
                    const address = addressParts.join(', ');
                    
                    byCustomer[custId] = { 
                        name: getCustomerName(custId), 
                        address: address || '',
                        total: 0, 
                        orders: 0 
                    };
                }
                byCustomer[custId].total += parseFloat(s.Total_Amount) || 0;
                byCustomer[custId].orders++;
            });
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthNamesFull = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Calculate totals
            let totalSales = 0, totalOrders = 0, totalPaid = 0;
            const monthlyData = [];
            for (let m = 0; m < 12; m++) {
                totalSales += byMonth[m].sales;
                totalOrders += byMonth[m].orders;
                totalPaid += byMonth[m].paid;
                monthlyData.push(byMonth[m].sales);
            }
            const avgPerOrder = totalOrders > 0 ? totalSales / totalOrders : 0;
            const collectionRate = totalSales > 0 ? (totalPaid / totalSales * 100) : 0;
            
            const lineChartId = 'annualSalesLineChart_' + Date.now();
            const barChartId = 'annualSalesBarChart_' + Date.now();
            const topCustomers = Object.entries(byCustomer).sort((a, b) => b[1].total - a[1].total).slice(0, 5);
            
            let html = `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Annual Sales Summary - ${year}</h2>
                    <p style="margin: 0 0 10px 0; font-size: 14px; opacity: 0.95;">${salesInYear.length} orders | ${formatMoney(totalSales)} total sales</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        <span style="background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 12px; font-size: 12px;"> Calendar Year ${year}</span>
                        <span style="background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 12px; font-size: 12px;"> Voided Excluded</span>
                    </div>
                </div>`;
            
            // KPI Cards
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #7a9bb8;">
                        <div style="font-size: 11px; color: #5a7a8a; margin-bottom: 5px;"> Total Sales</div>
                        <div style="font-size: 22px; font-weight: bold; color: #7a9bb8;">${formatMoney(totalSales)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #6b9a8d;">
                        <div style="font-size: 11px; color: #5a7a6d; margin-bottom: 5px;"> Collected</div>
                        <div style="font-size: 22px; font-weight: bold; color: #6b9a8d;">${formatMoney(totalPaid)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f0e8f0 0%, #e4d8e8 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9a8ab8;">
                        <div style="font-size: 11px; color: #7a6a8a; margin-bottom: 5px;"> Avg/Order</div>
                        <div style="font-size: 22px; font-weight: bold; color: #9a8ab8;">${formatMoney(avgPerOrder)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b8a86b;">
                        <div style="font-size: 11px; color: #8a7a4a; margin-bottom: 5px;"> Collection %</div>
                        <div style="font-size: 22px; font-weight: bold; color: #b8a86b;">${collectionRate.toFixed(1)}%</div>
                    </div>
                </div>
                
                <!-- Charts Section (collapsible) -->
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'grid' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Monthly Sales Trend</h4>
                            <canvas id="${lineChartId}" height="120"></canvas>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 15px 0; color: #333;"> Top Customers</h4>
                                <canvas id="${barChartId}" height="180"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Table (collapsible) -->
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Monthly Breakdown</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>Month</th>
                                <th style="text-align: right;">Orders</th>
                                <th style="text-align: right;">Sales</th>
                                <th style="text-align: right;">Collected</th>
                            </tr></thead><tbody>`;
            
            for (let m = 0; m < 12; m++) {
                const data = byMonth[m];
                html += `<tr${data.orders === 0 ? ' style="color: #999;"' : ''}>
                    <td>${monthNamesFull[m]}</td>
                    <td style="text-align: right;">${data.orders}</td>
                    <td style="text-align: right;">${formatMoney(data.sales)}</td>
                    <td style="text-align: right;">${formatMoney(data.paid)}</td>
                </tr>`;
            }
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td>TOTAL</td>
                <td style="text-align: right;">${totalOrders}</td>
                <td style="text-align: right;">${formatMoney(totalSales)}</td>
                <td style="text-align: right;">${formatMoney(totalPaid)}</td>
            </tr></tfoot></table></div>
                    </div>
                </div>
                
                <!-- Customer Table (collapsible) -->
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Sales by Customer</strong>
                        <span style="color: #666; font-size: 12px;">(${Object.keys(byCustomer).length} customers - click to show)</span>
                    </div>
                    <div style="display: none; margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>Customer</th>
                                <th>Address</th>
                                <th style="text-align: right;">Orders</th>
                                <th style="text-align: right;">Total Sales</th>
                            </tr></thead><tbody>`;
            
            Object.entries(byCustomer)
                .sort((a, b) => b[1].total - a[1].total)
                .forEach(([id, data]) => {
                    html += `<tr>
                        <td><strong>${data.name}</strong></td>
                        <td style="color: #666; font-size: 13px;">${data.address || '-'}</td>
                        <td style="text-align: right;">${data.orders}</td>
                        <td style="text-align: right;">${formatMoney(data.total)}</td>
                    </tr>`;
                });
            
            html += `</tbody></table></div>
                    </div>
                </div>
                
                <!-- Chart.js -->
                <scr` + `ipt>
                    setTimeout(() => {
                        // Line Chart - Monthly Trend
                        const ctx1 = document.getElementById('${lineChartId}');
                        if (ctx1) {
                            if(Chart.getChart(ctx1))Chart.getChart(ctx1).destroy(); new Chart(ctx1, {
                                type: 'line',
                                data: {
                                    labels: ['${monthNames.join("', '")}'],
                                    datasets: [{
                                        label: 'Sales',
                                        data: [${monthlyData.map(d => d.toFixed(2)).join(', ')}],
                                        borderColor: '#7a9bb8',
                                        backgroundColor: 'rgba(122, 155, 184, 0.1)',
                                        fill: true,
                                        tension: 0.3,
                                        pointRadius: 4,
                                        pointBackgroundColor: '#7a9bb8'
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Bar Chart - Top Customers
                        const ctx2 = document.getElementById('${barChartId}');
                        if (ctx2) {
                            if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                type: 'bar',
                                data: {
                                    labels: [${topCustomers.map(([id, d]) => `'${d.name.replace(/'/g, "\\'").substring(0, 15)}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Sales',
                                        data: [${topCustomers.map(([id, d]) => d.total.toFixed(2)).join(', ')}],
                                        backgroundColor: ['#7a9bb8', '#9a8ab8', '#7aaab8', '#6b9a8d', '#b8a86b'],
                                        borderRadius: 6
                                    }]
                                },
                                options: {
                                    indexAxis: 'y',
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        x: {
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        // Annual Purchase Summary
        async function generateAnnualPurchaseSummaryModal() {
            const year = parseInt(reportFilters.year) || new Date().getFullYear();
            const { startDate, endDate } = getDateRangeForPeriod(year, 'annual');
            
            const poResult = await apiCall('getPurchaseOrders');
            if (!poResult?.data) throw new Error('Failed to load PO data');
            
            // Filter by year AND exclude voided (tax reports always exclude voided)
            const posInYear = poResult.data.filter(p => {
                if (p.Status === 'Voided') return false;
                const poDate = parseDate(p.PO_Date);
                return poDate && poDate >= startDate && poDate <= endDate;
            });
            
            // Group by month
            const byMonth = {};
            for (let m = 0; m < 12; m++) {
                byMonth[m] = { total: 0, orders: 0, paid: 0 };
            }
            
            posInYear.forEach(p => {
                const poDate = parseDate(p.PO_Date);
                if (poDate) {
                    const month = poDate.getMonth();
                    byMonth[month].total += parseFloat(p.Total_Amount) || 0;
                    byMonth[month].orders++;
                    byMonth[month].paid += parseFloat(p.Amount_Paid) || 0;
                }
            });
            
            // Group by supplier
            const bySupplier = {};
            posInYear.forEach(p => {
                const suppId = p.Supplier_ID;
                if (!bySupplier[suppId]) {
                    bySupplier[suppId] = { name: getSupplierName(suppId), total: 0, orders: 0 };
                }
                bySupplier[suppId].total += parseFloat(p.Total_Amount) || 0;
                bySupplier[suppId].orders++;
            });
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Calculate totals FIRST for KPI cards
            let totalPurchases = 0, totalOrders = 0, totalPaid = 0;
            for (let m = 0; m < 12; m++) {
                totalPurchases += byMonth[m].total;
                totalOrders += byMonth[m].orders;
                totalPaid += byMonth[m].paid;
            }
            const totalOwed = totalPurchases - totalPaid;
            const avgPerOrder = totalOrders > 0 ? totalPurchases / totalOrders : 0;
            
            // Build inline filter summary for oval header
            const filterSummaryInline = generateFilterSummary({ inline: true });
            
            let html = `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #7a9bb8 0%, #9a8ab8 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(122, 155, 184, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Annual Purchase Summary - ${year}</h2>
                    <p style="margin: 0 0 ${filterSummaryInline ? '10px' : '0'} 0; font-size: 14px; opacity: 0.95;">${posInYear.length} purchase orders | ${formatMoney(totalPurchases)} total</p>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px;">${filterSummaryInline}</div>` : ''}
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #7a9bb8;">
                        <div style="font-size: 11px; color: #5a7a8a; margin-bottom: 5px;"> Total Purchases</div>
                        <div style="font-size: 22px; font-weight: bold; color: #7a9bb8;">${formatMoney(totalPurchases)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #6b9a8d;">
                        <div style="font-size: 11px; color: #5a7a6d; margin-bottom: 5px;"> Paid</div>
                        <div style="font-size: 22px; font-weight: bold; color: #6b9a8d;">${formatMoney(totalPaid)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b8a86b;">
                        <div style="font-size: 11px; color: #8a7a4a; margin-bottom: 5px;"> Owed</div>
                        <div style="font-size: 22px; font-weight: bold; color: #b8a86b;">${formatMoney(totalOwed)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f0e8f0 0%, #e4d8e8 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9a8ab8;">
                        <div style="font-size: 11px; color: #7a6a8a; margin-bottom: 5px;"> Avg/Order</div>
                        <div style="font-size: 22px; font-weight: bold; color: #9a8ab8;">${formatMoney(avgPerOrder)}</div>
                    </div>
                </div>
                
                <h4 style="margin: 20px 0 10px 0; cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';"><span class="toggle-icon"></span>  Monthly Breakdown</h4>
                <div style="overflow-x: auto;"><table class="data-table">
                    <thead><tr>
                        <th>Month</th>
                        <th style="text-align: right;">POs</th>
                        <th style="text-align: right;">Purchases</th>
                        <th style="text-align: right;">Paid</th>
                    </tr></thead><tbody>`;
            
            for (let m = 0; m < 12; m++) {
                const data = byMonth[m];
                
                html += `<tr${data.orders === 0 ? ' style="color: #999;"' : ''}>
                    <td>${monthNames[m]}</td>
                    <td style="text-align: right;">${data.orders}</td>
                    <td style="text-align: right;">${formatMoney(data.total)}</td>
                    <td style="text-align: right;">${formatMoney(data.paid)}</td>
                </tr>`;
            }
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td>TOTAL</td>
                <td style="text-align: right;">${totalOrders}</td>
                <td style="text-align: right;">${formatMoney(totalPurchases)}</td>
                <td style="text-align: right;">${formatMoney(totalPaid)}</td>
            </tr></tfoot></table></div>`;
            
            // Supplier summary
            html += `
                <div style="margin-top: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Purchases by Supplier</strong>
                        <span style="color: #666; font-size: 12px;">(${Object.keys(bySupplier).length} suppliers - click to show)</span>
                    </div>
                    <div style="display: none; margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>Supplier</th>
                                <th style="text-align: right;">POs</th>
                                <th style="text-align: right;">Total Purchases</th>
                            </tr></thead><tbody>`;
            
            Object.entries(bySupplier)
                .sort((a, b) => b[1].total - a[1].total)
                .forEach(([id, data]) => {
                    html += `<tr>
                        <td>${data.name}</td>
                        <td style="text-align: right;">${data.orders}</td>
                        <td style="text-align: right;">${formatMoney(data.total)}</td>
                    </tr>`;
                });
            
            html += `</tbody></table></div>
                    </div>
                </div>
            `;
            
            // Charts
            const lineChartId = 'purchLineChart_' + Date.now();
            const barChartId = 'purchBarChart_' + Date.now();
            const monthlyData = [];
            for (let m = 0; m < 12; m++) {
                monthlyData.push(byMonth[m].total);
            }
            const topSuppliers = Object.entries(bySupplier).sort((a, b) => b[1].total - a[1].total).slice(0, 5);
            
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'grid' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Monthly Purchases</h4>
                            <canvas id="${lineChartId}" height="200"></canvas>
                        </div>
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Top 5 Suppliers</h4>
                            <canvas id="${barChartId}" height="200"></canvas>
                        </div>
                    </div>
                </div>
                
                <scr` + `ipt>
                    setTimeout(() => {
                        const ctx1 = document.getElementById('${lineChartId}');
                        if (ctx1) {
                            if(Chart.getChart(ctx1))Chart.getChart(ctx1).destroy(); new Chart(ctx1, {
                                type: 'line',
                                data: {
                                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                                    datasets: [{
                                        label: 'Purchases',
                                        data: [${monthlyData.map(v => v.toFixed(2)).join(', ')}],
                                        borderColor: '#3b82f6',
                                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                        fill: true,
                                        tension: 0.3
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: false } },
                                    scales: { y: { beginAtZero: true, ticks: { callback: (val) => '$' + val.toLocaleString() } } }
                                }
                            });
                        }
                        const ctx2 = document.getElementById('${barChartId}');
                        if (ctx2) {
                            if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                type: 'bar',
                                data: {
                                    labels: [${topSuppliers.map(([id, d]) => `'${d.name.replace(/'/g, "\\'").substring(0, 15)}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Purchases',
                                        data: [${topSuppliers.map(([id, d]) => d.total.toFixed(2)).join(', ')}],
                                        backgroundColor: ['#7a9bb8', '#9a8ab8', '#7aaab8', '#6b9a8d', '#b8a86b'],
                                        borderRadius: 6
                                    }]
                                },
                                options: {
                                    indexAxis: 'y',
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: false } },
                                    scales: { x: { beginAtZero: true, ticks: { callback: (val) => '$' + val.toLocaleString() } } }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        // Inventory Valuation
        async function generateInventoryValuationModal() {
            const itemsResult = await apiCall('getItems');
            if (!itemsResult?.data) throw new Error('Failed to load items');
            
            let items = itemsResult.data;
            
            // Filter by supplier if selected
            if (reportFilters.supplier) {
                items = items.filter(i => matchesFilter(i.Supplier_ID, reportFilters.supplier));
            }
            
            // Calculate totals and group by supplier
            let totalUnits = 0, totalValue = 0, totalRetailValue = 0;
            const bySupplier = {};
            
            items.forEach(item => {
                const qty = parseInt(item.Qty_On_Hand) || 0;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPkg = parseInt(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPkg;
                const sellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const extValue = Math.abs(qty) * unitCost;
                
                totalUnits += qty;
                totalValue += extValue;
                totalRetailValue += Math.abs(qty) * sellPrice;
                
                // Group by supplier
                const suppId = item.Supplier_ID || 'Unknown';
                if (!bySupplier[suppId]) {
                    bySupplier[suppId] = { name: getSupplierName(suppId), value: 0, items: 0 };
                }
                bySupplier[suppId].value += extValue;
                bySupplier[suppId].items++;
            });
            
            const potentialProfit = totalRetailValue - totalValue;
            const avgMargin = totalRetailValue > 0 ? (potentialProfit / totalRetailValue * 100) : 0;
            const today = new Date().toLocaleDateString();
            
            const pieChartId = 'invValPieChart_' + Date.now();
            const topSuppliers = Object.entries(bySupplier).sort((a, b) => b[1].value - a[1].value).slice(0, 5);
            const othersValue = Object.entries(bySupplier).slice(5).reduce((sum, [id, d]) => sum + d.value, 0);
            
            // Build inline filter summary for oval header
            const filterSummaryInline = generateFilterSummary({ inline: true });
            
            let html = `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #6b9a8d 0%, #7a9bb8 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(107, 154, 141, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Inventory Valuation Report</h2>
                    <p style="margin: 0 0 ${filterSummaryInline ? '10px' : '0'} 0; font-size: 14px; opacity: 0.95;">As of ${today} | ${items.length} items</p>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px;">${filterSummaryInline}</div>` : ''}
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e8f0f5 0%, #d4e4ef 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #7a9bb8;">
                        <div style="font-size: 11px; color: #5a7a8a; margin-bottom: 5px;"> Total Units</div>
                        <div style="font-size: 22px; font-weight: bold; color: #7a9bb8;">${totalUnits.toLocaleString()}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #6b9a8d;">
                        <div style="font-size: 11px; color: #5a7a6d; margin-bottom: 5px;"> Cost Value</div>
                        <div style="font-size: 22px; font-weight: bold; color: #6b9a8d;">${formatMoney(totalValue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f0e8f0 0%, #e4d8e8 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9a8ab8;">
                        <div style="font-size: 11px; color: #7a6a8a; margin-bottom: 5px;"> Retail Value</div>
                        <div style="font-size: 22px; font-weight: bold; color: #9a8ab8;">${formatMoney(totalRetailValue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f5f0e0 0%, #ede4cc 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #b8a86b;">
                        <div style="font-size: 11px; color: #8a7a4a; margin-bottom: 5px;"> Potential Profit</div>
                        <div style="font-size: 22px; font-weight: bold; color: #b8a86b;">${formatMoney(potentialProfit)}</div>
                    </div>
                </div>
            `;
            
            // Charts Section
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'grid' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Value by Supplier</h4>
                            <canvas id="${pieChartId}" height="220"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // Detail Table Section
            html += `
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Detail Table</strong>
                        <span style="color: #666; font-size: 12px;">(${items.length} items - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>SKU</th>
                                <th>Description</th>
                                <th>Supplier</th>
                                <th style="text-align: right;">Qty</th>
                                <th style="text-align: right;">Unit Cost</th>
                                <th style="text-align: right;">Ext. Value</th>
                            </tr></thead><tbody>`;
            
            items.forEach(item => {
                const qty = parseInt(item.Qty_On_Hand) || 0;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPkg = parseInt(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPkg;
                const extValue = Math.abs(qty) * unitCost;
                
                html += `<tr>
                    <td>${item.SKU || '-'}</td>
                    <td>${item.Item_Description || '-'}</td>
                    <td>${getSupplierName(item.Supplier_ID)}</td>
                    <td style="text-align: right; color: ${qty < 0 ? '#c62828' : '#333'};">${qty}</td>
                    <td style="text-align: right;">${formatMoney(unitCost)}</td>
                    <td style="text-align: right;">${formatMoney(extValue)}</td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="3">TOTAL</td>
                <td style="text-align: right;">${totalUnits}</td>
                <td></td>
                <td style="text-align: right; color: #2e7d32;">${formatMoney(totalValue)}</td>
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            
            // Chart.js initialization
            const suppLabels = topSuppliers.map(([id, d]) => d.name.replace(/'/g, "\\'").substring(0, 15));
            const suppData = topSuppliers.map(([id, d]) => d.value);
            
            html += `
                <scr` + `ipt>
                    setTimeout(() => {
                        const ctx = document.getElementById('${pieChartId}');
                        if (ctx) {
                            if(Chart.getChart(ctx))Chart.getChart(ctx).destroy(); new Chart(ctx, {
                                type: 'doughnut',
                                data: {
                                    labels: ['${suppLabels.join("', '")}' ${othersValue > 0 ? ", 'Others'" : ''}],
                                    datasets: [{
                                        data: [${suppData.join(', ')}${othersValue > 0 ? ', ' + othersValue.toFixed(2) : ''}],
                                        backgroundColor: ['#7a9bb8', '#9a8ab8', '#7aaab8', '#6b9a8d', '#b8a86b', '#a8a8a8'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { position: 'right', labels: { padding: 10, usePointStyle: true, font: { size: 11 } } },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => ctx.label + ': $' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        },
                                        datalabels: {
                                            display: true,
                                            color: '#fff',
                                            font: { weight: 'bold', size: 11 },
                                            formatter: (value, ctx) => {
                                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                                const pct = total > 0 ? ((value / total) * 100).toFixed(0) : 0;
                                                return pct > 5 ? pct + '%' : '';
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        // Cash Flow Summary
        async function generateCashFlowSummaryModal() {
            const year = parseInt(reportFilters.year) || new Date().getFullYear();
            const quarter = reportFilters.quarter || 'annual';
            
            const { startDate, endDate } = getDateRangeForPeriod(year, quarter);
            
            const [salesResult, poResult] = await Promise.all([
                apiCall('getSalesOrders'),
                apiCall('getPurchaseOrders')
            ]);
            
            if (!salesResult?.data || !poResult?.data) {
                throw new Error('Failed to load data');
            }
            
            // Filter by period AND exclude voided (tax reports always exclude voided)
            const salesInPeriod = salesResult.data.filter(s => {
                if (s.Status === 'Voided') return false;
                const d = parseDate(s.Sale_Date || s.SO_Date);
                return d && d >= startDate && d <= endDate;
            });
            
            const posInPeriod = poResult.data.filter(p => {
                if (p.Status === 'Voided') return false;
                const d = parseDate(p.PO_Date);
                return d && d >= startDate && d <= endDate;
            });
            
            // Calculate totals
            let totalSalesInvoiced = 0, totalSalesCollected = 0;
            let totalPurchasesInvoiced = 0, totalPurchasesPaid = 0;
            
            salesInPeriod.forEach(s => {
                totalSalesInvoiced += parseFloat(s.Total_Amount) || 0;
                totalSalesCollected += parseFloat(s.Amount_Paid) || 0;
            });
            
            posInPeriod.forEach(p => {
                totalPurchasesInvoiced += parseFloat(p.Total_Amount) || 0;
                totalPurchasesPaid += parseFloat(p.Amount_Paid) || 0;
            });
            
            const outstandingReceivables = totalSalesInvoiced - totalSalesCollected;
            const outstandingPayables = totalPurchasesInvoiced - totalPurchasesPaid;
            const netCashFlow = totalSalesCollected - totalPurchasesPaid;
            
            const periodLabel = quarter === 'annual' ? `Year ${year}` : `${quarter} ${year}`;
            
            // Build inline filter summary for oval header
            const filterSummaryInline = generateFilterSummary({ inline: true });
            
            let html = `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #6b9a8d 0%, #7a9bb8 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(107, 154, 141, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Cash Flow Summary</h2>
                            <p style="margin: 0; font-size: 14px; opacity: 0.95;">${salesInPeriod.length} Sales / ${posInPeriod.length} POs</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;">
                             ${periodLabel}
                        </div>
                    </div>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;">${filterSummaryInline}</div>` : ''}
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    
                    <!-- Cash In -->
                    <div style="background: linear-gradient(135deg, #e8f0e8 0%, #d4e8dc 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #6b9a8d;">
                        <h4 style="margin: 0 0 15px 0; color: #5a7a6d;"> Cash In (Collections)</h4>
                        <table style="width: 100%;">
                            <tr>
                                <td style="padding: 8px 0; color: #666;">Sales Invoiced</td>
                                <td style="text-align: right;">${formatMoney(totalSalesInvoiced)}</td>
                            </tr>
                            <tr style="font-weight: bold; font-size: 18px;">
                                <td style="padding: 8px 0; color: #6b9a8d;">Collected</td>
                                <td style="text-align: right; color: #6b9a8d;">${formatMoney(totalSalesCollected)}</td>
                            </tr>
                            <tr style="border-top: 1px solid #c8e6c9;">
                                <td style="padding: 8px 0; color: #666;">Outstanding A/R</td>
                                <td style="text-align: right; color: #b8a86b;">${formatMoney(outstandingReceivables)}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Cash Out -->
                    <div style="background: linear-gradient(135deg, #f5e8e8 0%, #efdcdc 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #b88a8a;">
                        <h4 style="margin: 0 0 15px 0; color: #8a6a6a;"> Cash Out (Payments)</h4>
                        <table style="width: 100%;">
                            <tr>
                                <td style="padding: 8px 0; color: #666;">Purchases Invoiced</td>
                                <td style="text-align: right;">${formatMoney(totalPurchasesInvoiced)}</td>
                            </tr>
                            <tr style="font-weight: bold; font-size: 18px;">
                                <td style="padding: 8px 0; color: #b88a8a;">Paid Out</td>
                                <td style="text-align: right; color: #b88a8a;">${formatMoney(totalPurchasesPaid)}</td>
                            </tr>
                            <tr style="border-top: 1px solid #efdcdc;">
                                <td style="padding: 8px 0; color: #666;">Outstanding A/P</td>
                                <td style="text-align: right; color: #b8a86b;">${formatMoney(outstandingPayables)}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Net Cash Flow -->
                <div style="background: linear-gradient(135deg, #7a9bb8 0%, #9a8ab8 100%); padding: 25px; border-radius: 12px; color: white; text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">NET CASH FLOW</div>
                    <div style="font-size: 36px; font-weight: bold;">
                        ${netCashFlow >= 0 ? '+' : ''}${formatMoney(netCashFlow)}
                    </div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Collections minus Payments</div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0;">Summary</h4>
                    <table class="data-table">
                        <tr>
                            <td>Total Sales Orders</td>
                            <td style="text-align: right;">${salesInPeriod.length}</td>
                        </tr>
                        <tr>
                            <td>Total Purchase Orders</td>
                            <td style="text-align: right;">${posInPeriod.length}</td>
                        </tr>
                        <tr>
                            <td>Collection Rate</td>
                            <td style="text-align: right;">${totalSalesInvoiced > 0 ? (totalSalesCollected / totalSalesInvoiced * 100).toFixed(1) : 0}%</td>
                        </tr>
                        <tr>
                            <td>Payment Rate</td>
                            <td style="text-align: right;">${totalPurchasesInvoiced > 0 ? (totalPurchasesPaid / totalPurchasesInvoiced * 100).toFixed(1) : 0}%</td>
                        </tr>
                    </table>
                </div>
            `;
            
            // Add chart for cash in vs cash out
            const cashChartId = 'cashFlowChart_' + Date.now();
            
            html += `
                <div style="margin-top: 20px; margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Cash Flow Chart</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 500px;">
                            <canvas id="${cashChartId}" height="180"></canvas>
                        </div>
                    </div>
                </div>
                
                <scr` + `ipt>
                    setTimeout(() => {
                        const ctx = document.getElementById('${cashChartId}');
                        if (ctx) {
                            if(Chart.getChart(ctx))Chart.getChart(ctx).destroy(); new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: ['Cash In', 'Cash Out', 'Net Flow'],
                                    datasets: [{
                                        data: [${totalSalesCollected.toFixed(2)}, ${totalPurchasesPaid.toFixed(2)}, ${netCashFlow.toFixed(2)}],
                                        backgroundColor: ['#6b9a8d', '#b88a8a', '${netCashFlow >= 0 ? '#7a9bb8' : '#b8a86b'}'],
                                        borderRadius: 8
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: false } },
                                    scales: { y: { beginAtZero: true, ticks: { callback: (val) => '$' + val.toLocaleString() } } }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        async function generateActionDashboard() {
            // Load all report data (uses cache if available)
            await loadReportData();
            
            // Use cached data
            const sales = cachedSalesOrders.filter(s => s.Status !== 'Voided');
            const purchases = cachedPurchaseOrders.filter(p => p.Status !== 'Voided');
            const items = cachedItems;
            const customers = cachedCustomers;
            const suppliers = cachedSuppliers;
            
            if (!sales.length && !purchases.length && !items.length) {
                throw new Error('Failed to load data');
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // ===== 1. PAST DUE PAYMENTS =====
            const pastDuePayments = sales.filter(s => {
                if (s.Payment_Status === 'Paid' || !s.Due_Date) return false;
                const dueDate = new Date(s.Due_Date);
                if (dueDate >= today) return false;
                // Exclude $0 balances (already paid in full)
                const balance = parseFloat(s.Total_Amount || 0) - parseFloat(s.Amount_Paid || 0);
                return balance > 0.01;
            }).map(s => {
                const dueDate = new Date(s.Due_Date);
                const daysLate = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
                const customer = customers.find(c => c.Customer_ID === s.Customer_ID);
                let balance = parseFloat(s.Total_Amount || 0) - parseFloat(s.Amount_Paid || 0);
                if (Math.abs(balance) < 0.01) balance = 0;
                return {
                    ...s,
                    Customer_Name: customer?.Customer_Name || 'Unknown',
                    Days_Late: daysLate,
                    Balance: balance
                };
            }).sort((a, b) => b.Days_Late - a.Days_Late);
            
            // ===== 2. LATE PURCHASE ORDERS =====
            const latePOs = purchases.filter(p => {
                // Check if PO is past due (not yet received)
                if (p.Status === 'Received') return false;
                
                // Check Need By Date first, then fall back to Due Date
                const checkDate = p.Need_By_Date || p.Due_Date;
                if (!checkDate) return false;
                
                const dueDate = new Date(checkDate);
                return dueDate < today;
            }).map(p => {
                const checkDate = p.Need_By_Date || p.Due_Date;
                const dueDate = new Date(checkDate);
                const daysLate = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
                const supplier = suppliers.find(s => s.Supplier_ID === p.Supplier_ID);
                return {
                    ...p,
                    Supplier_Name: supplier?.Supplier_Name || 'Unknown',
                    Days_Late: daysLate,
                    Check_Date: checkDate,
                    Date_Type: p.Need_By_Date ? 'Need By' : 'Due'
                };
            }).sort((a, b) => b.Days_Late - a.Days_Late);
            
            // ===== 3. NEGATIVE INVENTORY =====
            const negativeInventory = items.filter(item => {
                const qty = parseFloat(item.Qty_On_Hand || 0);
                return qty < 0;
            }).map(item => {
                const qty = parseFloat(item.Qty_On_Hand || 0);
                const supplier = suppliers.find(s => s.Supplier_ID === item.Supplier_ID);
                return {
                    ...item,
                    Qty: qty,
                    Supplier_Name: supplier?.Supplier_Name || 'Unknown'
                };
            }).sort((a, b) => a.Qty - b.Qty);
            
            // ===== 4. LOW STOCK (NEEDS REORDER) =====
            // First, calculate committed stock from pending sales orders
            const committedByItem = {};
            
            // Get pending/unfulfilled sales orders
            const pendingSales = sales.filter(s => 
                s.Status === 'Pending' || s.Status === 'Ready' || s.Status === 'Out for Delivery'
            );
            
            // Fetch lines for pending orders to get committed quantities
            for (const so of pendingSales) {
                try {
                    const lines = getSalesLinesFromCache(so.SO_ID);
                    if (lines.length > 0) {
                        lines.forEach(line => {
                            const itemId = line.Item_ID;
                            const qty = parseFloat(line.Quantity) || 0;
                            if (!committedByItem[itemId]) committedByItem[itemId] = 0;
                            committedByItem[itemId] += qty;
                        });
                    }
                } catch(e) {
                    // Skip if can't fetch lines
                }
            }
            
            const lowStock = items.filter(item => {
                const qty = parseFloat(item.Qty_On_Hand || 0);
                const onOrder = parseFloat(item.Qty_On_Order || 0);
                const committed = committedByItem[item.Item_ID] || 0;
                // Available NOW (for immediate orders)
                const availableNow = qty - committed;
                // Effective available INCLUDING pending orders
                const effectiveAvailable = qty - committed + onOrder;
                const reorder = parseFloat(item.Reorder_Point || 0);
                // Only show if EFFECTIVE available (with on-order) is still below reorder point
                return effectiveAvailable <= reorder && reorder > 0;
            }).map(item => {
                const qty = parseFloat(item.Qty_On_Hand || 0);
                const onOrder = parseFloat(item.Qty_On_Order || 0);
                const committed = committedByItem[item.Item_ID] || 0;
                const availableNow = qty - committed;
                const effectiveAvailable = qty - committed + onOrder;
                const reorder = parseFloat(item.Reorder_Point || 0);
                const supplier = suppliers.find(s => s.Supplier_ID === item.Supplier_ID);
                // Units needed = gap to reach reorder point (considering what's on order)
                const unitsNeeded = Math.max(0, reorder - effectiveAvailable);
                return {
                    ...item,
                    Qty: qty,
                    Committed: committed,
                    Available: availableNow,  // Show current available (without on-order)
                    EffectiveAvailable: effectiveAvailable,  // Including on-order
                    Reorder_Point: reorder,
                    Units_Needed: unitsNeeded,
                    Supplier_Name: supplier?.Supplier_Name || 'Unknown'
                };
            }).sort((a, b) => (a.EffectiveAvailable / a.Reorder_Point) - (b.EffectiveAvailable / b.Reorder_Point));
            
            // ===== 5. DEAD STOCK (NO SALES) =====
            const deadStockDays = 180; // Configurable threshold
            const deadStockDate = new Date();
            deadStockDate.setDate(deadStockDate.getDate() - deadStockDays);
            
            const deadStock = items.filter(item => {
                const qty = parseFloat(item.Qty_On_Hand || 0);
                if (qty <= 0) return false;
                
                // Find last sale of this item
                const itemSales = sales.filter(s => {
                    const lineItems = s.Line_Items ? JSON.parse(s.Line_Items) : [];
                    return lineItems.some(li => li.Item_ID === item.Item_ID);
                });
                
                if (itemSales.length === 0) return true; // Never sold
                
                const lastSale = itemSales.sort((a, b) => 
                    new Date(b.Order_Date) - new Date(a.Order_Date)
                )[0];
                
                return new Date(lastSale.Order_Date) < deadStockDate;
            }).map(item => {
                const qty = parseFloat(item.Qty_On_Hand || 0);
                const unitCost = parseFloat(item.Package_Cost || 0) / parseFloat(item.Units_Per_Package || 1);
                // Use absolute value - dead stock value is always positive
                const value = Math.abs(qty) * unitCost;
                
                // Find last sale date
                const itemSales = sales.filter(s => {
                    const lineItems = s.Line_Items ? JSON.parse(s.Line_Items) : [];
                    return lineItems.some(li => li.Item_ID === item.Item_ID);
                }).sort((a, b) => new Date(b.Order_Date) - new Date(a.Order_Date));
                
                let daysSinceLastSale = 999;
                if (itemSales.length > 0) {
                    const lastSaleDate = new Date(itemSales[0].Order_Date);
                    daysSinceLastSale = Math.floor((today - lastSaleDate) / (1000 * 60 * 60 * 24));
                }
                
                const supplier = suppliers.find(s => s.Supplier_ID === item.Supplier_ID);
                return {
                    ...item,
                    Qty: qty,
                    Value: value,
                    Days_Since_Sale: daysSinceLastSale,
                    Supplier_Name: supplier?.Supplier_Name || 'Unknown'
                };
            }).sort((a, b) => b.Days_Since_Sale - a.Days_Since_Sale);
            
            const totalDeadStockValue = deadStock.reduce((sum, item) => sum + item.Value, 0);
            
            // ===== 6. SLOW MOVING INVENTORY =====
            const slowMovingDays = 60; // Configurable threshold
            const slowMovingDate = new Date();
            slowMovingDate.setDate(slowMovingDate.getDate() - slowMovingDays);
            
            const slowMoving = items.filter(item => {
                const qty = parseFloat(item.Qty_On_Hand || 0);
                if (qty <= 0) return false;
                
                // Find last sale of this item
                const itemSales = sales.filter(s => {
                    const lineItems = s.Line_Items ? JSON.parse(s.Line_Items) : [];
                    return lineItems.some(li => li.Item_ID === item.Item_ID);
                });
                
                if (itemSales.length === 0) return false; // This is dead stock, not slow moving
                
                const lastSale = itemSales.sort((a, b) => 
                    new Date(b.Order_Date) - new Date(a.Order_Date)
                )[0];
                
                const lastSaleDate = new Date(lastSale.Order_Date);
                return lastSaleDate < slowMovingDate && lastSaleDate >= deadStockDate;
            }).map(item => {
                const qty = parseFloat(item.Qty_On_Hand || 0);
                
                // Find last sale date
                const itemSales = sales.filter(s => {
                    const lineItems = s.Line_Items ? JSON.parse(s.Line_Items) : [];
                    return lineItems.some(li => li.Item_ID === item.Item_ID);
                }).sort((a, b) => new Date(b.Order_Date) - new Date(a.Order_Date));
                
                const lastSaleDate = new Date(itemSales[0].Order_Date);
                const daysSinceLastSale = Math.floor((today - lastSaleDate) / (1000 * 60 * 60 * 24));
                
                const supplier = suppliers.find(s => s.Supplier_ID === item.Supplier_ID);
                return {
                    ...item,
                    Qty: qty,
                    Days_Since_Sale: daysSinceLastSale,
                    Supplier_Name: supplier?.Supplier_Name || 'Unknown'
                };
            }).sort((a, b) => b.Days_Since_Sale - a.Days_Since_Sale);
            
            // ===== 7. DORMANT CUSTOMERS =====
            const dormantDays = 45; // Configurable threshold
            const dormantDate = new Date();
            dormantDate.setDate(dormantDate.getDate() - dormantDays);
            
            const dormantCustomers = customers.filter(c => {
                const customerSales = sales.filter(s => s.Customer_ID === c.Customer_ID);
                if (customerSales.length === 0) return false; // Never bought - not dormant, just never active
                
                const lastSale = customerSales.sort((a, b) => 
                    new Date(b.Order_Date) - new Date(a.Order_Date)
                )[0];
                
                return new Date(lastSale.Order_Date) < dormantDate;
            }).map(c => {
                const customerSales = sales.filter(s => s.Customer_ID === c.Customer_ID)
                    .sort((a, b) => new Date(b.Order_Date) - new Date(a.Order_Date));
                
                const lastSaleDate = new Date(customerSales[0].Order_Date);
                const daysSinceLastOrder = Math.floor((today - lastSaleDate) / (1000 * 60 * 60 * 24));
                
                const totalSales = customerSales.reduce((sum, s) => 
                    sum + parseFloat(s.Total_Amount || 0), 0
                );
                
                return {
                    ...c,
                    Last_Order_Date: lastSaleDate,
                    Days_Since_Order: daysSinceLastOrder,
                    Total_Sales: totalSales
                };
            }).sort((a, b) => b.Total_Sales - a.Total_Sales); // Sort by best customers first
            
            // ===== 8. QTY ON ORDER SYNC CHECK =====
            // Calculate expected Qty_On_Order from pending POs
            const pendingPOIds = new Set();
            purchases.forEach(p => {
                const status = (p.Status || '').trim();
                const poType = (p.PO_Type || 'INCOMING').trim();
                // Include OUTGOING POs (orders sent to supplier, waiting for goods)
                // and INCOMING POs that aren't received or voided
                if ((poType === 'OUTGOING' || poType === 'INCOMING') && 
                    status !== 'Received' && status !== 'Voided' && status !== 'Cancelled') {
                    pendingPOIds.add(p.PO_ID);
                }
            });
            
            // Use cached PO lines (loaded by loadReportData)
            const poLines = cachedPurchaseLines || [];
            
            const expectedOnOrderByItem = {};
            poLines.forEach(line => {
                if (!pendingPOIds.has(line.PO_ID)) return;
                
                const itemId = (line.Item_ID || '').trim();
                const qtyOrdered = parseInt(line.Quantity) || 0;
                const qtyReceived = parseInt(line.Qty_Received) || 0;
                const pendingCases = Math.max(0, qtyOrdered - qtyReceived);
                
                if (!itemId || pendingCases <= 0) return;
                
                // Find units per package for this item
                const item = items.find(i => i.Item_ID === itemId);
                const unitsPerPkg = parseInt(item?.Units_Per_Package) || 1;
                const pendingUnits = pendingCases * unitsPerPkg;
                
                expectedOnOrderByItem[itemId] = (expectedOnOrderByItem[itemId] || 0) + pendingUnits;
            });
            
            // Find items where Qty_On_Order doesn't match expected
            const qtyOnOrderMismatch = items.filter(item => {
                const currentOnOrder = parseInt(item.Qty_On_Order) || 0;
                const expectedOnOrder = expectedOnOrderByItem[item.Item_ID] || 0;
                return currentOnOrder !== expectedOnOrder;
            }).map(item => {
                const currentOnOrder = parseInt(item.Qty_On_Order) || 0;
                const expectedOnOrder = expectedOnOrderByItem[item.Item_ID] || 0;
                const supplier = suppliers.find(s => s.Supplier_ID === item.Supplier_ID);
                return {
                    ...item,
                    Current_On_Order: currentOnOrder,
                    Expected_On_Order: expectedOnOrder,
                    Difference: currentOnOrder - expectedOnOrder,
                    Supplier_Name: supplier?.Supplier_Name || 'Unknown'
                };
            }).sort((a, b) => Math.abs(b.Difference) - Math.abs(a.Difference));
            
            // ===== BUILD HTML =====
            let html = `
                <style>
                    .action-section {
                        background: white;
                        border-radius: 16px;
                        padding: 25px;
                        margin-bottom: 25px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 2px 6px rgba(0,0,0,0.04);
                        border-left: 6px solid #666;
                        transition: transform 0.2s, box-shadow 0.2s;
                        overflow: hidden;
                    }
                    .action-section:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 8px 20px rgba(0,0,0,0.12), 0 4px 10px rgba(0,0,0,0.06);
                    }
                    .action-section.critical { 
                        border-left-color: #b88a8a;
                        border-left-width: 6px;
                    }
                    .action-section.warning { 
                        border-left-color: #b8a86b;
                        border-left-width: 6px;
                    }
                    .action-section.info { 
                        border-left-color: #3b82f6;
                        border-left-width: 6px;
                    }
                    .action-section-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        padding-bottom: 15px;
                        border-bottom: 3px solid #e5e7eb;
                    }
                    .action-section-title {
                        font-size: 22px;
                        font-weight: 700;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        color: #1f2937;
                    }
                    .action-count {
                        background: linear-gradient(135deg, #b88a8a, #b88a8a);
                        color: white;
                        padding: 6px 16px;
                        border-radius: 20px;
                        font-size: 15px;
                        font-weight: 700;
                        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
                    }
                    .action-count.warning {
                        background: linear-gradient(135deg, #b8a86b, #fbbf24);
                        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
                    }
                    .action-count.info {
                        background: linear-gradient(135deg, #3b82f6, #60a5fa);
                        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
                    }
                    .action-table-wrapper {
                        overflow-x: auto;
                        -webkit-overflow-scrolling: touch;
                        margin: 0 -10px;
                        padding: 0 10px;
                        max-width: 100%;
                    }
                    .action-table {
                        width: 100%;
                        min-width: 800px;
                        border-collapse: separate;
                        border-spacing: 0;
                        margin-top: 15px;
                        border-radius: 8px;
                        overflow: hidden;
                        border: 1px solid #e5e7eb;
                        font-size: 13px;
                    }
                    .action-table th {
                        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
                        padding: 10px 8px;
                        text-align: left;
                        font-weight: 600;
                        font-size: 11px;
                        color: #374151;
                        border-bottom: 2px solid #d1d5db;
                        white-space: nowrap;
                    }
                    .action-table td {
                        padding: 10px 8px;
                        border-bottom: 1px solid #e5e7eb;
                        font-size: 12px;
                        white-space: nowrap;
                    }
                    .action-table tr:last-child td {
                        border-bottom: none;
                    }
                    .action-table tbody tr:hover {
                        background: #f9fafb;
                        transition: background 0.2s;
                    }
                    .action-btn {
                        padding: 8px 16px;
                        border-radius: 8px;
                        border: none;
                        cursor: pointer;
                        font-size: 13px;
                        font-weight: 600;
                        transition: all 0.2s;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .action-btn:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                    }
                    .action-btn-primary {
                        background: linear-gradient(135deg, #3b82f6, #60a5fa);
                        color: white;
                    }
                    .action-btn-primary:hover {
                        background: linear-gradient(135deg, #2563eb, #3b82f6);
                    }
                    .action-btn-success {
                        background: linear-gradient(135deg, #10b981, #34d399);
                        color: white;
                    }
                    .action-btn-success:hover {
                        background: linear-gradient(135deg, #059669, #10b981);
                    }
                    .action-btn-warning {
                        background: linear-gradient(135deg, #b8a86b, #fbbf24);
                        color: white;
                    }
                    .action-btn-warning:hover {
                        background: linear-gradient(135deg, #d97706, #b8a86b);
                    }
                    .action-btn-danger {
                        background: linear-gradient(135deg, #b88a8a, #f87171);
                        color: white;
                    }
                    .action-btn-danger:hover {
                        background: linear-gradient(135deg, #b88a8a, #b88a8a);
                    }
                    .days-late {
                        color: #b88a8a;
                        font-weight: 700;
                    }
                    .summary-box {
                        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
                        border: 2px solid #fecaca;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 20px;
                        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.1);
                    }
                    .summary-item {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 8px;
                    }
                    .summary-label {
                        font-weight: 600;
                        color: #374151;
                    }
                    .summary-value {
                        font-weight: 700;
                        color: #b88a8a;
                    }
                    
                    /* Oval Action Buttons */
                    .oval-action-btn {
                        padding: 6px 14px;
                        border-radius: 20px;
                        border: 2px solid;
                        font-size: 13px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s;
                        white-space: nowrap;
                        display: inline-flex;
                        align-items: center;
                        gap: 4px;
                    }
                    .oval-action-btn:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                    }
                    .oval-action-primary {
                        background: #3b82f6;
                        color: white;
                        border-color: #2563eb;
                    }
                    .oval-action-primary:hover {
                        background: #2563eb;
                    }
                    .oval-action-success {
                        background: #10b981;
                        color: white;
                        border-color: #059669;
                    }
                    .oval-action-success:hover {
                        background: #059669;
                    }
                    .oval-action-warning {
                        background: #b8a86b;
                        color: white;
                        border-color: #d97706;
                    }
                    .oval-action-warning:hover {
                        background: #d97706;
                    }
                    .oval-action-info {
                        background: #06b6d4;
                        color: white;
                        border-color: #0891b2;
                    }
                    .oval-action-info:hover {
                        background: #0891b2;
                    }
                    .oval-action-danger {
                        background: #b88a8a;
                        color: white;
                        border-color: #b88a8a;
                    }
                    .oval-action-danger:hover {
                        background: #b88a8a;
                    }
                    
                    /* Action Dashboard Container - Locked Layout */
                    .action-dashboard-container {
                        max-width: 100%;
                        margin: 0 auto;
                        position: relative;
                        display: flex;
                        flex-direction: column;
                        gap: 0;
                        min-height: auto;
                        overflow: visible;
                    }
                    
                    /* Ensure sections don't shift */
                    .action-dashboard-container .action-section {
                        flex-shrink: 0;
                        position: relative;
                    }
                    
                    /* Mobile-specific fixes for Action Dashboard */
                    @media (max-width: 768px) {
                        .action-dashboard-container {
                            width: 100% !important;
                            max-width: 100% !important;
                            padding: 0 !important;
                            margin: 0 !important;
                        }
                        
                        .action-dashboard-container > div {
                            max-width: 100% !important;
                            overflow-x: hidden !important;
                        }
                        
                        /* Header */
                        .action-dashboard-container > div:first-child {
                            padding: 20px !important;
                            margin-bottom: 15px !important;
                            border-radius: 10px !important;
                        }
                        
                        .action-dashboard-container > div:first-child h2 {
                            font-size: 22px !important;
                        }
                        
                        .action-dashboard-container > div:first-child p {
                            font-size: 13px !important;
                        }
                        
                        /* Action sections */
                        .action-section {
                            padding: 15px !important;
                            margin-bottom: 15px !important;
                            border-radius: 10px !important;
                        }
                        
                        .action-section-header {
                            flex-direction: column !important;
                            align-items: flex-start !important;
                            gap: 10px !important;
                        }
                        
                        .action-section-title {
                            font-size: 16px !important;
                        }
                        
                        /* Tables in Action Dashboard */
                        .action-dashboard-container table {
                            font-size: 12px !important;
                        }
                        
                        .action-dashboard-container th,
                        .action-dashboard-container td {
                            padding: 8px 6px !important;
                        }
                        
                        /* Action buttons */
                        .oval-action-btn {
                            padding: 5px 10px !important;
                            font-size: 11px !important;
                        }
                        
                        /* Summary box */
                        .summary-box {
                            padding: 12px !important;
                        }
                    }
                    
                    /* Landscape-specific fixes for Action Dashboard */
                    @media (max-height: 500px) and (orientation: landscape) {
                        .action-dashboard-container {
                            width: 100% !important;
                            max-width: 100% !important;
                            padding: 0 !important;
                            margin: 0 !important;
                        }
                        
                        .action-dashboard-container > div {
                            max-width: 100% !important;
                            overflow-x: hidden !important;
                        }
                        
                        /* Header - compact in landscape */
                        .action-dashboard-container > div:first-child {
                            padding: 10px 15px !important;
                            margin-bottom: 10px !important;
                            border-radius: 8px !important;
                        }
                        
                        .action-dashboard-container > div:first-child h2 {
                            font-size: 16px !important;
                            margin-bottom: 0 !important;
                        }
                        
                        .action-dashboard-container > div:first-child p {
                            display: none !important;
                        }
                        
                        /* Action sections - compact */
                        .action-section {
                            padding: 10px !important;
                            margin-bottom: 10px !important;
                            border-radius: 8px !important;
                        }
                        
                        .action-section-header {
                            flex-direction: row !important;
                            align-items: center !important;
                            gap: 10px !important;
                            padding: 5px 0 !important;
                        }
                        
                        .action-section-title {
                            font-size: 14px !important;
                        }
                        
                        /* Tables in Action Dashboard - compact */
                        .action-dashboard-container table {
                            font-size: 11px !important;
                        }
                        
                        .action-dashboard-container th,
                        .action-dashboard-container td {
                            padding: 5px 4px !important;
                        }
                        
                        /* Action buttons - smaller */
                        .oval-action-btn {
                            padding: 3px 8px !important;
                            font-size: 10px !important;
                        }
                        
                        /* Summary box - compact */
                        .summary-box {
                            padding: 8px !important;
                            margin-bottom: 10px !important;
                        }
                        
                        .summary-item {
                            margin-bottom: 4px !important;
                            font-size: 12px !important;
                        }
                    }
                </style>
                
                <div class="action-dashboard-container">
                <div style="background: linear-gradient(135deg, #b88a8a 0%, #b88a8a 100%); color: white; padding: 35px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(220, 38, 38, 0.3), 0 4px 12px rgba(0,0,0,0.1); border: 2px solid rgba(255, 255, 255, 0.1);">
                    <h2 style="margin: 0 0 10px 0; font-size: 32px; display: flex; align-items: center; gap: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                         ACTION DASHBOARD
                    </h2>
                    <p style="margin: 0; font-size: 16px; opacity: 0.95;">
                        Critical issues requiring immediate attention
                    </p>
                </div>
            `;
            
            // 1. PAST DUE PAYMENTS
            html += `
                <div class="action-section critical">
                    <div class="action-section-header">
                        <div class="action-section-title">
                             PAST DUE PAYMENTS
                            <span class="action-count">${pastDuePayments.length}</span>
                        </div>
                        ${pastDuePayments.length > 0 ? '<button class="action-btn action-btn-primary" onclick="showInfo(\'Send Reminder feature coming soon!\')"> Send Reminders</button>' : ''}
                    </div>
                    <p style="color: #6b7280; font-size: 14px; margin: -10px 0 15px 0; padding: 0; line-height: 1.5;">
                        <strong>Customer invoices (sales orders)</strong> where the due date has passed and payment is not yet received. Sorted by most overdue first.
                    </p>
            `;
            
            if (pastDuePayments.length === 0) {
                html += '<p style="color: #10b981; font-weight: 600;"> No past due payments!</p>';
            } else {
                const totalPastDue = pastDuePayments.reduce((sum, p) => sum + p.Balance, 0);
                html += `
                    <div class="summary-box">
                        <div class="summary-item">
                            <span class="summary-label">Total Past Due Amount:</span>
                            <span class="summary-value">${formatMoney(totalPastDue)}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Number of Customers:</span>
                            <span class="summary-value">${new Set(pastDuePayments.map(p => p.Customer_ID)).size}</span>
                        </div>
                    </div>
                    <table class="action-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Invoice</th>
                                <th>Sale Date</th>
                                <th>Due Date</th>
                                <th>Days Late</th>
                                <th>Balance</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                pastDuePayments.slice(0, 10).forEach(p => {
                    const dueDate = new Date(p.Due_Date);
                    const dueDateStr = (dueDate.getMonth()+1) + '/' + dueDate.getDate() + '/' + dueDate.getFullYear();
                    const saleDate = p.Sale_Date ? new Date(p.Sale_Date) : null;
                    const saleDateStr = saleDate ? (saleDate.getMonth()+1) + '/' + saleDate.getDate() + '/' + saleDate.getFullYear() : '-';
                    html += `
                        <tr>
                            <td>${p.Customer_Name}</td>
                            <td>${p.Invoice_Number || p.SO_ID || 'N/A'}</td>
                            <td>${saleDateStr}</td>
                            <td>${dueDateStr}</td>
                            <td class="days-late">${p.Days_Late} days</td>
                            <td>${formatMoney(p.Balance)}</td>
                            <td>
                                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                    <button class="oval-action-btn oval-action-primary" onclick="viewSaleOrder('${p.SO_ID}')"> View</button>
                                    <button class="oval-action-btn oval-action-success" onclick="recordSalesPayment('${p.SO_ID}', ${p.Total_Amount || 0}, ${p.Amount_Paid || 0})"> Pay</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                if (pastDuePayments.length > 10) {
                    html += `<tr><td colspan="6" style="text-align: center; color: #666; padding: 15px;">... and ${pastDuePayments.length - 10} more</td></tr>`;
                }
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            html += '</div>';
            
            // 2. LATE PURCHASE ORDERS
            html += `
                <div class="action-section warning">
                    <div class="action-section-header">
                        <div class="action-section-title">
                             LATE PURCHASE ORDERS
                            <span class="action-count warning">${latePOs.length}</span>
                        </div>
                    </div>
                    <p style="color: #6b7280; font-size: 14px; margin: -10px 0 15px 0; padding: 0; line-height: 1.5;">
                        <strong>Inbound orders from suppliers</strong> where the "Need By Date" has passed and the order is not yet received. Only shows POs that have a Need By Date set.
                    </p>
            `;
            
            if (latePOs.length === 0) {
                html += '<p style="color: #10b981; font-weight: 600;"> No late purchase orders!</p>';
            } else {
                html += `
                    <table class="action-table">
                        <thead>
                            <tr>
                                <th>Supplier</th>
                                <th>PO #</th>
                                <th>Need By Date</th>
                                <th>Days Late</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                latePOs.forEach(p => {
                    const checkDate = new Date(p.Check_Date);
                    const dateStr = !isNaN(checkDate) ? (checkDate.getMonth()+1) + '/' + checkDate.getDate() + '/' + checkDate.getFullYear() : 'N/A';
                    html += `
                        <tr>
                            <td>${p.Supplier_Name}</td>
                            <td>PO-${p.PO_ID}</td>
                            <td>${dateStr}</td>
                            <td class="days-late">${p.Days_Late} days</td>
                            <td>${p.Status}</td>
                            <td>
                                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                    <button class="oval-action-btn oval-action-warning" onclick="viewPurchaseOrder('${p.PO_ID}')"> View</button>
                                    <button class="oval-action-btn oval-action-info" onclick="receivePO('${p.PO_ID}')"> Receive</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            html += '</div>';
            
            // 3. NEGATIVE INVENTORY
            html += `
                <div class="action-section critical">
                    <div class="action-section-header">
                        <div class="action-section-title">
                             NEGATIVE INVENTORY
                            <span class="action-count">${negativeInventory.length}</span>
                        </div>
                        ${negativeInventory.length > 0 ? '<button class="action-btn action-btn-danger" onclick="openQuickAdjustForNegative()">Fix Now</button>' : ''}
                    </div>
                    <p style="color: #6b7280; font-size: 14px; margin: -10px 0 15px 0; padding: 0; line-height: 1.5;">
                        <strong>Items sold before received</strong> - Qty On Hand is below zero. This indicates you sold more than you had in stock. Needs immediate correction.
                    </p>
            `;
            
            if (negativeInventory.length === 0) {
                html += '<p style="color: #10b981; font-weight: 600;"> No negative inventory!</p>';
            } else {
                html += `
                    <table class="action-table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Item</th>
                                <th>Supplier</th>
                                <th>Current Qty</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                negativeInventory.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.SKU || 'N/A'}</td>
                            <td>${item.Item_Description}</td>
                            <td>${item.Supplier_Name}</td>
                            <td class="days-late">${item.Qty} units</td>
                            <td>
                                <button class="oval-action-btn oval-action-danger" onclick="createInventoryAdjustment('${item.Item_ID}')"> Adjust</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            html += '</div>';
            
            // 3.5. QTY ON ORDER SYNC
            html += `
                <div class="action-section ${qtyOnOrderMismatch.length > 0 ? 'warning' : 'info'}">
                    <div class="action-section-header">
                        <div class="action-section-title">
                             QTY ON ORDER SYNC
                            <span class="action-count ${qtyOnOrderMismatch.length > 0 ? 'warning' : 'info'}">${qtyOnOrderMismatch.length}</span>
                        </div>
                        ${qtyOnOrderMismatch.length > 0 ? '<button class="action-btn action-btn-warning" onclick="fixQtyOnOrderFromDashboard()"> Fix All</button>' : ''}
                    </div>
                    <p style="color: #6b7280; font-size: 14px; margin: -10px 0 15px 0; padding: 0; line-height: 1.5;">
                        <strong>Items where Qty On Order doesn't match pending POs.</strong> This can happen if POs were edited manually or data got out of sync.
                    </p>
            `;
            
            if (qtyOnOrderMismatch.length === 0) {
                html += '<p style="color: #10b981; font-weight: 600;"> All Qty On Order values are in sync!</p>';
            } else {
                html += `
                    <div class="action-table-wrapper">
                    <table class="action-table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Item</th>
                                <th>Supplier</th>
                                <th style="text-align: right;">Current</th>
                                <th style="text-align: right;">Expected</th>
                                <th style="text-align: right;">Difference</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                qtyOnOrderMismatch.slice(0, 15).forEach(item => {
                    const diffColor = item.Difference > 0 ? '#b88a8a' : '#059669';
                    const diffSign = item.Difference > 0 ? '+' : '';
                    html += `
                        <tr>
                            <td>${item.SKU || 'N/A'}</td>
                            <td>${item.Item_Description || 'Unknown'}</td>
                            <td>${item.Supplier_Name}</td>
                            <td style="text-align: right; font-weight: bold;">${item.Current_On_Order}</td>
                            <td style="text-align: right; color: #059669; font-weight: bold;">${item.Expected_On_Order}</td>
                            <td style="text-align: right; color: ${diffColor}; font-weight: bold;">${diffSign}${item.Difference}</td>
                        </tr>
                    `;
                });
                
                if (qtyOnOrderMismatch.length > 15) {
                    html += `<tr><td colspan="6" style="text-align: center; color: #666; padding: 15px;">... and ${qtyOnOrderMismatch.length - 15} more items</td></tr>`;
                }
                
                html += `
                        </tbody>
                    </table>
                    </div>
                `;
            }
            html += '</div>';
            
            // Get unique suppliers from lowStock for filter dropdown
            const lowStockSuppliers = [...new Set(lowStock.map(item => item.Supplier_ID))].map(suppId => {
                const supp = (cachedSuppliers || []).find(s => s.Supplier_ID === suppId);
                return { id: suppId, name: supp?.Supplier_Name || suppId };
            }).sort((a, b) => a.name.localeCompare(b.name));
            
            // 4. LOW STOCK
            html += `
                <div class="action-section warning">
                    <div class="action-section-header">
                        <div class="action-section-title">
                             LOW STOCK - NEEDS REORDER
                            <span class="action-count warning">${lowStock.length}</span>
                        </div>
                        ${lowStock.length > 0 ? '<button class="action-btn action-btn-success" onclick="bulkReorder()"> Bulk Reorder</button>' : ''}
                    </div>
                    <p style="color: #6b7280; font-size: 14px; margin: -10px 0 15px 0; padding: 0; line-height: 1.5;">
                        <strong>Items at or below reorder point</strong> (considering pending orders). Sorted by lowest availability first.
                    </p>
                    ${lowStock.length > 0 ? `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <label style="font-weight: 600; color: #666; font-size: 13px;"> Filter by Supplier:</label>
                        <select id="lowStockSupplierFilter" onchange="filterLowStockTable()" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; min-width: 200px;">
                            <option value="">All Suppliers (${lowStock.length})</option>
                            ${lowStockSuppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                        </select>
                        <span id="lowStockFilterCount" style="font-size: 13px; color: #888;"></span>
                    </div>
                    ` : ''}
                    <div style="background: #fffbeb; border: 1px solid #b8a86b; border-radius: 8px; padding: 12px 16px; margin-bottom: 15px;">
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 6px;"> Gap Formula:</div>
                        <div style="font-family: monospace; font-size: 13px; color: #78350f; line-height: 1.6;">
                            Effective Available = On Hand  Committed + On Order<br>
                            Gap = Reorder Point  Effective Available<br>
                            <em style="font-size: 12px; color: #a16207;">Items only appear here if Effective Available (including pending POs) is below Reorder Point.</em>
                        </div>
                    </div>
            `;
            
            if (lowStock.length === 0) {
                html += '<p style="color: #10b981; font-weight: 600;"> All items adequately stocked!</p>';
            } else {
                html += `
                    <div class="action-table-wrapper">
                    <table class="action-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllLowStock" onclick="toggleSelectAllLowStock()"></th>
                                <th>SKU</th>
                                <th>Item</th>
                                <th>Supplier</th>
                                <th style="text-align: center;">On Hand</th>
                                <th style="text-align: center;">On Order</th>
                                <th style="text-align: center;">Backorder</th>
                                <th style="text-align: center;">Committed</th>
                                <th style="text-align: center;">Available</th>
                                <th style="text-align: center;">Reorder Pt</th>
                                <th style="text-align: center;">Gap</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                lowStock.forEach(item => {
                    const backorder = parseInt(item.Qty_On_Backorder) || 0;
                    const onOrder = parseInt(item.Qty_On_Order) || 0;
                    html += `
                        <tr data-supplier-id="${item.Supplier_ID}">
                            <td><input type="checkbox" class="lowstock-checkbox" data-item-id="${item.Item_ID}" data-units-needed="${Math.ceil(item.Units_Needed)}"></td>
                            <td>${item.SKU || 'N/A'}</td>
                            <td>${item.Item_Description}</td>
                            <td>${item.Supplier_Name}</td>
                            <td style="text-align: center;">${item.Qty}</td>
                            <td style="text-align: center; color: ${onOrder > 0 ? '#2563eb' : '#666'}; font-weight: ${onOrder > 0 ? '600' : 'normal'}; background: ${onOrder > 0 ? '#eff6ff' : 'transparent'};">${onOrder > 0 ? ' ' + onOrder : '-'}</td>
                            <td style="text-align: center; color: ${backorder > 0 ? '#b88a8a' : '#666'}; font-weight: ${backorder > 0 ? '600' : 'normal'};">${backorder > 0 ? backorder : '-'}</td>
                            <td style="text-align: center; color: ${item.Committed > 0 ? '#b88a8a' : '#666'};">${item.Committed > 0 ? '-' + item.Committed : '0'}</td>
                            <td style="text-align: center; font-weight: 600; color: ${item.Available < 0 ? '#b88a8a' : '#059669'};">${item.Available}</td>
                            <td style="text-align: center;">${item.Reorder_Point}</td>
                            <td style="text-align: center; font-weight: 700; color: #b8a86b;">${Math.ceil(item.Units_Needed)}</td>
                            <td>
                                ${onOrder > 0 
                                    ? `<span style="color: #2563eb; font-size: 12px; font-weight: 600;">PO Pending</span>`
                                    : `<button class="oval-action-btn oval-action-success" onclick="createPOForItem('${item.Item_ID}', ${Math.ceil(item.Units_Needed)})"> Order</button>`
                                }
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                    </div>
                `;
            }
            html += '</div>';
            
            // 5. DEAD STOCK
            html += `
                <div class="action-section critical">
                    <div class="action-section-header">
                        <div class="action-section-title">
                             DEAD STOCK - NO SALES
                            <span class="action-count">${deadStock.length}</span>
                        </div>
                    </div>
                    <p style="color: #6b7280; font-size: 14px; margin: -10px 0 15px 0; padding: 0; line-height: 1.5;">
                        <strong>Items with no sales in 180+ days</strong> (or never sold). Has qty on hand but hasn't moved. Capital tied up in non-moving inventory. Top 10 shown.
                    </p>
            `;
            
            if (deadStock.length === 0) {
                html += '<p style="color: #10b981; font-weight: 600;"> No dead stock!</p>';
            } else {
                html += `
                    <div class="summary-box">
                        <div class="summary-item">
                            <span class="summary-label">Total Items:</span>
                            <span class="summary-value">${deadStock.length}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Total Units:</span>
                            <span class="summary-value">${deadStock.reduce((sum, i) => sum + i.Qty, 0).toFixed(0)}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Capital Tied Up:</span>
                            <span class="summary-value">${formatMoney(totalDeadStockValue)}</span>
                        </div>
                    </div>
                    <div class="action-table-wrapper">
                    <table class="action-table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Item</th>
                                <th>Supplier</th>
                                <th>On Hand</th>
                                <th>Last Sale</th>
                                <th>Value</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                deadStock.slice(0, 10).forEach(item => {
                    html += `
                        <tr>
                            <td>${item.SKU || 'N/A'}</td>
                            <td>${item.Item_Description}</td>
                            <td>${item.Supplier_Name}</td>
                            <td>${item.Qty}</td>
                            <td class="days-late">${item.Days_Since_Sale === 999 ? 'Never' : item.Days_Since_Sale + ' days ago'}</td>
                            <td>${formatMoney(item.Value)}</td>
                            <td>
                                <button class="oval-action-btn oval-action-warning" onclick="markForClearance('${item.Item_ID}')"> Clearance</button>
                            </td>
                        </tr>
                    `;
                });
                
                if (deadStock.length > 10) {
                    html += `<tr><td colspan="7" style="text-align: center; color: #666; padding: 15px;">... and ${deadStock.length - 10} more</td></tr>`;
                }
                
                html += `
                        </tbody>
                    </table>
                    </div>
                `;
            }
            html += '</div>';
            
            // 6. SLOW MOVING
            html += `
                <div class="action-section info">
                    <div class="action-section-header">
                        <div class="action-section-title">
                             SLOW MOVING INVENTORY
                            <span class="action-count info">${slowMoving.length}</span>
                        </div>
                    </div>
                    <p style="color: #6b7280; font-size: 14px; margin: -10px 0 15px 0; padding: 0; line-height: 1.5;">
                        <strong>Items with sales 60-180 days ago</strong> - Moving, but slowly. Not dead yet, but approaching it. Consider promotions. Top 10 shown.
                    </p>
            `;
            
            if (slowMoving.length === 0) {
                html += '<p style="color: #10b981; font-weight: 600;"> No slow moving items!</p>';
            } else {
                html += `
                    <table class="action-table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Item</th>
                                <th>Supplier</th>
                                <th>On Hand</th>
                                <th>Last Sale</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                slowMoving.slice(0, 10).forEach(item => {
                    html += `
                        <tr>
                            <td>${item.SKU || 'N/A'}</td>
                            <td>${item.Item_Description}</td>
                            <td>${item.Supplier_Name}</td>
                            <td>${item.Qty}</td>
                            <td>${item.Days_Since_Sale} days ago</td>
                            <td>
                                <button class="oval-action-btn oval-action-info" onclick="showInfo('Promotion feature coming soon!')"> Promote</button>
                            </td>
                        </tr>
                    `;
                });
                
                if (slowMoving.length > 10) {
                    html += `<tr><td colspan="6" style="text-align: center; color: #666; padding: 15px;">... and ${slowMoving.length - 10} more</td></tr>`;
                }
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            html += '</div>';
            
            // 7. DORMANT CUSTOMERS
            html += `
                <div class="action-section info">
                    <div class="action-section-header">
                        <div class="action-section-title">
                             DORMANT CUSTOMERS
                            <span class="action-count info">${dormantCustomers.length}</span>
                        </div>
                        ${dormantCustomers.length > 0 ? '<button class="action-btn action-btn-primary" onclick="exportDormantCustomers()"> Export List</button>' : ''}
                    </div>
                    <p style="color: #6b7280; font-size: 14px; margin: -10px 0 15px 0; padding: 0; line-height: 1.5;">
                        <strong>Customers who haven't ordered in 45+ days</strong> - Previously active customers who have stopped buying. Sorted by highest lifetime sales (best customers first). Top 15 shown.
                    </p>
            `;
            
            if (dormantCustomers.length === 0) {
                html += '<p style="color: #10b981; font-weight: 600;"> All customers active!</p>';
            } else {
                html += `
                    <table class="action-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Last Order</th>
                                <th>Days Ago</th>
                                <th>Total Sales</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                dormantCustomers.slice(0, 15).forEach(c => {
                    const lastOrderStr = (c.Last_Order_Date.getMonth()+1) + '/' + c.Last_Order_Date.getDate() + '/' + c.Last_Order_Date.getFullYear();
                    html += `
                        <tr>
                            <td>${c.Customer_Name}</td>
                            <td>${lastOrderStr}</td>
                            <td>${c.Days_Since_Order} days</td>
                            <td>${formatMoney(c.Total_Sales)}</td>
                            <td>
                                <button class="oval-action-btn oval-action-info" onclick="scheduleCustomerVisit('${c.Customer_ID}')"> Visit</button>
                            </td>
                        </tr>
                    `;
                });
                
                if (dormantCustomers.length > 15) {
                    html += `<tr><td colspan="5" style="text-align: center; color: #666; padding: 15px;">... and ${dormantCustomers.length - 15} more</td></tr>`;
                }
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            html += '</div>';
            
            // Close the container wrapper
            html += '</div>'; // End action-dashboard-container
            
            return html;
        }
        
        // ========== CUSTOMER BACKORDERS REPORT ==========
        async function generateCustomerBackordersModal() {
            // Load all report data (uses cache if available)
            await loadReportData();
            
            const sales = cachedSalesOrders.filter(s => s.Status !== 'Voided');
            const items = cachedItems;
            const customers = cachedCustomers;
            const suppliers = cachedSuppliers;
            const purchases = cachedPurchaseOrders.filter(p => p.Status !== 'Voided' && p.Status !== 'Cancelled');
            
            if (!items.length) {
                throw new Error('Failed to load data');
            }
            
            // Build item lookup with supplier info
            const itemMap = {};
            items.forEach(item => {
                const supplier = suppliers.find(s => s.Supplier_ID === item.Supplier_ID);
                itemMap[item.Item_ID] = {
                    ...item,
                    supplierName: supplier?.Supplier_Name || 'Unknown',
                    qtyOnHand: parseInt(item.Qty_On_Hand) || 0,
                    qtyOnOrder: parseInt(item.Qty_On_Order) || 0,
                    qtyOnBackorder: parseInt(item.Qty_On_Backorder) || 0
                };
            });
            
            // Find items that actually have backorders (Qty_On_Backorder > 0)
            const backorderedItemIds = new Set(
                items.filter(i => (parseInt(i.Qty_On_Backorder) || 0) > 0).map(i => i.Item_ID)
            );
            
            // Find pending sales orders that contain backordered items
            const pendingSales = sales.filter(s => 
                s.Status === 'Pending' || s.Status === 'Ready' || s.Status === 'Out for Delivery'
            );
            
            // Track backorders by customer and by item
            const customerBackorders = {}; // customerId -> { customerName, orders: [{ soId, invoiceNum, items: [...] }] }
            const itemBackorders = {}; // itemId -> { item info, customers: [{ customerId, customerName, qty, soId }], totalNeeded }
            
            // Fetch line items for each pending order
            for (const so of pendingSales) {
                try {
                    const lines = getSalesLinesFromCache(so.SO_ID);
                    if (!lines || lines.length === 0) continue;
                    
                    const customer = customers.find(c => c.Customer_ID === so.Customer_ID);
                    const customerName = customer?.Customer_Name || 'Unknown';
                    
                    for (const line of lines) {
                        const item = itemMap[line.Item_ID];
                        if (!item) continue;
                        
                        const qty = parseInt(line.Quantity) || 0;
                        const qtyOnHand = item.qtyOnHand;
                        
                        // Check if this item is on backorder (has Qty_On_Backorder > 0 OR negative stock)
                        if (backorderedItemIds.has(line.Item_ID) || qtyOnHand < 0) {
                            // Add to customer backorders
                            if (!customerBackorders[so.Customer_ID]) {
                                // Get full customer info including address
                                const customerInfo = customers.find(c => c.Customer_ID === so.Customer_ID);
                                const address = customerInfo ? [customerInfo.Address, customerInfo.City, customerInfo.State].filter(Boolean).join(', ') : '';
                                
                                customerBackorders[so.Customer_ID] = {
                                    customerName: customerName,
                                    customerId: so.Customer_ID,
                                    customerAddress: address,
                                    orders: []
                                };
                            }
                            
                            // Find or create order entry
                            let orderEntry = customerBackorders[so.Customer_ID].orders.find(o => o.soId === so.SO_ID);
                            if (!orderEntry) {
                                orderEntry = {
                                    soId: so.SO_ID,
                                    invoiceNum: so.Invoice_Number || so.SO_ID,
                                    soDate: so.Sale_Date || so.SO_Date,
                                    items: []
                                };
                                customerBackorders[so.Customer_ID].orders.push(orderEntry);
                            }
                            
                            orderEntry.items.push({
                                itemId: line.Item_ID,
                                itemDesc: item.Item_Description,
                                sku: item.SKU,
                                supplierName: item.supplierName,
                                supplierId: item.Supplier_ID,
                                qtyOrdered: qty,
                                qtyOnHand: qtyOnHand,
                                qtyOnOrder: item.qtyOnOrder,
                                qtyOnBackorder: item.qtyOnBackorder
                            });
                            
                            // Add to item backorders
                            if (!itemBackorders[line.Item_ID]) {
                                itemBackorders[line.Item_ID] = {
                                    itemId: line.Item_ID,
                                    itemDesc: item.Item_Description,
                                    sku: item.SKU,
                                    supplierName: item.supplierName,
                                    supplierId: item.Supplier_ID,
                                    qtyOnHand: qtyOnHand,
                                    qtyOnOrder: item.qtyOnOrder,
                                    qtyOnBackorder: item.qtyOnBackorder,
                                    customers: [],
                                    totalNeeded: 0
                                };
                            }
                            
                            itemBackorders[line.Item_ID].customers.push({
                                customerId: so.Customer_ID,
                                customerName: customerName,
                                qty: qty,
                                soId: so.SO_ID,
                                invoiceNum: so.Invoice_Number || so.SO_ID
                            });
                            itemBackorders[line.Item_ID].totalNeeded += qty;
                        }
                    }
                } catch(e) {
                    console.warn('Error fetching lines for SO:', so.SO_ID, e);
                }
            }
            
            // Calculate totals
            const totalCustomersAffected = Object.keys(customerBackorders).length;
            const totalItemsOnBackorder = Object.keys(itemBackorders).length;
            const totalUnitsNeeded = Object.values(itemBackorders).reduce((sum, i) => sum + i.totalNeeded, 0);
            
            // Build HTML
            let html = `
                <style>
                    .backorder-container {
                        max-width: 100%;
                    }
                    .backorder-header {
                        background: linear-gradient(135deg, #b8a86b 0%, #fbbf24 100%);
                        color: white;
                        padding: 25px;
                        border-radius: 12px;
                        margin-bottom: 20px;
                        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
                    }
                    .backorder-header h2 {
                        margin: 0 0 8px 0;
                        font-size: 24px;
                    }
                    .backorder-header p {
                        margin: 0;
                        opacity: 0.9;
                    }
                    .backorder-kpi-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                        gap: 12px;
                        margin-bottom: 20px;
                    }
                    .backorder-kpi {
                        background: white;
                        border-radius: 10px;
                        padding: 15px;
                        text-align: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    }
                    .backorder-kpi .value {
                        font-size: 28px;
                        font-weight: 700;
                    }
                    .backorder-kpi .label {
                        font-size: 12px;
                        color: #666;
                        text-transform: uppercase;
                        margin-top: 5px;
                    }
                    .backorder-section {
                        background: white;
                        border-radius: 12px;
                        margin-bottom: 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        overflow: hidden;
                    }
                    .backorder-section-header {
                        background: #f8fafc;
                        padding: 15px 20px;
                        border-bottom: 1px solid #e2e8f0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-wrap: wrap;
                        gap: 10px;
                    }
                    .backorder-section-title {
                        font-weight: 700;
                        font-size: 16px;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    .backorder-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 13px;
                    }
                    .backorder-table th {
                        background: #f1f5f9;
                        padding: 10px 12px;
                        text-align: left;
                        font-weight: 600;
                        color: #475569;
                        border-bottom: 1px solid #e2e8f0;
                    }
                    .backorder-table td {
                        padding: 10px 12px;
                        border-bottom: 1px solid #f1f5f9;
                    }
                    .backorder-table tr:hover {
                        background: #f8fafc;
                    }
                    .customer-card {
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        margin: 15px;
                        overflow: hidden;
                    }
                    .customer-card-header {
                        background: #f0f9ff;
                        padding: 12px 15px;
                        border-bottom: 1px solid #e2e8f0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .customer-name {
                        font-weight: 700;
                        color: #0369a1;
                    }
                    .order-badge {
                        background: #0891b2;
                        color: white;
                        padding: 4px 10px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: 600;
                    }
                    .item-summary-card {
                        background: #fffbeb;
                        border: 2px solid #fbbf24;
                        border-radius: 10px;
                        padding: 15px;
                        margin: 15px;
                    }
                    .item-summary-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        margin-bottom: 12px;
                    }
                    .item-summary-title {
                        font-weight: 700;
                        color: #92400e;
                    }
                    .item-summary-stats {
                        display: flex;
                        gap: 15px;
                        flex-wrap: wrap;
                        margin-bottom: 12px;
                        font-size: 13px;
                    }
                    .item-stat {
                        display: flex;
                        flex-direction: column;
                    }
                    .item-stat-label {
                        font-size: 10px;
                        color: #666;
                        text-transform: uppercase;
                    }
                    .item-stat-value {
                        font-weight: 700;
                        font-size: 16px;
                    }
                    .create-po-btn {
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 6px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 13px;
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                    }
                    .create-po-btn:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
                    }
                    .create-po-btn:disabled {
                        background: #9ca3af;
                        cursor: not-allowed;
                        transform: none;
                        box-shadow: none;
                    }
                    .qty-input {
                        width: 70px;
                        padding: 6px 8px;
                        border: 2px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                        text-align: center;
                    }
                    .qty-input:focus {
                        border-color: #10b981;
                        outline: none;
                    }
                    
                    @media (max-width: 768px) {
                        .backorder-table {
                            font-size: 11px;
                        }
                        .backorder-table th,
                        .backorder-table td {
                            padding: 8px 6px;
                        }
                        .item-summary-stats {
                            gap: 10px;
                        }
                    }
                </style>
                
                <div class="backorder-container">
                    <div class="backorder-header">
                        <h2> Customer Backorders</h2>
                        <p>Items on backorder for pending customer orders  Create POs to fulfill</p>
                    </div>
                    
                    <div class="backorder-kpi-grid">
                        <div class="backorder-kpi" style="border-top: 4px solid #b8a86b;">
                            <div class="value" style="color: #b8a86b;">${totalCustomersAffected}</div>
                            <div class="label">Customers Waiting</div>
                        </div>
                        <div class="backorder-kpi" style="border-top: 4px solid #b88a8a;">
                            <div class="value" style="color: #b88a8a;">${totalItemsOnBackorder}</div>
                            <div class="label">Items on Backorder</div>
                        </div>
                        <div class="backorder-kpi" style="border-top: 4px solid #7c3aed;">
                            <div class="value" style="color: #7c3aed;">${totalUnitsNeeded}</div>
                            <div class="label">Total Units Needed</div>
                        </div>
                    </div>
            `;
            
            if (totalItemsOnBackorder === 0) {
                html += `
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 15px;"></div>
                        <h3 style="margin: 0; color: #10b981;">No Backorders!</h3>
                        <p style="color: #666;">All customer orders can be fulfilled with current inventory.</p>
                    </div>
                `;
            } else {
                // SECTION 1: CONSOLIDATED VIEW BY ITEM
                html += `
                    <div class="backorder-section">
                        <div class="backorder-section-header">
                            <div class="backorder-section-title">
                                 Consolidated by Product
                                <span style="background: #b8a86b; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">${totalItemsOnBackorder} items</span>
                            </div>
                            <div style="font-size: 12px; color: #666;">Create POs for backorder quantities only (not up to reorder point)</div>
                        </div>
                        <div style="padding: 0;">
                `;
                
                // Sort items by total units needed (from actual orders)
                const sortedItems = Object.values(itemBackorders).sort((a, b) => b.totalNeeded - a.totalNeeded);
                
                for (const item of sortedItems) {
                    // Use totalNeeded (sum of actual order quantities) instead of qtyOnBackorder
                    const unitsNeeded = item.totalNeeded;
                    const netNeeded = Math.max(0, unitsNeeded - item.qtyOnOrder);
                    const alreadyCovered = Math.min(item.qtyOnOrder, unitsNeeded);
                    
                    html += `
                        <div class="item-summary-card">
                            <div class="item-summary-header">
                                <div>
                                    <div class="item-summary-title">${item.itemDesc}</div>
                                    <div style="font-size: 12px; color: #666;">SKU: ${item.sku}  ${item.supplierName}</div>
                                </div>
                            </div>
                            <div class="item-summary-stats">
                                <div class="item-stat">
                                    <span class="item-stat-label">On Hand</span>
                                    <span class="item-stat-value" style="color: ${item.qtyOnHand < 0 ? '#b88a8a' : '#333'};">${item.qtyOnHand}</span>
                                </div>
                                <div class="item-stat">
                                    <span class="item-stat-label">Units Ordered</span>
                                    <span class="item-stat-value" style="color: #b88a8a;">${unitsNeeded}</span>
                                </div>
                                <div class="item-stat">
                                    <span class="item-stat-label">Already On Order</span>
                                    <span class="item-stat-value" style="color: ${item.qtyOnOrder > 0 ? '#b8a86b' : '#666'};">${item.qtyOnOrder}</span>
                                </div>
                                <div class="item-stat">
                                    <span class="item-stat-label">Still Need</span>
                                    <span class="item-stat-value" style="color: ${netNeeded > 0 ? '#b88a8a' : '#10b981'}; font-weight: 800;">${netNeeded}</span>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 12px; font-size: 13px; color: #666;">
                                <strong>Customers waiting:</strong> 
                                ${item.customers.map(c => `${c.customerName} (${c.qty} units - ${c.invoiceNum})`).join(', ')}
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                ${netNeeded > 0 ? `
                                    <label style="font-size: 13px; color: #333;">Order Qty:</label>
                                    <input type="number" class="qty-input" id="backorderQty_${item.itemId}" value="${netNeeded}" min="1" max="${netNeeded + 100}">
                                    <button class="create-po-btn" onclick="createBackorderPO('${item.itemId}', '${item.supplierId}')">
                                         Restock
                                    </button>
                                    <span style="font-size: 11px; color: #666;">(Just enough to fulfill backorders)</span>
                                ` : `
                                    <span style="color: #10b981; font-weight: 600;"> Covered by existing PO</span>
                                    <span style="font-size: 11px; color: #666;">(${alreadyCovered} on order)</span>
                                `}
                            </div>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                // SECTION 2: BY CUSTOMER VIEW
                html += `
                    <div class="backorder-section">
                        <div class="backorder-section-header">
                            <div class="backorder-section-title">
                                 By Customer
                                <span style="background: #0891b2; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">${totalCustomersAffected} customers</span>
                            </div>
                        </div>
                `;
                
                // Sort customers by name
                const sortedCustomers = Object.values(customerBackorders).sort((a, b) => a.customerName.localeCompare(b.customerName));
                
                for (const customer of sortedCustomers) {
                    html += `
                        <div class="customer-card">
                            <div class="customer-card-header">
                                <div style="flex: 1;">
                                    <span class="customer-name"> ${customer.customerName}</span>
                                    ${customer.customerAddress ? `<div style="font-size: 12px; color: #666; margin-top: 2px;"> ${customer.customerAddress}</div>` : ''}
                                </div>
                                <span class="order-badge">${customer.orders.length} order${customer.orders.length > 1 ? 's' : ''} affected</span>
                            </div>
                            <table class="backorder-table">
                                <thead>
                                    <tr>
                                        <th>Order #</th>
                                        <th>Item</th>
                                        <th>SKU</th>
                                        <th>Qty Ordered</th>
                                        <th>On Hand</th>
                                        <th>On Order</th>
                                        <th>Short</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    for (const order of customer.orders) {
                        for (const item of order.items) {
                            // Calculate shortage for THIS specific order line
                            const shortQty = Math.max(0, item.qtyOrdered - Math.max(0, item.qtyOnHand));
                            html += `
                                <tr>
                                    <td><a href="#" onclick="viewSalesOrder('${order.soId}'); return false;" style="color: #0891b2; text-decoration: none;">${order.invoiceNum}</a></td>
                                    <td>${item.itemDesc}</td>
                                    <td style="font-family: monospace; font-size: 11px;">${item.sku}</td>
                                    <td style="text-align: center;">${item.qtyOrdered}</td>
                                    <td style="text-align: center; color: ${item.qtyOnHand < 0 ? '#b88a8a' : '#333'};">${item.qtyOnHand}</td>
                                    <td style="text-align: center; color: ${item.qtyOnOrder > 0 ? '#b8a86b' : '#666'};">${item.qtyOnOrder}</td>
                                    <td style="text-align: center; color: #b88a8a; font-weight: 600;">${shortQty > 0 ? shortQty : '-'}</td>
                                </tr>
                            `;
                        }
                    }
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                html += `
                    </div>
                `;
            }
            
            html += '</div>'; // End backorder-container
            
            return html;
        }
        
        // Create PO for backorder item - navigates to Create PO tab with pre-filled data
        async function createBackorderPO(itemId, supplierId) {
            const qtyInput = document.getElementById(`backorderQty_${itemId}`);
            const unitsNeeded = parseInt(qtyInput?.value) || 0;
            
            if (unitsNeeded <= 0) {
                showWarning('Please enter a quantity greater than 0');
                return;
            }
            
            // Get item details
            const item = (cachedItems || []).find(i => i.Item_ID === itemId);
            if (!item) {
                showError('Item not found. Please refresh and try again.');
                return;
            }
            
            const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === supplierId);
            const supplierName = supplier?.Supplier_Name || 'Unknown';
            
            const confirmed = await showConfirmModal(
                ' Create Backorder PO',
                `<div style="text-align: left;">
                    <p>Create PO for <strong>${unitsNeeded} units</strong> of:</p>
                    <p style="background: #f0f9ff; padding: 10px; border-radius: 6px; font-weight: 600; margin: 10px 0;">${item.Item_Description}</p>
                    <p>From: <strong>${supplierName}</strong></p>
                    <p style="color: #666; font-size: 13px; margin-top: 10px;">This is for backorder fulfillment only.</p>
                </div>`,
                'Create PO',
                'Cancel',
                'info'
            );
            if (!confirmed) {
                return;
            }
            
            // Close the report modal
            closeReportSetup();
            
            // Skip clearing since we're pre-filling
            window.skipCreatePOClear = true;
            
            // Switch to CREATE PO tab
            switchTab('createpo');
            
            setTimeout(() => {
                // Set supplier
                const supplierSelect = document.getElementById('createPOSupplier');
                if (supplierSelect) {
                    supplierSelect.value = supplierId;
                    filterItemsBySupplier();
                }
                
                // Set today's date
                const today = getTodayLocalDate();
                document.getElementById('createPODate').value = today;
                document.getElementById('createPOExpectedDate').value = '';
                
                // Set notes
                const notesField = document.getElementById('createPONotes');
                if (notesField) {
                    notesField.value = 'Backorder fulfillment - Created from Customer Backorders report';
                }
                
                // Clear existing line items
                const container = document.getElementById('createPOLineItems');
                container.innerHTML = '';
                
                // Calculate cases needed
                const cost = parseFloat(item.Package_Cost) || 0;
                const units = parseInt(item.Units_Per_Package) || 1;
                const casesNeeded = Math.ceil(unitsNeeded / units);
                
                const newRow = document.createElement('div');
                newRow.className = 'line-item-row';
                newRow.style.cssText = 'display: grid; grid-template-columns: 2.5fr 1fr 0.6fr 0.8fr 0.8fr 0.8fr 50px; gap: 8px; margin-bottom: 10px; align-items: end;';
                
                newRow.innerHTML = `
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                        <select class="createpo-item" style="width: 100%; padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white;" onchange="updateCreatePOItemCost(this)">
                            <option value="${item.Item_ID}" data-cost="${cost}" data-units="${units}" selected>${item.SKU || item.Item_ID} - ${item.Item_Description}</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Cases</label>
                        <input type="number" class="createpo-qty" value="${casesNeeded > 0 ? casesNeeded : ''}" placeholder="Qty" min="1" oninput="calculateCreatePOTotal()" style="width: 100%; padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px;">
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-units" style="text-align: center; font-size: 14px; color: #666; padding: 6px;">${units}</div>
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-totalunits" style="text-align: center; font-size: 16px; font-weight: bold; color: var(--primary, #667eea); padding: 6px;">${casesNeeded > 0 ? casesNeeded * units : '-'}</div>
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-cost" style="text-align: center; font-size: 14px; font-weight: bold; color: #6b9a8d; background: #e8f5e9; padding: 10px; border-radius: 6px;">$${cost.toFixed(2)}</div>
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-linetotal" style="text-align: right; font-size: 14px; font-weight: bold; color: var(--primary, #667eea); background: var(--primary-light, #E3F2FD); padding: 10px; border-radius: 6px;">${casesNeeded > 0 ? '$' + (casesNeeded * cost).toFixed(2) : '$0.00'}</div>
                    </div>
                    <button type="button" class="btn-danger" onclick="removeLineItem(this); calculateCreatePOTotal();" style="width: 100%; padding: 10px; font-size: 14px; margin-top: 26px;"></button>
                `;
                
                container.appendChild(newRow);
                
                // Calculate total
                calculateCreatePOTotal();
                
            }, 300);
        }
        
        // Helper functions for Action Dashboard
        function filterLowStockTable() {
            const filterValue = document.getElementById('lowStockSupplierFilter').value;
            const rows = document.querySelectorAll('.action-table tbody tr[data-supplier-id]');
            let visibleCount = 0;
            
            rows.forEach(row => {
                if (!filterValue || row.dataset.supplierId === filterValue) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update count display
            const countEl = document.getElementById('lowStockFilterCount');
            if (countEl) {
                if (filterValue) {
                    countEl.textContent = `Showing ${visibleCount} items`;
                } else {
                    countEl.textContent = '';
                }
            }
            
            // Uncheck "select all" when filtering
            const selectAll = document.getElementById('selectAllLowStock');
            if (selectAll) selectAll.checked = false;
        }
        
        function toggleSelectAllLowStock() {
            const filterValue = document.getElementById('lowStockSupplierFilter')?.value || '';
            const checkboxes = document.querySelectorAll('.lowstock-checkbox');
            const selectAll = document.getElementById('selectAllLowStock');
            
            checkboxes.forEach(cb => {
                const row = cb.closest('tr');
                // Only select visible rows (matching filter)
                if (!filterValue || row.dataset.supplierId === filterValue) {
                    cb.checked = selectAll.checked;
                }
            });
        }
        
        function bulkReorder() {
            const checkboxes = document.querySelectorAll('.lowstock-checkbox:checked');
            if (checkboxes.length === 0) {
                showWarning('Please select items to reorder first.\n\nUse the checkboxes next to each item, or "Select All" at the top.');
                return;
            }
            
            // Get item IDs and their pre-calculated units needed from the checkboxes
            const selectedItems = Array.from(checkboxes).map(cb => ({
                itemId: cb.dataset.itemId,
                unitsNeeded: parseInt(cb.dataset.unitsNeeded) || 0
            }));
            
            // Get item details and check suppliers
            const items = selectedItems.map(sel => {
                const item = (cachedItems || []).find(i => i.Item_ID === sel.itemId);
                if (item) {
                    return { ...item, _unitsNeeded: sel.unitsNeeded };
                }
                return null;
            }).filter(Boolean);
            
            if (items.length === 0) {
                showError('Could not find selected items. Please refresh and try again.');
                return;
            }
            
            // Check if all items are from the same supplier
            const suppliers = [...new Set(items.map(i => i.Supplier_ID))];
            
            if (suppliers.length > 1) {
                // Multiple suppliers - show error
                const supplierNames = suppliers.map(supId => {
                    const sup = (cachedSuppliers || []).find(s => s.Supplier_ID === supId);
                    const itemCount = items.filter(i => i.Supplier_ID === supId).length;
                    return ` ${sup?.Supplier_Name || 'Unknown'}: ${itemCount} item${itemCount > 1 ? 's' : ''}`;
                }).join('<br>');
                
                showError(`Cannot create a single PO with items from multiple suppliers!<br><br>You selected items from ${suppliers.length} different suppliers:<br><br>${supplierNames}<br><br>Purchase orders can only contain items from ONE supplier.<br><br>Please select items from a single supplier, or create separate POs for each supplier.`);
                return;
            }
            
            // All items are from the same supplier - show bulk PO popup!
            const supplierId = suppliers[0];
            const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === supplierId);
            const supplierName = supplier?.Supplier_Name || 'Unknown Supplier';
            
            // Build line items HTML
            let lineItemsHtml = '';
            let grandTotal = 0;
            
            items.forEach((item, index) => {
                const cost = parseFloat(item.Package_Cost) || 0;
                const units = parseInt(item.Units_Per_Package) || 1;
                // Use the pre-calculated units needed from the Needs Reorder report (considers committed & on-order)
                const qtyNeeded = item._unitsNeeded || 0;
                const casesNeeded = Math.ceil(qtyNeeded / units);
                const lineTotal = casesNeeded * cost;
                grandTotal += lineTotal;
                
                lineItemsHtml += `
                    <tr data-item-id="${item.Item_ID}" data-cost="${cost}" data-units="${units}">
                        <td style="font-size: 13px;">${item.SKU || ''}</td>
                        <td style="font-size: 12px;">${item.Item_Description?.substring(0, 30) || ''}</td>
                        <td style="text-align: center;">
                            <input type="number" class="bulk-po-qty" value="${casesNeeded}" min="1" 
                                   onchange="updateBulkPOLine(this)" 
                                   style="width: 60px; padding: 6px; text-align: center; border: 2px solid #f9a825; border-radius: 4px; font-weight: bold;">
                        </td>
                        <td style="text-align: center; color: #666;">${units}</td>
                        <td style="text-align: center; color: #6b9a8d; font-weight: 600;">$${cost.toFixed(2)}</td>
                        <td style="text-align: right; font-weight: 600;" class="bulk-line-total">$${lineTotal.toFixed(2)}</td>
                        <td style="text-align: center;">
                            <button type="button" onclick="removeBulkPOLine(this)" style="background: #b88a8a; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;"></button>
                        </td>
                    </tr>
                `;
            });
            
            // Show Bulk PO Modal
            const modalHtml = `
                <div id="bulkPOModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;">
                    <div style="background: white; border-radius: 16px; padding: 25px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 15px;">
                            <h2 style="margin: 0; color: #667eea;"> Bulk Purchase Order (${items.length} items)</h2>
                            <button onclick="closeBulkPOModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;"></button>
                        </div>
                        
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #6b9a8d;">
                            <div style="font-weight: 600; color: #2e7d32;"> Supplier: ${supplierName}</div>
                        </div>
                        
                        <form id="bulkPOForm" onsubmit="submitBulkPO(event, '${supplierId}')">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 5px;"> Order Date <span style="color: #b88a8a;">*</span></label>
                                    <input type="date" id="bulkPODate" value="${getTodayLocalDate()}" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                                </div>
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 5px;"> Expected Arrival <span style="color: #b88a8a;">*</span></label>
                                    <input type="date" id="bulkPOExpected" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                                </div>
                            </div>
                            
                            <div style="overflow-x: auto; margin-bottom: 15px;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 14px;" id="bulkPOTable">
                                    <thead>
                                        <tr style="background: #667eea; color: white;">
                                            <th style="padding: 10px; text-align: left;">SKU</th>
                                            <th style="padding: 10px; text-align: left;">Description</th>
                                            <th style="padding: 10px; text-align: center;">Cases</th>
                                            <th style="padding: 10px; text-align: center;">Units/Pkg</th>
                                            <th style="padding: 10px; text-align: center;">Cost</th>
                                            <th style="padding: 10px; text-align: right;">Total</th>
                                            <th style="padding: 10px; width: 40px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${lineItemsHtml}
                                    </tbody>
                                    <tfoot>
                                        <tr style="background: #f8f9fa; font-weight: bold;">
                                            <td colspan="5" style="padding: 12px; text-align: right;">Grand Total:</td>
                                            <td style="padding: 12px; text-align: right; font-size: 18px; color: #6b9a8d;" id="bulkPOGrandTotal">$${grandTotal.toFixed(2)}</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="font-weight: 600; display: block; margin-bottom: 5px;"> Notes (optional)</label>
                                <textarea id="bulkPONotes" rows="2" placeholder="Special instructions..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" onclick="closeBulkPOModal()" style="padding: 12px 24px; background: #8a8a8a; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Cancel</button>
                                <button type="submit" style="padding: 12px 24px; background: #6b9a8d; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;"> Create Purchase Order</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Add modal to page
            const modalContainer = document.createElement('div');
            modalContainer.id = 'bulkPOModalContainer';
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
        }
        
        function closeBulkPOModal() {
            const container = document.getElementById('bulkPOModalContainer');
            if (container) container.remove();
        }
        
        function updateBulkPOLine(input) {
            const row = input.closest('tr');
            const cost = parseFloat(row.dataset.cost) || 0;
            const qty = parseInt(input.value) || 0;
            const lineTotal = qty * cost;
            row.querySelector('.bulk-line-total').textContent = '$' + lineTotal.toFixed(2);
            updateBulkPOGrandTotal();
        }
        
        function removeBulkPOLine(btn) {
            const row = btn.closest('tr');
            row.remove();
            updateBulkPOGrandTotal();
        }
        
        function updateBulkPOGrandTotal() {
            const rows = document.querySelectorAll('#bulkPOTable tbody tr');
            let total = 0;
            rows.forEach(row => {
                const cost = parseFloat(row.dataset.cost) || 0;
                const qty = parseInt(row.querySelector('.bulk-po-qty')?.value) || 0;
                total += cost * qty;
            });
            document.getElementById('bulkPOGrandTotal').textContent = '$' + total.toFixed(2);
        }
        
        async function submitBulkPO(event, supplierId) {
            event.preventDefault();
            
            const rows = document.querySelectorAll('#bulkPOTable tbody tr');
            if (rows.length === 0) {
                showWarning('No items in the order');
                return;
            }
            
            const lineItems = [];
            rows.forEach(row => {
                const itemId = row.dataset.itemId;
                const qty = parseInt(row.querySelector('.bulk-po-qty')?.value) || 0;
                const cost = parseFloat(row.dataset.cost) || 0;
                if (qty > 0) {
                    lineItems.push({ itemId, quantity: qty, unitCost: cost });
                }
            });
            
            if (lineItems.length === 0) {
                showWarning('Please enter quantities for at least one item');
                return;
            }
            
            showLoading('Creating Purchase Order...');
            
            try {
                // Get selected date and format as MMDDYY for invoice number
                const selectedDate = document.getElementById('bulkPODate').value;
                const dateObj = new Date(selectedDate + 'T12:00:00');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                const year = String(dateObj.getFullYear()).slice(-2);
                const dateStr = `${month}${day}${year}`;
                
                // Get all existing POs to find the next number for this date
                const existingPOs = await apiCall('getPurchaseOrders');
                let nextNumber = 1;
                
                if (existingPOs && existingPOs.data && existingPOs.data.length > 0) {
                    const prefix = `PO-${dateStr}-`;
                    const todayPOs = existingPOs.data
                        .filter(po => po.Invoice_Number && po.Invoice_Number.startsWith(prefix))
                        .map(po => {
                            const parts = po.Invoice_Number.split('-');
                            return parseInt(parts[2]) || 0;
                        });
                    
                    if (todayPOs.length > 0) {
                        nextNumber = Math.max(...todayPOs) + 1;
                    }
                }
                
                // Generate PO number: PO-122125-001
                const poNumber = `PO-${dateStr}-${String(nextNumber).padStart(3, '0')}`;
                
                // Create proper datetime: combine selected date with current time
                const now = new Date();
                const timeStr = now.toTimeString().split(' ')[0]; // HH:MM:SS
                const poDateTime = `${selectedDate}T${timeStr}`; // YYYY-MM-DDTHH:MM:SS
                
                const poData = {
                    supplierId: supplierId,
                    poDate: poDateTime,  // Full datetime format
                    dueDate: document.getElementById('bulkPOExpected').value || '',  // Expected Arrival  Due_Date
                    invoiceNumber: poNumber,  // Auto-generated PO-MMDDYY-###
                    notes: document.getElementById('bulkPONotes').value || '',
                    status: 'Ordered',
                    lineItems: lineItems
                };
                
                const result = await apiCall('createPurchaseOrder', poData);
                hideLoading();
                
                if (result && result.status === 'success') {
                    closeBulkPOModal();
                    // Refresh items and clear report cache to get fresh data
                    await loadItems(true);  // Force refresh
                    reportDataCacheTime = null;  // Clear report cache so it reloads
                    // Refresh the Action Dashboard report if it's currently displayed
                    if (document.getElementById('reportSetupModal')?.style.display !== 'none') {
                        // Re-run the report to refresh the data
                        setTimeout(() => executeReport(), 100);
                    }
                    showSuccessModal('Purchase Order Created!', `PO #: ${poNumber}\n\n${lineItems.length} item${lineItems.length > 1 ? 's' : ''} ordered.`);
                } else {
                    showError('Error creating PO: ' + (result?.message || 'Unknown error'));
                }
            } catch (error) {
                hideLoading();
                showError('Error: ' + error.message);
            }
        }
        
        function createPOForItem(itemId, unitsNeeded) {
            // Get item details
            const item = (cachedItems || []).find(i => i.Item_ID === itemId);
            if (!item) {
                showError('Item not found. Please refresh and try again.');
                return;
            }
            
            const supplierId = item.Supplier_ID;
            const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === supplierId);
            const supplierName = supplier?.Supplier_Name || 'Unknown Supplier';
            
            // Calculate values
            const cost = parseFloat(item.Package_Cost) || 0;
            const units = parseInt(item.Units_Per_Package) || 1;
            const qtyNeeded = unitsNeeded !== undefined ? unitsNeeded : Math.max(0, (parseInt(item.Reorder_Point) || 0) - (parseInt(item.Qty_On_Hand) || 0));
            const casesNeeded = Math.ceil(qtyNeeded / units);
            const lineTotal = casesNeeded * cost;
            
            // Show Quick PO Modal (stays on critical report)
            const modalHtml = `
                <div id="quickPOModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;">
                    <div style="background: white; border-radius: 16px; padding: 25px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 15px;">
                            <h2 style="margin: 0; color: #667eea;"> Quick Purchase Order</h2>
                            <button onclick="closeQuickPOModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;"></button>
                        </div>
                        
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #6b9a8d;">
                            <div style="font-weight: 600; color: #2e7d32; margin-bottom: 8px;"> Supplier: ${supplierName}</div>
                            <div style="font-size: 14px; color: #666;"> ${item.SKU || ''} - ${item.Item_Description}</div>
                        </div>
                        
                        <form id="quickPOForm" onsubmit="submitQuickPO(event, '${itemId}', '${supplierId}')">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 5px;"> Order Date <span style="color: #b88a8a;">*</span></label>
                                    <input type="date" id="quickPODate" value="${getTodayLocalDate()}" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                                </div>
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 5px;"> Expected Arrival <span style="color: #b88a8a;">*</span></label>
                                    <input type="date" id="quickPOExpected" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                                </div>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; align-items: end;">
                                    <div>
                                        <label style="font-weight: 600; display: block; margin-bottom: 5px; font-size: 13px;">Item</label>
                                        <div style="padding: 10px; background: #e9ecef; border-radius: 6px; font-size: 13px;">
                                            <div style="font-weight: 600;">${item.SKU || item.Item_ID}</div>
                                            <div style="font-size: 12px; color: #666; margin-top: 2px;">${item.Item_Description || ''}</div>
                                        </div>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; display: block; margin-bottom: 5px; font-size: 13px;"> Cases</label>
                                        <input type="number" id="quickPOCases" value="${casesNeeded}" min="1" required onchange="updateQuickPOTotal(${cost}, ${units})" style="width: 100%; padding: 10px; border: 2px solid #f9a825; border-radius: 6px; text-align: center; font-size: 16px; font-weight: bold; background: #fffde7; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; display: block; margin-bottom: 5px; font-size: 13px;">Units/Pkg</label>
                                        <div style="padding: 10px; background: #e9ecef; border-radius: 6px; text-align: center; font-size: 14px;">${units}</div>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; display: block; margin-bottom: 5px; font-size: 13px;">Cost/Case</label>
                                        <div style="padding: 10px; background: #e8f5e9; border-radius: 6px; text-align: center; font-size: 14px; font-weight: 600; color: #6b9a8d;">$${cost.toFixed(2)}</div>
                                    </div>
                                </div>
                                <div style="margin-top: 15px; text-align: right; border-top: 1px solid #ddd; padding-top: 10px;">
                                    <span style="font-size: 14px; color: #666;">Total Units: </span>
                                    <span id="quickPOTotalUnits" style="font-weight: 700; color: #667eea; margin-right: 20px;">${casesNeeded * units}</span>
                                    <span style="font-size: 14px; color: #666;">Order Total: </span>
                                    <span id="quickPOTotal" style="font-size: 20px; font-weight: 700; color: #6b9a8d;">$${lineTotal.toFixed(2)}</span>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="font-weight: 600; display: block; margin-bottom: 5px;"> Notes (optional)</label>
                                <textarea id="quickPONotes" rows="2" placeholder="Special instructions..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" id="quickPOCancelBtn" onclick="closeQuickPOModal()" style="padding: 12px 24px; background: #8a8a8a; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Cancel</button>
                                <button type="submit" id="quickPOSubmitBtn" style="padding: 12px 24px; background: #6b9a8d; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;"> Create Purchase Order</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Add modal to page
            const modalContainer = document.createElement('div');
            modalContainer.id = 'quickPOModalContainer';
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
        }
        
        function closeQuickPOModal() {
            const container = document.getElementById('quickPOModalContainer');
            if (container) container.remove();
        }
        
        function updateQuickPOTotal(cost, units) {
            const cases = parseInt(document.getElementById('quickPOCases').value) || 0;
            document.getElementById('quickPOTotalUnits').textContent = cases * units;
            document.getElementById('quickPOTotal').textContent = '$' + (cases * cost).toFixed(2);
        }
        
        async function submitQuickPO(event, itemId, supplierId) {
            event.preventDefault();
            
            const cases = parseInt(document.getElementById('quickPOCases').value) || 0;
            if (cases <= 0) {
                showWarning('Please enter a valid quantity');
                return;
            }
            
            const item = (cachedItems || []).find(i => i.Item_ID === itemId);
            const cost = parseFloat(item?.Package_Cost) || 0;
            
            // Disable buttons during processing
            const submitBtn = document.getElementById('quickPOSubmitBtn');
            const cancelBtn = document.getElementById('quickPOCancelBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = ' Processing...';
            }
            if (cancelBtn) {
                cancelBtn.disabled = true;
                cancelBtn.style.opacity = '0.5';
                cancelBtn.style.cursor = 'not-allowed';
            }
            
            showLoading('Creating Purchase Order...');
            
            try {
                // Get selected date and format as MMDDYY for invoice number
                const selectedDate = document.getElementById('quickPODate').value;
                const dateObj = new Date(selectedDate + 'T12:00:00');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                const year = String(dateObj.getFullYear()).slice(-2);
                const dateStr = `${month}${day}${year}`;
                
                // Get all existing POs to find the next number for this date
                const existingPOs = await apiCall('getPurchaseOrders');
                let nextNumber = 1;
                
                if (existingPOs && existingPOs.data && existingPOs.data.length > 0) {
                    const prefix = `PO-${dateStr}-`;
                    const todayPOs = existingPOs.data
                        .filter(po => po.Invoice_Number && po.Invoice_Number.startsWith(prefix))
                        .map(po => {
                            const parts = po.Invoice_Number.split('-');
                            return parseInt(parts[2]) || 0;
                        });
                    
                    if (todayPOs.length > 0) {
                        nextNumber = Math.max(...todayPOs) + 1;
                    }
                }
                
                // Generate PO number: PO-122125-001
                const poNumber = `PO-${dateStr}-${String(nextNumber).padStart(3, '0')}`;
                
                // Create proper datetime: combine selected date with current time
                const now = new Date();
                const timeStr = now.toTimeString().split(' ')[0]; // HH:MM:SS
                const poDateTime = `${selectedDate}T${timeStr}`; // YYYY-MM-DDTHH:MM:SS
                
                const poData = {
                    supplierId: supplierId,
                    poDate: poDateTime,  // Full datetime format
                    dueDate: document.getElementById('quickPOExpected').value || '',  // Expected Arrival  Due_Date
                    invoiceNumber: poNumber,  // Auto-generated PO-MMDDYY-###
                    notes: document.getElementById('quickPONotes').value || '',
                    status: 'Ordered',
                    lineItems: [{
                        itemId: itemId,
                        quantity: cases,
                        unitCost: cost
                    }]
                };
                
                console.log(' Quick PO Data being sent:', JSON.stringify(poData, null, 2));
                
                const result = await apiCall('createPurchaseOrder', poData);
                console.log(' Quick PO API Result:', JSON.stringify(result, null, 2));
                hideLoading();
                
                if (result && result.status === 'success') {
                    closeQuickPOModal();
                    // Refresh items and clear report cache to get fresh data
                    await loadItems(true);  // Force refresh
                    reportDataCacheTime = null;  // Clear report cache so it reloads
                    // Refresh purchases list so new PO appears
                    loadPurchases(true);
                    // Refresh the Action Dashboard report if it's currently displayed
                    if (document.getElementById('reportSetupModal')?.style.display !== 'none') {
                        // Re-run the report to refresh the data
                        setTimeout(() => executeReport(), 100);
                    }
                    showSuccessModal('Purchase Order Created!', `PO #: ${poNumber}\n\nItems marked as "On Order".`);
                } else {
                    showError('Error creating PO: ' + (result?.message || 'Unknown error'));
                    // Re-enable buttons on error
                    const submitBtn = document.getElementById('quickPOSubmitBtn');
                    const cancelBtn = document.getElementById('quickPOCancelBtn');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = ' Create Purchase Order';
                    }
                    if (cancelBtn) {
                        cancelBtn.disabled = false;
                        cancelBtn.style.opacity = '1';
                        cancelBtn.style.cursor = 'pointer';
                    }
                }
            } catch (error) {
                hideLoading();
                showError('Error: ' + error.message);
                // Re-enable buttons on error
                const submitBtn = document.getElementById('quickPOSubmitBtn');
                const cancelBtn = document.getElementById('quickPOCancelBtn');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = ' Create Purchase Order';
                }
                if (cancelBtn) {
                    cancelBtn.disabled = false;
                    cancelBtn.style.opacity = '1';
                    cancelBtn.style.cursor = 'pointer';
                }
            }
        }
        
        async function createInventoryAdjustment(itemId) {
            // Get item details
            const item = (cachedItems || []).find(i => i.Item_ID === itemId);
            if (!item) {
                showError('Item not found. Please refresh and try again.');
                return;
            }
            
            // Use the Quick Adjust Modal instead of navigating away
            // This keeps the report open so user can continue working
            openQuickAdjustModal(itemId);
        }
        
        // Open adjustment modal for the first negative inventory item
        function openQuickAdjustForNegative() {
            // Find first negative inventory item from the displayed table
            const negativeRows = document.querySelectorAll('.action-section.critical table tbody tr');
            if (negativeRows.length > 0) {
                const firstRow = negativeRows[0];
                const adjustBtn = firstRow.querySelector('button[onclick*="createInventoryAdjustment"]');
                if (adjustBtn) {
                    adjustBtn.click();
                    return;
                }
            }
            
            // Fallback: find any negative item from cached data
            const negItem = (cachedItems || []).find(i => (parseInt(i.Qty_On_Hand) || 0) < 0);
            if (negItem) {
                openQuickAdjustModal(negItem.Item_ID);
            } else {
                showWarning('No negative inventory items found.');
            }
        }
        
        function viewSaleOrder(saleId) {
            // Use the existing viewSalesOrder function which opens the modal
            viewSalesOrder(saleId);
        }
        
        async function markForClearance(itemId) {
            const confirmed = await showConfirmModal(
                ' Mark for Clearance',
                'Mark this item for clearance sale?',
                'Yes, Mark for Clearance',
                'Cancel',
                'info'
            );
            if (confirmed) {
                showInfo('Clearance feature coming soon!');
                // TODO: Implement clearance modal
            }
        }
        
        function scheduleCustomerVisit(customerId) {
            showInfo('Schedule Visit feature coming soon!');
            // TODO: Implement visit scheduling
        }
        
        function exportDormantCustomers() {
            showInfo('Export feature coming soon!');
            // TODO: Implement CSV export
        }
        
        // Create a new sales order for a customer (from Dormant Customers report)
        function createSalesOrderForCustomer(customerId) {
            // Close the report modal
            closeReportSetup();
            
            // Switch to CREATE SO tab
            switchTab('createso');
            
            setTimeout(() => {
                // Set customer in the picker
                const customer = (cachedCustomers || []).find(c => c.Customer_ID === customerId);
                if (customer) {
                    const displayInput = document.getElementById('createSOCustomerDisplay');
                    const hiddenInput = document.getElementById('createSOCustomer');
                    if (displayInput && hiddenInput) {
                        displayInput.value = customer.Customer_Name || customer.Customer_ID;
                        hiddenInput.value = customerId;
                    }
                }
                
                // Set today's date
                const today = getTodayLocalDate();
                const dateInput = document.getElementById('createSODate');
                if (dateInput) dateInput.value = today;
                
                // Clear existing line items
                const container = document.getElementById('createSOLineItems');
                if (container) container.innerHTML = '';
                
                // Add an empty line item row
                if (typeof addSOLineItem === 'function') {
                    addSOLineItem();
                }
                
                // Show confirmation
                if (customer) {
                    showStatus('soStatus', ` Creating order for ${customer.Customer_Name}. Add items below!`, 'success');
                }
            }, 300);
        }
        
        // ==================== DAILY DASHBOARD ====================
        
        async function generateDailyDashboardModal() {
            // Default to ALL TIME if no dates specified (not just today)
            let fromDate, toDate;
            
            if (reportFilters.fromDate) {
                fromDate = parseLocalDate(reportFilters.fromDate);
                fromDate.setHours(0, 0, 0, 0);
            } else {
                // Default: beginning of time (Jan 1, 2020)
                fromDate = new Date(2020, 0, 1, 0, 0, 0, 0);
            }
            
            if (reportFilters.toDate) {
                toDate = parseLocalDate(reportFilters.toDate);
                toDate.setHours(23, 59, 59, 999);
            } else {
                // Default: end of today
                toDate = new Date();
                toDate.setHours(23, 59, 59, 999);
            }
            
            // Load all report data AND expenses in PARALLEL for speed
            let expenseData = { expenses: [], byCategory: [], totalExpenses: 0, expenseCount: 0 };
            
            const [reportLoaded, expResult] = await Promise.all([
                loadReportData(),
                apiCall('getExpensesForPeriod', {
                    fromDate: reportFilters.fromDate || '',
                    toDate: reportFilters.toDate || ''
                }).catch(e => {
                    console.log('Could not load expenses:', e);
                    return null;
                })
            ]);
            
            if (expResult && expResult.status === 'success' && expResult.data) {
                expenseData = expResult.data;
            }
            
            const items = cachedItems;
            const customers = cachedCustomers;
            const suppliers = cachedSuppliers;
            
            if (!cachedSalesOrders.length || !items.length) {
                throw new Error('Failed to load data');
            }
            
            // Get theme color
            const themeColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#667eea';
            
            // Filter sales by date range
            let salesInPeriod = cachedSalesOrders.filter(s => {
                const saleDate = parseDate(s.Sale_Date || s.SO_Date);
                return saleDate && saleDate >= fromDate && saleDate <= toDate;
            });
            
            // Filter by customer if selected
            if (reportFilters.customer) {
                salesInPeriod = salesInPeriod.filter(s => matchesFilter(s.Customer_ID, reportFilters.customer));
            }
            
            // Calculate metrics
            let totalQtySold = 0;
            let totalSales = 0;
            let totalCost = 0;
            let totalListPrice = 0;
            let totalDiscount = 0;
            let orderCount = salesInPeriod.length;
            
            // Get line items for each sale - USE CACHED DATA
            const productSales = {};
            const customerSales = {};
            const citySales = {};
            
            for (const so of salesInPeriod) {
                const soTotal = parseFloat(so.Total_Amount) || 0;
                totalSales += soTotal;
                
                // Track customer sales
                const custId = so.Customer_ID;
                const cust = customers.find(c => c.Customer_ID === custId);
                const custCity = cust?.City || 'Unknown';
                const custState = cust?.State || '';
                
                if (!customerSales[custId]) {
                    customerSales[custId] = { 
                        name: getCustomerName(custId),
                        location: getCustomerLocation(custId),
                        sales: 0, 
                        orders: 0 
                    };
                }
                customerSales[custId].sales += soTotal;
                customerSales[custId].orders++;
                
                // Track city sales
                const cityKey = custCity + (custState ? ', ' + custState : '');
                if (!citySales[cityKey]) {
                    citySales[cityKey] = {
                        city: custCity,
                        state: custState,
                        sales: 0,
                        orders: 0,
                        customers: new Set()
                    };
                }
                citySales[cityKey].sales += soTotal;
                citySales[cityKey].orders++;
                citySales[cityKey].customers.add(custId);
                
                // Get line items from CACHE instead of API call
                const lines = getSalesLinesFromCache(so.SO_ID);
                lines.forEach(line => {
                        const qty = parseInt(line.Quantity) || 0;
                        totalQtySold += qty;
                        
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const unitsPerPkg = parseFloat(item?.Units_Per_Package) || 1;
                        const pkgCost = parseFloat(item?.Package_Cost) || 0;
                        const unitCost = pkgCost / unitsPerPkg;
                        totalCost += qty * unitCost;
                        
                        // Calculate line total (Line_Total may not exist in data)
                        const unitPrice = parseFloat(line.Unit_Price) || 0;
                        const lineTotal = qty * unitPrice;
                        
                        // Calculate list price and discount
                        const listPrice = parseFloat(item?.Unit_Sell_Price) || 0;
                        const listTotal = qty * listPrice;
                        totalListPrice += listTotal;
                        totalDiscount += (listTotal - lineTotal); // Positive = discount given
                        
                        // Track product sales - include supplier
                        const itemId = line.Item_ID;
                        const suppId = item?.Supplier_ID;
                        const supp = suppliers.find(s => s.Supplier_ID === suppId);
                        if (!productSales[itemId]) {
                            productSales[itemId] = {
                                name: item?.Item_Description || itemId,
                                sku: item?.SKU || '-',
                                supplierName: supp?.Supplier_Name || 'Unknown',
                                qty: 0,
                                sales: 0
                            };
                        }
                        productSales[itemId].qty += qty;
                        productSales[itemId].sales += lineTotal;
                });
            }
            
            const profit = totalSales - totalCost;
            const grossMargin = totalSales > 0 ? (profit / totalSales * 100) : 0;
            const avgOrderValue = orderCount > 0 ? (totalSales / orderCount) : 0;
            const avgUnitPrice = totalQtySold > 0 ? (totalSales / totalQtySold) : 0;
            const avgUnitCost = totalQtySold > 0 ? (totalCost / totalQtySold) : 0;
            
            // Calculate expense metrics - use totalExpensesForProfit for net profit calculation
            const totalExpenses = expenseData.totalExpenses || 0;
            const totalExpensesForProfit = expenseData.totalExpensesForProfit || 0;
            const totalExcludedFromProfit = expenseData.totalExcludedFromProfit || 0;
            const totalReimbursements = expenseData.totalReimbursements || 0;
            const grossExpenses = totalExpenses; // Expenses before reimbursements
            const netProfit = profit - totalExpensesForProfit; // Only subtract actual cash expenses
            const netMargin = totalSales > 0 ? (netProfit / totalSales * 100) : 0;
            
            // Calculate daily expense rate (divide total expenses by number of days in period)
            const daysInPeriod = Math.max(1, Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1);
            const dailyExpenseRate = totalExpensesForProfit / daysInPeriod;
            const dailySalesAvg = totalSales / daysInPeriod;
            const dailyProfitAvg = netProfit / daysInPeriod;
            
            // Sort top performers
            const topCustomers = Object.values(customerSales).sort((a, b) => b.sales - a.sales).slice(0, 10);
            const topProducts = Object.values(productSales).sort((a, b) => b.sales - a.sales).slice(0, 10);
            const topCities = Object.values(citySales)
                .map(c => ({ ...c, customerCount: c.customers.size }))
                .sort((a, b) => b.sales - a.sales)
                .slice(0, 10);
            
            // Calculate max values for bar charts
            const maxCustomerOrders = Math.max(...topCustomers.map(c => c.orders), 1);
            const maxProductQty = Math.max(...topProducts.map(p => p.qty), 1);
            const maxCityOrders = Math.max(...topCities.map(c => c.orders), 1);
            
            // Unique customers and products count
            const uniqueCustomers = Object.keys(customerSales).length;
            const uniqueProducts = Object.keys(productSales).length;
            
            // Working days calculation
            const workingDays = Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1;
            
            // Bar colors
            const barColors = ['#6b9a8d', '#7a9bb8', '#b8a86b', '#b88a8a', '#9a8ab8', '#b89aaa', '#7aaab8', '#9ab88a', '#b8a07a', '#8a8ab0'];
            
            // Date range label - show "All Time" if no specific dates were selected
            let dateLabel;
            if (!reportFilters.fromDate && !reportFilters.toDate) {
                dateLabel = 'All Time';
            } else {
                const fromStr = fromDate.toLocaleDateString();
                const toStr = toDate.toLocaleDateString();
                dateLabel = fromStr === toStr ? fromStr : `${fromStr} - ${toStr}`;
            }
            
            // Build dashboard HTML with clean card styling
            let html = `
                <style>
                    .daily-dash {
                        background: white;
                        border-radius: 16px;
                        padding: 25px;
                        color: #1f2937;
                        border: 2px solid #e0e0e0;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    }
                    .daily-dash-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 25px;
                        padding-bottom: 20px;
                        border-bottom: 2px solid #e5e7eb;
                        flex-wrap: wrap;
                        gap: 15px;
                    }
                    .daily-dash-header h2 {
                        margin: 0;
                        font-size: 28px;
                        font-weight: 700;
                        color: ${themeColor};
                    }
                    .daily-dash-header p {
                        margin: 5px 0 0 0;
                        color: #6b7280;
                        font-size: 14px;
                    }
                    .daily-dash-badge {
                        background: ${themeColor};
                        color: white;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 500;
                        flex-shrink: 0;
                    }
                    .daily-dash-stats {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                        gap: 15px;
                        margin-bottom: 20px;
                    }
                    .daily-dash-stat {
                        background: #f8fafc;
                        border-radius: 12px;
                        padding: 18px;
                        text-align: center;
                        border: 1px solid #e2e8f0;
                        min-width: 0;
                        overflow: hidden;
                    }
                    .daily-dash-stat-label {
                        font-size: 11px;
                        color: #6b7280;
                        text-transform: uppercase;
                        margin-bottom: 8px;
                        font-weight: 600;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .daily-dash-stat-value {
                        font-size: 24px;
                        font-weight: 700;
                        color: #1f2937;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .daily-dash-stat-sub {
                        font-size: 11px;
                        color: #9ca3af;
                        margin-top: 4px;
                    }
                    .daily-dash-stats-row2 {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    .daily-dash-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                        gap: 20px;
                    }
                    .daily-dash-card {
                        background: #f8fafc;
                        border-radius: 12px;
                        padding: 20px;
                        border: 1px solid #e2e8f0;
                        min-width: 0;
                        overflow: hidden;
                    }
                    .daily-dash-card-title {
                        font-size: 16px;
                        font-weight: 600;
                        margin-bottom: 15px;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        color: #1e3a5f;
                    }
                    .daily-dash-card-title .icon {
                        background: ${themeColor};
                        color: white;
                        width: 32px;
                        height: 32px;
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 16px;
                        flex-shrink: 0;
                    }
                    .daily-dash-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 13px;
                    }
                    .daily-dash-table th {
                        text-align: left;
                        padding: 10px 6px;
                        border-bottom: 2px solid #e5e7eb;
                        color: #6b7280;
                        font-weight: 600;
                        font-size: 11px;
                        text-transform: uppercase;
                    }
                    .daily-dash-table td {
                        padding: 12px 6px;
                        border-bottom: 1px solid #f3f4f6;
                        vertical-align: top;
                    }
                    .daily-dash-list {
                        display: flex;
                        flex-direction: column;
                        gap: 0;
                    }
                    .daily-dash-list-item {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px 0;
                        border-bottom: 1px solid #e5e7eb;
                    }
                    .daily-dash-list-item:last-child {
                        border-bottom: none;
                    }
                    .daily-dash-list-name {
                        flex: 1;
                        min-width: 0;
                        overflow: hidden;
                    }
                    .daily-dash-list-title {
                        font-weight: 600;
                        font-size: 14px;
                        color: #1f2937;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }
                    .daily-dash-list-sub {
                        font-size: 11px;
                        color: #9ca3af;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }
                    .daily-dash-list-value {
                        font-weight: 600;
                        font-size: 14px;
                        color: #10b981;
                        white-space: nowrap;
                        flex-shrink: 0;
                    }
                    /* Horizontal Bar Chart Styles */
                    .daily-dash-bar-list {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                        width: 100%;
                        overflow: hidden;
                    }
                    .daily-dash-bar-item {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        width: 100%;
                        min-width: 0;
                    }
                    .daily-dash-bar-label {
                        display: flex;
                        align-items: flex-start;
                        gap: 4px;
                        width: 110px;
                        flex-shrink: 0;
                        overflow: hidden;
                    }
                    .daily-dash-bar-rank {
                        font-weight: 600;
                        color: #6b7280;
                        font-size: 13px;
                        min-width: 18px;
                        flex-shrink: 0;
                    }
                    .daily-dash-bar-name {
                        flex: 1;
                        min-width: 0;
                        overflow: hidden;
                    }
                    .daily-dash-bar-title {
                        font-weight: 600;
                        font-size: 12px;
                        color: #1f2937;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }
                    .daily-dash-bar-sub {
                        font-size: 10px;
                        color: #9ca3af;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }
                    .daily-dash-bar-track {
                        flex: 1;
                        height: 22px;
                        background: #f3f4f6;
                        border-radius: 12px;
                        overflow: hidden;
                        min-width: 50px;
                    }
                    .daily-dash-bar-fill {
                        height: 100%;
                        border-radius: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: flex-end;
                        padding-right: 6px;
                        min-width: 30px;
                        transition: width 0.3s ease;
                    }
                    .daily-dash-bar-badge {
                        font-size: 10px;
                        font-weight: 600;
                        color: white;
                        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
                    }
                    .daily-dash-bar-value {
                        font-weight: 600;
                        font-size: 12px;
                        color: #1f2937;
                        width: 65px;
                        text-align: right;
                        white-space: nowrap;
                        flex-shrink: 0;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    /* Quick Stats Styles */
                    .daily-dash-quick-stats {
                        display: flex;
                        flex-direction: column;
                        gap: 0;
                    }
                    .daily-dash-quick-stat {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 0;
                        border-bottom: 1px solid #e5e7eb;
                    }
                    .daily-dash-quick-stat:last-child {
                        border-bottom: none;
                    }
                    .daily-dash-quick-label {
                        font-size: 14px;
                        color: #4b5563;
                    }
                    .daily-dash-quick-value {
                        font-size: 16px;
                        font-weight: 600;
                        color: #1f2937;
                    }
                    .daily-dash-table tr:last-child td {
                        border-bottom: none;
                    }
                    .rank-badge {
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 11px;
                        color: white;
                    }
                    .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); }
                    .rank-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
                    .rank-3 { background: linear-gradient(135deg, #CD7F32, #8B4513); }
                    .rank-other { background: #e5e7eb; color: #6b7280; }
                    @media print {
                        .daily-dash { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    }
                </style>
                
                <div class="daily-dash">
                    <div class="daily-dash-header">
                        <div>
                            <h2> Daily Sales Dashboard</h2>
                            <p>Sales Performance Summary${reportFilters.customer ? '  ' + getCustomerName(reportFilters.customer) : ''}</p>
                        </div>
                        <div class="daily-dash-badge">${dateLabel}</div>
                    </div>
                    
                    <!-- Primary KPIs - Revenue Flow -->
                    <div class="daily-dash-stats">
                        <div class="daily-dash-stat">
                            <div class="daily-dash-stat-label"> Sales</div>
                            <div class="daily-dash-stat-value" style="color: ${themeColor};">${formatMoney(totalSales)}</div>
                            <div class="daily-dash-stat-sub">${formatMoney(dailySalesAvg)}/day</div>
                        </div>
                        <div class="daily-dash-stat">
                            <div class="daily-dash-stat-label"> COGS</div>
                            <div class="daily-dash-stat-value" style="color: #b8a86b;">${formatMoney(totalCost)}</div>
                            <div class="daily-dash-stat-sub">cost of goods</div>
                        </div>
                        <div class="daily-dash-stat">
                            <div class="daily-dash-stat-label"> Gross Profit</div>
                            <div class="daily-dash-stat-value" style="color: ${profit >= 0 ? '#10b981' : '#b88a8a'};">${formatMoney(profit)}</div>
                            <div class="daily-dash-stat-sub">${grossMargin.toFixed(1)}% margin</div>
                        </div>
                        <div class="daily-dash-stat">
                            <div class="daily-dash-stat-label"> Net Op. Exp</div>
                            <div class="daily-dash-stat-value" style="color: ${totalExpensesForProfit >= 0 ? '#9333ea' : '#059669'};">${formatMoney(totalExpensesForProfit)}</div>
                            <div class="daily-dash-stat-sub">${totalReimbursements > 0 ? formatMoney(grossExpenses) + ' - ' + formatMoney(totalReimbursements) : formatMoney(dailyExpenseRate) + '/day'}${totalExcludedFromProfit > 0 ? '  +' + formatMoney(totalExcludedFromProfit) + ' tax' : ''}</div>
                        </div>
                        <div class="daily-dash-stat" style="background: ${netProfit >= 0 ? 'linear-gradient(135deg, #d1fae5, #a7f3d0)' : 'linear-gradient(135deg, #fee2e2, #fecaca)'};">
                            <div class="daily-dash-stat-label"> Net Profit</div>
                            <div class="daily-dash-stat-value" style="color: ${netProfit >= 0 ? '#059669' : '#dc2626'};">${formatMoney(netProfit)}</div>
                            <div class="daily-dash-stat-sub">${netMargin.toFixed(1)}% net  ${formatMoney(dailyProfitAvg)}/day</div>
                        </div>
                    </div>
                    
                    <!-- Secondary KPIs - Activity Metrics -->
                    <div class="daily-dash-stats" style="margin-bottom: 25px;">
                        <div class="daily-dash-stat">
                            <div class="daily-dash-stat-label"> Units Sold</div>
                            <div class="daily-dash-stat-value" style="color: #3b82f6;">${totalQtySold.toLocaleString()}</div>
                            <div class="daily-dash-stat-sub">total quantity</div>
                        </div>
                        <div class="daily-dash-stat">
                            <div class="daily-dash-stat-label"> Orders</div>
                            <div class="daily-dash-stat-value" style="color: #8b5cf6;">${orderCount.toLocaleString()}</div>
                            <div class="daily-dash-stat-sub">${(orderCount / daysInPeriod).toFixed(1)}/day avg</div>
                        </div>
                        <div class="daily-dash-stat">
                            <div class="daily-dash-stat-label"> Customers</div>
                            <div class="daily-dash-stat-value" style="color: #0891b2;">${uniqueCustomers}</div>
                            <div class="daily-dash-stat-sub">unique buyers</div>
                        </div>
                        <div class="daily-dash-stat">
                            <div class="daily-dash-stat-label"> Avg Order</div>
                            <div class="daily-dash-stat-value" style="color: #6b9a8d;">${formatMoney(avgOrderValue)}</div>
                            <div class="daily-dash-stat-sub">per order</div>
                        </div>
                        <div class="daily-dash-stat">
                            <div class="daily-dash-stat-label"> Discounts</div>
                            <div class="daily-dash-stat-value" style="color: ${totalDiscount > 0 ? '#b88a8a' : '#9ca3af'};">${totalDiscount > 0 ? formatMoney(totalDiscount) : '$0.00'}</div>
                            <div class="daily-dash-stat-sub">given</div>
                        </div>
                    </div>
                    
                    <!-- Top 10 Charts - 2 columns -->
                    <div class="daily-dash-grid" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));">
                        <!-- Top 10 Customers -->
                        <div class="daily-dash-card">
                            <div class="daily-dash-card-title">
                                <span class="icon"></span>
                                Top 10 Customers
                            </div>
                            ${topCustomers.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No sales in this period</p>' : `
                            <div class="daily-dash-bar-list">
                                ${topCustomers.map((c, i) => `
                                    <div class="daily-dash-bar-item">
                                        <div class="daily-dash-bar-label">
                                            <span class="daily-dash-bar-rank">${i + 1}.</span>
                                            <div class="daily-dash-bar-name">
                                                <div class="daily-dash-bar-title">${c.name}</div>
                                                <div class="daily-dash-bar-sub">${c.location || ''}</div>
                                            </div>
                                        </div>
                                        <div class="daily-dash-bar-track">
                                            <div class="daily-dash-bar-fill" style="width: ${(c.orders / maxCustomerOrders * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]};">
                                                <span class="daily-dash-bar-badge">${c.orders}</span>
                                            </div>
                                        </div>
                                        <div class="daily-dash-bar-value">${formatMoney(c.sales)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            `}
                        </div>
                        
                        <!-- Top 10 Products -->
                        <div class="daily-dash-card">
                            <div class="daily-dash-card-title">
                                <span class="icon"></span>
                                Top 10 Products
                            </div>
                            ${topProducts.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No sales in this period</p>' : `
                            <div class="daily-dash-bar-list">
                                ${topProducts.map((p, i) => `
                                    <div class="daily-dash-bar-item">
                                        <div class="daily-dash-bar-label">
                                            <span class="daily-dash-bar-rank">${i + 1}.</span>
                                            <div class="daily-dash-bar-name">
                                                <div class="daily-dash-bar-title">${p.name}</div>
                                                <div class="daily-dash-bar-sub">${p.qty} units  ${p.supplierName}</div>
                                            </div>
                                        </div>
                                        <div class="daily-dash-bar-track">
                                            <div class="daily-dash-bar-fill" style="width: ${(p.qty / maxProductQty * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]};">
                                                <span class="daily-dash-bar-badge">${p.qty}</span>
                                            </div>
                                        </div>
                                        <div class="daily-dash-bar-value">${formatMoney(p.sales)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Top 10 Cities + Quick Stats - 2 columns -->
                    <div class="daily-dash-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                        <!-- Top 10 Cities -->
                        <div class="daily-dash-card">
                            <div class="daily-dash-card-title">
                                <span class="icon"></span>
                                Top 10 Cities
                            </div>
                            ${topCities.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No sales in this period</p>' : `
                            <div class="daily-dash-bar-list">
                                ${topCities.map((c, i) => `
                                    <div class="daily-dash-bar-item">
                                        <div class="daily-dash-bar-label">
                                            <span class="daily-dash-bar-rank">${i + 1}.</span>
                                            <div class="daily-dash-bar-name">
                                                <div class="daily-dash-bar-title">${c.city}${c.state ? ', ' + c.state : ''}</div>
                                                <div class="daily-dash-bar-sub">${c.customerCount} customer${c.customerCount !== 1 ? 's' : ''}</div>
                                            </div>
                                        </div>
                                        <div class="daily-dash-bar-track">
                                            <div class="daily-dash-bar-fill" style="width: ${(c.orders / maxCityOrders * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]};">
                                                <span class="daily-dash-bar-badge">${c.orders}</span>
                                            </div>
                                        </div>
                                        <div class="daily-dash-bar-value">${formatMoney(c.sales)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            `}
                        </div>
                        
                        <!-- Quick Stats -->
                        <div class="daily-dash-card">
                            <div class="daily-dash-card-title">
                                <span class="icon"></span>
                                Quick Stats
                            </div>
                            <div class="daily-dash-quick-stats">
                                <div class="daily-dash-quick-stat">
                                    <span class="daily-dash-quick-label"> Total Revenue</span>
                                    <span class="daily-dash-quick-value">${formatMoney(totalSales)}</span>
                                </div>
                                <div class="daily-dash-quick-stat">
                                    <span class="daily-dash-quick-label"> Total Cost</span>
                                    <span class="daily-dash-quick-value">${formatMoney(totalCost)}</span>
                                </div>
                                <div class="daily-dash-quick-stat">
                                    <span class="daily-dash-quick-label"> List Price Total</span>
                                    <span class="daily-dash-quick-value" style="color: #b8a86b;">${formatMoney(totalListPrice)}</span>
                                </div>
                                <div class="daily-dash-quick-stat">
                                    <span class="daily-dash-quick-label"> Discounts Given</span>
                                    <span class="daily-dash-quick-value" style="color: ${totalDiscount > 0 ? '#b88a8a' : '#9ca3af'};">${totalDiscount > 0 ? formatMoney(totalDiscount) : '-'}</span>
                                </div>
                                <div class="daily-dash-quick-stat">
                                    <span class="daily-dash-quick-label"> Gross Profit</span>
                                    <span class="daily-dash-quick-value" style="color: #10b981;">${formatMoney(profit)}</span>
                                </div>
                                <div class="daily-dash-quick-stat">
                                    <span class="daily-dash-quick-label"> Profit Margin</span>
                                    <span class="daily-dash-quick-value">${grossMargin.toFixed(1)}%</span>
                                </div>
                                <div class="daily-dash-quick-stat">
                                    <span class="daily-dash-quick-label"> Total Orders</span>
                                    <span class="daily-dash-quick-value">${orderCount.toLocaleString()}</span>
                                </div>
                                <div class="daily-dash-quick-stat">
                                    <span class="daily-dash-quick-label"> Avg Order Value</span>
                                    <span class="daily-dash-quick-value">${formatMoney(avgOrderValue)}</span>
                                </div>
                                <div class="daily-dash-quick-stat">
                                    <span class="daily-dash-quick-label"> Active Customers</span>
                                    <span class="daily-dash-quick-value">${uniqueCustomers}</span>
                                </div>
                                <div class="daily-dash-quick-stat">
                                    <span class="daily-dash-quick-label"> Products Sold</span>
                                    <span class="daily-dash-quick-value">${uniqueProducts}</span>
                                </div>
                                <div class="daily-dash-quick-stat">
                                    <span class="daily-dash-quick-label"> Working Days</span>
                                    <span class="daily-dash-quick-value">${workingDays} days</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Expense Breakdown Section -->
                    ${totalExpensesForProfit !== 0 || totalExcludedFromProfit > 0 || (expenseData.totalReimbursements || 0) > 0 ? `
                    <div class="daily-dash-grid" style="grid-template-columns: 1fr; margin-top: 20px;">
                        <div class="daily-dash-card">
                            <div class="daily-dash-card-title">
                                <span class="icon" style="background: #9333ea;"></span>
                                Operating Expenses Breakdown
                                <span style="margin-left: auto; font-size: 12px; color: #6b7280; font-weight: normal;">
                                    ${daysInPeriod} day${daysInPeriod !== 1 ? 's' : ''}  ${formatMoney(Math.abs(dailyExpenseRate))}/day avg
                                    ${(expenseData.totalProrated || 0) > 0 ? '  <span style="color: #0891b2;">prorated</span>' : ''}
                                </span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px;">
                                ${expenseData.byCategory.sort((a, b) => {
                                    // Sort: expenses first, then reimbursements
                                    if (a.isReimbursement && !b.isReimbursement) return 1;
                                    if (!a.isReimbursement && b.isReimbursement) return -1;
                                    return b.total - a.total;
                                }).map(cat => {
                                    const isProrated = (cat.totalProrated || 0) > 0.01;
                                    const isReimbursement = cat.isReimbursement === true;
                                    const bgColor = isReimbursement ? '#f0fdf4' : (cat.excludeFromProfit ? '#fffbeb' : (isProrated ? '#f0fdfa' : 'white'));
                                    const borderColor = isReimbursement ? '#bbf7d0' : (cat.excludeFromProfit ? '#fcd34d' : (isProrated ? '#99f6e4' : '#e5e7eb'));
                                    const amountColor = isReimbursement ? '#059669' : (cat.excludeFromProfit ? '#f59e0b' : (isProrated ? '#0891b2' : '#9333ea'));
                                    return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${bgColor}; border-radius: 8px; border: 1px solid ${borderColor};">
                                        <div>
                                            <div style="font-weight: 600; font-size: 13px; color: #374151;">
                                                ${cat.categoryName}
                                                ${isReimbursement ? '<span style="font-size: 10px; background: #059669; color: white; padding: 2px 5px; border-radius: 3px; margin-left: 5px;">CREDIT</span>' : ''}
                                                ${cat.excludeFromProfit ? '<span style="font-size: 10px; background: #f59e0b; color: white; padding: 2px 5px; border-radius: 3px; margin-left: 5px;">TAX ONLY</span>' : ''}
                                                ${isProrated && !isReimbursement ? '<span style="font-size: 10px; background: #0891b2; color: white; padding: 2px 5px; border-radius: 3px; margin-left: 5px;">PRORATED</span>' : ''}
                                            </div>
                                            <div style="font-size: 11px; color: #9ca3af;">
                                                ${cat.count} ${isReimbursement ? 'credit' : 'expense'}${cat.count !== 1 ? 's' : ''}
                                                ${isProrated && !isReimbursement ? '  Full: ' + formatMoney(cat.totalActual) : ''}
                                            </div>
                                        </div>
                                        <div style="font-weight: 700; color: ${amountColor}; font-size: 15px;">${isReimbursement ? '-' : ''}${formatMoney(cat.total)}</div>
                                    </div>
                                `}).join('')}
                            </div>
                            ${(expenseData.totalReimbursements || 0) > 0 ? '<div style="margin-top: 12px; padding: 10px; background: #f0fdf4; border-radius: 8px; font-size: 12px; color: #166534;"><strong> Credits Applied:</strong> Reimbursements total -' + formatMoney(expenseData.totalReimbursements) + ' (reduces your net expenses)</div>' : ''}
                            ${(expenseData.totalProrated || 0) > 0.01 ? '<div style="margin-top: 12px; padding: 10px; background: #f0fdfa; border-radius: 8px; font-size: 12px; color: #0e7490;"><strong> Proration Applied:</strong> Fixed monthly expenses are prorated for the ' + daysInPeriod + '-day period.</div>' : ''}
                            ${totalExcludedFromProfit > 0 ? '<div style="margin-top: 12px; padding: 10px; background: #fffbeb; border-radius: 8px; font-size: 12px; color: #92400e;"><strong>Note:</strong> Tax-only expenses (' + formatMoney(totalExcludedFromProfit) + ') are tracked for tax records but not subtracted from Net Profit.</div>' : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            return html;
        }
        
        // ==================== BUSINESS OVERVIEW DASHBOARD ====================
        
        async function generateBusinessOverviewModal() {
            const topN = reportFilters.topN || 10;
            const fromDate = reportFilters.fromDate ? parseLocalDate(reportFilters.fromDate) : null;
            let toDate = reportFilters.toDate ? parseLocalDate(reportFilters.toDate) : null;
            if (toDate) toDate.setHours(23, 59, 59, 999);
            if (fromDate) fromDate.setHours(0, 0, 0, 0);
            
            // Load report data AND expense data in PARALLEL for speed
            let expenseData = { expenses: [], byCategory: [], totalExpenses: 0, expenseCount: 0 };
            
            const [reportLoaded, expResult] = await Promise.all([
                loadReportData(),
                apiCall('getExpensesForPeriod', {
                    fromDate: reportFilters.fromDate || '',
                    toDate: reportFilters.toDate || ''
                }).catch(e => {
                    console.log('Could not load expenses:', e);
                    return null;
                })
            ]);
            
            if (expResult && expResult.status === 'success' && expResult.data) {
                expenseData = expResult.data;
            }
            
            const items = cachedItems;
            const customers = cachedCustomers;
            const suppliers = cachedSuppliers;
            const purchases = cachedPurchaseOrders;
            let sales = cachedSalesOrders.filter(so => so.Status !== 'Voided');
            
            if (!items.length) {
                throw new Error('Failed to load data');
            }
            
            // Date label
            let dateLabel = 'All Time';
            if (fromDate && toDate) {
                dateLabel = `${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`;
            } else if (fromDate) {
                dateLabel = `Since ${fromDate.toLocaleDateString()}`;
            } else if (toDate) {
                dateLabel = `Through ${toDate.toLocaleDateString()}`;
            }
            
            // Filter sales by date
            const filteredSales = sales.filter(so => {
                const soDate = parseDate(so.Sale_Date || so.SO_Date);
                if (!soDate) return false;
                if (fromDate && soDate < fromDate) return false;
                if (toDate && soDate > toDate) return false;
                return true;
            });
            
            // Filter purchases by date
            const filteredPurchases = purchases.filter(po => {
                if (po.Status === 'Voided' || po.Status === 'Cancelled') return false;
                const poDate = parseDate(po.PO_Date);
                if (!poDate) return false;
                if (fromDate && poDate < fromDate) return false;
                if (toDate && poDate > toDate) return false;
                return true;
            });
            
            // Calculate Sales Stats
            let totalRevenue = 0, totalCost = 0, orderCount = filteredSales.length;
            const monthlySales = {};
            const customerSet = new Set();
            const productSet = new Set();
            let totalUnitsSold = 0;
            
            // Pre-index sales lines by SO_ID for O(1) lookups instead of O(n) filtering
            const salesLinesBySO = {};
            cachedSalesLines.forEach(line => {
                if (!salesLinesBySO[line.SO_ID]) salesLinesBySO[line.SO_ID] = [];
                salesLinesBySO[line.SO_ID].push(line);
            });
            
            // Pre-index items by Item_ID for O(1) lookups
            const itemsById = {};
            items.forEach(item => { itemsById[item.Item_ID] = item; });
            
            for (const so of filteredSales) {
                const soDate = parseDate(so.Sale_Date || so.SO_Date);
                const monthKey = soDate ? `${soDate.getFullYear()}-${String(soDate.getMonth() + 1).padStart(2, '0')}` : 'Unknown';
                customerSet.add(so.Customer_ID);
                
                // Use pre-indexed lookup - O(1) instead of O(n)
                const lines = salesLinesBySO[so.SO_ID] || [];
                for (const line of lines) {
                    const qty = parseInt(line.Quantity) || 0;
                    const unitPrice = parseFloat(line.Unit_Price) || 0;
                    const revenue = qty * unitPrice;
                    
                    // Use stored Unit_Cost if available, fall back to current item cost
                    let unitCost;
                    const storedUnitCost = parseFloat(line.Unit_Cost);
                    if (!isNaN(storedUnitCost) && storedUnitCost > 0) {
                        unitCost = storedUnitCost;
                    } else {
                        // Use pre-indexed item lookup - O(1) instead of O(n)
                        const item = itemsById[line.Item_ID];
                        const unitsPerPkg = parseFloat(item?.Units_Per_Package) || 1;
                        const pkgCost = parseFloat(item?.Package_Cost) || 0;
                        unitCost = pkgCost / unitsPerPkg;
                    }
                    
                    const cost = qty * unitCost;
                    
                    totalRevenue += revenue;
                    totalCost += cost;
                    totalUnitsSold += qty;
                    productSet.add(line.Item_ID);
                    
                    if (!monthlySales[monthKey]) {
                        monthlySales[monthKey] = { revenue: 0, cost: 0, profit: 0, orders: 0 };
                    }
                    monthlySales[monthKey].revenue += revenue;
                    monthlySales[monthKey].cost += cost;
                    monthlySales[monthKey].profit += (revenue - cost);
                }
                if (monthlySales[monthKey]) monthlySales[monthKey].orders++;
            }
            
            const totalProfit = totalRevenue - totalCost;
            const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
            const avgOrderValue = orderCount > 0 ? totalRevenue / orderCount : 0;
            
            // Calculate Net Profit (after operating expenses) - only use profit-affecting expenses
            const totalExpenses = expenseData.totalExpenses || 0;
            const totalExpensesForProfit = expenseData.totalExpensesForProfit || 0;
            const totalExcludedFromProfit = expenseData.totalExcludedFromProfit || 0;
            const totalReimbursements = expenseData.totalReimbursements || 0;
            const grossExpenses = totalExpenses; // Expenses before reimbursements
            const netProfit = totalProfit - totalExpensesForProfit;
            const netMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
            
            // Calculate Purchase Stats
            let totalPOAmount = 0, totalPOPaid = 0;
            let receivedPOCount = 0, pendingPOCount = 0;
            
            for (const po of filteredPurchases) {
                const poAmount = parseFloat(po.Total_Amount) || 0;
                const poPaid = parseFloat(po.Amount_Paid) || 0;
                totalPOAmount += poAmount;
                totalPOPaid += poPaid;
                if (po.Status === 'Received') receivedPOCount++;
                else pendingPOCount++;
            }
            const totalPOOutstanding = totalPOAmount - totalPOPaid;
            
            // Inventory Stats
            let totalBackorder = 0, backorderItems = 0, totalOnOrder = 0, onOrderItems = 0;
            items.forEach(item => {
                const backorder = parseInt(item.Qty_On_Backorder) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                if (backorder > 0) { totalBackorder += backorder; backorderItems++; }
                if (onOrder > 0) { totalOnOrder += onOrder; onOrderItems++; }
            });
            
            // Monthly data for chart
            const sortedMonths = Object.entries(monthlySales).sort((a, b) => a[0].localeCompare(b[0])).slice(-12);
            const monthLabels = sortedMonths.map(([m]) => {
                const [year, month] = m.split('-');
                return new Date(year, parseInt(month) - 1).toLocaleDateString('en-US', { month: 'short' });
            });
            const revenueData = sortedMonths.map(([, d]) => d.revenue.toFixed(2));
            const profitData = sortedMonths.map(([, d]) => d.profit.toFixed(2));
            
            // Chart IDs
            const salesChartId = 'bizSalesChart_' + Date.now();
            const poChartId = 'bizPOChart_' + Date.now();
            
            // Get theme color from CSS variable
            const themeColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#1e3a5f';
            
            let html = `
                <style>
                    .biz-dash {
                        background: white;
                        border-radius: 16px;
                        padding: 25px;
                        color: #1f2937;
                        border: 2px solid #e0e0e0;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    }
                    .biz-dash-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 25px;
                        padding-bottom: 20px;
                        border-bottom: 2px solid #e5e7eb;
                        flex-wrap: wrap;
                        gap: 15px;
                    }
                    .biz-dash-header h2 {
                        margin: 0;
                        font-size: 28px;
                        font-weight: 700;
                        color: ${themeColor};
                    }
                    .biz-dash-header p {
                        margin: 5px 0 0 0;
                        color: #6b7280;
                        font-size: 14px;
                    }
                    .biz-dash-badge {
                        background: ${themeColor};
                        color: white;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 500;
                        flex-shrink: 0;
                    }
                    .biz-dash-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                        gap: 20px;
                        margin-bottom: 20px;
                    }
                    .biz-dash-card {
                        background: #f8fafc;
                        border-radius: 12px;
                        padding: 20px;
                        border: 1px solid #e2e8f0;
                        min-width: 0;
                        overflow: hidden;
                    }
                    .biz-dash-card-title {
                        font-size: 18px;
                        font-weight: 600;
                        margin-bottom: 15px;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        color: #1e3a5f;
                    }
                    .biz-dash-card-title .icon {
                        background: ${themeColor};
                        color: white;
                        width: 36px;
                        height: 36px;
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 18px;
                        flex-shrink: 0;
                    }
                    .biz-dash-kpi-grid {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 12px;
                    }
                    .biz-dash-kpi {
                        background: white;
                        border-radius: 8px;
                        padding: 12px;
                        border: 1px solid #e5e7eb;
                    }
                    .biz-dash-kpi-label {
                        font-size: 11px;
                        color: #6b7280;
                        text-transform: uppercase;
                        margin-bottom: 5px;
                        letter-spacing: 0.5px;
                    }
                    .biz-dash-kpi-value {
                        font-size: 22px;
                        font-weight: 700;
                        color: #1f2937;
                    }
                    .biz-dash-chart {
                        height: 200px;
                        margin: 15px 0;
                    }
                    .biz-dash-donut {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 10px 0;
                    }
                    .biz-dash-bottom {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                        gap: 15px;
                        margin-top: 20px;
                    }
                    .biz-dash-stat {
                        background: #f8fafc;
                        border-radius: 10px;
                        padding: 18px;
                        text-align: center;
                        border: 1px solid #e2e8f0;
                        min-width: 0;
                        overflow: hidden;
                    }
                    .biz-dash-stat-label {
                        font-size: 11px;
                        color: #6b7280;
                        margin-bottom: 8px;
                        text-transform: uppercase;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .biz-dash-stat-value {
                        font-size: 24px;
                        font-weight: 700;
                        color: #1f2937;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .biz-dash-stat-sub {
                        font-size: 12px;
                        color: #6b7280;
                        margin-top: 5px;
                    }
                    @media print {
                        .biz-dash { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    }
                </style>
                
                <div class="biz-dash">
                    <div class="biz-dash-header">
                        <div>
                            <h2> Business Overview</h2>
                            <p>Sales Performance, Customer and Operations</p>
                        </div>
                        <div class="biz-dash-badge">${dateLabel}</div>
                    </div>
                    
                    <!-- Top Stats Row - Key Metrics -->
                    <div class="biz-dash-bottom" style="margin-bottom: 20px; margin-top: 0;">
                        <div class="biz-dash-stat">
                            <div class="biz-dash-stat-label"> TOTAL REVENUE</div>
                            <div class="biz-dash-stat-value" style="color: ${themeColor};">${formatMoney(totalRevenue)}</div>
                        </div>
                        <div class="biz-dash-stat">
                            <div class="biz-dash-stat-label"> COST OF GOODS</div>
                            <div class="biz-dash-stat-value" style="color: #b8a86b;">${formatMoney(totalCost)}</div>
                        </div>
                        <div class="biz-dash-stat">
                            <div class="biz-dash-stat-label"> GROSS PROFIT</div>
                            <div class="biz-dash-stat-value" style="color: #10b981;">${formatMoney(totalProfit)}</div>
                            <div class="biz-dash-stat-sub">${avgMargin.toFixed(1)}% margin</div>
                        </div>
                        <div class="biz-dash-stat">
                            <div class="biz-dash-stat-label"> NET OPERATING EXP</div>
                            <div class="biz-dash-stat-value" style="color: ${totalExpensesForProfit >= 0 ? '#9333ea' : '#059669'};">${formatMoney(totalExpensesForProfit)}</div>
                            <div class="biz-dash-stat-sub">${totalReimbursements > 0 ? formatMoney(grossExpenses) + ' - ' + formatMoney(totalReimbursements) + ' credit' : (expenseData.expenseCount || 0) + ' expenses'}${totalExcludedFromProfit > 0 ? '  +' + formatMoney(totalExcludedFromProfit) + ' tax' : ''}</div>
                        </div>
                        <div class="biz-dash-stat" style="background: ${netProfit >= 0 ? 'linear-gradient(135deg, #d1fae5, #a7f3d0)' : 'linear-gradient(135deg, #fee2e2, #fecaca)'};">
                            <div class="biz-dash-stat-label"> NET PROFIT</div>
                            <div class="biz-dash-stat-value" style="color: ${netProfit >= 0 ? '#059669' : '#dc2626'};">${formatMoney(netProfit)}</div>
                            <div class="biz-dash-stat-sub">${netMargin.toFixed(1)}% net margin</div>
                        </div>
                    </div>
                    
                    <!-- Main 3-Column Grid -->
                    <div class="biz-dash-grid">
                        <!-- Sales Performance -->
                        <div class="biz-dash-card">
                            <div class="biz-dash-card-title">
                                <span class="icon"></span>
                                Sales Performance
                            </div>
                            <div class="biz-dash-chart">
                                <canvas id="${salesChartId}"></canvas>
                            </div>
                            <div class="biz-dash-kpi-grid">
                                <div class="biz-dash-kpi">
                                    <div class="biz-dash-kpi-label">Avg Order Value</div>
                                    <div class="biz-dash-kpi-value">${formatMoney(avgOrderValue)}</div>
                                </div>
                                <div class="biz-dash-kpi">
                                    <div class="biz-dash-kpi-label">Total Orders</div>
                                    <div class="biz-dash-kpi-value">${orderCount.toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Customer & Operations -->
                        <div class="biz-dash-card">
                            <div class="biz-dash-card-title">
                                <span class="icon"></span>
                                Customer & Operations
                            </div>
                            <div class="biz-dash-kpi-grid">
                                <div class="biz-dash-kpi">
                                    <div class="biz-dash-kpi-label">Active Customers</div>
                                    <div class="biz-dash-kpi-value">${customerSet.size}</div>
                                </div>
                                <div class="biz-dash-kpi">
                                    <div class="biz-dash-kpi-label">Products Sold</div>
                                    <div class="biz-dash-kpi-value">${productSet.size}</div>
                                </div>
                                <div class="biz-dash-kpi">
                                    <div class="biz-dash-kpi-label">Units Sold</div>
                                    <div class="biz-dash-kpi-value">${totalUnitsSold.toLocaleString()}</div>
                                </div>
                                <div class="biz-dash-kpi">
                                    <div class="biz-dash-kpi-label">On Backorder</div>
                                    <div class="biz-dash-kpi-value" style="${totalBackorder > 0 ? 'color: #fca5a5;' : ''}">${totalBackorder}</div>
                                </div>
                            </div>
                            <div class="biz-dash-kpi" style="margin-top: 12px;">
                                <div class="biz-dash-kpi-label">Qty On Order (from suppliers)</div>
                                <div class="biz-dash-kpi-value">${totalOnOrder.toLocaleString()}</div>
                            </div>
                        </div>
                        
                        <!-- Purchase Orders Summary -->
                        <div class="biz-dash-card">
                            <div class="biz-dash-card-title">
                                <span class="icon"></span>
                                Purchase Orders
                            </div>
                            <div class="biz-dash-kpi-grid">
                                <div class="biz-dash-kpi">
                                    <div class="biz-dash-kpi-label">Total PO Amount</div>
                                    <div class="biz-dash-kpi-value">${formatMoney(totalPOAmount)}</div>
                                </div>
                                <div class="biz-dash-kpi">
                                    <div class="biz-dash-kpi-label">Amount Paid</div>
                                    <div class="biz-dash-kpi-value">${formatMoney(totalPOPaid)}</div>
                                </div>
                            </div>
                            <div class="biz-dash-donut">
                                <canvas id="${poChartId}" width="140" height="140"></canvas>
                            </div>
                            <div class="biz-dash-kpi-grid">
                                <div class="biz-dash-kpi">
                                    <div class="biz-dash-kpi-label">POs Received</div>
                                    <div class="biz-dash-kpi-value">${receivedPOCount}</div>
                                </div>
                                <div class="biz-dash-kpi">
                                    <div class="biz-dash-kpi-label">POs Pending</div>
                                    <div class="biz-dash-kpi-value" style="${pendingPOCount > 0 ? 'color: #fde047;' : ''}">${pendingPOCount}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Operating Expenses Summary -->
                        <div class="biz-dash-card">
                            <div class="biz-dash-card-title">
                                <span class="icon" style="background: #9333ea;"></span>
                                Operating Expenses
                                ${(expenseData.totalProrated || 0) > 0.01 ? '<span style="font-size: 10px; background: #0891b2; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">PRORATED</span>' : ''}
                            </div>
                            ${expenseData.byCategory && expenseData.byCategory.length > 0 ? `
                                <div style="max-height: 280px; overflow-y: auto;">
                                    ${expenseData.byCategory.sort((a, b) => {
                                        // Sort: expenses first (positive), then reimbursements (shown as negative)
                                        if (a.isReimbursement && !b.isReimbursement) return 1;
                                        if (!a.isReimbursement && b.isReimbursement) return -1;
                                        return b.total - a.total;
                                    }).slice(0, 8).map(cat => {
                                        const isProrated = (cat.totalProrated || 0) > 0.01;
                                        const isReimbursement = cat.isReimbursement === true;
                                        const bgStyle = isReimbursement ? 'background: #f0fdf4;' : (cat.excludeFromProfit ? 'background: #fffbeb;' : (isProrated ? 'background: #f0fdfa;' : ''));
                                        const displayAmount = isReimbursement ? -cat.total : cat.total;
                                        const amountColor = isReimbursement ? '#059669' : (cat.excludeFromProfit ? '#f59e0b' : (isProrated ? '#0891b2' : '#9333ea'));
                                        return `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb; ${bgStyle} margin: 0 -8px; padding-left: 8px; padding-right: 8px;">
                                            <span style="font-size: 13px; color: #374151;">
                                                ${cat.categoryName}
                                                ${isReimbursement ? '<span style="font-size: 9px; background: #059669; color: white; padding: 1px 4px; border-radius: 3px; margin-left: 4px;">CREDIT</span>' : ''}
                                                ${cat.excludeFromProfit ? '<span style="font-size: 9px; background: #f59e0b; color: white; padding: 1px 4px; border-radius: 3px; margin-left: 4px;">TAX</span>' : ''}
                                                ${isProrated && !cat.excludeFromProfit && !isReimbursement ? '<span style="font-size: 9px; background: #0891b2; color: white; padding: 1px 4px; border-radius: 3px; margin-left: 4px;">PRO</span>' : ''}
                                            </span>
                                            <span style="font-weight: 600; color: ${amountColor};">${isReimbursement ? '-' : ''}${formatMoney(cat.total)}</span>
                                        </div>
                                    `}).join('')}
                                </div>
                                ${expenseData.byCategory.length > 8 ? `<div style="text-align: center; padding-top: 10px; color: #6b7280; font-size: 12px;">+ ${expenseData.byCategory.length - 8} more categories</div>` : ''}
                                ${(expenseData.totalReimbursements || 0) > 0 ? `<div style="margin-top: 10px; padding: 8px; background: #f0fdf4; border-radius: 6px; font-size: 11px; color: #166534;"> Credits/Reimbursements: -${formatMoney(expenseData.totalReimbursements)} (reduces expenses)</div>` : ''}
                                ${(expenseData.totalProrated || 0) > 0.01 ? `<div style="margin-top: 10px; padding: 8px; background: #f0fdfa; border-radius: 6px; font-size: 11px; color: #0e7490;"> Fixed expenses prorated for period</div>` : ''}
                                ${totalExcludedFromProfit > 0 ? `<div style="margin-top: 10px; padding: 8px; background: #fffbeb; border-radius: 6px; font-size: 11px; color: #92400e;">Tax-only: ${formatMoney(totalExcludedFromProfit)} (not in Net Profit)</div>` : ''}
                            ` : `
                                <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                                    <div style="font-size: 32px; margin-bottom: 10px;"></div>
                                    <p style="margin: 0;">No expenses recorded for this period</p>
                                    <p style="margin: 5px 0 0; font-size: 12px;">Add expenses in the Expenses tab</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
                
                <scr` + `ipt>
                    setTimeout(() => {
                        // Sales Trend Chart
                        const salesCtx = document.getElementById('${salesChartId}');
                        if (salesCtx) {
                            if(Chart.getChart(salesCtx)) Chart.getChart(salesCtx).destroy();
                            new Chart(salesCtx, {
                                type: 'line',
                                data: {
                                    labels: [${monthLabels.map(l => `'${l}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Revenue',
                                        data: [${revenueData.join(', ')}],
                                        borderColor: '${themeColor}',
                                        backgroundColor: '${themeColor}22',
                                        borderWidth: 3,
                                        fill: true,
                                        tension: 0.4,
                                        pointRadius: 4,
                                        pointBackgroundColor: '${themeColor}'
                                    }, {
                                        label: 'Profit',
                                        data: [${profitData.join(', ')}],
                                        borderColor: '#10b981',
                                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                        borderWidth: 2,
                                        fill: true,
                                        tension: 0.4,
                                        pointRadius: 3,
                                        pointBackgroundColor: '#10b981'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    animation: false,
                                    plugins: {
                                        legend: { 
                                            display: true, 
                                            position: 'top',
                                            labels: { color: '#374151', font: { size: 11 }, usePointStyle: true, padding: 15 }
                                        },
                                        datalabels: { display: false }
                                    },
                                    scales: {
                                        x: { 
                                            ticks: { color: '#6b7280', font: { size: 10 } },
                                            grid: { color: '#e5e7eb' }
                                        },
                                        y: { 
                                            ticks: { 
                                                color: '#6b7280', 
                                                font: { size: 10 },
                                                callback: (val) => '$' + (val >= 1000 ? (val/1000).toFixed(0) + 'k' : val.toFixed(0))
                                            },
                                            grid: { color: '#e5e7eb' }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // PO Donut Chart
                        const poCtx = document.getElementById('${poChartId}');
                        if (poCtx) {
                            if(Chart.getChart(poCtx)) Chart.getChart(poCtx).destroy();
                            new Chart(poCtx, {
                                type: 'doughnut',
                                data: {
                                    labels: ['Paid', 'Outstanding'],
                                    datasets: [{
                                        data: [${totalPOPaid.toFixed(2)}, ${totalPOOutstanding.toFixed(2)}],
                                        backgroundColor: ['#6b9a8d', '#e5e7eb'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false,
                                    animation: false,
                                    cutout: '60%',
                                    plugins: {
                                        legend: { 
                                            display: true, 
                                            position: 'bottom',
                                            labels: { color: '#374151', font: { size: 10 }, padding: 10 }
                                        },
                                        datalabels: {
                                            display: true,
                                            color: '#1f2937',
                                            font: { weight: 'bold', size: 11 },
                                            formatter: (value, ctx) => {
                                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                                const pct = total > 0 ? Math.round((value / total) * 100) : 0;
                                                return pct > 5 ? pct + '%' : '';
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        // ==================== PRODUCT PERFORMANCE DASHBOARD ====================
        
        async function generateProductDashboardModal() {
            const topN = reportFilters.topN || 10;
            const itemFilter = reportFilters.item || '';
            const supplierFilter = reportFilters.supplier || '';
            const fromDate = reportFilters.fromDate ? parseLocalDate(reportFilters.fromDate) : null;
            let toDate = reportFilters.toDate ? parseLocalDate(reportFilters.toDate) : null;
            if (toDate) toDate.setHours(23, 59, 59, 999);
            if (fromDate) fromDate.setHours(0, 0, 0, 0);
            
            await loadReportData();
            
            const items = cachedItems;
            const customers = cachedCustomers;
            const suppliers = cachedSuppliers;
            let sales = cachedSalesOrders.filter(so => so.Status !== 'Voided');
            
            if (!items.length) {
                throw new Error('Failed to load data');
            }
            
            // Get theme color
            const themeColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#3b82f6';
            
            // Date label
            let dateLabel = 'All Time';
            if (fromDate && toDate) {
                dateLabel = `${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`;
            } else if (fromDate) {
                dateLabel = `Since ${fromDate.toLocaleDateString()}`;
            } else if (toDate) {
                dateLabel = `Through ${toDate.toLocaleDateString()}`;
            }
            
            // Gather sales data
            const productStats = {};
            const customerStats = {};
            const supplierStats = {};
            const cityStats = {};
            const monthlySales = {};
            let totalOrders = 0;
            
            for (const so of sales) {
                const soDate = parseDate(so.Sale_Date || so.SO_Date);
                if (fromDate && (!soDate || soDate < fromDate)) continue;
                if (toDate && (!soDate || soDate > toDate)) continue;
                
                const monthKey = soDate ? `${soDate.getFullYear()}-${String(soDate.getMonth() + 1).padStart(2, '0')}` : 'Unknown';
                
                // Get customer info
                const cust = customers.find(c => c.Customer_ID === so.Customer_ID);
                const cityKey = cust ? `${cust.City || 'Unknown'}|${cust.State || ''}` : 'Unknown|';
                
                const lines = getSalesLinesFromCache(so.SO_ID);
                let orderRevenue = 0;
                let orderHasMatchingItems = false;
                
                lines.forEach(line => {
                    const itemId = line.Item_ID;
                    const item = items.find(i => i.Item_ID === itemId);
                    const supplierId = item?.Supplier_ID || 'unknown';
                    
                    // Apply filters
                    if (itemFilter && itemId !== itemFilter) return;
                    if (supplierFilter && !matchesFilter(supplierId, supplierFilter)) return;
                    
                    orderHasMatchingItems = true;
                    const qty = parseInt(line.Quantity) || 0;
                    const unitPrice = parseFloat(line.Unit_Price) || 0;
                    const revenue = qty * unitPrice;
                    orderRevenue += revenue;
                    
                    // Use stored Unit_Cost if available, fall back to current item cost
                    let unitCost;
                    const storedUnitCost = parseFloat(line.Unit_Cost);
                    if (!isNaN(storedUnitCost) && storedUnitCost > 0) {
                        unitCost = storedUnitCost;
                    } else {
                        const unitsPerPkg = parseFloat(item?.Units_Per_Package) || 1;
                        const pkgCost = parseFloat(item?.Package_Cost) || 0;
                        unitCost = pkgCost / unitsPerPkg;
                    }
                    
                    const supplier = suppliers.find(s => s.Supplier_ID === supplierId);
                    
                    if (!productStats[itemId]) {
                        productStats[itemId] = {
                            name: item?.Item_Description || itemId,
                            sku: item?.SKU || '-',
                            supplier: supplier?.Supplier_Name || 'Unknown',
                            unitCost: unitCost,
                            qtySold: 0,
                            revenue: 0,
                            cost: 0
                        };
                    }
                    
                    productStats[itemId].qtySold += qty;
                    productStats[itemId].revenue += revenue;
                    productStats[itemId].cost += qty * unitCost;  // Use line's unitCost, not average
                    
                    // Supplier tracking
                    if (!supplierStats[supplierId]) {
                        supplierStats[supplierId] = {
                            name: supplier?.Supplier_Name || 'Unknown',
                            revenue: 0,
                            units: 0,
                            products: new Set()
                        };
                    }
                    supplierStats[supplierId].revenue += revenue;
                    supplierStats[supplierId].units += qty;
                    supplierStats[supplierId].products.add(itemId);
                    
                    // Monthly tracking
                    if (!monthlySales[monthKey]) {
                        monthlySales[monthKey] = { revenue: 0, units: 0, orders: 0 };
                    }
                    monthlySales[monthKey].revenue += revenue;
                    monthlySales[monthKey].units += qty;
                });
                
                // Only count order and track customer/city if there were matching items
                if (orderHasMatchingItems) {
                    totalOrders++;
                    if (monthlySales[monthKey]) monthlySales[monthKey].orders++;
                    
                    // Customer tracking
                    if (!customerStats[so.Customer_ID]) {
                        customerStats[so.Customer_ID] = {
                            name: cust?.Customer_Name || 'Unknown',
                            location: cust ? `${cust.City || ''}, ${cust.State || ''}`.replace(', ,', ',').replace(/^, |, $/g, '') : '',
                            revenue: 0,
                            orders: 0
                        };
                    }
                    customerStats[so.Customer_ID].orders++;
                    customerStats[so.Customer_ID].revenue += orderRevenue;
                    
                    // City tracking
                    if (!cityStats[cityKey]) {
                        cityStats[cityKey] = {
                            city: cust?.City || 'Unknown',
                            state: cust?.State || '',
                            revenue: 0,
                            orders: 0,
                            customers: new Set()
                        };
                    }
                    cityStats[cityKey].orders++;
                    cityStats[cityKey].customers.add(so.Customer_ID);
                    cityStats[cityKey].revenue += orderRevenue;
                }
            }
            
            // Calculate totals
            const allProducts = Object.values(productStats);
            allProducts.forEach(p => {
                p.profit = p.revenue - p.cost;
                p.margin = p.revenue > 0 ? (p.profit / p.revenue) * 100 : 0;
            });
            
            const totalRevenue = allProducts.reduce((sum, p) => sum + p.revenue, 0);
            const totalCost = allProducts.reduce((sum, p) => sum + p.cost, 0);
            const totalProfit = totalRevenue - totalCost;
            const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
            const totalUnitsSold = allProducts.reduce((sum, p) => sum + p.qtySold, 0);
            const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
            
            // Top sellers (25 for detail table, 10 for bar chart)
            const topSellersAll = [...allProducts].sort((a, b) => b.revenue - a.revenue).slice(0, 25);
            const topSellers = topSellersAll.slice(0, 10);
            const topCustomers = Object.values(customerStats).sort((a, b) => b.revenue - a.revenue).slice(0, 10);
            const topSuppliers = Object.values(supplierStats)
                .map(s => ({ ...s, productCount: s.products.size }))
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 10);
            const topCities = Object.values(cityStats)
                .map(c => ({ ...c, customerCount: c.customers.size }))
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 10);
            
            // Calculate max values for bar charts
            const maxProductUnits = Math.max(...topSellers.map(p => p.qtySold), 1);
            const maxCustomerOrders = Math.max(...topCustomers.map(c => c.orders), 1);
            const maxSupplierUnits = Math.max(...topSuppliers.map(s => s.units), 1);
            const maxCityOrders = Math.max(...topCities.map(c => c.orders), 1);
            
            // Unique counts
            const uniqueCustomers = Object.keys(customerStats).length;
            const uniqueSuppliers = Object.keys(supplierStats).length;
            const uniqueCities = Object.keys(cityStats).length;
            
            // Bar colors
            const barColors = ['#6b9a8d', '#7a9bb8', '#b8a86b', '#b88a8a', '#9a8ab8', '#b89aaa', '#7aaab8', '#9ab88a', '#b8a07a', '#8a8ab0'];
            
            // Monthly data for chart
            const sortedMonths = Object.entries(monthlySales).sort((a, b) => a[0].localeCompare(b[0])).slice(-12);
            const monthLabels = sortedMonths.map(([m]) => {
                const [year, month] = m.split('-');
                return new Date(year, parseInt(month) - 1).toLocaleDateString('en-US', { month: 'short' });
            });
            const revenueData = sortedMonths.map(([, d]) => d.revenue.toFixed(2));
            
            // Chart IDs
            const salesChartId = 'salesDashChart_' + Date.now();
            const topProductsChartId = 'topProductsChart_' + Date.now();
            const topCustomersChartId = 'topCustomersChart_' + Date.now();
            
            let html = `
                <style>
                    .sales-dash {
                        background: white;
                        border-radius: 16px;
                        padding: 25px;
                        color: #1f2937;
                        border: 2px solid #e0e0e0;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    }
                    .sales-dash-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 25px;
                        padding-bottom: 20px;
                        border-bottom: 2px solid #e5e7eb;
                        flex-wrap: wrap;
                        gap: 15px;
                    }
                    .sales-dash-header h2 {
                        margin: 0;
                        font-size: 28px;
                        font-weight: 700;
                        color: ${themeColor};
                    }
                    .sales-dash-header p {
                        margin: 5px 0 0 0;
                        color: #6b7280;
                        font-size: 14px;
                    }
                    .sales-dash-badge {
                        background: ${themeColor};
                        color: white;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 500;
                        flex-shrink: 0;
                    }
                    .sales-dash-stats {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    .sales-dash-stat {
                        background: #f8fafc;
                        border-radius: 12px;
                        padding: 20px;
                        text-align: center;
                        border: 1px solid #e2e8f0;
                        min-width: 0;
                        overflow: hidden;
                    }
                    .sales-dash-stat-label {
                        font-size: 11px;
                        color: #6b7280;
                        text-transform: uppercase;
                        margin-bottom: 8px;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .sales-dash-stat-value {
                        font-size: 24px;
                        font-weight: 700;
                        color: #1f2937;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .sales-dash-stat-sub {
                        font-size: 12px;
                        color: #6b7280;
                        margin-top: 4px;
                    }
                    .sales-dash-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                        gap: 20px;
                        margin-bottom: 20px;
                    }
                    .sales-dash-card {
                        background: #f8fafc;
                        border-radius: 12px;
                        padding: 20px;
                        border: 1px solid #e2e8f0;
                        min-width: 0;
                        overflow: hidden;
                    }
                    .sales-dash-card-title {
                        font-size: 16px;
                        font-weight: 600;
                        margin-bottom: 15px;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        color: #1e3a5f;
                    }
                    .sales-dash-card-title .icon {
                        background: ${themeColor};
                        color: white;
                        width: 32px;
                        height: 32px;
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 16px;
                        flex-shrink: 0;
                    }
                    .sales-dash-chart {
                        height: 220px;
                    }
                    .sales-dash-row2 {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                        gap: 20px;
                    }
                    .sales-dash-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 13px;
                        table-layout: fixed;
                    }
                    .sales-dash-table th {
                        text-align: left;
                        padding: 10px 6px;
                        border-bottom: 2px solid #e5e7eb;
                        color: #6b7280;
                        font-weight: 600;
                        font-size: 11px;
                        text-transform: uppercase;
                    }
                    .sales-dash-table td {
                        padding: 10px 6px;
                        border-bottom: 1px solid #f3f4f6;
                        vertical-align: top;
                    }
                    .sales-dash-table tr:last-child td {
                        border-bottom: none;
                    }
                    /* Horizontal Bar Chart Styles */
                    .sales-dash-bar-list {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                        width: 100%;
                        overflow: hidden;
                    }
                    .sales-dash-bar-item {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        width: 100%;
                        min-width: 0;
                    }
                    .sales-dash-bar-label {
                        display: flex;
                        align-items: flex-start;
                        gap: 4px;
                        width: 110px;
                        flex-shrink: 0;
                        overflow: hidden;
                    }
                    .sales-dash-bar-rank {
                        font-weight: 600;
                        color: #6b7280;
                        font-size: 13px;
                        min-width: 18px;
                        flex-shrink: 0;
                    }
                    .sales-dash-bar-name {
                        flex: 1;
                        min-width: 0;
                        overflow: hidden;
                    }
                    .sales-dash-bar-title {
                        font-weight: 600;
                        font-size: 12px;
                        color: #1f2937;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }
                    .sales-dash-bar-sub {
                        font-size: 10px;
                        color: #9ca3af;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }
                    .sales-dash-bar-track {
                        flex: 1;
                        height: 22px;
                        background: #f3f4f6;
                        border-radius: 12px;
                        overflow: hidden;
                        min-width: 50px;
                    }
                    .sales-dash-bar-fill {
                        height: 100%;
                        border-radius: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: flex-end;
                        padding-right: 6px;
                        min-width: 30px;
                        transition: width 0.3s ease;
                    }
                    .sales-dash-bar-badge {
                        font-size: 10px;
                        font-weight: 600;
                        color: white;
                        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
                    }
                    .sales-dash-bar-value {
                        font-weight: 600;
                        font-size: 12px;
                        color: #1f2937;
                        width: 65px;
                        text-align: right;
                        white-space: nowrap;
                        flex-shrink: 0;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    /* Quick Stats Styles */
                    .sales-dash-quick-stats {
                        display: flex;
                        flex-direction: column;
                        gap: 0;
                    }
                    .sales-dash-quick-stat {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 0;
                        border-bottom: 1px solid #e5e7eb;
                    }
                    .sales-dash-quick-stat:last-child {
                        border-bottom: none;
                    }
                    .sales-dash-quick-label {
                        font-size: 14px;
                        color: #4b5563;
                    }
                    .sales-dash-quick-value {
                        font-size: 16px;
                        font-weight: 600;
                        color: #1f2937;
                    }
                    .sales-dash-table th:first-child,
                    .sales-dash-table td:first-child {
                        width: 15%;
                    }
                    .sales-dash-table th:nth-child(2),
                    .sales-dash-table td:nth-child(2) {
                        width: 55%;
                        overflow: hidden;
                    }
                    .sales-dash-table td:nth-child(2) > div {
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }
                    .sales-dash-table th:last-child,
                    .sales-dash-table td:last-child {
                        width: 30%;
                        text-align: right;
                    }
                    @media print {
                        .sales-dash { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    }
                </style>
                
                <div class="sales-dash">
                    <div class="sales-dash-header">
                        <div>
                            <h2> Product Performance Dashboard</h2>
                            <p>Product Sales and Customer Analysis</p>
                        </div>
                        <div class="sales-dash-badge">${dateLabel}</div>
                    </div>
                    
                    <!-- Top Stats Row -->
                    <div class="sales-dash-stats">
                        <div class="sales-dash-stat">
                            <div class="sales-dash-stat-label"> Units Sold</div>
                            <div class="sales-dash-stat-value" style="color: #7a9bb8;">${totalUnitsSold.toLocaleString()}</div>
                        </div>
                        <div class="sales-dash-stat">
                            <div class="sales-dash-stat-label"> Orders</div>
                            <div class="sales-dash-stat-value" style="color: #9a8ab8;">${totalOrders.toLocaleString()}</div>
                        </div>
                        <div class="sales-dash-stat">
                            <div class="sales-dash-stat-label"> Sales</div>
                            <div class="sales-dash-stat-value" style="color: ${themeColor};">${formatMoney(totalRevenue)}</div>
                        </div>
                        <div class="sales-dash-stat">
                            <div class="sales-dash-stat-label"> Cost</div>
                            <div class="sales-dash-stat-value" style="color: #b8a86b;">${formatMoney(totalCost)}</div>
                        </div>
                        <div class="sales-dash-stat">
                            <div class="sales-dash-stat-label"> Profit</div>
                            <div class="sales-dash-stat-value" style="color: ${totalProfit >= 0 ? '#6b9a8d' : '#b88a8a'};">${formatMoney(totalProfit)}</div>
                        </div>
                        <div class="sales-dash-stat">
                            <div class="sales-dash-stat-label"> Margin</div>
                            <div class="sales-dash-stat-value" style="color: ${avgMargin >= 30 ? '#6b9a8d' : avgMargin >= 15 ? '#b8a86b' : '#b88a8a'};">${avgMargin.toFixed(1)}%</div>
                        </div>
                    </div>
                    
                    <!-- Top 10 Products + Top 10 Customers -->
                    <div class="sales-dash-grid" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); margin-bottom: 20px;">
                        <!-- Top 10 Products -->
                        <div class="sales-dash-card">
                            <div class="sales-dash-card-title">
                                <span class="icon"></span>
                                Top 10 Products
                            </div>
                            ${topSellers.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No sales in this period</p>' : `
                            <div class="sales-dash-bar-list">
                                ${topSellers.map((p, i) => `
                                    <div class="sales-dash-bar-item">
                                        <div class="sales-dash-bar-label">
                                            <span class="sales-dash-bar-rank">${i + 1}.</span>
                                            <div class="sales-dash-bar-name">
                                                <div class="sales-dash-bar-title">${p.name}</div>
                                                <div class="sales-dash-bar-sub">${p.qtySold} units  ${p.supplier}</div>
                                            </div>
                                        </div>
                                        <div class="sales-dash-bar-track">
                                            <div class="sales-dash-bar-fill" style="width: ${(p.qtySold / maxProductUnits * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]};">
                                                <span class="sales-dash-bar-badge">${p.qtySold}</span>
                                            </div>
                                        </div>
                                        <div class="sales-dash-bar-value">${formatMoney(p.revenue)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            `}
                        </div>
                        
                        <!-- Top 10 Customers -->
                        <div class="sales-dash-card">
                            <div class="sales-dash-card-title">
                                <span class="icon"></span>
                                Top 10 Customers
                            </div>
                            ${topCustomers.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No sales in this period</p>' : `
                            <div class="sales-dash-bar-list">
                                ${topCustomers.map((c, i) => `
                                    <div class="sales-dash-bar-item">
                                        <div class="sales-dash-bar-label">
                                            <span class="sales-dash-bar-rank">${i + 1}.</span>
                                            <div class="sales-dash-bar-name">
                                                <div class="sales-dash-bar-title">${c.name}</div>
                                                <div class="sales-dash-bar-sub">${c.location || ''}</div>
                                            </div>
                                        </div>
                                        <div class="sales-dash-bar-track">
                                            <div class="sales-dash-bar-fill" style="width: ${(c.orders / maxCustomerOrders * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]};">
                                                <span class="sales-dash-bar-badge">${c.orders}</span>
                                            </div>
                                        </div>
                                        <div class="sales-dash-bar-value">${formatMoney(c.revenue)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Top 10 Suppliers + Quick Stats -->
                    <div class="sales-dash-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); margin-bottom: 20px;">
                        <!-- Top 10 Suppliers -->
                        <div class="sales-dash-card">
                            <div class="sales-dash-card-title">
                                <span class="icon"></span>
                                Top 10 Suppliers
                            </div>
                            ${topSuppliers.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No sales in this period</p>' : `
                            <div class="sales-dash-bar-list">
                                ${topSuppliers.map((s, i) => `
                                    <div class="sales-dash-bar-item">
                                        <div class="sales-dash-bar-label">
                                            <span class="sales-dash-bar-rank">${i + 1}.</span>
                                            <div class="sales-dash-bar-name">
                                                <div class="sales-dash-bar-title">${s.name}</div>
                                                <div class="sales-dash-bar-sub">${s.productCount} product${s.productCount !== 1 ? 's' : ''}</div>
                                            </div>
                                        </div>
                                        <div class="sales-dash-bar-track">
                                            <div class="sales-dash-bar-fill" style="width: ${(s.units / maxSupplierUnits * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]};">
                                                <span class="sales-dash-bar-badge">${s.units}</span>
                                            </div>
                                        </div>
                                        <div class="sales-dash-bar-value">${formatMoney(s.revenue)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            `}
                        </div>
                        
                        <!-- Top 10 Cities -->
                        <div class="sales-dash-card">
                            <div class="sales-dash-card-title">
                                <span class="icon"></span>
                                Top 10 Cities
                            </div>
                            ${topCities.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No sales in this period</p>' : `
                            <div class="sales-dash-bar-list">
                                ${topCities.map((c, i) => `
                                    <div class="sales-dash-bar-item">
                                        <div class="sales-dash-bar-label">
                                            <span class="sales-dash-bar-rank">${i + 1}.</span>
                                            <div class="sales-dash-bar-name">
                                                <div class="sales-dash-bar-title">${c.city}${c.state ? ', ' + c.state : ''}</div>
                                                <div class="sales-dash-bar-sub">${c.customerCount} customer${c.customerCount !== 1 ? 's' : ''}</div>
                                            </div>
                                        </div>
                                        <div class="sales-dash-bar-track">
                                            <div class="sales-dash-bar-fill" style="width: ${(c.orders / maxCityOrders * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]};">
                                                <span class="sales-dash-bar-badge">${c.orders}</span>
                                            </div>
                                        </div>
                                        <div class="sales-dash-bar-value">${formatMoney(c.revenue)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="sales-dash-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); margin-bottom: 20px;">
                        <!-- Quick Stats -->
                        <div class="sales-dash-card">
                            <div class="sales-dash-card-title">
                                <span class="icon"></span>
                                Quick Stats
                            </div>
                            <div class="sales-dash-quick-stats">
                                <div class="sales-dash-quick-stat">
                                    <span class="sales-dash-quick-label"> Total Revenue</span>
                                    <span class="sales-dash-quick-value">${formatMoney(totalRevenue)}</span>
                                </div>
                                <div class="sales-dash-quick-stat">
                                    <span class="sales-dash-quick-label"> Total Cost</span>
                                    <span class="sales-dash-quick-value">${formatMoney(totalCost)}</span>
                                </div>
                                <div class="sales-dash-quick-stat">
                                    <span class="sales-dash-quick-label"> Gross Profit</span>
                                    <span class="sales-dash-quick-value" style="color: #6b9a8d;">${formatMoney(totalProfit)}</span>
                                </div>
                                <div class="sales-dash-quick-stat">
                                    <span class="sales-dash-quick-label"> Profit Margin</span>
                                    <span class="sales-dash-quick-value">${avgMargin.toFixed(1)}%</span>
                                </div>
                                <div class="sales-dash-quick-stat">
                                    <span class="sales-dash-quick-label"> Total Orders</span>
                                    <span class="sales-dash-quick-value">${totalOrders.toLocaleString()}</span>
                                </div>
                                <div class="sales-dash-quick-stat">
                                    <span class="sales-dash-quick-label"> Avg Order Value</span>
                                    <span class="sales-dash-quick-value">${formatMoney(avgOrderValue)}</span>
                                </div>
                                <div class="sales-dash-quick-stat">
                                    <span class="sales-dash-quick-label"> Active Customers</span>
                                    <span class="sales-dash-quick-value">${uniqueCustomers}</span>
                                </div>
                                <div class="sales-dash-quick-stat">
                                    <span class="sales-dash-quick-label"> Active Suppliers</span>
                                    <span class="sales-dash-quick-value">${uniqueSuppliers}</span>
                                </div>
                                <div class="sales-dash-quick-stat">
                                    <span class="sales-dash-quick-label"> Active Cities</span>
                                    <span class="sales-dash-quick-value">${uniqueCities}</span>
                                </div>
                                <div class="sales-dash-quick-stat">
                                    <span class="sales-dash-quick-label"> Products Sold</span>
                                    <span class="sales-dash-quick-value">${allProducts.length}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Product Table -->
                    <div class="sales-dash-card">
                        <div class="sales-dash-card-title">
                            <span class="icon"></span>
                            Product Performance Details (Top 25)
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="sales-dash-table" style="table-layout: auto;">
                                <thead>
                                    <tr>
                                        <th style="width: 30px;">#</th>
                                        <th>Product</th>
                                        <th>Supplier</th>
                                        <th style="text-align: right;">Units</th>
                                        <th style="text-align: right;">Revenue</th>
                                        <th style="text-align: right;">Profit</th>
                                        <th style="text-align: right;">Margin</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topSellersAll.map((p, i) => `
                                        <tr>
                                            <td><strong>${i + 1}</strong></td>
                                            <td>
                                                <div style="font-weight: 600;">${p.name}</div>
                                                <div style="font-size: 11px; color: #6b7280;">${p.sku}</div>
                                            </td>
                                            <td style="color: #6b7280;">${p.supplier}</td>
                                            <td style="text-align: right;">${p.qtySold.toLocaleString()}</td>
                                            <td style="text-align: right; font-weight: 600;">${formatMoney(p.revenue)}</td>
                                            <td style="text-align: right; color: ${p.profit >= 0 ? '#6b9a8d' : '#b88a8a'};">${formatMoney(p.profit)}</td>
                                            <td style="text-align: right;">
                                                <span style="background: ${p.margin >= 30 ? '#e0ebe7' : p.margin >= 15 ? '#f0e8d0' : '#f0e0e0'}; color: ${p.margin >= 30 ? '#4a6b5f' : p.margin >= 15 ? '#7a6b40' : '#8a5a5a'}; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">${p.margin.toFixed(1)}%</span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // ==================== CUSTOMER PRESENTATION DASHBOARD ====================
        
        async function generateCustomerDashboardModal() {
            const customerId = reportFilters.customer;
            const fromDate = reportFilters.fromDate ? parseLocalDate(reportFilters.fromDate) : null;
            let toDate = reportFilters.toDate ? parseLocalDate(reportFilters.toDate) : null;
            if (toDate) toDate.setHours(23, 59, 59, 999);
            
            // Load all report data (uses cache if available)
            await loadReportData();
            
            const items = cachedItems;
            const suppliers = cachedSuppliers;
            const customers = cachedCustomers;
            
            if (!cachedSalesOrders.length || !items.length || !customers.length) {
                throw new Error('Failed to load data');
            }
            
            // Handle single vs multi-customer selection
            let customerName = 'Customer';
            if (customerId && !customerId.includes(',')) {
                const customer = customers.find(c => c.Customer_ID === customerId);
                customerName = customer?.Customer_Name || 'Customer';
            } else if (customerId && customerId.includes(',')) {
                const count = customerId.split(',').length;
                customerName = `${count} Customers Selected`;
            } else {
                customerName = 'All Customers';
            }
            
            // Get all sales - use matchesFilter for multi-select support
            let allCustomerSales = [...cachedSalesOrders];
            if (customerId) {
                allCustomerSales = cachedSalesOrders.filter(s => matchesFilter(s.Customer_ID, customerId));
            }
            
            // Apply date filter if provided
            let filteredSales = allCustomerSales;
            if (fromDate) {
                fromDate.setHours(0, 0, 0, 0);
                filteredSales = filteredSales.filter(s => {
                    const d = parseDate(s.Sale_Date || s.SO_Date);
                    return d && d >= fromDate;
                });
            }
            if (toDate) {
                filteredSales = filteredSales.filter(s => {
                    const d = parseDate(s.Sale_Date || s.SO_Date);
                    return d && d <= toDate;
                });
            }
            
            // Calculate time period stats (regardless of date filter)
            const now = new Date();
            const periods = {
                '1 MONTH': { start: new Date(now.getFullYear(), now.getMonth() - 1, now.getDate()), sales: 0, orders: 0 },
                '3 MONTH': { start: new Date(now.getFullYear(), now.getMonth() - 3, now.getDate()), sales: 0, orders: 0 },
                'YTD': { start: new Date(now.getFullYear(), 0, 1), sales: 0, orders: 0 },
                '1 YEAR': { start: new Date(now.getFullYear() - 1, now.getMonth(), now.getDate()), sales: 0, orders: 0 },
                '3 YEAR': { start: new Date(now.getFullYear() - 3, now.getMonth(), now.getDate()), sales: 0, orders: 0 },
                'ALL TIME': { start: new Date(2000, 0, 1), sales: 0, orders: 0 }
            };
            
            allCustomerSales.forEach(s => {
                const saleDate = parseDate(s.Sale_Date || s.SO_Date);
                const amount = parseFloat(s.Total_Amount) || 0;
                if (saleDate) {
                    Object.keys(periods).forEach(key => {
                        if (saleDate >= periods[key].start) {
                            periods[key].sales += amount;
                            periods[key].orders++;
                        }
                    });
                }
            });
            
            // Get product breakdown for filtered period
            const productSales = {};
            let totalQty = 0, totalSales = 0, totalOrders = filteredSales.length;
            
            for (const so of filteredSales) {
                totalSales += parseFloat(so.Total_Amount) || 0;
                
                const lines = getSalesLinesFromCache(so.SO_ID);
                if (lines.length > 0) {
                    lines.forEach(line => {
                        const qty = parseInt(line.Quantity) || 0;
                        totalQty += qty;
                        
                        // Calculate line total (Line_Total may not exist in data)
                        const unitPrice = parseFloat(line.Unit_Price) || 0;
                        const lineTotal = qty * unitPrice;
                        
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const suppId = item?.Supplier_ID;
                        const supp = suppliers.find(s => s.Supplier_ID === suppId);
                        const itemId = line.Item_ID;
                        if (!productSales[itemId]) {
                            productSales[itemId] = {
                                name: item?.Item_Description || itemId,
                                sku: item?.SKU || '-',
                                supplierName: supp?.Supplier_Name || 'Unknown',
                                qty: 0,
                                sales: 0
                            };
                        }
                        productSales[itemId].qty += qty;
                        productSales[itemId].sales += lineTotal;
                    });
                }
            }
            
            const topProducts = Object.values(productSales).sort((a, b) => b.sales - a.sales).slice(0, 5);
            const avgOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;
            
            // Period colors matching the reference image
            const periodColors = ['#2196F3', '#9C27B0', '#FF9800', '#b88a8a', '#4CAF50', '#607D8B'];
            
            // Date range label
            let dateLabel = 'All Time';
            if (fromDate && toDate) {
                dateLabel = `${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`;
            } else if (fromDate) {
                dateLabel = `Since ${fromDate.toLocaleDateString()}`;
            } else if (toDate) {
                dateLabel = `Through ${toDate.toLocaleDateString()}`;
            }
            
            let html = `
                <style>
                    .pres-header {
                        padding: 35px;
                        background: linear-gradient(135deg, #2e7d32 0%, #6b9a8d 100%);
                        color: white;
                        border-radius: 16px;
                        margin-bottom: 30px;
                        box-shadow: 0 10px 30px rgba(46, 125, 50, 0.3), 0 4px 12px rgba(0,0,0,0.1);
                        border: 2px solid rgba(255, 255, 255, 0.1);
                    }
                    .pres-header h2 {
                        margin: 0 0 10px 0;
                        font-size: 32px;
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    }
                    .pres-header p {
                        margin: 0;
                        font-size: 16px;
                        opacity: 0.95;
                    }
                    .period-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                        gap: 12px;
                        margin-bottom: 25px;
                    }
                    .period-card {
                        background: white;
                        border-radius: 10px;
                        padding: 15px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        border-left: 4px solid #2e7d32;
                        transition: transform 0.2s;
                    }
                    .period-card:hover {
                        transform: translateY(-3px);
                        box-shadow: 0 4px 15px rgba(0,0,0,0.12);
                    }
                    .period-label {
                        font-size: 11px;
                        font-weight: 600;
                        text-transform: uppercase;
                        margin-bottom: 8px;
                    }
                    .period-value {
                        font-size: 26px;
                        font-weight: bold;
                        color: #333;
                    }
                    .period-sub {
                        font-size: 11px;
                        color: #888;
                        margin-top: 4px;
                    }
                    .section-title {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        margin: 25px 0 15px 0;
                        padding-bottom: 10px;
                        border-bottom: 2px solid #e0e0e0;
                    }
                    .section-title h3 {
                        margin: 0;
                        color: #333;
                    }
                    .summary-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    .summary-card {
                        background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
                        border-radius: 10px;
                        padding: 20px;
                        text-align: center;
                    }
                    .summary-card .label {
                        font-size: 12px;
                        color: #666;
                        text-transform: uppercase;
                    }
                    .summary-card .value {
                        font-size: 32px;
                        font-weight: bold;
                        color: #2e7d32;
                        margin: 5px 0;
                    }
                    .product-row {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 15px;
                        background: white;
                        border-radius: 8px;
                        margin-bottom: 8px;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                    }
                    .product-rank {
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 14px;
                        margin-right: 15px;
                        color: white;
                    }
                    .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); }
                    .rank-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
                    .rank-3 { background: linear-gradient(135deg, #CD7F32, #8B4513); }
                    .rank-other { background: #a8a8a8; }
                </style>
                
                <div class="pres-header">
                    <h2> ${customerName}</h2>
                    <p>Sales Performance Report</p>
                </div>
                
                <div class="section-title">
                    <span style="font-size: 20px;"></span>
                    <h3>Sales by Time Period</h3>
                </div>
                <p style="color: #666; margin: -10px 0 15px 0; font-size: 13px;">Click any tile to see detailed breakdown</p>
                
                <div class="period-grid">
                    ${Object.entries(periods).map(([label, data], i) => `
                        <div class="period-card" style="border-color: ${periodColors[i]};">
                            <div class="period-label" style="color: ${periodColors[i]};">${label}</div>
                            <div class="period-value">$${data.sales.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div class="period-sub">${data.orders} order${data.orders !== 1 ? 's' : ''}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="section-title">
                    <span style="font-size: 20px;"></span>
                    <h3>Selected Period Summary</h3>
                    <span style="color: #666; font-size: 13px; margin-left: auto;">${dateLabel}</span>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="label">Total Sales</div>
                        <div class="value">${formatMoney(totalSales)}</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">Orders</div>
                        <div class="value" style="color: #1565c0;">${totalOrders}</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">Units Purchased</div>
                        <div class="value" style="color: #7b1fa2;">${totalQty.toLocaleString()}</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">Avg Order Value</div>
                        <div class="value" style="color: #e65100;">${formatMoney(avgOrderValue)}</div>
                    </div>
                </div>
                
                <div class="section-title">
                    <span style="font-size: 20px;"></span>
                    <h3>Top Products Purchased</h3>
                </div>
                
                ${topProducts.length === 0 ? '<p style="color: #888; text-align: center; padding: 20px;">No purchases in selected period</p>' : ''}
                ${topProducts.map((p, i) => `
                    <div class="product-row">
                        <div style="display: flex; align-items: center;">
                            <div class="product-rank ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other'}">${i + 1}</div>
                            <div>
                                <div style="font-weight: 600;">${p.name}</div>
                                <div style="font-size: 12px; color: #888;">${p.qty} units  SKU: ${p.sku}</div>
                                <div style="font-size: 11px; color: #aaa;">${p.supplierName || 'Unknown'}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: bold; color: #2e7d32;">${formatMoney(p.sales)}</div>
                        </div>
                    </div>
                `).join('')}
                
                <div class="partnership-box" style="background: linear-gradient(135deg, #2e7d32, #1b5e20); margin-top: 30px; width: 100%; box-sizing: border-box; text-align: center; padding: 25px; border-radius: 12px; color: white;">
                    <h3 style="margin: 0 0 10px 0; font-size: 18px; color: white;"> Total Customer Value</h3>
                    <div style="font-size: 42px; font-weight: bold; color: white;">${formatMoney(totalSales)}</div>
                    <div style="font-size: 14px; opacity: 0.9; margin-top: 8px; color: white;">${totalOrders} sales orders  ${dateLabel}</div>
                </div>
            `;
            
            return html;
        }
        
        // ==================== SUPPLIER PRESENTATION DASHBOARD ====================
        
        async function generateSupplierDashboardModal() {
            const supplierId = reportFilters.supplier;
            const fromDate = reportFilters.fromDate ? parseLocalDate(reportFilters.fromDate) : null;
            let toDate = reportFilters.toDate ? parseLocalDate(reportFilters.toDate) : null;
            if (toDate) toDate.setHours(23, 59, 59, 999);
            if (fromDate) fromDate.setHours(0, 0, 0, 0);
            
            await loadReportData();
            
            const items = cachedItems;
            const suppliers = cachedSuppliers;
            const customers = cachedCustomers;
            const purchases = cachedPurchaseOrders;
            const sales = cachedSalesOrders.filter(so => so.Status !== 'Voided');
            
            if (!items.length || !suppliers.length) {
                throw new Error('Failed to load data');
            }
            
            // Get theme color
            const themeColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#1565c0';
            
            // Date label
            let dateLabel = 'All Time';
            if (fromDate && toDate) {
                dateLabel = `${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`;
            } else if (fromDate) {
                dateLabel = `Since ${fromDate.toLocaleDateString()}`;
            } else if (toDate) {
                dateLabel = `Through ${toDate.toLocaleDateString()}`;
            }
            
            // Filter POs by date and supplier
            let filteredPOs = purchases.filter(p => {
                if (supplierId && !matchesFilter(p.Supplier_ID, supplierId)) return false;
                const poDate = parseDate(p.PO_Date);
                if (fromDate && (!poDate || poDate < fromDate)) return false;
                if (toDate && (!poDate || poDate > toDate)) return false;
                return true;
            });
            
            // Build supplier stats from purchases
            const supplierStats = {};
            const monthlyPurchases = {};
            const productPurchases = {};
            
            for (const po of filteredPOs) {
                const supId = po.Supplier_ID;
                const poDate = parseDate(po.PO_Date);
                const monthKey = poDate ? `${poDate.getFullYear()}-${String(poDate.getMonth() + 1).padStart(2, '0')}` : 'Unknown';
                
                if (!supplierStats[supId]) {
                    const sup = suppliers.find(s => s.Supplier_ID === supId);
                    supplierStats[supId] = {
                        name: sup?.Supplier_Name || 'Unknown',
                        city: sup?.City || '',
                        state: sup?.State || '',
                        orders: 0,
                        totalSpent: 0,
                        totalPaid: 0,
                        products: new Set(),
                        units: 0
                    };
                }
                
                supplierStats[supId].orders++;
                supplierStats[supId].totalSpent += parseFloat(po.Total_Amount) || 0;
                supplierStats[supId].totalPaid += parseFloat(po.Amount_Paid) || 0;
                
                // Monthly tracking
                if (!monthlyPurchases[monthKey]) {
                    monthlyPurchases[monthKey] = { spent: 0, orders: 0 };
                }
                monthlyPurchases[monthKey].spent += parseFloat(po.Total_Amount) || 0;
                monthlyPurchases[monthKey].orders++;
                
                // Product tracking from purchase lines
                const lines = getPurchaseLinesFromCache(po.PO_ID);
                lines.forEach(line => {
                    const itemId = line.Item_ID;
                    const qty = parseInt(line.Quantity) || 0;
                    const cost = qty * (parseFloat(line.Unit_Cost) || 0);
                    
                    supplierStats[supId].products.add(itemId);
                    supplierStats[supId].units += qty;
                    
                    if (!productPurchases[itemId]) {
                        const item = items.find(i => i.Item_ID === itemId);
                        productPurchases[itemId] = {
                            name: item?.Item_Description || itemId,
                            sku: item?.SKU || '-',
                            supplierId: item?.Supplier_ID,
                            qty: 0,
                            cost: 0
                        };
                    }
                    productPurchases[itemId].qty += qty;
                    productPurchases[itemId].cost += cost;
                });
            }
            
            // Build sales stats by supplier (for customer and city analysis)
            const customerStats = {};
            const cityStats = {};
            const productSalesStats = {};
            let totalSalesRevenue = 0;
            let totalSalesOrders = 0;
            
            for (const so of sales) {
                const soDate = parseDate(so.Sale_Date || so.SO_Date);
                if (fromDate && (!soDate || soDate < fromDate)) continue;
                if (toDate && (!soDate || soDate > toDate)) continue;
                
                const cust = customers.find(c => c.Customer_ID === so.Customer_ID);
                const cityKey = cust ? `${cust.City || 'Unknown'}|${cust.State || ''}` : 'Unknown|';
                
                const lines = getSalesLinesFromCache(so.SO_ID);
                let orderMatchesSupplier = false;
                let orderRevenue = 0;
                
                lines.forEach(line => {
                    const itemId = line.Item_ID;
                    const item = items.find(i => i.Item_ID === itemId);
                    const itemSupplierId = item?.Supplier_ID;
                    
                    // Filter by supplier if specified
                    if (supplierId && !matchesFilter(itemSupplierId, supplierId)) return;
                    
                    orderMatchesSupplier = true;
                    const qty = parseInt(line.Quantity) || 0;
                    const unitPrice = parseFloat(line.Unit_Price) || 0;
                    const revenue = qty * unitPrice;
                    orderRevenue += revenue;
                    
                    // Product sales tracking
                    if (!productSalesStats[itemId]) {
                        productSalesStats[itemId] = {
                            name: item?.Item_Description || itemId,
                            sku: item?.SKU || '-',
                            supplier: suppliers.find(s => s.Supplier_ID === itemSupplierId)?.Supplier_Name || 'Unknown',
                            qtySold: 0,
                            revenue: 0
                        };
                    }
                    productSalesStats[itemId].qtySold += qty;
                    productSalesStats[itemId].revenue += revenue;
                });
                
                if (orderMatchesSupplier) {
                    totalSalesOrders++;
                    totalSalesRevenue += orderRevenue;
                    
                    // Customer tracking
                    if (!customerStats[so.Customer_ID]) {
                        customerStats[so.Customer_ID] = {
                            name: cust?.Customer_Name || 'Unknown',
                            location: cust ? `${cust.City || ''}, ${cust.State || ''}`.replace(', ,', ',').replace(/^, |, $/g, '') : '',
                            revenue: 0,
                            orders: 0
                        };
                    }
                    customerStats[so.Customer_ID].orders++;
                    customerStats[so.Customer_ID].revenue += orderRevenue;
                    
                    // City tracking
                    if (!cityStats[cityKey]) {
                        cityStats[cityKey] = {
                            city: cust?.City || 'Unknown',
                            state: cust?.State || '',
                            revenue: 0,
                            orders: 0,
                            customers: new Set()
                        };
                    }
                    cityStats[cityKey].orders++;
                    cityStats[cityKey].revenue += orderRevenue;
                    cityStats[cityKey].customers.add(so.Customer_ID);
                }
            }
            
            // Calculate totals
            const allSuppliers = Object.values(supplierStats);
            allSuppliers.forEach(s => {
                s.productCount = s.products.size;
                s.outstanding = s.totalSpent - s.totalPaid;
            });
            
            const totalSpent = allSuppliers.reduce((sum, s) => sum + s.totalSpent, 0);
            const totalPaid = allSuppliers.reduce((sum, s) => sum + s.totalPaid, 0);
            const totalOutstanding = totalSpent - totalPaid;
            const totalOrders = allSuppliers.reduce((sum, s) => sum + s.orders, 0);
            const totalUnits = allSuppliers.reduce((sum, s) => sum + s.units, 0);
            const avgOrderValue = totalOrders > 0 ? totalSpent / totalOrders : 0;
            const paymentRate = totalSpent > 0 ? (totalPaid / totalSpent) * 100 : 100;
            
            // Top 10 lists
            const topSuppliers = [...allSuppliers].sort((a, b) => b.totalSpent - a.totalSpent).slice(0, 10);
            const topProducts = Object.values(productPurchases).sort((a, b) => b.cost - a.cost).slice(0, 10);
            const topCustomers = Object.values(customerStats).sort((a, b) => b.revenue - a.revenue).slice(0, 10);
            const topCities = Object.values(cityStats)
                .map(c => ({ ...c, customerCount: c.customers.size }))
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 10);
            const topProductsSales = Object.values(productSalesStats).sort((a, b) => b.revenue - a.revenue).slice(0, 10);
            
            // Calculate max values for bar charts
            const maxSupplierOrders = Math.max(...topSuppliers.map(s => s.orders), 1);
            const maxProductQty = Math.max(...topProducts.map(p => p.qty), 1);
            const maxCustomerOrders = Math.max(...topCustomers.map(c => c.orders), 1);
            const maxCityOrders = Math.max(...topCities.map(c => c.orders), 1);
            const maxProductSalesQty = Math.max(...topProductsSales.map(p => p.qtySold), 1);
            
            // Unique counts
            const uniqueCustomers = Object.keys(customerStats).length;
            const uniqueCities = Object.keys(cityStats).length;
            const uniqueProducts = Object.keys(productPurchases).length;
            
            // Bar colors
            const barColors = ['#6b9a8d', '#7a9bb8', '#b8a86b', '#b88a8a', '#9a8ab8', '#b89aaa', '#7aaab8', '#9ab88a', '#b8a07a', '#8a8ab0'];
            
            // Monthly data for chart
            const sortedMonths = Object.entries(monthlyPurchases).sort((a, b) => a[0].localeCompare(b[0])).slice(-12);
            const monthLabels = sortedMonths.map(([m]) => {
                const [year, month] = m.split('-');
                return new Date(year, parseInt(month) - 1).toLocaleDateString('en-US', { month: 'short' });
            });
            const spentData = sortedMonths.map(([, d]) => d.spent.toFixed(2));
            
            // Chart IDs
            const purchaseChartId = 'supplierPurchaseChart_' + Date.now();
            const paymentChartId = 'paymentDonutChart_' + Date.now();
            
            let html = `
                <style>
                    .supplier-dash {
                        background: white;
                        border-radius: 16px;
                        padding: 25px;
                        color: #1f2937;
                        border: 2px solid #e0e0e0;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    }
                    .supplier-dash-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 25px;
                        padding-bottom: 20px;
                        border-bottom: 2px solid #e5e7eb;
                        flex-wrap: wrap;
                        gap: 15px;
                    }
                    .supplier-dash-header h2 {
                        margin: 0;
                        font-size: 28px;
                        font-weight: 700;
                        color: ${themeColor};
                    }
                    .supplier-dash-header p {
                        margin: 5px 0 0 0;
                        color: #6b7280;
                        font-size: 14px;
                    }
                    .supplier-dash-badge {
                        background: ${themeColor};
                        color: white;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 500;
                        flex-shrink: 0;
                    }
                    .supplier-dash-stats {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    .supplier-dash-stat {
                        background: #f8fafc;
                        border-radius: 12px;
                        padding: 18px;
                        text-align: center;
                        border: 1px solid #e2e8f0;
                        min-width: 0;
                        overflow: hidden;
                    }
                    .supplier-dash-stat-label {
                        font-size: 11px;
                        color: #6b7280;
                        text-transform: uppercase;
                        margin-bottom: 8px;
                        font-weight: 600;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .supplier-dash-stat-value {
                        font-size: 24px;
                        font-weight: 700;
                        color: #1f2937;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .supplier-dash-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                        gap: 20px;
                        margin-bottom: 20px;
                    }
                    .supplier-dash-card {
                        background: #f8fafc;
                        border-radius: 12px;
                        padding: 20px;
                        border: 1px solid #e2e8f0;
                        min-width: 0;
                        overflow: hidden;
                    }
                    .supplier-dash-card-title {
                        font-size: 16px;
                        font-weight: 600;
                        margin-bottom: 15px;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        color: #1e3a5f;
                    }
                    .supplier-dash-card-title .icon {
                        background: ${themeColor};
                        color: white;
                        width: 32px;
                        height: 32px;
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 16px;
                        flex-shrink: 0;
                    }
                    .supplier-dash-chart {
                        height: 220px;
                    }
                    /* Horizontal Bar Chart Styles */
                    .supplier-dash-bar-list {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                        width: 100%;
                        overflow: hidden;
                    }
                    .supplier-dash-bar-item {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        width: 100%;
                        min-width: 0;
                    }
                    .supplier-dash-bar-label {
                        display: flex;
                        align-items: flex-start;
                        gap: 4px;
                        width: 110px;
                        flex-shrink: 0;
                        overflow: hidden;
                    }
                    .supplier-dash-bar-rank {
                        font-weight: 600;
                        color: #6b7280;
                        font-size: 13px;
                        min-width: 18px;
                        flex-shrink: 0;
                    }
                    .supplier-dash-bar-name {
                        flex: 1;
                        min-width: 0;
                        overflow: hidden;
                    }
                    .supplier-dash-bar-title {
                        font-weight: 600;
                        font-size: 12px;
                        color: #1f2937;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }
                    .supplier-dash-bar-sub {
                        font-size: 10px;
                        color: #9ca3af;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }
                    .supplier-dash-bar-track {
                        flex: 1;
                        height: 22px;
                        background: #f3f4f6;
                        border-radius: 12px;
                        overflow: hidden;
                        min-width: 50px;
                    }
                    .supplier-dash-bar-fill {
                        height: 100%;
                        border-radius: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: flex-end;
                        padding-right: 6px;
                        min-width: 30px;
                        transition: width 0.3s ease;
                    }
                    .supplier-dash-bar-badge {
                        font-size: 10px;
                        font-weight: 600;
                        color: white;
                        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
                    }
                    .supplier-dash-bar-value {
                        font-weight: 600;
                        font-size: 12px;
                        color: #1f2937;
                        width: 65px;
                        text-align: right;
                        white-space: nowrap;
                        flex-shrink: 0;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    /* Quick Stats Styles */
                    .supplier-dash-quick-stats {
                        display: flex;
                        flex-direction: column;
                        gap: 0;
                    }
                    .supplier-dash-quick-stat {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 0;
                        border-bottom: 1px solid #e5e7eb;
                    }
                    .supplier-dash-quick-stat:last-child {
                        border-bottom: none;
                    }
                    .supplier-dash-quick-label {
                        font-size: 14px;
                        color: #4b5563;
                    }
                    .supplier-dash-quick-value {
                        font-size: 16px;
                        font-weight: 600;
                        color: #1f2937;
                    }
                    .supplier-dash-donut {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                    }
                    .supplier-dash-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 13px;
                    }
                    .supplier-dash-table th {
                        text-align: left;
                        padding: 10px 6px;
                        border-bottom: 2px solid #e5e7eb;
                        color: #6b7280;
                        font-weight: 600;
                        font-size: 11px;
                        text-transform: uppercase;
                    }
                    .supplier-dash-table td {
                        padding: 10px 6px;
                        border-bottom: 1px solid #f3f4f6;
                        vertical-align: top;
                    }
                    .supplier-dash-table tr:last-child td {
                        border-bottom: none;
                    }
                    @media print {
                        .supplier-dash { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    }
                </style>
                
                <div class="supplier-dash">
                    <div class="supplier-dash-header">
                        <div>
                            <h2> Supplier Performance Dashboard</h2>
                            <p>Purchasing Analysis and Supplier Metrics</p>
                        </div>
                        <div class="supplier-dash-badge">${dateLabel}</div>
                    </div>
                    
                    <!-- Top Stats Row -->
                    <div class="supplier-dash-stats">
                        <div class="supplier-dash-stat">
                            <div class="supplier-dash-stat-label"> Units Purchased</div>
                            <div class="supplier-dash-stat-value" style="color: #7a9bb8;">${totalUnits.toLocaleString()}</div>
                        </div>
                        <div class="supplier-dash-stat">
                            <div class="supplier-dash-stat-label"> PO Count</div>
                            <div class="supplier-dash-stat-value" style="color: #9a8ab8;">${totalOrders.toLocaleString()}</div>
                        </div>
                        <div class="supplier-dash-stat">
                            <div class="supplier-dash-stat-label"> Total Spent</div>
                            <div class="supplier-dash-stat-value" style="color: ${themeColor};">${formatMoney(totalSpent)}</div>
                        </div>
                        <div class="supplier-dash-stat">
                            <div class="supplier-dash-stat-label"> Total Sales</div>
                            <div class="supplier-dash-stat-value" style="color: #6b9a8d;">${formatMoney(totalSalesRevenue)}</div>
                        </div>
                        <div class="supplier-dash-stat">
                            <div class="supplier-dash-stat-label"> Outstanding</div>
                            <div class="supplier-dash-stat-value" style="color: ${totalOutstanding > 0 ? '#b88a8a' : '#6b9a8d'};">${formatMoney(totalOutstanding)}</div>
                        </div>
                        <div class="supplier-dash-stat">
                            <div class="supplier-dash-stat-label"> Payment Rate</div>
                            <div class="supplier-dash-stat-value" style="color: ${paymentRate >= 80 ? '#6b9a8d' : paymentRate >= 50 ? '#b8a86b' : '#b88a8a'};">${paymentRate.toFixed(1)}%</div>
                        </div>
                    </div>
                    
                    <!-- Supplier Scorecard Table -->
                    <div class="supplier-dash-card" style="margin-bottom: 20px;">
                        <div class="supplier-dash-card-title">
                            <span class="icon"></span>
                            Supplier Scorecard (Top 10)
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="supplier-dash-table" style="table-layout: auto;">
                                <thead>
                                    <tr>
                                        <th style="width: 30px;">#</th>
                                        <th>Supplier</th>
                                        <th>Location</th>
                                        <th style="text-align: right;">POs</th>
                                        <th style="text-align: right;">Products</th>
                                        <th style="text-align: right;">Units</th>
                                        <th style="text-align: right;">Total Spent</th>
                                        <th style="text-align: right;">Outstanding</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topSuppliers.map((s, i) => `
                                        <tr>
                                            <td><strong>${i + 1}</strong></td>
                                            <td><strong>${s.name}</strong></td>
                                            <td style="color: #6b7280;">${[s.city, s.state].filter(Boolean).join(', ') || '-'}</td>
                                            <td style="text-align: right;">${s.orders}</td>
                                            <td style="text-align: right;">${s.productCount}</td>
                                            <td style="text-align: right;">${s.units.toLocaleString()}</td>
                                            <td style="text-align: right; font-weight: 600;">${formatMoney(s.totalSpent)}</td>
                                            <td style="text-align: right; color: ${s.outstanding > 0 ? '#b88a8a' : '#6b9a8d'};">${formatMoney(s.outstanding)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Purchase Trend Chart + Payment Status -->
                    <div class="supplier-dash-grid" style="grid-template-columns: 2fr 1fr;">
                        <div class="supplier-dash-card">
                            <div class="supplier-dash-card-title">
                                <span class="icon"></span>
                                Purchase Trend
                            </div>
                            <div class="supplier-dash-chart">
                                <canvas id="${purchaseChartId}"></canvas>
                            </div>
                        </div>
                        <div class="supplier-dash-card">
                            <div class="supplier-dash-card-title">
                                <span class="icon"></span>
                                Payment Status
                            </div>
                            <div class="supplier-dash-donut">
                                <canvas id="${paymentChartId}" width="160" height="160"></canvas>
                                <div style="margin-top: 15px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: ${paymentRate >= 80 ? '#6b9a8d' : paymentRate >= 50 ? '#b8a86b' : '#b88a8a'};">${paymentRate.toFixed(1)}%</div>
                                    <div style="font-size: 12px; color: #6b7280;">Payment Rate</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top 10 Suppliers + Top 10 Products (Purchased) -->
                    <div class="supplier-dash-grid">
                        <!-- Top 10 Suppliers -->
                        <div class="supplier-dash-card">
                            <div class="supplier-dash-card-title">
                                <span class="icon"></span>
                                Top 10 Suppliers (by Spend)
                            </div>
                            ${topSuppliers.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No purchases in this period</p>' : `
                            <div class="supplier-dash-bar-list">
                                ${topSuppliers.map((s, i) => `
                                    <div class="supplier-dash-bar-item">
                                        <div class="supplier-dash-bar-label">
                                            <span class="supplier-dash-bar-rank">${i + 1}.</span>
                                            <div class="supplier-dash-bar-name">
                                                <div class="supplier-dash-bar-title">${s.name}</div>
                                                <div class="supplier-dash-bar-sub">${s.productCount} product${s.productCount !== 1 ? 's' : ''}</div>
                                            </div>
                                        </div>
                                        <div class="supplier-dash-bar-track">
                                            <div class="supplier-dash-bar-fill" style="width: ${(s.orders / maxSupplierOrders * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]};">
                                                <span class="supplier-dash-bar-badge">${s.orders}</span>
                                            </div>
                                        </div>
                                        <div class="supplier-dash-bar-value">${formatMoney(s.totalSpent)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            `}
                        </div>
                        
                        <!-- Top 10 Products (Purchased) -->
                        <div class="supplier-dash-card">
                            <div class="supplier-dash-card-title">
                                <span class="icon"></span>
                                Top 10 Products (Purchased)
                            </div>
                            ${topProducts.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No purchases in this period</p>' : `
                            <div class="supplier-dash-bar-list">
                                ${topProducts.map((p, i) => {
                                    const supplier = suppliers.find(s => s.Supplier_ID === p.supplierId);
                                    const supplierName = supplier?.Supplier_Name || 'Unknown';
                                    return `
                                    <div class="supplier-dash-bar-item">
                                        <div class="supplier-dash-bar-label">
                                            <span class="supplier-dash-bar-rank">${i + 1}.</span>
                                            <div class="supplier-dash-bar-name">
                                                <div class="supplier-dash-bar-title">${p.name}</div>
                                                <div class="supplier-dash-bar-sub">${p.qty} units  ${supplierName}</div>
                                            </div>
                                        </div>
                                        <div class="supplier-dash-bar-track">
                                            <div class="supplier-dash-bar-fill" style="width: ${(p.qty / maxProductQty * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]};">
                                                <span class="supplier-dash-bar-badge">${p.qty}</span>
                                            </div>
                                        </div>
                                        <div class="supplier-dash-bar-value">${formatMoney(p.cost)}</div>
                                    </div>
                                `}).join('')}
                            </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Top 10 Customers + Top 10 Cities (Sales of Supplier Products) -->
                    <div class="supplier-dash-grid">
                        <!-- Top 10 Customers -->
                        <div class="supplier-dash-card">
                            <div class="supplier-dash-card-title">
                                <span class="icon"></span>
                                Top 10 Customers (Sales)
                            </div>
                            ${topCustomers.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No sales in this period</p>' : `
                            <div class="supplier-dash-bar-list">
                                ${topCustomers.map((c, i) => `
                                    <div class="supplier-dash-bar-item">
                                        <div class="supplier-dash-bar-label">
                                            <span class="supplier-dash-bar-rank">${i + 1}.</span>
                                            <div class="supplier-dash-bar-name">
                                                <div class="supplier-dash-bar-title">${c.name}</div>
                                                <div class="supplier-dash-bar-sub">${c.location || ''}</div>
                                            </div>
                                        </div>
                                        <div class="supplier-dash-bar-track">
                                            <div class="supplier-dash-bar-fill" style="width: ${(c.orders / maxCustomerOrders * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]};">
                                                <span class="supplier-dash-bar-badge">${c.orders}</span>
                                            </div>
                                        </div>
                                        <div class="supplier-dash-bar-value">${formatMoney(c.revenue)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            `}
                        </div>
                        
                        <!-- Top 10 Cities -->
                        <div class="supplier-dash-card">
                            <div class="supplier-dash-card-title">
                                <span class="icon"></span>
                                Top 10 Cities (Sales)
                            </div>
                            ${topCities.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No sales in this period</p>' : `
                            <div class="supplier-dash-bar-list">
                                ${topCities.map((c, i) => `
                                    <div class="supplier-dash-bar-item">
                                        <div class="supplier-dash-bar-label">
                                            <span class="supplier-dash-bar-rank">${i + 1}.</span>
                                            <div class="supplier-dash-bar-name">
                                                <div class="supplier-dash-bar-title">${c.city}${c.state ? ', ' + c.state : ''}</div>
                                                <div class="supplier-dash-bar-sub">${c.customerCount} customer${c.customerCount !== 1 ? 's' : ''}</div>
                                            </div>
                                        </div>
                                        <div class="supplier-dash-bar-track">
                                            <div class="supplier-dash-bar-fill" style="width: ${(c.orders / maxCityOrders * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]};">
                                                <span class="supplier-dash-bar-badge">${c.orders}</span>
                                            </div>
                                        </div>
                                        <div class="supplier-dash-bar-value">${formatMoney(c.revenue)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Top Products (Sales) + Quick Stats -->
                    <div class="supplier-dash-grid">
                        <!-- Top 10 Products (Sales) -->
                        <div class="supplier-dash-card">
                            <div class="supplier-dash-card-title">
                                <span class="icon"></span>
                                Top 10 Products (by Sales Revenue)
                            </div>
                            ${topProductsSales.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">No sales in this period</p>' : `
                            <div class="supplier-dash-bar-list">
                                ${topProductsSales.map((p, i) => `
                                    <div class="supplier-dash-bar-item">
                                        <div class="supplier-dash-bar-label">
                                            <span class="supplier-dash-bar-rank">${i + 1}.</span>
                                            <div class="supplier-dash-bar-name">
                                                <div class="supplier-dash-bar-title">${p.name}</div>
                                                <div class="supplier-dash-bar-sub">${p.qtySold} units  ${p.supplier}</div>
                                            </div>
                                        </div>
                                        <div class="supplier-dash-bar-track">
                                            <div class="supplier-dash-bar-fill" style="width: ${(p.qtySold / maxProductSalesQty * 100).toFixed(0)}%; background: ${barColors[i % barColors.length]};">
                                                <span class="supplier-dash-bar-badge">${p.qtySold}</span>
                                            </div>
                                        </div>
                                        <div class="supplier-dash-bar-value">${formatMoney(p.revenue)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            `}
                        </div>
                        
                        <!-- Quick Stats -->
                        <div class="supplier-dash-card">
                            <div class="supplier-dash-card-title">
                                <span class="icon"></span>
                                Quick Stats
                            </div>
                            <div class="supplier-dash-quick-stats">
                                <div class="supplier-dash-quick-stat">
                                    <span class="supplier-dash-quick-label"> Total Purchases</span>
                                    <span class="supplier-dash-quick-value">${formatMoney(totalSpent)}</span>
                                </div>
                                <div class="supplier-dash-quick-stat">
                                    <span class="supplier-dash-quick-label"> Sales Revenue</span>
                                    <span class="supplier-dash-quick-value">${formatMoney(totalSalesRevenue)}</span>
                                </div>
                                <div class="supplier-dash-quick-stat">
                                    <span class="supplier-dash-quick-label"> Amount Paid</span>
                                    <span class="supplier-dash-quick-value" style="color: #6b9a8d;">${formatMoney(totalPaid)}</span>
                                </div>
                                <div class="supplier-dash-quick-stat">
                                    <span class="supplier-dash-quick-label"> Outstanding</span>
                                    <span class="supplier-dash-quick-value" style="color: ${totalOutstanding > 0 ? '#b88a8a' : '#6b9a8d'};">${formatMoney(totalOutstanding)}</span>
                                </div>
                                <div class="supplier-dash-quick-stat">
                                    <span class="supplier-dash-quick-label"> Purchase Orders</span>
                                    <span class="supplier-dash-quick-value">${totalOrders}</span>
                                </div>
                                <div class="supplier-dash-quick-stat">
                                    <span class="supplier-dash-quick-label"> Avg PO Value</span>
                                    <span class="supplier-dash-quick-value">${formatMoney(avgOrderValue)}</span>
                                </div>
                                <div class="supplier-dash-quick-stat">
                                    <span class="supplier-dash-quick-label"> Active Suppliers</span>
                                    <span class="supplier-dash-quick-value">${allSuppliers.length}</span>
                                </div>
                                <div class="supplier-dash-quick-stat">
                                    <span class="supplier-dash-quick-label"> Active Customers</span>
                                    <span class="supplier-dash-quick-value">${uniqueCustomers}</span>
                                </div>
                                <div class="supplier-dash-quick-stat">
                                    <span class="supplier-dash-quick-label"> Active Cities</span>
                                    <span class="supplier-dash-quick-value">${uniqueCities}</span>
                                </div>
                                <div class="supplier-dash-quick-stat">
                                    <span class="supplier-dash-quick-label"> Products</span>
                                    <span class="supplier-dash-quick-value">${uniqueProducts}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <scr` + `ipt>
                    setTimeout(() => {
                        // Purchase Trend Chart
                        const purchaseCtx = document.getElementById('${purchaseChartId}');
                        if (purchaseCtx) {
                            if(Chart.getChart(purchaseCtx)) Chart.getChart(purchaseCtx).destroy();
                            new Chart(purchaseCtx, {
                                type: 'bar',
                                data: {
                                    labels: [${monthLabels.map(l => `'${l}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Purchases',
                                        data: [${spentData.join(', ')}],
                                        backgroundColor: '${themeColor}',
                                        borderRadius: 6
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    animation: false,
                                    layout: { padding: { top: 20 } },
                                    plugins: {
                                        legend: { display: false },
                                        datalabels: {
                                            display: true,
                                            anchor: 'end',
                                            align: 'end',
                                            color: '#374151',
                                            font: { size: 10, weight: 'bold' },
                                            formatter: (val) => '$' + (val >= 1000 ? (val/1000).toFixed(1) + 'k' : val.toFixed(0))
                                        }
                                    },
                                    scales: {
                                        x: { 
                                            ticks: { color: '#6b7280', font: { size: 10 } },
                                            grid: { display: false }
                                        },
                                        y: { 
                                            ticks: { 
                                                color: '#6b7280', 
                                                font: { size: 10 },
                                                callback: (val) => '$' + (val >= 1000 ? (val/1000).toFixed(0) + 'k' : val.toFixed(0))
                                            },
                                            grid: { color: '#e5e7eb' }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Payment Donut Chart
                        const paymentCtx = document.getElementById('${paymentChartId}');
                        if (paymentCtx) {
                            if(Chart.getChart(paymentCtx)) Chart.getChart(paymentCtx).destroy();
                            new Chart(paymentCtx, {
                                type: 'doughnut',
                                data: {
                                    labels: ['Paid', 'Outstanding'],
                                    datasets: [{
                                        data: [${totalPaid.toFixed(2)}, ${totalOutstanding.toFixed(2)}],
                                        backgroundColor: ['#6b9a8d', '#b88a8a'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false,
                                    animation: false,
                                    cutout: '65%',
                                    plugins: {
                                        legend: { display: false },
                                        datalabels: {
                                            display: true,
                                            color: '#fff',
                                            font: { weight: 'bold', size: 11 },
                                            formatter: (value, ctx) => {
                                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                                const pct = total > 0 ? Math.round((value / total) * 100) : 0;
                                                return pct > 5 ? pct + '%' : '';
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        // 1. SALES BY CUSTOMER REPORT
        async function generateSalesByCustomer() {
            const salesResult = await apiCall('getSalesOrders');
            const customersResult = await apiCall('getCustomers');
            const itemsResult = await apiCall('getItems');
            
            if (!salesResult?.data || !customersResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const customers = customersResult.data;
            const items = itemsResult.data;
            let sales = salesResult.data;
            
            // Fetch ALL sales order lines with their SO info
            const allDetails = [];
            for (const so of sales) {
                const lines = getSalesLinesFromCache(so.SO_ID);
                if (lines.length > 0) {
                    lines.forEach(line => {
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const unitsPerPackage = parseFloat(item?.Units_Per_Package) || 1;
                        const packageCost = parseFloat(item?.Package_Cost) || 0;
                        const unitCost = packageCost / unitsPerPackage;
                        const quantity = parseInt(line.Quantity || 0);
                        const unitPrice = parseFloat(line.Unit_Price || 0);
                        // Calculate line total from qty * price (Line_Total may not exist)
                        const lineTotal = quantity * unitPrice;
                        const lineCost = quantity * unitCost;
                        
                        allDetails.push({
                            soId: so.SO_ID,
                            soDate: so.Sale_Date || so.SO_Date,
                            customerId: so.Customer_ID,
                            customerName: getCustomerName(so.Customer_ID),
                            itemId: line.Item_ID,
                            itemDescription: item?.Item_Description || line.Item_ID,
                            quantity: quantity,
                            unitsPerPackage: unitsPerPackage,
                            unitPrice: unitPrice,
                            unitCost: unitCost,
                            lineTotal: lineTotal,
                            lineCost: lineCost,
                            lineProfit: lineTotal - lineCost,
                            paymentStatus: so.Payment_Status || 'Unknown'
                        });
                    });
                }
            }
            
            // Store raw data
            rawReportData['sales-by-customer'] = { sales, customers, items, allDetails };
            
            // APPLY FILTERS
            let filtered = allDetails;
            if (reportFilters.fromDate) {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                filtered = filtered.filter(d => new Date(d.soDate) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = parseLocalDate(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                filtered = filtered.filter(d => new Date(d.soDate) <= toDate);
            }
            if (reportFilters.customer) {
                filtered = filtered.filter(d => matchesFilter(d.customerId, reportFilters.customer));
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(d => d.lineTotal >= reportFilters.minAmount);
            }
            
            // GROUP BY CUSTOMER and calculate totals
            const customerSummary = {};
            filtered.forEach(detail => {
                if (!customerSummary[detail.customerId]) {
                    customerSummary[detail.customerId] = {
                        customerId: detail.customerId,
                        customerName: detail.customerName,
                        customerLocation: getCustomerLocation(detail.customerId),
                        totalCases: 0,
                        totalUnits: 0,
                        totalRevenue: 0,
                        totalCost: 0,
                        totalProfit: 0
                    };
                }
                
                const summary = customerSummary[detail.customerId];
                // Calculate cases (divide units by units per package)
                const cases = detail.quantity / detail.unitsPerPackage;
                summary.totalCases += cases;
                summary.totalUnits += detail.quantity;
                summary.totalRevenue += detail.lineTotal;
                summary.totalCost += detail.lineCost;
                summary.totalProfit += detail.lineProfit;
            });
            
            // Convert to array and calculate margin %
            const summaryArray = Object.values(customerSummary).map(s => ({
                ...s,
                marginPercent: s.totalRevenue > 0 ? (s.totalProfit / s.totalRevenue) * 100 : 0
            }));
            
            // Sort by total revenue (highest first)
            summaryArray.sort((a, b) => b.totalRevenue - a.totalRevenue);
            
            // Calculate grand totals
            const grandTotalRevenue = summaryArray.reduce((sum, s) => sum + s.totalRevenue, 0);
            const grandTotalCost = summaryArray.reduce((sum, s) => sum + s.totalCost, 0);
            const grandTotalProfit = summaryArray.reduce((sum, s) => sum + s.totalProfit, 0);
            const grandTotalCases = summaryArray.reduce((sum, s) => sum + s.totalCases, 0);
            const grandTotalUnits = summaryArray.reduce((sum, s) => sum + s.totalUnits, 0);
            const grandMargin = grandTotalRevenue > 0 ? (grandTotalProfit / grandTotalRevenue) * 100 : 0;
            
            // Build customer list for filter
            const customerList = customers.map(c => ({ id: c.Customer_ID, name: c.Customer_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('sales-by-customer', {
                dateRange: true,
                dateLabel: 'Sale Date',
                customer: true,
                customerList: customerList,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3> Sales by Customer Summary</h3>
                    <p style="color: #666;">Total Customers: ${summaryArray.length} | Total Revenue: ${formatMoney(grandTotalRevenue)} | Total Profit: ${formatMoney(grandTotalProfit)} | Gross Margin: ${grandMargin.toFixed(1)}%</p>
                </div>`;
            
            if (summaryArray.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table" id="salesByCustomerTable">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Total Cases</th>
                            <th>Total Units</th>
                            <th>Total Revenue</th>
                            <th>Total Cost</th>
                            <th>Total Profit</th>
                            <th>Gross Margin %</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                summaryArray.forEach(summary => {
                    const marginColor = summary.marginPercent >= 30 ? '#2e7d32' : summary.marginPercent >= 20 ? '#f57c00' : '#c62828';
                    html += `<tr style="cursor: pointer;" onclick="openCustomer('${summary.customerId}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td>
                            <strong style="color: #667eea;">${summary.customerName}</strong>
                            ${summary.customerLocation ? `<div style="font-size: 11px; color: #888;">${summary.customerLocation}</div>` : ''}
                        </td>
                        <td>${summary.totalCases.toFixed(1)}</td>
                        <td>${Math.round(summary.totalUnits).toLocaleString()}</td>
                        <td><strong>${formatMoney(summary.totalRevenue)}</strong></td>
                        <td>${formatMoney(summary.totalCost)}</td>
                        <td style="color: ${summary.totalProfit >= 0 ? 'green' : 'red'};"><strong>${formatMoney(summary.totalProfit)}</strong></td>
                        <td style="color: ${marginColor}; font-weight: bold;">${summary.marginPercent.toFixed(1)}%</td>
                    </tr>`;
                });
                
                // Add totals row
                html += `<tr style="background: #f0f0f0; font-weight: bold; border-top: 3px solid #667eea;">
                    <td style="text-align: right; padding-right: 20px;">TOTALS:</td>
                    <td>${grandTotalCases.toFixed(1)}</td>
                    <td>${Math.round(grandTotalUnits).toLocaleString()}</td>
                    <td><strong>${formatMoney(grandTotalRevenue)}</strong></td>
                    <td>${formatMoney(grandTotalCost)}</td>
                    <td style="color: ${grandTotalProfit >= 0 ? 'green' : 'red'};"><strong>${formatMoney(grandTotalProfit)}</strong></td>
                    <td style="color: ${grandMargin >= 30 ? '#2e7d32' : grandMargin >= 20 ? '#f57c00' : '#c62828'}; font-weight: bold;">${grandMargin.toFixed(1)}%</td>
                </tr>`;
            
                html += '</tbody></table>';
            }
            
            reportData['sales-by-customer'] = summaryArray;
            document.getElementById('reportContainer').innerHTML = html;
            setTimeout(() => makeSortable('salesByCustomerTable'), 0);
        }
        
        // SALES ORDER DETAIL REPORT (NEW!)
        async function generateSalesOrderDetail() {
            const salesResult = await apiCall('getSalesOrders');
            const customersResult = await apiCall('getCustomers');
            const itemsResult = await apiCall('getItems');
            
            if (!salesResult?.data || !customersResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const customers = customersResult.data;
            const items = itemsResult.data;
            let sales = salesResult.data;
            
            // Fetch ALL sales order lines with their SO info
            const allDetails = [];
            for (const so of sales) {
                const lines = getSalesLinesFromCache(so.SO_ID);
                if (lines.length > 0) {
                    lines.forEach(line => {
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const quantity = parseInt(line.Quantity || 0);
                        const unitPrice = parseFloat(line.Unit_Price || 0);
                        // Calculate line total from qty * price (Line_Total may not exist)
                        const lineTotal = quantity * unitPrice;
                        allDetails.push({
                            soId: so.SO_ID,
                            invoiceNumber: so.Invoice_Number || so.SO_ID,
                            soDate: so.Sale_Date || so.SO_Date,
                            customerId: so.Customer_ID,
                            customerName: getCustomerName(so.Customer_ID),
                            customerLocation: getCustomerLocation(so.Customer_ID),
                            itemId: line.Item_ID,
                            itemDescription: item?.Item_Description || line.Item_ID,
                            sku: item?.SKU || '',
                            quantity: quantity,
                            unitPrice: unitPrice,
                            lineTotal: lineTotal,
                            orderTotal: parseFloat(so.Total_Amount || 0),
                            amountPaid: parseFloat(so.Amount_Paid || 0),
                            dueDate: so.Due_Date,
                            paymentDate: so.Payment_Date,
                            paymentStatus: so.Payment_Status || 'Unpaid',
                            status: so.Status || 'Completed'
                        });
                    });
                }
            }
            
            // Store raw data
            rawReportData['sales-order-detail'] = { sales, customers, items, allDetails };
            
            // APPLY FILTERS
            let filtered = allDetails;
            if (reportFilters.fromDate) {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                filtered = filtered.filter(d => new Date(d.soDate) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = parseLocalDate(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                filtered = filtered.filter(d => new Date(d.soDate) <= toDate);
            }
            if (reportFilters.customer) {
                filtered = filtered.filter(d => matchesFilter(d.customerId, reportFilters.customer));
            }
            if (reportFilters.item) {
                filtered = filtered.filter(d => matchesFilter(d.itemId, reportFilters.item));
            }
            if (reportFilters.paymentStatus) {
                filtered = filtered.filter(d => d.paymentStatus === reportFilters.paymentStatus);
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(d => d.lineTotal >= reportFilters.minAmount);
            }
            
            // Sort by date (newest first), then by SO ID
            filtered.sort((a, b) => {
                const dateCompare = new Date(b.soDate) - new Date(a.soDate);
                if (dateCompare !== 0) return dateCompare;
                return b.soId.localeCompare(a.soId);
            });
            
            // Calculate totals
            const totalSales = filtered.reduce((sum, d) => sum + d.lineTotal, 0);
            const totalOrders = new Set(filtered.map(d => d.soId)).size;
            
            // Build lists for filters
            const customerList = customers.map(c => ({ id: c.Customer_ID, name: c.Customer_Name }));
            const itemList = items.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            
            // Build inline filter summary for oval header
            const filterSummaryInline = generateFilterSummary({ inline: true });
            
            // Build HTML with filters
            let html = buildFilterUI('sales-order-detail', {
                dateRange: true,
                dateLabel: 'Sale Date',
                customer: true,
                customerList: customerList,
                item: true,
                itemList: itemList,
                paymentStatus: true,
                minAmount: true
            });
            
            html += `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Sales Order Detail Report</h2>
                    <p style="margin: 0 0 ${filterSummaryInline ? '10px' : '0'} 0; font-size: 14px; opacity: 0.95;">Total Orders: ${totalOrders} | Total Lines: ${filtered.length} | Total Sales: ${formatMoney(totalSales)}</p>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px;">${filterSummaryInline}</div>` : ''}
                </div>`;
            
            if (filtered.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table" id="salesOrderDetailTable">
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Sale Date</th>
                            <th>Customer</th>
                            <th style="text-align: right;">Total</th>
                            <th style="text-align: right;">Paid</th>
                            <th style="text-align: right;">Balance</th>
                            <th>Due Date</th>
                            <th>Paid Date</th>
                            <th>Payment</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                // Group by SO to show order-level details (not line-level)
                const orderMap = new Map();
                filtered.forEach(detail => {
                    if (!orderMap.has(detail.soId)) {
                        orderMap.set(detail.soId, detail);
                    }
                });
                
                let grandTotal = 0;
                let grandPaid = 0;
                let grandBalance = 0;
                
                orderMap.forEach((detail, soId) => {
                    const orderTotal = parseFloat(detail.orderTotal) || 0;
                    const amountPaid = parseFloat(detail.amountPaid) || 0;
                    const balance = orderTotal - amountPaid;
                    grandTotal += orderTotal;
                    grandPaid += amountPaid;
                    grandBalance += balance;
                    
                    const dateObj = parseDate(detail.soDate);
                    const sortableDate = dateObj ? dateObj.toISOString().split('T')[0] : '';
                    const dueDateObj = parseDate(detail.dueDate);
                    const sortableDueDate = dueDateObj ? dueDateObj.toISOString().split('T')[0] : '';
                    const paidDateObj = parseDate(detail.paymentDate);
                    const sortablePaidDate = paidDateObj ? paidDateObj.toISOString().split('T')[0] : '';
                    
                    html += `<tr style="cursor: pointer;" onclick="openSalesOrder('${detail.soId}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td><strong style="color: #667eea;">${detail.invoiceNumber || detail.soId}</strong></td>
                        <td data-sort="${sortableDate}">${formatDateSafe(detail.soDate)}</td>
                        <td>
                            <span style="color: #667eea;">${detail.customerName}</span>
                            ${detail.customerLocation ? `<div style="font-size: 11px; color: #888;">${detail.customerLocation}</div>` : ''}
                        </td>
                        <td style="text-align: right;">${formatMoney(orderTotal)}</td>
                        <td style="text-align: right; color: #6b9a8d;">${formatMoney(amountPaid)}</td>
                        <td style="text-align: right; color: ${balance > 0 ? '#b88a8a' : '#6b9a8d'}; font-weight: ${balance > 0 ? 'bold' : 'normal'};">${formatMoney(balance)}</td>
                        <td data-sort="${sortableDueDate}">${detail.dueDate ? formatDateSafe(detail.dueDate) : '-'}</td>
                        <td data-sort="${sortablePaidDate}">${detail.paymentDate ? formatDateSafe(detail.paymentDate) : '-'}</td>
                        <td><span style="background: ${detail.paymentStatus === 'Paid' ? '#6b9a8d' : detail.paymentStatus === 'Partial' ? '#b8a86b' : '#b88a8a'}; color: ${detail.paymentStatus === 'Partial' ? 'black' : 'white'}; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${detail.paymentStatus}</span></td>
                        <td><span style="background: ${detail.status === 'Completed' ? '#6b9a8d' : detail.status === 'Delivered' ? '#6b9a8d' : '#8a8a8a'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${detail.status === 'Completed' ? ' Completed' : detail.status === 'Delivered' ? ' Delivered' : detail.status}</span></td>
                    </tr>`;
                });
            
                html += `</tbody>
                <tfoot>
                    <tr style="font-weight: bold; background: #f0f0f0;">
                        <td colspan="3">TOTAL (${orderMap.size} orders)</td>
                        <td style="text-align: right;">${formatMoney(grandTotal)}</td>
                        <td style="text-align: right; color: #6b9a8d;">${formatMoney(grandPaid)}</td>
                        <td style="text-align: right; color: ${grandBalance > 0 ? '#b88a8a' : '#6b9a8d'};">${formatMoney(grandBalance)}</td>
                        <td colspan="4"></td>
                    </tr>
                </tfoot>
                </table>`;
            }
            
            reportData['sales-order-detail'] = filtered;
            document.getElementById('reportContainer').innerHTML = html;
            setTimeout(() => makeSortable('salesOrderDetailTable'), 0);
        }
        
        // 2. SALES BY PRODUCT REPORT
        async function generateSalesByProduct() {
            const itemsResult = await apiCall('getItems');
            const suppliersResult = await apiCall('getSuppliers');
            const salesResult = await apiCall('getSalesOrders');
            
            if (!itemsResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const suppliers = suppliersResult.data;
            let sales = salesResult?.data || [];
            
            // Fetch ALL sales order lines to get units sold
            const allLines = [];
            for (const so of sales) {
                const lines = getSalesLinesFromCache(so.SO_ID);
                if (lines.length > 0) {
                    lines.forEach(line => {
                        line.SO_Date = so.Sale_Date || so.SO_Date;
                        // Calculate line total (Line_Total may not exist in API response)
                        const qty = parseInt(line.Quantity || 0);
                        const unitPrice = parseFloat(line.Unit_Price || 0);
                        line.Line_Total = qty * unitPrice;
                        allLines.push(line);
                    });
                }
            }
            
            // APPLY DATE FILTERS to sales lines
            let filteredLines = allLines;
            if (reportFilters.fromDate) {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                filteredLines = filteredLines.filter(line => new Date(line.SO_Date) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = parseLocalDate(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                filteredLines = filteredLines.filter(line => new Date(line.SO_Date) <= toDate);
            }
            
            // Calculate units sold per item
            const unitsSoldByItem = {};
            filteredLines.forEach(line => {
                const itemId = line.Item_ID;
                unitsSoldByItem[itemId] = (unitsSoldByItem[itemId] || 0) + parseInt(line.Quantity || 0);
            });
            
            // Build product list with margins - INCLUDE ALL ITEMS
            const productData = items.map(item => {
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitCost = packageCost / unitsPerPackage;
                const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const margin = unitSellPrice - unitCost;
                const marginPercent = unitSellPrice > 0 ? (margin / unitSellPrice) * 100 : 0;
                const unitsSold = unitsSoldByItem[item.Item_ID] || 0;
                const totalProfit = unitsSold * margin;
                
                return {
                    id: item.Item_ID,
                    description: item.Item_Description || '',
                    sku: item.SKU || '',
                    supplierId: item.Supplier_ID || '',
                    unitCost: unitCost,
                    unitSellPrice: unitSellPrice,
                    margin: margin,
                    marginPercent: marginPercent,
                    unitsSold: unitsSold,
                    totalProfit: totalProfit
                };
            });
            
            // Store raw data
            rawReportData['sales-by-product'] = { items, suppliers, productData };
            
            // APPLY FILTERS
            let filtered = productData;
            
            if (reportFilters.item) {
                filtered = filtered.filter(p => matchesFilter(p.id, reportFilters.item));
            }
            if (reportFilters.supplier) {
                filtered = filtered.filter(p => matchesFilter(p.supplierId, reportFilters.supplier));
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(p => p.margin >= reportFilters.minAmount);
            }
            
            // Sort by margin % (highest first)
            const sorted = filtered.sort((a, b) => b.marginPercent - a.marginPercent);
            
            // Build filter lists
            const itemList = items.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('sales-by-product', {
                dateRange: false, // Remove date filter - this is about pricing, not sales history
                item: true,
                itemList: itemList,
                supplier: true,
                supplierList: supplierList,
                minAmount: true,
                amountLabel: 'Min Margin ($)'
            });
            
            // Build inline filter summary for oval header
            const filterSummaryInline = generateFilterSummary({ inline: true });
            
            // Calculate totals
            const avgMarginPercent = sorted.length > 0 
                ? sorted.reduce((sum, p) => sum + p.marginPercent, 0) / sorted.length 
                : 0;
            const totalPotentialProfit = sorted.reduce((sum, p) => sum + p.totalProfit, 0);
            
            html += `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Sales by Item - Pricing & Margin Analysis</h2>
                    <p style="margin: 0 0 ${filterSummaryInline ? '10px' : '0'} 0; font-size: 14px; opacity: 0.95;">Total Items: ${sorted.length} | Average Margin: ${avgMarginPercent.toFixed(1)}% | Total Profit: ${formatMoney(totalPotentialProfit)}</p>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px;">${filterSummaryInline}</div>` : ''}
                </div>`;
            
            if (sorted.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table" id="salesByProductTable">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>SKU</th>
                            <th>Cost</th>
                            <th>Sell</th>
                            <th>Margin</th>
                            <th>Margin %</th>
                            <th>Units Sold</th>
                            <th>Total Profit</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                sorted.forEach(product => {
                    const marginColor = product.marginPercent >= 30 ? '#2e7d32' : product.marginPercent >= 20 ? '#f57c00' : '#c62828';
                    html += `<tr style="cursor: pointer;" onclick="openItem('${product.id}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td><strong style="color: #667eea;">${product.description}</strong></td>
                        <td>${product.sku}</td>
                        <td>${formatMoney(product.unitCost)}</td>
                        <td>${formatMoney(product.unitSellPrice)}</td>
                        <td style="color: ${product.margin >= 0 ? 'green' : 'red'};">${formatMoney(product.margin)}</td>
                        <td style="color: ${marginColor}; font-weight: bold;">${product.marginPercent.toFixed(1)}%</td>
                        <td>${product.unitsSold.toLocaleString()}</td>
                        <td style="color: ${product.totalProfit >= 0 ? 'green' : 'red'};"><strong>${formatMoney(product.totalProfit)}</strong></td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['sales-by-product'] = sorted;
            document.getElementById('reportContainer').innerHTML = html;
            setTimeout(() => makeSortable('salesByProductTable'), 0);
        }
        
        // PURCHASE ORDER DETAIL REPORT (NEW!)
        async function generatePurchaseOrderDetail() {
            const purchasesResult = await apiCall('getPurchaseOrders');
            const suppliersResult = await apiCall('getSuppliers');
            const itemsResult = await apiCall('getItems');
            
            if (!purchasesResult?.data || !suppliersResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            const items = itemsResult.data;
            let purchases = purchasesResult.data;
            
            // Fetch ALL purchase order lines with their PO info
            const allDetails = [];
            for (const po of purchases) {
                const lines = getPurchaseLinesFromCache(po.PO_ID);
                if (lines.length > 0) {
                    lines.forEach(line => {
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const quantity = parseInt(line.Quantity || 0);
                        const unitCost = parseFloat(line.Unit_Cost || 0);
                        // Calculate line total from qty * cost (Line_Total may not exist)
                        const lineTotal = quantity * unitCost;
                        allDetails.push({
                            poId: po.PO_ID,
                            invoiceNumber: po.Invoice_Number || po.PO_ID,
                            poDate: po.PO_Date,
                            supplierId: po.Supplier_ID,
                            supplierName: getSupplierName(po.Supplier_ID),
                            itemId: line.Item_ID,
                            itemDescription: item?.Item_Description || line.Item_ID,
                            sku: item?.SKU || '',
                            quantity: quantity,
                            unitCost: unitCost,
                            lineTotal: lineTotal,
                            orderTotal: parseFloat(po.Total_Amount || 0),
                            amountPaid: parseFloat(po.Amount_Paid || 0),
                            dueDate: po.Due_Date,
                            paymentDate: po.Payment_Date,
                            paymentStatus: po.Payment_Status || 'Unpaid',
                            status: po.Status || 'Received'
                        });
                    });
                }
            }
            
            // Store raw data
            rawReportData['purchase-order-detail'] = { purchases, suppliers, items, allDetails };
            
            // APPLY FILTERS
            let filtered = allDetails;
            if (reportFilters.fromDate) {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                filtered = filtered.filter(d => new Date(d.poDate) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = parseLocalDate(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                filtered = filtered.filter(d => new Date(d.poDate) <= toDate);
            }
            if (reportFilters.supplier) {
                filtered = filtered.filter(d => matchesFilter(d.supplierId, reportFilters.supplier));
            }
            if (reportFilters.item) {
                filtered = filtered.filter(d => matchesFilter(d.itemId, reportFilters.item));
            }
            if (reportFilters.paymentStatus) {
                filtered = filtered.filter(d => d.paymentStatus === reportFilters.paymentStatus);
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(d => d.lineTotal >= reportFilters.minAmount);
            }
            
            // Sort by date (newest first), then by PO ID
            filtered.sort((a, b) => {
                const dateCompare = new Date(b.poDate) - new Date(a.poDate);
                if (dateCompare !== 0) return dateCompare;
                return b.poId.localeCompare(a.poId);
            });
            
            // Calculate totals
            const totalPurchases = filtered.reduce((sum, d) => sum + d.lineTotal, 0);
            const totalOrders = new Set(filtered.map(d => d.poId)).size;
            
            // Build lists for filters
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            const itemList = items.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            
            // Build HTML with filters
            let html = buildFilterUI('purchase-order-detail', {
                dateRange: true,
                dateLabel: 'Purchase Date',
                supplier: true,
                supplierList: supplierList,
                item: true,
                itemList: itemList,
                paymentStatus: true,
                minAmount: true
            });
            
            // Build inline filter summary for oval header
            const filterSummaryInline = generateFilterSummary({ inline: true });
            
            html += `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Purchase Order Detail Report</h2>
                    <p style="margin: 0 0 ${filterSummaryInline ? '10px' : '0'} 0; font-size: 14px; opacity: 0.95;">Total Orders: ${totalOrders} | Total Lines: ${filtered.length} | Total Purchases: ${formatMoney(totalPurchases)}</p>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px;">${filterSummaryInline}</div>` : ''}
                </div>`;
            
            if (filtered.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table" id="purchaseOrderDetailTable">
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>PO Date</th>
                            <th>Supplier</th>
                            <th>Status</th>
                            <th style="text-align: right;">Total</th>
                            <th style="text-align: right;">Paid</th>
                            <th style="text-align: right;">Balance</th>
                            <th>Due Date</th>
                            <th>Paid Date</th>
                            <th>Payment</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                // Group by PO to show order-level details (not line-level)
                const orderMap = new Map();
                filtered.forEach(detail => {
                    if (!orderMap.has(detail.poId)) {
                        orderMap.set(detail.poId, detail);
                    }
                });
                
                let grandTotal = 0;
                let grandPaid = 0;
                let grandBalance = 0;
                
                orderMap.forEach((detail, poId) => {
                    const orderTotal = parseFloat(detail.orderTotal) || 0;
                    const amountPaid = parseFloat(detail.amountPaid) || 0;
                    const balance = orderTotal - amountPaid;
                    grandTotal += orderTotal;
                    grandPaid += amountPaid;
                    grandBalance += balance;
                    
                    const dateObj = parseDate(detail.poDate);
                    const sortableDate = dateObj ? dateObj.toISOString().split('T')[0] : '';
                    const dueDateObj = parseDate(detail.dueDate);
                    const sortableDueDate = dueDateObj ? dueDateObj.toISOString().split('T')[0] : '';
                    const paidDateObj = parseDate(detail.paymentDate);
                    const sortablePaidDate = paidDateObj ? paidDateObj.toISOString().split('T')[0] : '';
                    
                    // Status badge
                    let statusBadge = '';
                    if (detail.status === 'Ordered') statusBadge = '<span style="background: #b8a86b; color: black; padding: 3px 8px; border-radius: 4px; font-size: 11px;"> Ordered</span>';
                    else if (detail.status === 'In Transit') statusBadge = '<span style="background: #7aaab8; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;"> In Transit</span>';
                    else if (detail.status === 'Received') statusBadge = '<span style="background: #6b9a8d; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;"> Received</span>';
                    else if (detail.status === 'Void' || detail.status === 'Voided') statusBadge = '<span style="background: #b88a8a; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;"> VOID</span>';
                    else statusBadge = `<span style="background: #8a8a8a; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${detail.status}</span>`;
                    
                    html += `<tr style="cursor: pointer;" onclick="openPurchaseOrder('${detail.poId}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td><strong style="color: #667eea;">${detail.invoiceNumber || detail.poId}</strong></td>
                        <td data-sort="${sortableDate}">${formatDateSafe(detail.poDate)}</td>
                        <td style="color: #667eea;">${detail.supplierName}</td>
                        <td>${statusBadge}</td>
                        <td style="text-align: right;">${formatMoney(orderTotal)}</td>
                        <td style="text-align: right; color: #6b9a8d;">${formatMoney(amountPaid)}</td>
                        <td style="text-align: right; color: ${balance > 0 ? '#b88a8a' : '#6b9a8d'}; font-weight: ${balance > 0 ? 'bold' : 'normal'};">${formatMoney(balance)}</td>
                        <td data-sort="${sortableDueDate}">${detail.dueDate ? formatDateSafe(detail.dueDate) : '-'}</td>
                        <td data-sort="${sortablePaidDate}">${detail.paymentDate ? formatDateSafe(detail.paymentDate) : '-'}</td>
                        <td><span style="background: ${detail.paymentStatus === 'Paid' ? '#6b9a8d' : detail.paymentStatus === 'Partial' ? '#b8a86b' : '#b88a8a'}; color: ${detail.paymentStatus === 'Partial' ? 'black' : 'white'}; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${detail.paymentStatus}</span></td>
                    </tr>`;
                });
                
                html += `</tbody>
                <tfoot>
                    <tr style="font-weight: bold; background: #f0f0f0;">
                        <td colspan="4">TOTAL (${orderMap.size} orders)</td>
                        <td style="text-align: right;">${formatMoney(grandTotal)}</td>
                        <td style="text-align: right; color: #6b9a8d;">${formatMoney(grandPaid)}</td>
                        <td style="text-align: right; color: ${grandBalance > 0 ? '#b88a8a' : '#6b9a8d'};">${formatMoney(grandBalance)}</td>
                        <td colspan="3"></td>
                    </tr>
                </tfoot>
                </table>`;
            }
            
            reportData['purchase-order-detail'] = filtered;
            document.getElementById('reportContainer').innerHTML = html;
            setTimeout(() => makeSortable('purchaseOrderDetailTable'), 0);
        }
        
        // 3. PURCHASE BY SUPPLIER REPORT
        async function generatePurchaseBySupplier() {
            const purchasesResult = await apiCall('getPurchaseOrders');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!purchasesResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            let purchases = purchasesResult.data;
            
            // Store raw data
            rawReportData['purchase-by-supplier'] = { purchases, suppliers };
            
            // APPLY FILTERS
            if (reportFilters.fromDate) {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                purchases = purchases.filter(po => new Date(po.PO_Date) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = parseLocalDate(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                purchases = purchases.filter(po => new Date(po.PO_Date) <= toDate);
            }
            if (reportFilters.supplier) {
                purchases = purchases.filter(po => matchesFilter(po.Supplier_ID, reportFilters.supplier));
            }
            if (reportFilters.minAmount) {
                purchases = purchases.filter(po => parseFloat(po.Total_Amount || po.Invoice_Total || 0) >= reportFilters.minAmount);
            }
            
            // Build supplier purchase summary
            const supplierPurchases = {};
            
            purchases.forEach(po => {
                const suppId = po.Supplier_ID;
                if (!supplierPurchases[suppId]) {
                    const supplier = suppliers.find(s => s.Supplier_ID === suppId);
                    supplierPurchases[suppId] = {
                        id: suppId,
                        name: supplier?.Supplier_Name || suppId,
                        totalSpent: 0,
                        orderCount: 0,
                        lastOrderDate: null
                    };
                }
                
                const total = parseFloat(po.Total_Amount || po.Invoice_Total || 0);
                supplierPurchases[suppId].totalSpent += total;
                supplierPurchases[suppId].orderCount++;
                
                const orderDate = new Date(po.PO_Date);
                if (!supplierPurchases[suppId].lastOrderDate || orderDate > supplierPurchases[suppId].lastOrderDate) {
                    supplierPurchases[suppId].lastOrderDate = orderDate;
                }
            });
            
            // Sort by total spent
            const sorted = Object.values(supplierPurchases).sort((a, b) => b.totalSpent - a.totalSpent);
            
            // Build supplier list for filter
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build inline filter summary for oval header
            const filterSummaryInline = generateFilterSummary({ inline: true });
            
            // Build HTML with filters
            let html = buildFilterUI('purchase-by-supplier', {
                dateRange: true,
                dateLabel: 'Purchase Date',
                supplier: true,
                supplierList: supplierList,
                minAmount: true
            });
            
            html += `
                <div style="padding: 25px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                    <h2 style="margin: 0 0 8px 0; font-size: 26px; display: flex; align-items: center; gap: 12px;"> Purchase by Supplier Report</h2>
                    <p style="margin: 0 0 ${filterSummaryInline ? '10px' : '0'} 0; font-size: 14px; opacity: 0.95;">Suppliers: ${sorted.length} | Total Spent: ${formatMoney(sorted.reduce((sum, s) => sum + s.totalSpent, 0))}</p>
                    ${filterSummaryInline ? `<div style="display: flex; flex-wrap: wrap; gap: 5px;">${filterSummaryInline}</div>` : ''}
                </div>`;
            
            if (sorted.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Supplier</th>
                            <th>Orders</th>
                            <th>Total Spent</th>
                            <th>Avg Order</th>
                            <th>Last Order</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                sorted.forEach(supp => {
                    const avgOrder = supp.totalSpent / supp.orderCount;
                    
                    html += `<tr>
                        <td><strong>${supp.name}</strong></td>
                        <td>${supp.orderCount}</td>
                        <td>${formatMoney(supp.totalSpent)}</td>
                        <td>${formatMoney(avgOrder)}</td>
                        <td>${supp.lastOrderDate ? supp.lastOrderDate.toLocaleDateString() : '-'}</td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['purchase-by-supplier'] = sorted;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 4. INVENTORY TURNOVER REPORT
        async function generateInventoryTurnover() {
            const inventoryResult = await apiCall('getInventoryReport');
            const salesResult = await apiCall('getSalesOrders');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!inventoryResult?.data || !salesResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const inventory = inventoryResult.data;
            const sales = salesResult.data;
            const suppliers = suppliersResult.data;
            
            // Fetch ALL sales order lines
            const allLines = [];
            for (const so of sales) {
                const lines = getSalesLinesFromCache(so.SO_ID);
                if (lines.length > 0) {
                    allLines.push(...lines);
                }
            }
            
            // Store raw data
            rawReportData['inventory-turnover'] = { inventory, sales, suppliers, allLines };
            
            // Calculate units sold per item
            const unitsSold = {};
            allLines.forEach(line => {
                const itemId = line.Item_ID;
                unitsSold[itemId] = (unitsSold[itemId] || 0) + parseInt(line.Quantity || 0);
            });
            
            // Build turnover report
            let turnoverData = inventory.map(item => {
                const sold = unitsSold[item.Item_ID] || 0;
                const onHand = parseInt(item.Qty_On_Hand) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                const backorder = parseInt(item.Qty_On_Backorder) || 0;
                const avgInventory = onHand + (sold / 2);
                const turnover = avgInventory > 0 ? sold / avgInventory : 0;
                
                // Calculate cost from package cost
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPackage;
                const value = onHand * unitCost;
                
                return {
                    id: item.Item_ID,
                    description: item.Item_Description,
                    sku: item.SKU,
                    supplierId: item.Supplier_ID,
                    onHand: onHand,
                    onOrder: onOrder,
                    backorder: backorder,
                    sold: sold,
                    turnover: turnover,
                    value: value,
                    status: turnover > 4 ? 'Fast' : turnover > 2 ? 'Normal' : 'Slow'
                };
            });
            
            // APPLY FILTERS - use matchesFilter for multi-select support
            if (reportFilters.supplier) {
                turnoverData = turnoverData.filter(item => matchesFilter(item.supplierId, reportFilters.supplier));
            }
            if (reportFilters.turnoverStatus) {
                turnoverData = turnoverData.filter(item => item.status === reportFilters.turnoverStatus);
            }
            if (reportFilters.minAmount) {
                turnoverData = turnoverData.filter(item => item.value >= reportFilters.minAmount);
            }
            
            // Sort by turnover
            turnoverData.sort((a, b) => b.turnover - a.turnover);
            
            // Build supplier list for filter
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('inventory-turnover', {
                supplier: true,
                supplierList: supplierList,
                turnoverStatus: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3> Inventory Turnover Report</h3>
                    <p style="color: #666;">Total Items: ${turnoverData.length}</p>
                    
                </div>`;
            
            if (turnoverData.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>On Hand</th>
                            <th>Backorder</th>
                            <th>On Order</th>
                            <th>Units Sold</th>
                            <th>Turnover Rate</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                turnoverData.forEach(item => {
                    const statusColor = item.status === 'Fast' ? 'green' : item.status === 'Normal' ? 'orange' : 'red';
                    const qtyOnOrder = parseFloat(item.onOrder) || 0;
                    const backorder = parseInt(item.backorder) || 0;
                    
                    html += `<tr>
                        <td><strong>${item.description}</strong></td>
                        <td>${item.sku}</td>
                        <td>${item.onHand}</td>
                        <td style="color: ${backorder > 0 ? '#b88a8a' : '#666'}; font-weight: ${backorder > 0 ? '600' : 'normal'};">${backorder > 0 ? backorder : '-'}</td>
                        <td><span style="background: ${qtyOnOrder > 0 ? '#b8a86b' : '#e0e0e0'}; padding: 3px 8px; border-radius: 4px; font-weight: bold;">${qtyOnOrder}</span></td>
                        <td>${item.sold}</td>
                        <td>${item.turnover.toFixed(2)}</td>
                        <td style="color: ${statusColor}; font-weight: bold;">${item.status}</td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['inventory-turnover'] = turnoverData;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 5. GROSS MARGIN REPORT
        async function generateGrossMargin() {
            const itemsResult = await apiCall('getItems');
            const salesResult = await apiCall('getSalesOrders');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!itemsResult?.data || !salesResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const sales = salesResult.data;
            const suppliers = suppliersResult.data;
            
            // Store raw data
            rawReportData['gross-margin'] = { items, sales, suppliers };
            
            // Calculate margin per item
            let marginData = items.map(item => {
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const cost = packageCost / unitsPerPackage;
                const sell = parseFloat(item.Unit_Sell_Price) || 0;
                const margin = sell - cost;
                const marginPercent = sell > 0 ? (margin / sell) * 100 : 0;
                
                // Calculate units sold
                let unitsSold = 0;
                sales.forEach(so => {
                    // Parse lines if they're stored as JSON string
                    let lines = so.lines;
                    if (typeof lines === 'string') {
                        try {
                            lines = JSON.parse(lines);
                        } catch (e) {
                            lines = [];
                        }
                    }
                    
                    if (lines && Array.isArray(lines)) {
                        lines.forEach(line => {
                            if ((line.itemId || line.Item_ID) === item.Item_ID) {
                                unitsSold += parseInt(line.quantity || line.Quantity || 0);
                            }
                        });
                    }
                });
                
                const totalProfit = margin * unitsSold;
                
                return {
                    id: item.Item_ID,
                    description: item.Item_Description,
                    sku: item.SKU,
                    supplierId: item.Supplier_ID,
                    cost: cost,
                    sell: sell,
                    margin: margin,
                    marginPercent: marginPercent,
                    unitsSold: unitsSold,
                    totalProfit: totalProfit
                };
            });
            
            // APPLY FILTERS - use matchesFilter for multi-select support
            if (reportFilters.supplier) {
                marginData = marginData.filter(item => matchesFilter(item.supplierId, reportFilters.supplier));
            }
            if (reportFilters.item) {
                marginData = marginData.filter(item => matchesFilter(item.id, reportFilters.item));
            }
            if (reportFilters.minAmount) {
                marginData = marginData.filter(item => item.marginPercent >= reportFilters.minAmount);
            }
            // Add max margin filter (using minAmount field with special handling)
            const maxMarginFilter = document.getElementById('filter_maxMargin');
            if (maxMarginFilter && maxMarginFilter.value) {
                const maxMargin = parseFloat(maxMarginFilter.value);
                marginData = marginData.filter(item => item.marginPercent <= maxMargin);
            }
            
            // Sort by total profit
            marginData.sort((a, b) => b.totalProfit - a.totalProfit);
            
            // Build filter lists
            const itemList = items.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters (with custom min/max margin)
            let html = buildFilterUI('gross-margin', {
                supplier: true,
                supplierList: supplierList,
                item: true,
                itemList: itemList,
                minAmount: false // We'll add custom margin filters
            });
            
            // Add custom min/max margin filters
            const filterDiv = html.lastIndexOf('</div>');
            html = html.substring(0, filterDiv) + `
                <div class="form-group">
                    <label>Min Margin %</label>
                    <input type="number" id="filter_minMargin" step="0.1" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Max Margin %</label>
                    <input type="number" id="filter_maxMargin" step="0.1" placeholder="100">
                </div>
            ` + html.substring(filterDiv);
            
            const totalProfit = marginData.reduce((sum, item) => sum + item.totalProfit, 0);
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3> Gross Margin Report</h3>
                    <p style="color: #666;">Total Products: ${marginData.length} | Total Profit: ${formatMoney(totalProfit)}</p>
                    
                </div>`;
            
            if (marginData.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Cost</th>
                            <th>Sell</th>
                            <th>Margin</th>
                            <th>Margin %</th>
                            <th>Units Sold</th>
                            <th>Total Profit</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                marginData.forEach(item => {
                    const marginColor = item.marginPercent > 40 ? 'green' : item.marginPercent > 20 ? 'orange' : 'red';
                    
                    html += `<tr>
                        <td><strong>${item.description}</strong></td>
                        <td>${item.sku}</td>
                        <td>${formatMoney(item.cost)}</td>
                        <td>${formatMoney(item.sell)}</td>
                        <td>${formatMoney(item.margin)}</td>
                        <td style="color: ${marginColor}; font-weight: bold;">${item.marginPercent.toFixed(1)}%</td>
                        <td>${item.unitsSold}</td>
                        <td style="font-weight: bold;">${formatMoney(item.totalProfit)}</td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['gross-margin'] = marginData;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 6. ACCOUNTS RECEIVABLE REPORT (Who owes you money)
        async function generateAccountsReceivable() {
            const salesResult = await apiCall('getSalesOrders');
            const customersResult = await apiCall('getCustomers');
            
            if (!salesResult?.data || !customersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const customers = customersResult.data;
            const sales = salesResult.data;
            
            // Store raw data
            rawReportData['accounts-receivable'] = { sales, customers };
            
            // Filter for unpaid/partial invoices
            let receivables = sales
                .filter(so => {
                    const status = so.Payment_Status || 'Unpaid';
                    return status !== 'Paid';
                })
                .map(so => {
                    const customer = customers.find(c => c.Customer_ID === so.Customer_ID);
                    const total = parseFloat(so.Total_Amount || so.Order_Total || 0);
                    const paid = parseFloat(so.Amount_Paid || 0);
                    const balance = total - paid;
                    const dueDate = so.Due_Date ? new Date(so.Due_Date) : null;
                    const today = new Date();
                    const daysOverdue = dueDate ? Math.floor((today - dueDate) / (1000 * 60 * 60 * 24)) : 0;
                    
                    let aging = 'Current';
                    if (daysOverdue > 60) aging = '60+ days';
                    else if (daysOverdue > 30) aging = '31-60 days';
                    else if (daysOverdue > 0) aging = '1-30 days';
                    
                    return {
                        customerId: so.Customer_ID,
                        customer: customer?.Customer_Name || so.Customer_ID,
                        invoiceId: so.SO_ID,
                        invoiceDate: new Date(so.Sale_Date || so.SO_Date).toLocaleDateString(),
                        dueDate: dueDate ? dueDate.toLocaleDateString() : '-',
                        total: total,
                        paid: paid,
                        balance: balance,
                        status: so.Payment_Status || 'Unpaid',
                        daysOverdue: daysOverdue,
                        aging: aging,
                        agingCategory: aging // For filtering
                    };
                });
            
            // APPLY FILTERS - use matchesFilter for multi-select support
            if (reportFilters.customer) {
                receivables = receivables.filter(r => matchesFilter(r.customerId, reportFilters.customer));
            }
            if (reportFilters.minAmount) {
                receivables = receivables.filter(r => r.balance >= reportFilters.minAmount);
            }
            if (reportFilters.paymentStatus) {
                if (reportFilters.paymentStatus === 'Overdue') {
                    receivables = receivables.filter(r => r.daysOverdue > 0);
                } else {
                    receivables = receivables.filter(r => r.status === reportFilters.paymentStatus);
                }
            }
            if (reportFilters.aging) {
                const agingFilter = reportFilters.aging;
                if (agingFilter === '1-30') {
                    receivables = receivables.filter(r => r.aging === '1-30 days');
                } else if (agingFilter === '31-60') {
                    receivables = receivables.filter(r => r.aging === '31-60 days');
                } else if (agingFilter === '60+') {
                    receivables = receivables.filter(r => r.aging === '60+ days');
                } else if (agingFilter === 'Current') {
                    receivables = receivables.filter(r => r.aging === 'Current');
                }
            }
            
            // Sort by days overdue
            receivables.sort((a, b) => b.daysOverdue - a.daysOverdue);
            
            const totalOutstanding = receivables.reduce((sum, r) => sum + r.balance, 0);
            
            // Build customer list for filter
            const customerList = customers.map(c => ({ id: c.Customer_ID, name: c.Customer_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('accounts-receivable', {
                customer: true,
                customerList: customerList,
                paymentStatus: true,
                aging: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3> Accounts Receivable Report</h3>
                    <p style="color: #666;">Outstanding Invoices: ${receivables.length} | Total AR: ${formatMoney(totalOutstanding)}</p>
                    
                </div>`;
            
            if (receivables.length === 0) {
                html += '<p style="color: green; font-size: 18px; text-align: center; padding: 40px;"> All invoices paid! No outstanding receivables.</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Invoice #</th>
                            <th>Invoice Date</th>
                            <th>Due Date</th>
                            <th>Total</th>
                            <th>Paid</th>
                            <th>Balance Due</th>
                            <th>Days Overdue</th>
                            <th>Aging</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                receivables.forEach(r => {
                    const statusColor = r.status === 'Overdue' || r.daysOverdue > 0 ? 'red' : 'orange';
                    const agingColor = r.daysOverdue > 60 ? 'red' : r.daysOverdue > 30 ? 'orange' : r.daysOverdue > 0 ? '#f39c12' : 'green';
                    
                    html += `<tr>
                        <td><a href="javascript:void(0)" onclick="openCustomer('${r.customerId}')" style="color: #667eea; text-decoration: none;"><strong>${r.customer}</strong></a></td>
                        <td><a href="javascript:void(0)" onclick="openSalesOrder('${r.invoiceId}')" style="color: #667eea; text-decoration: none;"><strong>${r.invoiceId}</strong></a></td>
                        <td>${r.invoiceDate}</td>
                        <td>${r.dueDate}</td>
                        <td>${formatMoney(r.total)}</td>
                        <td>${formatMoney(r.paid)}</td>
                        <td style="font-weight: bold; color: ${statusColor};">${formatMoney(r.balance)}</td>
                        <td style="color: ${r.daysOverdue > 0 ? 'red' : 'green'};">${r.daysOverdue > 0 ? r.daysOverdue : '-'}</td>
                        <td style="color: ${agingColor}; font-weight: bold;">${r.aging}</td>
                        <td style="color: ${statusColor};">${r.status}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            }
            
            reportData['accounts-receivable'] = receivables;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 7. ACCOUNTS PAYABLE REPORT (Who you owe money to)
        async function generateAccountsPayable() {
            const purchasesResult = await apiCall('getPurchaseOrders');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!purchasesResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            const purchases = purchasesResult.data;
            
            // Store raw data
            rawReportData['accounts-payable'] = { purchases, suppliers };
            
            // Filter for unpaid/partial invoices
            let payables = purchases
                .filter(po => {
                    const status = po.Payment_Status || 'Unpaid';
                    return status !== 'Paid';
                })
                .map(po => {
                    const supplier = suppliers.find(s => s.Supplier_ID === po.Supplier_ID);
                    const total = parseFloat(po.Total_Amount || po.Invoice_Total || 0);
                    const paid = parseFloat(po.Amount_Paid || 0);
                    const balance = total - paid;
                    const dueDate = po.Due_Date ? new Date(po.Due_Date) : null;
                    const today = new Date();
                    const daysOverdue = dueDate ? Math.floor((today - dueDate) / (1000 * 60 * 60 * 24)) : 0;
                    
                    let aging = 'Current';
                    if (daysOverdue > 60) aging = '60+ days';
                    else if (daysOverdue > 30) aging = '31-60 days';
                    else if (daysOverdue > 0) aging = '1-30 days';
                    
                    return {
                        supplierId: po.Supplier_ID,
                        supplier: supplier?.Supplier_Name || po.Supplier_ID,
                        invoiceId: po.Invoice_Number || po.PO_ID,
                        poId: po.PO_ID,
                        invoiceDate: new Date(po.PO_Date).toLocaleDateString(),
                        dueDate: dueDate ? dueDate.toLocaleDateString() : '-',
                        total: total,
                        paid: paid,
                        balance: balance,
                        status: po.Payment_Status || 'Unpaid',
                        daysOverdue: daysOverdue,
                        aging: aging,
                        agingCategory: aging // For filtering
                    };
                });
            
            // APPLY FILTERS - use matchesFilter for multi-select support
            if (reportFilters.supplier) {
                payables = payables.filter(p => matchesFilter(p.supplierId, reportFilters.supplier));
            }
            if (reportFilters.minAmount) {
                payables = payables.filter(p => p.balance >= reportFilters.minAmount);
            }
            if (reportFilters.paymentStatus) {
                if (reportFilters.paymentStatus === 'Overdue') {
                    payables = payables.filter(p => p.daysOverdue > 0);
                } else {
                    payables = payables.filter(p => p.status === reportFilters.paymentStatus);
                }
            }
            if (reportFilters.aging) {
                const agingFilter = reportFilters.aging;
                if (agingFilter === '1-30') {
                    payables = payables.filter(p => p.aging === '1-30 days');
                } else if (agingFilter === '31-60') {
                    payables = payables.filter(p => p.aging === '31-60 days');
                } else if (agingFilter === '60+') {
                    payables = payables.filter(p => p.aging === '60+ days');
                } else if (agingFilter === 'Current') {
                    payables = payables.filter(p => p.aging === 'Current');
                }
            }
            
            // Sort by days overdue
            payables.sort((a, b) => b.daysOverdue - a.daysOverdue);
            
            const totalOutstanding = payables.reduce((sum, p) => sum + p.balance, 0);
            
            // Build supplier list for filter
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('accounts-payable', {
                supplier: true,
                supplierList: supplierList,
                paymentStatus: true,
                aging: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3> Accounts Payable Report</h3>
                    <p style="color: #666;">Outstanding Bills: ${payables.length} | Total AP: ${formatMoney(totalOutstanding)}</p>
                    
                </div>`;
            
            if (payables.length === 0) {
                html += '<p style="color: green; font-size: 18px; text-align: center; padding: 40px;"> All bills paid! No outstanding payables.</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Supplier</th>
                            <th>Invoice #</th>
                            <th>PO #</th>
                            <th>Invoice Date</th>
                            <th>Due Date</th>
                            <th>Total</th>
                            <th>Paid</th>
                            <th>Balance Due</th>
                            <th>Days Overdue</th>
                            <th>Aging</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                payables.forEach(p => {
                    const statusColor = p.daysOverdue > 0 ? 'red' : 'orange';
                    const agingColor = p.daysOverdue > 60 ? 'red' : p.daysOverdue > 30 ? 'orange' : p.daysOverdue > 0 ? '#f39c12' : 'green';
                    
                    html += `<tr>
                        <td><a href="javascript:void(0)" onclick="openSupplier('${p.supplierId}')" style="color: #667eea; text-decoration: none;"><strong>${p.supplier}</strong></a></td>
                        <td>${p.invoiceId}</td>
                        <td><a href="javascript:void(0)" onclick="openPurchaseOrder('${p.poId}')" style="color: #667eea; text-decoration: none;"><strong>${p.poId}</strong></a></td>
                        <td>${p.invoiceDate}</td>
                        <td>${p.dueDate}</td>
                        <td>${formatMoney(p.total)}</td>
                        <td>${formatMoney(p.paid)}</td>
                        <td style="font-weight: bold; color: ${statusColor};">${formatMoney(p.balance)}</td>
                        <td style="color: ${p.daysOverdue > 0 ? 'red' : 'green'};">${p.daysOverdue > 0 ? p.daysOverdue : '-'}</td>
                        <td style="color: ${agingColor}; font-weight: bold;">${p.aging}</td>
                        <td style="color: ${statusColor};">${p.status}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            }
            
            reportData['accounts-payable'] = payables;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 8. SIMPLE INVENTORY REPORT
        async function generateSimpleInventory() {
            const inventoryResult = await apiCall('getInventoryReport');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!inventoryResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            let inventory = inventoryResult.data;
            
            // Store raw data
            rawReportData['simple-inventory'] = { inventory, suppliers };
            
            // APPLY FILTERS - use matchesFilter for multi-select support
            if (reportFilters.supplier) {
                inventory = inventory.filter(item => matchesFilter(item.Supplier_ID, reportFilters.supplier));
            }
            if (reportFilters.item) {
                inventory = inventory.filter(item => matchesFilter(item.Item_ID, reportFilters.item));
            }
            if (reportFilters.stockStatus) {
                if (reportFilters.stockStatus === 'negative') {
                    inventory = inventory.filter(item => parseFloat(item.Qty_On_Hand || 0) < 0);
                } else if (reportFilters.stockStatus === 'out') {
                    inventory = inventory.filter(item => parseFloat(item.Qty_On_Hand || 0) === 0);
                } else if (reportFilters.stockStatus === 'low') {
                    inventory = inventory.filter(item => {
                        const qty = parseFloat(item.Qty_On_Hand || 0);
                        const reorder = parseFloat(item.Reorder_Point || 0);
                        return qty > 0 && qty <= reorder;
                    });
                } else if (reportFilters.stockStatus === 'ok') {
                    inventory = inventory.filter(item => {
                        const qty = parseFloat(item.Qty_On_Hand || 0);
                        const reorder = parseFloat(item.Reorder_Point || 0);
                        return qty > reorder;
                    });
                }
            }
            if (reportFilters.minAmount) {
                inventory = inventory.filter(item => parseFloat(item.Total_Value || 0) >= reportFilters.minAmount);
            }
            
            // Sort alphabetically
            inventory.sort((a, b) => a.Item_Description.localeCompare(b.Item_Description));
            
            const totalValue = inventory.reduce((sum, item) => sum + parseFloat(item.Total_Value || 0), 0);
            const totalItems = inventory.length;
            const lowStockCount = inventory.filter(item => item.Low_Stock).length;
            
            // Build filter lists
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            const itemList = inventoryResult.data.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            
            // Build HTML with filters
            let html = buildFilterUI('simple-inventory', {
                supplier: true,
                supplierList: supplierList,
                item: true,
                itemList: itemList,
                stockStatus: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3> Inventory List Report</h3>
                    <p style="color: #666;">
                        Total Items: ${totalItems} | 
                        Total Value: ${formatMoney(totalValue)} | 
                        Low Stock Items: ${lowStockCount}
                    </p>
                    
                </div>`;
            
            if (inventory.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No items match your filters</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Description</th>
                            <th>Supplier</th>
                            <th>UOM</th>
                            <th>Qty On Hand</th>
                            <th>Backorder</th>
                            <th>On Order</th>
                            <th>Reorder Point</th>
                            <th>Cost</th>
                            <th>Sell Price</th>
                            <th>Total Value</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                inventory.forEach(item => {
                    const lowStock = item.Low_Stock;
                    const qtyOnOrder = parseFloat(item.Qty_On_Order) || 0;
                    const backorder = parseInt(item.Qty_On_Backorder) || 0;
                    const rowStyle = lowStock ? 'background: #f0e8d0;' : '';
                    const status = lowStock ? ' Low Stock' : ' OK';
                    const statusColor = lowStock ? '#f39c12' : 'green';
                    
                    html += `<tr style="${rowStyle}">
                        <td><strong>${item.SKU || '-'}</strong></td>
                        <td>${item.Item_Description}</td>
                        <td>${getSupplierName(item.Supplier_ID)}</td>
                        <td>${item.UOM}</td>
                        <td style="font-weight: bold;">${item.Qty_On_Hand}</td>
                        <td style="color: ${backorder > 0 ? '#b88a8a' : '#666'}; font-weight: ${backorder > 0 ? '600' : 'normal'};">${backorder > 0 ? backorder : '-'}</td>
                        <td><span style="background: ${qtyOnOrder > 0 ? '#b8a86b' : '#e0e0e0'}; padding: 3px 8px; border-radius: 4px; font-weight: bold;">${qtyOnOrder}</span></td>
                        <td>${item.Reorder_Point}</td>
                        <td>${formatMoney(parseFloat(item.Package_Cost) / parseFloat(item.Units_Per_Package || 1))}</td>
                        <td>${formatMoney(parseFloat(item.Unit_Sell_Price))}</td>
                        <td>${formatMoney(parseFloat(item.Total_Value))}</td>
                        <td style="color: ${statusColor}; font-weight: bold;">${status}</td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['simple-inventory'] = inventory;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // ==================== HOT LINK FUNCTIONS ====================
        
        async function openSalesOrder(soId) {
            // Remember current tab to return to later
            const currentTab = document.querySelector('.card.active');
            if (currentTab && currentTab.id === 'reports') {
                returnToTab = 'reports';
            } else {
                returnToTab = null;
            }
            
            // Load the sales order and open edit modal
            const result = await apiCall('getSalesOrders');
            const so = result.data.find(s => s.SO_ID === soId);
            if (so) {
                // Switch to Sales tab and show the order
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="sales"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('sales').classList.add('active');
                
                // Open the order details modal
                await showSalesOrderDetails(so);
                document.getElementById('orderModal').style.display = 'block'; document.body.classList.add('modal-open');
            } else {
                showError('Sales order not found: ' + soId);
            }
        }
        
        async function openPurchaseOrder(poId) {
            // Remember current tab to return to later
            const currentTab = document.querySelector('.card.active');
            if (currentTab && currentTab.id === 'reports') {
                returnToTab = 'reports';
            } else {
                returnToTab = null;
            }
            
            // Load the purchase order and open edit modal
            const result = await apiCall('getPurchaseOrders');
            const po = result.data.find(p => p.PO_ID === poId);
            if (po) {
                // Switch to Purchases tab and show the order
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="purchases"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('purchases').classList.add('active');
                
                // Open the order details modal
                await showPurchaseOrderDetails(po);
                document.getElementById('orderModal').style.display = 'block'; document.body.classList.add('modal-open');
            } else {
                showError('Purchase order not found: ' + poId);
            }
        }
        
        async function openCustomer(customerId) {
            // Remember current tab to return to later
            const currentTab = document.querySelector('.card.active');
            if (currentTab && currentTab.id === 'reports') {
                returnToTab = 'reports';
            } else {
                returnToTab = null;
            }
            
            // Load customer and open edit modal
            const result = await apiCall('getCustomers');
            const customer = result.data.find(c => c.Customer_ID === customerId);
            if (customer) {
                // Switch to Customers tab
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="customers"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('customers').classList.add('active');
                
                // Show edit form
                showEditCustomerForm(customer);
            } else {
                showError('Customer not found: ' + customerId);
            }
        }
        
        async function openSupplier(supplierId) {
            // Remember current tab to return to later
            const currentTab = document.querySelector('.card.active');
            if (currentTab && currentTab.id === 'reports') {
                returnToTab = 'reports';
            } else {
                returnToTab = null;
            }
            
            // Load supplier and open edit modal
            const result = await apiCall('getSuppliers');
            const supplier = result.data.find(s => s.Supplier_ID === supplierId);
            if (supplier) {
                // Switch to Suppliers tab
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="suppliers"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('suppliers').classList.add('active');
                
                // Show edit form
                showEditSupplierForm(supplier);
            } else {
                showError('Supplier not found: ' + supplierId);
            }
        }
        
        async function openItem(itemId) {
            // Load items if not cached
            if (cachedItems.length === 0) {
                const result = await apiCall('getItems');
                if (result && result.status === 'success') {
                    cachedItems = result.data;
                }
            }
            
            // FIX #5: Add null checking to prevent errors
            // Switch to Items tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Find the items tab more reliably
            const itemsTab = document.querySelector('.tab[onclick*="showSection"][onclick*="items"]') || 
                             document.querySelector('.tab[onclick*="items"]');
            
            if (itemsTab) {
                itemsTab.classList.add('active');
            }
            
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            
            const itemsCard = document.getElementById('items');
            if (itemsCard) {
                itemsCard.classList.add('active');
            }
            
            // Call editItemById which handles the edit form
            editItemById(itemId);
        }
        
        
        // ==================== CREATE PO (PRINT ONLY) FUNCTIONS ====================
        
        // Add supplier check to createpo-item selects on focus AND click
        document.addEventListener('focusin', function(e) {
            if (e.target.classList.contains('createpo-item')) {
                const supplierId = document.getElementById('createPOSupplier')?.value;
                if (!supplierId) {
                    e.preventDefault();
                    e.target.blur(); // Remove focus
                    showWarning('Please select a supplier first');
                    document.getElementById('createPOSupplier')?.focus();
                }
            }
        });
        
        // Also catch mousedown/touchstart to prevent dropdown from opening
        document.addEventListener('mousedown', function(e) {
            if (e.target.classList.contains('createpo-item')) {
                const supplierId = document.getElementById('createPOSupplier')?.value;
                if (!supplierId) {
                    e.preventDefault();
                    e.stopPropagation();
                    showWarning('Please select a supplier first');
                    document.getElementById('createPOSupplier')?.focus();
                }
            }
        });
        
        document.addEventListener('touchstart', function(e) {
            if (e.target.classList.contains('createpo-item')) {
                const supplierId = document.getElementById('createPOSupplier')?.value;
                if (!supplierId) {
                    e.preventDefault();
                    e.stopPropagation();
                    setTimeout(() => {
                        showWarning('Please select a supplier first');
                        document.getElementById('createPOSupplier')?.focus();
                    }, 10);
                }
            }
        }, { passive: false });
        
        function filterItemsBySupplier() {
            const supplierId = document.getElementById('createPOSupplier').value;
            const itemSelects = document.querySelectorAll('.createpo-item');
            const qtyInputs = document.querySelectorAll('#createPOLineItems .createpo-qty');
            
            if (!supplierId) {
                // No supplier selected - disable all line item controls
                itemSelects.forEach(select => {
                    select.disabled = true;
                    select.style.border = '2px solid #ccc';
                    select.style.background = '#f5f5f5';
                    select.innerHTML = '<option value=""> Select Supplier First</option>';
                });
                qtyInputs.forEach(input => {
                    input.disabled = true;
                });
                calculateCreatePOTotal();
                return;
            }
            
            // Filter items by supplier (exclude archived)
            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId && item.Status !== 'Archived');
            
            itemSelects.forEach(select => {
                // Enable and style
                select.disabled = false;
                select.style.border = '2px solid #667eea';
                select.style.background = 'white';
                
                // Clear existing options
                select.innerHTML = '<option value="">Select item...</option>';
                
                supplierItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.Item_ID;
                    option.textContent = `${item.SKU || item.Item_ID} - ${item.Item_Description}`;
                    option.dataset.cost = item.Package_Cost || 0;
                    option.dataset.units = item.Units_Per_Package || 1;
                    select.appendChild(option);
                });
            });
            
            // Enable quantity inputs
            qtyInputs.forEach(input => {
                input.disabled = false;
            });
            
            calculateCreatePOTotal();
        }
        
        function addCreatePOLineItem() {
            const container = document.getElementById('createPOLineItems');
            const supplierId = document.getElementById('createPOSupplier').value;
            
            if (!supplierId) {
                showWarning('Please select a supplier first');
                return;
            }
            
            const newRow = document.createElement('div');
            newRow.className = 'line-item-row';
            newRow.style.cssText = 'display: grid; grid-template-columns: 2.5fr 1fr 0.6fr 0.8fr 0.8fr 0.8fr 50px; gap: 8px; margin-bottom: 10px; align-items: end;';
            newRow.innerHTML = `
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                    <select class="createpo-item" style="width: 100%; padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white;" onchange="updateCreatePOItemCost(this)">
                        <option value="">Select item...</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Cases</label>
                    <input type="number" class="createpo-qty" placeholder="0" min="1" oninput="calculateCreatePOTotal()" style="width: 100%; padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px;">
                </div>
                <div style="margin-top: 26px;">
                    <div class="createpo-units" style="text-align: center; font-size: 14px; color: #666; padding: 6px;">-</div>
                </div>
                <div style="margin-top: 26px;">
                    <div class="createpo-totalunits" style="text-align: center; font-size: 16px; font-weight: bold; color: var(--primary, #667eea); padding: 6px;">-</div>
                </div>
                <div style="margin-top: 26px;">
                    <div class="createpo-cost" style="text-align: center; font-size: 14px; font-weight: bold; color: #6b9a8d; background: #e8f5e9; padding: 10px; border-radius: 6px;">-</div>
                </div>
                <div style="margin-top: 26px;">
                    <div class="createpo-linetotal" style="text-align: right; font-size: 14px; font-weight: bold; color: var(--primary, #667eea); background: var(--primary-light, #E3F2FD); padding: 10px; border-radius: 6px;">$0.00</div>
                </div>
                <button type="button" class="btn-danger" onclick="removeLineItem(this); calculateCreatePOTotal();" style="width: 100%; padding: 10px; font-size: 14px; margin-top: 26px;"></button>
            `;
            
            container.appendChild(newRow);
            
            // Populate the new select with filtered items
            const itemSelect = newRow.querySelector('.createpo-item');
            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
            supplierItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.Item_ID;
                option.textContent = `${item.SKU || item.Item_ID} - ${item.Item_Description}`;
                option.dataset.cost = item.Package_Cost || 0;
                option.dataset.units = item.Units_Per_Package || 1;
                itemSelect.appendChild(option);
            });
        }
        
        function updateCreatePOItemCost(selectElement) {
            const row = selectElement.closest('.line-item-row');
            const costDiv = row.querySelector('.createpo-cost');
            const unitsDiv = row.querySelector('.createpo-units');
            const qtyInput = row.querySelector('.createpo-qty');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.cost) {
                const cost = parseFloat(selectedOption.dataset.cost);
                const units = parseFloat(selectedOption.dataset.units) || 1;
                
                costDiv.textContent = '$' + cost.toFixed(2);
                unitsDiv.textContent = units;
                
                // Calculate total units if qty is entered
                const qty = parseFloat(qtyInput.value) || 0;
                const totalUnitsDiv = row.querySelector('.createpo-totalunits');
                totalUnitsDiv.textContent = qty > 0 ? (qty * units) : '-';
            } else {
                costDiv.textContent = '-';
                unitsDiv.textContent = '-';
                row.querySelector('.createpo-totalunits').textContent = '-';
            }
            
            calculateCreatePOTotal();
        }
        
        function calculateCreatePOTotal() {
            let totalCost = 0;
            let totalCases = 0;
            let totalUnits = 0;
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            
            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                const costDiv = row.querySelector('.createpo-cost');
                const unitsDiv = row.querySelector('.createpo-units');
                const totalUnitsDiv = row.querySelector('.createpo-totalunits');
                const lineTotalDiv = row.querySelector('.createpo-linetotal');
                
                // Get cost from text (strip $ and parse)
                const costText = costDiv.textContent.replace('$', '');
                const cost = costText === '-' ? 0 : parseFloat(costText);
                
                // Get units per case
                const unitsText = unitsDiv.textContent;
                const unitsPerCase = unitsText === '-' ? 0 : parseFloat(unitsText);
                
                // Update total units for this line
                if (unitsPerCase > 0 && qty > 0) {
                    const lineUnits = qty * unitsPerCase;
                    totalUnitsDiv.textContent = lineUnits;
                    totalUnits += lineUnits;
                } else {
                    totalUnitsDiv.textContent = '-';
                }
                
                // Update line total
                const lineTotal = qty * cost;
                if (lineTotal > 0) {
                    lineTotalDiv.textContent = '$' + lineTotal.toFixed(2);
                } else {
                    lineTotalDiv.textContent = '$0.00';
                }
                
                totalCost += lineTotal;
                totalCases += qty;
            });
            
            // Update all totals
            document.getElementById('createPOTotalCases').textContent = totalCases;
            document.getElementById('createPOTotalUnits').textContent = totalUnits;
            document.getElementById('createPOTotal').textContent = '$' + totalCost.toFixed(2);
            return totalCost;
        }
        
        // ==================== OUTGOING PO FUNCTIONS ====================
        
        // Void a PO (when supplier prices changed)
        async function voidPurchaseOrder(poId) {
            const confirmed = await showConfirmModal(
                'Void Purchase Order?',
                `<strong> VOID Purchase Order ${poId}?</strong><br><br>` +
                `This will mark the PO as invalid. Use this when:<br>` +
                ` Supplier prices have changed<br>` +
                ` Order was entered incorrectly<br>` +
                ` Order is no longer needed<br><br>` +
                `The PO will remain in your records but won't affect inventory.`,
                'Void PO',
                'Cancel',
                'danger'
            );
            if (!confirmed) return;
            
            const reason = prompt('Optional: Enter reason for voiding (e.g., "Prices increased 10%"):', 'Supplier prices changed');
            
            // If user clicked Cancel on the prompt, abort
            if (reason === null) return;
            
            try {
                const result = await apiCall('updatePurchaseOrder', {
                    poId: poId,
                    status: 'Void',
                    notes: 'VOIDED - ' + (reason || 'No reason provided') + ' - ' + new Date().toLocaleDateString()
                });
                
                if (result && result.status === 'success') {
                    showStatus('purchasesStatus', ` PO ${poId} has been voided. You can copy it to create a new PO with updated prices.`, 'success');
                    closeModal();
                    loadPurchases();
                } else {
                    showError('Error voiding PO: ' + (result?.message || 'Unknown error'));
                }
            } catch (e) {
                showError('Error: ' + e.message);
            }
        }
        
        // Duplicate a PO (useful when original was voided due to price changes)
        async function duplicatePO(poId) {
            try {
                // Load the original PO
                const result = await apiCall('getPurchaseOrders');
                if (!result || result.status !== 'success') {
                    showError('Error loading purchase order');
                    return;
                }
                
                const originalPO = result.data.find(p => p.PO_ID === poId);
                if (!originalPO) {
                    showError('Purchase order not found');
                    return;
                }
                
                // Get original line items
                const linesResult = await apiCall('getPurchaseOrderLines', { poId: poId });
                const originalLines = linesResult?.data || [];
                
                if (originalLines.length === 0) {
                    showWarning('No line items found in original PO');
                    return;
                }
                
                // Confirm with user
                const itemCount = originalLines.length;
                const confirmed = await showConfirmModal(
                    ' Reorder from PO',
                    `<div style="text-align: left;">
                        <p>Create a <strong>NEW</strong> Purchase Order with <strong>${itemCount} item(s)</strong> from ${poId}?</p>
                        <p style="background: #f0e8d0; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 13px;">
                             You'll need to update prices in the new PO if they've changed.
                        </p>
                    </div>`,
                    'Create New PO',
                    'Cancel',
                    'info'
                );
                if (!confirmed) {
                    return;
                }
                
                // Skip clearing since we're pre-filling
                window.skipCreatePOClear = true;
                
                // Switch to Create PO tab
                switchTab('createpo');
                
                // Pre-select the supplier
                const supplierSelect = document.getElementById('poSupplier');
                if (supplierSelect) {
                    supplierSelect.value = originalPO.Supplier_ID;
                    await loadSupplierItems(); // Load items for this supplier
                }
                
                // Wait a moment for items to load
                setTimeout(async () => {
                    // Add each line item to the new PO
                    for (const line of originalLines) {
                        // Find the item in the dropdown and select it
                        const itemSelect = document.getElementById('poItemSelect');
                        if (itemSelect) {
                            itemSelect.value = line.Item_ID;
                            
                            // Set quantity
                            const qtyInput = document.getElementById('poItemQty');
                            if (qtyInput) {
                                qtyInput.value = line.Quantity || 1;
                            }
                            
                            // Add to PO
                            addItemToPO();
                        }
                    }
                    
                    showStatus('poStatus', ` Copied ${itemCount} items from ${poId}. Review prices and quantities, then save!`, 'success');
                    
                    // Scroll to the line items
                    const poTable = document.getElementById('poLineItemsTable');
                    if (poTable) {
                        poTable.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 500);
                
            } catch (e) {
                showError('Error duplicating PO: ' + e.message);
            }
        }
        
        async function receiveOutgoingPO(poId) {
            // Properly close any existing modal first (prevents window-in-window issue)
            const existingModal = document.getElementById('orderModal');
            if (existingModal && existingModal.style.display !== 'none') {
                existingModal.style.display = 'none';
                document.body.classList.remove('modal-open');
            }
            
            // Load the OUTGOING PO
            const result = await apiCall('getPurchaseOrders');
            if (!result || result.status !== 'success') {
                showError('Error loading purchase order');
                return;
            }
            
            const po = result.data.find(p => p.PO_ID === poId);
            if (!po) {
                showError('Purchase order not found');
                return;
            }
            
            if (po.Status !== 'Ordered' && po.Status !== 'Partial' && po.Status !== 'In Transit') {
                showWarning('This PO has already been fully received');
                // Refresh the report if it's currently displayed
                reportDataCacheTime = null;
                if (document.getElementById('reportSetupModal')?.style.display !== 'none') {
                    setTimeout(() => executeReport(), 100);
                }
                return;
            }
            
            // Load line items
            const linesResult = await apiCall('getPurchaseOrderLines', { poId: poId });
            if (!linesResult || linesResult.status !== 'success') {
                showError('Error loading PO line items');
                return;
            }
            
            const lines = linesResult.data || [];
            
            // Show receive modal
            showReceiveModal(po, lines);
        }
        
        function showReceiveModal(po, lines) {
            // Store supplier ID for adding items
            window.currentReceivePO = po;
            window.currentReceiveLines = lines;
            window.receiveLineCounter = lines.length;
            
            // Calculate overall receiving progress
            let totalOrdered = 0;
            let totalPrevReceived = 0;
            lines.forEach(line => {
                totalOrdered += parseFloat(line.Quantity) || 0;
                totalPrevReceived += parseFloat(line.Qty_Received) || 0;
            });
            const overallProgress = totalOrdered > 0 ? Math.round((totalPrevReceived / totalOrdered) * 100) : 0;
            
            let html = `
                <div class="receive-modal-content">
                    <!-- Order Info Box -->
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #6b9a8d;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <strong> Internal PO #:</strong> 
                                <span style="font-size: 18px; font-weight: bold; color: #2e7d32;">${po.Invoice_Number || po.PO_ID}</span>
                            </div>
                            <div>
                                <strong> Supplier:</strong> ${getSupplierName(po.Supplier_ID)}
                            </div>
                            <div>
                                <strong> Order Date:</strong> ${formatDateSafe(po.PO_Date)}
                            </div>
                            <div>
                                <strong> Status:</strong> 
                                <span style="background: ${po.Status === 'Received' ? '#6b9a8d' : po.Status === 'Partial' ? '#b8a07a' : '#b8a86b'}; color: ${po.Status === 'Ordered' ? 'black' : 'white'}; padding: 2px 8px; border-radius: 4px;">${po.Status}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${totalPrevReceived > 0 ? `
                    <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #7a9bb8;">
                        <strong> Receiving Progress:</strong> ${totalPrevReceived} of ${totalOrdered} items (${overallProgress}%)
                        <div style="background: #ddd; border-radius: 4px; height: 8px; margin-top: 8px; overflow: hidden;">
                            <div style="background: ${overallProgress >= 100 ? '#6b9a8d' : '#7a9bb8'}; height: 100%; width: ${Math.min(overallProgress, 100)}%;"></div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="background: #f0e8d0; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 0;"><strong> Partial Receiving Instructions:</strong></p>
                        <ul style="margin: 10px 0 0 20px; padding-left: 0;">
                            <li>Enter the <strong>"Receive Now"</strong> quantity for each item you're receiving today</li>
                            <li>Previously received quantities are shown and cannot be changed</li>
                            <li>Items already fully received show  and are locked</li>
                            <li>You can receive remaining items in multiple shipments</li>
                        </ul>
                    </div>
                    
                    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                    <table class="data-table" id="receiveItemsTable" style="table-layout: fixed; min-width: 700px; width: 100%;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th style="width: 28%; font-size: 15px; padding: 12px 8px;">Item</th>
                                <th style="width: 12%; text-align: center; font-size: 15px; padding: 12px 8px;">Ordered</th>
                                <th style="width: 12%; text-align: center; font-size: 15px; padding: 12px 8px;">Prev Recv</th>
                                <th style="width: 14%; text-align: center; font-size: 15px; padding: 12px 8px;">Receive Now</th>
                                <th style="width: 12%; text-align: center; font-size: 15px; padding: 12px 8px;">Pending</th>
                                <th style="width: 10%; text-align: center; font-size: 15px; padding: 12px 8px;">Status</th>
                                <th style="width: 12%; text-align: right; font-size: 15px; padding: 12px 8px;">Cost</th>
                            </tr>
                        </thead>
                        <tbody id="receiveItemsBody">
            `;
            
            lines.forEach((line, index) => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                const itemName = item ? item.Item_Description : line.Item_ID;
                const unitCost = parseFloat(line.Unit_Cost) || 0;
                const qtyOrdered = parseFloat(line.Quantity) || 0;
                const qtyPrevReceived = parseFloat(line.Qty_Received) || 0;
                const qtyPending = qtyOrdered - qtyPrevReceived;
                const isComplete = qtyPrevReceived >= qtyOrdered;
                const unitsPerPkg = parseFloat(item?.Units_Per_Package) || 1;
                const expectedUnits = qtyPending * unitsPerPkg;
                
                // Status indicator
                let statusBadge, statusBg;
                if (isComplete) {
                    statusBadge = '';
                    statusBg = '#e0ebe7';
                } else if (qtyPrevReceived > 0) {
                    statusBadge = '';
                    statusBg = '#f0e8d0';
                } else {
                    statusBadge = '';
                    statusBg = '#f8f9fa';
                }
                
                html += `
                    <tr id="receiveLine${index}" data-is-original="true" style="background: ${statusBg};">
                        <td style="padding: 12px; word-wrap: break-word;">
                            <strong style="font-size: 18px; line-height: 1.3; display: block;">${itemName}</strong>
                            <div style="font-size: 15px; color: #666; margin-top: 4px;">${item?.SKU || ''}</div>
                            <div style="font-size: 13px; color: #1976d2; margin-top: 4px; font-weight: 600;">
                                 ${unitsPerPkg} units/pkg ${!isComplete && qtyPending > 0 ? ` Expect <strong>${expectedUnits}</strong> units total` : ''}
                            </div>
                            ${!isComplete ? `
                            <button type="button" onclick="adjustShortPackage('${line.Item_ID}', '${itemName}', ${unitsPerPkg})" 
                                    style="margin-top: 8px; padding: 4px 10px; font-size: 12px; background: #fff3e0; color: #e65100; border: 1px solid #ffb74d; border-radius: 6px; cursor: pointer;">
                                 Short Package?
                            </button>
                            ` : ''}
                        </td>
                        <td style="text-align: center; padding: 12px 8px; font-weight: bold; font-size: 18px;">${qtyOrdered}</td>
                        <td style="text-align: center; padding: 12px 8px; color: ${qtyPrevReceived > 0 ? '#6b9a8d' : '#999'}; font-weight: ${qtyPrevReceived > 0 ? 'bold' : 'normal'}; font-size: 18px;">
                            ${qtyPrevReceived > 0 ? qtyPrevReceived : '-'}
                        </td>
                        <td style="padding: 12px 8px;">
                            ${isComplete ? `
                                <input type="number" 
                                       id="receiveQty${index}" 
                                       value="0" 
                                       disabled
                                       data-line-id="${line.Line_ID}"
                                       data-item-id="${line.Item_ID}"
                                       data-ordered="${qtyOrdered}"
                                       data-prev-received="${qtyPrevReceived}"
                                       data-cost="${unitCost}"
                                       style="width: 100%; padding: 12px; font-size: 20px; text-align: center; box-sizing: border-box; background: #e9ecef; cursor: not-allowed;">
                            ` : `
                                <input type="number" 
                                       id="receiveQty${index}" 
                                       value="${qtyPending}" 
                                       min="0" 
                                       max="${qtyPending}"
                                       step="1"
                                       data-line-id="${line.Line_ID}"
                                       data-item-id="${line.Item_ID}"
                                       data-ordered="${qtyOrdered}"
                                       data-prev-received="${qtyPrevReceived}"
                                       data-cost="${unitCost}"
                                       style="width: 100%; padding: 12px; font-size: 20px; text-align: center; box-sizing: border-box; border: 2px solid #6b9a8d;"
                                       oninput="updateReceiveLinePartial(${index})">
                            `}
                        </td>
                        <td style="text-align: center; padding: 12px 8px; font-size: 18px;" id="receivePending${index}">
                            <span style="color: ${qtyPending > 0 ? '#b88a8a' : '#6b9a8d'}; font-weight: bold;">
                                ${isComplete ? '0' : qtyPending}
                            </span>
                        </td>
                        <td style="text-align: center; padding: 12px 8px; font-size: 24px;">${statusBadge}</td>
                        <td style="text-align: right; padding: 12px 8px; font-size: 16px; font-weight: 600;">${formatMoney(unitCost)}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td colspan="3" style="text-align: right; padding: 12px;">Items to Receive:</td>
                                <td style="text-align: center; padding: 12px;" id="receiveItemCount">0</td>
                                <td colspan="2" style="text-align: right; padding: 12px;">Value:</td>
                                <td style="text-align: right; padding: 12px;" id="receiveGrandTotal">$0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                    </div>
                    
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px;">
                        <div class="form-group" style="flex: 1; min-width: 200px; margin: 0;">
                            <label style="font-weight: 600;"> Supplier's Invoice # <span style="font-weight: normal; color: #666;">(from their packing slip)</span></label>
                            <input type="text" id="receiveInvoiceNumber" value="" placeholder="Enter supplier's invoice/packing slip #..." style="width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; border: 2px solid #ddd; border-radius: 6px;">
                            <div style="font-size: 12px; color: #666; margin-top: 4px;"> Your internal PO# (${po.Invoice_Number || po.PO_ID}) will be preserved</div>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 200px; margin: 0;">
                            <label style="font-weight: 600;"> Receive Date</label>
                            <input type="date" id="receiveDate" value="${getTodayLocalDate()}" style="width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; border: 2px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label>Notes (optional)</label>
                        <textarea id="receiveNotes" rows="2" placeholder="Any discrepancies, damage, or special notes..." style="width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box;"></textarea>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalTitle').textContent = ` Receive PO: ${po.Invoice_Number || po.PO_ID}`;
            document.getElementById('modalEditBtn').style.display = 'none';
            document.getElementById('modalPrintBtn').style.display = 'none';
            document.getElementById('modalSaveBtn').style.display = 'inline-block';
            document.getElementById('modalSaveBtn').textContent = ' Receive Items into Inventory';
            document.getElementById('modalSaveBtn').onclick = () => commitReceivePartial(po.PO_ID);
            document.getElementById('orderModal').style.display = 'block'; document.body.classList.add('modal-open');
            
            // Calculate initial totals
            setTimeout(() => {
                for (let i = 0; i < lines.length; i++) {
                    updateReceiveLinePartial(i);
                }
            }, 100);
        }
        
        // Handle short package - opens quick adjust modal
        async function adjustShortPackage(itemId, itemName, unitsPerPkg) {
            const shortUnits = prompt(
                ` Short Package Adjustment\n\n` +
                `Item: ${itemName}\n` +
                `Expected: ${unitsPerPkg} units per package\n\n` +
                `How many units were MISSING from the package?\n` +
                `(Enter a positive number, e.g., 4 if only 20 of 24 received)`
            );
            
            if (shortUnits === null) return; // Cancelled
            
            const missing = parseInt(shortUnits);
            if (isNaN(missing) || missing <= 0) {
                showWarning('Please enter a valid number of missing units');
                return;
            }
            
            if (missing >= unitsPerPkg) {
                showWarning(`That's the entire package! If you didn't receive the package at all, reduce the "Receive Now" quantity instead.`);
                return;
            }
            
            // Confirm and create adjustment
            const reason = `Short Package - received ${unitsPerPkg - missing} of ${unitsPerPkg} units`;
            
            const confirmed = await showConfirmModal(
                'Create Inventory Adjustment?',
                `<strong>Item:</strong> ${itemName}<br><br>` +
                `<strong>Adjustment:</strong> -${missing} units<br>` +
                `<strong>Reason:</strong> ${reason}<br><br>` +
                `This will reduce the inventory by ${missing} units after receiving.`,
                'Create Adjustment',
                'Cancel',
                'warning'
            );
            
            if (confirmed) {
                // Create the adjustment
                apiCall('adjustInventory', {
                    itemId: itemId,
                    quantity: -missing,
                    adjustmentType: 'Manual',
                    reason: reason,
                    user: 'Receiving'
                }).then(result => {
                    if (result && result.status === 'success') {
                        showSuccess(`Adjustment recorded!<br><br>-${missing} units for: ${reason}<br><br>Continue receiving the PO normally.`);
                    } else {
                        showError('Error creating adjustment: ' + (result?.message || 'Unknown error'));
                    }
                }).catch(err => {
                    showError('Error: ' + err.message);
                });
            }
        }
        
        // Update line for partial receiving
        function updateReceiveLinePartial(index) {
            const qtyInput = document.getElementById(`receiveQty${index}`);
            const pendingSpan = document.getElementById(`receivePending${index}`);
            
            if (!qtyInput) return;
            
            const qtyOrdered = parseFloat(qtyInput.dataset.ordered) || 0;
            const qtyPrevReceived = parseFloat(qtyInput.dataset.prevReceived) || 0;
            const qtyReceiveNow = parseFloat(qtyInput.value) || 0;
            const maxReceivable = qtyOrdered - qtyPrevReceived;
            
            // Clamp value to max receivable
            if (qtyReceiveNow > maxReceivable) {
                qtyInput.value = maxReceivable;
            }
            if (qtyReceiveNow < 0) {
                qtyInput.value = 0;
            }
            
            const actualReceiveNow = parseFloat(qtyInput.value) || 0;
            const newPending = maxReceivable - actualReceiveNow;
            
            // Update pending display
            if (pendingSpan) {
                pendingSpan.innerHTML = `<span style="color: ${newPending > 0 ? '#b88a8a' : '#6b9a8d'}; font-weight: bold;">${newPending}</span>`;
            }
            
            // Recalculate totals
            recalculateReceiveTotalPartial();
        }
        
        function recalculateReceiveTotalPartial() {
            let totalItems = 0;
            let totalValue = 0;
            
            document.querySelectorAll('#receiveItemsBody tr').forEach(row => {
                const qtyInput = row.querySelector('input[type="number"]');
                if (qtyInput && !qtyInput.disabled) {
                    const qty = parseFloat(qtyInput.value) || 0;
                    const cost = parseFloat(qtyInput.dataset.cost) || 0;
                    if (qty > 0) {
                        totalItems += qty;
                        totalValue += qty * cost;
                    }
                }
            });
            
            const itemCountEl = document.getElementById('receiveItemCount');
            const grandTotalEl = document.getElementById('receiveGrandTotal');
            
            if (itemCountEl) itemCountEl.textContent = totalItems;
            if (grandTotalEl) grandTotalEl.textContent = '$' + totalValue.toFixed(2);
        }
        
        // Commit partial receive
        let isCommittingReceivePartial = false;
        
        async function commitReceivePartial(poId) {
            if (isCommittingReceivePartial) {
                console.log('Already committing, ignoring duplicate click');
                return;
            }
            
            // SAFETY CHECK: Re-verify PO status before receiving
            const poCheck = await apiCall('getPurchaseOrders');
            if (poCheck && poCheck.status === 'success') {
                const currentPO = poCheck.data.find(p => p.PO_ID === poId);
                if (!currentPO) {
                    showError('Error: Purchase order not found. It may have been deleted.');
                    return;
                }
                if (currentPO.Status === 'Received') {
                    showWarning('This PO has already been fully received!\n\nInventory was already updated. No changes made.');
                    document.getElementById('orderModal').style.display = 'none';
                    document.body.classList.remove('modal-open');
                    loadPurchases();
                    // Refresh the report if it's currently displayed
                    reportDataCacheTime = null;
                    if (document.getElementById('reportSetupModal')?.style.display !== 'none') {
                        setTimeout(() => executeReport(), 100);
                    }
                    return;
                }
            }
            
            const notes = document.getElementById('receiveNotes')?.value || '';
            const invoiceNumber = document.getElementById('receiveInvoiceNumber')?.value || '';
            const receiveDate = document.getElementById('receiveDate')?.value || '';
            
            // Collect lines to receive with full item details
            const linesToReceive = [];
            let totalValue = 0;
            let totalUnits = 0;
            
            document.querySelectorAll('#receiveItemsBody tr[data-is-original="true"]').forEach(row => {
                const qtyInput = row.querySelector('input[type="number"]');
                if (qtyInput && !qtyInput.disabled) {
                    const qtyToReceive = parseFloat(qtyInput.value) || 0;
                    const lineId = qtyInput.dataset.lineId;
                    const itemId = qtyInput.dataset.itemId;
                    const unitCost = parseFloat(qtyInput.dataset.cost) || 0;
                    
                    if (qtyToReceive > 0 && lineId) {
                        const item = cachedItems.find(i => i.Item_ID === itemId);
                        const unitsPerPkg = parseFloat(item?.Units_Per_Package) || 1;
                        const lineUnits = qtyToReceive * unitsPerPkg;
                        const lineTotal = qtyToReceive * unitCost;
                        
                        linesToReceive.push({
                            lineId: lineId,
                            itemId: itemId,
                            qtyToReceive: qtyToReceive,
                            itemName: item?.Item_Description || itemId,
                            sku: item?.SKU || '',
                            unitCost: unitCost,
                            unitsPerPkg: unitsPerPkg,
                            totalUnits: lineUnits,
                            lineTotal: lineTotal
                        });
                        
                        totalValue += lineTotal;
                        totalUnits += lineUnits;
                    }
                }
            });
            
            if (linesToReceive.length === 0) {
                showWarning('No items to receive. Enter quantities greater than 0.');
                return;
            }
            
            // Get PO and supplier info
            const po = window.currentReceivePO;
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === po.Supplier_ID);
            const supplierName = supplier?.Supplier_Name || 'Unknown Supplier';
            
            // Show detailed preview modal
            const confirmed = await showReceivePreviewModal(po, supplierName, linesToReceive, totalValue, totalUnits, receiveDate, invoiceNumber);
            if (!confirmed) return;
            
            isCommittingReceivePartial = true;
            const commitBtn = document.getElementById('modalSaveBtn');
            const closeBtn = document.getElementById('modalCloseBtn');
            if (commitBtn) {
                commitBtn.disabled = true;
                commitBtn.textContent = ' Processing...';
            }
            if (closeBtn) {
                closeBtn.disabled = true;
                closeBtn.style.opacity = '0.5';
                closeBtn.style.cursor = 'not-allowed';
            }
            
            try {
                showLoading('Receiving Items...');
                const data = {
                    poId: poId,
                    notes: notes,
                    lines: linesToReceive.map(l => ({ lineId: l.lineId, qtyToReceive: l.qtyToReceive }))
                };
                
                console.log('Calling receivePOItems with:', JSON.stringify(data));
                
                const result = await apiCall('receivePOItems', data);
                
                console.log('API result:', JSON.stringify(result));
                
                if (result && result.status === 'success') {
                    // Update receive date on PO (but NOT the Invoice_Number - that's our internal PO#)
                    // Supplier's invoice # is stored in notes for reference
                    const updateData = { poId: poId };
                    
                    // DON'T update invoiceNumber - that's our internal tracking number!
                    // Instead, append supplier invoice to notes if provided
                    if (receiveDate) updateData.receiveDate = receiveDate;
                    
                    // If supplier invoice provided, append to existing notes
                    if (invoiceNumber.trim()) {
                        const existingNotes = notes.trim();
                        const supplierInvoiceNote = ` Supplier Invoice #: ${invoiceNumber.trim()}`;
                        updateData.notes = existingNotes 
                            ? `${existingNotes}\n${supplierInvoiceNote}`
                            : supplierInvoiceNote;
                        console.log('Stored supplier invoice in notes:', invoiceNumber);
                    }
                    
                    if (updateData.receiveDate || updateData.notes) {
                        await apiCall('updatePurchaseOrder', updateData);
                        console.log('Updated PO - Receive Date:', receiveDate, 'Supplier Invoice stored in notes');
                    }
                    
                    const statusMsg = result.newStatus === 'Received' 
                        ? ' All items received! PO is now complete.' 
                        : ` Items received. PO status: ${result.newStatus} (${result.totalReceived}/${result.totalOrdered})`;
                    
                    showSuccess(statusMsg + '<br><br>Inventory has been updated.');
                    
                    document.getElementById('orderModal').style.display = 'none';
                    document.body.classList.remove('modal-open');
                    
                    // Reload data
                    await loadPurchases();
                    await loadItems();
                    
                    // Refresh the report if it's currently displayed (e.g., Inventory Flow Dashboard)
                    reportDataCacheTime = null;  // Clear report cache so it reloads fresh data
                    if (document.getElementById('reportSetupModal')?.style.display !== 'none') {
                        setTimeout(() => executeReport(), 100);
                    }
                } else {
                    showError('Error: ' + (result?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error in commitReceivePartial:', error);
                showError('Error: ' + error.message);
            } finally {
                hideLoading();
                isCommittingReceivePartial = false;
                const closeBtn = document.getElementById('modalCloseBtn');
                if (commitBtn) {
                    commitBtn.disabled = false;
                    commitBtn.textContent = ' Receive Items into Inventory';
                }
                if (closeBtn) {
                    closeBtn.disabled = false;
                    closeBtn.style.opacity = '1';
                    closeBtn.style.cursor = 'pointer';
                }
            }
        }
        
        // Detailed Receive Preview Modal
        function showReceivePreviewModal(po, supplierName, items, totalValue, totalUnits, receiveDate, supplierInvoice) {
            return new Promise((resolve) => {
                // Build items list HTML
                let itemsHtml = items.map(item => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #10b981;">
                        <div style="flex: 2;">
                            <div style="font-weight: 600; font-size: 14px; color: #1f2937;">${item.itemName}</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">SKU: ${item.sku || 'N/A'}</div>
                            <div style="font-size: 11px; color: #059669; margin-top: 4px;">
                                 ${item.unitsPerPkg} units/pkg  <strong>${item.totalUnits} total units</strong>
                            </div>
                        </div>
                        <div style="text-align: center; flex: 0.5; padding: 0 10px;">
                            <div style="font-size: 24px; font-weight: bold; color: #10b981;">${item.qtyToReceive}</div>
                            <div style="font-size: 10px; color: #6b7280; text-transform: uppercase;">Cases</div>
                        </div>
                        <div style="text-align: right; flex: 0.7;">
                            <div style="font-weight: 600; color: #1f2937;">${formatMoney(item.lineTotal)}</div>
                            <div style="font-size: 11px; color: #6b7280;">${formatMoney(item.unitCost)}/case</div>
                        </div>
                    </div>
                `).join('');
                
                const totalCases = items.reduce((sum, i) => sum + i.qtyToReceive, 0);
                
                const modalHtml = `
                    <div id="receivePreviewModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100001; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;">
                        <div style="max-width: 550px; width: 100%; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; display: flex; flex-direction: column;">
                            <!-- Header -->
                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; text-align: center; flex-shrink: 0;">
                                <h2 style="margin: 0; font-size: 22px;"> Confirm Inventory Receipt</h2>
                                <p style="margin: 8px 0 0; opacity: 0.9; font-size: 14px;">Review items before adding to inventory</p>
                            </div>
                            
                            <!-- Content -->
                            <div style="padding: 20px; overflow-y: auto; flex: 1;">
                                <!-- PO Info -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                                    <div style="padding: 12px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
                                        <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">PO Number</div>
                                        <div style="font-weight: 700; font-size: 16px; color: #166534;">${po.Invoice_Number || po.PO_ID}</div>
                                    </div>
                                    <div style="padding: 12px; background: #eff6ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                        <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Supplier</div>
                                        <div style="font-weight: 600; font-size: 14px; color: #1e40af;">${supplierName}</div>
                                    </div>
                                </div>
                                
                                ${receiveDate ? `
                                <div style="padding: 10px; background: #fefce8; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 18px;"></span>
                                    <div>
                                        <div style="font-size: 11px; color: #666;">Receive Date</div>
                                        <div style="font-weight: 600;">${new Date(receiveDate).toLocaleDateString()}</div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${supplierInvoice ? `
                                <div style="padding: 10px; background: #f5f3ff; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 18px;"></span>
                                    <div>
                                        <div style="font-size: 11px; color: #666;">Supplier Invoice #</div>
                                        <div style="font-weight: 600;">${supplierInvoice}</div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                <!-- Items Header -->
                                <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px; color: #374151; display: flex; align-items: center; gap: 8px;">
                                    <span style="background: #10b981; color: white; padding: 4px 10px; border-radius: 20px; font-size: 13px;">${items.length} Item${items.length !== 1 ? 's' : ''}</span>
                                    <span>to receive into inventory:</span>
                                </div>
                                
                                <!-- Items List -->
                                <div style="max-height: 250px; overflow-y: auto; margin-bottom: 15px;">
                                    ${itemsHtml}
                                </div>
                                
                                <!-- Totals -->
                                <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 12px; padding: 15px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
                                        <div>
                                            <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Cases</div>
                                            <div style="font-size: 24px; font-weight: bold; color: #166534;">${totalCases}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Total Units</div>
                                            <div style="font-size: 24px; font-weight: bold; color: #166534;">${totalUnits.toLocaleString()}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Value</div>
                                            <div style="font-size: 24px; font-weight: bold; color: #166534;">${formatMoney(totalValue)}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Warning -->
                                <div style="margin-top: 15px; padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #b8a86b;">
                                    <div style="font-size: 13px; color: #92400e;">
                                        <strong> Important:</strong> This will add these items to your inventory. Make sure quantities match the physical shipment.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Footer -->
                            <div style="padding: 15px 20px 20px; border-top: 1px solid #eee; display: flex; gap: 10px; flex-shrink: 0;">
                                <button id="receivePreviewCancel" style="flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 10px; background: white; color: #333; font-size: 15px; font-weight: 600; cursor: pointer;"> Back to Edit</button>
                                <button id="receivePreviewConfirm" style="flex: 1; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 15px; font-weight: 600; cursor: pointer;"> Receive into Inventory</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to page
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer.firstElementChild);
                
                const modal = document.getElementById('receivePreviewModal');
                
                // Button handlers
                modal.querySelector('#receivePreviewCancel').onclick = () => {
                    modal.remove();
                    resolve(false);
                };
                
                modal.querySelector('#receivePreviewConfirm').onclick = () => {
                    modal.remove();
                    resolve(true);
                };
            });
        }
        
        function removeReceiveLine(index) {
            const row = document.getElementById(`receiveLine${index}`);
            if (row) {
                row.remove();
                recalculateReceiveTotal();
            }
        }
        
        function addReceiveLine() {
            const tbody = document.getElementById('receiveItemsBody');
            const index = window.receiveLineCounter++;
            const supplierId = window.currentReceivePO.Supplier_ID;
            
            // Get items for this supplier
            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
            
            const row = document.createElement('tr');
            row.id = `receiveLine${index}`;
            row.dataset.isOriginal = 'false';
            row.innerHTML = `
                <td style="text-align: center; padding: 8px 4px;">
                    <input type="checkbox" id="receiveCheck${index}" checked onchange="updateReceiveLine(${index})" style="width: 20px; height: 20px;">
                </td>
                <td style="padding: 8px;">
                    <select id="receiveItem${index}" onchange="updateReceiveItemCost(${index})" style="width: 100%; padding: 8px; font-size: 14px; box-sizing: border-box;">
                        <option value="">Select item...</option>
                        ${supplierItems.map(item => `<option value="${item.Item_ID}" data-cost="${item.Package_Cost}">${item.Item_Description}</option>`).join('')}
                    </select>
                </td>
                <td style="text-align: center; padding: 8px 4px; color: #999;">N/A</td>
                <td style="padding: 8px 4px;">
                    <input type="number" 
                           id="receiveQty${index}" 
                           value="1" 
                           min="0" 
                           step="1"
                           data-item-id=""
                           data-ordered="0"
                           data-cost="0"
                           style="width: 100%; padding: 8px; font-size: 14px; text-align: center; box-sizing: border-box;"
                           oninput="updateReceiveLine(${index})">
                </td>
                <td style="text-align: right; padding: 8px 4px; font-size: 13px;" id="receiveCost${index}">$0.00</td>
                <td style="text-align: right; padding: 8px 4px; font-weight: bold;" id="receiveLineTotal${index}">$0.00</td>
                <td style="text-align: center; padding: 8px 4px;">
                    <button type="button" class="btn-danger" onclick="removeReceiveLine(${index})" style="padding: 6px 10px; font-size: 14px;"></button>
                </td>
            `;
            tbody.appendChild(row);
        }
        
        function updateReceiveItemCost(index) {
            const select = document.getElementById(`receiveItem${index}`);
            const qtyInput = document.getElementById(`receiveQty${index}`);
            const costTd = document.getElementById(`receiveCost${index}`);
            
            const selectedOption = select.options[select.selectedIndex];
            const cost = parseFloat(selectedOption.dataset.cost) || 0;
            
            qtyInput.dataset.itemId = select.value;
            qtyInput.dataset.cost = cost;
            costTd.textContent = '$' + cost.toFixed(2);
            
            updateReceiveLine(index);
        }
        
        function recalculateReceiveTotal() {
            let grandTotal = 0;
            document.querySelectorAll('[id^="receiveLineTotal"]').forEach(td => {
                const amount = parseFloat(td.textContent.replace('$', '')) || 0;
                grandTotal += amount;
            });
            const grandTotalEl = document.getElementById('receiveGrandTotal');
            if (grandTotalEl) {
                grandTotalEl.textContent = '$' + grandTotal.toFixed(2);
            }
        }
        
        function updateReceiveLine(index) {
            const checkbox = document.getElementById(`receiveCheck${index}`);
            const qtyInput = document.getElementById(`receiveQty${index}`);
            const lineTotal = document.getElementById(`receiveLineTotal${index}`);
            
            if (!checkbox || !qtyInput || !lineTotal) return;
            
            if (!checkbox.checked) {
                qtyInput.value = 0;
                qtyInput.disabled = true;
            } else {
                qtyInput.disabled = false;
            }
            
            const qty = parseFloat(qtyInput.value) || 0;
            const cost = parseFloat(qtyInput.dataset.cost) || 0;
            const total = qty * cost;
            
            lineTotal.textContent = '$' + total.toFixed(2);
            
            // Recalculate grand total
            recalculateReceiveTotal();
        }
        
        let isCommittingReceive = false; // Prevent double-click
        
        async function commitReceive(poId) {
            // Prevent double-click
            if (isCommittingReceive) {
                console.log('Already committing receive, ignoring duplicate click');
                return;
            }
            
            const invoiceNumber = document.getElementById('receiveInvoiceNumber').value;
            const receiveDate = document.getElementById('receiveDate').value;
            const notes = document.getElementById('receiveNotes').value;
            
            if (!invoiceNumber) {
                const confirmed = await showConfirmModal(
                    ' No Invoice Number',
                    'No invoice number entered. Continue anyway?',
                    'Continue',
                    'Cancel',
                    'warning'
                );
                if (!confirmed) {
                    return;
                }
            }
            
            // Collect all receive lines (including added ones)
            const receivedLines = [];
            const rows = document.querySelectorAll('#receiveItemsBody tr');
            
            console.log('Found ' + rows.length + ' rows in receive table');
            
            rows.forEach((row, idx) => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                const qtyInput = row.querySelector('input[type="number"]');
                
                console.log('Row ' + idx + ': checkbox=' + (checkbox ? checkbox.checked : 'null') + ', qtyInput=' + (qtyInput ? qtyInput.value : 'null'));
                
                if (checkbox && checkbox.checked && qtyInput) {
                    const qty = parseFloat(qtyInput.value) || 0;
                    const itemId = qtyInput.dataset.itemId;
                    const qtyOrdered = parseFloat(qtyInput.dataset.ordered) || 0;
                    const cost = parseFloat(qtyInput.dataset.cost) || 0;
                    
                    console.log('  itemId=' + itemId + ', qty=' + qty);
                    
                    if (qty > 0 && itemId) {
                        receivedLines.push({
                            itemId: itemId,
                            qtyOrdered: qtyOrdered,
                            qtyReceived: qty,
                            unitCost: cost
                        });
                    }
                }
            });
            
            console.log('Collected ' + receivedLines.length + ' lines to receive');
            
            if (receivedLines.length === 0) {
                showWarning('Please select at least one item to receive');
                return;
            }
            
            // LOCK - Prevent double submit
            isCommittingReceive = true;
            
            // Disable the commit button
            const commitBtn = document.getElementById('modalSaveBtn');
            const closeBtn = document.getElementById('modalCloseBtn');
            if (commitBtn) {
                commitBtn.disabled = true;
                commitBtn.textContent = ' Processing...';
            }
            if (closeBtn) {
                closeBtn.disabled = true;
                closeBtn.style.opacity = '0.5';
                closeBtn.style.cursor = 'not-allowed';
            }
            
            try {
                // Call API to process PO receipt
                const data = {
                    poId: poId,
                    invoiceNumber: invoiceNumber,
                    receiveDate: receiveDate,
                    notes: notes,
                    lines: receivedLines
                };
                
                console.log('Calling receiveOutgoingPO with data:', JSON.stringify(data));
                
                const result = await apiCall('receiveOutgoingPO', data);
                
                console.log('API result:', JSON.stringify(result));
                
                if (result && result.status === 'success') {
                    showSuccess('Items received successfully! Inventory has been updated.');
                    document.getElementById('orderModal').style.display = 'none';
                    document.body.classList.remove('modal-open');
                    
                    // Reload purchases and items
                    await loadPurchases();
                    await loadItems();
                    
                    // Refresh the report if it's currently displayed (e.g., Inventory Flow Dashboard)
                    reportDataCacheTime = null;  // Clear report cache so it reloads fresh data
                    if (document.getElementById('reportSetupModal')?.style.display !== 'none') {
                        setTimeout(() => executeReport(), 100);
                    }
                } else {
                    showError('Error receiving items: ' + (result?.message || JSON.stringify(result) || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error in commitReceive:', error);
                showError('Error: ' + error.message);
            } finally {
                // UNLOCK
                isCommittingReceive = false;
                const closeBtn = document.getElementById('modalCloseBtn');
                
                // Re-enable buttons
                if (commitBtn) {
                    commitBtn.disabled = false;
                    commitBtn.textContent = ' Commit to Inventory';
                }
                if (closeBtn) {
                    closeBtn.disabled = false;
                    closeBtn.style.opacity = '1';
                    closeBtn.style.cursor = 'pointer';
                }
            }
        }
        
        let isSavingOutgoingPO = false; // Prevent double-click
        
        async function saveOutgoingPO() {
            // Prevent double-click
            if (isSavingOutgoingPO) {
                console.log('Already saving PO, ignoring duplicate click');
                return;
            }
            
            const supplierId = document.getElementById('createPOSupplier').value;
            const poDate = document.getElementById('createPODate').value;
            const expectedDeliveryDate = document.getElementById('createPOExpectedDate').value;
            const notes = document.getElementById('createPONotes')?.value;
            
            if (!supplierId || !poDate) {
                showWarning('Please select supplier and date');
                return;
            }
            
            if (!expectedDeliveryDate) {
                showWarning('Please select an Expected Delivery Date');
                return;
            }
            
            // Get line items
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            const lineItems = [];
            
            rows.forEach(row => {
                const itemId = row.querySelector('.createpo-item').value;
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                const costDiv = row.querySelector('.createpo-cost');
                
                // Parse cost from text
                const costText = costDiv.textContent.replace('$', '');
                const cost = costText === '-' ? 0 : parseFloat(costText);
                
                if (itemId && qty > 0) {
                    lineItems.push({
                        itemId: itemId,
                        quantity: qty,
                        unitCost: cost
                    });
                }
            });
            
            if (lineItems.length === 0) {
                showWarning('Please add at least one line item');
                return;
            }
            
            // LOCK - Prevent double submit
            isSavingOutgoingPO = true;
            
            // Disable the button visually
            const saveBtn = document.querySelector('button[onclick="saveOutgoingPO()"]');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = ' Saving...';
            }
            
            try {
                // Calculate total
                const total = lineItems.reduce((sum, item) => sum + (item.quantity * item.unitCost), 0);
            
            // AUTO-GENERATE PO NUMBER
            // Format: PO-MMDDYY-XXX (e.g., PO-120725-001)
            const dateObj = poDate ? new Date(poDate) : new Date();
            
            // Format date as MMDDYY
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const year = String(dateObj.getFullYear()).slice(-2); // Last 2 digits
            const dateStr = `${month}${day}${year}`;
            
            // Get all existing POs to find the next number for this date
            const existingPOs = await apiCall('getPurchaseOrders');
            let nextNumber = 1;
            
            if (existingPOs && existingPOs.data && existingPOs.data.length > 0) {
                // Find highest PO number for this date
                const prefix = `PO-${dateStr}-`;
                const todayPOs = existingPOs.data
                    .filter(po => po.Invoice_Number && po.Invoice_Number.startsWith(prefix))
                    .map(po => {
                        const parts = po.Invoice_Number.split('-');
                        return parseInt(parts[2]) || 0;
                    });
                
                if (todayPOs.length > 0) {
                    nextNumber = Math.max(...todayPOs) + 1;
                }
            }
            
            // Generate PO number: PO-120725-001
            const poNumber = `PO-${dateStr}-${String(nextNumber).padStart(3, '0')}`;
            
            // Create proper datetime: combine selected date with current time
            const now = new Date();
            const timeStr = now.toTimeString().split(' ')[0]; // HH:MM:SS
            const poDateTime = `${poDate}T${timeStr}`; // YYYY-MM-DDTHH:MM:SS
            
            // Create PO (sending order OUT to supplier)
            const data = {
                supplierId: supplierId,
                invoiceNumber: poNumber,
                poDate: poDateTime,  // Full datetime format
                dueDate: expectedDeliveryDate,
                paymentTerms: 'Net 30',
                status: 'Ordered',
                totalAmount: total,
                amountPaid: 0,
                notes: notes || '',
                lineItems: lineItems,
                poType: 'OUTGOING' // PO sent OUT to supplier, waiting for goods
            };
            
            const result = await apiCall('createPurchaseOrder', data);
            
            if (result && result.status === 'success') {
                showSuccessModal(
                    'Purchase Order Created!',
                    `PO Number: ${result.poId || poNumber}\n\nItems marked as "On Order".`,
                    () => {
                        clearCreatePOForm();
                    }
                );
                
                // Refresh items to update Qty_On_Order
                await loadItems();
            } else {
                showError('Error creating OUTGOING PO: ' + (result?.message || 'Unknown error'));
            }
            } finally {
                // UNLOCK - Always reset even if error
                isSavingOutgoingPO = false;
                
                // Re-enable Save PO button
                const saveBtns = document.querySelectorAll('#createPOForm button');
                saveBtns.forEach(btn => {
                    if (btn.innerHTML.includes('Save PO') || btn.innerHTML.includes('Saving')) {
                        btn.disabled = false;
                        btn.innerHTML = ' Save PO';
                    }
                });
                
                // Reset preview confirm button
                const confirmBtn = document.getElementById('createPOConfirmBtn');
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = ' Confirm & Place Order';
                }
            }
        }
        
        // Show preview for Create PO (Placing an Order)
        function showCreatePOPreview() {
            const supplierId = document.getElementById('createPOSupplier').value;
            const poDate = document.getElementById('createPODate').value;
            const expectedDeliveryDate = document.getElementById('createPOExpectedDate').value;
            const notes = document.getElementById('createPONotes')?.value || '';
            
            if (!supplierId || !poDate) {
                showWarning('Please select supplier and date');
                return;
            }
            
            if (!expectedDeliveryDate) {
                showWarning('Please select an Expected Delivery Date');
                return;
            }
            
            // Get supplier info
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            if (!supplier) {
                showError('Supplier not found');
                return;
            }
            
            // Get line items
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            const lineItems = [];
            
            rows.forEach(row => {
                const itemId = row.querySelector('.createpo-item').value;
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                const costDiv = row.querySelector('.createpo-cost');
                const totalUnitsDiv = row.querySelector('.createpo-totalunits');
                
                const costText = costDiv.textContent.replace('$', '');
                const cost = costText === '-' ? 0 : parseFloat(costText);
                
                const totalUnitsText = totalUnitsDiv.textContent;
                const totalUnits = totalUnitsText === '-' ? 0 : parseFloat(totalUnitsText);
                
                if (itemId && qty > 0) {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    if (item) {
                        lineItems.push({
                            sku: item.SKU || item.Item_ID,
                            description: item.Item_Description,
                            qty: qty,
                            totalUnits: totalUnits,
                            cost: cost,
                            total: qty * cost
                        });
                    }
                }
            });
            
            if (lineItems.length === 0) {
                showWarning('Please add at least one line item');
                return;
            }
            
            const total = lineItems.reduce((sum, item) => sum + item.total, 0);
            
            // Build preview HTML
            let itemsHtml = lineItems.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <div style="flex: 2;">
                        <div style="font-weight: 600; font-size: 13px;">${item.description}</div>
                        <div style="font-size: 11px; color: #666;">SKU: ${item.sku}</div>
                    </div>
                    <div style="text-align: center; flex: 0.5;">
                        <div style="font-weight: 600;">${item.qty}</div>
                        <div style="font-size: 10px; color: #666;">cases</div>
                    </div>
                    <div style="text-align: right; flex: 0.7;">
                        <div style="font-weight: 600; color: #6b9a8d;">$${item.total.toFixed(2)}</div>
                    </div>
                </div>
            `).join('');
            
            const html = `
                <div style="margin-bottom: 15px; padding: 12px; background: #f0f9ff; border-radius: 10px; border-left: 4px solid #2563eb;">
                    <div style="font-weight: 600; font-size: 14px; color: #1e40af;"> ${supplier.Supplier_Name}</div>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">${supplier.City || ''}, ${supplier.State || ''}</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 11px; color: #666; text-transform: uppercase;">Order Date</div>
                        <div style="font-weight: 600;">${new Date(poDate).toLocaleDateString()}</div>
                    </div>
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 11px; color: #666; text-transform: uppercase;">Expected Delivery</div>
                        <div style="font-weight: 600;">${new Date(expectedDeliveryDate).toLocaleDateString()}</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;"> ${lineItems.length} Item(s)</div>
                    ${itemsHtml}
                </div>
                
                <div style="padding: 15px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 10px; text-align: center;">
                    <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Total Order</div>
                    <div style="font-size: 28px; font-weight: bold; color: #15803d;">$${total.toFixed(2)}</div>
                </div>
                
                ${notes ? `<div style="margin-top: 15px; padding: 10px; background: #fffbeb; border-radius: 8px; font-size: 13px;"><strong>Notes:</strong> ${notes}</div>` : ''}
            `;
            
            document.getElementById('createPOPreviewContent').innerHTML = html;
            document.getElementById('createPOPreviewModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closeCreatePOPreview() {
            document.getElementById('createPOPreviewModal').style.display = 'none';
            document.body.style.overflow = '';
            // Reset confirm button state
            const btn = document.getElementById('createPOConfirmBtn');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = ' Confirm & Place Order';
            }
        }
        
        function submitCreatePOWithLoading(btn) {
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = ' Saving...';
            
            // Disable back button
            const backBtn = btn.previousElementSibling;
            if (backBtn) backBtn.disabled = true;
            
            // Update main Save PO button
            const mainBtns = document.querySelectorAll('#createPOForm button');
            mainBtns.forEach(b => {
                if (b.textContent.includes('Save PO')) {
                    b.disabled = true;
                    b.innerHTML = ' Saving PO...';
                }
            });
            
            // Close preview and save
            document.getElementById('createPOPreviewModal').style.display = 'none';
            document.body.style.overflow = '';
            saveOutgoingPO();
        }
        
        // Show printable PO preview (for Print PO No Save button)
        function showPrintablePOPreview() {
            const supplierId = document.getElementById('createPOSupplier').value;
            const poDate = document.getElementById('createPODate').value;
            
            if (!supplierId || !poDate) {
                showWarning('Please select supplier and date');
                return;
            }
            
            // Get line items
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            const lineItems = [];
            
            rows.forEach(row => {
                const itemId = row.querySelector('.createpo-item').value;
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                const costDiv = row.querySelector('.createpo-cost');
                const unitsDiv = row.querySelector('.createpo-units');
                const totalUnitsDiv = row.querySelector('.createpo-totalunits');
                
                const costText = costDiv.textContent.replace('$', '');
                const cost = costText === '-' ? 0 : parseFloat(costText);
                const unitsText = unitsDiv.textContent;
                const unitsPerCase = unitsText === '-' ? 0 : parseFloat(unitsText);
                const totalUnitsText = totalUnitsDiv.textContent;
                const totalUnits = totalUnitsText === '-' ? 0 : parseFloat(totalUnitsText);
                
                if (itemId && qty > 0) {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    if (item) {
                        lineItems.push({
                            sku: item.SKU || item.Item_ID,
                            description: item.Item_Description,
                            qty: qty,
                            unitsPerCase: unitsPerCase,
                            totalUnits: totalUnits,
                            cost: cost,
                            total: qty * cost
                        });
                    }
                }
            });
            
            if (lineItems.length === 0) {
                showWarning('Please add at least one line item');
                return;
            }
            
            // Get supplier info
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            if (!supplier) {
                showError('Supplier not found');
                return;
            }
            
            // Get invoice settings
            const settings = getInvoiceSettings();
            const themeColors = getThemeColors();
            const total = lineItems.reduce((sum, item) => sum + item.total, 0);
            
            // Open print window with proper format (matching existing PO print format)
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                showWarning('Please allow popups for this site');
                return;
            }
            
            const supplierEmail = supplier.Email || '';
            
            // Build item list for email body
            let itemsList = lineItems.map(item => ` ${item.description} - ${item.qty} cases`).join('\\n');
            const totalCases = lineItems.reduce((sum, item) => sum + item.qty, 0);
            
            // Generate a draft PO number for the email
            const dateStr = poDate.replace(/-/g, '').slice(2); // YYMMDD
            const draftPONum = 'PO-' + dateStr;
            
            const emailSubject = encodeURIComponent(`Purchase Order ${draftPONum} from ${settings.companyName}`);
            const emailBody = encodeURIComponent(`Dear ${supplier.Supplier_Name},

Please find our purchase order below:

${itemsList}
---
Total Cases: ${totalCases}
Total: $${total.toFixed(2)}

Please confirm receipt and expected delivery date.

Best regards,
${settings.companyName}
${settings.phone}
${settings.email}

---
NOTE: Please print or save the PO as PDF from the print preview and attach it to this email.`);
            
            let linesHtml = lineItems.map(item => `
                <tr>
                    <td style="border: 1px solid #e5e7eb; padding: 10px; font-size: 11pt;">${item.sku}</td>
                    <td style="border: 1px solid #e5e7eb; padding: 10px; font-size: 11pt;">${item.description}</td>
                    <td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-size: 11pt;">${item.qty}</td>
                    <td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-size: 11pt;">${item.unitsPerCase}</td>
                    <td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold; font-size: 11pt;">${item.totalUnits}</td>
                    <td style="border: 1px solid #e5e7eb; padding: 10px; text-align: right; font-size: 11pt;">$${item.cost.toFixed(2)}</td>
                    <td style="border: 1px solid #e5e7eb; padding: 10px; text-align: right; font-size: 11pt;">$${item.total.toFixed(2)}</td>
                </tr>
            `).join('');
            
            const poHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${settings.companyName} - Purchase Order ${draftPONum} - ${new Date(poDate).toLocaleDateString().replace(/\//g, '-')}</title>
    <style>
        @media print {
            @page { margin: 0.3in; }
            body { margin: 0; }
            .no-print { display: none !important; }
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="no-print" style="text-align: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <button onclick="window.print()" style="padding: 12px 24px; background: ${themeColors.primary}; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-right: 10px;"> Print</button>
        ${supplierEmail ? `<a href="mailto:${supplierEmail}?subject=${emailSubject}&body=${emailBody}" style="padding: 12px 24px; background: #6b9a8d; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-right: 10px; text-decoration: none; display: inline-block;"> Email Supplier</a>` : ''}
        <button onclick="window.close()" style="padding: 12px 24px; background: #8a8a8a; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;"> Close</button>
    </div>

    <div style="text-align: center; margin-bottom: 25px; border-bottom: 3px solid ${themeColors.primary}; padding-bottom: 20px;">
        <h1 style="color: ${themeColors.primary}; margin: 0; font-size: 28pt;">PURCHASE ORDER</h1>
        <p style="font-size: 14pt; margin: 8px 0;">${settings.companyName}</p>
        <p style="margin: 5px 0; color: #666;">Date: ${new Date(poDate).toLocaleDateString()}</p>
    </div>

    <div style="display: flex; justify-content: space-between; margin-bottom: 25px;">
        <div style="flex: 1;">
            <h3 style="color: ${themeColors.primary}; margin: 0 0 8px 0; font-size: 12pt;">From:</h3>
            <p style="margin: 3px 0; font-weight: bold;">${settings.companyName}</p>
            <p style="margin: 3px 0;">Phone: ${settings.phone}</p>
            <p style="margin: 3px 0;">Email: ${settings.email}</p>
        </div>
        <div style="flex: 1; text-align: right;">
            <h3 style="color: ${themeColors.primary}; margin: 0 0 8px 0; font-size: 12pt;">To:</h3>
            <p style="margin: 3px 0; font-weight: bold;">${supplier.Supplier_Name}</p>
            <p style="margin: 3px 0;">${supplier.Address || ''}</p>
            <p style="margin: 3px 0;">${supplier.City || ''}, ${supplier.State || ''} ${supplier.ZIP || ''}</p>
            <p style="margin: 3px 0;">Phone: ${supplier.Phone || ''}</p>
            <p style="margin: 3px 0;">Email: ${supplier.Email || ''}</p>
        </div>
    </div>

    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
        <thead>
            <tr style="background: ${themeColors.primary}; color: white;">
                <th style="padding: 12px; text-align: left; font-size: 11pt;">SKU</th>
                <th style="padding: 12px; text-align: left; font-size: 11pt;">Description</th>
                <th style="padding: 12px; text-align: center; font-size: 11pt;">Cases</th>
                <th style="padding: 12px; text-align: center; font-size: 11pt;">Units/Case</th>
                <th style="padding: 12px; text-align: center; font-size: 11pt;">Total Units</th>
                <th style="padding: 12px; text-align: right; font-size: 11pt;">Cost/Case</th>
                <th style="padding: 12px; text-align: right; font-size: 11pt;">Total</th>
            </tr>
        </thead>
        <tbody>
            ${linesHtml}
        </tbody>
    </table>

    <div style="text-align: right; margin-top: 20px;">
        <table style="margin-left: auto;">
            <tr>
                <td style="padding: 8px 20px; font-weight: bold; font-size: 14pt;">TOTAL:</td>
                <td style="padding: 8px 20px; font-weight: bold; font-size: 18pt; color: ${themeColors.primary};">$${total.toFixed(2)}</td>
            </tr>
        </table>
    </div>

    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 10pt;">
        <p>Thank you for your business!</p>
    </div>
</body>
</html>`;

            printWindow.document.write(poHTML);
            printWindow.document.close();
        }
        
        function generatePrintablePO() {
            const supplierId = document.getElementById('createPOSupplier').value;
            const poDate = document.getElementById('createPODate').value;
            
            if (!supplierId || !poDate) {
                showWarning('Please select supplier and date');
                return;
            }
            
            // Get line items
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            const lineItems = [];
            
            rows.forEach(row => {
                const itemId = row.querySelector('.createpo-item').value;
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                const costDiv = row.querySelector('.createpo-cost');
                const unitsDiv = row.querySelector('.createpo-units');
                const totalUnitsDiv = row.querySelector('.createpo-totalunits');
                
                // Parse cost from text
                const costText = costDiv.textContent.replace('$', '');
                const cost = costText === '-' ? 0 : parseFloat(costText);
                
                // Parse units from text
                const unitsText = unitsDiv.textContent;
                const unitsPerCase = unitsText === '-' ? 0 : parseFloat(unitsText);
                
                // Parse total units from text
                const totalUnitsText = totalUnitsDiv.textContent;
                const totalUnits = totalUnitsText === '-' ? 0 : parseFloat(totalUnitsText);
                
                if (itemId && qty > 0) {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    if (item) {
                        lineItems.push({
                            sku: item.SKU || item.Item_ID,
                            description: item.Item_Description,
                            qty: qty,
                            unitsPerCase: unitsPerCase,
                            totalUnits: totalUnits,
                            cost: cost,
                            total: qty * cost
                        });
                    }
                }
            });
            
            if (lineItems.length === 0) {
                showWarning('Please add at least one line item');
                return;
            }
            
            // Get supplier info
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            if (!supplier) {
                showError('Supplier not found');
                return;
            }
            
            // Get invoice settings - USE THE SAME METHOD AS SALES INVOICES
            const settings = getInvoiceSettings();
            const companyName = settings.companyName;
            const companyContactName = settings.contactName;
            const companyPhone = settings.phone;
            const companyEmail = settings.email;
            const companyAddress1 = settings.address1;
            const companyAddress2 = settings.address2;
            const companyCityStateZip = settings.cityStateZip;
            
            const total = lineItems.reduce((sum, item) => sum + item.total, 0);
            
            // Generate printable HTML
            let html = `
                <style>
                    @media print {
                        body * { visibility: hidden; }
                        #printablePO, #printablePO * { visibility: visible; }
                        #printablePO { position: absolute; left: 0; top: 0; width: 100%; }
                        button { display: none !important; }
                    }
                    .po-header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #667eea; padding-bottom: 20px; }
                    .po-info { display: flex; justify-content: space-between; margin-bottom: 30px; }
                    .po-box { flex: 1; }
                    .po-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    .po-table th { background: #667eea; color: white; padding: 12px; text-align: left; }
                    .po-table td { border: 1px solid #ddd; padding: 10px; }
                    .po-total { text-align: right; font-size: 20px; font-weight: bold; margin-top: 20px; }
                </style>
                
                <div class="po-header">
                    <h1 style="color: #667eea; margin: 0;">PURCHASE ORDER</h1>
                    <p style="font-size: 16pt; margin: 5px 0;">${companyName}</p>
                    <p style="margin: 5px 0;">Date: ${new Date(poDate).toLocaleDateString()}</p>
                </div>
                
                <div class="po-info">
                    <div class="po-box">
                        <h3>From:</h3>
                        <p><strong>${companyName}</strong></p>
                        ${companyContactName ? `<p>${companyContactName}</p>` : ''}
                        <p>${companyAddress1}</p>
                        ${companyAddress2 ? `<p>${companyAddress2}</p>` : ''}
                        <p>${companyCityStateZip}</p>
                        <p>Phone: ${companyPhone}</p>
                        <p>Email: ${companyEmail}</p>
                    </div>
                    <div class="po-box">
                        <h3>To:</h3>
                        <p><strong>${supplier.Supplier_Name}</strong></p>
                        ${supplier.Address ? `<p>${supplier.Address}</p>` : ''}
                        ${supplier.City || supplier.State || supplier.ZIP ? `<p>${supplier.City || ''}${supplier.City && supplier.State ? ', ' : ''}${supplier.State || ''} ${supplier.ZIP || ''}</p>` : ''}
                        ${supplier.Phone ? `<p>Phone: ${supplier.Phone}</p>` : ''}
                        ${supplier.Email ? `<p>Email: ${supplier.Email}</p>` : ''}
                    </div>
                </div>
                
                <table class="po-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Description</th>
                            <th style="text-align: center;">Cases</th>
                            <th style="text-align: center;">Units/Case</th>
                            <th style="text-align: center;">Total Units</th>
                            <th style="text-align: right;">Cost/Case</th>
                            <th style="text-align: right;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            lineItems.forEach(item => {
                html += `
                    <tr>
                        <td>${item.sku}</td>
                        <td>${item.description}</td>
                        <td style="text-align: center;">${item.qty}</td>
                        <td style="text-align: center;">${item.unitsPerCase}</td>
                        <td style="text-align: center;"><strong>${item.totalUnits}</strong></td>
                        <td style="text-align: right;">${formatMoney(item.cost)}</td>
                        <td style="text-align: right;">${formatMoney(item.total)}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <div class="po-total">
                    <p>TOTAL: ${formatMoney(total)}</p>
                </div>
                
                <div style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <p style="color: #666; font-size: 14px;">
                        Please confirm receipt of this purchase order and provide expected delivery date.
                    </p>
                </div>
            `;
            
            // Display printable PO
            document.getElementById('printablePO').innerHTML = html;
            document.getElementById('printablePOContainer').style.display = 'block';
            document.getElementById('createPOForm').style.display = 'none';
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
        
        function closePrintablePO() {
            document.getElementById('printablePOContainer').style.display = 'none';
            document.getElementById('createPOForm').style.display = 'block';
        }
        
        function downloadPOAsPDF() {
            // Get PO details
            const supplierId = document.getElementById('createPOSupplier').value;
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            const poDate = document.getElementById('createPODate').value;
            
            if (!supplier) {
                showError('Supplier not found');
                return;
            }
            
            // Create a clean filename
            const fileName = `PO_${supplier.Supplier_Name.replace(/[^a-z0-9]/gi, '_')}_${poDate}.pdf`;
            
            // For now, trigger print dialog with instruction
            showInfo('PDF Download:<br><br>1. Click OK<br>2. In the print dialog, select "Save as PDF"<br>3. Click Save<br><br>Note: Full automated PDF generation requires a backend service.');
            window.print();
        }
        
        function emailPO() {
            // Get supplier email
            const supplierId = document.getElementById('createPOSupplier').value;
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            const poDate = document.getElementById('createPODate').value;
            
            if (!supplier) {
                showError('Supplier not found');
                return;
            }
            
            const supplierEmail = supplier.Email || '';
            
            if (!supplierEmail) {
                showWarning('No email address found for ' + supplier.Supplier_Name + '. Please add an email address to the supplier record first.');
                return;
            }
            
            // Get company info - USE THE SAME METHOD AS SALES INVOICES
            const settings = getInvoiceSettings();
            const companyName = settings.companyName;
            
            // Get line items for email body
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            let itemsList = '';
            rows.forEach(row => {
                const itemId = row.querySelector('.createpo-item').value;
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                if (itemId && qty > 0) {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    if (item) {
                        itemsList += ` ${item.Item_Description} - ${qty} cases\n`;
                    }
                }
            });
            
            const totalCases = document.getElementById('createPOTotalCases').textContent;
            const totalCost = document.getElementById('createPOTotal').textContent;
            
            // Create email subject and body
            const subject = `Purchase Order from ${companyName} - ${poDate}`;
            const body = `Dear ${supplier.Supplier_Name},

Please find our purchase order for ${poDate}:

${itemsList}
---
Total Cases: ${totalCases}
Total: ${totalCost}

Please confirm receipt and expected delivery date.

Best regards,
${companyName}

---
NOTE: Please print the attached PO document for full details.`;
            
            // Create mailto link
            const mailtoLink = `mailto:${supplierEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Inform user to attach the PO
            showInfo('Email Instructions:<br><br>1. Your email client will open with the supplier\'s email pre-filled<br>2. IMPORTANT: Print or save this PO as PDF first (use Print button)<br>3. Attach the PDF to the email before sending<br><br>Click OK to open your email client.');
            
            // Open email client
            window.location.href = mailtoLink;
        }
        
        function clearCreatePOForm() {
            document.getElementById('createPOSupplier').value = '';
            document.getElementById('createPODate').value = getTodayLocalDate();
            document.getElementById('createPOExpectedDate').value = ''; // User must select
            
            // Clear Notes field - be more aggressive
            const notesField = document.getElementById('createPONotes');
            if (notesField) {
                notesField.value = '';
                notesField.textContent = '';  // Also clear textContent for textareas
            }
            
            // Also clear old form notes if it exists (in case both are in DOM)
            const oldNotesField = document.getElementById('poNotes');
            if (oldNotesField) {
                oldNotesField.value = '';
                oldNotesField.textContent = '';
            }
            
            // Clear all line items except the first one
            const container = document.getElementById('createPOLineItems');
            const rows = container.querySelectorAll('.line-item-row');
            rows.forEach((row, index) => {
                if (index === 0) {
                    const itemSelect = row.querySelector('.createpo-item');
                    if (itemSelect) itemSelect.value = '';
                    const qtyInput = row.querySelector('.createpo-qty');
                    if (qtyInput) qtyInput.value = '';
                    const unitsDiv = row.querySelector('.createpo-units');
                    if (unitsDiv) unitsDiv.textContent = '-';
                    const totalUnitsDiv = row.querySelector('.createpo-totalunits');
                    if (totalUnitsDiv) totalUnitsDiv.textContent = '-';
                    const costDiv = row.querySelector('.createpo-cost');
                    if (costDiv) costDiv.textContent = '-';
                    const lineTotalDiv = row.querySelector('.createpo-linetotal');
                    if (lineTotalDiv) lineTotalDiv.textContent = '$0.00';
                } else {
                    row.remove();
                }
            });
            
            // Re-populate item options for first row (since supplier is now cleared)
            filterItemsBySupplier();
            
            calculateCreatePOTotal();
            
            console.log(' Create PO form cleared');
        }
        
        // ===== ITEM PICKER FUNCTIONS (must be here so inline handlers work) =====
        window.itemPickerItems = window.itemPickerItems || [];
        window.itemPickerIsFilter = false;
        window.itemPickerCallback = null;
        window.itemPickerSupplierContext = ''; // Stores supplier context for PO mode
        
        // Define globally immediately so inline handlers can find it
        window.filterItemPicker = function() {
            window.renderItemPickerList();
            // Also update report picker if active
            if (typeof filterItemPickerForReport === 'function') {
                filterItemPickerForReport();
            }
        };
        
        window.renderItemPickerList = function() {
            const searchEl = document.getElementById('itemPickerSearch');
            const supplierEl = document.getElementById('itemPickerSupplier');
            const listContainer = document.getElementById('itemPickerList');
            
            if (!listContainer) return;
            
            const search = searchEl ? searchEl.value.toLowerCase().trim() : '';
            // Use global context if select is empty (for PO mode where select is hidden)
            const supplier = (supplierEl && supplierEl.value) ? supplierEl.value : (window.itemPickerSupplierContext || '');
            
            const isFilterInput = window.itemPickerIsFilter;
            const isMultiSelect = window.multiSelectMode || false;
            const selectedItems = window.multiSelectedItems || new Set();
            
            let filtered = (window.itemPickerItems || []).filter(item => {
                // Search filter - check SKU and Description (convert to string first!)
                const sku = String(item.SKU || '').toLowerCase();
                const desc = String(item.Item_Description || '').toLowerCase();
                const matchesSearch = !search || sku.includes(search) || desc.includes(search);
                
                // Supplier filter - use matchesFilter for multi-select support
                const matchesSupplier = matchesFilter(item.Supplier_ID, supplier);
                
                // Hide archived items UNLESS this is a filter input
                const isArchived = item.Status === 'Archived';
                const matchesActive = isFilterInput || !isArchived;
                
                return matchesSearch && matchesSupplier && matchesActive;
            });
            
            let html = '';
            
            // Show selection count in multi-select mode
            if (isMultiSelect && selectedItems.size > 0) {
                html += `
                    <div style="background: #e8f5e9; border: 2px solid #6b9a8d; border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #2e7d32; font-weight: bold;"> ${selectedItems.size} item${selectedItems.size > 1 ? 's' : ''} selected</span>
                        <button onclick="clearMultiSelection()" style="background: #fff; border: 1px solid #ccc; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Clear All</button>
                    </div>
                `;
            }
            
            // Add "Clear Filter" option for filter text inputs
            if (isFilterInput && !search && !supplier) {
                html += `
                    <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) clearItemFilter()" onclick="clearItemFilter()" style="border-left: 4px solid #8a8a8a; background: #f8f9fa;">
                        <div class="item-picker-desc" style="font-weight: bold; color: #495057;">
                            <span style="font-size: 18px; margin-right: 8px;"></span> Clear Filter
                        </div>
                        <div style="font-size: 12px; color: #8a8a8a;">Remove item filter and show all items</div>
                    </div>
                `;
            }
            
            if (filtered.length === 0) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No items found</div>
                        <div style="font-size: 14px; margin-top: 5px;">Try a different search term</div>
                    </div>
                `;
                return;
            }
            
            filtered.forEach(item => {
                const qty = parseInt(item.Qty_On_Hand) || 0;
                const reorder = parseInt(item.Reorder_Point) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                const onBackorder = parseInt(item.Qty_On_Backorder) || 0;
                const expectedDate = item.Expected_Restock_Date;
                const sellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const pkgCost = parseFloat(item.Package_Cost) || 0;
                const unitsPer = parseInt(item.Units_Per_Package) || 1;
                const unitCost = pkgCost / unitsPer;
                
                let stockClass = 'in-stock';
                let stockText = `${qty} in stock`;
                if (qty <= 0) {
                    stockClass = 'out-of-stock';
                    stockText = 'Out of stock';
                } else if (qty <= reorder) {
                    stockClass = 'low-stock';
                    stockText = `Low: ${qty}`;
                }
                
                // Add On Order badge if there's quantity on order
                const onOrderBadge = onOrder > 0 ? `<span class="item-picker-stock" style="background: #e3f2fd; color: #1976d2; border: 2px solid #90caf9; margin-left: 6px;"> On Order: ${onOrder}</span>` : '';
                
                // Add Backorder badge if there's quantity on backorder
                const backorderBadge = onBackorder > 0 ? `<span class="item-picker-stock" style="background: #fff3e0; color: #e65100; border: 2px solid #ffb74d; margin-left: 6px;"> Backorder: ${onBackorder}</span>` : '';
                
                // Add Expected Date badge if available
                let expectedDateBadge = '';
                if (expectedDate && onOrder > 0) {
                    const expDate = new Date(expectedDate);
                    // Check if date is valid
                    if (!isNaN(expDate.getTime())) {
                        const today = new Date();
                        const daysUntil = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                        let dateColor = '#2e7d32';
                        let dateBg = '#e8f5e9';
                        let dateBorder = '#81c784';
                        
                        if (daysUntil < 0) {
                            dateColor = '#c62828';
                            dateBg = '#ffebee';
                            dateBorder = '#e57373';
                        } else if (daysUntil <= 3) {
                            dateColor = '#e65100';
                            dateBg = '#fff3e0';
                            dateBorder = '#ffb74d';
                        }
                        
                        const dateText = daysUntil < 0 ? `Overdue ${Math.abs(daysUntil)}d` : 
                                         daysUntil === 0 ? 'Today' : 
                                         daysUntil === 1 ? 'Tomorrow' : 
                                         `${daysUntil} days`;
                        
                        expectedDateBadge = `<span class="item-picker-stock" style="background: ${dateBg}; color: ${dateColor}; border: 2px solid ${dateBorder}; margin-left: 6px;"> Expected: ${expDate.toLocaleDateString()} (${dateText})</span>`;
                    }
                }
                
                // Add Top Seller badge if applicable
                let topSellerBadge = '';
                if (item.Top_Seller_Rank) {
                    const rank = parseInt(item.Top_Seller_Rank);
                    if (rank === 1) {
                        topSellerBadge = `<span class="item-picker-stock" style="background: #ffd700; color: #000; border: 2px solid #ffed4e; margin-left: 6px; font-weight: bold;"> #1 Best Seller</span>`;
                    } else if (rank <= 10) {
                        topSellerBadge = `<span class="item-picker-stock" style="background: #fff9c4; color: #f57f17; border: 2px solid #fbc02d; margin-left: 6px; font-weight: bold;"> Top 10 Best Seller</span>`;
                    } else if (rank <= 25) {
                        topSellerBadge = `<span class="item-picker-stock" style="background: #e3f2fd; color: #1565c0; border: 2px solid #64b5f6; margin-left: 6px;"> Top 25 Best Seller</span>`;
                    }
                }
                
                const supplierName = (cachedSuppliers || []).find(s => s.Supplier_ID === item.Supplier_ID)?.Supplier_Name || 'Unknown';
                
                // Multi-select mode: show checkbox
                const isSelected = selectedItems.has(item.Item_ID);
                const checkboxHtml = isMultiSelect ? `
                    <div style="position: absolute; top: 10px; right: 10px; z-index: 5;">
                        <div style="width: 28px; height: 28px; border-radius: 50%; border: 3px solid ${isSelected ? '#6b9a8d' : '#ccc'}; background: ${isSelected ? '#6b9a8d' : 'white'}; display: flex; align-items: center; justify-content: center;">
                            ${isSelected ? '<span style="color: white; font-size: 16px; font-weight: bold;"></span>' : ''}
                        </div>
                    </div>
                ` : '';
                
                const cardStyle = isMultiSelect && isSelected ? 'border: 3px solid #6b9a8d; background: #f1f8e9;' : '';
                const clickHandler = isMultiSelect ? `toggleMultiSelectItem('${item.Item_ID}')` : `selectItemFromPicker('${item.Item_ID}')`;
                
                html += `
                    <div class="item-picker-card" style="position: relative; ${cardStyle}"
                         data-click-action="${clickHandler}"
                         ontouchstart="pickerTouchStart(event)"
                         ontouchmove="pickerTouchMove(event)"
                         ontouchend="if(pickerTouchEnd()) ${clickHandler}"
                         onclick="${clickHandler}">
                        ${checkboxHtml}
                        <div class="item-picker-header-row" style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center; margin-bottom: 8px;">
                            <span class="item-picker-sku">${item.SKU || ''}</span>
                            <span class="item-picker-stock ${stockClass}">${stockText}</span>${onOrderBadge}${backorderBadge}${topSellerBadge}
                        </div>
                        ${expectedDateBadge ? `<div style="margin-bottom: 8px;">${expectedDateBadge}</div>` : ''}
                        <div class="item-picker-desc">${item.Item_Description || ''}</div>
                        <div class="item-picker-details">
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Unit Cost</span>
                                <span class="item-picker-detail-value">${formatMoney(unitCost)}</span>
                            </div>
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Sell Price</span>
                                <span class="item-picker-detail-value item-picker-price">${formatMoney(sellPrice)}</span>
                            </div>
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Pkg</span>
                                <span class="item-picker-detail-value">${unitsPer}/${item.Purchase_UOM || 'Case'}</span>
                            </div>
                        </div>
                        <div class="item-picker-supplier"> ${supplierName}</div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        };
        
        // Multi-select helper functions
        function toggleMultiSelectItem(itemId) {
            if (!window.multiSelectedItems) window.multiSelectedItems = new Set();
            
            if (window.multiSelectedItems.has(itemId)) {
                window.multiSelectedItems.delete(itemId);
            } else {
                window.multiSelectedItems.add(itemId);
            }
            
            renderItemPickerList();
            updateMultiSelectCount();
        }
        
        function clearMultiSelection() {
            window.multiSelectedItems = new Set();
            renderItemPickerList();
            updateMultiSelectCount();
        }
        
        function updateMultiSelectCount() {
            const count = window.multiSelectedItems ? window.multiSelectedItems.size : 0;
            const countEl = document.getElementById('itemSelectionCount');
            if (countEl) {
                countEl.textContent = count > 0 ? `${count} item${count > 1 ? 's' : ''} selected` : '';
            }
        }
        
        // Open multi-select picker for Purchase Orders
        function openMultiItemPickerForPO() {
            // Check if coming from main PO form or Create PO (Inventory Flow)
            const isMainPO = window.multiItemPickerTarget === 'mainPO';
            const supplierId = isMainPO 
                ? document.getElementById('poSupplier').value 
                : document.getElementById('createPOSupplier').value;
            
            if (!supplierId) {
                showWarning('Please select a supplier first');
                return;
            }
            
            // Set up multi-select mode
            window.multiSelectMode = true;
            window.multiSelectContext = 'PO';
            window.multiSelectedItems = new Set();
            window.itemPickerSupplierContext = supplierId;
            window.itemPickerItems = cachedItems || [];
            
            // Hide supplier filter (already selected)
            const supplierFilterDiv = document.getElementById('itemPickerSupplierFilter');
            if (supplierFilterDiv) supplierFilterDiv.style.display = 'none';
            
            // Update modal header
            document.querySelector('#itemPickerModal .item-picker-header h3').textContent = ' Select Multiple Items';
            
            // Update Done button to add selected items
            const doneBtn = document.querySelector('#itemPickerModal .item-picker-footer button.btn');
            if (doneBtn) {
                doneBtn.textContent = ' Add Selected Items';
                doneBtn.onclick = addSelectedItemsToPO;
            }
            
            // Clear search
            document.getElementById('itemPickerSearch').value = '';
            
            // Render items
            renderItemPickerList();
            
            // Show modal
            document.getElementById('itemPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
        }
        
        // Build a lookup of expected arrival dates from pending POs for each item
        // OPTIMIZED: Uses single backend API call instead of multiple calls
        async function buildItemExpectedArrivals() {
            try {
                // Single API call - backend does all the heavy lifting
                const result = await apiCall('getItemExpectedArrivals');
                
                if (result?.status === 'success' && result.data) {
                    window.itemExpectedArrivals = {};
                    window.itemExpectedQty = {};
                    
                    // Result is { itemId: { date: "MM/DD/YYYY", qty: N }, ... }
                    for (const itemId in result.data) {
                        window.itemExpectedArrivals[itemId] = result.data[itemId].date;
                        window.itemExpectedQty[itemId] = result.data[itemId].qty;
                    }
                    
                    console.log(' Loaded expected arrivals for', Object.keys(window.itemExpectedArrivals).length, 'items (1 API call)');
                } else {
                    window.itemExpectedArrivals = {};
                    window.itemExpectedQty = {};
                }
            } catch(e) {
                console.error('Error loading expected arrivals:', e);
                window.itemExpectedArrivals = {};
                window.itemExpectedQty = {};
            }
        }
        
        // Open multi-select picker for Sales Orders
        function openMultiItemPickerForSO() {
            const customerId = document.getElementById('soCustomer').value;
            
            if (!customerId) {
                showWarning('Please select a customer first');
                return;
            }
            
            // Build expected arrivals lookup from pending POs
            buildItemExpectedArrivals();
            
            // Set up multi-select mode
            window.multiSelectMode = true;
            window.multiSelectContext = 'SO';
            window.multiSelectedItems = new Set();
            window.itemPickerSupplierContext = ''; // Show all items for sales
            window.itemPickerItems = cachedItems || [];
            
            // Show supplier filter for sales
            const supplierFilterDiv = document.getElementById('itemPickerSupplierFilter');
            const supplierSelect = document.getElementById('itemPickerSupplier');
            if (supplierFilterDiv) {
                supplierFilterDiv.style.display = 'block';
                supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
                if (cachedSuppliers && cachedSuppliers.length > 0) {
                    cachedSuppliers.forEach(s => {
                        supplierSelect.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                    });
                }
                supplierSelect.value = '';
            }
            
            // Update modal header
            document.querySelector('#itemPickerModal .item-picker-header h3').textContent = ' Select Multiple Items';
            
            // Update Done button to add selected items
            const doneBtn = document.querySelector('#itemPickerModal .item-picker-footer button.btn');
            if (doneBtn) {
                doneBtn.textContent = ' Add Selected Items';
                doneBtn.onclick = addSelectedItemsToSO;
            }
            
            // Clear search
            document.getElementById('itemPickerSearch').value = '';
            
            // Render items
            renderItemPickerList();
            
            // Show modal
            document.getElementById('itemPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
        }
        
        // Add selected items to Purchase Order
        function addSelectedItemsToPO() {
            const selectedItems = window.multiSelectedItems || new Set();
            
            if (selectedItems.size === 0) {
                showWarning('Please select at least one item');
                return;
            }
            
            // Check if targeting main PO form or Create PO form
            const isMainPO = window.multiItemPickerTarget === 'mainPO';
            
            if (isMainPO) {
                addSelectedItemsToMainPO(selectedItems);
            } else {
                addSelectedItemsToCreatePO(selectedItems);
            }
        }
        
        // Add items to main PO form (Purchase Orders tab)
        function addSelectedItemsToMainPO(selectedItems) {
            const container = document.getElementById('poLineItems');
            
            // Get existing rows to check for duplicates
            const existingItems = new Set();
            container.querySelectorAll('.po-item').forEach(sel => {
                if (sel.value) existingItems.add(sel.value);
            });
            
            // Clear empty rows first
            const rows = container.querySelectorAll('.line-item-row');
            rows.forEach(row => {
                const itemSelect = row.querySelector('.po-item');
                if (itemSelect && !itemSelect.value) {
                    row.remove();
                }
            });
            
            // Add new rows for each selected item
            selectedItems.forEach(itemId => {
                if (existingItems.has(itemId)) return; // Skip duplicates
                
                const item = (cachedItems || []).find(i => i.Item_ID === itemId);
                if (!item) return;
                
                // Create new row matching main PO form design
                const newRow = document.createElement('div');
                newRow.className = 'line-item-row';
                newRow.style.cssText = 'display: grid; grid-template-columns: 2.5fr 1fr 0.6fr 0.8fr 0.8fr 0.8fr 50px; gap: 8px; margin-bottom: 10px; align-items: end;';
                
                const cost = parseFloat(item.Package_Cost) || 0;
                const units = parseInt(item.Units_Per_Package) || 1;
                
                // Store data on row for calculations
                newRow.dataset.unitCost = cost;
                newRow.dataset.unitsPerPackage = units;
                
                newRow.innerHTML = `
                    <div>
                        <select class="po-item" style="width: 100%; padding: 14px 12px; border: 2px solid var(--primary, #667eea); border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white;" required>
                            <option value="${item.Item_ID}" data-cost="${cost}" data-units="${units}" selected>${item.Item_Description}</option>
                        </select>
                    </div>
                    <div>
                        <input type="number" class="po-qty" placeholder="0" min="1" style="width: 100%; padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px;" required>
                    </div>
                    <div>
                        <div class="po-units" style="text-align: center; font-size: 14px; color: #666; padding: 6px;">${units}</div>
                    </div>
                    <div>
                        <div class="po-totalunits" style="text-align: center; font-size: 16px; font-weight: bold; color: var(--primary, #667eea); padding: 6px;">-</div>
                    </div>
                    <div>
                        <div class="po-cost" style="text-align: center; font-size: 14px; font-weight: bold; color: #6b9a8d; background: #e8f5e9; padding: 10px; border-radius: 6px;">${formatMoney(cost)}</div>
                    </div>
                    <div>
                        <div class="po-linetotal" style="text-align: right; font-size: 14px; font-weight: bold; color: var(--primary, #667eea); background: var(--primary-light, #E3F2FD); padding: 10px; border-radius: 6px;">$0.00</div>
                    </div>
                    <button type="button" class="remove-btn btn-danger" style="width: 100%; padding: 10px; font-size: 14px;"></button>
                `;
                
                container.appendChild(newRow);
                
                // Attach event listeners
                const qtyInput = newRow.querySelector('.po-qty');
                const removeBtn = newRow.querySelector('.remove-btn');
                
                qtyInput.addEventListener('input', function() {
                    updatePOLineDisplay(this);
                    calculatePOTotal();
                });
                
                removeBtn.addEventListener('click', function() {
                    removeLineItem(this);
                    calculatePOTotal();
                });
            });
            
            // Close picker and reset target
            closeItemPicker();
            window.multiItemPickerTarget = null;
            
            // Focus first empty quantity field
            setTimeout(() => {
                const emptyQty = container.querySelector('.po-qty[value=""], .po-qty:not([value])');
                if (emptyQty) emptyQty.focus();
            }, 100);
            
            showSuccess(`Added ${selectedItems.size} item${selectedItems.size > 1 ? 's' : ''} to the order. Now enter quantities!`);
        }
        
        // Add items to Create PO form (Inventory Flow)
        function addSelectedItemsToCreatePO(selectedItems) {
            const supplierId = document.getElementById('createPOSupplier').value;
            const container = document.getElementById('createPOLineItems');
            
            // Get existing rows to check for duplicates
            const existingItems = new Set();
            container.querySelectorAll('.createpo-item').forEach(sel => {
                if (sel.value) existingItems.add(sel.value);
            });
            
            // Clear empty rows first
            const rows = container.querySelectorAll('.line-item-row');
            rows.forEach(row => {
                const itemSelect = row.querySelector('.createpo-item');
                if (!itemSelect.value) {
                    row.remove();
                }
            });
            
            // Add new rows for each selected item
            selectedItems.forEach(itemId => {
                if (existingItems.has(itemId)) return; // Skip duplicates
                
                const item = (cachedItems || []).find(i => i.Item_ID === itemId);
                if (!item) return;
                
                // Create new row
                const newRow = document.createElement('div');
                newRow.className = 'line-item-row';
                newRow.style.cssText = 'display: grid; grid-template-columns: 2.5fr 1fr 0.6fr 0.8fr 0.8fr 0.8fr 50px; gap: 8px; margin-bottom: 10px; align-items: end;';
                
                const cost = parseFloat(item.Package_Cost) || 0;
                const units = parseInt(item.Units_Per_Package) || 1;
                
                newRow.innerHTML = `
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                        <select class="createpo-item" style="width: 100%; padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white;" onchange="updateCreatePOItemCost(this)">
                            <option value="${item.Item_ID}" data-cost="${cost}" data-units="${units}" selected>${item.SKU || item.Item_ID} - ${item.Item_Description}</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Cases</label>
                        <input type="number" class="createpo-qty" placeholder="Qty" min="1" oninput="calculateCreatePOTotal()" style="width: 100%; padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px;">
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-units" style="text-align: center; font-size: 14px; color: #666; padding: 6px;">${units}</div>
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-totalunits" style="text-align: center; font-size: 16px; font-weight: bold; color: var(--primary, #667eea); padding: 6px;">-</div>
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-cost" style="text-align: center; font-size: 14px; font-weight: bold; color: #6b9a8d; background: #e8f5e9; padding: 10px; border-radius: 6px;">$${cost.toFixed(2)}</div>
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-linetotal" style="text-align: right; font-size: 14px; font-weight: bold; color: var(--primary, #667eea); background: var(--primary-light, #E3F2FD); padding: 10px; border-radius: 6px;">$0.00</div>
                    </div>
                    <button type="button" class="btn-danger" onclick="removeLineItem(this); calculateCreatePOTotal();" style="width: 100%; padding: 10px; font-size: 14px; margin-top: 26px;"></button>
                `;
                
                container.appendChild(newRow);
            });
            
            // Close picker
            closeItemPicker();
            
            // Focus first empty quantity field
            setTimeout(() => {
                const firstEmptyQty = container.querySelector('.createpo-qty:not([value]):not(:placeholder-shown), .createpo-qty[value=""]');
                if (firstEmptyQty) firstEmptyQty.focus();
            }, 100);
            
            showSuccess(`Added ${selectedItems.size} item${selectedItems.size > 1 ? 's' : ''} to the order. Now enter quantities!`);
        }
        
        // Add selected items to Sales Order
        function addSelectedItemsToSO() {
            const selectedItems = window.multiSelectedItems || new Set();
            
            if (selectedItems.size === 0) {
                showWarning('Please select at least one item');
                return;
            }
            
            const container = document.getElementById('soLineItems');
            
            // Get existing rows to check for duplicates
            const existingItems = new Set();
            container.querySelectorAll('.so-item').forEach(sel => {
                if (sel.value) existingItems.add(sel.value);
            });
            
            // Clear empty rows first
            const rows = container.querySelectorAll('.line-item-row');
            rows.forEach(row => {
                const itemSelect = row.querySelector('.so-item');
                if (!itemSelect.value) {
                    row.remove();
                }
            });
            
            // Add new rows for each selected item
            selectedItems.forEach(itemId => {
                if (existingItems.has(itemId)) return; // Skip duplicates
                
                const item = (cachedItems || []).find(i => i.Item_ID === itemId);
                if (!item) return;
                
                const sellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const qty = parseInt(item.Qty_On_Hand) || 0;
                
                // Create new row
                const newRow = document.createElement('div');
                newRow.className = 'line-item-row';
                newRow.style.cssText = 'display: grid; grid-template-columns: 2.5fr 1fr 1fr 50px; gap: 10px; margin-bottom: 10px; align-items: end;';
                
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                const onBackorder = parseInt(item.Qty_On_Backorder) || 0;
                const expectedArrival = window.itemExpectedArrivals?.[item.Item_ID] || null;
                const expectedQty = window.itemExpectedQty?.[item.Item_ID] || 0;
                
                // Build comprehensive stock info HTML
                let stockInfoHtml = `<div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">`;
                stockInfoHtml += `<span> <strong>On Hand:</strong> ${qty}</span>`;
                if (onOrder > 0) {
                    stockInfoHtml += `<span style="color: #b8a86b;"> <strong>On Order:</strong> ${onOrder}`;
                    if (expectedArrival) {
                        stockInfoHtml += ` (${expectedArrival})`;
                    }
                    stockInfoHtml += `</span>`;
                }
                if (onBackorder > 0) {
                    stockInfoHtml += `<span style="color: #b88a8a;"> <strong>Committed:</strong> ${onBackorder}</span>`;
                }
                stockInfoHtml += `</div>`;
                
                newRow.innerHTML = `
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                        <select class="so-item" required style="padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white; width: 100%;">
                            <option value="${item.Item_ID}" selected 
                                data-stock="${qty}" 
                                data-onorder="${onOrder}" 
                                data-onbackorder="${onBackorder}"
                                data-expected="${expectedArrival || ''}">${item.SKU || item.Item_ID} - ${item.Item_Description}</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Quantity</label>
                        <input type="number" class="so-qty" placeholder="Qty" min="1" required style="padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px; width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Price</label>
                        <input type="number" class="so-price" value="${sellPrice.toFixed(2)}" step="0.01" min="0" required style="padding: 14px 10px; border: 2px solid #667eea; border-radius: 8px; text-align: center; font-size: 16px; min-height: 52px; background: white; width: 100%;">
                    </div>
                    <button type="button" class="remove-btn" style="min-height: 52px; font-size: 18px; margin-top: 26px;"></button>
                    <div class="so-stock-info" style="grid-column: 1 / -1; font-size: 13px; padding: 8px 12px; margin-top: -5px; border-radius: 6px; border: 2px solid #e8f5e9; background: #f1f8e9;">
                        ${stockInfoHtml}
                    </div>
                `;
                
                container.appendChild(newRow);
                
                // Attach event listeners for qty, price, and remove
                const qtyInput = newRow.querySelector('.so-qty');
                const priceInput = newRow.querySelector('.so-price');
                const removeBtn = newRow.querySelector('.remove-btn');
                const stockInfoDiv = newRow.querySelector('.so-stock-info');
                
                if (qtyInput) {
                    qtyInput.addEventListener('input', function() {
                        // Update stock warning based on quantity
                        const qtyVal = parseFloat(this.value) || 0;
                        const stockAvailable = qty;
                        const remaining = stockAvailable - qtyVal;
                        const totalAvailable = stockAvailable + onOrder; // Including incoming
                        
                        if (stockInfoDiv) {
                            let statusHtml = `<div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">`;
                            statusHtml += `<span> <strong>On Hand:</strong> ${stockAvailable}</span>`;
                            if (onOrder > 0) {
                                statusHtml += `<span style="color: #b8a86b;"> <strong>On Order:</strong> ${onOrder}`;
                                if (expectedArrival) {
                                    statusHtml += ` (${expectedArrival})`;
                                }
                                statusHtml += `</span>`;
                            }
                            if (onBackorder > 0) {
                                statusHtml += `<span style="color: #b88a8a;"> <strong>Committed:</strong> ${onBackorder}</span>`;
                            }
                            statusHtml += `</div>`;
                            
                            let bgColor = '#f1f8e9';
                            let borderColor = '#a5d6a7';
                            
                            if (qtyVal > 0) {
                                statusHtml += `<div style="margin-top: 6px; font-weight: 600;">`;
                                
                                if (remaining < 0) {
                                    const shortage = Math.abs(remaining);
                                    bgColor = '#ffebee';
                                    borderColor = '#ef5350';
                                    
                                    if (onOrder >= shortage) {
                                        // Can fulfill once PO arrives
                                        statusHtml += `<span style="color: #b8a86b;"> Short ${shortage} units - but ${onOrder} on order`;
                                        if (expectedArrival) {
                                            statusHtml += ` (arriving ${expectedArrival})`;
                                        }
                                        statusHtml += `</span>`;
                                    } else {
                                        // Not enough even with incoming
                                        statusHtml += `<span style="color: #c62828;"> INSUFFICIENT STOCK! Short ${shortage} units</span>`;
                                    }
                                } else if (remaining === 0) {
                                    bgColor = '#fff3e0';
                                    borderColor = '#ffb74d';
                                    statusHtml += `<span style="color: #e65100;"> Will deplete stock to zero</span>`;
                                } else if (remaining < 10) {
                                    bgColor = '#fff3e0';
                                    borderColor = '#ffb74d';
                                    statusHtml += `<span style="color: #ef6c00;"> Low stock after sale: ${remaining} remaining</span>`;
                                } else {
                                    statusHtml += `<span style="color: #2e7d32;"> OK - ${remaining} will remain after sale</span>`;
                                }
                                
                                statusHtml += `</div>`;
                            }
                            
                            stockInfoDiv.innerHTML = statusHtml;
                            stockInfoDiv.style.background = bgColor;
                            stockInfoDiv.style.borderColor = borderColor;
                        }
                        
                        calculateSOTotal();
                    });
                }
                
                if (priceInput) {
                    priceInput.addEventListener('input', function() {
                        calculateSOTotal();
                    });
                }
                
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        this.closest('.line-item-row').remove();
                        calculateSOTotal();
                    });
                }
            });
            
            // Close picker
            closeItemPicker();
            
            // Calculate total after adding items
            calculateSOTotal();
            
            // Focus first empty quantity field
            setTimeout(() => {
                const firstEmptyQty = container.querySelector('.so-qty:not([value]):not(:placeholder-shown), .so-qty[value=""]');
                if (firstEmptyQty) firstEmptyQty.focus();
            }, 100);
            
            showSuccess(`Added ${selectedItems.size} item${selectedItems.size > 1 ? 's' : ''} to the order. Now enter quantities!`);
        }
        
        // ============================================================================
        // INVENTORY FLOW DASHBOARD FUNCTIONS
        // ============================================================================
        
        /**
         * Refresh the entire Inventory Flow Dashboard
         */
        // Wrapper function with timeout to prevent hanging
        async function refreshInventoryFlowWithTimeout() {
            const timeoutMs = 30000; // 30 seconds timeout
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('Dashboard loading timed out after 30 seconds. This usually means the backend is not responding or data is too large.')), timeoutMs);
            });
            
            try {
                await Promise.race([
                    refreshInventoryFlow(),
                    timeoutPromise
                ]);
            } catch (error) {
                console.error('Dashboard timeout or error:', error);
                console.log('Dashboard failed to load: ' + error.message);
                
                const alertsDiv = document.getElementById('invflowAlerts');
                if (alertsDiv) {
                    alertsDiv.innerHTML = `
                        <div style="background: #fee2e2; border: 2px solid #b88a8a; border-radius: 12px; padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 32px;"></div>
                                <div>
                                    <h4 style="margin: 0 0 8px 0; color: #b88a8a;">Dashboard Loading Issue</h4>
                                    <p style="margin: 0; color: #991b1b;">${error.message}</p>
                                    <p style="margin: 8px 0 0 0; color: #991b1b; font-size: 12px;">Open browser console (F12) to see what step failed</p>
                                    <button onclick="refreshInventoryFlowWithTimeout()" style="margin-top: 12px; background: #b88a8a; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                         Try Again
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        async function refreshInventoryFlow() {
            console.log(' Starting refreshInventoryFlow...');
            try {
                console.log('Loading inventory flow data...');
                
                // Make sure we have all the data loaded
                console.log(' Checking cached data...');
                console.log('- cachedItems:', cachedItems ? cachedItems.length : 'null/undefined');
                console.log('- purchasesData:', purchasesData ? purchasesData.length : 'null/undefined');
                console.log('- salesData:', salesData ? salesData.length : 'null/undefined');
                
                if (!cachedItems || cachedItems.length === 0) {
                    console.log(' Loading items...');
                    await loadItems();
                    console.log(' Items loaded:', cachedItems ? cachedItems.length : '0');
                }
                if (!purchasesData || purchasesData.length === 0) {
                    console.log(' Loading purchase orders...');
                    await loadPurchases();
                    console.log(' Purchase orders loaded:', purchasesData ? purchasesData.length : '0');
                }
                if (!salesData || salesData.length === 0) {
                    console.log(' Loading sales orders...');
                    await loadSales();
                    console.log(' Sales orders loaded:', salesData ? salesData.length : '0');
                }
                
                console.log(' Calculating metrics...');
                calculateInvFlowMetrics();
                console.log(' Metrics calculated');
                
                console.log(' Rendering alerts...');
                renderInvFlowAlerts();
                console.log(' Alerts rendered');
                
                console.log(' Rendering backorder items...');
                renderInvFlowBackorderItems();
                console.log(' Backorder items rendered');
                
                console.log(' Rendering pending POs...');
                renderInvFlowPendingPOs();
                console.log(' Pending POs rendered');
                
                console.log(' Rendering critical items...');
                renderInvFlowCriticalItems();
                console.log(' Critical items rendered');
                
                console.log(' Dashboard refresh complete!');
                console.log('Inventory flow dashboard updated!');
            } catch (error) {
                console.error(' Error refreshing inventory flow:', error);
                console.error('Error stack:', error.stack);
                console.error('Error loading dashboard: ' + error.message);
                
                // Show error in alerts section
                const alertsDiv = document.getElementById('invflowAlerts');
                if (alertsDiv) {
                    alertsDiv.innerHTML = `
                        <div style="background: #fee2e2; border: 2px solid #b88a8a; border-radius: 12px; padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 32px;"></div>
                                <div>
                                    <h4 style="margin: 0 0 8px 0; color: #b88a8a;">Error Loading Dashboard</h4>
                                    <p style="margin: 0; color: #991b1b;">${error.message}</p>
                                    <p style="margin: 8px 0 0 0; color: #991b1b; font-size: 12px;">Check browser console (F12) for details</p>
                                    <button onclick="refreshInventoryFlowWithTimeout()" style="margin-top: 12px; background: #b88a8a; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                         Try Again
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        /**
         * Calculate summary metrics for inventory flow
         */
        function calculateInvFlowMetrics() {
            try {
                const items = cachedItems || [];
                const pos = purchasesData || [];
                
                // Total On Order - check if field exists and has data
                const totalOnOrder = items.reduce((sum, item) => {
                    const qty = item.Qty_On_Order;
                    if (qty === undefined || qty === null || qty === '') return sum;
                    return sum + (parseInt(qty) || 0);
                }, 0);
                
                // Total Backorder - check if field exists and has data
                const totalBackorder = items.reduce((sum, item) => {
                    const qty = item.Qty_On_Backorder;
                    if (qty === undefined || qty === null || qty === '') return sum;
                    return sum + (parseInt(qty) || 0);
                }, 0);
                
                // POs This Week
                const now = new Date();
                const endOfWeek = new Date(now);
                endOfWeek.setDate(now.getDate() + (7 - now.getDay()));
                
                const posThisWeek = pos.filter(po => {
                    if (!po || !po.Status) return false;
                    if (['Received', 'Cancelled', 'Voided'].includes(po.Status)) return false;
                    if (!po.Need_By_Date) return false;
                    try {
                        const needBy = new Date(po.Need_By_Date);
                        return needBy <= endOfWeek;
                    } catch (e) {
                        return false;
                    }
                }).length;
                
                // Total Value Pending
                const totalValue = pos.filter(po => {
                    if (!po || !po.Status) return false;
                    return !['Received', 'Cancelled', 'Voided'].includes(po.Status);
                }).reduce((sum, po) => {
                    return sum + (parseFloat(po.Total_Amount) || 0);
                }, 0);
                
                // Update display - use safe defaults
                const totalOnOrderEl = document.getElementById('invflowTotalOnOrder');
                const totalBackorderEl = document.getElementById('invflowTotalBackorder');
                const posThisWeekEl = document.getElementById('invflowPOsThisWeek');
                const totalValueEl = document.getElementById('invflowTotalValue');
                
                if (totalOnOrderEl) totalOnOrderEl.textContent = totalOnOrder.toLocaleString();
                if (totalBackorderEl) totalBackorderEl.textContent = totalBackorder.toLocaleString();
                if (posThisWeekEl) posThisWeekEl.textContent = posThisWeek;
                if (totalValueEl) totalValueEl.textContent = '$' + totalValue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
                
            } catch (error) {
                console.error('Error calculating metrics:', error);
                // Set all to 0 on error
                document.getElementById('invflowTotalOnOrder').textContent = '0';
                document.getElementById('invflowTotalBackorder').textContent = '0';
                document.getElementById('invflowPOsThisWeek').textContent = '0';
                document.getElementById('invflowTotalValue').textContent = '$0';
            }
        }
        
        /**
         * Render critical alerts
         */
        function renderInvFlowAlerts() {
            try {
                const items = cachedItems || [];
                const pos = purchasesData || [];
                
                const alerts = [];
                
                // Count items on backorder - with safety checks
                const backorderItems = items.filter(item => {
                    const qty = item.Qty_On_Backorder;
                    if (qty === undefined || qty === null || qty === '') return false;
                    return (parseInt(qty) || 0) > 0;
                });
                if (backorderItems.length > 0) {
                    alerts.push({
                        type: 'warning',
                        icon: '',
                        text: `${backorderItems.length} item${backorderItems.length > 1 ? 's' : ''} on backorder (Customers waiting!)`,
                        action: () => {
                            const backorderSection = document.getElementById('invflowBackorderItems');
                            if (backorderSection) backorderSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });
                }
                
                // Count overdue POs - with safety checks
                const now = new Date();
                const overduePOs = pos.filter(po => {
                    if (!po || !po.Status) return false;
                    if (['Received', 'Cancelled', 'Voided'].includes(po.Status)) return false;
                    if (!po.Need_By_Date) return false;
                    try {
                        return new Date(po.Need_By_Date) < now;
                    } catch (e) {
                        return false;
                    }
                });
                if (overduePOs.length > 0) {
                    alerts.push({
                        type: 'danger',
                        icon: '',
                        text: `${overduePOs.length} overdue PO${overduePOs.length > 1 ? 's' : ''} (Expected last week or earlier)`,
                        action: () => switchTab('purchases')
                    });
                }
                
                // Count critical gap items (backorder > on order) - with safety checks
                const gapItems = items.filter(item => {
                    const backorder = item.Qty_On_Backorder;
                    const onOrder = item.Qty_On_Order;
                    if (backorder === undefined || backorder === null || backorder === '') return false;
                    if (onOrder === undefined || onOrder === null || onOrder === '') return false;
                    const backorderQty = parseInt(backorder) || 0;
                    const onOrderQty = parseInt(onOrder) || 0;
                    return backorderQty > 0 && backorderQty > onOrderQty;
                });
                if (gapItems.length > 0) {
                    alerts.push({
                        type: 'danger',
                        icon: '',
                        text: `${gapItems.length} item${gapItems.length > 1 ? 's' : ''}: Backorder > On Order (Not enough ordered!)`,
                        action: () => {
                            const criticalSection = document.getElementById('invflowCriticalItems');
                            if (criticalSection) criticalSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });
                }
                
                // Count out of stock with no PO - with safety checks
                const outOfStockNoPO = items.filter(item => {
                    const qtyOnHand = parseInt(item.Qty_On_Hand) || 0;
                    const onOrder = item.Qty_On_Order;
                    const backorder = item.Qty_On_Backorder;
                    const onOrderQty = (onOrder === undefined || onOrder === null || onOrder === '') ? 0 : (parseInt(onOrder) || 0);
                    const backorderQty = (backorder === undefined || backorder === null || backorder === '') ? 0 : (parseInt(backorder) || 0);
                    return qtyOnHand === 0 && onOrderQty === 0 && backorderQty > 0;
                });
                if (outOfStockNoPO.length > 0) {
                    alerts.push({
                        type: 'danger',
                        icon: '',
                        text: `${outOfStockNoPO.length} item${outOfStockNoPO.length > 1 ? 's' : ''} out of stock with NO purchase order!`,
                        action: () => switchTab('createpo')
                    });
                }
                
                // Render alerts
                const alertsContainer = document.getElementById('invflowAlerts');
                if (!alertsContainer) {
                    console.error('invflowAlerts container not found');
                    return;
                }
                
                if (alerts.length === 0) {
                    alertsContainer.innerHTML = `
                        <div style="text-align: center; padding: 30px; background: #e8f5e9; border-radius: 8px; border: 2px solid #6b9a8d;">
                            <div style="font-size: 48px; margin-bottom: 10px;"></div>
                            <div style="font-size: 18px; color: #2e7d32; font-weight: 600;">All Clear!</div>
                            <div style="font-size: 14px; color: #388e3c; margin-top: 8px;">No critical issues detected</div>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                alerts.forEach(alert => {
                    const bgColor = alert.type === 'danger' ? '#ffebee' : '#fff3e0';
                    const borderColor = alert.type === 'danger' ? '#b88a8a' : '#b8a86b';
                    const textColor = alert.type === 'danger' ? '#b91c1c' : '#d97706';
                    
                    html += `
                        <div onclick="(${alert.action.toString()})()" style="padding: 15px 20px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 24px;">${alert.icon}</span>
                                <span style="font-size: 15px; font-weight: 600; color: ${textColor};">${alert.text}</span>
                            </div>
                        </div>
                    `;
                });
                
                alertsContainer.innerHTML = html;
            } catch (error) {
                console.error('Error rendering alerts:', error);
                const alertsContainer = document.getElementById('invflowAlerts');
                if (alertsContainer) {
                    alertsContainer.innerHTML = `
                        <div style="background: #fee2e2; border: 2px solid #b88a8a; border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="font-size: 32px; margin-bottom: 10px;"></div>
                            <div style="color: #991b1b; font-weight: 600;">Error loading alerts</div>
                            <div style="color: #b91c1c; font-size: 13px; margin-top: 8px;">${error.message}</div>
                        </div>
                    `;
                }
            }
        }
        
        /**
         * Render items on backorder
         */
        function renderInvFlowBackorderItems() {
            const items = cachedItems || [];
            const backorderItems = items.filter(item => (parseInt(item.Qty_On_Backorder) || 0) > 0)
                .sort((a, b) => (parseInt(b.Qty_On_Backorder) || 0) - (parseInt(a.Qty_On_Backorder) || 0));
            
            document.getElementById('invflowBackorderCount').textContent = backorderItems.length;
            
            const container = document.getElementById('invflowBackorderItems');
            
            if (backorderItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                        <div style="font-size: 16px; color: #666;">No items on backorder</div>
                        <div style="font-size: 14px; color: #999; margin-top: 8px;">All customer orders can be fulfilled!</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            backorderItems.slice(0, 10).forEach(item => {
                const qtyOnHand = parseInt(item.Qty_On_Hand) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                const backorder = parseInt(item.Qty_On_Backorder) || 0;
                const expectedDate = item.Expected_Restock_Date;
                
                // Determine urgency
                const gap = backorder - onOrder;
                const isUrgent = gap > 0 || onOrder === 0;
                
                html += `
                    <div style="padding: 15px; border: 2px solid ${isUrgent ? '#b88a8a' : '#b8a86b'}; border-radius: 8px; margin-bottom: 12px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="font-weight: 600; font-size: 16px; color: #333; margin-bottom: 6px;">${item.Item_Description || item.SKU}</div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <span style="background: ${qtyOnHand === 0 ? '#fee2e2' : '#fff7ed'}; color: ${qtyOnHand === 0 ? '#b88a8a' : '#ea580c'}; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                        Stock: ${qtyOnHand}
                                    </span>
                                    <span style="background: #e3f2fd; color: #1976d2; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                        On Order: ${onOrder}
                                    </span>
                                    <span style="background: #fff3e0; color: #f57c00; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                         Backorder: ${backorder}
                                    </span>
                                    ${gap > 0 ? `<span style="background: #ffebee; color: #c62828; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;"> Gap: ${gap}</span>` : ''}
                                </div>
                                ${expectedDate && !isNaN(new Date(expectedDate).getTime()) ? `
                                    <div style="margin-top: 8px; font-size: 13px; color: #555;">
                                         Expected: ${new Date(expectedDate).toLocaleDateString()}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                ${isUrgent ? `
                                    <button class="btn-small" onclick="createPOForBackorderItem('${item.Item_ID}')" style="background: #b88a8a; color: white; font-size: 12px;"> CREATE PO</button>
                                ` : ''}
                                <button class="btn-small" onclick="viewItemDetails('${item.Item_ID}')" style="font-size: 12px;">View</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (backorderItems.length > 10) {
                html += `
                    <div style="text-align: center; padding: 15px; color: #666; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                        <strong>+${backorderItems.length - 10} more items on backorder</strong>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Create PO for a backorder item from Inventory tab
        async function createPOForBackorderItem(itemId) {
            // Get item from cache
            const item = (cachedItems || []).find(i => i.Item_ID === itemId);
            if (!item) {
                showStatus('inventoryStatus', ' Item not found. Please refresh.', 'error');
                return;
            }
            
            const supplierId = item.Supplier_ID;
            const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === supplierId);
            const supplierName = supplier?.Supplier_Name || 'Unknown';
            
            const qtyOnHand = parseInt(item.Qty_On_Hand) || 0;
            const backorder = parseInt(item.Qty_On_Backorder) || 0;
            const onOrder = parseInt(item.Qty_On_Order) || 0;
            const unitsPerPackage = parseInt(item.Units_Per_Package) || 1;
            
            // Calculate needed quantity
            const gap = Math.max(0, backorder - onOrder);
            const suggestedUnits = Math.max(gap, backorder);
            const suggestedCases = Math.ceil(suggestedUnits / unitsPerPackage);
            
            // Show styled confirmation modal
            const confirmed = await showConfirmModal(
                ' Create PO for Backorder Item',
                `<div style="text-align: left; padding: 10px 0;">
                    <p><strong>Item:</strong> ${item.Item_Description}</p>
                    <p><strong>SKU:</strong> ${item.SKU || 'N/A'}</p>
                    <p><strong>Supplier:</strong> ${supplierName}</p>
                    <hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">
                    <p> <strong>Current Status:</strong></p>
                    <ul style="margin: 5px 0 15px 20px;">
                        <li>On Hand: ${qtyOnHand} units</li>
                        <li>On Backorder: ${backorder} units</li>
                        <li>On Order: ${onOrder} units</li>
                        <li style="color: #b88a8a; font-weight: 600;">Gap to Fill: ${gap} units</li>
                    </ul>
                    <p>This will navigate to Create PO and pre-fill with <strong>${suggestedCases} cases</strong> (${suggestedCases * unitsPerPackage} units).</p>
                </div>`,
                'Create PO',
                'Cancel'
            );
            
            if (!confirmed) return;
            
            // Navigate to Create PO tab with pre-filled data
            window.skipCreatePOClear = true;
            switchTab('createpo');
            
            setTimeout(async () => {
                // Set supplier first
                const supplierSelect = document.getElementById('createPOSupplier');
                if (supplierSelect) {
                    supplierSelect.value = supplierId;
                    // Trigger the filter to populate item dropdowns
                    filterItemsBySupplier();
                }
                
                // Set today's date
                const today = getTodayLocalDate();
                document.getElementById('createPODate').value = today;
                
                // Set notes
                const notesField = document.getElementById('createPONotes');
                if (notesField) {
                    notesField.value = `Backorder fulfillment for ${item.Item_Description}`;
                }
                
                // Clear existing line items
                const container = document.getElementById('createPOLineItems');
                container.innerHTML = '';
                
                // Wait a bit for supplier filter to complete, then add a line item
                setTimeout(() => {
                    // Add a new line item using the standard function
                    addCreatePOLineItem();
                    
                    // Now find and populate the newly added row
                    const rows = container.querySelectorAll('.line-item-row');
                    const newRow = rows[rows.length - 1];
                    
                    if (newRow) {
                        // Select the item in the dropdown
                        const itemSelect = newRow.querySelector('.createpo-item');
                        if (itemSelect) {
                            itemSelect.value = item.Item_ID;
                            // Trigger the cost/units update
                            updateCreatePOItemCost(itemSelect);
                        }
                        
                        // Set the quantity
                        const qtyInput = newRow.querySelector('.createpo-qty');
                        if (qtyInput) {
                            qtyInput.value = suggestedCases;
                            // Trigger recalculation
                            calculateCreatePOTotal();
                        }
                    }
                    
                    showSuccess(`Pre-filled PO for ${suggestedCases} cases of ${item.Item_Description}`);
                }, 200);
            }, 300);
        }
        
        /**
         * Render pending purchase orders
         */
        function renderInvFlowPendingPOs() {
            const pos = (purchasesData || []).filter(po => {
                return !['Received', 'Cancelled', 'Voided'].includes(po.Status);
            }).sort((a, b) => {
                if (!a.Need_By_Date) return 1;
                if (!b.Need_By_Date) return -1;
                return new Date(a.Need_By_Date) - new Date(b.Need_By_Date);
            });
            
            document.getElementById('invflowPendingCount').textContent = pos.length;
            
            const container = document.getElementById('invflowPendingPOs');
            
            if (pos.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                        <div style="font-size: 16px; color: #666;">No pending arrivals</div>
                        <div style="font-size: 14px; color: #999; margin-top: 8px;">No purchase orders expected</div>
                    </div>
                `;
                return;
            }
            
            const now = new Date();
            let html = '';
            
            pos.slice(0, 10).forEach(po => {
                const needByDate = po.Need_By_Date ? new Date(po.Need_By_Date) : null;
                const isOverdue = needByDate && needByDate < now;
                const daysUntil = needByDate ? Math.ceil((needByDate - now) / (1000 * 60 * 60 * 24)) : null;
                
                let dateText = 'No date specified';
                let dateBg = '#f8f9fa';
                let dateColor = '#666';
                
                if (needByDate) {
                    if (isOverdue) {
                        dateText = ` Overdue ${Math.abs(daysUntil)} day${Math.abs(daysUntil) !== 1 ? 's' : ''}`;
                        dateBg = '#ffebee';
                        dateColor = '#c62828';
                    } else if (daysUntil === 0) {
                        dateText = ' Today';
                        dateBg = '#fff3e0';
                        dateColor = '#f57c00';
                    } else if (daysUntil === 1) {
                        dateText = ' Tomorrow';
                        dateBg = '#e8f5e9';
                        dateColor = '#2e7d32';
                    } else if (daysUntil <= 7) {
                        dateText = ` ${daysUntil} days`;
                        dateBg = '#e8f5e9';
                        dateColor = '#2e7d32';
                    } else {
                        dateText = ` ${needByDate.toLocaleDateString()}`;
                        dateBg = '#e3f2fd';
                        dateColor = '#1976d2';
                    }
                }
                
                const supplierName = getSupplierName(po.Supplier_ID);
                const totalAmount = parseFloat(po.Total_Amount) || 0;
                
                html += `
                    <div style="padding: 15px; border: 2px solid ${isOverdue ? '#b88a8a' : '#1976d2'}; border-radius: 8px; margin-bottom: 12px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1; min-width: 250px;">
                                <div style="font-weight: 600; font-size: 16px; color: #333; margin-bottom: 6px;">
                                    PO #${po.Invoice_Number || po.PO_ID} - ${supplierName}
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                                    <span style="background: ${dateBg}; color: ${dateColor}; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                        ${dateText}
                                    </span>
                                    <span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                         ${totalAmount.toLocaleString('en-US', {style: 'currency', currency: 'USD'})}
                                    </span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-small" onclick="viewPODetails('${po.PO_ID}')" style="font-size: 12px;">View PO</button>
                                <button class="btn-small" onclick="receivePO('${po.PO_ID}')" style="background: #2e7d32; color: white; font-size: 12px;">Receive</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (pos.length > 10) {
                html += `
                    <div style="text-align: center; padding: 15px; color: #666; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                        <strong>+${pos.length - 10} more pending POs</strong> - <a href="#" onclick="switchTab('purchases'); return false;" style="color: #1976d2;">View All</a>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        /**
         * Render critical items (low stock + high demand)
         */
        function renderInvFlowCriticalItems() {
            const items = cachedItems || [];
            const criticalItems = items.filter(item => {
                const qtyOnHand = parseInt(item.Qty_On_Hand) || 0;
                const reorderPoint = parseInt(item.Reorder_Point) || 0;
                const backorder = parseInt(item.Qty_On_Backorder) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                
                // Critical if any of these conditions:
                // 1. Out of stock (qty = 0)
                // 2. Negative stock
                // 3. Below reorder point with no incoming orders
                // 4. Has backorders exceeding on-order quantity (unfulfillable demand)
                const isOutOfStock = qtyOnHand <= 0;
                const isBelowReorderNoOrders = qtyOnHand <= reorderPoint && reorderPoint > 0 && onOrder === 0;
                const hasUnfulfillableBackorder = backorder > 0 && backorder > onOrder;
                
                return isOutOfStock || isBelowReorderNoOrders || hasUnfulfillableBackorder;
            }).sort((a, b) => {
                // Sort by urgency: out of stock first, then by gap
                const qtyA = parseInt(a.Qty_On_Hand) || 0;
                const qtyB = parseInt(b.Qty_On_Hand) || 0;
                if (qtyA <= 0 && qtyB > 0) return -1;
                if (qtyB <= 0 && qtyA > 0) return 1;
                const gapA = (parseInt(a.Qty_On_Backorder) || 0) - (parseInt(a.Qty_On_Order) || 0);
                const gapB = (parseInt(b.Qty_On_Backorder) || 0) - (parseInt(b.Qty_On_Order) || 0);
                return gapB - gapA;
            });
            
            document.getElementById('invflowCriticalCount').textContent = criticalItems.length;
            
            const container = document.getElementById('invflowCriticalItems');
            
            if (criticalItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                        <div style="font-size: 16px; color: #666;">No critical items</div>
                        <div style="font-size: 14px; color: #999; margin-top: 8px;">All items have adequate stock levels</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            criticalItems.slice(0, 10).forEach(item => {
                const qtyOnHand = parseInt(item.Qty_On_Hand) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                const backorder = parseInt(item.Qty_On_Backorder) || 0;
                const reorderPoint = parseInt(item.Reorder_Point) || 0;
                const gap = backorder - onOrder;
                
                // Determine the critical reason
                let criticalReason = '';
                if (qtyOnHand <= 0) criticalReason = ' OUT OF STOCK';
                else if (qtyOnHand <= reorderPoint && onOrder === 0) criticalReason = ' LOW STOCK - NO ORDERS';
                else if (gap > 0) criticalReason = ' BACKORDER GAP';
                
                html += `
                    <div style="padding: 15px; border: 2px solid #b88a8a; border-radius: 8px; margin-bottom: 12px; background: #fff5f5;">
                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="font-weight: 600; font-size: 16px; color: #333; margin-bottom: 6px;">${item.Item_Description || item.SKU}</div>
                                <div style="font-size: 12px; color: #b88a8a; font-weight: 600; margin-bottom: 8px;">${criticalReason}</div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <span style="background: ${qtyOnHand <= 0 ? '#fee2e2' : '#fff3e0'}; color: ${qtyOnHand <= 0 ? '#b88a8a' : '#f57c00'}; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                        Stock: ${qtyOnHand}
                                    </span>
                                    <span style="background: #f3f4f6; color: #6b7280; padding: 4px 10px; border-radius: 12px; font-size: 13px;">
                                        Reorder: ${reorderPoint}
                                    </span>
                                    ${backorder > 0 ? `<span style="background: #fff3e0; color: #f57c00; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                        Backorder: ${backorder}
                                    </span>` : ''}
                                    ${onOrder > 0 ? `<span style="background: #e3f2fd; color: #1976d2; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                        On Order: ${onOrder}
                                    </span>` : ''}
                                    ${gap > 0 ? `<span style="background: #ffebee; color: #c62828; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">GAP: -${gap}!</span>` : ''}
                                </div>
                            </div>
                            <div>
                                <button class="btn-small" onclick="switchTab('createpo')" style="background: #b88a8a; color: white; font-size: 12px; font-weight: 600;"> ORDER MORE!</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (criticalItems.length > 10) {
                html += `
                    <div style="text-align: center; padding: 15px; color: #666; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                        <strong>+${criticalItems.length - 10} more critical items</strong>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        /**
         * View critical items report (placeholder - can be expanded later)
         */
        function viewCriticalItemsReport() {
            // Open the Inventory Status report which shows critical items
            showReport('inventory-status');
        }
        
        /**
         * View item details - opens Items tab and could highlight the item
         */
        function viewItemDetails(itemId) {
            // Use Quick View Modal instead of navigating away
            // This keeps the report open so user can continue working
            openQuickViewItemModal(itemId);
        }
        
        /**
         * View PO details (placeholder - can link to existing PO view)
         */
        function viewPODetails(poId) {
            // Open the PO detail popup directly
            viewPurchaseOrder(poId);
        }
        
        /**
         * Receive PO - calls the existing receive function
         */
        function receivePO(poId) {
            // Call existing receive PO function that opens the receive modal
            receiveOutgoingPO(poId);
        }
    </script>
    
    <!-- Order View/Edit Modal -->
    <div id="orderModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; padding: 20px; box-sizing: border-box; overflow-y: auto;">
        <div id="orderModalInner" style="background: white; margin: 0 auto; max-width: 900px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: calc(100vh - 40px); display: flex; flex-direction: column; resize: both; overflow: hidden; min-width: 400px; min-height: 300px;">
            <div id="orderModalHeader" style="background: var(--primary, #667eea); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <h2 id="modalTitle" style="margin: 0;">Order Details</h2>
                <button onclick="closeOrderModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <div id="modalContent" style="padding: 30px; overflow-y: auto; flex: 1;">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div id="modalFooter" style="padding: 20px 30px; border-top: 1px solid #ddd; display: flex; gap: 10px; justify-content: flex-end;">
                <button id="modalCloseBtn" class="btn" onclick="closeOrderModal()" style="background: var(--secondary, #764ba2); color: white;">Close</button>
                <button id="modalPrintBtn" class="btn" onclick="printInvoice()" style="display: none; background: var(--primary, #667eea); color: white;"> Print Invoice</button>
                <button id="modalEditBtn" class="btn" onclick="enableEditMode()" style="display: none; background: var(--primary, #667eea); color: white;"> Edit Order</button>
                <button id="modalSaveBtn" class="btn" onclick="if(event && debounceButton(event.currentTarget)) saveOrderChanges()" style="display: none; background: var(--primary, #667eea); color: white;"> Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Report Setup Modal -->
    <div id="reportSetupModal" onclick="if(event.target === this) closeReportSetup()" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: none; padding: 20px; box-sizing: border-box; overflow-y: auto;">
        <div id="reportSetupModalInner" style="background: white; width: 100%; max-width: 1400px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: calc(100vh - 40px); display: flex; flex-direction: column; overflow: hidden; resize: both; min-width: 500px; min-height: 400px; margin: 0 auto;">
            <div id="reportSetupHeader" style="background: var(--primary, #667eea); color: white; padding: 15px 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <h2 id="reportSetupTitle" style="margin: 0; flex: 1;"> Report Setup</h2>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <!-- Window Controls -->
                    <button id="reportMaximizeBtn" onclick="toggleReportModalSize()" title="Maximize/Restore" style="background: var(--secondary, rgba(255,255,255,0.3)); border: none; color: white; font-size: 16px; cursor: pointer; width: 36px; height: 36px; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; opacity: 0.85;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.85'">
                        <span id="reportMaximizeIcon"></span>
                    </button>
                    <button onclick="closeReportSetup()" title="Close" style="background: var(--secondary, rgba(255,255,255,0.3)); border: none; color: white; font-size: 20px; cursor: pointer; width: 36px; height: 36px; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; opacity: 0.85;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.85'">&times;</button>
                </div>
            </div>
            <div id="reportSetupFilters" style="padding: 20px; background: #f8f9fa; border-bottom: 1px solid #ddd; flex-shrink: 0;">
                <!-- Filters will be populated by JavaScript -->
            </div>
            <div id="reportSetupContent" style="padding: 20px; flex: 1; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; min-height: 0;">
                <div style="text-align: center; padding: 40px; color: #888;">
                    <div style="font-size: 48px; margin-bottom: 15px;"></div>
                    <p>Configure filters above and click <strong>Run Report</strong></p>
                </div>
            </div>
            <div id="reportSetupFooter" style="padding: 15px 20px; border-top: 1px solid #ddd; display: flex; gap: 10px; justify-content: space-between; background: #f8f9fa; border-radius: 0 0 12px 12px; flex-wrap: wrap; flex-shrink: 0;">
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn" onclick="printReport()" title="Print Report (or Save as PDF)" style="background: var(--primary, #667eea); color: white;"> Print</button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="closeReportSetup()" style="background: var(--secondary, #764ba2); color: white;">Cancel</button>
                    <button class="btn" onclick="executeReport()" id="runReportBtn" style="background: var(--primary, #667eea); color: white;"> Run Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile-Friendly Item Picker Modal -->
    <div id="itemPickerModal" class="item-picker-overlay">
        <div class="item-picker-container">
            <div class="item-picker-header">
                <h3> Select Item(s)</h3>
                <button class="item-picker-close" onclick="closeItemPicker(); closeItemPickerForReport();">&times;</button>
            </div>
            <div class="item-picker-search">
                <input type="text" id="itemPickerSearch" placeholder=" Search by SKU or description..." oninput="handleItemPickerSearch();" onkeyup="handleItemPickerSearch();">
            </div>
            <div id="itemPickerSupplierFilter" class="item-picker-filter">
                <select id="itemPickerSupplier" onchange="window.filterItemPicker()">
                    <option value="">All Suppliers</option>
                </select>
            </div>
            <div id="itemPickerList" class="item-picker-list" style="max-height: calc(100% - 240px);">
                <!-- Items will be populated by JavaScript -->
            </div>
            <div class="item-picker-footer" style="padding: 15px; border-top: 2px solid #e0e0e0; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                <div id="itemSelectionCount" style="color: #666; font-size: 14px; font-weight: 600;"></div>
                <button class="btn" onclick="closeItemPicker(); closeItemPickerForReport();" style="background: var(--primary, #667eea); color: white; padding: 10px 24px;"> Done</button>
            </div>
        </div>
    </div>

    <!-- SUPPLIER PICKER MODAL -->
    <div id="supplierPickerModal" class="item-picker-overlay">
        <div class="item-picker-container">
            <div class="item-picker-header">
                <h3> Select Supplier(s)</h3>
                <button class="item-picker-close" onclick="closeSupplierPicker()">&times;</button>
            </div>
            <div class="item-picker-search">
                <input type="text" id="supplierPickerSearch" placeholder=" Search suppliers..." oninput="filterSupplierPicker()" onkeyup="filterSupplierPicker()">
            </div>
            <div id="supplierPickerList" class="item-picker-list" style="max-height: calc(100% - 180px);">
                <!-- Suppliers will be populated by JavaScript -->
            </div>
            <div class="item-picker-footer" style="padding: 15px; border-top: 2px solid #e0e0e0; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                <div id="supplierSelectionCount" style="color: #666; font-size: 14px; font-weight: 600;"></div>
                <button class="btn" onclick="closeSupplierPicker()" style="background: var(--primary, #667eea); color: white; padding: 10px 24px;"> Done</button>
            </div>
        </div>
    </div>

    <!-- CUSTOMER PICKER MODAL -->
    <div id="customerPickerModal" class="item-picker-overlay">
        <div class="item-picker-container">
            <div class="item-picker-header">
                <h3> Select Customer(s)</h3>
                <button class="item-picker-close" onclick="closeCustomerPicker()">&times;</button>
            </div>
            <div class="item-picker-search">
                <input type="text" id="customerPickerSearch" placeholder=" Search customers..." oninput="filterCustomerPicker()" onkeyup="filterCustomerPicker()">
            </div>
            <div id="customerPickerList" class="item-picker-list" style="max-height: calc(100% - 180px);">
                <!-- Customers will be populated by JavaScript -->
            </div>
            <div class="item-picker-footer" style="padding: 15px; border-top: 2px solid #e0e0e0; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                <div id="customerSelectionCount" style="color: #666; font-size: 14px; font-weight: 600;"></div>
                <button class="btn" onclick="closeCustomerPicker()" style="background: var(--primary, #667eea); color: white; padding: 10px 24px;"> Done</button>
            </div>
        </div>
    </div>

    <!-- REASON PICKER MODAL -->
    <div id="reasonPickerModal" class="item-picker-overlay">
        <div class="item-picker-container styled-modal-container" style="max-width: 500px; width: 90%; height: auto; max-height: 90vh; margin: auto; border-radius: 16px; overflow: hidden;">
            <div class="item-picker-header" style="border-radius: 16px 16px 0 0;">
                <h3> Select Reason</h3>
                <button class="item-picker-close" onclick="closeReasonPicker()">&times;</button>
            </div>
            <div id="reasonPickerList" class="item-picker-list" style="padding: 15px; max-height: 60vh; overflow-y: auto;">
                <!-- Reason options will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- UOM PICKER MODAL -->
    <div id="uomPickerModal" class="item-picker-overlay">
        <div class="item-picker-container styled-modal-container" style="max-width: 500px; width: 90%; height: auto; max-height: 90vh; margin: auto; border-radius: 16px; overflow: hidden;">
            <div class="item-picker-header" style="border-radius: 16px 16px 0 0;">
                <h3> Select Unit of Measure</h3>
                <button class="item-picker-close" onclick="closeUOMPicker()">&times;</button>
            </div>
            <div id="uomPickerList" class="item-picker-list" style="padding: 15px; max-height: 60vh; overflow-y: auto;">
                <!-- UOM options will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- THEME PICKER MODAL -->
    <div id="themePickerModal" class="item-picker-overlay">
        <div class="item-picker-container" style="max-width: 700px; width: 95%; height: 90vh; max-height: 90vh; margin: auto; border-radius: 16px; overflow: hidden;">
            <div class="item-picker-header" style="border-radius: 16px 16px 0 0; background: var(--primary, #667eea);">
                <h3> Choose Your Theme</h3>
                <button class="item-picker-close" onclick="closeThemePicker()">&times;</button>
            </div>
            <div class="item-picker-search" style="padding: 15px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">
                <input type="text" id="themePickerSearch" placeholder=" Search themes... (e.g. 'packers', 'blue', 'nfl')" oninput="filterThemePicker()" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px;">
            </div>
            <div id="themePickerList" class="item-picker-list" style="padding: 15px; flex: 1; overflow-y: auto;">
                <!-- Theme options will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- PO PICKER MODAL -->
    <div id="poPickerModal" class="item-picker-overlay">
        <div class="item-picker-container">
            <div class="item-picker-header">
                <h3> Select Purchase Order(s)</h3>
                <button class="item-picker-close" onclick="closePOPicker()">&times;</button>
            </div>
            <div class="item-picker-search">
                <input type="text" id="poPickerSearch" placeholder=" Search by PO number..." oninput="filterPOPicker()" onkeyup="filterPOPicker()">
            </div>
            <div id="poPickerList" class="item-picker-list" style="max-height: calc(100% - 180px);">
                <!-- POs will be populated by JavaScript -->
            </div>
            <div class="item-picker-footer" style="padding: 15px; border-top: 2px solid #e0e0e0; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                <div id="poSelectionCount" style="color: #666; font-size: 14px; font-weight: 600;"></div>
                <button class="btn" onclick="closePOPicker()" style="background: var(--primary, #667eea); color: white; padding: 10px 24px;"> Done</button>
            </div>
        </div>
    </div>

    <!-- STYLED ALERT MODAL -->
    <div id="styledAlertModal" class="item-picker-overlay" style="z-index: 999999;">
        <div class="item-picker-container styled-modal-container" style="max-width: 450px; width: 90%; height: auto; max-height: 90vh; margin: auto; border-radius: 16px; overflow: hidden;">
            <div id="styledAlertHeader" class="item-picker-header" style="background: var(--primary, #667eea);">
                <h3 id="styledAlertTitle"> Alert</h3>
                <button class="item-picker-close" onclick="closeStyledAlert()">&times;</button>
            </div>
            <div id="styledAlertContent" style="padding: 25px; font-size: 15px; line-height: 1.6; max-height: 50vh; overflow-y: auto; background: white;">
                <!-- Content will be inserted here -->
            </div>
            <div style="padding: 15px 25px 25px; display: flex; justify-content: flex-end; gap: 12px; background: #f8f9fa; border-top: 1px solid #e0e0e0;">
                <button id="styledAlertOkBtn" onclick="closeStyledAlert()" style="background: var(--primary, #667eea); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">OK</button>
            </div>
        </div>
    </div>

    <!-- STYLED CONFIRM MODAL -->
    <div id="styledConfirmModal" class="item-picker-overlay" style="z-index: 999999;">
        <div class="item-picker-container styled-modal-container" style="max-width: 500px; width: 90%; height: auto; max-height: 90vh; margin: auto; border-radius: 16px; overflow: hidden;">
            <div id="styledConfirmHeader" class="item-picker-header" style="background: var(--primary, #667eea);">
                <h3 id="styledConfirmTitle"> Confirm</h3>
                <button class="item-picker-close" onclick="resolveConfirm(false)">&times;</button>
            </div>
            <div id="styledConfirmContent" style="padding: 25px; font-size: 15px; line-height: 1.6; max-height: 50vh; overflow-y: auto; background: white;">
                <!-- Content will be inserted here -->
            </div>
            <div style="padding: 15px 25px 25px; display: flex; justify-content: flex-end; gap: 12px; background: #f8f9fa; border-top: 1px solid #e0e0e0;">
                <button id="styledConfirmCancelBtn" onclick="resolveConfirm(false)" style="background: #8a8a8a; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">Cancel</button>
                <button id="styledConfirmOkBtn" onclick="resolveConfirm(true)" style="background: var(--primary, #667eea); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">Confirm</button>
            </div>
        </div>
    </div>

    <!-- QUICK ADD ITEM MODAL (for adding items while creating PO) -->
    <div id="quickAddItemModal" class="item-picker-overlay">
        <div class="item-picker-container styled-modal-container" style="max-width: 500px; width: 95%; height: auto; max-height: 95vh; margin: auto; border-radius: 16px; overflow: hidden;">
            <div class="item-picker-header" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);">
                <h3 style="margin: 0; color: white;"> Quick Add Item to Catalog</h3>
                <button class="item-picker-close" onclick="closeQuickAddItem()" style="color: white;">&times;</button>
            </div>
            <div style="padding: 20px; overflow-y: auto; max-height: calc(95vh - 140px);">
                <form id="quickAddItemForm" onsubmit="saveQuickAddItem(event)">
                    <div style="display: grid; gap: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-weight: 600; color: #333;">SKU *</label>
                            <input type="text" id="quickItemSKU" required placeholder="e.g., DAD-CHIP-BBQ" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-weight: 600; color: #333;">Item Description *</label>
                            <input type="text" id="quickItemDescription" required placeholder="e.g., BBQ Potato Chips 1oz" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-weight: 600; color: #333;">Package Cost *</label>
                                <input type="number" id="quickItemCost" required step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px;">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-weight: 600; color: #333;">Sell Price *</label>
                                <input type="number" id="quickItemPrice" required step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px;">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-weight: 600; color: #333;">Units per Package *</label>
                                <input type="number" id="quickItemUnits" required min="1" value="24" placeholder="24" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px;">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-weight: 600; color: #333;">Purchase UOM</label>
                                <input type="text" id="quickItemUOM" value="Case" placeholder="Case" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px;">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-weight: 600; color: #333;">Reorder Point</label>
                                <input type="number" id="quickItemReorder" min="0" value="50" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px;">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-weight: 600; color: #333;">Starting Qty</label>
                                <input type="number" id="quickItemQty" min="0" value="0" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px;">
                            </div>
                        </div>
                        <input type="hidden" id="quickItemSupplier">
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 12px;">
                        <button type="button" onclick="closeQuickAddItem()" style="flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 8px; background: white; font-size: 15px; font-weight: 600; cursor: pointer;">Cancel</button>
                        <button type="submit" style="flex: 1; padding: 14px; border: none; border-radius: 8px; background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; font-size: 15px; font-weight: 600; cursor: pointer;"> Save & Add to PO</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ORDER PREVIEW MODAL (Customer-facing view for Sales Orders) -->
    <div id="orderPreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100000; overflow-y: auto; padding: 20px; box-sizing: border-box;">
        <div style="max-width: 500px; margin: 0 auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); color: white; padding: 20px; text-align: center;">
                <h2 style="margin: 0; font-size: 24px;"> Order Summary</h2>
                <p style="margin: 8px 0 0; opacity: 0.9; font-size: 14px;">Please verify your order</p>
            </div>
            
            <!-- Content -->
            <div id="orderPreviewContent" style="padding: 20px;">
                <!-- Populated by JavaScript -->
            </div>
            
            <!-- Footer -->
            <div style="padding: 15px 20px 20px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                <button type="button" onclick="closeOrderPreview()" style="flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 10px; background: white; color: #333; font-size: 15px; font-weight: 600; cursor: pointer;"> Back to Edit</button>
                <button type="button" id="soConfirmSaveBtn" onclick="submitSaleWithLoading(this)" style="flex: 1; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, #6b9a8d 0%, #6b9a8d 100%); color: white; font-size: 15px; font-weight: 600; cursor: pointer;"> Confirm & Save</button>
            </div>
        </div>
    </div>

    <!-- PO PREVIEW MODAL (For Purchase Orders) -->
    <div id="poPreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100000; overflow-y: auto; padding: 20px; box-sizing: border-box;">
        <div style="max-width: 500px; margin: 0 auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; padding: 20px; text-align: center;">
                <h2 style="margin: 0; font-size: 24px;"> Purchase Order Preview</h2>
                <p style="margin: 8px 0 0; opacity: 0.9; font-size: 14px;">Review before submitting</p>
            </div>
            
            <!-- Content -->
            <div id="poPreviewContent" style="padding: 20px;">
                <!-- Populated by JavaScript -->
            </div>
            
            <!-- Footer -->
            <div style="padding: 15px 20px 20px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                <button type="button" onclick="closePOPreview()" style="flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 10px; background: white; color: #333; font-size: 15px; font-weight: 600; cursor: pointer;"> Back to Edit</button>
                <button type="button" id="poConfirmSaveBtn" onclick="submitPOWithLoading(this)" style="flex: 1; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; font-size: 15px; font-weight: 600; cursor: pointer;"> Confirm & Save</button>
            </div>
        </div>
    </div>

    <!-- CREATE PO PREVIEW MODAL (For Outgoing/Placing Orders) -->
    <div id="createPOPreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100000; overflow-y: auto; padding: 20px; box-sizing: border-box;">
        <div style="max-width: 500px; margin: 0 auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 20px; text-align: center;">
                <h2 style="margin: 0; font-size: 24px;"> Confirm Purchase Order</h2>
                <p style="margin: 8px 0 0; opacity: 0.9; font-size: 14px;">Review before placing order</p>
            </div>
            
            <!-- Content -->
            <div id="createPOPreviewContent" style="padding: 20px;">
                <!-- Populated by JavaScript -->
            </div>
            
            <!-- Footer -->
            <div style="padding: 15px 20px 20px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                <button onclick="closeCreatePOPreview()" style="flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 10px; background: white; color: #333; font-size: 15px; font-weight: 600; cursor: pointer;"> Back to Edit</button>
                <button id="createPOConfirmBtn" onclick="submitCreatePOWithLoading(this)" style="flex: 1; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; font-size: 15px; font-weight: 600; cursor: pointer;"> Confirm & Place Order</button>
            </div>
        </div>
    </div>

    <!-- UNIVERSAL STATUS PICKER MODAL -->
    <!-- UNIVERSAL STATUS PICKER MODAL -->
    <div id="statusPickerModal" class="item-picker-overlay" style="display: none;">
        <div class="item-picker-container styled-modal-container" style="max-width: 450px; width: 90%; height: auto; max-height: 90vh; margin: auto; border-radius: 16px; overflow: hidden;">
            <div class="item-picker-header">
                <h3 id="statusPickerTitle"> Select Status</h3>
                <button class="item-picker-close" onclick="closeStatusPicker()">&times;</button>
            </div>
            <div id="statusPickerList" class="item-picker-list" style="padding: 15px;">
                <!-- Status options will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- INVOICE PICKER MODAL -->
    <div id="invoicePickerModal" class="item-picker-overlay">
        <div class="item-picker-container">
            <div class="item-picker-header">
                <h3> Select Invoice(s)</h3>
                <button class="item-picker-close" onclick="closeInvoicePicker()">&times;</button>
            </div>
            <div class="item-picker-search">
                <input type="text" id="invoicePickerSearch" placeholder=" Search by invoice number..." oninput="filterInvoicePicker()" onkeyup="filterInvoicePicker()">
            </div>
            <div id="invoicePickerList" class="item-picker-list" style="max-height: calc(100% - 180px);">
                <!-- Invoices will be populated by JavaScript -->
            </div>
            <div class="item-picker-footer" style="padding: 15px; border-top: 2px solid #e0e0e0; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                <div id="invoiceSelectionCount" style="color: #666; font-size: 14px; font-weight: 600;"></div>
                <button class="btn" onclick="closeInvoicePicker()" style="background: var(--primary, #667eea); color: white; padding: 10px 24px;"> Done</button>
            </div>
        </div>
    </div>

    <!-- ITEM PICKER MODAL (for reports) -->
    <!-- PO TYPE PICKER MODAL -->
    <div id="poTypePickerModal" class="item-picker-overlay">
        <div class="item-picker-container styled-modal-container" style="max-width: 400px; width: 90%; height: auto; max-height: 80vh; margin: auto; border-radius: 16px; overflow: hidden;">
            <div class="item-picker-header">
                <h3> Select PO Type</h3>
                <button class="item-picker-close" onclick="closePOTypePicker()">&times;</button>
            </div>
            <div id="poTypePickerList" class="item-picker-list" style="padding: 15px;">
                <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectPOType('', 'All Types')" onclick="selectPOType('', 'All Types')" style="border-left: 4px solid #8a8a8a; background: #f8f9fa; margin-bottom: 10px;">
                    <div class="item-picker-desc" style="font-weight: bold; color: #495057;">
                        <span style="font-size: 24px; margin-right: 12px;"></span> All Types
                    </div>
                    <div style="font-size: 13px; color: #8a8a8a; margin-top: 5px;">Show both inbound and outbound POs</div>
                </div>
                <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectPOType('INCOMING', 'Received (In Stock)')" onclick="selectPOType('INCOMING', 'Received (In Stock)')" style="border-left: 4px solid #6b9a8d; background: #e8f5e9; margin-bottom: 10px;">
                    <div class="item-picker-desc" style="font-weight: bold; color: #2e7d32;">
                        <span style="font-size: 24px; margin-right: 12px;"></span> Received (In Stock)
                    </div>
                    <div style="font-size: 13px; color: #388e3c; margin-top: 5px;">Products already received into inventory</div>
                </div>
                <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectPOType('OUTGOING', 'On Order (Pending)')" onclick="selectPOType('OUTGOING', 'On Order (Pending)')" style="border-left: 4px solid #1976d2; background: #e3f2fd; margin-bottom: 10px;">
                    <div class="item-picker-desc" style="font-weight: bold; color: #1565c0;">
                        <span style="font-size: 24px; margin-right: 12px;"></span> On Order (Pending)
                    </div>
                    <div style="font-size: 13px; color: #1976d2; margin-top: 5px;">PO sent to supplier, awaiting delivery</div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Mobile-Friendly Item Picker Styles */
        .item-picker-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 99999 !important;  /* Way above sticky elements (999) */
            padding: 0;
            /* Center styled modals */
            align-items: center;
            justify-content: center;
        }
        
        /* CRITICAL: Keep ALL picker modals hidden by default - only show when specific class is added */
        #statusPickerModal,
        #quickAddItemModal,
        #styledConfirmModal,
        #styledAlertModal,
        #itemPickerModal,
        #supplierPickerModal,
        #customerPickerModal,
        #reasonPickerModal,
        #uomPickerModal,
        #themePickerModal,
        #poPickerModal,
        #invoicePickerModal,
        #poTypePickerModal {
            display: none !important;
        }
        
        /* Only show when explicit open class is added */
        #statusPickerModal.modal-open,
        #quickAddItemModal.modal-open,
        #styledConfirmModal.modal-open,
        #styledAlertModal.modal-open,
        #itemPickerModal.modal-open,
        #supplierPickerModal.modal-open,
        #customerPickerModal.modal-open,
        #reasonPickerModal.modal-open,
        #uomPickerModal.modal-open,
        #themePickerModal.modal-open,
        #poPickerModal.modal-open,
        #invoicePickerModal.modal-open,
        #poTypePickerModal.modal-open {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        /* Legacy class support */
        #statusPickerModal.status-picker-open,
        #quickAddItemModal.quick-add-open {
            display: flex !important;
        }
        
        /* When overlay contains a styled-modal-container AND is shown, use flex centering */
        /* Note: The JavaScript will set display:flex when showing these modals */
        .item-picker-overlay.styled-modal-visible {
            display: flex !important;
        }
        
        .item-picker-container {
            background: #f5f5f5;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 100000 !important;  /* Ensure it's on top */
        }
        
        /* Styled modal containers (alerts, confirms) should NOT be full screen */
        .item-picker-container.styled-modal-container {
            width: 90% !important;
            max-width: 450px !important;
            height: auto !important;
            max-height: 85vh !important;
            margin: auto !important;
            border-radius: 16px !important;
            overflow: hidden !important;
        }
        
        @media (min-width: 768px) {
            .item-picker-container {
                margin: 40px auto;
                height: calc(100% - 80px);
                border-radius: 16px;
                overflow: hidden;
            }
            
            /* Show maximize button only on desktop */
            #reportMaximizeBtn {
                display: flex !important;
            }
        }
        
        .item-picker-header {
            background: var(--primary, #667eea);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .item-picker-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .item-picker-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 28px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .item-picker-search {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
        }
        
        .item-picker-search input {
            width: 100%;
            padding: 15px 20px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 12px;
            outline: none;
        }
        
        .item-picker-search input:focus {
            border-color: var(--primary, #667eea);
        }
        
        .item-picker-filter {
            padding: 10px 15px;
            background: white;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
        }
        
        .item-picker-filter select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        
        .item-picker-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            overscroll-behavior: contain;
            display: flex;
            flex-direction: column;
        }
        
        .item-picker-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            border: 2px solid transparent;
            border-left: 4px solid #c0c0c0;
            touch-action: pan-y;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            flex-shrink: 0;
            width: 100%;
            box-sizing: border-box;
        }
        
        .item-picker-footer {
            position: sticky !important;
            bottom: 0 !important;
            z-index: 100 !important;
            background: #f8f9fa !important;
            flex-shrink: 0 !important;
        }
        
        .item-picker-card:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        
        @media (hover: hover) {
            .item-picker-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 16px rgba(0,0,0,0.15);
                border-color: #999;
            }
        }
        
        .item-picker-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .item-picker-sku {
            background: #f0f0f0;
            color: #555;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
        }
        
        .item-picker-stock {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
        }
        
        .item-picker-stock.in-stock {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .item-picker-stock.low-stock {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .item-picker-stock.out-stock {
            background: #ffebee;
            color: #c62828;
        }
        
        .item-picker-desc {
            font-size: 17px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .item-picker-details {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .item-picker-detail {
            display: flex;
            flex-direction: column;
        }
        
        .item-picker-detail-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
        }
        
        .item-picker-detail-value {
            font-weight: bold;
            color: #333;
        }
        
        .item-picker-price {
            color: #2e7d32 !important;
            font-size: 18px !important;
        }
        
        .item-picker-supplier {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }
        
        .item-picker-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .item-picker-empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        /* Supplier card specific styling */
        .supplier-card:hover,
        .supplier-card:active {
            border-color: #999 !important;
        }
        
        /* Customer card specific styling */
        .customer-card:hover,
        .customer-card:active {
            border-color: #999 !important;
        }
        
        /* Make ALL select elements more tappable on mobile */
        @media (max-width: 768px) {
            select {
                min-height: 48px;
                font-size: 16px !important;
                padding: 12px !important;
            }
            
            #poSupplier, #soCustomer, #editPOSupplier, #editSOCustomer {
                background: linear-gradient(to right, #f8f9fa, #ffffff);
                border: 2px solid #ddd;
                border-radius: 8px;
                cursor: pointer;
            }
        }
        
        /* Make select elements more tappable on mobile */
        .po-item, .so-item, .createpo-item, .edit-item {
            min-height: 44px;
            font-size: 16px !important;
        }
        
        /* ========== MOBILE MODAL FIXES ========== */
        
        /* Prevent horizontal scroll only */
        html, body {
            overscroll-behavior-x: none;
        }
        
        @media (max-width: 768px) {
            html {
                overflow-x: hidden;
                overflow-y: auto !important; /* Allow vertical scroll */
            }
            
            body {
                overflow-x: hidden;
                overflow-y: auto !important; /* Allow vertical scroll */
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* Receive modal content */
        .receive-modal-content {
            max-height: 70vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (max-width: 768px) {
            .receive-modal-content {
                max-height: none !important;
                height: auto !important;
                overflow-y: visible !important;
            }
        }
        
        /* Landscape mode for receive modal */
        @media (max-height: 500px) and (orientation: landscape) {
            .receive-modal-content {
                max-height: none !important;
                height: auto !important;
                overflow-y: visible !important;
                padding: 10px !important;
            }
            
            .receive-modal-content h2 {
                font-size: 16px !important;
                padding: 5px 0 !important;
                margin-bottom: 5px !important;
            }
            
            .receive-modal-content table {
                font-size: 11px !important;
            }
            
            .receive-modal-content th,
            .receive-modal-content td {
                padding: 5px 4px !important;
            }
            
            .receive-modal-content input[type="number"] {
                width: 60px !important;
                padding: 4px !important;
                font-size: 14px !important;
            }
        }
        
        /* When any modal is open, prevent body scrolling */
        body.modal-open {
            overflow: hidden !important;
            /* Don't use position:fixed on iOS - causes scroll issues */
            touch-action: none !important;
        }
        
        /* iOS-specific fix for modal scrolling */
        @supports (-webkit-touch-callout: none) {
            body.modal-open {
                position: relative !important;
                height: 100% !important;
            }
        }
        
        /* Base modal overlay styles */
        #reportSetupModal,
        #orderModal,
        #itemPickerModal,
        #supplierPickerModal,
        #customerPickerModal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100% !important;
            height: 100% !important;
            overflow: hidden !important;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Z-index hierarchy - detail modals above report modals */
        #reportSetupModal { 
            z-index: 10000 !important; 
            padding: 20px !important;
            box-sizing: border-box !important;
        }
        #orderModal { 
            z-index: 10500 !important;
            padding: 20px !important;
            box-sizing: border-box !important;
        }
        #itemPickerModal,
        #supplierPickerModal,
        #customerPickerModal { z-index: 11000 !important; } /* Picker modals highest */
        
        /* Modal content container - DESKTOP: constrain to viewport, position at TOP */
        #reportSetupModalInner {
            position: relative !important;
            top: 0 !important;
            transform: none !important;
            max-height: calc(100vh - 40px) !important;
            max-width: 900px !important;
            margin: 0 auto !important;
            overflow: hidden !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        #orderModalInner {
            position: relative !important;
            top: 0 !important;
            transform: none !important;
            max-height: calc(100vh - 40px) !important;
            max-width: 900px !important;
            margin: 0 auto !important;
            overflow: hidden !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        /* Desktop report content scrolls */
        #reportSetupContent {
            flex: 1 !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            min-height: 0 !important;
        }
        
        /* GLOBAL FIX: Prevent horizontal overflow in all report content */
        #reportSetupContent > * {
            max-width: 100% !important;
            box-sizing: border-box !important;
        }
        
        #reportSetupContent > div {
            max-width: 100% !important;
            overflow-x: hidden !important;
            box-sizing: border-box !important;
        }
        
        /* Allow tables to scroll horizontally within their wrapper */
        #reportSetupContent [style*="overflow-x: auto"],
        #reportSetupContent .table-wrapper {
            overflow-x: auto !important;
            max-width: 100% !important;
        }
        
        /* Desktop report footer stays at bottom */
        #reportSetupFooter {
            flex-shrink: 0 !important;
            position: relative !important;
        }
        
        /* Order modal content scrolls */
        #modalContent {
            flex: 1 !important;
            overflow-y: auto !important;
            min-height: 0 !important;
        }
        
        /* Mobile-specific modal fixes */
        @media (max-width: 768px) {
            #reportSetupModal > div,
            #reportSetupModalInner,
            #orderModal > div,
            #orderModalInner {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
                min-width: 0 !important;
                min-height: 0 !important;
                width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                border-radius: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                resize: none !important;
                overflow: hidden !important;
            }
            
            /* Headers don't shrink */
            #orderModalHeader,
            #reportSetupModal > div > div:first-child {
                flex-shrink: 0 !important;
            }
            
            /* Footers don't shrink */
            #modalFooter,
            #reportSetupModal > div > div:last-child {
                flex-shrink: 0 !important;
            }
            
            /* Filters don't shrink */
            #reportSetupFilters {
                flex-shrink: 0 !important;
            }
            
            /* Report content area - scrollable vertically only */
            #reportSetupContent {
                flex: 1 !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch;
                min-height: 0 !important; /* Important for flex scrolling */
            }
            
            /* Ensure all report content children stay within bounds */
            #reportSetupContent > * {
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* Order modal content */
            #modalContent {
                flex: 1 !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch;
                min-height: 0 !important;
                max-height: none !important; /* Override inline style */
            }
            
            /* Hide maximize button on mobile - modal is already full screen */
            #reportMaximizeBtn {
                display: none !important;
            }
        }
        
        /* Landscape mode specific fixes */
        @media (max-height: 500px) and (orientation: landscape) {
            /* Make modal overlay fill screen */
            #reportSetupModal,
            #orderModal {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                padding: 0 !important;
                overflow: hidden !important;
                z-index: 99999 !important;
            }
            
            /* Make inner container fullscreen */
            #reportSetupModal > div,
            #reportSetupModalInner,
            #orderModal > div,
            #orderModalInner {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
                min-width: 0 !important;
                width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                min-height: 0 !important;
                border-radius: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                resize: none !important;
                overflow: hidden !important;
            }
            
            /* Compact header in landscape - DEBUG: red background */
            #reportSetupModal > div > div:first-child,
            #orderModal > div > div:first-child,
            #orderModalHeader {
                padding: 5px 10px !important;
                flex-shrink: 0 !important;
                min-height: 30px !important;
                max-height: 40px !important;
            }
            
            #reportSetupModal > div > div:first-child h2,
            #orderModal > div > div:first-child h2 {
                font-size: 14px !important;
            }
            
            /* HIDE filters in landscape to save space */
            #reportSetupFilters {
                display: none !important;
            }
            
            /* Hide maximize button in landscape - modal is already full screen */
            #reportMaximizeBtn {
                display: none !important;
            }
            
            /* Content area takes remaining space - NO HORIZONTAL SCROLL */
            #reportSetupContent {
                flex: 1 1 auto !important;
                min-height: 100px !important; /* Force minimum height */
                padding: 5px !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            /* Ensure all report children stay within bounds in landscape */
            #reportSetupContent > * {
                max-width: 100% !important;
                box-sizing: border-box !important;
                overflow-x: hidden !important;
            }
            
            /* Grid containers in reports - prevent overflow */
            #reportSetupContent [style*="display: grid"],
            #reportSetupContent [style*="grid-template-columns"] {
                max-width: 100% !important;
                overflow: hidden !important;
            }
            
            #modalContent {
                flex: 1 1 auto !important;
                min-height: 100px !important;
                padding: 5px !important;
                overflow: auto !important;
                -webkit-overflow-scrolling: touch !important;
                max-height: none !important;
            }
            
            /* Compact footer - DEBUG: blue background */
            #reportSetupModal > div > div:last-child {
                padding: 5px 10px !important;
                flex-shrink: 0 !important;
                min-height: 35px !important;
                max-height: 45px !important;
            }
            
            #reportSetupModal > div > div:last-child .btn {
                padding: 4px 10px !important;
                font-size: 12px !important;
            }
            
            /* Order modal footer */
            #modalFooter {
                padding: 5px 10px !important;
                flex-shrink: 0 !important;
                min-height: 35px !important;
                max-height: 45px !important;
            }
            
            #modalFooter .btn {
                padding: 4px 10px !important;
                font-size: 12px !important;
            }
        }
        
        /* Table horizontal scroll fix for reports */
        #reportSetupContent table {
            min-width: 500px; /* Force horizontal scroll on narrow screens */
        }
        
        #reportSetupContent .data-table {
            font-size: 13px;
        }
        
        /* Wrapper for horizontal table scrolling */
        #reportSetupContent > div[style*="overflow-x"] {
            max-width: 100%;
            overflow-x: auto !important;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (max-width: 768px) {
            #reportSetupContent .data-table {
                font-size: 12px;
            }
            
            #reportSetupContent .data-table th,
            #reportSetupContent .data-table td {
                padding: 8px 6px;
                white-space: nowrap;
            }
        }
        
        @media (max-height: 500px) and (orientation: landscape) {
            #reportSetupContent .data-table {
                font-size: 11px;
            }
            
            #reportSetupContent .data-table th,
            #reportSetupContent .data-table td {
                padding: 5px 4px;
            }
            
            #reportSetupContent h3 {
                font-size: 14px !important;
                margin: 0 0 5px 0 !important;
            }
            
            #reportSetupContent p {
                font-size: 11px !important;
                margin-bottom: 8px !important;
            }
        }
    </style>

    <script>
        // ==================== MOBILE ITEM PICKER ====================
        
        // itemPickerCallback declared in earlier script block
        let itemPickerSupplierFilter = '';
        
        // Bind search event properly when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Item picker - use window. since function is in different script block
            const searchInput = document.getElementById('itemPickerSearch');
            if (searchInput) {
                searchInput.addEventListener('input', window.filterItemPicker);
                searchInput.addEventListener('keyup', window.filterItemPicker);
            }
            const supplierFilter = document.getElementById('itemPickerSupplier');
            if (supplierFilter) {
                supplierFilter.addEventListener('change', window.filterItemPicker);
            }
            
            // Supplier picker
            const supplierSearchInput = document.getElementById('supplierPickerSearch');
            if (supplierSearchInput) {
                supplierSearchInput.addEventListener('input', filterSupplierPicker);
                supplierSearchInput.addEventListener('keyup', filterSupplierPicker);
            }
            
            // Customer picker
            const customerSearchInput = document.getElementById('customerPickerSearch');
            if (customerSearchInput) {
                customerSearchInput.addEventListener('input', filterCustomerPicker);
                customerSearchInput.addEventListener('keyup', filterCustomerPicker);
            }
        });
        
        function openItemPicker(selectElement, preSelectedSupplierId = null) {
            // Store callback to set value when item is selected
            window.itemPickerCallback = selectElement;
            
            // Reset filter mode flag
            window.itemPickerIsFilter = false;
            
            // ALWAYS refresh from cachedItems to get latest data
            window.itemPickerItems = cachedItems && cachedItems.length > 0 ? [...cachedItems] : [];
            
            // Check if we're in a context where supplier is already selected (PO forms)
            let supplierContext = preSelectedSupplierId;
            let isSalesContext = false;
            
            if (!supplierContext) {
                // Try to detect from Create PO form
                const createPOSupplier = document.getElementById('createPOSupplier');
                if (createPOSupplier && createPOSupplier.value) {
                    supplierContext = createPOSupplier.value;
                }
                // Try to detect from Purchase form (Record Purchase)
                const purchaseSupplier = document.getElementById('poSupplier');
                if (purchaseSupplier && purchaseSupplier.value) {
                    supplierContext = purchaseSupplier.value;
                }
            }
            
            // Only check for Sales context if we DON'T have a supplier context
            // This prevents false detection when both forms might exist in DOM
            if (!supplierContext) {
                const saleCustomer = document.getElementById('newSaleCustomer');
                const editSOCustomer = document.getElementById('editSOCustomer');
                if ((saleCustomer && saleCustomer.value) || (editSOCustomer && editSOCustomer.value)) {
                    isSalesContext = true;
                }
            }
            
            const supplierFilterDiv = document.getElementById('itemPickerSupplierFilter');
            const supplierSelect = document.getElementById('itemPickerSupplier');
            
            if (isSalesContext) {
                // SALES MODE: Hide supplier filter - show ALL items from all suppliers
                supplierFilterDiv.style.display = 'none';
                supplierSelect.value = ''; // No supplier filter
                window.itemPickerSupplierContext = ''; // Store globally
            } else if (supplierContext) {
                // PO MODE with supplier selected: Hide filter, only show that supplier's items
                supplierFilterDiv.style.display = 'none';
                supplierSelect.value = supplierContext;
                window.itemPickerSupplierContext = supplierContext; // Store globally
            } else {
                // OTHER MODE: Show supplier filter dropdown
                supplierFilterDiv.style.display = 'block';
                supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
                if (cachedSuppliers && cachedSuppliers.length > 0) {
                    cachedSuppliers.forEach(s => {
                        supplierSelect.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                    });
                }
                supplierSelect.value = '';
                window.itemPickerSupplierContext = ''; // No preset context
            }
            
            // Clear search
            document.getElementById('itemPickerSearch').value = '';
            
            // Render items
            renderItemPickerList();
            
            // Show modal
            document.getElementById('itemPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            
            // Focus search after a moment - only on desktop
            document.activeElement?.blur();
            focusOnDesktop('itemPickerSearch');
        }
        
        function closeItemPicker() {
            document.getElementById('itemPickerModal').classList.remove('modal-open');
            window.itemPickerCallback = null;
            window.multiSelectMode = false;
            window.multiSelectedItems = new Set();
            
            // Reset modal header
            const headerEl = document.querySelector('#itemPickerModal .item-picker-header h3');
            if (headerEl) headerEl.textContent = ' Select Item(s)';
            
            // Reset Done button
            const doneBtn = document.querySelector('#itemPickerModal .item-picker-footer button.btn');
            if (doneBtn) {
                doneBtn.textContent = ' Done';
                doneBtn.onclick = function() { closeItemPicker(); closeItemPickerForReport(); };
            }
            
            // Only remove modal-open if no other modals are open
            const reportModal = document.getElementById('reportSetupModal');
            const orderModal = document.getElementById('orderModal');
            const hasOpenModal = (reportModal && reportModal.style.display !== 'none') || 
                                 (orderModal && orderModal.style.display !== 'none');
            if (!hasOpenModal) {
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
            }
        }
        
        function selectItemFromPicker(itemId) {
            if (window.itemPickerCallback) {
                // Check if this is for inventory adjustment form
                if (window.itemPickerCallback.tagName === 'ADJUSTMENT_FORM') {
                    document.getElementById('adjustItem').value = itemId;
                    const item = (cachedItems || []).find(i => i.Item_ID === itemId);
                    if (item) {
                        document.getElementById('adjustItemDisplay').value = `${item.SKU} - ${item.Item_Description}`;
                        document.getElementById('adjustCurrentQty').value = parseInt(item.Qty_On_Hand) || 0;
                        updateAdjustNewQty();
                    }
                    window.adjustmentPickerActive = false;
                    closeItemPicker();
                    return;
                }
                
                // Check if this is a filter text input or a select element
                const isTextInput = window.itemPickerCallback.tagName === 'INPUT' && window.itemPickerCallback.type === 'text';
                
                if (isTextInput && window.itemPickerIsFilter) {
                    // For filter inputs, set the item description/SKU as value
                    const item = (cachedItems || []).find(i => i.Item_ID === itemId);
                    if (item) {
                        window.itemPickerCallback.value = item.SKU || item.Item_Description || itemId;
                    }
                    // Trigger the appropriate filter function based on input ID
                    const id = window.itemPickerCallback.id;
                    if (id === 'filterItemSearch') {
                        if (typeof filterItems === 'function') filterItems();
                    } else if (id === 'filterInventorySearch') {
                        if (typeof filterInventory === 'function') filterInventory();
                    } else if (id === 'pricesimSearch') {
                        if (typeof filterPriceSimItems === 'function') filterPriceSimItems();
                    }
                } else {
                    // Set the select value
                    window.itemPickerCallback.value = itemId;
                    
                    // Trigger change event to update any dependent fields
                    window.itemPickerCallback.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // Explicitly call update functions for mobile compatibility
                    if (window.itemPickerCallback.classList.contains('createpo-item')) {
                        updateCreatePOItemCost(window.itemPickerCallback);
                    } else if (window.itemPickerCallback.classList.contains('po-item')) {
                        updatePOItemInfo(window.itemPickerCallback);
                    } else if (window.itemPickerCallback.classList.contains('so-item')) {
                        if (typeof updateSOItemInfo === 'function') updateSOItemInfo(window.itemPickerCallback);
                    }
                    
                    // Recalculate totals after a brief delay to ensure DOM updates
                    setTimeout(() => {
                        if (typeof calculateCreatePOTotal === 'function') calculateCreatePOTotal();
                        if (typeof calculatePOTotal === 'function') calculatePOTotal();
                        if (typeof calculateSOTotal === 'function') calculateSOTotal();
                    }, 50);
                }
            }
            window.itemPickerIsFilter = false;
            closeItemPicker();
        }
        
        // Clear item filter and close picker
        function clearItemFilter() {
            if (window.itemPickerCallback) {
                window.itemPickerCallback.value = '';
                // Trigger the appropriate filter function
                const id = window.itemPickerCallback.id;
                if (id === 'filterItemSearch') {
                    if (typeof filterItems === 'function') filterItems();
                } else if (id === 'filterInventorySearch') {
                    if (typeof filterInventory === 'function') filterInventory();
                } else if (id === 'pricesimSearch') {
                    if (typeof filterPriceSimItems === 'function') filterPriceSimItems();
                }
            }
            window.itemPickerIsFilter = false;
            closeItemPicker();
        }
        
        // Auto-attach to item selects on ALL devices (not just mobile)
        function attachItemPickerToSelects() {
            // Attach to ALL item selects (forms + reports)
            document.querySelectorAll('.po-item, .so-item, .createpo-item, .edit-item, #filter_item').forEach(select => {
                if (!select.dataset.pickerAttached) {
                    select.dataset.pickerAttached = 'true';
                    // Use mousedown to intercept BEFORE the dropdown opens
                    select.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openItemPicker(this);
                    });
                    select.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openItemPicker(this);
                    });
                }
            });
        }
        
        // Re-attach when new rows are added
        const originalAddPORow = typeof addPurchaseLineItem === 'function' ? addPurchaseLineItem : null;
        const originalAddSORow = typeof addSaleLineItem === 'function' ? addSaleLineItem : null;
        const originalAddCreatePORow = typeof addCreatePOLine === 'function' ? addCreatePOLine : null;
        
        // Also attach when switching tabs
        const originalSwitchTab = typeof switchTab === 'function' ? switchTab : null;
        if (originalSwitchTab) {
            window.switchTabOriginal = switchTab;
            window.switchTab = function(tab) {
                switchTabOriginal(tab);
                setTimeout(attachItemPickerToSelects, 100);
                setTimeout(attachSupplierPickerToSelects, 100);
                setTimeout(attachCustomerPickerToSelects, 100);
                setTimeout(attachStatusPickerToSelects, 100);
            };
        }
        
        // ==================== SUPPLIER PICKER ====================
        
        let supplierPickerCallback = null;
        let supplierPickerIsFilter = false;  // Track if this is for a filter input
        
        // Open supplier picker for filter text inputs
        function openSupplierPickerForFilter(inputElement) {
            // Blur input to prevent mobile keyboard from appearing
            if (inputElement) inputElement.blur();
            document.activeElement?.blur();
            
            supplierPickerCallback = inputElement;
            supplierPickerIsFilter = true;
            document.getElementById('supplierPickerSearch').value = '';
            renderSupplierPickerList();
            document.getElementById('supplierPickerModal').classList.add('modal-open');
            document.body.classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            
            // Only focus search on desktop (not touch devices)
            if (!('ontouchstart' in window)) {
                setTimeout(() => {
                    document.getElementById('supplierPickerSearch').focus();
                }, 100);
            }
        }
        
        // Open item picker for filter text inputs
        function openItemPickerForFilter(inputElement) {
            // Blur input to prevent mobile keyboard from appearing
            if (inputElement) inputElement.blur();
            document.activeElement?.blur();
            
            window.itemPickerCallback = inputElement;
            window.itemPickerIsFilter = true;
            window.itemPickerSupplierContext = ''; // No supplier context for filters
            
            // Show supplier filter for filter context
            const supplierFilterDiv = document.getElementById('itemPickerSupplierFilter');
            if (supplierFilterDiv) {
                supplierFilterDiv.style.display = 'block';
            }
            
            // Populate supplier filter
            const supplierSelect = document.getElementById('itemPickerSupplier');
            supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
            if (cachedSuppliers && cachedSuppliers.length > 0) {
                cachedSuppliers.forEach(s => {
                    supplierSelect.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                });
            }
            
            // Get items from cache
            window.itemPickerItems = cachedItems || [];
            
            // Clear search
            document.getElementById('itemPickerSearch').value = '';
            document.getElementById('itemPickerSupplier').value = '';
            
            // Render items
            renderItemPickerList();
            
            // Show modal
            document.getElementById('itemPickerModal').classList.add('modal-open');
            document.body.classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            
            // Only focus search on desktop (not touch devices)
            if (!('ontouchstart' in window)) {
                setTimeout(() => {
                    document.getElementById('itemPickerSearch').focus();
                }, 100);
            }
        }
        
        // Open customer picker for filter text inputs
        function openCustomerPickerForFilter(inputElement) {
            // Blur input to prevent mobile keyboard from appearing
            if (inputElement) inputElement.blur();
            document.activeElement?.blur();
            
            customerPickerCallback = inputElement;
            window.customerPickerIsFilter = true;
            document.getElementById('customerPickerSearch').value = '';
            renderCustomerPickerList();
            document.getElementById('customerPickerModal').classList.add('modal-open');
            document.body.classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            
            // Only focus search on desktop (not touch devices)
            if (!('ontouchstart' in window)) {
                setTimeout(() => {
                    document.getElementById('customerPickerSearch').focus();
                }, 100);
            }
        }
        
        // Customer picker for report filters
        function openCustomerPickerForReport() {
            document.activeElement?.blur();
            
            window.reportPickerType = 'customer';
            window.customerPickerIsFilter = true; // Allow "All Customers" option
            customerPickerCallback = {
                tagName: 'REPORT_FILTER',
                value: document.getElementById('rptFilter_customer').value
            };
            
            // Initialize selected customers from current value
            const currentValue = document.getElementById('rptFilter_customer').value;
            if (currentValue) {
                selectedCustomersForReport = currentValue.split(',').filter(v => v);
            } else {
                selectedCustomersForReport = [];
            }
            
            document.getElementById('customerPickerSearch').value = '';
            renderCustomerPickerList();
            document.getElementById('customerPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('customerPickerSearch');
        }
        
        // Supplier picker for report filters
        function openSupplierPickerForReport() {
            document.activeElement?.blur();
            
            window.reportPickerType = 'supplier';
            window.supplierPickerIsFilter = true; // Allow "All Suppliers" option
            supplierPickerCallback = {
                tagName: 'REPORT_FILTER',
                value: document.getElementById('rptFilter_supplier').value
            };
            
            // Initialize selected suppliers from current value
            const currentValue = document.getElementById('rptFilter_supplier').value;
            if (currentValue) {
                selectedSuppliersForReport = currentValue.split(',').filter(v => v);
            } else {
                selectedSuppliersForReport = [];
            }
            
            document.getElementById('supplierPickerSearch').value = '';
            renderSupplierPickerList();
            document.getElementById('supplierPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('supplierPickerSearch');
        }
        
        // NEW: Supplier picker for report setup modal filters (filter_supplier)
        function openReportSupplierPicker() {
            document.activeElement?.blur();
            
            window.reportPickerType = 'supplier';
            window.supplierPickerIsFilter = true; // Allow "All Suppliers" option
            window.supplierPickerTarget = 'filter_supplier'; // Target the filter_supplier input
            supplierPickerCallback = {
                tagName: 'REPORT_SETUP_FILTER',
                value: document.getElementById('filter_supplier')?.value || ''
            };
            
            // Initialize selected suppliers from current value
            const currentValue = document.getElementById('filter_supplier')?.value || '';
            if (currentValue) {
                selectedSuppliersForReport = currentValue.split(',').filter(v => v);
            } else {
                selectedSuppliersForReport = [];
            }
            
            document.getElementById('supplierPickerSearch').value = '';
            renderSupplierPickerList();
            document.getElementById('supplierPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('supplierPickerSearch');
        }
        
        // Invoice picker for report filters (Pick List)
        async function openInvoicePickerForReport() {
            document.activeElement?.blur();
            
            // Use the existing invoice picker modal (defined in HTML)
            const modal = document.getElementById('invoicePickerModal');
            const listEl = document.getElementById('invoicePickerList');
            
            if (!modal || !listEl) {
                console.error('Invoice picker modal not found');
                return;
            }
            
            // Set flag for report mode
            window.invoicePickerForReport = true;
            
            // Show modal using modal-open class (same as other pickers)
            modal.classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            
            // Clear search
            const searchInput = document.getElementById('invoicePickerSearch');
            if (searchInput) searchInput.value = '';
            
            // Show loading
            listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading invoices...</div>';
            
            try {
                const salesResult = await apiCall('getSalesOrders');
                const customersResult = await apiCall('getCustomers');
                
                if (!salesResult?.data) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #b88a8a;">Failed to load invoices</div>';
                    return;
                }
                
                const customers = customersResult?.data || [];
                const customerMap = {};
                customers.forEach(c => customerMap[c.Customer_ID] = c.Customer_Name);
                
                // For reports, show ALL invoices (not just pending) excluding voided
                const allOrders = salesResult.data.filter(s => 
                    s.Status !== 'Voided'
                ).sort((a, b) => new Date(b.Sale_Date || b.SO_Date) - new Date(a.Sale_Date || a.SO_Date));
                
                // Store for filtering
                window.invoicePickerData = allOrders.map(s => ({
                    id: s.SO_ID,
                    invoiceNum: s.Invoice_Number || s.SO_Number || s.SO_ID,
                    customerId: s.Customer_ID,
                    customerName: customerMap[s.Customer_ID] || s.Customer_ID,
                    date: s.Sale_Date || s.SO_Date,
                    status: s.Status || 'Pending',
                    amount: parseFloat(s.Total_Amount) || 0
                }));
                
                renderInvoicePickerList();
                focusOnDesktop('invoicePickerSearch');
            } catch(e) {
                listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #b88a8a;">Error: ' + e.message + '</div>';
            }
        }
        
        function renderInvoicePickerList() {
            const listEl = document.getElementById('invoicePickerList');
            if (!listEl) return;
            
            const search = (document.getElementById('invoicePickerSearch')?.value || '').toLowerCase();
            const data = window.invoicePickerData || [];
            
            const filtered = data.filter(inv => {
                if (!search) return true;
                return inv.invoiceNum.toLowerCase().includes(search) ||
                       inv.customerName.toLowerCase().includes(search);
            });
            
            let html = `
                <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectInvoiceForReport('')" onclick="selectInvoiceForReport('')" 
                    style="border-left: 4px solid #10b981; background: #ecfdf5; user-select: none;">
                    <div style="pointer-events: none;">
                        <div class="item-picker-desc" style="font-weight: bold; color: #059669;">
                            <span style="font-size: 20px; margin-right: 8px;"></span> All Invoices
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">Show all pending orders</div>
                    </div>
                </div>
            `;
            
            if (filtered.length === 0) {
                html += '<div style="text-align: center; padding: 30px; color: #666;">No invoices found</div>';
            } else {
                filtered.slice(0, 50).forEach(inv => {
                    const statusColors = {
                        'Pending': '#b8a86b',
                        'Ready': '#3b82f6',
                        'Out for Delivery': '#8b5cf6'
                    };
                    const statusColor = statusColors[inv.status] || '#666';
                    
                    html += `
                        <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectInvoiceForReport('${inv.invoiceNum}')" onclick="selectInvoiceForReport('${inv.invoiceNum}')" 
                            style="user-select: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; pointer-events: none;">
                                <div>
                                    <div class="item-picker-desc" style="font-weight: 600; color: #1f2937;"> ${inv.invoiceNum}</div>
                                    <div style="font-size: 13px; color: #6b7280; margin-top: 2px;"> ${inv.customerName}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 600; color: #059669;">${formatMoney(inv.amount)}</div>
                                    <div style="font-size: 11px; padding: 2px 8px; border-radius: 10px; background: ${statusColor}20; color: ${statusColor}; margin-top: 3px;">${inv.status}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                if (filtered.length > 50) {
                    html += `<div style="text-align: center; padding: 10px; color: #666; font-size: 13px;">Showing 50 of ${filtered.length} invoices. Type to search more...</div>`;
                }
            }
            
            listEl.innerHTML = html;
        }
        
        function filterInvoicePickerList() {
            renderInvoicePickerList();
        }
        
        // Also handle the original filterInvoicePicker for compatibility
        function filterInvoicePicker() {
            if (window.invoicePickerForReport) {
                renderInvoicePickerList();
            }
        }
        
        function selectInvoiceForReport(invoiceNum) {
            // Check if this is for sales filter or report filter
            if (invoicePickerCallback && invoicePickerCallback.tagName === 'SALES_FILTER') {
                // Sales filter - set the filter value and apply
                const hiddenInput = document.getElementById('filterInvoiceNumber');
                const displayInput = document.getElementById('filterInvoiceNumber_display');
                if (hiddenInput) hiddenInput.value = invoiceNum;
                if (displayInput) displayInput.value = invoiceNum ? ' ' + invoiceNum : '';
                closeInvoicePicker();
                filterSales(); // Apply the filter
            } else {
                // Report filter
                const hiddenInput = document.getElementById('rptFilter_salesInvoice');
                const displayInput = document.getElementById('rptFilter_salesInvoice_display');
                if (hiddenInput) hiddenInput.value = invoiceNum;
                if (displayInput) displayInput.value = invoiceNum ? ' ' + invoiceNum : ' All Invoices';
                closeInvoicePicker();
            }
        }
        
        function selectInvoice(invoiceNum) {
            // If in report mode, use report version
            if (window.invoicePickerForReport) {
                selectInvoiceForReport(invoiceNum);
            }
        }
        
        function closeInvoicePicker() {
            const modal = document.getElementById('invoicePickerModal');
            if (modal) {
                modal.classList.remove('modal-open');
                modal.style.display = 'none';
            }
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open');
            window.invoicePickerForReport = false;
            invoicePickerCallback = null;
        }
        
        // ==================== STYLED ALERT & CONFIRM MODALS ====================
        
        // Styled Alert - replaces browser alert()
        function showStyledAlert(title, message, type = 'info') {
            const colors = {
                info: '#667eea',
                success: '#10b981',
                warning: '#b8a86b',
                error: '#b88a8a'
            };
            const icons = {
                info: '',
                success: '',
                warning: '',
                error: ''
            };
            
            document.getElementById('styledAlertHeader').style.background = colors[type] || colors.info;
            document.getElementById('styledAlertTitle').textContent = `${icons[type] || icons.info} ${title}`;
            document.getElementById('styledAlertContent').innerHTML = message.replace(/\n/g, '<br>');
            document.getElementById('styledAlertModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
        }
        
        function closeStyledAlert() {
            document.getElementById('styledAlertModal').classList.remove('modal-open');
            document.body.style.overflow = '';
            if (window.alertResolve) {
                window.alertResolve();
                window.alertResolve = null;
            }
        }
        
        // Async version for await
        function showAlertModal(title, message, type = 'info') {
            return new Promise(resolve => {
                window.alertResolve = resolve;
                showStyledAlert(title, message, type);
            });
        }
        
        // Styled Confirm - replaces browser confirm()
        let confirmResolve = null;
        
        function showConfirmModal(title, message, confirmText = 'Confirm', cancelText = 'Cancel', type = 'info') {
            return new Promise(resolve => {
                confirmResolve = resolve;
                
                const colors = {
                    info: '#667eea',
                    success: '#10b981',
                    warning: '#b8a86b',
                    error: '#b88a8a',
                    danger: '#b88a8a'
                };
                const icons = {
                    info: '',
                    success: '',
                    warning: '',
                    error: '',
                    danger: ''
                };
                
                const headerColor = colors[type] || colors.info;
                document.getElementById('styledConfirmHeader').style.background = headerColor;
                document.getElementById('styledConfirmTitle').textContent = `${icons[type] || icons.info} ${title}`;
                document.getElementById('styledConfirmContent').innerHTML = typeof message === 'string' ? message.replace(/\n/g, '<br>') : message;
                document.getElementById('styledConfirmOkBtn').textContent = confirmText;
                document.getElementById('styledConfirmOkBtn').style.background = headerColor;
                document.getElementById('styledConfirmCancelBtn').textContent = cancelText;
                document.getElementById('styledConfirmModal').classList.add('modal-open');
                document.body.style.overflow = 'hidden';
            });
        }
        
        function resolveConfirm(result) {
            document.getElementById('styledConfirmModal').classList.remove('modal-open');
            document.body.style.overflow = '';
            if (confirmResolve) {
                confirmResolve(result);
                confirmResolve = null;
            }
        }
        
        // Quick helpers for common patterns
        function showSuccess(message) {
            showStyledAlert('Success', message, 'success');
        }
        
        function showError(message) {
            showStyledAlert('Error', message, 'error');
        }
        
        function showWarning(message) {
            showStyledAlert('Warning', message, 'warning');
        }
        
        function showInfo(message) {
            showStyledAlert('Info', message, 'info');
        }
        
        // ==================== RECORD PREVIEW/CONFIRM ====================
        // Shows a confirmation modal before creating or updating a record
        function showRecordPreview(type, data, originalData, onConfirm) {
            return new Promise((resolve) => {
                const isUpdate = !!originalData;
                const typeLabels = {
                    supplier: { icon: '', name: 'Supplier', color: '#7c3aed' },
                    customer: { icon: '', name: 'Customer', color: '#0891b2' },
                    item: { icon: '', name: 'Item', color: '#059669' }
                };
                const typeInfo = typeLabels[type] || { icon: '', name: 'Record', color: '#6b7280' };
                
                // Fields to skip in comparison (IDs and internal fields that don't change)
                const skipFields = ['supplierId', 'customerId', 'itemId', 'fax'];
                
                let contentHtml = '';
                
                if (isUpdate) {
                    // Show what changed - only compare fields that exist in BOTH objects
                    const changes = [];
                    for (const key in originalData) {
                        // Skip ID fields and internal fields
                        if (skipFields.includes(key)) continue;
                        
                        const oldVal = originalData[key] || '';
                        const newVal = data[key] || '';
                        if (String(oldVal).trim() !== String(newVal).trim()) {
                            const fieldName = key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
                            changes.push({ field: fieldName, old: oldVal || '(empty)', new: newVal || '(empty)' });
                        }
                    }
                    
                    if (changes.length === 0) {
                        showInfo('No changes detected.');
                        resolve(false);
                        return;
                    }
                    
                    contentHtml = `
                        <div style="margin-bottom: 15px; font-size: 14px; color: #666;">
                            The following changes will be saved:
                        </div>
                    `;
                    changes.forEach(c => {
                        contentHtml += `
                            <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">${c.field}</div>
                                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                    <span style="color: #b88a8a; text-decoration: line-through; font-size: 13px;">${c.old}</span>
                                    <span style="color: #666;"></span>
                                    <span style="color: #059669; font-weight: 600; font-size: 13px;">${c.new}</span>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    // Show new record summary - skip ID fields
                    contentHtml = `
                        <div style="margin-bottom: 15px; font-size: 14px; color: #666;">
                            Creating new ${typeInfo.name.toLowerCase()}:
                        </div>
                    `;
                    for (const key in data) {
                        // Skip ID fields
                        if (skipFields.includes(key)) continue;
                        
                        if (data[key] && String(data[key]).trim()) {
                            const fieldName = key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
                            contentHtml += `
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                    <span style="color: #666; font-size: 13px;">${fieldName}</span>
                                    <span style="font-weight: 600; font-size: 13px;">${data[key]}</span>
                                </div>
                            `;
                        }
                    }
                }
                
                // Create modal
                const modal = document.createElement('div');
                modal.id = 'recordPreviewModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100001; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;';
                
                modal.innerHTML = `
                    <div style="max-width: 450px; width: 100%; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="background: linear-gradient(135deg, ${typeInfo.color} 0%, ${typeInfo.color}dd 100%); color: white; padding: 20px; text-align: center;">
                            <h2 style="margin: 0; font-size: 22px;">${typeInfo.icon} ${isUpdate ? 'Confirm Changes' : 'Confirm New ' + typeInfo.name}</h2>
                            <p style="margin: 8px 0 0; opacity: 0.9; font-size: 14px;">${isUpdate ? 'Review changes before saving' : 'Review before creating'}</p>
                        </div>
                        <div style="padding: 20px; max-height: 50vh; overflow-y: auto;">
                            ${contentHtml}
                        </div>
                        <div style="padding: 15px 20px 20px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                            <button id="recordPreviewCancel" style="flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 10px; background: white; font-size: 15px; font-weight: 600; cursor: pointer;"> Cancel</button>
                            <button id="recordPreviewConfirm" style="flex: 1; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, ${typeInfo.color} 0%, ${typeInfo.color}dd 100%); color: white; font-size: 15px; font-weight: 600; cursor: pointer;"> ${isUpdate ? 'Save Changes' : 'Create'}</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                document.body.style.overflow = 'hidden';
                
                const cleanup = () => {
                    modal.remove();
                    document.body.style.overflow = '';
                };
                
                modal.querySelector('#recordPreviewCancel').onclick = () => { cleanup(); resolve(false); };
                modal.querySelector('#recordPreviewConfirm').onclick = () => { cleanup(); resolve(true); };
            });
        }
        
        // Show changes preview for PO/SO edits
        function showOrderChangesPreview(type, newData, originalOrder) {
            return new Promise((resolve) => {
                const isPO = type === 'po';
                const typeInfo = isPO 
                    ? { icon: '', name: 'Purchase Order', color: '#7c3aed' }
                    : { icon: '', name: 'Sales Order', color: '#0891b2' };
                
                const changes = [];
                
                // Compare header fields
                const fieldMappings = isPO ? {
                    'Status': { new: newData.status, old: originalOrder.Status },
                    'Invoice #': { new: newData.invoiceNumber, old: originalOrder.Invoice_Number },
                    'Order Date': { new: newData.poDate, old: originalOrder.PO_Date?.split('T')[0] },
                    'Due Date': { new: newData.dueDate, old: originalOrder.Due_Date?.split('T')[0] },
                    'Amount Paid': { new: formatMoney(newData.amountPaid || 0), old: formatMoney(originalOrder.Amount_Paid || 0) },
                    'Notes': { new: newData.notes || '', old: originalOrder.Notes || '' }
                } : {
                    'Status': { new: newData.status, old: originalOrder.Status },
                    'Order Date': { new: newData.soDate, old: (originalOrder.Sale_Date || originalOrder.SO_Date)?.split('T')[0] },
                    'Due Date': { new: newData.dueDate, old: originalOrder.Due_Date?.split('T')[0] },
                    'Amount Paid': { new: formatMoney(newData.amountPaid || 0), old: formatMoney(originalOrder.Amount_Paid || 0) },
                    'Notes': { new: newData.notes || '', old: originalOrder.Notes || '' }
                };
                
                for (const [fieldName, values] of Object.entries(fieldMappings)) {
                    const oldVal = String(values.old || '').trim();
                    const newVal = String(values.new || '').trim();
                    if (oldVal !== newVal) {
                        changes.push({ field: fieldName, old: oldVal || '(empty)', new: newVal || '(empty)' });
                    }
                }
                
                // Compare totals
                const oldTotal = parseFloat(originalOrder.Total_Amount) || 0;
                const newTotal = parseFloat(newData.totalAmount) || 0;
                if (Math.abs(oldTotal - newTotal) > 0.01) {
                    changes.push({ field: 'Total Amount', old: formatMoney(oldTotal), new: formatMoney(newTotal) });
                }
                
                // Compare line items
                const originalLines = originalOrder._originalLines || [];
                const newLines = newData.lineItems || [];
                
                // Check for added/removed/changed items
                const lineChanges = [];
                
                // Find changed or removed items
                originalLines.forEach(origLine => {
                    const newLine = newLines.find(n => n.lineId === origLine.Line_ID || n.itemId === origLine.Item_ID);
                    if (!newLine) {
                        const item = cachedItems.find(i => i.Item_ID === origLine.Item_ID);
                        lineChanges.push({ type: 'removed', item: item?.Item_Description || origLine.Item_ID, oldQty: origLine.Quantity });
                    } else if (newLine.quantity !== parseInt(origLine.Quantity) || Math.abs(newLine.unitCost - parseFloat(origLine.Unit_Cost || origLine.Unit_Price || 0)) > 0.01) {
                        const item = cachedItems.find(i => i.Item_ID === origLine.Item_ID);
                        lineChanges.push({ 
                            type: 'changed', 
                            item: item?.Item_Description || origLine.Item_ID,
                            oldQty: origLine.Quantity,
                            newQty: newLine.quantity,
                            oldCost: origLine.Unit_Cost || origLine.Unit_Price,
                            newCost: newLine.unitCost
                        });
                    }
                });
                
                // Find added items
                newLines.forEach(newLine => {
                    const wasOriginal = originalLines.some(o => o.Line_ID === newLine.lineId || o.Item_ID === newLine.itemId);
                    if (!wasOriginal && !newLine.lineId) {
                        const item = cachedItems.find(i => i.Item_ID === newLine.itemId);
                        lineChanges.push({ type: 'added', item: item?.Item_Description || newLine.itemId, newQty: newLine.quantity });
                    }
                });
                
                // Build content HTML
                let contentHtml = '';
                
                if (changes.length === 0 && lineChanges.length === 0) {
                    showInfo('No changes detected.');
                    resolve(false);
                    return;
                }
                
                if (changes.length > 0) {
                    contentHtml += `<div style="margin-bottom: 15px; font-size: 14px; color: #666; font-weight: 600;">Header Changes:</div>`;
                    changes.forEach(c => {
                        contentHtml += `
                            <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">${c.field}</div>
                                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                    <span style="color: #b88a8a; text-decoration: line-through; font-size: 13px;">${c.old}</span>
                                    <span style="color: #666;"></span>
                                    <span style="color: #059669; font-weight: 600; font-size: 13px;">${c.new}</span>
                                </div>
                            </div>
                        `;
                    });
                }
                
                if (lineChanges.length > 0) {
                    contentHtml += `<div style="margin: 15px 0; font-size: 14px; color: #666; font-weight: 600;">Line Item Changes:</div>`;
                    lineChanges.forEach(lc => {
                        if (lc.type === 'added') {
                            contentHtml += `
                                <div style="background: #ecfdf5; padding: 10px; border-radius: 8px; margin-bottom: 6px; border-left: 4px solid #10b981;">
                                    <span style="color: #059669; font-weight: 600;"> Added:</span> ${lc.item} (Qty: ${lc.newQty})
                                </div>`;
                        } else if (lc.type === 'removed') {
                            contentHtml += `
                                <div style="background: #fef2f2; padding: 10px; border-radius: 8px; margin-bottom: 6px; border-left: 4px solid #b88a8a;">
                                    <span style="color: #b88a8a; font-weight: 600;"> Removed:</span> ${lc.item} (was Qty: ${lc.oldQty})
                                </div>`;
                        } else {
                            contentHtml += `
                                <div style="background: #fffbeb; padding: 10px; border-radius: 8px; margin-bottom: 6px; border-left: 4px solid #b8a86b;">
                                    <span style="color: #d97706; font-weight: 600;"> Changed:</span> ${lc.item}<br>
                                    <span style="font-size: 12px; color: #666;">Qty: ${lc.oldQty}  ${lc.newQty}</span>
                                </div>`;
                        }
                    });
                }
                
                // Create modal
                const modal = document.createElement('div');
                modal.id = 'orderChangesPreviewModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100001; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;';
                
                modal.innerHTML = `
                    <div style="max-width: 500px; width: 100%; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="background: linear-gradient(135deg, ${typeInfo.color} 0%, ${typeInfo.color}dd 100%); color: white; padding: 20px; text-align: center;">
                            <h2 style="margin: 0; font-size: 22px;">${typeInfo.icon} Confirm Changes</h2>
                            <p style="margin: 8px 0 0; opacity: 0.9; font-size: 14px;">Review changes before saving</p>
                        </div>
                        <div style="padding: 20px; max-height: 50vh; overflow-y: auto;">
                            ${contentHtml}
                        </div>
                        <div style="padding: 15px 20px 20px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                            <button id="orderChangesCancel" style="flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 10px; background: white; font-size: 15px; font-weight: 600; cursor: pointer;"> Cancel</button>
                            <button id="orderChangesConfirm" style="flex: 1; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, ${typeInfo.color} 0%, ${typeInfo.color}dd 100%); color: white; font-size: 15px; font-weight: 600; cursor: pointer;"> Save Changes</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                document.body.style.overflow = 'hidden';
                
                const cleanup = () => {
                    modal.remove();
                    document.body.style.overflow = '';
                };
                
                modal.querySelector('#orderChangesCancel').onclick = () => { cleanup(); resolve(false); };
                modal.querySelector('#orderChangesConfirm').onclick = () => { cleanup(); resolve(true); };
            });
        }
        
        // ==================== UNIVERSAL STATUS PICKER ====================
        let statusPickerCallback = null;
        let statusPickerTargetId = null;
        
        const STATUS_OPTIONS = {
            // Purchase Order Status
            poStatus: {
                title: ' Select PO Status',
                options: [
                    { value: 'Ordered', label: 'Ordered - Sent to supplier', icon: '', color: '#b8a86b', bg: '#fff7ed' },
                    { value: 'In Transit', label: 'In Transit - Shipped, on the way', icon: '', color: '#3b82f6', bg: '#eff6ff' },
                    { value: 'Partial', label: 'Partial - Some items received', icon: '', color: '#8b5cf6', bg: '#f5f3ff' },
                    { value: 'Received', label: 'Received - All items received', icon: '', color: '#10b981', bg: '#ecfdf5' },
                    { value: 'Voided', label: 'Voided - Cancelled', icon: '', color: '#b88a8a', bg: '#fef2f2' }
                ]
            },
            // Sales Order Status
            soStatus: {
                title: ' Select Order Status',
                options: [
                    { value: 'Pending', label: 'Pending - Awaiting fulfillment', icon: '', color: '#b8a86b', bg: '#fff7ed' },
                    { value: 'Ready for Pickup', label: 'Ready for Pickup', icon: '', color: '#3b82f6', bg: '#eff6ff' },
                    { value: 'Out for Delivery', label: 'Out for Delivery', icon: '', color: '#8b5cf6', bg: '#f5f3ff' },
                    { value: 'Delivered', label: 'Delivered - Awaiting payment', icon: '', color: '#6b9a8d', bg: '#f0fdfa' },
                    { value: 'Completed', label: 'Completed - Paid & delivered', icon: '', color: '#6b9a8d', bg: '#dcfce7' },
                    { value: 'Voided', label: 'Voided - Cancelled', icon: '', color: '#b88a8a', bg: '#fef2f2' }
                ]
            },
            // Payment Method
            paymentMethod: {
                title: ' Select Payment Method',
                options: [
                    { value: 'Cash', label: 'Cash', icon: '', color: '#10b981', bg: '#ecfdf5' },
                    { value: 'Check', label: 'Check', icon: '', color: '#3b82f6', bg: '#eff6ff' },
                    { value: 'Credit Card', label: 'Credit Card', icon: '', color: '#8b5cf6', bg: '#f5f3ff' },
                    { value: 'Invoice', label: 'Invoice (Net Terms)', icon: '', color: '#b8a86b', bg: '#fff7ed' }
                ]
            },
            // Payment Terms (for PO)
            paymentTerms: {
                title: ' Select Payment Terms',
                options: [
                    { value: 'Net 30', label: 'Net 30 - Due in 30 days', icon: '', color: '#3b82f6', bg: '#eff6ff' },
                    { value: 'Net 60', label: 'Net 60 - Due in 60 days', icon: '', color: '#6366f1', bg: '#eef2ff' },
                    { value: 'COD', label: 'COD - Paid at pickup', icon: '', color: '#10b981', bg: '#ecfdf5' },
                    { value: 'Prepaid', label: 'Prepaid - Paid in advance', icon: '', color: '#059669', bg: '#d1fae5' }
                ]
            },
            // Payment Status Filter
            paymentStatus: {
                title: ' Select Payment Status',
                options: [
                    { value: '', label: 'All Payment Statuses', icon: '', color: '#6b7280', bg: '#f3f4f6' },
                    { value: 'Paid', label: 'Paid - Fully paid', icon: '', color: '#10b981', bg: '#ecfdf5' },
                    { value: 'Partial', label: 'Partial - Some paid', icon: '', color: '#b8a86b', bg: '#fff7ed' },
                    { value: 'Unpaid', label: 'Unpaid - Nothing paid', icon: '', color: '#b88a8a', bg: '#fef2f2' }
                ]
            },
            // Purchase Filter Status
            filterPurchaseStatus: {
                title: ' Filter by PO Status',
                options: [
                    { value: '', label: 'All Statuses', icon: '', color: '#6b7280', bg: '#f3f4f6' },
                    { value: 'Ordered', label: 'Ordered (Pending)', icon: '', color: '#b8a86b', bg: '#fff7ed' },
                    { value: 'Received', label: 'Received', icon: '', color: '#10b981', bg: '#ecfdf5' },
                    { value: 'Voided', label: 'Voided', icon: '', color: '#b88a8a', bg: '#fef2f2' },
                    { value: 'exclude-voided', label: 'Exclude Voided', icon: '', color: '#6b7280', bg: '#f3f4f6' }
                ]
            },
            // Sales Filter Status
            filterSaleStatus: {
                title: ' Filter by Order Status',
                options: [
                    { value: '', label: 'All Statuses', icon: '', color: '#6b7280', bg: '#f3f4f6' },
                    { value: 'Pending', label: 'Pending', icon: '', color: '#b8a86b', bg: '#fff7ed' },
                    { value: 'Ready for Pickup', label: 'Ready for Pickup', icon: '', color: '#3b82f6', bg: '#eff6ff' },
                    { value: 'Out for Delivery', label: 'Out for Delivery', icon: '', color: '#8b5cf6', bg: '#f5f3ff' },
                    { value: 'Delivered', label: 'Delivered - Awaiting payment', icon: '', color: '#6b9a8d', bg: '#f0fdfa' },
                    { value: 'Completed', label: 'Completed - Paid & delivered', icon: '', color: '#6b9a8d', bg: '#dcfce7' },
                    { value: 'Voided', label: 'Voided', icon: '', color: '#b88a8a', bg: '#fef2f2' },
                    { value: 'exclude-voided', label: 'Exclude Voided', icon: '', color: '#6b7280', bg: '#f3f4f6' }
                ]
            },
            // Transaction Status (for reports)
            transactionStatus: {
                title: ' Transaction Status',
                options: [
                    { value: 'exclude-voided', label: 'Exclude Voided', icon: '', color: '#6b7280', bg: '#f3f4f6' },
                    { value: '', label: 'All Transactions', icon: '', color: '#6b7280', bg: '#f3f4f6' },
                    { value: 'Completed', label: 'Completed Only', icon: '', color: '#10b981', bg: '#ecfdf5' },
                    { value: 'Pending', label: 'Pending Only', icon: '', color: '#b8a86b', bg: '#fff7ed' },
                    { value: 'Voided', label: 'Voided Only', icon: '', color: '#b88a8a', bg: '#fef2f2' }
                ]
            },
            // Delivery Status (for reports)
            deliveryStatus: {
                title: ' Delivery Status',
                options: [
                    { value: 'needs-delivery', label: 'Needs Delivery (Pending/Ready/Out)', icon: '', color: '#b8a86b', bg: '#fff7ed' },
                    { value: '', label: 'All Orders', icon: '', color: '#6b7280', bg: '#f3f4f6' },
                    { value: 'pending', label: 'Pending Only', icon: '', color: '#b8a86b', bg: '#fff7ed' },
                    { value: 'ready', label: 'Ready for Pickup Only', icon: '', color: '#3b82f6', bg: '#eff6ff' },
                    { value: 'out', label: 'Out for Delivery Only', icon: '', color: '#8b5cf6', bg: '#f5f3ff' },
                    { value: 'delivered', label: 'Delivered/Completed', icon: '', color: '#10b981', bg: '#ecfdf5' }
                ]
            },
            // Stock Status (for inventory filter)
            stock: {
                title: ' Stock Status',
                options: [
                    { value: '', label: 'All Items', icon: '', color: '#6b7280', bg: '#f3f4f6' },
                    { value: 'negative', label: 'Negative Stock', icon: '', color: '#b88a8a', bg: '#fef2f2' },
                    { value: 'out', label: 'Out of Stock', icon: '', color: '#b88a8a', bg: '#fef2f2' },
                    { value: 'low', label: 'Low Stock', icon: '', color: '#b8a86b', bg: '#fff7ed' },
                    { value: 'ok', label: 'In Stock', icon: '', color: '#10b981', bg: '#ecfdf5' }
                ]
            },
            // Adjustment Type (for inventory adjustments report)
            adjustmentType: {
                title: ' Adjustment Type',
                options: [
                    { value: '', label: 'All Types', icon: '', color: '#6b7280', bg: '#f3f4f6' },
                    { value: 'VOID REVERSAL', label: 'Void Reversals', icon: '', color: '#b88a8a', bg: '#fef2f2' },
                    { value: 'Manual', label: 'Manual Adjustments', icon: '', color: '#8b5cf6', bg: '#f5f3ff' },
                    { value: 'Sale', label: 'Sales (Out)', icon: '', color: '#b8a86b', bg: '#fff7ed' },
                    { value: 'Purchase', label: 'Purchases (In)', icon: '', color: '#10b981', bg: '#ecfdf5' },
                    { value: 'OUTGOING', label: 'On Order (Pending)', icon: '', color: '#3b82f6', bg: '#eff6ff' }
                ]
            }
        };
        
        function openStatusPicker(type, targetId, callback) {
            document.activeElement?.blur();
            
            const config = STATUS_OPTIONS[type];
            if (!config) {
                console.error('Unknown status type:', type);
                return;
            }
            
            statusPickerTargetId = targetId;
            statusPickerCallback = callback;
            
            document.getElementById('statusPickerTitle').textContent = config.title;
            
            const currentValue = document.getElementById(targetId)?.value || '';
            
            let html = '';
            config.options.forEach(opt => {
                const isSelected = opt.value === currentValue;
                html += `
                    <div class="item-picker-card" 
                        ontouchstart="pickerTouchStart(event)" 
                        ontouchmove="pickerTouchMove(event)" 
                        ontouchend="if(pickerTouchEnd()) selectStatus('${opt.value}')" 
                        onclick="selectStatus('${opt.value}')"
                        style="border-left: 4px solid ${opt.color}; background: ${isSelected ? opt.bg : 'white'}; ${isSelected ? 'border: 2px solid ' + opt.color + ';' : ''}">
                        <div style="display: flex; align-items: center; gap: 12px; pointer-events: none;">
                            <span style="font-size: 24px;">${opt.icon}</span>
                            <div>
                                <div style="font-weight: 600; color: ${opt.color};">${opt.label}</div>
                            </div>
                            ${isSelected ? '<span style="margin-left: auto; color: ' + opt.color + '; font-size: 20px;"></span>' : ''}
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('statusPickerList').innerHTML = html;
            // Use class-based display to avoid CSS specificity issues
            const modal = document.getElementById('statusPickerModal');
            modal.classList.add('status-picker-open');
            document.body.style.overflow = 'hidden';
        }
        
        function selectStatus(value) {
            if (statusPickerTargetId) {
                const el = document.getElementById(statusPickerTargetId);
                if (el) {
                    el.value = value;
                    // Trigger change event
                    el.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }
            if (statusPickerCallback && typeof statusPickerCallback === 'function') {
                statusPickerCallback(value);
            }
            closeStatusPicker();
        }
        
        function closeStatusPicker() {
            const modal = document.getElementById('statusPickerModal');
            modal.classList.remove('status-picker-open');
            document.body.style.overflow = '';
            statusPickerCallback = null;
            statusPickerTargetId = null;
        }
        
        // Open Stock Status Picker
        function openStockStatusPicker() {
            openStatusPicker('stock', 'rptFilter_stockStatus', function(value) {
                const display = document.getElementById('rptFilter_stockStatus_display');
                if (display) {
                    display.value = getStatusDisplayText('stock', value);
                }
            });
        }
        
        // Open Adjustment Type Picker
        function openAdjustmentTypePicker() {
            openStatusPicker('adjustmentType', 'rptFilter_adjustmentType', function(value) {
                const display = document.getElementById('rptFilter_adjustmentType_display');
                if (display) {
                    display.value = getStatusDisplayText('adjustmentType', value);
                }
            });
        }
        
        // Helper to get display text for a status value
        function getStatusDisplayText(type, value) {
            const config = STATUS_OPTIONS[type];
            if (!config) return value || 'Select...';
            const opt = config.options.find(o => o.value === value);
            return opt ? `${opt.icon} ${opt.label.split(' - ')[0]}` : (value || 'Select...');
        }
        
        // Update display field after selection
        function updateStatusDisplay(targetId) {
            const hidden = document.getElementById(targetId);
            const display = document.getElementById(targetId + '_display');
            if (hidden && display) {
                // Find the type from known mappings
                const typeMap = {
                    'filterPurchaseStatus': 'filterPurchaseStatus',
                    'filterPurchasePaymentStatus': 'paymentStatus',
                    'filterSaleStatus': 'filterSaleStatus',
                    'editPOStatus': 'poStatus',
                    'poStatus': 'poStatus',
                    'poPaymentTerms': 'paymentTerms',
                    'editSOStatus': 'soStatus',
                    'editSOPaymentMethod': 'paymentMethod',
                    'rptFilter_paymentStatus': 'paymentStatus',
                    'rptFilter_transactionStatus': 'transactionStatus',
                    'rptFilter_deliveryStatus': 'deliveryStatus',
                    'rptFilter_stockStatus': 'stock',
                    'rptFilter_adjustmentType': 'adjustmentType'
                };
                const type = typeMap[targetId] || 'poStatus';
                display.value = getStatusDisplayText(type, hidden.value);
            }
        }
        
        // Override selectStatus to also update display
        const originalSelectStatus = selectStatus;
        selectStatus = function(value) {
            if (statusPickerTargetId) {
                const el = document.getElementById(statusPickerTargetId);
                if (el) {
                    el.value = value;
                    updateStatusDisplay(statusPickerTargetId);
                    el.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }
            if (statusPickerCallback && typeof statusPickerCallback === 'function') {
                statusPickerCallback(value);
            }
            closeStatusPicker();
        };
        
        // Supplier picker for Purchase Orders filter
        function openSupplierPickerForPurchases() {
            // Blur to prevent mobile keyboard
            document.activeElement?.blur();
            
            window.reportPickerType = 'supplier';
            window.supplierPickerIsFilter = true;
            supplierPickerCallback = {
                tagName: 'PURCHASE_FILTER',
                value: document.getElementById('filterPurchaseSupplier').value
            };
            
            // Initialize selected suppliers from current value
            const currentValue = document.getElementById('filterPurchaseSupplier').value;
            if (currentValue) {
                selectedSuppliersForReport = currentValue.split(',').filter(v => v);
            } else {
                selectedSuppliersForReport = [];
            }
            
            document.getElementById('supplierPickerSearch').value = '';
            renderSupplierPickerList();
            document.getElementById('supplierPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            
            // Only focus on desktop
            if (!('ontouchstart' in window)) {
                setTimeout(() => {
                    document.getElementById('supplierPickerSearch').focus();
                }, 100);
            }
        }
        
        // Supplier picker for Inventory filter
        function openSupplierPickerForInventory() {
            document.activeElement?.blur();
            
            window.reportPickerType = 'supplier';
            window.supplierPickerIsFilter = true;
            supplierPickerCallback = {
                tagName: 'INVENTORY_FILTER',
                value: document.getElementById('filterInventorySupplier').value
            };
            
            // Initialize selected suppliers from current value
            const currentValue = document.getElementById('filterInventorySupplier').value;
            if (currentValue) {
                selectedSuppliersForReport = currentValue.split(',').filter(v => v);
            } else {
                selectedSuppliersForReport = [];
            }
            
            document.getElementById('supplierPickerSearch').value = '';
            renderSupplierPickerList();
            document.getElementById('supplierPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('supplierPickerSearch');
        }
        
        // Supplier picker for Pricing Workbench filter
        function openSupplierPickerForPricing() {
            document.activeElement?.blur();
            window.reportPickerType = 'supplier';
            window.supplierPickerIsFilter = true;
            supplierPickerCallback = {
                tagName: 'PRICING_FILTER',
                value: document.getElementById('pricesimSupplier').value
            };
            
            // Initialize selected suppliers from current value
            const currentValue = document.getElementById('pricesimSupplier').value;
            if (currentValue) {
                selectedSuppliersForPricing = currentValue.split(',').filter(v => v);
            } else {
                selectedSuppliersForPricing = [];
            }
            
            document.getElementById('supplierPickerSearch').value = '';
            renderSupplierPickerListForPricing();
            document.getElementById('supplierPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('supplierPickerSearch');
        }
        
        function openSupplierPicker(selectElement) {
            document.activeElement?.blur();
            supplierPickerCallback = selectElement;
            document.getElementById('supplierPickerSearch').value = '';
            renderSupplierPickerList();
            document.getElementById('supplierPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            focusOnDesktop('supplierPickerSearch');
        }
        
        function closeSupplierPicker() {
            document.getElementById('supplierPickerModal').classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
            supplierPickerCallback = null;
        }
        
        function filterSupplierPicker() {
            renderSupplierPickerList();
        }
        
        function renderSupplierPickerList() {
            const search = document.getElementById('supplierPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('supplierPickerList');
            
            let suppliers = cachedSuppliers || [];
            
            let filtered = suppliers.filter(s => {
                return !search || 
                    (s.Supplier_Name && s.Supplier_Name.toLowerCase().includes(search)) ||
                    (s.Supplier_ID && s.Supplier_ID.toLowerCase().includes(search)) ||
                    (s.Contact_Name && s.Contact_Name.toLowerCase().includes(search));
            });
            
            // Check if this is a report, purchase, inventory, or pricing filter (multi-select enabled)
            const isReportFilter = supplierPickerCallback && (
                supplierPickerCallback.tagName === 'REPORT_FILTER' || 
                supplierPickerCallback.tagName === 'PURCHASE_FILTER' || 
                supplierPickerCallback.tagName === 'INVENTORY_FILTER' ||
                supplierPickerCallback.tagName === 'PRICING_FILTER'
            );
            
            let html = '';
            
            // Add multi-select controls for report filters
            if (isReportFilter && !search) {
                html += `
                    <div class="item-picker-card" style="border-left: 4px solid #8a8a8a; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="item-picker-desc" style="font-weight: bold; color: #1976d2;">
                                    <span style="font-size: 18px; margin-right: 8px;"></span> All Suppliers
                                </div>
                                <div style="font-size: 12px; color: #555;">Select specific suppliers below, or leave all unchecked for all suppliers</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllSuppliers()" class="oval-action-btn oval-action-primary" style="font-size: 11px; padding: 4px 10px;"> Select All</button>
                                <button onclick="clearAllSuppliers()" class="oval-action-btn oval-action-warning" style="font-size: 11px; padding: 4px 10px;"> Clear All</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && !isReportFilter) {
                listContainer.innerHTML = `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No suppliers found</div>
                    </div>
                `;
                return;
            }
            
            filtered.forEach(s => {
                const isSelected = selectedSuppliersForReport.includes(s.Supplier_ID);
                const touchHandlers = `ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)"`;
                const clickHandler = isReportFilter 
                    ? `${touchHandlers} ontouchend="if(pickerTouchEnd()) toggleSupplierSelection('${s.Supplier_ID}')" onclick="toggleSupplierSelection('${s.Supplier_ID}')"` 
                    : `${touchHandlers} ontouchend="if(pickerTouchEnd()) selectSupplierFromPicker('${s.Supplier_ID}')" onclick="selectSupplierFromPicker('${s.Supplier_ID}')"`;
                const checkboxHtml = isReportFilter 
                    ? `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSupplierSelection('${s.Supplier_ID}')" style="width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation()">` 
                    : '';
                
                html += `
                    <div class="item-picker-card supplier-card" ${clickHandler} style="border-left: 4px solid ${isSelected ? '#10b981' : '#c0c0c0'}; ${isSelected ? 'background: #d1fae5;' : 'background: white;'} display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        ${checkboxHtml}
                        <div style="flex: 1;">
                            <div class="item-picker-card-header">
                                <span class="item-picker-sku">${s.Supplier_ID}</span>
                            </div>
                            <div class="item-picker-desc" style="margin-bottom: 8px;">${s.Supplier_Name || 'Unnamed Supplier'}</div>
                            <div class="item-picker-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
                                ${s.Contact_Name ? `<div class="item-picker-detail"><span class="item-picker-detail-label"> Contact</span><span class="item-picker-detail-value">${s.Contact_Name}</span></div>` : ''}
                                ${s.Phone ? `<div class="item-picker-detail"><span class="item-picker-detail-label"> Phone</span><span class="item-picker-detail-value">${s.Phone}</span></div>` : ''}
                                ${s.Mobile ? `<div class="item-picker-detail"><span class="item-picker-detail-label"> Mobile</span><span class="item-picker-detail-value">${s.Mobile}</span></div>` : ''}
                                ${s.Email ? `<div class="item-picker-detail"><span class="item-picker-detail-label"> Email</span><span class="item-picker-detail-value" style="font-size: 13px;">${s.Email}</span></div>` : ''}
                            </div>
                            ${s.Address || s.City || s.State || s.ZIP ? `
                                <div style="margin-top: 10px;">
                                    <div style="font-weight: 600; color: #555; margin-bottom: 4px; font-size: 12px;"> ADDRESS</div>
                                    ${s.Address ? `<div style="font-size: 13px; color: #333;">${s.Address}</div>` : ''}
                                    ${s.City || s.State || s.ZIP ? `
                                        <div style="font-size: 13px; color: #555;">
                                            ${s.City || ''}${s.City && (s.State || s.ZIP) ? ', ' : ''}${s.State || ''} ${s.ZIP || ''}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        // Pricing Workbench supplier picker render function
        function renderSupplierPickerListForPricing() {
            const search = document.getElementById('supplierPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('supplierPickerList');
            
            let suppliers = cachedSuppliers || [];
            
            let filtered = suppliers.filter(s => {
                return !search || 
                    (s.Supplier_Name && s.Supplier_Name.toLowerCase().includes(search)) ||
                    (s.Supplier_ID && s.Supplier_ID.toLowerCase().includes(search)) ||
                    (s.Contact_Name && s.Contact_Name.toLowerCase().includes(search));
            });
            
            let html = '';
            
            // Add multi-select controls
            if (!search) {
                html += `
                    <div class="item-picker-card" style="border-left: 4px solid #8a8a8a; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="item-picker-desc" style="font-weight: bold; color: #1976d2;">
                                    <span style="font-size: 18px; margin-right: 8px;"></span> All Suppliers
                                </div>
                                <div style="font-size: 12px; color: #555;">Select specific suppliers below, or leave all unchecked for all suppliers</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllSuppliersForPricing()" class="oval-action-btn oval-action-primary" style="font-size: 11px; padding: 4px 10px;"> Select All</button>
                                <button onclick="clearAllSuppliersForPricing()" class="oval-action-btn oval-action-warning" style="font-size: 11px; padding: 4px 10px;"> Clear All</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && search) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No suppliers found</div>
                    </div>
                `;
                return;
            }
            
            // Sort alphabetically
            filtered.sort((a, b) => (a.Supplier_Name || '').localeCompare(b.Supplier_Name || ''));
            
            filtered.forEach(s => {
                const isSelected = selectedSuppliersForPricing.includes(s.Supplier_ID);
                const touchHandlers = `ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)"`;
                const clickHandler = `${touchHandlers} ontouchend="if(pickerTouchEnd()) toggleSupplierSelectionForPricing('${s.Supplier_ID}')" onclick="toggleSupplierSelectionForPricing('${s.Supplier_ID}')"`;
                const checkboxHtml = `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSupplierSelectionForPricing('${s.Supplier_ID}')" style="width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation()">`;
                
                html += `
                    <div class="item-picker-card" ${clickHandler} style="border-left: 4px solid ${isSelected ? '#10b981' : '#667eea'}; ${isSelected ? 'background: #d1fae5;' : 'background: white;'} display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        ${checkboxHtml}
                        <div style="flex: 1;">
                            <div class="item-picker-card-header">
                                <span class="item-picker-sku">${s.Supplier_ID || 'No ID'}</span>
                            </div>
                            <div class="item-picker-desc">${s.Supplier_Name || 'No name'}</div>
                            <div class="item-picker-details" style="margin-top: 8px;">
                                ${s.Contact_Name ? `<div style="font-size: 13px; color: #666;"> ${s.Contact_Name}</div>` : ''}
                                ${s.Phone ? `<div style="font-size: 13px; color: #666;"> ${s.Phone}</div>` : ''}
                                ${s.Email ? `<div style="font-size: 13px; color: #666;"> ${s.Email}</div>` : ''}
                                ${(s.Address || s.City || s.State || s.Zip) ? `
                                    <div style="margin-top: 6px; font-size: 12px; color: #777;">
                                        <div style="font-weight: 600; margin-bottom: 2px;"> ADDRESS</div>
                                        ${s.Address ? `<div>${s.Address}</div>` : ''}
                                        ${(s.City || s.State || s.Zip) ? `<div>${[s.City, s.State, s.Zip].filter(Boolean).join(', ')}</div>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        // Pricing-specific supplier selection functions
        function toggleSupplierSelectionForPricing(supplierId) {
            const index = selectedSuppliersForPricing.indexOf(supplierId);
            if (index > -1) {
                selectedSuppliersForPricing.splice(index, 1);
            } else {
                selectedSuppliersForPricing.push(supplierId);
            }
            renderSupplierPickerListForPricing();
            updateSupplierSelectionDisplayForPricing();
        }
        
        function selectAllSuppliersForPricing() {
            const search = document.getElementById('supplierPickerSearch').value.toLowerCase().trim();
            let suppliers = cachedSuppliers || [];
            let filtered = suppliers.filter(s => {
                return !search || 
                    (s.Supplier_Name && s.Supplier_Name.toLowerCase().includes(search)) ||
                    (s.Supplier_ID && s.Supplier_ID.toLowerCase().includes(search)) ||
                    (s.Contact_Name && s.Contact_Name.toLowerCase().includes(search));
            });
            selectedSuppliersForPricing = filtered.map(s => s.Supplier_ID);
            renderSupplierPickerListForPricing();
            updateSupplierSelectionDisplayForPricing();
        }
        
        function clearAllSuppliersForPricing() {
            selectedSuppliersForPricing = [];
            renderSupplierPickerListForPricing();
            updateSupplierSelectionDisplayForPricing();
        }
        
        function updateSupplierSelectionDisplayForPricing() {
            const displayInput = document.getElementById('pricesimSupplier_display');
            const hiddenInput = document.getElementById('pricesimSupplier');
            const countDiv = document.getElementById('supplierSelectionCount');
            
            if (selectedSuppliersForPricing.length === 0) {
                if (displayInput) displayInput.value = '';
                if (hiddenInput) hiddenInput.value = '';
                if (countDiv) countDiv.textContent = 'No suppliers selected (all will be shown)';
            } else if (selectedSuppliersForPricing.length === 1) {
                const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === selectedSuppliersForPricing[0]);
                if (displayInput) displayInput.value = supplier ? supplier.Supplier_Name : selectedSuppliersForPricing[0];
                if (hiddenInput) hiddenInput.value = selectedSuppliersForPricing[0];
                if (countDiv) countDiv.textContent = '1 supplier selected';
            } else if (selectedSuppliersForPricing.length <= 3) {
                // For 2-3 suppliers, show their names
                const names = selectedSuppliersForPricing.map(id => {
                    const s = (cachedSuppliers || []).find(sup => sup.Supplier_ID === id);
                    return s ? s.Supplier_Name : id;
                }).join(', ');
                if (displayInput) displayInput.value = names;
                if (hiddenInput) hiddenInput.value = selectedSuppliersForPricing.join(',');
                if (countDiv) countDiv.textContent = `${selectedSuppliersForPricing.length} suppliers selected`;
            } else {
                if (displayInput) displayInput.value = `${selectedSuppliersForPricing.length} suppliers selected`;
                if (hiddenInput) hiddenInput.value = selectedSuppliersForPricing.join(',');
                if (countDiv) countDiv.textContent = `${selectedSuppliersForPricing.length} suppliers selected`;
            }
            
            // Trigger filter update
            filterPriceSimItems();
        }
        
        // Toggle supplier selection for multi-select
        function toggleSupplierSelection(supplierId) {
            const index = selectedSuppliersForReport.indexOf(supplierId);
            if (index > -1) {
                selectedSuppliersForReport.splice(index, 1);
            } else {
                selectedSuppliersForReport.push(supplierId);
            }
            renderSupplierPickerList();
            updateSupplierSelectionDisplay();
        }
        
        // Select all suppliers
        function selectAllSuppliers() {
            const search = document.getElementById('supplierPickerSearch').value.toLowerCase().trim();
            let suppliers = cachedSuppliers || [];
            let filtered = suppliers.filter(s => {
                return !search || 
                    (s.Supplier_Name && s.Supplier_Name.toLowerCase().includes(search)) ||
                    (s.Supplier_ID && s.Supplier_ID.toLowerCase().includes(search));
            });
            selectedSuppliersForReport = filtered.map(s => s.Supplier_ID);
            renderSupplierPickerList();
            updateSupplierSelectionDisplay();
        }
        
        // Clear all supplier selections
        function clearAllSuppliers() {
            selectedSuppliersForReport = [];
            renderSupplierPickerList();
            updateSupplierSelectionDisplay();
        }
        
        // Update the display field with selection count
        function updateSupplierSelectionDisplay() {
            // Determine which fields to update based on callback
            let displayInput, hiddenInput;
            
            if (supplierPickerCallback && supplierPickerCallback.tagName === 'PURCHASE_FILTER') {
                displayInput = document.getElementById('filterPurchaseSupplier_display');
                hiddenInput = document.getElementById('filterPurchaseSupplier');
            } else if (supplierPickerCallback && supplierPickerCallback.tagName === 'INVENTORY_FILTER') {
                displayInput = document.getElementById('filterInventorySupplier_display');
                hiddenInput = document.getElementById('filterInventorySupplier');
            } else if (supplierPickerCallback && supplierPickerCallback.tagName === 'PRICING_FILTER') {
                displayInput = document.getElementById('pricesimSupplier_display');
                hiddenInput = document.getElementById('pricesimSupplier');
            } else {
                displayInput = document.getElementById('rptFilter_supplier_display');
                hiddenInput = document.getElementById('rptFilter_supplier');
            }
            
            const countDiv = document.getElementById('supplierSelectionCount');
            
            if (selectedSuppliersForReport.length === 0) {
                if (displayInput) displayInput.value = '';
                if (hiddenInput) hiddenInput.value = '';
                if (countDiv) countDiv.textContent = 'No suppliers selected (all will be shown)';
            } else if (selectedSuppliersForReport.length === 1) {
                const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === selectedSuppliersForReport[0]);
                if (displayInput) displayInput.value = supplier ? supplier.Supplier_Name : selectedSuppliersForReport[0];
                if (hiddenInput) hiddenInput.value = selectedSuppliersForReport[0];
                if (countDiv) countDiv.textContent = '1 supplier selected';
            } else if (selectedSuppliersForReport.length <= 3) {
                // For 2-3 suppliers, show their names
                const names = selectedSuppliersForReport.map(id => {
                    const s = (cachedSuppliers || []).find(sup => sup.Supplier_ID === id);
                    return s ? s.Supplier_Name : id;
                }).join(', ');
                if (displayInput) displayInput.value = names;
                if (hiddenInput) hiddenInput.value = selectedSuppliersForReport.join(',');
                if (countDiv) countDiv.textContent = `${selectedSuppliersForReport.length} suppliers selected`;
            } else {
                if (displayInput) displayInput.value = `${selectedSuppliersForReport.length} suppliers selected`;
                if (hiddenInput) hiddenInput.value = selectedSuppliersForReport.join(',');
                if (countDiv) countDiv.textContent = `${selectedSuppliersForReport.length} suppliers selected`;
            }
            
            // Trigger filter update for purchase orders, inventory, or pricing
            if (supplierPickerCallback && supplierPickerCallback.tagName === 'PURCHASE_FILTER') {
                filterPurchases();
            } else if (supplierPickerCallback && supplierPickerCallback.tagName === 'INVENTORY_FILTER') {
                filterInventory();
            } else if (supplierPickerCallback && supplierPickerCallback.tagName === 'PRICING_FILTER') {
                filterPriceSimItems();
            }
        }
        
        function selectSupplierFromPicker(supplierId) {
            if (supplierPickerCallback) {
                // Check if this is the new report setup filter
                if (supplierPickerCallback.tagName === 'REPORT_SETUP_FILTER') {
                    const displayInput = document.getElementById('filter_supplier_display');
                    const hiddenInput = document.getElementById('filter_supplier');
                    if (supplierId === '') {
                        if (displayInput) displayInput.value = '';
                        if (hiddenInput) hiddenInput.value = '';
                    } else {
                        const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === supplierId);
                        if (displayInput) displayInput.value = supplier ? supplier.Supplier_Name : supplierId;
                        if (hiddenInput) hiddenInput.value = supplierId;
                    }
                    window.supplierPickerIsFilter = false;
                    closeSupplierPicker();
                    return;
                }
                
                // Check if this is a report filter
                if (supplierPickerCallback.tagName === 'REPORT_FILTER') {
                    const displayInput = document.getElementById('rptFilter_supplier_display');
                    const hiddenInput = document.getElementById('rptFilter_supplier');
                    if (supplierId === '') {
                        displayInput.value = '';
                        hiddenInput.value = '';
                    } else {
                        const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === supplierId);
                        displayInput.value = supplier ? supplier.Supplier_Name : supplierId;
                        hiddenInput.value = supplierId;
                    }
                    window.supplierPickerIsFilter = false;
                    closeSupplierPicker();
                    return;
                }
                
                // Check if this is a filter text input or a select element
                const isTextInput = supplierPickerCallback.tagName === 'INPUT' && supplierPickerCallback.type === 'text';
                
                if (isTextInput && supplierPickerIsFilter) {
                    // For filter inputs, set the supplier name as value
                    if (supplierId === '') {
                        supplierPickerCallback.value = '';
                    } else {
                        const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === supplierId);
                        supplierPickerCallback.value = supplier ? supplier.Supplier_Name : supplierId;
                    }
                    // Trigger the filter function
                    if (typeof filterSuppliers === 'function') filterSuppliers();
                } else {
                    // For select elements, set the ID
                    supplierPickerCallback.value = supplierId;
                    supplierPickerCallback.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // Explicitly call update functions for specific selects
                    const id = supplierPickerCallback.id;
                    if (id === 'createPOSupplier') {
                        if (typeof filterItemsBySupplier === 'function') filterItemsBySupplier();
                    } else if (id === 'poSupplier') {
                        if (typeof loadSupplierItems === 'function') loadSupplierItems();
                    } else if (id === 'filterItemSupplier') {
                        if (typeof filterItems === 'function') filterItems();
                    } else if (id === 'filterPurchaseSupplier') {
                        if (typeof filterPurchases === 'function') filterPurchases();
                    } else if (id === 'filterInventorySupplier') {
                        if (typeof filterInventory === 'function') filterInventory();
                    } else if (id === 'pricesimSupplier') {
                        if (typeof filterPriceSimItems === 'function') filterPriceSimItems();
                    }
                }
            }
            supplierPickerIsFilter = false;
            closeSupplierPicker();
        }
        
        function attachSupplierPickerToSelects() {
            // Attach to ALL supplier selects on ALL devices (forms + filters + reports)
            const supplierSelects = [
                // Form selects
                '#poSupplier', '#editPOSupplier', '#createPOSupplier', 
                '#newItemSupplier', '#editItemSupplier', '#newSimSupplier',
                // Filter selects
                '#filterItemSupplier', '#filterPurchaseSupplier', 
                '#filterInventorySupplier', '#pricesimSupplier',
                // Report filters
                '#filter_supplier',
                // Class-based
                '.supplier-select'
            ].join(', ');
            
            document.querySelectorAll(supplierSelects).forEach(select => {
                if (!select.dataset.supplierPickerAttached) {
                    select.dataset.supplierPickerAttached = 'true';
                    select.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openSupplierPicker(this);
                    });
                    select.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openSupplierPicker(this);
                    });
                }
            });
        }
        
        // ==================== CUSTOMER PICKER ====================
        
        let customerPickerCallback = null;
        
        function openCustomerPicker(selectElement) {
            document.activeElement?.blur();
            customerPickerCallback = selectElement;
            document.getElementById('customerPickerSearch').value = '';
            renderCustomerPickerList();
            document.getElementById('customerPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            focusOnDesktop('customerPickerSearch');
        }
        
        // Customer picker for Sales Orders filter
        function openCustomerPickerForSales() {
            // Blur to prevent mobile keyboard
            document.activeElement?.blur();
            
            window.reportPickerType = 'customer';
            window.customerPickerIsFilter = true;
            customerPickerCallback = {
                tagName: 'SALES_FILTER',
                value: document.getElementById('filterSaleCustomer').value
            };
            
            // Initialize selected customers from current value
            const currentValue = document.getElementById('filterSaleCustomer').value;
            if (currentValue) {
                selectedCustomersForReport = currentValue.split(',').filter(v => v);
            } else {
                selectedCustomersForReport = [];
            }
            
            document.getElementById('customerPickerSearch').value = '';
            renderCustomerPickerList();
            document.getElementById('customerPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            
            // Only focus on desktop
            if (!('ontouchstart' in window)) {
                setTimeout(() => {
                    document.getElementById('customerPickerSearch').focus();
                }, 100);
            }
        }
        
        function closeCustomerPicker() {
            document.getElementById('customerPickerModal').classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
            customerPickerCallback = null;
        }
        
        // ==================== REASON PICKER ====================
        const adjustmentReasons = [
            { value: 'Physical Count', icon: '', desc: 'Adjust to match physical inventory count' },
            { value: 'Damaged Goods', icon: '', desc: 'Items damaged and cannot be sold' },
            { value: 'Expired Products', icon: '', desc: 'Products past expiration date' },
            { value: 'Shrinkage/Theft', icon: '', desc: 'Missing inventory, possible theft' },
            { value: 'Found Inventory', icon: '', desc: 'Located misplaced items' },
            { value: 'Data Correction', icon: '', desc: 'Fix data entry error' },
            { value: 'Returned Goods', icon: '', desc: 'Customer returned products' },
            { value: 'Sample/Promo', icon: '', desc: 'Given as sample or promotion' },
            { value: 'Transfer Out', icon: '', desc: 'Moved to another location' },
            { value: 'Transfer In', icon: '', desc: 'Received from another location' },
            { value: 'Other', icon: '', desc: 'Other reason (add notes)' }
        ];
        
        function openReasonPicker() {
            const listContainer = document.getElementById('reasonPickerList');
            
            let html = '';
            adjustmentReasons.forEach(reason => {
                html += `
                    <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectReason('${reason.value}')" onclick="selectReason('${reason.value}')" 
                         style="border-left: 4px solid #c0c0c0; margin-bottom: 10px; padding: 15px; cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.background='#f0f4ff'; this.style.borderLeftColor='var(--primary, #667eea)'"
                         onmouseout="this.style.background='white'; this.style.borderLeftColor='#c0c0c0'">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">${reason.icon}</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">${reason.value}</div>
                                <div style="font-size: 12px; color: #666;">${reason.desc}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
            
            document.getElementById('reasonPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
        }
        
        function selectReason(reason) {
            document.getElementById('adjustReason').value = reason;
            document.getElementById('adjustReasonDisplay').value = reason;
            // Visual feedback - change border to green when reason selected
            document.getElementById('adjustReasonDisplay').style.borderColor = '#10b981';
            document.getElementById('adjustReasonDisplay').style.background = '#ecfdf5';
            closeReasonPicker();
        }
        
        function closeReasonPicker() {
            document.getElementById('reasonPickerModal').classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
        }
        
        // ==================== UOM PICKER ====================
        let uomPickerTargetId = null;
        
        const purchaseUOMs = [
            { value: 'Case', icon: '', desc: 'Standard case/carton of products' },
            { value: 'Box', icon: '', desc: 'Smaller box packaging' },
            { value: 'Pack', icon: '', desc: 'Multi-pack bundle' },
            { value: 'Each', icon: '1', desc: 'Individual unit' },
            { value: 'Pallet', icon: '', desc: 'Full pallet load' },
            { value: 'Bag', icon: '', desc: 'Bag packaging' },
            { value: 'Tray', icon: '', desc: 'Tray packaging' },
            { value: 'Dozen', icon: '', desc: '12 units' }
        ];
        
        function openUOMPicker(targetId) {
            uomPickerTargetId = targetId;
            const listContainer = document.getElementById('uomPickerList');
            
            let html = '';
            purchaseUOMs.forEach(uom => {
                html += `
                    <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectUOM('${uom.value}')" onclick="selectUOM('${uom.value}')" 
                         style="border-left: 4px solid #c0c0c0; margin-bottom: 10px; padding: 15px; cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.background='#f0f4ff'; this.style.borderLeftColor='var(--primary, #667eea)'"
                         onmouseout="this.style.background='white'; this.style.borderLeftColor='#c0c0c0'">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">${uom.icon}</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">${uom.value}</div>
                                <div style="font-size: 12px; color: #666;">${uom.desc}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
            
            document.getElementById('uomPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
        }
        
        function selectUOM(uom) {
            if (uomPickerTargetId) {
                document.getElementById(uomPickerTargetId).value = uom;
                document.getElementById(uomPickerTargetId + 'Display').value = uom;
            }
            closeUOMPicker();
        }
        
        function closeUOMPicker() {
            document.getElementById('uomPickerModal').classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
            uomPickerTargetId = null;
        }
        
        // ==================== THEME PICKER ====================
        const themeCategories = [
            {
                name: ' Classic Themes',
                themes: [
                    { value: 'purple', name: ' Royal Purple', primary: '#667eea', secondary: '#764ba2' },
                    { value: 'ocean', name: ' Ocean Blue', primary: '#0077b6', secondary: '#00b4d8' },
                    { value: 'forest', name: ' Forest Green', primary: '#2d6a4f', secondary: '#40916c' },
                    { value: 'sunset', name: ' Sunset Orange', primary: '#f77f00', secondary: '#fcbf49' },
                    { value: 'crimson', name: ' Crimson Red', primary: '#9d0208', secondary: '#dc2f02' },
                    { value: 'slate', name: ' Slate Gray', primary: '#475569', secondary: '#64748b' },
                    { value: 'teal', name: ' Teal', primary: '#6b9a8d', secondary: '#14b8a6' },
                    { value: 'dark', name: ' Professional Dark', primary: '#1e293b', secondary: '#334155' }
                ]
            },
            {
                name: ' NFL - AFC',
                themes: [
                    { value: 'bills', name: ' Buffalo Bills', primary: '#00338D', secondary: '#C60C30' },
                    { value: 'dolphins', name: ' Miami Dolphins', primary: '#008E97', secondary: '#FC4C02' },
                    { value: 'patriots', name: ' New England Patriots', primary: '#002244', secondary: '#C60C30' },
                    { value: 'jets', name: ' New York Jets', primary: '#125740', secondary: '#000000' },
                    { value: 'ravens', name: ' Baltimore Ravens', primary: '#241773', secondary: '#9E7C0C' },
                    { value: 'bengals', name: ' Cincinnati Bengals', primary: '#FB4F14', secondary: '#000000' },
                    { value: 'browns', name: ' Cleveland Browns', primary: '#311D00', secondary: '#FF3C00' },
                    { value: 'steelers', name: ' Pittsburgh Steelers', primary: '#FFB612', secondary: '#101820' },
                    { value: 'texans', name: ' Houston Texans', primary: '#03202F', secondary: '#A71930' },
                    { value: 'colts', name: ' Indianapolis Colts', primary: '#002C5F', secondary: '#A2AAAD' },
                    { value: 'jaguars', name: ' Jacksonville Jaguars', primary: '#006778', secondary: '#D7A22A' },
                    { value: 'titans', name: ' Tennessee Titans', primary: '#0C2340', secondary: '#4B92DB' },
                    { value: 'broncos', name: ' Denver Broncos', primary: '#FB4F14', secondary: '#002244' },
                    { value: 'chiefs', name: ' Kansas City Chiefs', primary: '#E31837', secondary: '#FFB81C' },
                    { value: 'raiders', name: ' Las Vegas Raiders', primary: '#000000', secondary: '#A5ACAF' },
                    { value: 'chargers', name: ' Los Angeles Chargers', primary: '#0080C6', secondary: '#FFC20E' }
                ]
            },
            {
                name: ' NFL - NFC',
                themes: [
                    { value: 'cowboys', name: ' Dallas Cowboys', primary: '#003594', secondary: '#869397' },
                    { value: 'giants', name: ' New York Giants', primary: '#0B2265', secondary: '#A71930' },
                    { value: 'eagles', name: ' Philadelphia Eagles', primary: '#004C54', secondary: '#A5ACAF' },
                    { value: 'commanders', name: ' Washington Commanders', primary: '#5A1414', secondary: '#FFB612' },
                    { value: 'bears', name: ' Chicago Bears', primary: '#0B162A', secondary: '#C83803' },
                    { value: 'lions', name: ' Detroit Lions', primary: '#0076B6', secondary: '#B0B7BC' },
                    { value: 'packers', name: ' Green Bay Packers', primary: '#203731', secondary: '#FFB612' },
                    { value: 'vikings', name: ' Minnesota Vikings', primary: '#4F2683', secondary: '#FFC62F' },
                    { value: 'falcons', name: ' Atlanta Falcons', primary: '#A71930', secondary: '#000000' },
                    { value: 'panthers', name: ' Carolina Panthers', primary: '#0085CA', secondary: '#101820' },
                    { value: 'saints', name: ' New Orleans Saints', primary: '#D3BC8D', secondary: '#101820' },
                    { value: 'bucs', name: ' Tampa Bay Buccaneers', primary: '#D50A0A', secondary: '#FF7900' },
                    { value: 'azcardinals', name: ' Arizona Cardinals', primary: '#97233F', secondary: '#000000' },
                    { value: 'rams', name: ' Los Angeles Rams', primary: '#003594', secondary: '#FFA300' },
                    { value: 'niners', name: ' San Francisco 49ers', primary: '#AA0000', secondary: '#B3995D' },
                    { value: 'seahawks', name: ' Seattle Seahawks', primary: '#002244', secondary: '#69BE28' }
                ]
            },
            {
                name: ' NFL Throwbacks',
                themes: [
                    { value: 'bucscreamsicle', name: ' Bucs Creamsicle', primary: '#FF8200', secondary: '#B71234' },
                    { value: 'steelersbee', name: ' Steelers Bumblebee', primary: '#FFB612', secondary: '#000000' },
                    { value: 'oilersthrow', name: ' Oilers Columbia Blue', primary: '#8CBED6', secondary: '#C41E3A' },
                    { value: 'patpatriot', name: ' Patriots Pat Patriot', primary: '#C8102E', secondary: '#002244' },
                    { value: 'chargerspowder', name: ' Chargers Powder Blue', primary: '#0080C6', secondary: '#FFC20E' },
                    { value: 'orangecrush', name: ' Broncos Orange Crush', primary: '#FB4F14', secondary: '#002244' },
                    { value: 'kellygreen', name: ' Eagles Kelly Green', primary: '#004C54', secondary: '#A5ACAF' },
                    { value: 'niners94', name: ' 49ers 94 Gold', primary: '#AA0000', secondary: '#B3995D' },
                    { value: 'rams99', name: ' Rams 99 Blue', primary: '#003594', secondary: '#FFA300' },
                    { value: 'seahawkslime', name: ' Seahawks Original', primary: '#002244', secondary: '#69BE28' },
                    { value: 'falcons66', name: ' Falcons 66', primary: '#A71930', secondary: '#000000' },
                    { value: 'jets98', name: ' Jets 98 Green', primary: '#125740', secondary: '#000000' },
                    { value: 'bears36', name: ' Bears 36 Orange', primary: '#0B162A', secondary: '#C83803' },
                    { value: 'acme', name: ' Packers Acme', primary: '#203731', secondary: '#FFB612' },
                    { value: 'cards47', name: ' Cardinals 47', primary: '#97233F', secondary: '#000000' }
                ]
            },
            {
                name: ' NFL Alternates',
                themes: [
                    { value: 'billsred', name: ' Bills Red Helmet', primary: '#C60C30', secondary: '#00338D' },
                    { value: 'chiefsred', name: ' Chiefs Red on Red', primary: '#E31837', secondary: '#FFB81C' },
                    { value: 'raidersblack', name: ' Raiders Color Rush', primary: '#000000', secondary: '#A5ACAF' },
                    { value: 'whitetiger', name: ' Bengals White Tiger', primary: '#FB4F14', secondary: '#000000' },
                    { value: 'brownsrush', name: ' Browns Color Rush', primary: '#311D00', secondary: '#FF3C00' },
                    { value: 'eaglesblack', name: ' Eagles Black Alt', primary: '#004C54', secondary: '#000000' },
                    { value: 'titansoilers', name: ' Titans Oilers 23', primary: '#8CBED6', secondary: '#C41E3A' },
                    { value: 'actiongreen', name: ' Seahawks Action Green', primary: '#69BE28', secondary: '#002244' },
                    { value: 'jagsteal', name: ' Jaguars Teal', primary: '#006778', secondary: '#D7A22A' },
                    { value: 'purplepeople', name: ' Vikings Purple Eaters', primary: '#4F2683', secondary: '#FFC62F' }
                ]
            },
            {
                name: ' MLB - American League',
                themes: [
                    { value: 'orioles', name: ' Baltimore Orioles', primary: '#DF4601', secondary: '#000000' },
                    { value: 'redsox', name: ' Boston Red Sox', primary: '#BD3039', secondary: '#0C2340' },
                    { value: 'yankees', name: ' New York Yankees', primary: '#003087', secondary: '#E4002C' },
                    { value: 'rays', name: ' Tampa Bay Rays', primary: '#092C5C', secondary: '#8FBCE6' },
                    { value: 'bluejays', name: ' Toronto Blue Jays', primary: '#134A8E', secondary: '#E8291C' },
                    { value: 'whitesox', name: ' Chicago White Sox', primary: '#27251F', secondary: '#C4CED4' },
                    { value: 'guardians', name: ' Cleveland Guardians', primary: '#00385D', secondary: '#E50022' },
                    { value: 'tigers', name: ' Detroit Tigers', primary: '#0C2340', secondary: '#FA4616' },
                    { value: 'royals', name: ' Kansas City Royals', primary: '#004687', secondary: '#BD9B60' },
                    { value: 'twins', name: ' Minnesota Twins', primary: '#002B5C', secondary: '#D31145' },
                    { value: 'astros', name: ' Houston Astros', primary: '#002D62', secondary: '#EB6E1F' },
                    { value: 'angels', name: ' Los Angeles Angels', primary: '#BA0021', secondary: '#003263' },
                    { value: 'athletics', name: ' Oakland Athletics', primary: '#003831', secondary: '#EFB21E' },
                    { value: 'mariners', name: ' Seattle Mariners', primary: '#0C2C56', secondary: '#005C5C' },
                    { value: 'rangers', name: ' Texas Rangers', primary: '#003278', secondary: '#C0111F' }
                ]
            },
            {
                name: ' MLB - National League',
                themes: [
                    { value: 'braves', name: ' Atlanta Braves', primary: '#CE1141', secondary: '#13274F' },
                    { value: 'marlins', name: ' Miami Marlins', primary: '#00A3E0', secondary: '#EF3340' },
                    { value: 'mets', name: ' New York Mets', primary: '#002D72', secondary: '#FF5910' },
                    { value: 'phillies', name: ' Philadelphia Phillies', primary: '#E81828', secondary: '#002D72' },
                    { value: 'nationals', name: ' Washington Nationals', primary: '#AB0003', secondary: '#14225A' },
                    { value: 'cubs', name: ' Chicago Cubs', primary: '#0E3386', secondary: '#CC3433' },
                    { value: 'reds', name: ' Cincinnati Reds', primary: '#C6011F', secondary: '#000000' },
                    { value: 'brewers', name: ' Milwaukee Brewers', primary: '#12284B', secondary: '#B6922E' },
                    { value: 'pirates', name: ' Pittsburgh Pirates', primary: '#27251F', secondary: '#FDB827' },
                    { value: 'stlcardinals', name: ' St. Louis Cardinals', primary: '#C41E3A', secondary: '#0C2340' },
                    { value: 'dbacks', name: ' Arizona Diamondbacks', primary: '#A71930', secondary: '#E3D4AD' },
                    { value: 'rockies', name: ' Colorado Rockies', primary: '#33006F', secondary: '#C4CED4' },
                    { value: 'dodgers', name: ' Los Angeles Dodgers', primary: '#005A9C', secondary: '#EF3E42' },
                    { value: 'padres', name: ' San Diego Padres', primary: '#2F241D', secondary: '#FFC425' },
                    { value: 'sfgiants', name: ' San Francisco Giants', primary: '#FD5A1E', secondary: '#27251F' }
                ]
            },
            {
                name: ' NBA Teams',
                themes: [
                    { value: 'bulls', name: ' Chicago Bulls', primary: '#CE1141', secondary: '#000000' },
                    { value: 'celtics', name: ' Boston Celtics', primary: '#007A33', secondary: '#BA9653' },
                    { value: 'nets', name: ' Brooklyn Nets', primary: '#000000', secondary: '#FFFFFF' },
                    { value: 'knicks', name: ' New York Knicks', primary: '#006BB6', secondary: '#F58426' },
                    { value: 'sixers', name: ' Philadelphia 76ers', primary: '#006BB6', secondary: '#ED174C' },
                    { value: 'raptors', name: ' Toronto Raptors', primary: '#CE1141', secondary: '#000000' },
                    { value: 'cavs', name: ' Cleveland Cavaliers', primary: '#860038', secondary: '#041E42' },
                    { value: 'pistons', name: ' Detroit Pistons', primary: '#C8102E', secondary: '#1D42BA' },
                    { value: 'pacers', name: ' Indiana Pacers', primary: '#002D62', secondary: '#FDBB30' },
                    { value: 'bucks', name: ' Milwaukee Bucks', primary: '#00471B', secondary: '#EEE1C6' },
                    { value: 'hawks', name: ' Atlanta Hawks', primary: '#E03A3E', secondary: '#C1D32F' },
                    { value: 'hornets', name: ' Charlotte Hornets', primary: '#1D1160', secondary: '#00788C' },
                    { value: 'heat', name: ' Miami Heat', primary: '#98002E', secondary: '#F9A01B' },
                    { value: 'magic', name: ' Orlando Magic', primary: '#0077C0', secondary: '#C4CED4' },
                    { value: 'wizards', name: ' Washington Wizards', primary: '#002B5C', secondary: '#E31837' },
                    { value: 'nuggets', name: ' Denver Nuggets', primary: '#0E2240', secondary: '#FEC524' },
                    { value: 'twolves', name: ' Minnesota Timberwolves', primary: '#0C2340', secondary: '#236192' },
                    { value: 'thunder', name: ' Oklahoma City Thunder', primary: '#007AC1', secondary: '#EF3B24' },
                    { value: 'blazers', name: ' Portland Trail Blazers', primary: '#E03A3E', secondary: '#000000' },
                    { value: 'jazz', name: ' Utah Jazz', primary: '#002B5C', secondary: '#00471B' },
                    { value: 'warriors', name: ' Golden State Warriors', primary: '#1D428A', secondary: '#FFC72C' },
                    { value: 'clippers', name: ' LA Clippers', primary: '#C8102E', secondary: '#1D428A' },
                    { value: 'lakers', name: ' Los Angeles Lakers', primary: '#552583', secondary: '#FDB927' },
                    { value: 'suns', name: ' Phoenix Suns', primary: '#1D1160', secondary: '#E56020' },
                    { value: 'nbakings', name: ' Sacramento Kings', primary: '#5A2D81', secondary: '#63727A' },
                    { value: 'mavs', name: ' Dallas Mavericks', primary: '#00538C', secondary: '#002B5E' },
                    { value: 'rockets', name: ' Houston Rockets', primary: '#CE1141', secondary: '#000000' },
                    { value: 'grizzlies', name: ' Memphis Grizzlies', primary: '#5D76A9', secondary: '#12173F' },
                    { value: 'pelicans', name: ' New Orleans Pelicans', primary: '#0C2340', secondary: '#C8102E' },
                    { value: 'spurs', name: ' San Antonio Spurs', primary: '#C4CED4', secondary: '#000000' }
                ]
            },
            {
                name: ' NHL Teams',
                themes: [
                    { value: 'blackhawks', name: ' Chicago Blackhawks', primary: '#CF0A2C', secondary: '#000000' },
                    { value: 'bruins', name: ' Boston Bruins', primary: '#FFB81C', secondary: '#000000' },
                    { value: 'sabres', name: ' Buffalo Sabres', primary: '#002654', secondary: '#FCB514' },
                    { value: 'redwings', name: ' Detroit Red Wings', primary: '#CE1126', secondary: '#FFFFFF' },
                    { value: 'flapanthers', name: ' Florida Panthers', primary: '#041E42', secondary: '#C8102E' },
                    { value: 'canadiens', name: ' Montreal Canadiens', primary: '#AF1E2D', secondary: '#192168' },
                    { value: 'senators', name: ' Ottawa Senators', primary: '#C52032', secondary: '#C2912C' },
                    { value: 'lightning', name: ' Tampa Bay Lightning', primary: '#002868', secondary: '#FFFFFF' },
                    { value: 'mapleleafs', name: ' Toronto Maple Leafs', primary: '#00205B', secondary: '#FFFFFF' },
                    { value: 'hurricanes', name: ' Carolina Hurricanes', primary: '#CC0000', secondary: '#000000' },
                    { value: 'bluejackets', name: ' Columbus Blue Jackets', primary: '#002654', secondary: '#CE1126' },
                    { value: 'devils', name: ' New Jersey Devils', primary: '#CE1126', secondary: '#000000' },
                    { value: 'islanders', name: ' New York Islanders', primary: '#00539B', secondary: '#F47D30' },
                    { value: 'nhlrangers', name: ' New York Rangers', primary: '#0038A8', secondary: '#CE1126' },
                    { value: 'flyers', name: ' Philadelphia Flyers', primary: '#F74902', secondary: '#000000' },
                    { value: 'penguins', name: ' Pittsburgh Penguins', primary: '#000000', secondary: '#FCB514' },
                    { value: 'capitals', name: ' Washington Capitals', primary: '#041E42', secondary: '#C8102E' },
                    { value: 'coyotes', name: ' Arizona Coyotes', primary: '#8C2633', secondary: '#E2D6B5' },
                    { value: 'avalanche', name: ' Colorado Avalanche', primary: '#6F263D', secondary: '#236192' },
                    { value: 'stars', name: ' Dallas Stars', primary: '#006847', secondary: '#8F8F8C' },
                    { value: 'wild', name: ' Minnesota Wild', primary: '#154734', secondary: '#A6192E' },
                    { value: 'predators', name: ' Nashville Predators', primary: '#FFB81C', secondary: '#041E42' },
                    { value: 'stlblues', name: ' St. Louis Blues', primary: '#002F87', secondary: '#FCB514' },
                    { value: 'nhljets', name: ' Winnipeg Jets', primary: '#041E42', secondary: '#004C97' },
                    { value: 'ducks', name: ' Anaheim Ducks', primary: '#F47A38', secondary: '#B9975B' },
                    { value: 'flames', name: ' Calgary Flames', primary: '#C8102E', secondary: '#F1BE48' },
                    { value: 'oilers', name: ' Edmonton Oilers', primary: '#041E42', secondary: '#FF4C00' },
                    { value: 'kings', name: ' Los Angeles Kings', primary: '#111111', secondary: '#A2AAAD' },
                    { value: 'sharks', name: ' San Jose Sharks', primary: '#006D75', secondary: '#EA7200' },
                    { value: 'kraken', name: ' Seattle Kraken', primary: '#001628', secondary: '#99D9D9' },
                    { value: 'canucks', name: ' Vancouver Canucks', primary: '#00205B', secondary: '#00843D' },
                    { value: 'goldenknights', name: ' Vegas Golden Knights', primary: '#B4975A', secondary: '#333F42' }
                ]
            },
            {
                name: ' College Football',
                themes: [
                    { value: 'alabama', name: ' Alabama Crimson Tide', primary: '#9E1B32', secondary: '#828A8F' },
                    { value: 'arkansas', name: ' Arkansas Razorbacks', primary: '#9D2235', secondary: '#000000' },
                    { value: 'auburn', name: ' Auburn Tigers', primary: '#0C2340', secondary: '#E87722' },
                    { value: 'florida', name: ' Florida Gators', primary: '#0021A5', secondary: '#FA4616' },
                    { value: 'georgia', name: ' Georgia Bulldogs', primary: '#BA0C2F', secondary: '#000000' },
                    { value: 'lsu', name: ' LSU Tigers', primary: '#461D7C', secondary: '#FDD023' },
                    { value: 'tennessee', name: ' Tennessee Volunteers', primary: '#FF8200', secondary: '#58595B' },
                    { value: 'texasam', name: ' Texas A&M Aggies', primary: '#500000', secondary: '#FFFFFF' },
                    { value: 'michigan', name: ' Michigan Wolverines', primary: '#00274C', secondary: '#FFCB05' },
                    { value: 'michiganst', name: ' Michigan State Spartans', primary: '#18453B', secondary: '#FFFFFF' },
                    { value: 'ohiostate', name: ' Ohio State Buckeyes', primary: '#BB0000', secondary: '#666666' },
                    { value: 'pennstate', name: ' Penn State Nittany Lions', primary: '#041E42', secondary: '#FFFFFF' },
                    { value: 'wisconsin', name: ' Wisconsin Badgers', primary: '#C5050C', secondary: '#FFFFFF' },
                    { value: 'nebraska', name: ' Nebraska Cornhuskers', primary: '#E41C38', secondary: '#F5F1E7' },
                    { value: 'clemson', name: ' Clemson Tigers', primary: '#F56600', secondary: '#522D80' },
                    { value: 'fsu', name: ' Florida State Seminoles', primary: '#782F40', secondary: '#CEB888' },
                    { value: 'miami', name: ' Miami Hurricanes', primary: '#F47321', secondary: '#005030' },
                    { value: 'oklahoma', name: ' Oklahoma Sooners', primary: '#841617', secondary: '#FDF9D8' },
                    { value: 'okstate', name: ' Oklahoma State Cowboys', primary: '#FF7300', secondary: '#000000' },
                    { value: 'texas', name: ' Texas Longhorns', primary: '#BF5700', secondary: '#333F48' },
                    { value: 'oregon', name: ' Oregon Ducks', primary: '#154733', secondary: '#FEE123' },
                    { value: 'oregonst', name: ' Oregon State Beavers', primary: '#DC4405', secondary: '#000000' },
                    { value: 'usc', name: ' USC Trojans', primary: '#990000', secondary: '#FFC72C' },
                    { value: 'ucla', name: ' UCLA Bruins', primary: '#2D68C4', secondary: '#F2A900' },
                    { value: 'byu', name: ' BYU Cougars', primary: '#002E5D', secondary: '#FFFFFF' },
                    { value: 'notredame', name: ' Notre Dame Fighting Irish', primary: '#0C2340', secondary: '#C99700' }
                ]
            },
            {
                name: ' Fast Food',
                themes: [
                    { value: 'mcdonalds', name: " McDonald's", primary: '#FFC72C', secondary: '#DA291C' },
                    { value: 'burgerking', name: ' Burger King', primary: '#FF8732', secondary: '#502314' },
                    { value: 'wendys', name: " Wendy's", primary: '#E2203D', secondary: '#199FDA' },
                    { value: 'tacobell', name: ' Taco Bell', primary: '#702082', secondary: '#FF5BA3' },
                    { value: 'kfc', name: ' KFC', primary: '#F40027', secondary: '#FFFFFF' },
                    { value: 'subway', name: ' Subway', primary: '#008C15', secondary: '#FFC600' },
                    { value: 'pizzahut', name: ' Pizza Hut', primary: '#EE3124', secondary: '#00A160' },
                    { value: 'chickfila', name: ' Chick-fil-A', primary: '#E51636', secondary: '#004F71' },
                    { value: 'dunkin', name: " Dunkin'", primary: '#FF671F', secondary: '#DA1884' },
                    { value: 'dominos', name: " Domino's", primary: '#006491', secondary: '#E31837' },
                    { value: 'sonic', name: ' Sonic', primary: '#0066A1', secondary: '#EF3E42' },
                    { value: 'arbys', name: " Arby's", primary: '#D22630', secondary: '#64502F' },
                    { value: 'dairyqueen', name: ' Dairy Queen', primary: '#ED1C24', secondary: '#0066B2' },
                    { value: 'jackinthebox', name: ' Jack in the Box', primary: '#E31837', secondary: '#FFD100' },
                    { value: 'popeyes', name: ' Popeyes', primary: '#F15A22', secondary: '#008578' },
                    { value: 'chipotle', name: ' Chipotle', primary: '#441500', secondary: '#A81612' },
                    { value: 'fiveguys', name: ' Five Guys', primary: '#D32323', secondary: '#FFFFFF' },
                    { value: 'innout', name: ' In-N-Out', primary: '#E4002B', secondary: '#FFD700' },
                    { value: 'culvers', name: " Culver's", primary: '#0033A0', secondary: '#FFC72C' },
                    { value: 'timhortons', name: ' Tim Hortons', primary: '#DD0031', secondary: '#683B29' }
                ]
            },
            {
                name: ' Wisconsin & Midwest',
                themes: [
                    { value: 'kwiktrip', name: ' Kwik Trip', primary: '#D21034', secondary: '#231F20' },
                    { value: 'rutters', name: " Rutter's", primary: '#D40029', secondary: '#000000' },
                    { value: 'cenex', name: ' Cenex', primary: '#004B87', secondary: '#ED1C24' },
                    { value: 'cenexcoop', name: ' Cenex Co-op', primary: '#004B87', secondary: '#ED1C24' },
                    { value: 'fleetfarm', name: ' Fleet Farm', primary: '#00703C', secondary: '#231F20' },
                    { value: 'woodmans', name: " Woodman's Markets", primary: '#2E3092', secondary: '#ED1C24' },
                    { value: 'picknsave', name: " Pick 'n Save", primary: '#004990', secondary: '#E4002B' },
                    { value: 'sentry', name: ' Sentry Foods', primary: '#004990', secondary: '#E4002B' },
                    { value: 'festival', name: ' Festival Foods', primary: '#00A651', secondary: '#ED1C24' },
                    { value: 'pigglywiggly', name: ' Piggly Wiggly', primary: '#E31837', secondary: '#231F20' },
                    { value: 'holiday', name: ' Holiday Stationstores', primary: '#00703C', secondary: '#ED1C24' },
                    { value: 'bp', name: ' BP Wisconsin', primary: '#009639', secondary: '#F7E600' },
                    { value: 'caseys', name: " Casey's", primary: '#E21A22', secondary: '#000000' },
                    { value: 'shell', name: ' Shell', primary: '#FFD500', secondary: '#DD1D21' },
                    { value: 'mobil', name: ' Mobil / Exxon', primary: '#0033A0', secondary: '#ED1C24' }
                ]
            },
            {
                name: ' Retro Gaming',
                themes: [
                    { value: 'nes', name: ' NES Classic', primary: '#E60012', secondary: '#484848' },
                    { value: 'snes', name: ' SNES Classic', primary: '#5F249F', secondary: '#009DC4' },
                    { value: 'genesis', name: ' Sega Genesis', primary: '#0060A8', secondary: '#C8102E' },
                    { value: 'gameboy', name: ' Game Boy Color', primary: '#306230', secondary: '#8BAC0F' },
                    { value: 'n64', name: ' N64 Funtastic', primary: '#009E60', secondary: '#A020F0' },
                    { value: 'ps1', name: ' PlayStation 1', primary: '#003087', secondary: '#00A4E8' },
                    { value: 'windows95', name: ' Windows 95', primary: '#008080', secondary: '#000080' },
                    { value: 'windowsxp', name: ' Windows XP Bliss', primary: '#3A6EA5', secondary: '#6EA04B' },
                    { value: 'macos9', name: ' Mac OS 9', primary: '#666666', secondary: '#999999' },
                    { value: 'amiga', name: ' Amiga Workbench', primary: '#FF8800', secondary: '#0055AA' },
                    { value: 'c64', name: ' Commodore 64', primary: '#A5A5FF', secondary: '#0000AA' }
                ]
            },
            {
                name: ' Cars & Sneakers',
                themes: [
                    { value: 'camaro', name: " '69 Camaro Z28", primary: '#FF6600', secondary: '#1C1C1C' },
                    { value: 'challenger', name: " '70 Challenger", primary: '#7B1FA2', secondary: '#1A1A1A' },
                    { value: 'bullitt', name: " '68 Mustang Bullitt", primary: '#355E3B', secondary: '#1A1A1A' },
                    { value: 'supra', name: " '94 Toyota Supra", primary: '#FF4500', secondary: '#1A1A1A' },
                    { value: 'skyline', name: " '99 Nissan Skyline", primary: '#0033CC', secondary: '#C0C0C0' },
                    { value: 'typer', name: " '97 Civic Type R", primary: '#CC0000', secondary: '#FFFFFF' },
                    { value: 'jordan1', name: ' Jordan 1 Chicago', primary: '#CE1126', secondary: '#000000' },
                    { value: 'yeezy', name: ' Yeezy 350', primary: '#B8B8B8', secondary: '#3D3D3D' },
                    { value: 'pigeon', name: ' Nike SB Dunk Pigeon', primary: '#808080', secondary: '#FF6B00' },
                    { value: 'wotherspoon', name: ' Air Max 97 Wotherspoon', primary: '#87CEEB', secondary: '#FFD700' }
                ]
            },
            {
                name: ' Superheroes',
                themes: [
                    { value: 'spiderman', name: ' Spider-Man Classic', primary: '#E62429', secondary: '#003DA5' },
                    { value: 'symbiote', name: ' Spider-Man Symbiote', primary: '#1A1A1A', secondary: '#FFFFFF' },
                    { value: 'batman', name: ' Batman Arkham', primary: '#1A1A1A', secondary: '#2B3A4A' },
                    { value: 'superman', name: ' Superman', primary: '#0099F7', secondary: '#ED1D24' },
                    { value: 'wonderwoman', name: ' Wonder Woman', primary: '#C9A227', secondary: '#B22234' },
                    { value: 'ironman', name: ' Iron Man', primary: '#B71C1C', secondary: '#FFD700' },
                    { value: 'captainamerica', name: ' Captain America', primary: '#002868', secondary: '#BF0A30' },
                    { value: 'hulk', name: ' Hulk', primary: '#4CAF50', secondary: '#1B5E20' },
                    { value: 'thor', name: ' Thor', primary: '#0D47A1', secondary: '#FFD700' },
                    { value: 'harleyquinn', name: ' Harley Quinn', primary: '#E91E63', secondary: '#00BCD4' },
                    { value: 'starlord', name: ' Star-Lord', primary: '#8B0000', secondary: '#FFD700' },
                    { value: 'groot', name: ' Groot', primary: '#8B4513', secondary: '#228B22' },
                    { value: 'marvelrivals', name: ' Marvel Rivals', primary: '#E62429', secondary: '#003DA5' },
                    { value: 'flash', name: ' The Flash', primary: '#E62429', secondary: '#FFD700' },
                    { value: 'greenlantern', name: ' Green Lantern', primary: '#00A651', secondary: '#1A1A1A' },
                    { value: 'reaper', name: ' Overwatch Reaper', primary: '#1A1A1A', secondary: '#8B0000' }
                ]
            },
            {
                name: ' Cyberpunk 2077',
                themes: [
                    { value: 'nightcity', name: ' Night City Neon', primary: '#FF003C', secondary: '#00F0FF' },
                    { value: 'arasaka', name: ' Arasaka Corpo', primary: '#E21B1B', secondary: '#1A1A1A' },
                    { value: 'militech', name: ' Militech Military', primary: '#3D5C5C', secondary: '#8B8B00' },
                    { value: 'moxes', name: ' Moxes Gang', primary: '#9B2D9B', secondary: '#00BFFF' },
                    { value: 'valentinos', name: ' Valentinos Gang', primary: '#DC143C', secondary: '#FFD700' },
                    { value: 'vjacket', name: " V's Jacket", primary: '#FFD700', secondary: '#000000' },
                    { value: 'silverhand', name: ' Johnny Silverhand', primary: '#FF6B35', secondary: '#1A1A1A' },
                    { value: 'cyberpunkui', name: ' Cyberpunk UI', primary: '#00F0FF', secondary: '#FF003C' },
                    { value: 'phantomliberty', name: ' Phantom Liberty', primary: '#B8860B', secondary: '#191970' },
                    { value: 'cyberpunklogo', name: ' Cyberpunk Logo', primary: '#FCE94F', secondary: '#00D4FF' }
                ]
            },
            {
                name: ' Lo-Fi / Vaporwave',
                themes: [
                    { value: 'lofi', name: ' Lo-Fi ChilledCow', primary: '#E67E22', secondary: '#5B3A29' },
                    { value: 'chillhop', name: ' Chillhop Raccoon', primary: '#4A90A4', secondary: '#E8D5B7' },
                    { value: 'vaporwave', name: ' Vaporwave Classic', primary: '#FF71CE', secondary: '#01CDFE' },
                    { value: 'mallsoft', name: ' Mallsoft Sunset', primary: '#FF6B9D', secondary: '#C9EEFF' },
                    { value: 'miamivice', name: ' Miami Vice', primary: '#FF6B9D', secondary: '#00D4FF' },
                    { value: 'outrun', name: ' Outrun Grid', primary: '#FF2975', secondary: '#00BFFF' }
                ]
            },
            {
                name: ' Airlines',
                themes: [
                    { value: 'panam', name: ' Pan Am Classic', primary: '#0033A0', secondary: '#FFFFFF' },
                    { value: 'braniff', name: ' Braniff International', primary: '#FF6600', secondary: '#00A86B' },
                    { value: 'southwest', name: ' Southwest Heart', primary: '#304CB2', secondary: '#FFBF27' },
                    { value: 'pokemon', name: ' ANA Pokmon Jet', primary: '#FFCB05', secondary: '#3D7DCA' }
                ]
            },
            {
                name: ' National Parks',
                themes: [
                    { value: 'yellowstone', name: ' Yellowstone', primary: '#8B4513', secondary: '#228B22' },
                    { value: 'grandcanyon', name: ' Grand Canyon', primary: '#CD5C5C', secondary: '#DAA520' },
                    { value: 'yosemite', name: ' Yosemite', primary: '#2E8B57', secondary: '#4682B4' }
                ]
            },
            {
                name: ' Retro Search Engines',
                themes: [
                    { value: 'yahoo1996', name: ' Yahoo! 1996', primary: '#6001A8', secondary: '#FF9900' },
                    { value: 'yahoo2000s', name: ' Yahoo! 2000s', primary: '#7B0099', secondary: '#FF0000' },
                    { value: 'aol1995', name: ' AOL 1995', primary: '#00C8FF', secondary: '#FFCC00' },
                    { value: 'aol2000s', name: ' AOL 2000s Teal', primary: '#00A0D8', secondary: '#FFFFFF' },
                    { value: 'excite1997', name: ' Excite 1997', primary: '#E4002B', secondary: '#000000' },
                    { value: 'lycos', name: ' Lycos', primary: '#FF0000', secondary: '#000000' },
                    { value: 'altavista', name: ' AltaVista 1998', primary: '#0066CC', secondary: '#FF9900' },
                    { value: 'askjeeves', name: ' Ask Jeeves', primary: '#00A99D', secondary: '#FF6600' },
                    { value: 'webcrawler', name: ' WebCrawler', primary: '#009900', secondary: '#FFFF00' },
                    { value: 'infoseek', name: ' Infoseek 1997', primary: '#660099', secondary: '#FFCC00' },
                    { value: 'msn1998', name: ' MSN 1998 Butterfly', primary: '#00ADEF', secondary: '#FFB900' },
                    { value: 'netscape', name: ' Netscape Navigator', primary: '#0033CC', secondary: '#FFCC00' },
                    { value: 'dogpile', name: ' Dogpile', primary: '#FF6600', secondary: '#6600CC' },
                    { value: 'geocities', name: ' GeoCities Classic', primary: '#FF0099', secondary: '#00FF00' }
                ]
            },
            {
                name: ' MAME Arcade Classics',
                themes: [
                    { value: 'mamepacman', name: ' Pac-Man', primary: '#FFFF00', secondary: '#FF0000' },
                    { value: 'mamemspacman', name: ' Ms. Pac-Man', primary: '#FF21AE', secondary: '#00FFFF' },
                    { value: 'mamedonkeykong', name: ' Donkey Kong', primary: '#E80709', secondary: '#EE7511' },
                    { value: 'mamespaceinvaders', name: ' Space Invaders', primary: '#62DE6D', secondary: '#F83B3A' },
                    { value: 'mamegalaga', name: ' Galaga', primary: '#00FF00', secondary: '#EC4705' },
                    { value: 'mamefrogger', name: ' Frogger', primary: '#66A400', secondary: '#EB1C2D' },
                    { value: 'mamestreetfighter', name: ' Street Fighter II', primary: '#FFFFFF', secondary: '#E70000' },
                    { value: 'mamemortalkombat', name: ' Mortal Kombat', primary: '#EED911', secondary: '#F53929' },
                    { value: 'mamedefender', name: ' Defender', primary: '#00A651', secondary: '#FF4500' },
                    { value: 'mamecentipede', name: ' Centipede', primary: '#228B22', secondary: '#8B4513' },
                    { value: 'mamedigdug', name: ' Dig Dug', primary: '#4169E1', secondary: '#FF0000' },
                    { value: 'mameqbert', name: ' Q*bert', primary: '#9370DB', secondary: '#FF8C00' },
                    { value: 'mametempest', name: ' Tempest', primary: '#8A2BE2', secondary: '#00BFFF' },
                    { value: 'mameasteroids', name: ' Asteroids', primary: '#FFFFFF', secondary: '#00FFFF' },
                    { value: 'mamebubble', name: ' Bubble Bobble', primary: '#FFB6C1', secondary: '#87CEEB' },
                    { value: 'mamegauntlet', name: ' Gauntlet', primary: '#40FF40', secondary: '#FF4040' },
                    { value: 'mamerampage', name: ' Rampage', primary: '#00A000', secondary: '#FF69B4' },
                    { value: 'mamerobotron', name: ' Robotron', primary: '#00FFFF', secondary: '#FF00FF' },
                    { value: 'mamejoust', name: ' Joust', primary: '#FFD700', secondary: '#FF0000' },
                    { value: 'mametron', name: ' Tron', primary: '#00FFFF', secondary: '#FF0000' },
                    { value: 'mamenbajam', name: ' NBA Jam', primary: '#C8102E', secondary: '#002244' },
                    { value: 'mamecontra', name: ' Contra', primary: '#0000FF', secondary: '#FF0000' },
                    { value: 'mamemetalslug', name: ' Metal Slug', primary: '#FFD700', secondary: '#4169E1' },
                    { value: 'mametmnt', name: ' TMNT Arcade', primary: '#008000', secondary: '#FF0000' },
                    { value: 'mamedoubledragon', name: ' Double Dragon', primary: '#0000FF', secondary: '#FF0000' },
                    { value: 'mamefinalfight', name: ' Final Fight', primary: '#FFFF00', secondary: '#FF0000' },
                    { value: 'mamegradius', name: ' Gradius', primary: '#00FFFF', secondary: '#FF4500' },
                    { value: 'mamegoldenaxe', name: ' Golden Axe', primary: '#8B0000', secondary: '#FF4500' },
                    { value: 'mamestrider', name: ' Strider', primary: '#00FF00', secondary: '#FF00FF' },
                    { value: 'mamertype', name: ' R-Type', primary: '#4169E1', secondary: '#FF0000' }
                ]
            },
            {
                name: ' Monster Energy',
                themes: [
                    { value: 'monstergreen', name: ' Monster Original', primary: '#8DC63F', secondary: '#000000' },
                    { value: 'monsterblack', name: ' Ultra Black', primary: '#000000', secondary: '#C0C0C0' },
                    { value: 'monstersunrise', name: ' Ultra Sunrise', primary: '#FF6B00', secondary: '#FFD700' },
                    { value: 'monsterparadise', name: ' Ultra Paradise', primary: '#00FF7F', secondary: '#FFFFFF' },
                    { value: 'monsterviolet', name: ' Ultra Violet', primary: '#9932CC', secondary: '#E0B0FF' },
                    { value: 'monsterpipeline', name: ' Pipeline Punch', primary: '#FF69B4', secondary: '#FFD700' },
                    { value: 'monsterrehab', name: ' Rehab Tea+Lemonade', primary: '#FFD700', secondary: '#8B4513' },
                    { value: 'monsterred', name: ' Ultra Red', primary: '#C8102E', secondary: '#FFFFFF' }
                ]
            },
            {
                name: ' Mountain Dew',
                themes: [
                    { value: 'mtndewgreen', name: ' Original Dew', primary: '#99CC00', secondary: '#006633' },
                    { value: 'mtndewcodered', name: ' Code Red', primary: '#C8102E', secondary: '#000000' },
                    { value: 'mtndewvoltage', name: ' Voltage', primary: '#00B7EB', secondary: '#000000' },
                    { value: 'mtndewbaja', name: ' Baja Blast', primary: '#66CCCC', secondary: '#FFFFFF' },
                    { value: 'mtndewlivewire', name: ' Live Wire', primary: '#FF6B00', secondary: '#000000' },
                    { value: 'mtndewwhiteout', name: ' White Out', primary: '#FFFFFF', secondary: '#00BFFF' }
                ]
            },
            {
                name: ' Root Beer & Soda',
                themes: [
                    { value: 'awrootbeer', name: ' A&W Root Beer', primary: '#8B4513', secondary: '#FFD700' },
                    { value: 'barqs', name: ' Barqs Red Crme', primary: '#C8102E', secondary: '#FFFFFF' },
                    { value: 'mugcream', name: ' Mug Cream Soda', primary: '#FFF8DC', secondary: '#8B4513' },
                    { value: 'ibccherry', name: ' IBC Black Cherry', primary: '#4B0082', secondary: '#C71585' },
                    { value: 'cocacola', name: ' Coca-Cola', primary: '#C8102E', secondary: '#FFFFFF' },
                    { value: 'drpepper', name: ' Dr Pepper', primary: '#8B0000', secondary: '#DAA520' },
                    { value: 'pepsi', name: ' Pepsi', primary: '#004B8D', secondary: '#E4002B' },
                    { value: 'sprite', name: ' Sprite', primary: '#00A550', secondary: '#FFFFFF' },
                    { value: 'fanta', name: ' Fanta Orange', primary: '#FF6600', secondary: '#003DA5' }
                ]
            },
            {
                name: ' Energy Drinks',
                themes: [
                    { value: 'redbull', name: ' Red Bull', primary: '#0050A4', secondary: '#C0C0C0' },
                    { value: 'rockstar', name: ' Rockstar', primary: '#800080', secondary: '#FFD700' },
                    { value: 'nos', name: ' NOS Nitrous', primary: '#000000', secondary: '#FF0000' },
                    { value: 'bang', name: ' Bang Neon', primary: '#FF6B00', secondary: '#FFD700' },
                    { value: 'c4energy', name: ' C4 Electric Blue', primary: '#00BFFF', secondary: '#FFFFFF' },
                    { value: 'alaninu', name: ' Alani Nu Pink', primary: '#FF69B4', secondary: '#E0B0FF' },
                    { value: 'ghostenergy', name: ' Ghost Neon', primary: '#39FF14', secondary: '#000000' },
                    { value: 'celsius', name: ' Celsius Orange', primary: '#FF4500', secondary: '#FFD700' },
                    { value: 'prime', name: ' Prime Tropical', primary: '#00AEEF', secondary: '#FF6B00' },
                    { value: 'reign', name: ' Reign Matte Black', primary: '#000000', secondary: '#C0C0C0' },
                    { value: 'gamerfuel', name: ' Gamer Neon Grid', primary: '#00FFFF', secondary: '#FF00FF' }
                ]
            }
        ];

        function openThemePicker() {
            document.activeElement?.blur();
            renderThemePickerList();
            document.getElementById('themePickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            focusOnDesktop('themePickerSearch');
        }
        
        function closeThemePicker() {
            document.getElementById('themePickerModal').classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
        }
        
        function filterThemePicker() {
            renderThemePickerList();
        }
        
        function renderThemePickerList() {
            const search = document.getElementById('themePickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('themePickerList');
            const currentTheme = document.getElementById('themeSelector').value;
            
            let html = '';
            
            themeCategories.forEach(category => {
                // Filter themes in this category
                const filteredThemes = category.themes.filter(t => {
                    return !search || 
                        t.name.toLowerCase().includes(search) || 
                        t.value.toLowerCase().includes(search) ||
                        category.name.toLowerCase().includes(search);
                });
                
                if (filteredThemes.length === 0) return;
                
                // Category header
                html += `<div style="font-weight: 600; font-size: 16px; color: #333; margin: 15px 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #e0e0e0;">${category.name}</div>`;
                
                // Theme grid
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">';
                
                filteredThemes.forEach(theme => {
                    const isSelected = theme.value === currentTheme;
                    html += `
                        <div ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectTheme('${theme.value}', '${theme.name.replace(/'/g, "\\'")}')" onclick="selectTheme('${theme.value}', '${theme.name.replace(/'/g, "\\'")}')" 
                             style="cursor: pointer; padding: 12px; border: 2px solid ${isSelected ? theme.primary : '#e0e0e0'}; border-radius: 12px; background: ${isSelected ? '#f8f9fa' : 'white'}; transition: all 0.2s; display: flex; align-items: center; gap: 10px;"
                             onmouseover="this.style.borderColor='${theme.primary}'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                             onmouseout="this.style.borderColor='${isSelected ? theme.primary : '#e0e0e0'}'; this.style.transform='none'; this.style.boxShadow='none'">
                            <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary} 100%); box-shadow: 0 2px 6px rgba(0,0,0,0.2); flex-shrink: 0;"></div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 500; font-size: 13px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${theme.name}</div>
                                ${isSelected ? '<div style="font-size: 11px; color: #4CAF50; font-weight: 600;"> Active</div>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            if (!html) {
                html = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 15px;"></div>
                        <div>No themes found for "${search}"</div>
                    </div>
                `;
            }
            
            listContainer.innerHTML = html;
        }
        
        function selectTheme(themeValue, themeName) {
            document.getElementById('themeSelector').value = themeValue;
            document.getElementById('themePreviewName').textContent = themeName;
            
            // Call the existing changeTheme function
            changeTheme();
            
            // Update the preview swatch with new colors
            setTimeout(() => {
                const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
                const secondary = getComputedStyle(document.documentElement).getPropertyValue('--secondary').trim();
                document.getElementById('themePreviewSwatch').style.background = `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`;
            }, 50);
            
            closeThemePicker();
        }
        
        // Update theme preview on page load
        function updateThemePreview() {
            const savedTheme = localStorage.getItem('theme') || 'purple';
            document.getElementById('themeSelector').value = savedTheme;
            
            // Find the theme name
            let themeName = ' Royal Purple';
            themeCategories.forEach(cat => {
                const found = cat.themes.find(t => t.value === savedTheme);
                if (found) themeName = found.name;
            });
            
            document.getElementById('themePreviewName').textContent = themeName;
            
            // Update swatch
            setTimeout(() => {
                const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
                const secondary = getComputedStyle(document.documentElement).getPropertyValue('--secondary').trim();
                if (primary && secondary) {
                    document.getElementById('themePreviewSwatch').style.background = `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`;
                }
            }, 100);
        }
        
        function filterCustomerPicker() {
            renderCustomerPickerList();
        }
        
        function renderCustomerPickerList() {
            const search = document.getElementById('customerPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('customerPickerList');
            
            let customers = cachedCustomers || [];
            
            let filtered = customers.filter(c => {
                return !search || 
                    (c.Customer_Name && c.Customer_Name.toLowerCase().includes(search)) ||
                    (c.Customer_ID && c.Customer_ID.toLowerCase().includes(search)) ||
                    (c.Contact_Name && c.Contact_Name.toLowerCase().includes(search)) ||
                    (c.Route && c.Route.toLowerCase().includes(search));
            });
            
            // Check if this is a report or sales filter (multi-select enabled)
            const isReportFilter = customerPickerCallback && (customerPickerCallback.tagName === 'REPORT_FILTER' || customerPickerCallback.tagName === 'SALES_FILTER');
            
            let html = '';
            
            // Add "All Customers" or multi-select controls for report filters
            if (isReportFilter && !search) {
                html += `
                    <div class="item-picker-card" style="border-left: 4px solid #8a8a8a; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="item-picker-desc" style="font-weight: bold; color: #1976d2;">
                                    <span style="font-size: 18px; margin-right: 8px;"></span> All Customers
                                </div>
                                <div style="font-size: 12px; color: #555;">Select specific customers below, or leave all unchecked for all customers</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllCustomers()" class="oval-action-btn oval-action-primary" style="font-size: 11px; padding: 4px 10px;"> Select All</button>
                                <button onclick="clearAllCustomers()" class="oval-action-btn oval-action-warning" style="font-size: 11px; padding: 4px 10px;"> Clear All</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && !isReportFilter) {
                listContainer.innerHTML = `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No customers found</div>
                    </div>
                `;
                return;
            }
            
            filtered.forEach(c => {
                const isSelected = selectedCustomersForReport.includes(c.Customer_ID);
                const touchHandlers = `ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)"`;
                const clickHandler = isReportFilter 
                    ? `${touchHandlers} ontouchend="if(pickerTouchEnd()) toggleCustomerSelection('${c.Customer_ID}')" onclick="toggleCustomerSelection('${c.Customer_ID}')"` 
                    : `${touchHandlers} ontouchend="if(pickerTouchEnd()) selectCustomerFromPicker('${c.Customer_ID}')" onclick="selectCustomerFromPicker('${c.Customer_ID}')"`;
                const checkboxHtml = isReportFilter 
                    ? `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleCustomerSelection('${c.Customer_ID}')" style="width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation()">` 
                    : '';
                
                // Add Top Customer badge if applicable
                let topCustomerBadge = '';
                if (c.Top_Customer_Rank) {
                    const rank = parseInt(c.Top_Customer_Rank);
                    if (rank === 1) {
                        topCustomerBadge = `<span class="item-picker-stock" style="background: #ffd700; color: #000; border: 2px solid #ffed4e; font-weight: bold;"> #1 Top Customer</span>`;
                    } else if (rank <= 10) {
                        topCustomerBadge = `<span class="item-picker-stock" style="background: #fff9c4; color: #f57f17; border: 2px solid #fbc02d; font-weight: bold;"> Top 10 Customer</span>`;
                    } else if (rank <= 25) {
                        topCustomerBadge = `<span class="item-picker-stock" style="background: #e3f2fd; color: #1565c0; border: 2px solid #64b5f6;"> Top 25 Customer</span>`;
                    }
                }
                
                html += `
                    <div class="item-picker-card customer-card" ${clickHandler} style="border-left: 4px solid ${isSelected ? '#10b981' : '#c0c0c0'}; ${isSelected ? 'background: #d1fae5;' : ''} display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        ${checkboxHtml}
                        <div style="flex: 1;">
                            <div class="item-picker-card-header" style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                                <span class="item-picker-sku">${c.Customer_ID}</span>
                                ${c.Route ? `<span class="item-picker-stock" style="background: #f0f0f0; color: #555;">Route: ${c.Route}</span>` : ''}
                                ${topCustomerBadge}
                            </div>
                            <div class="item-picker-desc" style="margin-bottom: 8px;">${c.Customer_Name || 'Unnamed Customer'}</div>
                            <div class="item-picker-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
                                ${c.Contact_Name ? `<div class="item-picker-detail"><span class="item-picker-detail-label"> Contact</span><span class="item-picker-detail-value">${c.Contact_Name}</span></div>` : ''}
                                ${c.Phone ? `<div class="item-picker-detail"><span class="item-picker-detail-label"> Phone</span><span class="item-picker-detail-value">${c.Phone}</span></div>` : ''}
                                ${c.Mobile ? `<div class="item-picker-detail"><span class="item-picker-detail-label"> Mobile</span><span class="item-picker-detail-value">${c.Mobile}</span></div>` : ''}
                                ${c.Email ? `<div class="item-picker-detail"><span class="item-picker-detail-label"> Email</span><span class="item-picker-detail-value" style="font-size: 13px;">${c.Email}</span></div>` : ''}
                            </div>
                            ${c.Address || c.City || c.State || c.Zip ? `
                                <div style="margin-top: 10px; padding: 10px; background: ${isSelected ? '#bbf7d0' : '#f8f9fa'}; border-radius: 8px; border: 1px solid ${isSelected ? '#86efac' : '#e0e0e0'};">
                                    <div style="font-weight: 600; color: ${isSelected ? '#166534' : '#666'}; margin-bottom: 4px; font-size: 12px;"> ADDRESS</div>
                                    ${c.Address ? `<div style="font-size: 13px; color: #222 !important;">${c.Address}</div>` : ''}
                                    ${c.City || c.State || c.Zip ? `
                                        <div style="font-size: 13px; color: #444 !important;">
                                            ${c.City || ''}${c.City && (c.State || c.Zip) ? ', ' : ''}${c.State || ''} ${c.Zip || ''}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        // Toggle customer selection for multi-select
        function toggleCustomerSelection(customerId) {
            const index = selectedCustomersForReport.indexOf(customerId);
            if (index > -1) {
                selectedCustomersForReport.splice(index, 1);
            } else {
                selectedCustomersForReport.push(customerId);
            }
            renderCustomerPickerList();
            updateCustomerSelectionDisplay();
        }
        
        // Select all customers
        function selectAllCustomers() {
            const search = document.getElementById('customerPickerSearch').value.toLowerCase().trim();
            let customers = cachedCustomers || [];
            let filtered = customers.filter(c => {
                return !search || 
                    (c.Customer_Name && c.Customer_Name.toLowerCase().includes(search)) ||
                    (c.Customer_ID && c.Customer_ID.toLowerCase().includes(search));
            });
            selectedCustomersForReport = filtered.map(c => c.Customer_ID);
            renderCustomerPickerList();
            updateCustomerSelectionDisplay();
        }
        
        // Clear all customer selections
        function clearAllCustomers() {
            selectedCustomersForReport = [];
            renderCustomerPickerList();
            updateCustomerSelectionDisplay();
        }
        
        // Update the display field with selection count
        function updateCustomerSelectionDisplay() {
            // Determine which fields to update based on callback
            let displayInput, hiddenInput;
            
            if (customerPickerCallback && customerPickerCallback.tagName === 'SALES_FILTER') {
                displayInput = document.getElementById('filterSaleCustomer_display');
                hiddenInput = document.getElementById('filterSaleCustomer');
            } else {
                displayInput = document.getElementById('rptFilter_customer_display');
                hiddenInput = document.getElementById('rptFilter_customer');
            }
            
            const countDiv = document.getElementById('customerSelectionCount');
            
            if (selectedCustomersForReport.length === 0) {
                if (displayInput) displayInput.value = '';
                if (hiddenInput) hiddenInput.value = '';
                if (countDiv) countDiv.textContent = 'No customers selected (all will be shown)';
            } else if (selectedCustomersForReport.length === 1) {
                const customer = (cachedCustomers || []).find(c => c.Customer_ID === selectedCustomersForReport[0]);
                if (displayInput) displayInput.value = customer ? customer.Customer_Name : selectedCustomersForReport[0];
                if (hiddenInput) hiddenInput.value = selectedCustomersForReport[0];
                if (countDiv) countDiv.textContent = '1 customer selected';
            } else if (selectedCustomersForReport.length <= 3) {
                // For 2-3 customers, show their names
                const names = selectedCustomersForReport.map(id => {
                    const c = (cachedCustomers || []).find(cust => cust.Customer_ID === id);
                    return c ? c.Customer_Name : id;
                }).join(', ');
                if (displayInput) displayInput.value = names;
                if (hiddenInput) hiddenInput.value = selectedCustomersForReport.join(',');
                if (countDiv) countDiv.textContent = `${selectedCustomersForReport.length} customers selected`;
            } else {
                // For more than 3, show count
                if (displayInput) displayInput.value = `${selectedCustomersForReport.length} customers selected`;
                if (hiddenInput) hiddenInput.value = selectedCustomersForReport.join(',');
                if (countDiv) countDiv.textContent = `${selectedCustomersForReport.length} customers selected`;
            }
            
            // Trigger filter update for sales orders
            if (customerPickerCallback && customerPickerCallback.tagName === 'SALES_FILTER') {
                filterSales();
            }
        }
        
        function selectCustomerFromPicker(customerId) {
            if (customerPickerCallback) {
                // Check if this is a report filter
                if (customerPickerCallback.tagName === 'REPORT_FILTER') {
                    const displayInput = document.getElementById('rptFilter_customer_display');
                    const hiddenInput = document.getElementById('rptFilter_customer');
                    if (customerId === '') {
                        displayInput.value = '';
                        hiddenInput.value = '';
                    } else {
                        const customer = (cachedCustomers || []).find(c => c.Customer_ID === customerId);
                        displayInput.value = customer ? customer.Customer_Name : customerId;
                        hiddenInput.value = customerId;
                    }
                    window.customerPickerIsFilter = false;
                    closeCustomerPicker();
                    return;
                }
                
                // Check if this is a filter text input or a select element
                const isTextInput = customerPickerCallback.tagName === 'INPUT' && customerPickerCallback.type === 'text';
                
                if (isTextInput && window.customerPickerIsFilter) {
                    // For filter inputs, set the customer name as value
                    if (customerId === '') {
                        customerPickerCallback.value = '';
                    } else {
                        const customer = (cachedCustomers || []).find(c => c.Customer_ID === customerId);
                        customerPickerCallback.value = customer ? customer.Customer_Name : customerId;
                    }
                    // Trigger the filter function
                    if (typeof filterCustomers === 'function') filterCustomers();
                } else {
                    customerPickerCallback.value = customerId;
                    customerPickerCallback.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // Explicitly call filter function if it's a filter select
                    const id = customerPickerCallback.id;
                    if (id === 'filterSaleCustomer') {
                        if (typeof filterSales === 'function') filterSales();
                    }
                }
            }
            window.customerPickerIsFilter = false;
            closeCustomerPicker();
        }
        
        function attachCustomerPickerToSelects() {
            // Attach to ALL customer selects on ALL devices (forms + filters + reports)
            const customerSelects = [
                // Form selects
                '#soCustomer', '#editSOCustomer',
                // Filter selects
                '#filterSaleCustomer',
                // Report filters
                '#filter_customer',
                // Class-based
                '.customer-select'
            ].join(', ');
            
            document.querySelectorAll(customerSelects).forEach(select => {
                if (!select.dataset.customerPickerAttached) {
                    select.dataset.customerPickerAttached = 'true';
                    select.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openCustomerPicker(this);
                    });
                    select.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openCustomerPicker(this);
                    });
                }
            });
        }
        
        // ==================== PO PICKER ====================
        
        let poPickerCallback = null;
        
        function openPOPicker(inputElement) {
            document.activeElement?.blur();
            poPickerCallback = inputElement;
            document.getElementById('poPickerSearch').value = '';
            renderPOPickerList();
            document.getElementById('poPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            focusOnDesktop('poPickerSearch');
        }
        
        // PO picker for Purchase Orders filter (multi-select)
        function openPOPickerForPurchases() {
            document.activeElement?.blur();
            poPickerCallback = {
                tagName: 'PURCHASE_FILTER',
                value: document.getElementById('filterPurchasePO').value
            };
            
            // Initialize selected POs from current value
            const currentValue = document.getElementById('filterPurchasePO').value;
            if (currentValue) {
                selectedPOsForPurchases = currentValue.split(',').filter(v => v);
            } else {
                selectedPOsForPurchases = [];
            }
            
            document.getElementById('poPickerSearch').value = '';
            renderPOPickerList();
            document.getElementById('poPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('poPickerSearch');
        }
        
        function togglePOSelection(poNum) {
            const index = selectedPOsForPurchases.indexOf(poNum);
            if (index > -1) {
                selectedPOsForPurchases.splice(index, 1);
            } else {
                selectedPOsForPurchases.push(poNum);
            }
            renderPOPickerList();
            updatePOSelectionDisplay();
        }
        
        function selectAllPOs() {
            const search = document.getElementById('poPickerSearch').value.toLowerCase().trim();
            let pos = purchasesData || [];
            let filtered = pos.filter(po => {
                return !search || 
                    (po.PO_ID && po.PO_ID.toLowerCase().includes(search)) ||
                    (po.Invoice_Number && po.Invoice_Number.toLowerCase().includes(search));
            });
            // Sort and limit to 50
            filtered.sort((a, b) => new Date(b.PO_Date || 0) - new Date(a.PO_Date || 0));
            selectedPOsForPurchases = filtered.slice(0, 50).map(po => po.Invoice_Number || po.PO_ID);
            renderPOPickerList();
            updatePOSelectionDisplay();
        }
        
        function clearAllPOs() {
            selectedPOsForPurchases = [];
            renderPOPickerList();
            updatePOSelectionDisplay();
        }
        
        function updatePOSelectionDisplay() {
            const displayInput = document.getElementById('filterPurchasePO_display');
            const hiddenInput = document.getElementById('filterPurchasePO');
            const countDiv = document.getElementById('poSelectionCount');
            
            if (selectedPOsForPurchases.length === 0) {
                if (displayInput) displayInput.value = '';
                if (hiddenInput) hiddenInput.value = '';
                if (countDiv) countDiv.textContent = 'No POs selected (all will be shown)';
            } else if (selectedPOsForPurchases.length === 1) {
                if (displayInput) displayInput.value = selectedPOsForPurchases[0];
                if (hiddenInput) hiddenInput.value = selectedPOsForPurchases[0];
                if (countDiv) countDiv.textContent = '1 PO selected';
            } else {
                if (displayInput) displayInput.value = `${selectedPOsForPurchases.length} POs selected`;
                if (hiddenInput) hiddenInput.value = selectedPOsForPurchases.join(',');
                if (countDiv) countDiv.textContent = `${selectedPOsForPurchases.length} POs selected`;
            }
            
            // Trigger filter update
            filterPurchases();
        }
        
        function closePOPicker() {
            document.getElementById('poPickerModal').classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
            poPickerCallback = null;
        }
        
        function filterPOPicker() {
            renderPOPickerList();
        }
        
        function renderPOPickerList() {
            const search = document.getElementById('poPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('poPickerList');
            
            // Get POs from cache - use purchasesData not cachedPurchases
            let pos = purchasesData || [];
            
            let filtered = pos.filter(po => {
                return !search || 
                    (po.PO_ID && po.PO_ID.toLowerCase().includes(search)) ||
                    (po.Invoice_Number && po.Invoice_Number.toLowerCase().includes(search));
            });
            
            // Check if this is a purchase filter (multi-select enabled)
            const isPurchaseFilter = poPickerCallback && poPickerCallback.tagName === 'PURCHASE_FILTER';
            
            let html = '';
            
            // Add multi-select controls for purchase filter
            if (isPurchaseFilter && !search) {
                html += `
                    <div class="item-picker-card" style="border-left: 4px solid #8a8a8a; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="item-picker-desc" style="font-weight: bold; color: #1976d2;">
                                    <span style="font-size: 18px; margin-right: 8px;"></span> All Purchase Orders
                                </div>
                                <div style="font-size: 12px; color: #555;">Select specific POs below, or leave all unchecked for all POs</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllPOs()" class="oval-action-btn oval-action-primary" style="font-size: 11px; padding: 4px 10px;"> Select All</button>
                                <button onclick="clearAllPOs()" class="oval-action-btn oval-action-warning" style="font-size: 11px; padding: 4px 10px;"> Clear All</button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (!isPurchaseFilter && !search) {
                // Add "Clear Filter" option for single-select mode
                html += `
                    <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectPOFromPicker('')" onclick="selectPOFromPicker('')" style="border-left: 4px solid #8a8a8a; background: #f8f9fa;">
                        <div class="item-picker-desc" style="font-weight: bold; color: #495057;">
                            <span style="font-size: 18px; margin-right: 8px;"></span> Clear Filter
                        </div>
                        <div style="font-size: 12px; color: #8a8a8a;">Show all purchase orders</div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && !isPurchaseFilter) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No purchase orders found</div>
                    </div>
                `;
                return;
            }
            
            // Sort by date descending
            filtered.sort((a, b) => new Date(b.PO_Date || 0) - new Date(a.PO_Date || 0));
            
            // Limit to 50
            filtered.slice(0, 50).forEach(po => {
                const status = po.Status || 'Ordered';
                const statusColor = status === 'Received' ? '#6b9a8d' : '#b8a86b';
                const supplierName = getSupplierName(po.Supplier_ID);
                const total = parseFloat(po.Total_Amount) || 0;
                const date = po.PO_Date ? new Date(po.PO_Date).toLocaleDateString() : '';
                const displayNum = po.Invoice_Number || po.PO_ID;
                
                const isSelected = selectedPOsForPurchases.includes(displayNum);
                const touchHandlers = `ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)"`;
                const clickHandler = isPurchaseFilter 
                    ? `${touchHandlers} ontouchend="if(pickerTouchEnd()) togglePOSelection('${displayNum}')" onclick="togglePOSelection('${displayNum}')"` 
                    : `${touchHandlers} ontouchend="if(pickerTouchEnd()) selectPOFromPicker('${displayNum}')" onclick="selectPOFromPicker('${displayNum}')"`;
                const checkboxHtml = isPurchaseFilter 
                    ? `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="togglePOSelection('${displayNum}')" style="width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation()">` 
                    : '';
                
                html += `
                    <div class="item-picker-card" ${clickHandler} style="border-left: 4px solid ${isSelected ? '#10b981' : '#c0c0c0'}; ${isSelected ? 'background: #d1fae5;' : 'background: white;'} display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        ${checkboxHtml}
                        <div style="flex: 1;">
                            <div class="item-picker-card-header">
                                <span class="item-picker-sku">${displayNum}</span>
                                <span class="item-picker-stock" style="background: ${status === 'Received' ? '#e8f5e9' : '#fff3e0'}; color: ${statusColor};">${status}</span>
                            </div>
                            <div class="item-picker-desc">${supplierName}</div>
                            <div class="item-picker-details">
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">DATE</span>
                                    <span class="item-picker-detail-value">${date}</span>
                                </div>
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">TOTAL</span>
                                    <span class="item-picker-detail-value item-picker-price">${formatMoney(total)}</span>
                                </div>
                                ${po.PO_ID !== displayNum ? `<div class="item-picker-detail"><span class="item-picker-detail-label">PO ID</span><span class="item-picker-detail-value">${po.PO_ID}</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function selectPOFromPicker(poNumber) {
            if (poPickerCallback) {
                poPickerCallback.value = poNumber;
                if (typeof filterPurchases === 'function') filterPurchases();
            }
            closePOPicker();
        }
        
        // ==================== PO PICKER FOR REPORTS ====================
        
        let selectedPOsForReport = [];
        
        async function openPurchaseInvoicePickerForReport() {
            document.activeElement?.blur();
            
            // Show loading in picker
            document.getElementById('poPickerSearch').value = '';
            document.getElementById('poPickerList').innerHTML = '<div style="padding: 40px; text-align: center; color: #666;"><div style="font-size: 24px; margin-bottom: 10px;"></div>Loading purchase orders...</div>';
            document.getElementById('poPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            
            // Load data if not cached
            if (!cachedPurchaseOrders || cachedPurchaseOrders.length === 0) {
                try {
                    const result = await apiCall('getPurchaseOrders');
                    if (result?.data) {
                        cachedPurchaseOrders = result.data;
                    }
                } catch(e) {
                    console.error('Error loading POs:', e);
                }
            }
            
            // Initialize selected POs from current value
            const currentValue = document.getElementById('rptFilter_purchaseInvoice')?.value || '';
            if (currentValue) {
                selectedPOsForReport = currentValue.split(',').filter(v => v);
            } else {
                selectedPOsForReport = [];
            }
            
            poPickerCallback = {
                tagName: 'REPORT_PO_FILTER'
            };
            
            renderPOPickerListForReport();
            focusOnDesktop('poPickerSearch');
        }
        
        function renderPOPickerListForReport() {
            const search = document.getElementById('poPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('poPickerList');
            
            // Get POs from cache
            let pos = cachedPurchaseOrders || purchasesData || [];
            
            let filtered = pos.filter(po => {
                return !search || 
                    (po.PO_ID && po.PO_ID.toLowerCase().includes(search)) ||
                    (po.Invoice_Number && po.Invoice_Number.toLowerCase().includes(search)) ||
                    (po.PO_Number && po.PO_Number.toLowerCase().includes(search));
            });
            
            let html = '';
            
            // Add multi-select controls at top
            if (!search) {
                html += `
                    <div class="item-picker-card" style="border-left: 4px solid #8a8a8a; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="item-picker-desc" style="font-weight: bold; color: #1976d2;">
                                    <span style="font-size: 18px; margin-right: 8px;"></span> All Purchase Orders
                                </div>
                                <div style="font-size: 12px; color: #555;">Select specific POs below, or leave all unchecked for all POs</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllPOsForReport()" class="oval-action-btn oval-action-primary" style="font-size: 11px; padding: 4px 10px;"> Select All</button>
                                <button onclick="clearAllPOsForReport()" class="oval-action-btn oval-action-warning" style="font-size: 11px; padding: 4px 10px;"> Clear All</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && search) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No purchase orders found matching "${search}"</div>
                    </div>
                `;
                return;
            }
            
            // Sort by date descending
            filtered.sort((a, b) => new Date(b.PO_Date || 0) - new Date(a.PO_Date || 0));
            
            // Limit to 50
            filtered.slice(0, 50).forEach(po => {
                const status = po.Status || 'Ordered';
                const statusColor = status === 'Received' ? '#6b9a8d' : status === 'Voided' ? '#b88a8a' : '#b8a86b';
                const supplierName = getSupplierName(po.Supplier_ID);
                const total = parseFloat(po.Total_Amount) || 0;
                const date = po.PO_Date ? new Date(po.PO_Date).toLocaleDateString() : '';
                const displayNum = po.PO_Number || po.Invoice_Number || po.PO_ID;
                const poType = po.PO_Type || 'INCOMING';
                const typeIcon = poType === 'OUTGOING' ? '' : '';
                
                const isSelected = selectedPOsForReport.includes(displayNum);
                
                html += `
                    <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) togglePOSelectionForReport('${displayNum}')" onclick="togglePOSelectionForReport('${displayNum}')" style="border-left: 4px solid ${isSelected ? '#10b981' : '#c0c0c0'}; ${isSelected ? 'background: #d1fae5;' : 'background: white;'} display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="togglePOSelectionForReport('${displayNum}')" style="width: 20px; height: 20px; cursor: pointer; margin-top: 4px;" onclick="event.stopPropagation()">
                        <div style="flex: 1;">
                            <div class="item-picker-card-header">
                                <span class="item-picker-sku">${typeIcon} ${displayNum}</span>
                                <span class="item-picker-stock" style="background: ${status === 'Received' ? '#e8f5e9' : status === 'Voided' ? '#ffebee' : '#fff3e0'}; color: ${statusColor};">${status}</span>
                            </div>
                            <div class="item-picker-desc">${supplierName}</div>
                            <div class="item-picker-details">
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">DATE</span>
                                    <span class="item-picker-detail-value">${date}</span>
                                </div>
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">TOTAL</span>
                                    <span class="item-picker-detail-value item-picker-price">${formatMoney(total)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (filtered.length > 50) {
                html += `<div style="padding: 15px; text-align: center; color: #666; font-size: 13px;">Showing 50 of ${filtered.length} POs. Use search to find more.</div>`;
            }
            
            listContainer.innerHTML = html;
            updatePOSelectionCountForReport();
        }
        
        function togglePOSelectionForReport(poNum) {
            const index = selectedPOsForReport.indexOf(poNum);
            if (index > -1) {
                selectedPOsForReport.splice(index, 1);
            } else {
                selectedPOsForReport.push(poNum);
            }
            renderPOPickerListForReport();
            updatePOSelectionDisplayForReport();
        }
        
        function selectAllPOsForReport() {
            const search = document.getElementById('poPickerSearch').value.toLowerCase().trim();
            let pos = cachedPurchaseOrders || purchasesData || [];
            let filtered = pos.filter(po => {
                return !search || 
                    (po.PO_ID && po.PO_ID.toLowerCase().includes(search)) ||
                    (po.Invoice_Number && po.Invoice_Number.toLowerCase().includes(search)) ||
                    (po.PO_Number && po.PO_Number.toLowerCase().includes(search));
            });
            // Sort and add to selection (up to 50)
            filtered.sort((a, b) => new Date(b.PO_Date || 0) - new Date(a.PO_Date || 0));
            filtered.slice(0, 50).forEach(po => {
                const displayNum = po.PO_Number || po.Invoice_Number || po.PO_ID;
                if (!selectedPOsForReport.includes(displayNum)) {
                    selectedPOsForReport.push(displayNum);
                }
            });
            renderPOPickerListForReport();
            updatePOSelectionDisplayForReport();
        }
        
        function clearAllPOsForReport() {
            selectedPOsForReport = [];
            renderPOPickerListForReport();
            updatePOSelectionDisplayForReport();
        }
        
        function updatePOSelectionCountForReport() {
            const countDiv = document.getElementById('poSelectionCount');
            if (countDiv) {
                if (selectedPOsForReport.length === 0) {
                    countDiv.textContent = 'No POs selected (all will be shown)';
                } else {
                    countDiv.textContent = `${selectedPOsForReport.length} PO(s) selected`;
                }
            }
        }
        
        function updatePOSelectionDisplayForReport() {
            const displayInput = document.getElementById('rptFilter_purchaseInvoice_display');
            const hiddenInput = document.getElementById('rptFilter_purchaseInvoice');
            
            if (selectedPOsForReport.length === 0) {
                if (displayInput) displayInput.value = '';
                if (hiddenInput) hiddenInput.value = '';
            } else if (selectedPOsForReport.length === 1) {
                if (displayInput) displayInput.value = selectedPOsForReport[0];
                if (hiddenInput) hiddenInput.value = selectedPOsForReport[0];
            } else {
                if (displayInput) displayInput.value = `${selectedPOsForReport.length} POs selected`;
                if (hiddenInput) hiddenInput.value = selectedPOsForReport.join(',');
            }
            
            updatePOSelectionCountForReport();
        }
        
        // Override filter function when PO picker is for report
        const originalFilterPOPicker = typeof filterPOPicker === 'function' ? filterPOPicker : null;
        filterPOPicker = function() {
            if (poPickerCallback && poPickerCallback.tagName === 'REPORT_PO_FILTER') {
                renderPOPickerListForReport();
            } else if (originalFilterPOPicker) {
                originalFilterPOPicker();
            } else {
                renderPOPickerList();
            }
        };
        
        // Override close function
        const originalClosePOPicker = closePOPicker;
        closePOPicker = function() {
            if (poPickerCallback && poPickerCallback.tagName === 'REPORT_PO_FILTER') {
                updatePOSelectionDisplayForReport();
            }
            document.getElementById('poPickerModal').classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open');
            poPickerCallback = null;
        };
        
        // ==================== INVOICE PICKER ====================
        
        let invoicePickerCallback = null;
        
        function openInvoicePicker(inputElement) {
            document.activeElement?.blur();
            invoicePickerCallback = inputElement;
            document.getElementById('invoicePickerSearch').value = '';
            renderInvoicePickerList();
            document.getElementById('invoicePickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            focusOnDesktop('invoicePickerSearch');
        }
        
        // Invoice picker for Sales Orders filter (multi-select)
        function openInvoicePickerForSales() {
            document.activeElement?.blur();
            invoicePickerCallback = {
                tagName: 'SALES_FILTER',
                value: document.getElementById('filterInvoiceNumber').value
            };
            
            // Initialize selected invoices from current value
            const currentValue = document.getElementById('filterInvoiceNumber').value;
            if (currentValue) {
                selectedInvoicesForSales = currentValue.split(',').filter(v => v);
            } else {
                selectedInvoicesForSales = [];
            }
            
            // Populate invoicePickerData from salesData for the picker to use
            const sales = salesData || window.salesData || window.cachedSales || [];
            window.invoicePickerData = sales.map(s => ({
                invoiceNum: s.Invoice_Number || s.SO_ID || 'No Invoice#',
                customerName: getCustomerName(s.Customer_ID) || s.Customer_ID || 'Unknown',
                amount: s.Total_Amount || 0,
                status: s.Status || 'Pending',
                date: s.Sale_Date
            }));
            
            document.getElementById('invoicePickerSearch').value = '';
            renderInvoicePickerList();
            document.getElementById('invoicePickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('invoicePickerSearch');
        }
        
        function toggleInvoiceSelection(invoiceNum) {
            const index = selectedInvoicesForSales.indexOf(invoiceNum);
            if (index > -1) {
                selectedInvoicesForSales.splice(index, 1);
            } else {
                selectedInvoicesForSales.push(invoiceNum);
            }
            renderInvoicePickerList();
            updateInvoiceSelectionDisplay();
        }
        
        function selectAllInvoices() {
            const search = document.getElementById('invoicePickerSearch').value.toLowerCase().trim();
            let sales = salesData || window.cachedSales || [];
            let filtered = sales.filter(sale => {
                return !search || 
                    (sale.Invoice_Number && sale.Invoice_Number.toLowerCase().includes(search)) ||
                    (sale.SO_Number && sale.SO_Number.toLowerCase().includes(search));
            });
            // Sort and limit to 50
            filtered.sort((a, b) => new Date(b.Sale_Date || 0) - new Date(a.Sale_Date || 0));
            selectedInvoicesForSales = filtered.slice(0, 50).map(s => s.Invoice_Number || s.SO_Number || 'No Invoice#');
            renderInvoicePickerList();
            updateInvoiceSelectionDisplay();
        }
        
        function clearAllInvoices() {
            selectedInvoicesForSales = [];
            renderInvoicePickerList();
            updateInvoiceSelectionDisplay();
        }
        
        function updateInvoiceSelectionDisplay() {
            const displayInput = document.getElementById('filterInvoiceNumber_display');
            const hiddenInput = document.getElementById('filterInvoiceNumber');
            const countDiv = document.getElementById('invoiceSelectionCount');
            
            if (selectedInvoicesForSales.length === 0) {
                if (displayInput) displayInput.value = '';
                if (hiddenInput) hiddenInput.value = '';
                if (countDiv) countDiv.textContent = 'No invoices selected (all will be shown)';
            } else if (selectedInvoicesForSales.length === 1) {
                if (displayInput) displayInput.value = selectedInvoicesForSales[0];
                if (hiddenInput) hiddenInput.value = selectedInvoicesForSales[0];
                if (countDiv) countDiv.textContent = '1 invoice selected';
            } else {
                if (displayInput) displayInput.value = `${selectedInvoicesForSales.length} invoices selected`;
                if (hiddenInput) hiddenInput.value = selectedInvoicesForSales.join(',');
                if (countDiv) countDiv.textContent = `${selectedInvoicesForSales.length} invoices selected`;
            }
            
            // Trigger filter update
            filterSales();
        }
        
        // ==================== ITEM PICKER (for reports) ====================
        
        function openItemPickerForReport() {
            document.activeElement?.blur();
            // Initialize selected items from current value
            const currentValue = document.getElementById('rptFilter_item').value;
            if (currentValue) {
                selectedItemsForReport = currentValue.split(',').filter(v => v);
            } else {
                selectedItemsForReport = [];
            }
            
            // Show and populate supplier filter dropdown
            const supplierFilterDiv = document.getElementById('itemPickerSupplierFilter');
            const supplierSelect = document.getElementById('itemPickerSupplier');
            if (supplierFilterDiv) {
                supplierFilterDiv.style.display = 'block';
            }
            if (supplierSelect) {
                supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
                if (cachedSuppliers && cachedSuppliers.length > 0) {
                    cachedSuppliers.forEach(s => {
                        supplierSelect.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                    });
                }
                supplierSelect.value = ''; // Reset to all suppliers
            }
            
            document.getElementById('itemPickerSearch').value = '';
            renderItemPickerListForReport();
            document.getElementById('itemPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            focusOnDesktop('itemPickerSearch');
        }
        
        // Item picker for Inventory filter (multi-select)
        function openItemPickerForInventory() {
            document.activeElement?.blur();
            window.reportPickerType = 'item';
            window.itemPickerCallback = {
                tagName: 'INVENTORY_FILTER',
                value: document.getElementById('filterInventorySearch').value
            };
            
            // Initialize selected items from current value
            const currentValue = document.getElementById('filterInventorySearch').value;
            if (currentValue) {
                selectedItemsForInventory = currentValue.split(',').filter(v => v);
            } else {
                selectedItemsForInventory = [];
            }
            
            document.getElementById('itemPickerSearch').value = '';
            renderItemPickerListForInventory();
            document.getElementById('itemPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('itemPickerSearch');
        }
        
        // Item picker for Pricing Workbench filter (multi-select)
        function openItemPickerForPricing() {
            document.activeElement?.blur();
            window.reportPickerType = 'item';
            window.itemPickerCallback = {
                tagName: 'PRICING_FILTER',
                value: document.getElementById('pricesimSearch').value
            };
            
            // Initialize selected items from current value
            const currentValue = document.getElementById('pricesimSearch').value;
            if (currentValue) {
                selectedItemsForPricing = currentValue.split(',').filter(v => v);
            } else {
                selectedItemsForPricing = [];
            }
            
            document.getElementById('itemPickerSearch').value = '';
            renderItemPickerListForPricing();
            document.getElementById('itemPickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('itemPickerSearch');
        }
        
        function closeItemPickerForReport() {
            document.getElementById('itemPickerModal').classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
        }
        
        function renderItemPickerListForInventory() {
            const search = document.getElementById('itemPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('itemPickerList');
            
            let items = cachedItems || [];
            
            let filtered = items.filter(item => {
                return !search || 
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(search)) ||
                    (item.SKU && item.SKU.toLowerCase().includes(search));
            });
            
            let html = '';
            
            // Add multi-select controls at top
            if (!search) {
                html += `
                    <div class="item-picker-card" style="border-left: 4px solid #8a8a8a; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="item-picker-desc" style="font-weight: bold; color: #1976d2;">
                                    <span style="font-size: 18px; margin-right: 8px;"></span> All Items
                                </div>
                                <div style="font-size: 12px; color: #555;">Select specific items below, or leave all unchecked for all items</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllItemsForInventory()" class="oval-action-btn oval-action-primary" style="font-size: 11px; padding: 4px 10px;"> Select All</button>
                                <button onclick="clearAllItemsForInventory()" class="oval-action-btn oval-action-warning" style="font-size: 11px; padding: 4px 10px;"> Clear All</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && search) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No items found matching "${search}"</div>
                    </div>
                `;
                return;
            }
            
            // Sort alphabetically by description
            filtered.sort((a, b) => (a.Item_Description || '').localeCompare(b.Item_Description || ''));
            
            // Show items
            filtered.forEach(item => {
                const supplierName = getSupplierName(item.Supplier_ID);
                const sellPrice = parseFloat(item.Sell_Price) || 0;
                const costPrice = parseFloat(item.Cost) || 0;
                const qty = parseInt(item.Qty_On_Hand) || 0;
                
                // Stock status color
                let stockColor = '#6b9a8d';
                let stockBg = '#e8f5e9';
                if (qty <= 0) {
                    stockColor = '#b88a8a';
                    stockBg = '#ffebee';
                } else if (qty <= (parseInt(item.Reorder_Point) || 10)) {
                    stockColor = '#b8a86b';
                    stockBg = '#fff3e0';
                }
                
                const isSelected = selectedItemsForInventory.includes(item.Item_ID);
                const touchHandlers = `ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)"`;
                const clickHandler = `${touchHandlers} ontouchend="if(pickerTouchEnd()) toggleItemSelectionForInventory('${item.Item_ID}')" onclick="toggleItemSelectionForInventory('${item.Item_ID}')"`;
                const checkboxHtml = `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleItemSelectionForInventory('${item.Item_ID}')" style="width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation()">`;
                
                html += `
                    <div class="item-picker-card" ${clickHandler} style="border-left: 4px solid ${isSelected ? '#10b981' : '#667eea'}; ${isSelected ? 'background: #d1fae5;' : 'background: white;'} display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        ${checkboxHtml}
                        <div style="flex: 1;">
                            <div class="item-picker-card-header">
                                <span class="item-picker-sku">${item.SKU || 'No SKU'}</span>
                                <span class="item-picker-stock" style="background: ${stockBg}; color: ${stockColor};">${qty} in stock</span>
                            </div>
                            <div class="item-picker-desc">${item.Item_Description || 'No description'}</div>
                            <div class="item-picker-details">
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Supplier</span>
                                    <span class="item-picker-detail-value">${supplierName}</span>
                                </div>
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Cost</span>
                                    <span class="item-picker-detail-value">${formatMoney(costPrice)}</span>
                                </div>
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Sell Price</span>
                                    <span class="item-picker-detail-value">${formatMoney(sellPrice)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        // Smart handler for item picker search that routes to correct render function
        function handleItemPickerSearch() {
            // Check callback context to determine which render function to use
            if (window.itemPickerCallback && window.itemPickerCallback.tagName === 'INVENTORY_FILTER') {
                renderItemPickerListForInventory();
            } else if (window.itemPickerCallback && window.itemPickerCallback.tagName === 'PRICING_FILTER') {
                renderItemPickerListForPricing();
            } else {
                // Default to report picker and general picker
                window.filterItemPicker();
                filterItemPickerForReport();
            }
        }
        
        function filterItemPickerForReport() {
            renderItemPickerListForReport();
        }
        
        function renderItemPickerListForReport() {
            const search = document.getElementById('itemPickerSearch').value.toLowerCase().trim();
            const supplierEl = document.getElementById('itemPickerSupplier');
            const supplierFilter = supplierEl ? supplierEl.value : '';
            const listContainer = document.getElementById('itemPickerList');
            
            let items = cachedItems || [];
            
            let filtered = items.filter(item => {
                // Search filter - check SKU and Description
                const sku = String(item.SKU || '').toLowerCase();
                const desc = String(item.Item_Description || '').toLowerCase();
                const matchesSearch = !search || sku.includes(search) || desc.includes(search);
                
                // Supplier filter
                const matchesSupplier = !supplierFilter || matchesFilter(item.Supplier_ID, supplierFilter);
                
                return matchesSearch && matchesSupplier;
            });
            
            let html = '';
            
            // Add multi-select controls at top
            if (!search) {
                html += `
                    <div class="item-picker-card" style="border-left: 4px solid #8a8a8a; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="item-picker-desc" style="font-weight: bold; color: #1976d2;">
                                    <span style="font-size: 18px; margin-right: 8px;"></span> All Items
                                </div>
                                <div style="font-size: 12px; color: #555;">Select specific items below, or leave all unchecked for all items</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllItems()" class="oval-action-btn oval-action-primary" style="font-size: 11px; padding: 4px 10px;"> Select All</button>
                                <button onclick="clearAllItems()" class="oval-action-btn oval-action-warning" style="font-size: 11px; padding: 4px 10px;"> Clear All</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && (search || supplierFilter)) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No items found${search ? ` matching "${search}"` : ''}${supplierFilter ? ' for selected supplier' : ''}</div>
                    </div>
                `;
                return;
            }
            
            // Sort alphabetically by description
            filtered.sort((a, b) => (a.Item_Description || '').localeCompare(b.Item_Description || ''));
            
            // Show items
            filtered.forEach(item => {
                const supplierName = getSupplierName(item.Supplier_ID);
                const sellPrice = parseFloat(item.Sell_Price) || 0;
                const costPrice = parseFloat(item.Cost) || 0;
                const qty = parseInt(item.Qty_On_Hand) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                const onBackorder = parseInt(item.Qty_On_Backorder) || 0;
                const expectedDate = item.Expected_Restock_Date;
                
                // Stock status color
                let stockColor = '#6b9a8d';
                let stockBg = '#e8f5e9';
                if (qty <= 0) {
                    stockColor = '#b88a8a';
                    stockBg = '#ffebee';
                } else if (qty <= (parseInt(item.Reorder_Point) || 10)) {
                    stockColor = '#b8a86b';
                    stockBg = '#fff3e0';
                }
                
                // Add On Order badge if there's quantity on order
                const onOrderBadge = onOrder > 0 ? `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; border: 2px solid #90caf9; margin-left: 4px;"> ${onOrder} On Order</span>` : '';
                
                // Add Backorder badge if there's quantity on backorder
                const backorderBadge = onBackorder > 0 ? `<span style="background: #fff3e0; color: #e65100; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; border: 2px solid #ffb74d; margin-left: 4px;"> ${onBackorder} Backorder</span>` : '';
                
                // Add Expected Date badge if available
                let expectedDateBadge = '';
                if (expectedDate && onOrder > 0) {
                    const expDate = new Date(expectedDate);
                    const today = new Date();
                    const daysUntil = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                    let dateColor = '#2e7d32';
                    let dateBg = '#e8f5e9';
                    
                    if (daysUntil < 0) {
                        dateColor = '#c62828';
                        dateBg = '#ffebee';
                    } else if (daysUntil <= 3) {
                        dateColor = '#e65100';
                        dateBg = '#fff3e0';
                    }
                    
                    const dateText = daysUntil < 0 ? `Overdue ${Math.abs(daysUntil)}d` : 
                                     daysUntil === 0 ? 'Today' : 
                                     daysUntil === 1 ? 'Tomorrow' : 
                                     `${daysUntil} days`;
                    
                    expectedDateBadge = `<div style="margin-top: 6px;"><span style="background: ${dateBg}; color: ${dateColor}; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; border: 2px solid ${dateColor === '#2e7d32' ? '#81c784' : dateColor === '#e65100' ? '#ffb74d' : '#e57373'};"> Expected: ${expDate.toLocaleDateString()} (${dateText})</span></div>`;
                }
                
                // Add Top Seller badge if applicable
                let topSellerBadge = '';
                if (item.Top_Seller_Rank) {
                    const rank = parseInt(item.Top_Seller_Rank);
                    if (rank === 1) {
                        topSellerBadge = `<span style="background: #ffd700; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; border: 2px solid #ffed4e; margin-left: 4px;"> #1 Best Seller</span>`;
                    } else if (rank <= 10) {
                        topSellerBadge = `<span style="background: #fff9c4; color: #f57f17; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; border: 2px solid #fbc02d; margin-left: 4px;"> Top 10 Best Seller</span>`;
                    } else if (rank <= 25) {
                        topSellerBadge = `<span style="background: #e3f2fd; color: #1565c0; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; border: 2px solid #64b5f6; margin-left: 4px;"> Top 25 Best Seller</span>`;
                    }
                }
                
                const isSelected = selectedItemsForReport.includes(item.Item_ID);
                const checkboxHtml = `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleItemSelection('${item.Item_ID}')" style="width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation()">`;
                
                html += `
                    <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) toggleItemSelection('${item.Item_ID}')" onclick="toggleItemSelection('${item.Item_ID}')" style="border-left: 4px solid ${isSelected ? '#10b981' : stockColor}; ${isSelected ? 'background: #d1fae5;' : ''} display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        ${checkboxHtml}
                        <div style="flex: 1;">
                            <div class="item-picker-card-header" style="display: flex; flex-wrap: wrap; gap: 4px; align-items: center;">
                                <span class="item-picker-sku">${item.SKU || 'No SKU'}</span>
                                <span style="background: ${stockBg}; color: ${stockColor}; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold;">${qty} in stock</span>${onOrderBadge}${backorderBadge}${topSellerBadge}
                            </div>
                            ${expectedDateBadge}
                            <div class="item-picker-desc">${item.Item_Description || 'No Description'}</div>
                            <div class="item-picker-details">
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Supplier</span>
                                    <span class="item-picker-detail-value">${supplierName}</span>
                                </div>
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Sell</span>
                                    <span class="item-picker-detail-value item-picker-price">${formatMoney(sellPrice)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        // Toggle item selection for multi-select
        function toggleItemSelection(itemId) {
            const index = selectedItemsForReport.indexOf(itemId);
            if (index > -1) {
                selectedItemsForReport.splice(index, 1);
            } else {
                selectedItemsForReport.push(itemId);
            }
            renderItemPickerListForReport();
            updateItemSelectionDisplay();
        }
        
        // Select all items (respects current search and supplier filter, ADDS to existing selection)
        function selectAllItems() {
            const search = document.getElementById('itemPickerSearch').value.toLowerCase().trim();
            const supplierEl = document.getElementById('itemPickerSupplier');
            const supplierFilter = supplierEl ? supplierEl.value : '';
            let items = cachedItems || [];
            let filtered = items.filter(item => {
                // Search filter
                const matchesSearch = !search || 
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(search)) ||
                    (item.SKU && item.SKU.toLowerCase().includes(search));
                
                // Supplier filter
                const matchesSupplier = !supplierFilter || matchesFilter(item.Supplier_ID, supplierFilter);
                
                return matchesSearch && matchesSupplier;
            });
            // Add to existing selection (don't replace)
            filtered.forEach(item => {
                if (!selectedItemsForReport.includes(item.Item_ID)) {
                    selectedItemsForReport.push(item.Item_ID);
                }
            });
            renderItemPickerListForReport();
            updateItemSelectionDisplay();
        }
        
        // Clear all item selections
        function clearAllItems() {
            selectedItemsForReport = [];
            renderItemPickerListForReport();
            updateItemSelectionDisplay();
        }
        
        // Pricing Workbench item picker render function
        function renderItemPickerListForPricing() {
            const search = document.getElementById('itemPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('itemPickerList');
            
            let items = cachedItems || [];
            
            let filtered = items.filter(item => {
                return !search || 
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(search)) ||
                    (item.SKU && item.SKU.toLowerCase().includes(search));
            });
            
            let html = '';
            
            // Add multi-select controls at top
            if (!search) {
                html += `
                    <div class="item-picker-card" style="border-left: 4px solid #8a8a8a; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="item-picker-desc" style="font-weight: bold; color: #1976d2;">
                                    <span style="font-size: 18px; margin-right: 8px;"></span> All Items
                                </div>
                                <div style="font-size: 12px; color: #555;">Select specific items below, or leave all unchecked for all items</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllItemsForPricing()" class="oval-action-btn oval-action-primary" style="font-size: 11px; padding: 4px 10px;"> Select All</button>
                                <button onclick="clearAllItemsForPricing()" class="oval-action-btn oval-action-warning" style="font-size: 11px; padding: 4px 10px;"> Clear All</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && search) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No items found matching "${search}"</div>
                    </div>
                `;
                return;
            }
            
            // Sort alphabetically by description
            filtered.sort((a, b) => (a.Item_Description || '').localeCompare(b.Item_Description || ''));
            
            // Show items
            filtered.forEach(item => {
                const supplierName = getSupplierName(item.Supplier_ID);
                const sellPrice = parseFloat(item.Sell_Price) || 0;
                const costPrice = parseFloat(item.Cost) || 0;
                const qty = parseInt(item.Qty_On_Hand) || 0;
                
                // Stock status color
                let stockColor = '#6b9a8d';
                let stockBg = '#e8f5e9';
                if (qty <= 0) {
                    stockColor = '#b88a8a';
                    stockBg = '#ffebee';
                } else if (qty <= (parseInt(item.Reorder_Point) || 10)) {
                    stockColor = '#b8a86b';
                    stockBg = '#fff3e0';
                }
                
                const isSelected = selectedItemsForPricing.includes(item.Item_ID);
                const touchHandlers = `ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)"`;
                const clickHandler = `${touchHandlers} ontouchend="if(pickerTouchEnd()) toggleItemSelectionForPricing('${item.Item_ID}')" onclick="toggleItemSelectionForPricing('${item.Item_ID}')"`;
                const checkboxHtml = `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleItemSelectionForPricing('${item.Item_ID}')" style="width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation()">`;
                
                html += `
                    <div class="item-picker-card" ${clickHandler} style="border-left: 4px solid ${isSelected ? '#10b981' : '#667eea'}; ${isSelected ? 'background: #d1fae5;' : 'background: white;'} display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        ${checkboxHtml}
                        <div style="flex: 1;">
                            <div class="item-picker-card-header">
                                <span class="item-picker-sku">${item.SKU || 'No SKU'}</span>
                                <span class="item-picker-stock" style="background: ${stockBg}; color: ${stockColor};">${qty} in stock</span>
                            </div>
                            <div class="item-picker-desc">${item.Item_Description || 'No description'}</div>
                            <div class="item-picker-details">
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Supplier</span>
                                    <span class="item-picker-detail-value">${supplierName}</span>
                                </div>
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Cost</span>
                                    <span class="item-picker-detail-value">${formatMoney(costPrice)}</span>
                                </div>
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Sell Price</span>
                                    <span class="item-picker-detail-value">${formatMoney(sellPrice)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        // Pricing-specific item selection functions
        function toggleItemSelectionForPricing(itemId) {
            const index = selectedItemsForPricing.indexOf(itemId);
            if (index > -1) {
                selectedItemsForPricing.splice(index, 1);
            } else {
                selectedItemsForPricing.push(itemId);
            }
            renderItemPickerListForPricing();
            updateItemSelectionDisplayForPricing();
        }
        
        function selectAllItemsForPricing() {
            const search = document.getElementById('itemPickerSearch').value.toLowerCase().trim();
            const supplierEl = document.getElementById('itemPickerSupplier');
            const supplierFilter = supplierEl ? supplierEl.value : '';
            let items = cachedItems || [];
            let filtered = items.filter(item => {
                // Search filter
                const matchesSearch = !search || 
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(search)) ||
                    (item.SKU && item.SKU.toLowerCase().includes(search));
                
                // Supplier filter
                const matchesSupplier = !supplierFilter || matchesFilter(item.Supplier_ID, supplierFilter);
                
                return matchesSearch && matchesSupplier;
            });
            // Add to existing selection (don't replace)
            filtered.forEach(item => {
                if (!selectedItemsForPricing.includes(item.Item_ID)) {
                    selectedItemsForPricing.push(item.Item_ID);
                }
            });
            renderItemPickerListForPricing();
            updateItemSelectionDisplayForPricing();
        }
        
        function clearAllItemsForPricing() {
            selectedItemsForPricing = [];
            renderItemPickerListForPricing();
            updateItemSelectionDisplayForPricing();
        }
        
        function updateItemSelectionDisplayForPricing() {
            const displayInput = document.getElementById('pricesimSearch_display');
            const hiddenInput = document.getElementById('pricesimSearch');
            const countDiv = document.getElementById('itemSelectionCount');
            
            if (selectedItemsForPricing.length === 0) {
                if (displayInput) displayInput.value = '';
                if (hiddenInput) hiddenInput.value = '';
                if (countDiv) countDiv.textContent = 'No items selected (all will be shown)';
            } else if (selectedItemsForPricing.length === 1) {
                const item = (cachedItems || []).find(i => i.Item_ID === selectedItemsForPricing[0]);
                if (displayInput) displayInput.value = item ? item.Item_Description : selectedItemsForPricing[0];
                if (hiddenInput) hiddenInput.value = selectedItemsForPricing[0];
                if (countDiv) countDiv.textContent = '1 item selected';
            } else {
                if (displayInput) displayInput.value = `${selectedItemsForPricing.length} items selected`;
                if (hiddenInput) hiddenInput.value = selectedItemsForPricing.join(',');
                if (countDiv) countDiv.textContent = `${selectedItemsForPricing.length} items selected`;
            }
            
            // Trigger filter update
            filterPriceSimItems();
        }
        
        // Inventory-specific item selection functions
        function toggleItemSelectionForInventory(itemId) {
            const index = selectedItemsForInventory.indexOf(itemId);
            if (index > -1) {
                selectedItemsForInventory.splice(index, 1);
            } else {
                selectedItemsForInventory.push(itemId);
            }
            renderItemPickerListForInventory();
            updateItemSelectionDisplayForInventory();
        }
        
        function selectAllItemsForInventory() {
            const search = document.getElementById('itemPickerSearch').value.toLowerCase().trim();
            const supplierEl = document.getElementById('itemPickerSupplier');
            const supplierFilter = supplierEl ? supplierEl.value : '';
            let items = cachedItems || [];
            let filtered = items.filter(item => {
                // Search filter
                const matchesSearch = !search || 
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(search)) ||
                    (item.SKU && item.SKU.toLowerCase().includes(search));
                
                // Supplier filter
                const matchesSupplier = !supplierFilter || matchesFilter(item.Supplier_ID, supplierFilter);
                
                return matchesSearch && matchesSupplier;
            });
            // Add to existing selection (don't replace)
            filtered.forEach(item => {
                if (!selectedItemsForInventory.includes(item.Item_ID)) {
                    selectedItemsForInventory.push(item.Item_ID);
                }
            });
            renderItemPickerListForInventory();
            updateItemSelectionDisplayForInventory();
        }
        
        function clearAllItemsForInventory() {
            selectedItemsForInventory = [];
            renderItemPickerListForInventory();
            updateItemSelectionDisplayForInventory();
        }
        
        function updateItemSelectionDisplayForInventory() {
            const displayInput = document.getElementById('filterInventorySearch_display');
            const hiddenInput = document.getElementById('filterInventorySearch');
            const countDiv = document.getElementById('itemSelectionCount');
            
            if (selectedItemsForInventory.length === 0) {
                if (displayInput) displayInput.value = '';
                if (hiddenInput) hiddenInput.value = '';
                if (countDiv) countDiv.textContent = 'No items selected (all will be shown)';
            } else if (selectedItemsForInventory.length === 1) {
                const item = (cachedItems || []).find(i => i.Item_ID === selectedItemsForInventory[0]);
                if (displayInput) displayInput.value = item ? item.Item_Description : selectedItemsForInventory[0];
                if (hiddenInput) hiddenInput.value = selectedItemsForInventory[0];
                if (countDiv) countDiv.textContent = '1 item selected';
            } else {
                if (displayInput) displayInput.value = `${selectedItemsForInventory.length} items selected`;
                if (hiddenInput) hiddenInput.value = selectedItemsForInventory.join(',');
                if (countDiv) countDiv.textContent = `${selectedItemsForInventory.length} items selected`;
            }
            
            // Trigger filter update
            filterInventory();
        }
        
        // Update the display field with selection count
        function updateItemSelectionDisplay() {
            const displayInput = document.getElementById('rptFilter_item_display');
            const hiddenInput = document.getElementById('rptFilter_item');
            const countDiv = document.getElementById('itemSelectionCount');
            
            if (selectedItemsForReport.length === 0) {
                displayInput.value = '';
                hiddenInput.value = '';
                if (countDiv) countDiv.textContent = 'No items selected (all will be shown)';
            } else if (selectedItemsForReport.length === 1) {
                const item = (cachedItems || []).find(i => i.Item_ID === selectedItemsForReport[0]);
                displayInput.value = item ? item.Item_Description : selectedItemsForReport[0];
                hiddenInput.value = selectedItemsForReport[0];
                if (countDiv) countDiv.textContent = '1 item selected';
            } else {
                displayInput.value = `${selectedItemsForReport.length} items selected`;
                hiddenInput.value = selectedItemsForReport.join(',');
                if (countDiv) countDiv.textContent = `${selectedItemsForReport.length} items selected`;
            }
        }
        
        function selectItemForReport(itemId, itemName) {
            document.getElementById('rptFilter_item').value = itemId;
            document.getElementById('rptFilter_item_display').value = itemId ? itemName : 'All Items (click to filter)';
            closeItemPickerForReport();
        }
        
        // ==================== PO TYPE PICKER (for reports) ====================
        
        function openPOTypePicker() {
            document.getElementById('poTypePickerModal').classList.add('modal-open');
            document.body.style.overflow = 'hidden';
        }
        
        function closePOTypePicker() {
            document.getElementById('poTypePickerModal').classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
        }
        
        function selectPOType(typeValue, typeName) {
            document.getElementById('rptFilter_poType').value = typeValue;
            document.getElementById('rptFilter_poType_display').value = typeValue ? typeName : 'All Types (click to select)';
            closePOTypePicker();
        }
        
        function attachStatusPickerToSelects() {
            // Stock Status selects - use the 'stock' type we added
            document.querySelectorAll('#filterItemStock, #filterInventoryStock, #pricesimStock').forEach(select => {
                if (!select.dataset.statusPickerAttached) {
                    select.dataset.statusPickerAttached = 'true';
                    const selectId = select.id;
                    select.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openStatusPicker('stock', selectId, () => filterInventory());
                    });
                    select.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openStatusPicker('stock', selectId, () => filterInventory());
                    }, { passive: false });
                }
            });
            
            // Note: Other status selects (filterPurchaseStatus, filterPurchasePaymentStatus) 
            // already use onclick handlers in their HTML, so we don't need to attach here
        }
        
        // Attach all pickers on page load
        document.addEventListener('DOMContentLoaded', function() {
            attachItemPickerToSelects();
            attachSupplierPickerToSelects();
            attachCustomerPickerToSelects();
            attachStatusPickerToSelects();
            setInterval(() => {
                attachItemPickerToSelects();
                attachSupplierPickerToSelects();
                attachCustomerPickerToSelects();
                attachStatusPickerToSelects();
            }, 1000);
            
            // ==================== ORIENTATION CHANGE FIX ====================
            // Prevent screen from becoming "loose" when rotating device
            
            function lockViewport() {
                // Only re-lock if a modal is actually open
                const modalsOpen = document.querySelectorAll('.modal[style*="display: block"], #orderModal[style*="display: block"], #reportSetupModal[style*="display: block"]');
                if (modalsOpen.length > 0) {
                    document.body.classList.add('modal-open');
                    document.body.style.overflow = 'hidden';
                    document.body.style.position = 'fixed';
                    document.body.style.width = '100%';
                } else {
                    // Make sure body is NOT locked when no modal is open
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.position = '';
                    document.body.style.width = '';
                    document.body.style.minHeight = '';
                }
            }
            
            // Handle orientation change - prevent iOS select picker popup
            window.addEventListener('orientationchange', function() {
                // Immediately blur ALL form elements
                document.activeElement?.blur();
                
                // Temporarily disable all select elements to prevent iOS picker
                const allSelects = document.querySelectorAll('select');
                allSelects.forEach(sel => {
                    sel.style.pointerEvents = 'none';
                    sel.setAttribute('disabled', 'disabled');
                });
                
                // Re-enable after orientation change completes
                setTimeout(function() {
                    allSelects.forEach(sel => {
                        sel.style.pointerEvents = '';
                        sel.removeAttribute('disabled');
                    });
                }, 500);
                
                setTimeout(lockViewport, 100);
                setTimeout(lockViewport, 300);
            });
            
            // Handle resize (also triggered by orientation on some devices)
            let resizeTimeout;
            window.addEventListener('resize', function() {
                // Blur any focused elements
                document.activeElement?.blur();
                
                // CRITICAL: Close ALL picker modals on resize to prevent ghost popups
                const allPickerModals = document.querySelectorAll('.item-picker-overlay');
                allPickerModals.forEach(modal => {
                    modal.classList.remove('modal-open', 'status-picker-open', 'quick-add-open');
                });
                
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(lockViewport, 150);
            });
            
            // CRITICAL: Ensure ALL picker modals are hidden on page load
            const allPickerModals = document.querySelectorAll('.item-picker-overlay');
            allPickerModals.forEach(modal => {
                modal.classList.remove('modal-open', 'status-picker-open', 'quick-add-open');
            });
        });
        
        // ==================== HOW-TO GUIDE FUNCTIONS ====================
        
        function openHowToGuide() {
            document.getElementById('howToGuideModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            showGuideSection('getting-started'); // Show first section by default
        }
        
        function closeHowToGuide() {
            document.getElementById('howToGuideModal').style.display = 'none';
            document.body.style.overflow = '';
        }
        
        // ==================== DIAGNOSTIC TOOL ====================
        
        function openDiagnosticTool() {
            document.getElementById('diagnosticModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            // Show current environment
            const envDisplay = document.getElementById('diagEnvDisplay');
            envDisplay.innerHTML = `<strong>Environment:</strong> ${currentEnvironment.toUpperCase()}<br><strong>API URL:</strong> ${API_URL}`;
        }
        
        function closeDiagnosticTool() {
            document.getElementById('diagnosticModal').style.display = 'none';
            document.body.style.overflow = '';
        }
        
        async function runDiagnosticTest(testType) {
            const resultsDiv = document.getElementById('diagResults');
            const timestamp = new Date().toLocaleTimeString();
            
            resultsDiv.innerHTML += `<p style="color: #60a5fa;">[${timestamp}] Running ${testType} test...</p>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            
            const startTime = Date.now();
            
            try {
                let endpoint = '';
                let testName = '';
                
                switch(testType) {
                    case 'connection':
                        endpoint = 'suppliers';
                        testName = 'Connection';
                        break;
                    case 'suppliers':
                        endpoint = 'suppliers';
                        testName = 'Suppliers';
                        break;
                    case 'items':
                        endpoint = 'items';
                        testName = 'Items';
                        break;
                    case 'customers':
                        endpoint = 'customers';
                        testName = 'Customers';
                        break;
                }
                
                const response = await fetch(`${API_URL}?action=get${endpoint.charAt(0).toUpperCase() + endpoint.slice(1)}`);
                const elapsed = Date.now() - startTime;
                
                if (response.ok) {
                    const data = await response.json();
                    const count = Array.isArray(data) ? data.length : (data.data ? data.data.length : 'N/A');
                    resultsDiv.innerHTML += `<p style="color: #4ade80;"> ${testName}: SUCCESS (${elapsed}ms) - ${count} records</p>`;
                } else {
                    resultsDiv.innerHTML += `<p style="color: #f87171;"> ${testName}: FAILED - Status ${response.status}</p>`;
                }
            } catch (error) {
                resultsDiv.innerHTML += `<p style="color: #f87171;"> ${testType}: ERROR - ${error.message}</p>`;
            }
            
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        async function runAllDiagnostics() {
            const resultsDiv = document.getElementById('diagResults');
            resultsDiv.innerHTML = `<p style="color: #b8a86b;"> Starting full diagnostic suite...</p>`;
            
            await runDiagnosticTest('connection');
            await new Promise(r => setTimeout(r, 300));
            await runDiagnosticTest('suppliers');
            await new Promise(r => setTimeout(r, 300));
            await runDiagnosticTest('items');
            await new Promise(r => setTimeout(r, 300));
            await runDiagnosticTest('customers');
            
            resultsDiv.innerHTML += `<p style="color: #4ade80; margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;"> Diagnostic complete!</p>`;
        }
        
        // ==================== QUICK VIEW ITEM MODAL ====================
        // For viewing item details within reports without navigating away
        
        let quickViewCurrentItemId = null;
        
        function openQuickViewItemModal(itemId) {
            const item = (cachedItems || []).find(i => i.Item_ID === itemId);
            if (!item) {
                showError('Item not found. Please refresh and try again.');
                return;
            }
            
            quickViewCurrentItemId = itemId;
            
            // Get supplier name
            const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === item.Supplier_ID);
            const supplierName = supplier ? supplier.Supplier_Name : item.Supplier_ID || 'N/A';
            
            // Calculate stock status
            const qtyOnHand = parseInt(item.Qty_On_Hand) || 0;
            const reorderPoint = parseInt(item.Reorder_Point) || 0;
            const onOrder = parseInt(item.Qty_On_Order) || 0;
            const backorder = parseInt(item.Qty_On_Backorder) || 0;
            
            let stockStatus = '', stockColor = '', stockBg = '';
            if (qtyOnHand < 0) {
                stockStatus = ' NEGATIVE'; stockColor = '#b88a8a'; stockBg = '#fef2f2';
            } else if (qtyOnHand === 0) {
                stockStatus = ' Out of Stock'; stockColor = '#b88a8a'; stockBg = '#fef2f2';
            } else if (qtyOnHand <= reorderPoint) {
                stockStatus = ' Low Stock'; stockColor = '#b8a86b'; stockBg = '#fffbeb';
            } else {
                stockStatus = ' In Stock'; stockColor = '#6b9a8d'; stockBg = '#f0fdf4';
            }
            
            // Populate header
            document.getElementById('quickViewItemSKU').textContent = item.SKU || item.Item_ID;
            
            // Build body content
            const bodyHtml = `
                <div style="margin-bottom: 20px;">
                    <h3 style="margin: 0 0 5px 0; color: #333; font-size: 18px;">${item.Item_Description || 'No Description'}</h3>
                    <p style="margin: 0; color: #666; font-size: 14px;">Supplier: ${supplierName}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <div style="background: ${stockBg}; padding: 15px; border-radius: 10px; text-align: center; border: 2px solid ${stockColor}20;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">On Hand</div>
                        <div style="font-size: 28px; font-weight: 700; color: ${stockColor};">${qtyOnHand}</div>
                        <div style="font-size: 11px; color: ${stockColor}; font-weight: 600;">${stockStatus}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Reorder Point</div>
                        <div style="font-size: 28px; font-weight: 700; color: #333;">${reorderPoint}</div>
                        <div style="font-size: 11px; color: #888;">Min level</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 11px; color: #666;">On Order</div>
                        <div style="font-size: 20px; font-weight: 700; color: #1976d2;">${onOrder}</div>
                    </div>
                    <div style="background: ${backorder > 0 ? '#fff3e0' : '#f8f9fa'}; padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 11px; color: #666;">Backorder</div>
                        <div style="font-size: 20px; font-weight: 700; color: ${backorder > 0 ? '#f57c00' : '#333'};">${backorder}</div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">Package Cost:</span>
                        <span style="font-weight: 600;">${formatMoney(parseFloat(item.Package_Cost) || 0)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">Sell Price:</span>
                        <span style="font-weight: 600;">${formatMoney(parseFloat(item.Sell_Price) || 0)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #666;">Units/Package:</span>
                        <span style="font-weight: 600;">${item.Units_Per_Package || 1}</span>
                    </div>
                </div>
            `;
            
            document.getElementById('quickViewItemBody').innerHTML = bodyHtml;
            
            // Show modal
            document.getElementById('quickViewItemModal').style.display = 'block';
            document.body.classList.add('modal-open');
        }
        
        function closeQuickViewItemModal() {
            document.getElementById('quickViewItemModal').style.display = 'none';
            document.body.classList.remove('modal-open');
            quickViewCurrentItemId = null;
        }
        
        function quickViewToAdjust() {
            if (quickViewCurrentItemId) {
                closeQuickViewItemModal();
                openQuickAdjustModal(quickViewCurrentItemId);
            }
        }
        
        function quickViewToCreatePO() {
            if (quickViewCurrentItemId) {
                const item = (cachedItems || []).find(i => i.Item_ID === quickViewCurrentItemId);
                closeQuickViewItemModal();
                closeReportSetup();
                switchTab('createpo');
                // Could pre-populate supplier here if desired
            }
        }
        
        // ==================== QUICK ADJUST INVENTORY MODAL ====================
        // For use within reports - doesn't close the report
        
        let quickAdjustCurrentQty = 0;
        
        async function openQuickAdjustModal(itemId) {
            // Show loading state
            showLoading('Loading item data...');
            
            // Fetch fresh item data to ensure we have current quantities
            try {
                const result = await apiCall('getItems');
                if (result && result.status === 'success') {
                    cachedItems = result.data;
                }
            } catch (e) {
                console.error('Error refreshing items:', e);
            }
            
            hideLoading();
            
            const item = (cachedItems || []).find(i => i.Item_ID === itemId);
            if (!item) {
                showError('Item not found. Please refresh and try again.');
                return;
            }
            
            // Populate modal with FRESH data
            document.getElementById('quickAdjustItemId').value = itemId;
            document.getElementById('quickAdjustItemName').textContent = `${item.SKU || item.Item_ID} - ${item.Item_Description}`;
            quickAdjustCurrentQty = parseInt(item.Qty_On_Hand) || 0;
            document.getElementById('quickAdjustCurrentQty').textContent = quickAdjustCurrentQty;
            document.getElementById('quickAdjustNewQty').textContent = quickAdjustCurrentQty;
            
            // Reset form
            document.getElementById('quickAdjustAmount').value = '';
            document.getElementById('quickAdjustReason').value = '';
            document.getElementById('quickAdjustNotes').value = '';
            document.getElementById('quickAdjustReasonDisplay').style.display = 'none';
            
            // Reset reason button styles
            document.querySelectorAll('.quick-reason-btn').forEach(btn => {
                btn.style.borderColor = '#ddd';
                btn.style.background = 'white';
            });
            
            // Show modal
            document.getElementById('quickAdjustModal').style.display = 'block';
            document.body.classList.add('modal-open');
            
            // Focus on amount input
            setTimeout(() => {
                document.getElementById('quickAdjustAmount').focus();
            }, 100);
        }
        
        function closeQuickAdjustModal() {
            document.getElementById('quickAdjustModal').style.display = 'none';
            document.body.classList.remove('modal-open');
        }
        
        function updateQuickAdjustPreview() {
            const adjustment = parseInt(document.getElementById('quickAdjustAmount').value) || 0;
            const newQty = quickAdjustCurrentQty + adjustment;
            const newQtyEl = document.getElementById('quickAdjustNewQty');
            newQtyEl.textContent = newQty;
            newQtyEl.style.color = newQty < 0 ? '#b88a8a' : '#6b9a8d';
        }
        
        function selectQuickReason(reason) {
            document.getElementById('quickAdjustReason').value = reason;
            document.getElementById('quickAdjustReasonDisplay').textContent = `Selected: ${reason}`;
            document.getElementById('quickAdjustReasonDisplay').style.display = 'block';
            document.getElementById('quickAdjustReasonDisplay').style.background = '#e8f5e9';
            document.getElementById('quickAdjustReasonDisplay').style.color = '#6b9a8d';
            
            // Update button styles
            document.querySelectorAll('.quick-reason-btn').forEach(btn => {
                btn.style.borderColor = '#ddd';
                btn.style.background = 'white';
            });
            event.target.style.borderColor = '#6b9a8d';
            event.target.style.background = '#e8f5e9';
        }
        
        async function submitQuickAdjustment() {
            const itemId = document.getElementById('quickAdjustItemId').value;
            const adjustment = parseInt(document.getElementById('quickAdjustAmount').value);
            const reason = document.getElementById('quickAdjustReason').value;
            const notes = document.getElementById('quickAdjustNotes').value;
            
            // Validation
            if (!itemId) {
                showWarning('Item not selected');
                return;
            }
            if (isNaN(adjustment) || adjustment === 0) {
                showWarning('Please enter an adjustment amount');
                document.getElementById('quickAdjustAmount').focus();
                return;
            }
            if (!reason) {
                showWarning('Please select a reason');
                return;
            }
            
            const newQty = quickAdjustCurrentQty + adjustment;
            const item = (cachedItems || []).find(i => i.Item_ID === itemId);
            
            // Confirm
            const confirmed = await showConfirmModal(
                'Confirm Adjustment',
                `Adjust <strong>${item.Item_Description}</strong>?<br><br>` +
                `Current: ${quickAdjustCurrentQty}<br>` +
                `Adjustment: ${adjustment > 0 ? '+' : ''}${adjustment}<br>` +
                `New Total: <strong>${newQty}</strong><br><br>` +
                `Reason: ${reason}`,
                'Adjust',
                'Cancel',
                'warning'
            );
            if (!confirmed) return;
            
            const data = {
                itemId: itemId,
                quantity: adjustment,
                adjustmentType: 'Manual',
                reason: reason + (notes ? ' - ' + notes : ''),
                user: 'Manual'
            };
            
            // Disable buttons during processing
            const submitBtn = document.getElementById('quickAdjustSubmitBtn');
            const cancelBtn = document.getElementById('quickAdjustCancelBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = ' Processing...';
            }
            if (cancelBtn) {
                cancelBtn.disabled = true;
                cancelBtn.style.opacity = '0.5';
                cancelBtn.style.cursor = 'not-allowed';
            }
            
            try {
                showLoading('Adjusting Inventory...');
                const result = await apiCall('adjustInventory', data);
                
                if (result && result.status === 'success') {
                    // Update cached items
                    const itemsResult = await apiCall('getItems');
                    if (itemsResult && itemsResult.status === 'success') {
                        cachedItems = itemsResult.data;
                    }
                    
                    closeQuickAdjustModal();
                    hideLoading();
                    showSuccessModal('Inventory Adjusted!', `${item.Item_Description}\n\n${quickAdjustCurrentQty}  ${newQty}`);
                    
                    // Refresh the current report if it's still open
                    reportDataCacheTime = null;  // Clear report cache
                    if (document.getElementById('reportSetupModal')?.style.display !== 'none') {
                        setTimeout(() => executeReport(), 100);
                    }
                } else {
                    hideLoading();
                    showError('Error: ' + (result?.message || 'Unknown error'));
                    // Re-enable buttons on error
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = ' Save Adjustment';
                    }
                    if (cancelBtn) {
                        cancelBtn.disabled = false;
                        cancelBtn.style.opacity = '1';
                        cancelBtn.style.cursor = 'pointer';
                    }
                }
            } catch (error) {
                hideLoading();
                showError('Error: ' + error.message);
                // Re-enable buttons on error
                const submitBtn = document.getElementById('quickAdjustSubmitBtn');
                const cancelBtn = document.getElementById('quickAdjustCancelBtn');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = ' Save Adjustment';
                }
                if (cancelBtn) {
                    cancelBtn.disabled = false;
                    cancelBtn.style.opacity = '1';
                    cancelBtn.style.cursor = 'pointer';
                }
            }
        }
        
        // ==================== TUTORIAL CONTENT ====================
        
        const tutorialContent = {
            // ===== SUPPLIER TUTORIALS =====
            'add-supplier': {
                title: 'How to Add a New Supplier',
                icon: '',
                category: 'Supplier Tasks',
                color: '#3b82f6',
                steps: [
                    { action: 'Navigate to Suppliers', detail: 'Click the <strong> Suppliers</strong> tab in the navigation bar.' },
                    { action: 'Click Add New', detail: 'Click the <strong>+ Add Supplier</strong> button in the top-right corner.' },
                    { action: 'Enter Supplier Name', detail: 'Type the supplier\'s company name (e.g., "Better Made Snack Foods").' },
                    { action: 'Add Contact Information', detail: 'Fill in contact name, phone number, and email address.' },
                    { action: 'Enter Address', detail: 'Add the supplier\'s street address, city, state, and ZIP code.' },
                    { action: 'Set Payment Terms', detail: 'Select payment terms from the dropdown (Net 30, Net 15, COD, etc.).' },
                    { action: 'Save', detail: 'Click <strong>Save Supplier</strong> to add them to your database.' }
                ],
                tips: ['Supplier ID is auto-generated (S001, S002, etc.)', 'You can add notes for special instructions or account numbers', 'Suppliers can be archived later if no longer used']
            },
            'edit-supplier': {
                title: 'How to Edit Supplier Information',
                icon: '',
                category: 'Supplier Tasks',
                color: '#3b82f6',
                steps: [
                    { action: 'Go to Suppliers', detail: 'Click the <strong> Suppliers</strong> tab.' },
                    { action: 'Find the Supplier', detail: 'Use the search box to find the supplier, or scroll through the list.' },
                    { action: 'Click Edit', detail: 'Click the <strong> Edit</strong> button on the supplier\'s row.' },
                    { action: 'Update Information', detail: 'Modify any fields that need updating (contact, phone, address, terms, etc.).' },
                    { action: 'Save Changes', detail: 'Click <strong>Save Changes</strong> to update the supplier record.' }
                ],
                tips: ['Changes take effect immediately', 'Existing POs are not affected by contact info changes', 'Use the Notes field to track important details']
            },
            'supplier-history': {
                title: 'How to View Supplier Purchase History',
                icon: '',
                category: 'Supplier Tasks',
                color: '#3b82f6',
                steps: [
                    { action: 'Go to Suppliers', detail: 'Click the <strong> Suppliers</strong> tab.' },
                    { action: 'Find the Supplier', detail: 'Locate the supplier you want to review.' },
                    { action: 'Click View', detail: 'Click the <strong> View</strong> button to see supplier details.' },
                    { action: 'Review Purchase History', detail: 'Scroll down to see all purchase orders placed with this supplier.' },
                    { action: 'Optional: Use Reports', detail: 'For more detail, go to <strong>Reports  Supplier Dashboard</strong> for analytics.' }
                ],
                tips: ['The Supplier Dashboard shows total spend and order frequency', 'You can filter by date range in reports', 'Click any PO number to see full details']
            },
            'archive-supplier': {
                title: 'How to Archive/Restore a Supplier',
                icon: '',
                category: 'Supplier Tasks',
                color: '#3b82f6',
                steps: [
                    { action: 'Go to Suppliers', detail: 'Click the <strong> Suppliers</strong> tab.' },
                    { action: 'Find the Supplier', detail: 'Locate the supplier you want to archive.' },
                    { action: 'Click Archive', detail: 'Click the <strong> Archive</strong> button (or find it in the Edit screen).' },
                    { action: 'Confirm', detail: 'Click <strong>Yes, Archive</strong> to confirm.' },
                    { action: 'To Restore', detail: 'Toggle "Show Archived" at the top, find the supplier, and click <strong>Restore</strong>.' }
                ],
                tips: ['Archived suppliers are hidden but not deleted', 'You cannot create new POs for archived suppliers', 'Historical data is preserved for reporting']
            },
            
            // ===== ITEM/PRODUCT TUTORIALS =====
            'add-item': {
                title: 'How to Add a New Item',
                icon: '',
                category: 'Item/Product Tasks',
                color: '#6b9a8d',
                steps: [
                    { action: 'Navigate to Items', detail: 'Click the <strong> Items</strong> tab in the navigation bar.' },
                    { action: 'Click Add New', detail: 'Click the <strong>+ Add Item</strong> button.' },
                    { action: 'Select Supplier', detail: 'Choose the supplier this item comes from (required).' },
                    { action: 'Enter SKU', detail: 'Add a unique product code/SKU (e.g., "BM-CHIPS-BBQ").' },
                    { action: 'Enter Description', detail: 'Type the item name/description (e.g., "BBQ Potato Chips 1oz").' },
                    { action: 'Set Package Cost', detail: 'Enter what you pay for one package from the supplier.' },
                    { action: 'Set Units Per Package', detail: 'How many sellable units come in one package (e.g., 24 bags per case).' },
                    { action: 'Set Sell Price', detail: 'Enter the price you charge customers per unit.' },
                    { action: 'Set Starting Inventory', detail: 'Enter current quantity on hand (can be 0).' },
                    { action: 'Set Reorder Point', detail: 'Set the low stock alert threshold.' },
                    { action: 'Save', detail: 'Click <strong>Save Item</strong> to add it to inventory.' }
                ],
                tips: ['Unit cost is auto-calculated: Package Cost  Units Per Package', 'Margin is auto-calculated from cost and sell price', 'SKUs should be unique and consistent for easy searching']
            },
            'update-pricing': {
                title: 'How to Update Item Pricing',
                icon: '',
                category: 'Item/Product Tasks',
                color: '#6b9a8d',
                steps: [
                    { action: 'Go to Items', detail: 'Click the <strong> Items</strong> tab.' },
                    { action: 'Find the Item', detail: 'Use search or filters to find the item.' },
                    { action: 'Click Edit', detail: 'Click the <strong> Edit</strong> button on the item row.' },
                    { action: 'Update Package Cost', detail: 'If supplier prices changed, update the package cost.' },
                    { action: 'Update Sell Price', detail: 'Adjust your selling price per unit as needed.' },
                    { action: 'Review Margin', detail: 'Check that the calculated margin is acceptable.' },
                    { action: 'Save Changes', detail: 'Click <strong>Save Changes</strong> to update pricing.' }
                ],
                tips: ['Use Price Simulator to test price changes before committing', 'Price changes affect new orders only, not existing ones', 'Consider competitor pricing and your target margin']
            },
            'set-reorder': {
                title: 'How to Set Reorder Points',
                icon: '',
                category: 'Item/Product Tasks',
                color: '#6b9a8d',
                steps: [
                    { action: 'Go to Items', detail: 'Click the <strong> Items</strong> tab.' },
                    { action: 'Find the Item', detail: 'Locate the item you want to set alerts for.' },
                    { action: 'Click Edit', detail: 'Click the <strong> Edit</strong> button.' },
                    { action: 'Set Reorder Point', detail: 'Enter the quantity that triggers a low stock alert (e.g., 50 units).' },
                    { action: 'Save', detail: 'Click <strong>Save Changes</strong>.' },
                    { action: 'Monitor', detail: 'Low stock items appear in the <strong>Action Dashboard</strong> and <strong>Inventory Flow Dashboard</strong>.' }
                ],
                tips: ['Set reorder point based on lead time and sales velocity', 'Consider: How many do you sell per week? How long does restock take?', 'Items below reorder point show a red warning badge']
            },
            'archive-item': {
                title: 'How to Archive Discontinued Items',
                icon: '',
                category: 'Item/Product Tasks',
                color: '#6b9a8d',
                steps: [
                    { action: 'Go to Items', detail: 'Click the <strong> Items</strong> tab.' },
                    { action: 'Find the Item', detail: 'Locate the discontinued item.' },
                    { action: 'Click Edit', detail: 'Click the <strong> Edit</strong> button.' },
                    { action: 'Change Status', detail: 'Change the Status dropdown from "Active" to "Archived".' },
                    { action: 'Save', detail: 'Click <strong>Save Changes</strong>.' }
                ],
                tips: ['Archived items are hidden from new orders but history is preserved', 'You can restore items by changing status back to Active', 'Consider selling remaining stock before archiving']
            },
            
            // ===== CUSTOMER TUTORIALS =====
            'add-customer': {
                title: 'How to Add a New Customer',
                icon: '',
                category: 'Customer Tasks',
                color: '#b8a86b',
                steps: [
                    { action: 'Navigate to Customers', detail: 'Click the <strong> Customers</strong> tab.' },
                    { action: 'Click Add New', detail: 'Click the <strong>+ Add Customer</strong> button.' },
                    { action: 'Enter Business Name', detail: 'Type the customer\'s business name.' },
                    { action: 'Add Contact Info', detail: 'Enter contact name, phone, and email.' },
                    { action: 'Enter Delivery Address', detail: 'Add the address where orders will be delivered.' },
                    { action: 'Set Payment Terms', detail: 'Choose payment terms (Net 30, Net 15, COD, etc.).' },
                    { action: 'Save', detail: 'Click <strong>Save Customer</strong> to add them.' }
                ],
                tips: ['Customer ID is auto-generated (C001, C002, etc.)', 'Delivery address is used on invoices and pick lists', 'You can add notes for delivery instructions']
            },
            'payment-terms': {
                title: 'How to Set Payment Terms',
                icon: '',
                category: 'Customer Tasks',
                color: '#b8a86b',
                steps: [
                    { action: 'Go to Customers', detail: 'Click the <strong> Customers</strong> tab.' },
                    { action: 'Find the Customer', detail: 'Locate the customer you want to update.' },
                    { action: 'Click Edit', detail: 'Click the <strong> Edit</strong> button.' },
                    { action: 'Update Payment Terms', detail: 'Select from: <strong>COD</strong> (Cash on Delivery), <strong>Net 15</strong>, <strong>Net 30</strong>, <strong>Net 45</strong>, <strong>Net 60</strong>.' },
                    { action: 'Save', detail: 'Click <strong>Save Changes</strong>.' }
                ],
                tips: ['Payment terms determine when invoices are due', 'Net 30 = payment due 30 days from invoice date', 'COD requires payment at time of delivery']
            },
            'customer-history': {
                title: 'How to View Customer Order History',
                icon: '',
                category: 'Customer Tasks',
                color: '#b8a86b',
                steps: [
                    { action: 'Go to Customers', detail: 'Click the <strong> Customers</strong> tab.' },
                    { action: 'Find the Customer', detail: 'Locate the customer.' },
                    { action: 'Click View', detail: 'Click the <strong> View</strong> button to see details.' },
                    { action: 'Review Order History', detail: 'Scroll down to see all past invoices and their status.' },
                    { action: 'Use Customer Dashboard', detail: 'For detailed analytics, go to <strong>Reports  Customer Dashboard</strong>.' }
                ],
                tips: ['Customer Dashboard shows buying patterns and trends', 'You can see total revenue and average order size', 'Click any invoice number to view full details']
            },
            'track-balances': {
                title: 'How to Track Outstanding Balances',
                icon: '',
                category: 'Customer Tasks',
                color: '#b8a86b',
                steps: [
                    { action: 'Go to Reports', detail: 'Click the <strong> Reports</strong> tab.' },
                    { action: 'Open Accounts Receivable', detail: 'Click <strong>Accounts Receivable Report</strong>.' },
                    { action: 'Review Balances', detail: 'See all customers with outstanding balances and aging.' },
                    { action: 'Filter if Needed', detail: 'Use filters to see only overdue invoices.' },
                    { action: 'Alternative: Action Dashboard', detail: 'The <strong>Action Dashboard</strong> also shows overdue invoices requiring attention.' }
                ],
                tips: ['AR Report shows aging buckets: Current, 1-30, 31-60, 60+ days', 'Red highlights indicate seriously overdue accounts', 'Click any invoice to record a payment']
            },
            
            // ===== PURCHASE ORDER TUTORIALS =====
            'create-po': {
                title: 'How to Create a Purchase Order',
                icon: '',
                category: 'Purchase Order Tasks',
                color: '#8b5cf6',
                steps: [
                    { action: 'Navigate to Create PO', detail: 'Click the <strong> Create PO</strong> tab.' },
                    { action: 'Select Supplier', detail: 'Choose the supplier from the dropdown. Their items will load automatically.' },
                    { action: 'Set Order Date', detail: 'Select the PO date (defaults to today).' },
                    { action: 'Add Items', detail: 'For each item you want to order, enter the quantity in the Qty field.' },
                    { action: 'Review Totals', detail: 'Check the line totals and PO total at the bottom.' },
                    { action: 'Add Notes (Optional)', detail: 'Add any special instructions in the Notes field.' },
                    { action: 'Submit PO', detail: 'Click <strong>Submit Purchase Order</strong> to create it.' }
                ],
                tips: ['Only items with quantity > 0 are included', 'PO numbers are auto-generated (PO-0001, etc.)', 'You can print or email the PO after creating it']
            },
            'receive-shipment': {
                title: 'How to Receive a Shipment (Full)',
                icon: '',
                category: 'Purchase Order Tasks',
                color: '#8b5cf6',
                steps: [
                    { action: 'Go to Purchases', detail: 'Click the <strong> Purchases</strong> tab.' },
                    { action: 'Find the PO', detail: 'Locate the purchase order (use search or scroll).' },
                    { action: 'Click View', detail: 'Click the <strong> View</strong> button to open PO details.' },
                    { action: 'Click Receive PO', detail: 'Click the <strong> Receive PO</strong> button.' },
                    { action: 'Confirm Full Receipt', detail: 'If you received everything, click <strong>Receive Full Shipment</strong>.' },
                    { action: 'Verify', detail: 'Inventory is automatically updated for all items on the PO.' }
                ],
                tips: ['Receiving updates inventory immediately', 'PO status changes from "Ordered" to "Received"', 'If items are missing, use Partial Receive instead']
            },
            'partial-receive': {
                title: 'How to Receive Partial Shipments',
                icon: '',
                category: 'Purchase Order Tasks',
                color: '#8b5cf6',
                steps: [
                    { action: 'Go to Purchases', detail: 'Click the <strong> Purchases</strong> tab.' },
                    { action: 'Find the PO', detail: 'Locate the purchase order.' },
                    { action: 'Click View', detail: 'Click <strong> View</strong> to open PO details.' },
                    { action: 'Click Receive PO', detail: 'Click the <strong> Receive PO</strong> button.' },
                    { action: 'Enter Received Quantities', detail: 'For each item, enter how many you actually received.' },
                    { action: 'Save Partial Receipt', detail: 'Click <strong>Save Partial Receipt</strong>.' },
                    { action: 'Repeat as Needed', detail: 'When more items arrive, repeat the process until fully received.' }
                ],
                tips: ['PO status shows "Partial" until fully received', 'Each partial receipt updates inventory', 'You can see Ordered vs Received quantities on the PO']
            },
            'pay-supplier': {
                title: 'How to Record Payment to Supplier',
                icon: '',
                category: 'Purchase Order Tasks',
                color: '#8b5cf6',
                steps: [
                    { action: 'Go to Purchases', detail: 'Click the <strong> Purchases</strong> tab.' },
                    { action: 'Find the PO', detail: 'Locate the purchase order you\'re paying.' },
                    { action: 'Click View', detail: 'Click <strong> View</strong> to open PO details.' },
                    { action: 'Click Record Payment', detail: 'Click the <strong> Record Payment</strong> button.' },
                    { action: 'Enter Amount', detail: 'Enter the payment amount (can be partial or full).' },
                    { action: 'Add Payment Date', detail: 'Select the date payment was made.' },
                    { action: 'Save Payment', detail: 'Click <strong>Save Payment</strong>.' }
                ],
                tips: ['Partial payments are supported', 'Payment status updates automatically (Unpaid  Partial  Paid)', 'Use Accounts Payable report to track what you owe']
            },
            'print-po': {
                title: 'How to Print/Email a PO',
                icon: '',
                category: 'Purchase Order Tasks',
                color: '#8b5cf6',
                steps: [
                    { action: 'Go to Purchases', detail: 'Click the <strong> Purchases</strong> tab.' },
                    { action: 'Find the PO', detail: 'Locate the purchase order.' },
                    { action: 'Click View', detail: 'Click <strong> View</strong> to open PO details.' },
                    { action: 'Click Print', detail: 'Click the <strong> Print PO</strong> button.' },
                    { action: 'Print or Save as PDF', detail: 'Use your browser\'s print dialog. Choose a printer or "Save as PDF".' },
                    { action: 'To Email', detail: 'Click <strong> Email</strong> to generate an email with the PO attached.' }
                ],
                tips: ['Print preview shows a clean, professional format', 'The current theme colors are used in the printout', 'You can email directly to the supplier if their email is on file']
            },
            
            // ===== SALES & INVOICE TUTORIALS =====
            'create-invoice': {
                title: 'How to Create a Sales Order/Invoice',
                icon: '',
                category: 'Sales & Invoice Tasks',
                color: '#ec4899',
                steps: [
                    { action: 'Navigate to Sales', detail: 'Click the <strong> Sales</strong> tab.' },
                    { action: 'Click Create Invoice', detail: 'Click the <strong>+ Create Invoice</strong> button.' },
                    { action: 'Select Customer', detail: 'Choose the customer from the dropdown.' },
                    { action: 'Set Invoice Date', detail: 'Select the date (defaults to today). Due date auto-calculates from payment terms.' },
                    { action: 'Add Items', detail: 'Use the item picker or dropdown to add products.' },
                    { action: 'Enter Quantities', detail: 'Set the quantity for each item.' },
                    { action: 'Review Totals', detail: 'Check line totals and invoice total.' },
                    { action: 'Save Invoice', detail: 'Click <strong>Save Invoice</strong> to create it.' }
                ],
                tips: ['Invoice numbers are auto-generated (INV-0001, etc.)', 'Inventory is automatically reduced when invoice is saved', 'You can add notes or special instructions']
            },
            'item-picker': {
                title: 'How to Use the Quick Item Picker',
                icon: '',
                category: 'Sales & Invoice Tasks',
                color: '#ec4899',
                steps: [
                    { action: 'Start Creating Invoice', detail: 'Begin a new invoice from the Sales tab.' },
                    { action: 'Click Quick Pick', detail: 'Click the <strong> Quick Pick</strong> button.' },
                    { action: 'Browse or Search', detail: 'Items are grouped by supplier. Use search to filter.' },
                    { action: 'Enter Quantities', detail: 'Type quantities directly in the picker grid.' },
                    { action: 'Click Add Selected', detail: 'Click <strong>Add Selected Items</strong> to add them to the invoice.' },
                    { action: 'Continue', detail: 'You can use the picker multiple times to add more items.' }
                ],
                tips: ['Quick picker shows current stock levels', 'Items with zero stock are highlighted', 'Great for quickly building large orders']
            },
            'print-invoice': {
                title: 'How to Print an Invoice',
                icon: '',
                category: 'Sales & Invoice Tasks',
                color: '#ec4899',
                steps: [
                    { action: 'Go to Sales', detail: 'Click the <strong> Sales</strong> tab.' },
                    { action: 'Find the Invoice', detail: 'Locate the invoice to print.' },
                    { action: 'Click View', detail: 'Click <strong> View</strong> to open invoice details.' },
                    { action: 'Click Print', detail: 'Click the <strong> Print Invoice</strong> button.' },
                    { action: 'Print or Save PDF', detail: 'In the print dialog, select your printer or "Save as PDF".' }
                ],
                tips: ['Invoice uses your current theme colors', 'Company info and customer address are included', 'PDF is great for emailing to customers']
            },
            'record-payment': {
                title: 'How to Record Customer Payment',
                icon: '',
                category: 'Sales & Invoice Tasks',
                color: '#ec4899',
                steps: [
                    { action: 'Go to Sales', detail: 'Click the <strong> Sales</strong> tab.' },
                    { action: 'Find the Invoice', detail: 'Locate the invoice being paid.' },
                    { action: 'Click View', detail: 'Click <strong> View</strong> to open invoice details.' },
                    { action: 'Click Record Payment', detail: 'Click the <strong> Record Payment</strong> button.' },
                    { action: 'Enter Amount', detail: 'Enter the payment amount received.' },
                    { action: 'Set Payment Date', detail: 'Select the date payment was received.' },
                    { action: 'Save Payment', detail: 'Click <strong>Save Payment</strong>.' }
                ],
                tips: ['Partial payments are supported', 'Status updates: Unpaid  Partial  Paid', 'Payment history is tracked for each invoice']
            },
            'pick-list': {
                title: 'How to Generate a Pick List',
                icon: '',
                category: 'Sales & Invoice Tasks',
                color: '#ec4899',
                steps: [
                    { action: 'Go to Reports', detail: 'Click the <strong> Reports</strong> tab.' },
                    { action: 'Click Pick List', detail: 'Find and click the <strong>Pick List Report</strong> button.' },
                    { action: 'Select Date Range', detail: 'Choose the dates for orders to include.' },
                    { action: 'Generate Report', detail: 'Click <strong>Generate</strong> to create the pick list.' },
                    { action: 'Print', detail: 'Click <strong> Print</strong> to print for warehouse use.' }
                ],
                tips: ['Pick list shows all items needed for pending deliveries', 'Items are grouped for efficient picking', 'Use this to prepare orders for delivery runs']
            },
            'dormant-customers': {
                title: 'How to Win Back Dormant Customers',
                icon: '',
                category: 'Sales & Invoice Tasks',
                color: '#b8a86b',
                steps: [
                    { action: 'Go to Reports', detail: 'Click the <strong> Reports</strong> tab.' },
                    { action: 'Find Sales Reports', detail: 'Look in the <strong>Sales Reports</strong> section.' },
                    { action: 'Click Dormant Customers', detail: 'Click the <strong> Dormant Customers</strong> report button.' },
                    { action: 'Set Dormancy Threshold', detail: 'Choose how long since last order (e.g., 30 days, 90 days).' },
                    { action: 'Choose Sort Order', detail: 'Sort by Most Dormant, City (for route planning), or Highest Value.' },
                    { action: 'Generate Report', detail: 'Click <strong>Generate</strong> to see your dormant customers.' },
                    { action: 'Review Customer Cards', detail: 'Each card shows contact info, address, buying history, and their last order items.' },
                    { action: 'Take Action', detail: 'Click <strong> New Order</strong> to start a new order for that customer.' }
                ],
                tips: [
                    'Review their last order items before calling - know what they typically buy',
                    'Sort by City to plan efficient in-person visit routes',
                    'High-value customers ($500+ lifetime) should be priority contacts',
                    'Check their order frequency - if they usually order every 14 days and it\'s been 45, they\'re 3x overdue!',
                    'Address and phone are included for sales calls or delivery visits'
                ]
            },
            
            // ===== INVENTORY TUTORIALS =====
            'view-inventory': {
                title: 'How to View Current Inventory Levels',
                icon: '',
                category: 'Inventory Tasks',
                color: '#64748b',
                steps: [
                    { action: 'Go to Inventory', detail: 'Click the <strong> Inventory</strong> tab.' },
                    { action: 'View All Items', detail: 'See all items with current quantities, values, and status.' },
                    { action: 'Use Search/Filter', detail: 'Search by name/SKU or filter by supplier.' },
                    { action: 'Check Status Colors', detail: '<span style="color: green;"></span> Green = Good stock, <span style="color: orange;"></span> Yellow = Low, <span style="color: red;"></span> Red = Critical/Out.' },
                    { action: 'View Details', detail: 'Click any item for detailed history and adjustments.' }
                ],
                tips: ['Total inventory value is shown at the top', 'Low stock items appear first when filtered', 'Click column headers to sort']
            },
            'adjust-inventory': {
                title: 'How to Make Manual Adjustments',
                icon: '',
                category: 'Inventory Tasks',
                color: '#64748b',
                steps: [
                    { action: 'Go to Inventory', detail: 'Click the <strong> Inventory</strong> tab.' },
                    { action: 'Find the Item', detail: 'Locate the item to adjust.' },
                    { action: 'Click Adjust', detail: 'Click the <strong></strong> or <strong>Adjust</strong> button.' },
                    { action: 'Enter Adjustment', detail: 'Enter the quantity change. Use negative for decreases (e.g., -5 for damage).' },
                    { action: 'Select Reason', detail: 'Choose a reason: Damage, Shrinkage, Count Correction, Return, Other.' },
                    { action: 'Add Notes', detail: 'Optionally add notes explaining the adjustment.' },
                    { action: 'Save', detail: 'Click <strong>Save Adjustment</strong>.' }
                ],
                tips: ['All adjustments are logged with timestamps', 'Use "Count Correction" after physical inventory counts', 'Audit trail is preserved for accountability']
            },
            'low-stock': {
                title: 'How to Track Low Stock Items',
                icon: '',
                category: 'Inventory Tasks',
                color: '#64748b',
                steps: [
                    { action: 'Check Action Dashboard', detail: 'Go to <strong>Reports  Action Dashboard</strong> to see items needing reorder.' },
                    { action: 'Or Use Inventory Tab', detail: 'Go to <strong>Inventory</strong> and look for red/yellow status indicators.' },
                    { action: 'Or Use Inventory Flow', detail: 'Go to <strong>Reports  Inventory Reports  Inventory Flow Dashboard</strong> for detailed alerts.' },
                    { action: 'Review Reorder Points', detail: 'Items below their reorder point are flagged.' },
                    { action: 'Create PO', detail: 'Click through to create a purchase order for needed items.' }
                ],
                tips: ['Set appropriate reorder points for each item', 'Consider lead time when setting reorder levels', 'Action Dashboard prioritizes what needs attention']
            },
            'inventory-flow': {
                title: 'How to Use Inventory Flow Dashboard',
                icon: '',
                category: 'Inventory Tasks',
                color: '#64748b',
                steps: [
                    { action: 'Go to Reports', detail: 'Click the <strong> Reports</strong> tab.' },
                    { action: 'Find Inventory Reports', detail: 'Scroll to the Inventory Reports section.' },
                    { action: 'Click Inventory Flow Dashboard', detail: 'Click the large <strong> Inventory Flow Dashboard</strong> button.' },
                    { action: 'Review Alerts', detail: 'See critical alerts, low stock warnings, and pending orders.' },
                    { action: 'Check Summary Metrics', detail: 'View total items, stock value, items on backorder, and pending POs.' },
                    { action: 'Take Action', detail: 'Click on any item or order to take action directly.' }
                ],
                tips: ['Dashboard refreshes when opened', 'Critical items are highlighted in red', 'Shows both inbound (POs) and outbound (sales) flow']
            }
        };
        
        function showTutorial(tutorialId) {
            const tutorial = tutorialContent[tutorialId];
            if (!tutorial) {
                showError('Tutorial not found');
                return;
            }
            
            // Build the tutorial HTML
            let stepsHtml = tutorial.steps.map((step, index) => `
                <div style="display: flex; gap: 15px; align-items: flex-start; margin-bottom: 20px;">
                    <div style="background: ${tutorial.color}; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; font-size: 16px;">${index + 1}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">${step.action}</div>
                        <div style="color: #6b7280; line-height: 1.5;">${step.detail}</div>
                    </div>
                </div>
            `).join('');
            
            let tipsHtml = tutorial.tips.map(tip => `
                <div style="display: flex; gap: 10px; align-items: flex-start; margin-bottom: 8px;">
                    <span style="color: ${tutorial.color};"></span>
                    <span style="color: #374151;">${tip}</span>
                </div>
            `).join('');
            
            const modalHtml = `
                <div id="tutorialModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10001; overflow-y: auto; padding: 20px 0;">
                    <div style="max-width: 700px; margin: 20px auto; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); overflow: hidden;">
                        <!-- Header -->
                        <div style="background: linear-gradient(135deg, ${tutorial.color} 0%, ${tutorial.color}dd 100%); color: white; padding: 25px 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">${tutorial.category}</div>
                                    <h2 style="margin: 0; font-size: 24px; display: flex; align-items: center; gap: 12px;">
                                        <span style="font-size: 32px;">${tutorial.icon}</span>
                                        ${tutorial.title}
                                    </h2>
                                </div>
                                <button onclick="closeTutorial()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;"></button>
                            </div>
                        </div>
                        
                        <!-- Steps -->
                        <div style="padding: 30px;">
                            <h3 style="margin: 0 0 25px 0; color: #1f2937; font-size: 18px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;"> Step-by-Step Instructions</h3>
                            ${stepsHtml}
                        </div>
                        
                        <!-- Tips -->
                        <div style="padding: 25px 30px; background: #f8fafc; border-top: 1px solid #e5e7eb;">
                            <h4 style="margin: 0 0 15px 0; color: #374151; font-size: 16px;"> Pro Tips</h4>
                            ${tipsHtml}
                        </div>
                        
                        <!-- Footer -->
                        <div style="padding: 20px 30px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <button onclick="closeTutorial()" style="background: #e5e7eb; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; color: #374151;">Close</button>
                            <button onclick="closeTutorial(); scrollToGuideSection('how-to');" style="background: ${tutorial.color}; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; color: white;"> Back to All Guides</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existing = document.getElementById('tutorialModal');
            if (existing) existing.remove();
            
            // Add new modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.body.style.overflow = 'hidden';
            
            // Close on backdrop click
            document.getElementById('tutorialModal').addEventListener('click', function(e) {
                if (e.target === this) closeTutorial();
            });
        }
        
        function closeTutorial() {
            const modal = document.getElementById('tutorialModal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }
        
        function showGuideSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.guide-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            const targetSection = document.getElementById('guide-' + sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // Update tab styles
            document.querySelectorAll('.guide-tab').forEach(tab => {
                tab.style.color = '#666';
                tab.style.borderBottom = '3px solid transparent';
                tab.style.background = 'none';
            });
            
            // Highlight active tab (find by checking onclick)
            document.querySelectorAll('.guide-tab').forEach(tab => {
                if (tab.onclick && tab.onclick.toString().includes(`'${sectionId}'`)) {
                    tab.style.color = '#667eea';
                    tab.style.borderBottom = '3px solid #667eea';
                    tab.style.background = 'white';
                }
            });
        }
        
        // Close guide modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('howToGuideModal');
            if (event.target === modal) {
                closeHowToGuide();
            }
        });
        
        // ==================== BULK IMPORT/EXPORT FUNCTIONS ====================
        
        // Store parsed items temporarily for commit
        let pendingItemsUpload = null;
        let pendingUploadMode = null;

        // Recalculate Qty_On_Order for all items based on pending POs
        async function recalculateOnOrder() {
            const confirmed = await showConfirmModal(
                'Recalculate On Order Quantities?',
                'This will recalculate On Order quantities for ALL items based on pending Purchase Orders.<br><br>' +
                'This fixes stale values that may not have been cleared when POs were received.<br><br>' +
                'Continue?',
                'Recalculate',
                'Cancel',
                'warning'
            );
            if (!confirmed) return;
            
            showLoading('Recalculating On Order quantities...');
            
            try {
                const result = await apiCall('recalculateQtyOnOrder');
                
                if (result && result.status === 'success') {
                    hideLoading();
                    showSuccess(result.message);
                    // Refresh items to show updated values
                    await loadItems();
                } else {
                    hideLoading();
                    showError('Error: ' + (result?.message || 'Unknown error'));
                }
            } catch (error) {
                hideLoading();
                showError('Error recalculating: ' + error.message);
            }
        }
        
        async function fixQtyOnOrderFromDashboard() {
            const confirmed = await showConfirmModal(
                'Fix Qty On Order?',
                'This will recalculate Qty On Order for all items based on pending Purchase Orders.<br><br>' +
                '<strong>Items shown above will be corrected to match their expected values.</strong><br><br>' +
                'Continue?',
                ' Fix Now',
                'Cancel',
                'warning'
            );
            if (!confirmed) return;
            
            showLoading('Fixing Qty On Order values...');
            
            try {
                const result = await apiCall('recalculateQtyOnOrder');
                
                if (result && result.status === 'success') {
                    hideLoading();
                    showSuccessModal(
                        'Qty On Order Fixed!',
                        `${result.updatedCount || 0} items were corrected.\n\nRefreshing dashboard...`,
                        async () => {
                            // Refresh items cache and re-run the report
                            await loadItems();
                            // Re-run the Action Dashboard to show updated status
                            showReport('action-dashboard');
                        }
                    );
                } else {
                    hideLoading();
                    showError('Error: ' + (result?.message || 'Unknown error'));
                }
            } catch (error) {
                hideLoading();
                showError('Error fixing: ' + error.message);
            }
        }

        async function downloadItemsReport() {
            if (!cachedItems || cachedItems.length === 0) {
                showWarning('No items to download. Please load items first.');
                return;
            }

            // Create printable HTML report
            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Nowak Distributing - Items Report - ${new Date().toLocaleDateString().replace(/\//g, '-')}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { text-align: center; color: #333; }
                        .important-notice {
                            background: #FFE4E1; /* Light pink background */
                            color: #8B0000; /* Dark red text for contrast */
                            padding: 20px 25px;
                            margin: 25px 0;
                            border-radius: 12px;
                            border-left: 6px solid #DC143C; /* Crimson left border */
                            box-shadow: 0 4px 15px rgba(220, 20, 60, 0.2);
                            font-size: 16px;
                            font-weight: 600;
                        }
                        .important-notice h2 {
                            margin: 0 0 12px 0;
                            font-size: 22px;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        .important-notice p {
                            margin: 8px 0;
                            line-height: 1.6;
                            font-size: 15px;
                        }
                        .important-notice ul {
                            margin: 12px 0;
                            padding-left: 25px;
                        }
                        .important-notice li {
                            margin: 6px 0;
                            line-height: 1.5;
                        }
                        .important-notice .highlight {
                            background: rgba(255, 255, 255, 0.2);
                            padding: 2px 8px;
                            border-radius: 4px;
                            font-weight: 700;
                        }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11px; }
                        th { background: #667eea; color: white; padding: 8px; text-align: left; border: 1px solid #ddd; }
                        td { padding: 6px; border: 1px solid #ddd; }
                        tr:nth-child(even) { background: #f9f9f9; }
                        .footer { margin-top: 30px; padding: 15px; background: #f0e8d0; border-left: 4px solid #b8a86b; }
                        .action-buttons { 
                            position: fixed; 
                            top: 10px; 
                            right: 10px; 
                            z-index: 1000; 
                            display: flex; 
                            gap: 10px; 
                        }
                        .action-btn { 
                            padding: 10px 20px; 
                            border: none; 
                            border-radius: 8px; 
                            cursor: pointer; 
                            font-size: 14px; 
                            font-weight: 600; 
                            transition: all 0.2s; 
                            box-shadow: 0 2px 8px rgba(0,0,0,0.15); 
                        }
                        .print-btn { 
                            background: #6b9a8d; 
                            color: white; 
                        }
                        .print-btn:hover { 
                            background: #218838; 
                            transform: translateY(-2px); 
                            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
                        }
                        .close-btn { 
                            background: #b88a8a; 
                            color: white; 
                        }
                        .close-btn:hover { 
                            background: #d32f2f; 
                            transform: translateY(-2px); 
                            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
                        }
                        @media print {
                            .action-buttons { display: none; }
                            .important-notice { 
                                page-break-inside: avoid; 
                                page-break-after: auto;
                            }
                        }
                    </style>
                </head>
                <body>
                    <!-- Action Buttons at Top -->
                    <div class="action-buttons">
                        <button class="action-btn print-btn" onclick="window.print()"> Print</button>
                        <button class="action-btn close-btn" onclick="window.close()"> Close</button>
                    </div>

                    <h1>Nowak Distributing - Items Report</h1>
                    <p style="text-align: center; color: #666;">Generated: ${new Date().toLocaleString()} | Total Items: ${cachedItems.length}</p>
                    
                    <!-- PROMINENT NOTICE AT TOP -->
                    <div class="important-notice">
                        <h2> CRITICAL: DO NOT MODIFY ITEM_ID COLUMN!</h2>
                        <p>When editing this report in Excel:</p>
                        <ul>
                            <li> <span class="highlight">DO</span> edit: Prices, Quantities, SKUs, Descriptions, etc.</li>
                            <li> <span class="highlight">DO NOT</span> edit: Item_ID column (first column)</li>
                            <li> <span class="highlight">DO NOT</span> delete: Item_ID column</li>
                            <li> <span class="highlight">DO NOT</span> change: Item_ID values</li>
                        </ul>
                        <p><strong> Item_ID is the SYSTEM KEY that matches rows to items in your database.</strong></p>
                        <p><strong> Changing Item_ID will cause data corruption!</strong></p>
                        <p style="margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(255,255,255,0.3);">
                            <strong>REMINDER:</strong> Click  Print  Save as PDF  Upload to ilovepdf.com/pdf_to_excel  Edit in Excel  Upload back
                        </p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Item_ID</th>
                                <th>SKU</th>
                                <th>Description</th>
                                <th>Supplier_ID</th>
                                <th>Cost</th>
                                <th>Sell_Price</th>
                                <th>Qty_On_Hand</th>
                                <th>Qty_On_Backorder</th>
                                <th>Reorder_Point</th>
                                <th>Package_Cost</th>
                                <th>Units_Per_Package</th>
                                <th>Qty_On_Order</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cachedItems.map(item => `
                                <tr>
                                    <td>${item.Item_ID || ''}</td>
                                    <td>${item.SKU || ''}</td>
                                    <td>${item.Item_Description || ''}</td>
                                    <td>${item.Supplier_ID || ''}</td>
                                    <td>${parseFloat(item.Cost || 0).toFixed(2)}</td>
                                    <td>${parseFloat(item.Sell_Price || 0).toFixed(2)}</td>
                                    <td>${parseInt(item.Qty_On_Hand || 0)}</td>
                                    <td>${parseInt(item.Qty_On_Backorder || 0)}</td>
                                    <td>${parseInt(item.Reorder_Point || 0)}</td>
                                    <td>${parseFloat(item.Package_Cost || 0).toFixed(2)}</td>
                                    <td>${parseInt(item.Units_Per_Package || 0)}</td>
                                    <td>${parseInt(item.Qty_On_Order || 0)}</td>
                                    <td>${item.Status || 'Active'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <h3>How to Use This Report:</h3>
                        <ol>
                            <li>Click <strong> Print</strong> button above and save as PDF</li>
                            <li>Upload PDF to <strong>ilovepdf.com/pdf_to_excel</strong></li>
                            <li>Download the Excel file</li>
                            <li>Edit prices, quantities, or other fields</li>
                            <li><strong>DO NOT modify Item_ID column!</strong></li>
                            <li>Upload back via the "Upload Items" button</li>
                        </ol>
                        <p><strong> Important:</strong> Always backup before uploading!</p>
                    </div>
                </body>
                </html>
            `;

            // Open in new window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            printWindow.focus();
        }

        function openUploadItemsModal() {
            document.getElementById('uploadItemsModal').style.display = 'block';
            document.getElementById('uploadItemsFile').value = '';
            document.getElementById('uploadItemsPreview').style.display = 'none';
            document.body.style.overflow = 'hidden';
        }

        function closeUploadItemsModal() {
            document.getElementById('uploadItemsModal').style.display = 'none';
            document.body.style.overflow = '';
            pendingItemsUpload = null;
            pendingUploadMode = null;
        }

        async function previewItemsUpload() {
            const fileInput = document.getElementById('uploadItemsFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showWarning('Please select a file to upload');
                return;
            }

            const uploadMode = document.querySelector('input[name="uploadMode"]:checked').value;
            
            try {
                showStatus('itemsStatus', ' Processing file and generating preview...', 'info');

                // Read and parse the file
                const uploadedItems = await parseUploadedFile(file);
                
                if (!uploadedItems || uploadedItems.length === 0) {
                    showWarning('No valid items found in file');
                    return;
                }

                // Store for later commit
                pendingItemsUpload = uploadedItems;
                pendingUploadMode = uploadMode;

                // Generate comparison report
                const comparison = compareItemsForPreview(uploadedItems, uploadMode);
                
                // Display preview
                displayPreviewReport(comparison);
                
                // Show the preview section
                document.getElementById('uploadItemsPreview').style.display = 'block';
                
                // Scroll to preview
                document.getElementById('uploadItemsPreview').scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                showStatus('itemsStatus', ' Preview generated - Review changes below', 'success');

            } catch (error) {
                showStatus('itemsStatus', ' Error processing file: ' + error.message, 'error');
            }
        }

        function compareItemsForPreview(uploadedItems, mode) {
            const existing = cachedItems || [];
            const comparison = {
                toAdd: [],
                toUpdate: [],
                noChange: [],
                notInUpload: []
            };

            // Create map of existing items by Item_ID
            const existingMap = {};
            existing.forEach(item => {
                if (item.Item_ID) {
                    existingMap[item.Item_ID] = item;
                }
            });

            // Compare uploaded items
            uploadedItems.forEach(uploadItem => {
                const itemId = uploadItem.Item_ID;
                
                // Check if this is a new item
                if (!itemId || itemId === 'NEW' || itemId === '' || !existingMap[itemId]) {
                    comparison.toAdd.push({
                        item: uploadItem,
                        isNew: true
                    });
                } else {
                    // Existing item - check for changes
                    const existingItem = existingMap[itemId];
                    const changes = detectChanges(existingItem, uploadItem);
                    
                    if (changes.length > 0) {
                        comparison.toUpdate.push({
                            itemId: itemId,
                            before: existingItem,
                            after: uploadItem,
                            changes: changes
                        });
                    } else {
                        comparison.noChange.push({
                            itemId: itemId,
                            item: existingItem
                        });
                    }
                    
                    // Mark as seen
                    existingMap[itemId].seen = true;
                }
            });

            // Find items not in upload (only matters for Full Refresh)
            if (mode === 'full-refresh') {
                existing.forEach(item => {
                    if (item.Item_ID && !item.seen) {
                        comparison.notInUpload.push(item);
                    }
                });
            }

            return comparison;
        }

        function detectChanges(before, after) {
            const changes = [];
            const fieldsToCheck = [
                { key: 'SKU', label: 'SKU' },
                { key: 'Item_Description', label: 'Description' },
                { key: 'Supplier_ID', label: 'Supplier' },
                { key: 'Cost', label: 'Cost', isNumber: true },
                { key: 'Sell_Price', label: 'Sell Price', isNumber: true },
                { key: 'Qty_On_Hand', label: 'Qty On Hand', isNumber: true },
                { key: 'Reorder_Point', label: 'Reorder Point', isNumber: true },
                { key: 'Package_Cost', label: 'Package Cost', isNumber: true },
                { key: 'Units_Per_Package', label: 'Units/Package', isNumber: true },
                { key: 'Qty_On_Order', label: 'Qty On Order', isNumber: true },
                { key: 'Status', label: 'Status' }
            ];

            fieldsToCheck.forEach(field => {
                let beforeVal = before[field.key];
                let afterVal = after[field.key];

                // Normalize for comparison
                if (field.isNumber) {
                    beforeVal = parseFloat(beforeVal) || 0;
                    afterVal = parseFloat(afterVal) || 0;
                } else {
                    beforeVal = String(beforeVal || '').trim();
                    afterVal = String(afterVal || '').trim();
                }

                if (beforeVal !== afterVal) {
                    changes.push({
                        field: field.label,
                        before: beforeVal,
                        after: afterVal
                    });
                }
            });

            return changes;
        }

        function displayPreviewReport(comparison) {
            // Summary stats
            const summaryHtml = `
                <div style="padding: 12px; background: #e8f5e9; border-radius: 6px; text-align: center; border-left: 4px solid #6b9a8d;">
                    <div style="font-size: 20px; font-weight: bold; color: #2e7d32;">${comparison.toAdd.length}</div>
                    <div style="font-size: 11px; color: #666;">To Add</div>
                </div>
                <div style="padding: 12px; background: #fff3e0; border-radius: 6px; text-align: center; border-left: 4px solid #b8a86b;">
                    <div style="font-size: 20px; font-weight: bold; color: #e65100;">${comparison.toUpdate.length}</div>
                    <div style="font-size: 11px; color: #666;">To Update</div>
                </div>
                ${pendingUploadMode === 'full-refresh' ? `
                <div style="padding: 12px; background: #ffebee; border-radius: 6px; text-align: center; border-left: 4px solid #b88a8a;">
                    <div style="font-size: 20px; font-weight: bold; color: #c62828;">${comparison.notInUpload.length}</div>
                    <div style="font-size: 11px; color: #666;">To Delete</div>
                </div>
                ` : ''}
                <div style="padding: 12px; background: #f5f5f5; border-radius: 6px; text-align: center; border-left: 4px solid #a8a8a8;">
                    <div style="font-size: 20px; font-weight: bold; color: #616161;">${comparison.noChange.length}</div>
                    <div style="font-size: 11px; color: #666;">No Change</div>
                </div>
            `;
            document.getElementById('uploadItemsSummary').innerHTML = summaryHtml;

            // Detailed changes
            let detailHtml = '';

            // Items to ADD
            if (comparison.toAdd.length > 0) {
                detailHtml += `<div style="margin-bottom: 15px;"><h4 style="background: #6b9a8d; color: white; padding: 8px; border-radius: 6px 6px 0 0; margin: 0;"> ${comparison.toAdd.length} Items to ADD</h4><div style="background: white; padding: 12px; border: 2px solid #6b9a8d; border-radius: 0 0 6px 6px;">`;
                
                comparison.toAdd.slice(0, 10).forEach(entry => {
                    const item = entry.item;
                    detailHtml += `<div style="padding: 8px; margin-bottom: 8px; background: #e8f5e9; border-radius: 4px; border-left: 4px solid #6b9a8d; font-size: 12px;"><strong>${item.SKU || 'No SKU'}</strong> - ${item.Item_Description || 'No Description'} | Cost: ${formatMoney(parseFloat(item.Cost || 0))} | Sell: ${formatMoney(parseFloat(item.Sell_Price || 0))}</div>`;
                });
                
                if (comparison.toAdd.length > 10) {
                    detailHtml += `<div style="padding: 8px; color: #666; font-size: 12px;">...and ${comparison.toAdd.length - 10} more</div>`;
                }
                
                detailHtml += `</div></div>`;
            }

            // Items to UPDATE
            if (comparison.toUpdate.length > 0) {
                detailHtml += `<div style="margin-bottom: 15px;"><h4 style="background: #b8a86b; color: white; padding: 8px; border-radius: 6px 6px 0 0; margin: 0;"> ${comparison.toUpdate.length} Items to UPDATE</h4><div style="background: white; padding: 12px; border: 2px solid #b8a86b; border-radius: 0 0 6px 6px;">`;
                
                comparison.toUpdate.slice(0, 10).forEach(entry => {
                    detailHtml += `<div style="padding: 8px; margin-bottom: 10px; background: #fff3e0; border-radius: 4px; border-left: 4px solid #b8a86b; font-size: 12px;"><strong>${entry.before.SKU || entry.itemId}</strong> - ${entry.before.Item_Description || 'No Description'}<br>${entry.changes.map(c => `<span style="color: #e65100;">${c.field}:</span> <span style="text-decoration: line-through;">${c.before}</span>  <strong>${c.after}</strong>`).join(' | ')}</div>`;
                });
                
                if (comparison.toUpdate.length > 10) {
                    detailHtml += `<div style="padding: 8px; color: #666; font-size: 12px;">...and ${comparison.toUpdate.length - 10} more</div>`;
                }
                
                detailHtml += `</div></div>`;
            }

            // Items to DELETE (Full Refresh only)
            if (pendingUploadMode === 'full-refresh' && comparison.notInUpload.length > 0) {
                detailHtml += `<div style="margin-bottom: 15px;"><h4 style="background: #b88a8a; color: white; padding: 8px; border-radius: 6px 6px 0 0; margin: 0;"> ${comparison.notInUpload.length} Items to DELETE</h4><div style="background: white; padding: 12px; border: 2px solid #b88a8a; border-radius: 0 0 6px 6px;">`;
                
                comparison.notInUpload.slice(0, 20).forEach(item => {
                    detailHtml += `<div style="padding: 6px; margin-bottom: 6px; background: #ffebee; border-radius: 4px; border-left: 4px solid #b88a8a; font-size: 12px;"><strong>${item.SKU || item.Item_ID}</strong> - ${item.Item_Description || 'No Description'}</div>`;
                });
                
                if (comparison.notInUpload.length > 20) {
                    detailHtml += `<div style="padding: 8px; color: #666; font-size: 12px;">...and ${comparison.notInUpload.length - 20} more</div>`;
                }
                
                detailHtml += `</div></div>`;
            }

            document.getElementById('uploadItemsPreviewContent').innerHTML = detailHtml || '<p>No changes detected</p>';
        }

        async function commitItemsUpload() {
            if (!pendingItemsUpload) {
                showWarning('No upload pending');
                return;
            }

            // Final confirmation for Full Refresh
            if (pendingUploadMode === 'full-refresh') {
                const confirmed = await showConfirmModal(
                    ' FINAL CONFIRMATION',
                    `<div style="color: #b88a8a; font-weight: 600;">This will DELETE ALL existing items and replace with the uploaded file.</div><br>` +
                    `Are you ABSOLUTELY SURE?`,
                    'Yes, Replace All',
                    'Cancel',
                    'danger'
                );
                if (!confirmed) return;
                
                const finalConfirm = prompt('Type YES (in capital letters) to proceed with FULL REFRESH:');
                if (finalConfirm !== 'YES') {
                    showInfo('Upload cancelled');
                    return;
                }
            }

            try {
                showStatus('itemsStatus', ' Committing changes to database...', 'info');

                // Send to backend
                const result = await apiCall('bulkUpdateItems', {
                    items: pendingItemsUpload,
                    mode: pendingUploadMode
                });

                if (result && result.status === 'success') {
                    showStatus('itemsStatus', ` Upload complete! ${result.added || 0} added, ${result.updated || 0} updated, ${result.deleted || 0} deleted`, 'success');
                    
                    // Clear pending upload
                    pendingItemsUpload = null;
                    pendingUploadMode = null;
                    
                    closeUploadItemsModal();
                    await loadItems();
                } else {
                    showStatus('itemsStatus', ' Upload failed: ' + (result?.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                showStatus('itemsStatus', ' Error committing changes: ' + error.message, 'error');
            }
        }

        function cancelPreview() {
            // Clear pending upload
            pendingItemsUpload = null;
            pendingUploadMode = null;
            
            // Hide preview
            document.getElementById('uploadItemsPreview').style.display = 'none';
            
            // Reset file input
            document.getElementById('uploadItemsFile').value = '';
            
            showStatus('itemsStatus', 'Upload cancelled', 'info');
        }

        async function parseUploadedFile(file) {
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.csv')) {
                // Parse CSV
                const text = await file.text();
                return parseCSV(text);
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                // Parse Excel
                await loadSheetJS();
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                // Normalize column names
                return jsonData.map(row => ({
                    Item_ID: row.Item_ID || row.item_id || '',
                    SKU: row.SKU || row.sku || '',
                    Item_Description: row.Item_Description || row.Description || row.description || '',
                    Supplier_ID: row.Supplier_ID || row.supplier_id || '',
                    Cost: parseFloat(row.Cost || row.cost || 0),
                    Sell_Price: parseFloat(row.Sell_Price || row.Unit_Sell_Price || row.sell_price || 0),
                    Qty_On_Hand: parseInt(row.Qty_On_Hand || row.qty_on_hand || 0),
                    Reorder_Point: parseInt(row.Reorder_Point || row.reorder_point || 0),
                    Package_Cost: parseFloat(row.Package_Cost || row.package_cost || 0),
                    Units_Per_Package: parseInt(row.Units_Per_Package || row.units_per_package || 0),
                    Qty_On_Order: parseInt(row.Qty_On_Order || row.qty_on_order || 0),
                    Status: row.Status || row.status || 'Active'
                }));
            } else {
                throw new Error('Unsupported file type. Please use .xlsx, .xls, or .csv');
            }
        }

        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const items = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const item = {};
                
                headers.forEach((header, index) => {
                    item[header] = values[index] || '';
                });
                
                // Normalize column names
                items.push({
                    Item_ID: item.Item_ID || item.item_id || '',
                    SKU: item.SKU || item.sku || '',
                    Item_Description: item.Item_Description || item.Description || '',
                    Supplier_ID: item.Supplier_ID || item.supplier_id || '',
                    Cost: parseFloat(item.Cost || item.cost || 0),
                    Sell_Price: parseFloat(item.Sell_Price || item.Unit_Sell_Price || 0),
                    Qty_On_Hand: parseInt(item.Qty_On_Hand || 0),
                    Reorder_Point: parseInt(item.Reorder_Point || 0),
                    Package_Cost: parseFloat(item.Package_Cost || 0),
                    Units_Per_Package: parseInt(item.Units_Per_Package || 0),
                    Qty_On_Order: parseInt(item.Qty_On_Order || 0),
                    Status: item.Status || 'Active'
                });
            }
            
            return items;
        }

        function loadSheetJS() {
            return new Promise((resolve, reject) => {
                if (window.XLSX) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // ==================== DESKTOP MODAL DRAG & RESIZE ====================
        // Make modals draggable and resizable on desktop only
        // Supports resize from ALL edges and corners like a real desktop window
        
        function initDesktopModalFeatures() {
            // Only enable on desktop (screen width > 768px)
            if (window.innerWidth <= 768) return;
            
            // Find all modals with inner containers
            const modals = [
                { overlay: document.getElementById('orderModal'), container: document.querySelector('#orderModal > div') },
                { overlay: document.getElementById('reportSetupModal'), container: document.querySelector('#reportSetupModal > div') },
                { overlay: document.getElementById('howToGuideModal'), container: document.querySelector('#howToGuideModal > div') },
                { overlay: document.getElementById('uploadItemsModal'), container: document.querySelector('#uploadItemsModal > div') },
                { overlay: document.getElementById('itemPickerModal'), container: document.querySelector('#itemPickerModal .item-picker-container') }
            ];
            
            modals.forEach(modal => {
                if (!modal.overlay || !modal.container) return;
                
                // Add resize handles if not already added
                if (!modal.container.classList.contains('resize-handles-added')) {
                    modal.container.style.position = 'relative';
                    modal.container.style.minWidth = '400px';
                    modal.container.style.minHeight = '300px';
                    modal.container.style.resize = 'none'; // Disable default resize, we use custom handles
                    modal.container.classList.add('resize-handles-added');
                    
                    // Create resize handles for all edges and corners
                    const handles = [
                        { name: 'n', cursor: 'ns-resize', style: 'top: -5px; left: 10px; right: 10px; height: 10px;' },
                        { name: 's', cursor: 'ns-resize', style: 'bottom: -5px; left: 10px; right: 10px; height: 10px;' },
                        { name: 'e', cursor: 'ew-resize', style: 'right: -5px; top: 10px; bottom: 10px; width: 10px;' },
                        { name: 'w', cursor: 'ew-resize', style: 'left: -5px; top: 10px; bottom: 10px; width: 10px;' },
                        { name: 'ne', cursor: 'nesw-resize', style: 'top: -5px; right: -5px; width: 15px; height: 15px;' },
                        { name: 'nw', cursor: 'nwse-resize', style: 'top: -5px; left: -5px; width: 15px; height: 15px;' },
                        { name: 'se', cursor: 'nwse-resize', style: 'bottom: -5px; right: -5px; width: 15px; height: 15px;' },
                        { name: 'sw', cursor: 'nesw-resize', style: 'bottom: -5px; left: -5px; width: 15px; height: 15px;' }
                    ];
                    
                    handles.forEach(h => {
                        const handle = document.createElement('div');
                        handle.className = 'modal-resize-handle modal-resize-' + h.name;
                        handle.style.cssText = 'position: absolute; z-index: 10001; ' + h.style;
                        handle.style.cursor = h.cursor;
                        handle.dataset.resize = h.name;
                        modal.container.appendChild(handle);
                    });
                    
                    // Setup resize functionality
                    setupModalResize(modal.container, modal.overlay);
                }
                
                // Find header for dragging
                const header = modal.container.querySelector('[id*="Header"], .item-picker-header, h2');
                if (!header || header.classList.contains('draggable-added')) return;
                
                header.style.cursor = 'move';
                header.style.userSelect = 'none';
                header.classList.add('draggable-added');
                
                let isDragging = false;
                let initialX;
                let initialY;
                let xOffset = 0;
                let yOffset = 0;
                
                header.addEventListener('mousedown', dragStart);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', dragEnd);
                
                function dragStart(e) {
                    // Don't drag if clicking on a button or input
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                    
                    if (e.target === header || header.contains(e.target)) {
                        isDragging = true;
                        
                        // Get current position
                        const rect = modal.container.getBoundingClientRect();
                        
                        // Add class to override CSS centering and enable dragging
                        modal.container.classList.add('modal-dragged');
                        
                        // Set fixed positioning with current visual position - use setProperty with !important
                        modal.container.style.setProperty('position', 'fixed', 'important');
                        modal.container.style.setProperty('margin', '0', 'important');
                        modal.container.style.setProperty('left', rect.left + 'px', 'important');
                        modal.container.style.setProperty('top', rect.top + 'px', 'important');
                        modal.container.style.setProperty('width', rect.width + 'px', 'important');
                        modal.container.style.setProperty('height', rect.height + 'px', 'important');
                        
                        // Set offsets from current position
                        xOffset = rect.left;
                        yOffset = rect.top;
                        
                        initialX = e.clientX;
                        initialY = e.clientY;
                    }
                }
                
                function drag(e) {
                    if (isDragging) {
                        e.preventDefault();
                        
                        // Calculate new position
                        const deltaX = e.clientX - initialX;
                        const deltaY = e.clientY - initialY;
                        
                        let newLeft = xOffset + deltaX;
                        let newTop = yOffset + deltaY;
                        
                        // Get modal dimensions
                        const rect = modal.container.getBoundingClientRect();
                        const modalWidth = rect.width;
                        const modalHeight = rect.height;
                        
                        // STRICT constraints - keep modal mostly visible on screen
                        const maxOffscreenX = modalWidth * 0.2;
                        const minLeft = -maxOffscreenX;
                        const maxLeft = window.innerWidth - modalWidth + maxOffscreenX;
                        const minTop = 0;
                        const maxTop = window.innerHeight - 100;
                        
                        // Apply constraints
                        newLeft = Math.max(minLeft, Math.min(newLeft, maxLeft));
                        newTop = Math.max(minTop, Math.min(newTop, maxTop));
                        
                        // Apply position with !important to override CSS
                        modal.container.style.setProperty('left', newLeft + 'px', 'important');
                        modal.container.style.setProperty('top', newTop + 'px', 'important');
                    }
                }
                
                function dragEnd(e) {
                    if (isDragging) {
                        // Update offsets for next drag
                        xOffset = parseInt(modal.container.style.left) || 0;
                        yOffset = parseInt(modal.container.style.top) || 0;
                        
                        // Save position to localStorage for this modal
                        saveModalPosition(modal.container, modal.overlay);
                    }
                    isDragging = false;
                }
            });
        }
        
        // Setup resize functionality for a modal
        function setupModalResize(container, overlay) {
            let isResizing = false;
            let currentHandle = null;
            let startX, startY, startWidth, startHeight, startLeft, startTop;
            
            const handles = container.querySelectorAll('.modal-resize-handle');
            
            handles.forEach(handle => {
                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    isResizing = true;
                    currentHandle = handle.dataset.resize;
                    
                    const rect = container.getBoundingClientRect();
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = rect.width;
                    startHeight = rect.height;
                    startLeft = rect.left;
                    startTop = rect.top;
                    
                    // Ensure modal is in fixed position mode
                    container.classList.add('modal-dragged');
                    container.style.setProperty('position', 'fixed', 'important');
                    container.style.setProperty('margin', '0', 'important');
                    container.style.setProperty('left', startLeft + 'px', 'important');
                    container.style.setProperty('top', startTop + 'px', 'important');
                    container.style.setProperty('width', startWidth + 'px', 'important');
                    container.style.setProperty('height', startHeight + 'px', 'important');
                    
                    document.addEventListener('mousemove', handleResize);
                    document.addEventListener('mouseup', stopResize);
                });
            });
            
            function handleResize(e) {
                if (!isResizing) return;
                
                e.preventDefault();
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                let newWidth = startWidth;
                let newHeight = startHeight;
                let newLeft = startLeft;
                let newTop = startTop;
                
                const minWidth = 300;
                const minHeight = 200;
                
                // Handle each resize direction - NO restrictive max limits
                if (currentHandle.includes('e')) {
                    newWidth = Math.max(minWidth, startWidth + deltaX);
                }
                if (currentHandle.includes('w')) {
                    const possibleWidth = startWidth - deltaX;
                    if (possibleWidth >= minWidth) {
                        newWidth = possibleWidth;
                        newLeft = startLeft + deltaX;
                    }
                }
                if (currentHandle.includes('s')) {
                    newHeight = Math.max(minHeight, startHeight + deltaY);
                }
                if (currentHandle.includes('n')) {
                    const possibleHeight = startHeight - deltaY;
                    if (possibleHeight >= minHeight) {
                        newHeight = possibleHeight;
                        newTop = startTop + deltaY;
                    }
                }
                
                // Only constraint: keep top edge on screen (so you can still grab it)
                newTop = Math.max(0, newTop);
                
                // Apply new size and position
                container.style.setProperty('width', newWidth + 'px', 'important');
                container.style.setProperty('height', newHeight + 'px', 'important');
                container.style.setProperty('left', newLeft + 'px', 'important');
                container.style.setProperty('top', newTop + 'px', 'important');
            }
            
            function stopResize() {
                if (isResizing) {
                    saveModalPosition(container, overlay);
                }
                isResizing = false;
                currentHandle = null;
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
            }
        }
        
        // Save modal position and size to localStorage
        function saveModalPosition(container, overlay) {
            const modalId = container.id || overlay.id + '_inner';
            const savedPositions = JSON.parse(localStorage.getItem('modalPositions') || '{}');
            savedPositions[modalId] = {
                left: parseInt(container.style.left) || 0,
                top: parseInt(container.style.top) || 0,
                width: parseInt(container.style.width) || null,
                height: parseInt(container.style.height) || null
            };
            localStorage.setItem('modalPositions', JSON.stringify(savedPositions));
        }
        
        // Restore saved modal position when modal opens
        function restoreModalPosition(modalContainer) {
            if (window.innerWidth <= 768) return; // Skip on mobile
            
            const modalId = modalContainer.id;
            const savedPositions = JSON.parse(localStorage.getItem('modalPositions') || '{}');
            const saved = savedPositions[modalId];
            
            if (saved && saved.left !== null && saved.top !== null) {
                // Validate position is still on screen
                const maxLeft = window.innerWidth - 100;
                const maxTop = window.innerHeight - 100;
                
                if (saved.left >= -100 && saved.left <= maxLeft && saved.top >= 0 && saved.top <= maxTop) {
                    modalContainer.classList.add('modal-dragged');
                    modalContainer.style.setProperty('position', 'fixed', 'important');
                    modalContainer.style.setProperty('margin', '0', 'important');
                    modalContainer.style.setProperty('left', saved.left + 'px', 'important');
                    modalContainer.style.setProperty('top', saved.top + 'px', 'important');
                    if (saved.width) modalContainer.style.setProperty('width', saved.width + 'px', 'important');
                    if (saved.height) modalContainer.style.setProperty('height', saved.height + 'px', 'important');
                    return true;
                }
            }
            return false;
        }
        
        // Initialize on page load
        window.addEventListener('load', initDesktopModalFeatures);
        
        // Re-initialize when modals are opened and restore positions
        const originalDisplaySetters = {};
        ['orderModal', 'reportSetupModal', 'howToGuideModal', 'uploadItemsModal', 'itemPickerModal'].forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal) {
                // Watch for display changes
                const observer = new MutationObserver(() => {
                    if (modal.style.display !== 'none') {
                        // Try to restore saved position
                        const innerModal = modal.querySelector('[id*="Inner"], [id*="inner"], .item-picker-container') || modal.querySelector(':scope > div');
                        if (innerModal) {
                            setTimeout(() => {
                                restoreModalPosition(innerModal);
                                initDesktopModalFeatures();
                            }, 50);
                        } else {
                            setTimeout(initDesktopModalFeatures, 100);
                        }
                    }
                });
                observer.observe(modal, { attributes: true, attributeFilter: ['style'] });
            }
        });
    </script>
</body>
</html>
