<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Nowak Distributing - Inventory Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            margin: 0;
            /* Minimal pull-to-refresh prevention */
            overscroll-behavior-y: contain;
        }
        
        html {
            /* Allow normal scrolling */
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .tab.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
            /* Contain content in landscape mode */
            overflow-x: auto;
            max-width: 100%;
        }

        .card.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Table wrapper for horizontal scroll on mobile landscape */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 20px 0;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
        }

        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-small {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            margin-right: 5px;
            transition: all 0.2s;
        }
        
        .btn-small:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: transparent;
            color: #dc3545;
            border: 1px solid #dc3545;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .btn-danger:hover {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete-icon {
            background: transparent;
            color: #999;
            border: none;
            padding: 4px 8px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .btn-delete-icon:hover {
            background: #ffebee;
            color: #dc3545;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background: #f8f9ff;
            font-weight: 600;
            color: #667eea;
        }

        .data-table tr:hover {
            background: #f8f9ff;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .line-items-container {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .line-item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 50px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .config-box {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        /* ==================== MOBILE RESPONSIVE STYLES ==================== */
        
        /* Tablets and smaller (768px and below) */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .tabs {
                gap: 5px;
            }
            
            .tab {
                padding: 10px 16px;
                font-size: 14px;
                flex: 1 1 auto;
            }
            
            .card {
                padding: 15px;
                border-radius: 12px;
            }
            
            /* Stack form fields vertically on mobile */
            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 15px;
            }
            
            /* Make line items stack vertically */
            .line-item-row {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }
            
            .line-item-row select,
            .line-item-row input {
                width: 100%;
            }
            
            .remove-btn {
                width: 100%;
                padding: 12px;
            }
            
            /* Make tables scrollable horizontally */
            .data-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px;
                font-size: 14px;
            }
            
            /* Stack buttons vertically */
            .btn {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .btn-small {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
        
        /* Phones (480px and below) */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .card {
                padding: 10px;
            }
            
            .form-group label {
                font-size: 14px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 10px;
            }
            
            /* Make table text smaller on very small screens */
            .data-table th,
            .data-table td {
                padding: 6px;
                font-size: 12px;
            }
            
            /* Smaller buttons on very small screens */
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
        
        /* Landscape orientation on mobile devices */
        @media (max-height: 600px) and (orientation: landscape) {
            body {
                padding: 5px;
                height: 100vh;
            }
            
            .container {
                max-width: 100%;
                padding: 0 5px;
            }
            
            .header {
                margin-bottom: 10px;
            }
            
            .header h1 {
                font-size: 1.3em;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 0.9em;
            }
            
            .tabs {
                margin-bottom: 10px;
                gap: 3px;
            }
            
            .tab {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .card {
                padding: 10px;
                max-height: calc(100vh - 120px);
                overflow-y: auto;
            }
            
            /* Make tables scroll horizontally in landscape */
            .data-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
                max-width: 100%;
            }
            
            .data-table th,
            .data-table td {
                padding: 6px 8px;
                font-size: 11px;
            }
            
            /* Compact form fields in landscape */
            .form-group {
                margin-bottom: 8px;
            }
            
            .form-group label {
                font-size: 12px;
                margin-bottom: 3px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 6px;
                font-size: 14px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .btn-small {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            /* Reduce spacing in landscape */
            .form-grid {
                gap: 8px;
            }
        }
        
        /* ==================== COMPLETE THEME SYSTEM ==================== */
        
        /* Ocean Blue Theme */
        body.theme-ocean {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
        }
        body.theme-ocean .btn,
        body.theme-ocean .btn-small {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
        }
        body.theme-ocean .btn-success {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%) !important;
        }
        body.theme-ocean .btn-secondary {
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%) !important;
        }
        body.theme-ocean .btn-danger {
            background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%) !important;
        }
        body.theme-ocean .tab.active {
            color: #1e3c72 !important;
        }
        body.theme-ocean .tab:hover {
            background: rgba(30, 60, 114, 0.3) !important;
        }
        
        /* Forest Green Theme */
        body.theme-forest {
            background: linear-gradient(135deg, #134e4a 0%, #059669 100%) !important;
        }
        body.theme-forest .btn,
        body.theme-forest .btn-small {
            background: linear-gradient(135deg, #134e4a 0%, #059669 100%) !important;
        }
        body.theme-forest .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%) !important;
        }
        body.theme-forest .btn-secondary {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%) !important;
        }
        body.theme-forest .btn-danger {
            background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%) !important;
        }
        body.theme-forest .tab.active {
            color: #134e4a !important;
        }
        body.theme-forest .tab:hover {
            background: rgba(19, 78, 74, 0.3) !important;
        }
        
        /* Sunset Orange Theme */
        body.theme-sunset {
            background: linear-gradient(135deg, #c2410c 0%, #ea580c 100%) !important;
        }
        body.theme-sunset .btn,
        body.theme-sunset .btn-small {
            background: linear-gradient(135deg, #c2410c 0%, #ea580c 100%) !important;
        }
        body.theme-sunset .btn-success {
            background: linear-gradient(135deg, #ea580c 0%, #f97316 100%) !important;
        }
        body.theme-sunset .btn-secondary {
            background: linear-gradient(135deg, #9a3412 0%, #c2410c 100%) !important;
        }
        body.theme-sunset .btn-danger {
            background: linear-gradient(135deg, #991b1b 0%, #b91c1c 100%) !important;
        }
        body.theme-sunset .tab.active {
            color: #c2410c !important;
        }
        body.theme-sunset .tab:hover {
            background: rgba(194, 65, 12, 0.3) !important;
        }
        
        /* Professional Dark Theme */
        body.theme-dark {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%) !important;
        }
        body.theme-dark .btn,
        body.theme-dark .btn-small {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%) !important;
        }
        body.theme-dark .btn-success {
            background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%) !important;
        }
        body.theme-dark .btn-secondary {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%) !important;
        }
        body.theme-dark .btn-danger {
            background: linear-gradient(135deg, #991b1b 0%, #b91c1c 100%) !important;
        }
        body.theme-dark .tab {
            background: rgba(255, 255, 255, 0.15) !important;
        }
        body.theme-dark .tab.active {
            background: white !important;
            color: #1f2937 !important;
        }
        body.theme-dark .tab:hover {
            background: rgba(255, 255, 255, 0.25) !important;
        }
        body.theme-dark .card {
            background: #f9fafb !important;
        }
        
        /* Crimson Red Theme */
        body.theme-crimson {
            background: linear-gradient(135deg, #be123c 0%, #e11d48 100%) !important;
        }
        body.theme-crimson .btn,
        body.theme-crimson .btn-small {
            background: linear-gradient(135deg, #be123c 0%, #e11d48 100%) !important;
        }
        body.theme-crimson .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%) !important;
        }
        body.theme-crimson .btn-secondary {
            background: linear-gradient(135deg, #9f1239 0%, #be123c 100%) !important;
        }
        body.theme-crimson .tab.active {
            color: #be123c !important;
        }
        body.theme-crimson .tab:hover {
            background: rgba(190, 18, 60, 0.3) !important;
        }
        
        /* Slate Gray Theme */
        body.theme-slate {
            background: linear-gradient(135deg, #475569 0%, #64748b 100%) !important;
        }
        body.theme-slate .btn,
        body.theme-slate .btn-small {
            background: linear-gradient(135deg, #475569 0%, #64748b 100%) !important;
        }
        body.theme-slate .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%) !important;
        }
        body.theme-slate .btn-secondary {
            background: linear-gradient(135deg, #334155 0%, #475569 100%) !important;
        }
        body.theme-slate .tab.active {
            color: #475569 !important;
        }
        body.theme-slate .tab:hover {
            background: rgba(71, 85, 105, 0.3) !important;
        }
        
        /* Teal Theme */
        body.theme-teal {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%) !important;
        }
        body.theme-teal .btn,
        body.theme-teal .btn-small {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%) !important;
        }
        body.theme-teal .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%) !important;
        }
        body.theme-teal .btn-secondary {
            background: linear-gradient(135deg, #0f766e 0%, #0d9488 100%) !important;
        }
        body.theme-teal .tab.active {
            color: #0d9488 !important;
        }
        body.theme-teal .tab:hover {
            background: rgba(13, 148, 136, 0.3) !important;
        }
        
        /* Royal Purple Theme (Default) */
        body.theme-purple {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        body.theme-purple .btn,
        body.theme-purple .btn-small {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        body.theme-purple .btn-success {
            background: linear-gradient(135deg, #764ba2 0%, #9333ea 100%) !important;
        }
        body.theme-purple .btn-secondary {
            background: linear-gradient(135deg, #5b21b6 0%, #7c3aed 100%) !important;
        }
        body.theme-purple .btn-danger {
            background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%) !important;
        }
        body.theme-purple .tab.active {
            color: #667eea !important;
        }
        body.theme-purple .tab:hover {
            background: rgba(102, 126, 234, 0.3) !important;
        }
        
        /* Chicago Bears Theme */
        body.theme-bears {
            background: linear-gradient(135deg, #0B162A 0%, #1C2B3A 100%) !important;
        }
        body.theme-bears .btn,
        body.theme-bears .btn-small {
            background: linear-gradient(135deg, #C83803 0%, #E04A15 100%) !important;
        }
        body.theme-bears .btn-success {
            background: linear-gradient(135deg, #C83803 0%, #E04A15 100%) !important;
        }
        body.theme-bears .btn-secondary {
            background: linear-gradient(135deg, #0B162A 0%, #1C2B3A 100%) !important;
        }
        body.theme-bears .tab.active {
            color: #C83803 !important;
        }
        body.theme-bears .tab:hover {
            background: rgba(200, 56, 3, 0.3) !important;
        }
        body.theme-bears .card {
            background: #E4E7EB !important;
        }
        body.theme-bears .header h1 {
            color: #C83803 !important;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        /* Chicago Cubs Theme */
        body.theme-cubs {
            background: linear-gradient(135deg, #0E3386 0%, #142C5C 100%) !important;
        }
        body.theme-cubs .btn,
        body.theme-cubs .btn-small {
            background: linear-gradient(135deg, #CC3433 0%, #E04545 100%) !important;
        }
        body.theme-cubs .btn-success {
            background: linear-gradient(135deg, #0E3386 0%, #1A4AA8 100%) !important;
        }
        body.theme-cubs .btn-secondary {
            background: linear-gradient(135deg, #142C5C 0%, #1E3A6E 100%) !important;
        }
        body.theme-cubs .tab.active {
            color: #CC3433 !important;
        }
        body.theme-cubs .tab:hover {
            background: rgba(204, 52, 51, 0.3) !important;
        }
        body.theme-cubs .card {
            background: #F1F4F8 !important;
        }
        body.theme-cubs .header h1 {
            color: #CC3433 !important;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        /* Chicago Bulls Theme */
        body.theme-bulls {
            background: linear-gradient(135deg, #121212 0%, #231F20 100%) !important;
        }
        body.theme-bulls .btn,
        body.theme-bulls .btn-small {
            background: linear-gradient(135deg, #CE1141 0%, #E02050 100%) !important;
        }
        body.theme-bulls .btn-success {
            background: linear-gradient(135deg, #A31D3A 0%, #CE1141 100%) !important;
        }
        body.theme-bulls .btn-secondary {
            background: linear-gradient(135deg, #231F20 0%, #3A3535 100%) !important;
        }
        body.theme-bulls .tab.active {
            color: #CE1141 !important;
        }
        body.theme-bulls .tab:hover {
            background: rgba(206, 17, 65, 0.3) !important;
        }
        body.theme-bulls .card {
            background: #FAFAFA !important;
        }
        body.theme-bulls .header h1 {
            color: #CE1141 !important;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        body.theme-bulls .header {
            border-bottom: 3px solid #CE1141 !important;
        }
        
        /* Chicago Blackhawks Theme */
        body.theme-blackhawks {
            background: linear-gradient(135deg, #001F3F 0%, #112A3C 100%) !important;
        }
        body.theme-blackhawks .btn,
        body.theme-blackhawks .btn-small {
            background: linear-gradient(135deg, #CF0A2C 0%, #E02040 100%) !important;
        }
        body.theme-blackhawks .btn-success {
            background: linear-gradient(135deg, #01583A 0%, #027A50 100%) !important;
        }
        body.theme-blackhawks .btn-secondary {
            background: linear-gradient(135deg, #002F6C 0%, #003D8F 100%) !important;
        }
        body.theme-blackhawks .tab.active {
            color: #CF0A2C !important;
        }
        body.theme-blackhawks .tab:hover {
            background: rgba(207, 10, 44, 0.3) !important;
        }
        body.theme-blackhawks .card {
            background: #F5F7FA !important;
        }
        body.theme-blackhawks .header h1 {
            color: #CF0A2C !important;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        body.theme-blackhawks .header p {
            color: #E7B08B !important;
        }
        body.theme-blackhawks .header {
            border-bottom: 3px solid #01583A !important;
        }
        
        /* Green Bay Packers Theme */
        body.theme-packers {
            background: linear-gradient(135deg, #172B27 0%, #2C4A42 100%) !important;
        }
        body.theme-packers .btn,
        body.theme-packers .btn-small {
            background: linear-gradient(135deg, #203731 0%, #2C4A42 100%) !important;
            color: #FFB612 !important;
            border: 2px solid #D4A017 !important;
        }
        body.theme-packers .btn:hover {
            background: linear-gradient(135deg, #FFB612 0%, #D4A017 100%) !important;
            color: #203731 !important;
        }
        body.theme-packers .btn-success {
            background: linear-gradient(135deg, #FFB612 0%, #D4A017 100%) !important;
            color: #203731 !important;
            border: none !important;
        }
        body.theme-packers .btn-secondary {
            background: linear-gradient(135deg, #2C4A42 0%, #3D5E54 100%) !important;
            color: #FFB612 !important;
        }
        body.theme-packers .tab.active {
            color: #FFB612 !important;
        }
        body.theme-packers .tab:hover {
            background: rgba(255, 182, 18, 0.2) !important;
        }
        body.theme-packers .card {
            background: #F9F6EE !important;
        }
        body.theme-packers .header h1 {
            color: #FFB612 !important;
            text-shadow: 0 4px 12px rgba(0,0,0,0.6);
        }
        body.theme-packers .header p {
            color: #D4A017 !important;
        }
        body.theme-packers .header {
            border-bottom: 4px solid #FFB612 !important;
        }
    </style>
</head>
<body class="theme-purple">
    <!-- Immediate theme application -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'purple';
            document.body.className = 'theme-' + savedTheme;
        })();
    </script>
    <div class="container">
        <div class="header">
            <h1>üöö Nowak Distributing <span style="transform: scaleX(-1); display: inline-block;">üöö</span></h1>
            <p>Professional Inventory & Order Management System</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('suppliers')">üè≠ Suppliers</button>
            <button class="tab" onclick="switchTab('items')">üì¶ Items</button>
            <button class="tab" onclick="switchTab('customers')">üë• Customers</button>
            <button class="tab" onclick="switchTab('createpo')">üìù Create PO</button>
            <button class="tab" onclick="switchTab('purchases')">üì• Purchases</button>
            <button class="tab" onclick="switchTab('sales')">üí∞ Sales</button>
            <button class="tab" onclick="switchTab('inventory')">üìä Inventory</button>
            <button class="tab" onclick="switchTab('pricesim')">üéØ Price Sim</button>
            <button class="tab" onclick="switchTab('reports')">üìà Reports</button>
            <button class="tab" onclick="switchTab('config')">‚öôÔ∏è Settings</button>
        </div>
        
        <!-- Floating Navigation Buttons - Bottom Left Corner -->
        <!-- Back to Top Button - Top -->
        <button id="backToTopBtn" onclick="scrollToTop()" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" style="display: none; position: fixed; bottom: 100px; left: 30px; z-index: 1000; background: #667eea; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.3s ease;" title="Back to top">
            ‚¨ÜÔ∏è
        </button>
        
        <!-- Back Button - Bottom -->
        <button id="backBtn" onclick="goBack()" style="display: none; position: fixed; bottom: 30px; left: 30px; z-index: 1000; background: #9e9e9e; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="Go back to previous tab">
            ‚¨ÖÔ∏è
        </button>

        <!-- Settings Tab -->
        <div id="config" class="card">
            <h2>System Configuration</h2>
            <div class="status" id="configStatus"></div>
            
            <div class="config-box">
                <h3>Backend API URL</h3>
                <p style="margin-bottom: 10px; color: #666;">
                    Enter your Google Apps Script Web App URL
                </p>
                <input type="text" id="apiUrl" class="form-group" style="width: 100%; padding: 10px; margin-bottom: 15px;" 
                       placeholder="https://script.google.com/macros/s/.../exec">
                <button class="btn" onclick="saveConfig()">üíæ Save Configuration</button>
            </div>
            
            <div class="config-box">
                <h3>Theme</h3>
                <p style="margin-bottom: 10px; color: #666;">
                    Choose your color scheme
                </p>
                <select id="themeSelector" onchange="changeTheme()" style="width: 100%; padding: 10px; margin-bottom: 15px;">
                    <option value="purple">üü£ Royal Purple (Default)</option>
                    <option value="ocean">üåä Ocean Blue</option>
                    <option value="forest">üå≤ Forest Green</option>
                    <option value="sunset">üåÖ Sunset Orange</option>
                    <option value="crimson">‚ù§Ô∏è Crimson Red</option>
                    <option value="slate">üîò Slate Gray</option>
                    <option value="teal">üíé Teal</option>
                    <option value="dark">üåô Professional Dark</option>
                    <option value="bears">üêª Chicago Bears</option>
                    <option value="cubs">‚öæ Chicago Cubs</option>
                    <option value="bulls">üèÄ Chicago Bulls</option>
                    <option value="blackhawks">üèí Chicago Blackhawks</option>
                    <option value="packers">üßÄ Green Bay Packers</option>
                </select>
            </div>
            
            <div class="config-box">
                <h3>Backup Data</h3>
                <p style="margin-bottom: 10px; color: #666;">
                    Download a copy of your database
                </p>
                <button class="btn btn-secondary" onclick="openBackup()">üì• Open Google Sheet</button>
            </div>
            
            <div class="config-box">
                <h3>üìÑ Invoice Settings</h3>
                <p style="margin-bottom: 15px; color: #666;">
                    Customize your printed invoices
                </p>
                
                <div class="form-group">
                    <label>Company Name *</label>
                    <input type="text" id="invoiceCompanyName" placeholder="Nowak Distributing">
                </div>
                
                <div class="form-group">
                    <label>Contact Name</label>
                    <input type="text" id="invoiceContactName" placeholder="Joe Nowak">
                </div>
                
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="text" id="invoicePhone" placeholder="(920)634-4351">
                </div>
                
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="invoiceEmail" placeholder="jnowaksnfoodistributors@gmail.com">
                </div>
                
                <div class="form-group">
                    <label>Address Line 1</label>
                    <input type="text" id="invoiceAddress1" placeholder="123 Business Street">
                </div>
                
                <div class="form-group">
                    <label>Address Line 2</label>
                    <input type="text" id="invoiceAddress2" placeholder="Suite 100 (optional)">
                </div>
                
                <div class="form-group">
                    <label>City, State, ZIP</label>
                    <input type="text" id="invoiceCityStateZip" placeholder="Milwaukee, WI 53201">
                </div>
                
                <div class="form-group">
                    <label>Footer Message</label>
                    <textarea id="invoiceFooter" rows="2" placeholder="Thank you for doing business with us!"></textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="invoiceSignatureLine" checked>
                        Include signature line on invoices
                    </label>
                </div>
                
                <button class="btn" onclick="saveInvoiceSettings()">üíæ Save Invoice Settings</button>
            </div>

            <div class="config-box">
                <h3>Current Status</h3>
                <p id="configStatusText">‚ö†Ô∏è Not configured</p>
            </div>
        </div>

        <!-- Suppliers Tab -->
        <div id="suppliers" class="card active">
            <h2>Suppliers</h2>
            <div class="status" id="suppliersStatus"></div>
            
            <button class="btn" onclick="loadSuppliers()">üîÑ Refresh</button>
            <button class="btn btn-success" onclick="showAddSupplierForm()">‚ûï Add Supplier</button>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;">üîç Filter Suppliers</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-suppliers')" style="background: #666;">
                        <span id="filter-panel-suppliers-toggle">‚ñ∂ Show</span>
                    </button>
                </div>
                <div id="filter-panel-suppliers" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Search Name</label>
                        <input type="text" id="filterSupplierName" placeholder="Type to filter..." onkeyup="filterSuppliers()">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="filterSupplierCity" placeholder="Filter by city..." onkeyup="filterSuppliers()">
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <input type="text" id="filterSupplierState" placeholder="Filter by state..." onkeyup="filterSuppliers()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearSupplierFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addSupplierForm" style="display: none; margin-top: 20px; border: 2px solid #667eea; padding: 20px; border-radius: 8px;">
                <h3>Add New Supplier</h3>
                <form onsubmit="addSupplier(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier Name *</label>
                            <input type="text" id="newSupplierName" required>
                        </div>
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="newContactName">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="newPhone" placeholder="(999) 999-9999" oninput="formatPhone(this)">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="newEmail">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="newAddress">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="newCity">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" id="newState" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" id="newZip">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Payment Terms</label>
                        <select id="newPaymentTerms">
                            <option value="Net 30">Net 30</option>
                            <option value="Net 45">Net 45</option>
                            <option value="Net 60">Net 60</option>
                            <option value="COD">COD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="newNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn">üíæ Save Supplier</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddSupplierForm()">Cancel</button>
                </form>
            </div>
            
            <!-- Edit Supplier Form -->
            <div id="editSupplierForm" style="display: none; margin-top: 20px; border: 2px solid #f39c12; padding: 20px; border-radius: 8px;">
                <h3>‚úèÔ∏è Edit Supplier</h3>
                <form onsubmit="updateSupplier(event)">
                    <input type="hidden" id="editSupplierId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier Name *</label>
                            <input type="text" id="editSupplierName" required>
                        </div>
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="editContactName">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="editPhone">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="editEmail">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="editAddress">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="editCity">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" id="editState" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" id="editZip">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Payment Terms</label>
                        <select id="editPaymentTerms">
                            <option value="Net 30">Net 30</option>
                            <option value="Net 45">Net 45</option>
                            <option value="Net 60">Net 60</option>
                            <option value="COD">COD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn">üíæ Update Supplier</button>
                    <button type="button" class="btn btn-secondary" onclick="hideEditSupplierForm()">Cancel</button>
                </form>
            </div>
            
            <div id="suppliersTable"></div>
        </div>

        <!-- Items Tab -->
        <div id="items" class="card">
            <h2>Items</h2>
            <div class="status" id="itemsStatus"></div>
            
            <button class="btn" onclick="loadItems()">üîÑ Refresh</button>
            <button class="btn btn-success" onclick="showAddItemForm()">‚ûï Add Item</button>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;">üîç Filter Items</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-items')" style="background: #666;">
                        <span id="filter-panel-items-toggle">‚ñ∂ Show</span>
                    </button>
                </div>
                <div id="filter-panel-items" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Search SKU/Description</label>
                        <input type="text" id="filterItemSearch" placeholder="Type to filter..." onkeyup="filterItems()">
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <select id="filterItemSupplier" onchange="filterItems()">
                            <option value="">All Suppliers</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stock Status</label>
                        <select id="filterItemStock" onchange="filterItems()">
                            <option value="">All Items</option>
                            <option value="negative">üö® Negative Inventory</option>
                            <option value="low">‚ö†Ô∏è Low Stock (Below Reorder)</option>
                            <option value="onorder">üì¶ On Order (Pending Delivery)</option>
                            <option value="reorder">üõí Needs Reorder (Low + No Order)</option>
                            <option value="ok">‚úÖ Normal Stock</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearItemFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addItemForm" style="display: none; margin-top: 20px; border: 2px solid #667eea; padding: 20px; border-radius: 8px;">
                <h3>Add New Item</h3>
                <form onsubmit="addItem(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="newItemSupplier" required>
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Item Description *</label>
                            <input type="text" id="newItemDescription" required>
                        </div>
                        <div class="form-group">
                            <label>SKU *</label>
                            <input type="text" id="newItemSKU" required placeholder="e.g. BM-BBQ-001">
                        </div>
                        <div class="form-group">
                            <label>Purchase UOM (What you buy)</label>
                            <select id="newItemPurchaseUOM">
                                <option value="Each" selected>Each</option>
                                <option value="Box">Box</option>
                                <option value="Case">Case</option>
                                <option value="Pack">Pack</option>
                                <option value="Pallet">Pallet</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Units Per Package * <span style="font-size: 12px; color: #666;">(How many individual units in one box/case)</span></label>
                            <input type="number" id="newUnitsPerPackage" step="1" min="1" required placeholder="e.g. 27">
                        </div>
                        <div class="form-group">
                            <label>Package Cost * <span style="font-size: 12px; color: #666;">(Cost per box/case)</span></label>
                            <input type="number" id="newPackageCost" step="0.01" required placeholder="e.g. 20.00" oninput="calculateUnitCost()">
                        </div>
                        <div class="form-group">
                            <label>Unit Cost (Calculated)</label>
                            <input type="text" id="calculatedUnitCost" readonly style="background: #f0f0f0; font-weight: bold;" value="$0.00">
                        </div>
                        <div class="form-group">
                            <label>Unit Sell Price * <span style="font-size: 12px; color: #666;">(Price per individual unit)</span></label>
                            <input type="number" id="newUnitSellPrice" step="0.01" required placeholder="e.g. 3.00">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Initial Quantity <span style="font-size: 12px; color: #666;">(In individual units)</span></label>
                            <input type="number" id="newQtyOnHand" value="0">
                        </div>
                        <div class="form-group">
                            <label>Reorder Point <span style="font-size: 12px; color: #666;">(In individual units)</span></label>
                            <input type="number" id="newReorderPoint" value="10">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="newItemNotes" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn">üíæ Save Item</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddItemForm()">Cancel</button>
                </form>
            </div>
            
            <!-- Edit Item Form -->
            <div id="editItemForm" style="display: none; margin-top: 20px; border: 2px solid #f39c12; padding: 20px; border-radius: 8px;">
                <h3>‚úèÔ∏è Edit Item</h3>
                <form onsubmit="updateItem(event)">
                    <input type="hidden" id="editItemId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="editItemSupplier" required>
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Item Description *</label>
                            <input type="text" id="editItemDescription" required>
                        </div>
                        <div class="form-group">
                            <label>SKU *</label>
                            <input type="text" id="editItemSKU" required>
                        </div>
                        <div class="form-group">
                            <label>Purchase UOM</label>
                            <select id="editItemPurchaseUOM">
                                <option value="Box">Box</option>
                                <option value="Case">Case</option>
                                <option value="Pallet">Pallet</option>
                                <option value="Each">Each</option>
                                <option value="Pack">Pack</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Units Per Package *</label>
                            <input type="number" id="editUnitsPerPackage" step="1" min="1" required oninput="calculateEditUnitCost()">
                        </div>
                        <div class="form-group">
                            <label>Package Cost *</label>
                            <input type="number" id="editPackageCost" step="0.01" required oninput="calculateEditUnitCost()">
                        </div>
                        <div class="form-group">
                            <label>Unit Cost (Calculated)</label>
                            <input type="text" id="calculatedEditUnitCost" readonly style="background: #f0f0f0; font-weight: bold;" value="$0.00">
                        </div>
                        <div class="form-group">
                            <label>Unit Sell Price *</label>
                            <input type="number" id="editUnitSellPrice" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Current Quantity <span style="font-size: 12px; color: #666;">(In individual units)</span></label>
                            <input type="number" id="editQtyOnHand" readonly style="background: #f0f0f0;">
                            <small style="color: #666;">Use Purchases/Sales to adjust quantity</small>
                        </div>
                        <div class="form-group">
                            <label>Reorder Point <span style="font-size: 12px; color: #666;">(In individual units)</span></label>
                            <input type="number" id="editReorderPoint">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editItemNotes" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn">üíæ Update Item</button>
                    <button type="button" class="btn btn-secondary" onclick="hideEditItemForm()">Cancel</button>
                </form>
            </div>
            
            <div id="itemsTable"></div>
        </div>

        <!-- Customers Tab -->
        <div id="customers" class="card">
            <h2>Customers</h2>
            <div class="status" id="customersStatus"></div>
            
            <button class="btn" onclick="loadCustomers()">üîÑ Refresh</button>
            <button class="btn btn-success" onclick="showAddCustomerForm()">‚ûï Add Customer</button>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;">üîç Filter Customers</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-customers')" style="background: #666;">
                        <span id="filter-panel-customers-toggle">‚ñ∂ Show</span>
                    </button>
                </div>
                <div id="filter-panel-customers" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Search Name</label>
                        <input type="text" id="filterCustomerName" placeholder="Customer name..." onkeyup="filterCustomers()">
                    </div>
                    <div class="form-group">
                        <label>Contact Name</label>
                        <input type="text" id="filterCustomerContact" placeholder="Contact name..." onkeyup="filterCustomers()">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="filterCustomerCity" placeholder="Filter by city..." onkeyup="filterCustomers()">
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <input type="text" id="filterCustomerState" placeholder="Filter by state..." onkeyup="filterCustomers()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearCustomerFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addCustomerForm" style="display: none; margin-top: 20px; border: 2px solid #667eea; padding: 20px; border-radius: 8px;">
                <h3>Add New Customer</h3>
                <form onsubmit="addCustomer(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Customer Name *</label>
                            <input type="text" id="newCustomerName" required>
                        </div>
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="newCustomerContact">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="newCustomerPhone">
                        </div>
                        <div class="form-group">
                            <label>Mobile</label>
                            <input type="tel" id="newCustomerMobile">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="newCustomerEmail">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="newCustomerAddress">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="newCustomerCity">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" id="newCustomerState" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" id="newCustomerZip">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Credit Limit</label>
                            <input type="number" id="newCreditLimit" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Payment Terms</label>
                            <select id="newCustomerPaymentTerms">
                                <option value="Net 30">Net 30</option>
                                <option value="Net 15">Net 15</option>
                                <option value="Net 45">Net 45</option>
                                <option value="COD">COD</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="newCustomerNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn">üíæ Save Customer</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddCustomerForm()">Cancel</button>
                </form>
            </div>
            
            <!-- Edit Customer Form -->
            <div id="editCustomerForm" style="display: none; margin-top: 20px; border: 2px solid #f39c12; padding: 20px; border-radius: 8px;">
                <h3>‚úèÔ∏è Edit Customer</h3>
                <form onsubmit="updateCustomer(event)">
                    <input type="hidden" id="editCustomerId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Customer Name *</label>
                            <input type="text" id="editCustomerName" required>
                        </div>
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="editCustomerContact">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="editCustomerPhone">
                        </div>
                        <div class="form-group">
                            <label>Mobile</label>
                            <input type="tel" id="editCustomerMobile">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="editCustomerEmail">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="editCustomerAddress">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="editCustomerCity">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" id="editCustomerState" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" id="editCustomerZip">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Credit Limit</label>
                            <input type="number" id="editCreditLimit" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Payment Terms</label>
                            <select id="editCustomerPaymentTerms">
                                <option value="Net 30">Net 30</option>
                                <option value="Net 15">Net 15</option>
                                <option value="Net 45">Net 45</option>
                                <option value="COD">COD</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editCustomerNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn">üíæ Update Customer</button>
                    <button type="button" class="btn btn-secondary" onclick="hideEditCustomerForm()">Cancel</button>
                </form>
            </div>
            
            <div id="customersTable"></div>
        </div>

        <!-- Create PO Tab (Generate Only - No Database Save) -->
        <div id="createpo" class="card">
            <div style="max-width: 100%; overflow: hidden;">
                <h2>üìù Create Purchase Order</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Create an OUTBOUND purchase order to track items on order from suppliers. Use <strong>"Save as OUTBOUND PO"</strong> to save to database and mark items as "On Order", or use <strong>"Print PO (No Save)"</strong> to just generate a printable document.
                </p>
                
                <div id="createPOForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="createPOSupplier" required onchange="filterItemsBySupplier()">
                                <option value="">Select Supplier...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>PO Date *</label>
                            <input type="date" id="createPODate" required>
                        </div>
                        <div class="form-group">
                            <label>Expected Delivery Date</label>
                            <input type="date" id="createPOExpectedDate">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Notes</label>
                            <textarea id="createPONotes" rows="2" placeholder="Special instructions, delivery notes, etc."></textarea>
                        </div>
                    </div>
                
                <h3>Line Items</h3>
                
                <!-- Wrapper for horizontal scroll on mobile -->
                <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 20px; width: 100%; position: relative;">
                    <div style="min-width: 650px; width: 100%; max-width: 100%;">
                        <!-- Header Row -->
                        <div style="display: grid; grid-template-columns: 2fr 0.6fr 0.6fr 0.8fr 0.8fr 0.8fr 60px; gap: 4px; padding: 10px; background: #667eea; color: white; font-weight: bold; border-radius: 8px 8px 0 0; font-size: 13px;">
                            <div>Item</div>
                            <div style="text-align: center;">Cases</div>
                            <div style="text-align: center;">Units/Case</div>
                            <div style="text-align: center;">Total Units</div>
                            <div style="text-align: center;">Catalog Cost</div>
                            <div style="text-align: right;">Line Total</div>
                            <div style="text-align: center;">Del</div>
                        </div>
                        
                        <!-- Line Items Container -->
                        <div id="createPOLineItems" style="border: 2px solid #667eea; border-top: none; border-radius: 0 0 8px 8px; padding: 6px;">
                            <div class="line-item-row" style="display: grid; grid-template-columns: 2fr 0.6fr 0.6fr 0.8fr 0.8fr 0.8fr 60px; gap: 4px; margin-bottom: 6px; align-items: center;">
                                <select class="createpo-item" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                    <option value="">Select item...</option>
                                </select>
                                <input type="number" class="createpo-qty" placeholder="0" min="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 13px;">
                                <div class="createpo-units" style="text-align: center; font-size: 13px; color: #666; padding: 4px;">-</div>
                                <div class="createpo-totalunits" style="text-align: center; font-size: 15px; font-weight: bold; color: #1565C0; padding: 4px;">-</div>
                                <div class="createpo-cost" style="text-align: center; font-size: 13px; font-weight: bold; color: #28a745; background: #e8f5e9; padding: 8px; border-radius: 4px;">-</div>
                                <div class="createpo-linetotal" style="text-align: right; font-size: 13px; font-weight: bold; color: #1565C0; background: #E3F2FD; padding: 8px; border-radius: 4px;">$0.00</div>
                                <button type="button" class="btn-danger" onclick="removeLineItem(this)" style="width: 100%; padding: 8px; font-size: 14px;">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-secondary" onclick="addCreatePOLineItem()">‚ûï Add Line Item</button>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <h3 style="margin: 0 0 10px 0; color: #666; font-size: 16px;">Total Cases</h3>
                            <p style="font-size: 28px; font-weight: bold; color: #667eea; margin: 0;" id="createPOTotalCases">0</p>
                        </div>
                        <div style="text-align: center;">
                            <h3 style="margin: 0 0 10px 0; color: #666; font-size: 16px;">Total Units</h3>
                            <p style="font-size: 28px; font-weight: bold; color: #1565C0; margin: 0;" id="createPOTotalUnits">0</p>
                        </div>
                        <div style="text-align: center;">
                            <h3 style="margin: 0 0 10px 0; color: #666; font-size: 16px;">Total Cost</h3>
                            <p style="font-size: 28px; font-weight: bold; color: #667eea; margin: 0;" id="createPOTotal">$0.00</p>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
                    <button class="btn" onclick="saveOutboundPO()" style="flex: 1; min-width: 200px; background: #28a745;">üíæ Save as OUTBOUND PO</button>
                    <button class="btn btn-success" onclick="generatePrintablePO()" style="flex: 1; min-width: 200px;">üñ®Ô∏è Print PO (No Save)</button>
                    <button class="btn btn-secondary" onclick="clearCreatePOForm()" style="flex: 1; min-width: 200px;">üîÑ Clear Form</button>
                </div>
            </div>
            </div>
            
            <!-- Printable PO Document (Hidden initially) -->
            <div id="printablePOContainer" style="display: none; margin-top: 30px;">
                <div style="text-align: right; margin-bottom: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-success" onclick="window.print()">üñ®Ô∏è Print</button>
                    <button class="btn btn-success" onclick="downloadPOAsPDF()">üì• Download PDF</button>
                    <button class="btn btn-success" onclick="emailPO()">üìß Email PO</button>
                    <button class="btn btn-secondary" onclick="closePrintablePO()">‚ùå Close</button>
                </div>
                <div id="printablePO" style="background: white; padding: 40px; border: 1px solid #ddd; max-width: 800px; margin: 0 auto;">
                    <!-- Printable PO will be generated here -->
                </div>
            </div>
        </div>

        <!-- Purchases Tab -->
        <div id="purchases" class="card">
            <h2>Purchase Orders</h2>
            <div class="status" id="purchasesStatus"></div>
            
            <button class="btn" onclick="loadPurchases()">üîÑ Refresh</button>
            <button class="btn btn-success" onclick="showAddPurchaseForm()">‚ûï Record Purchase</button>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;">üîç Filter Purchases</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-purchases')" style="background: #666;">
                        <span id="filter-panel-purchases-toggle">‚ñ∂ Show</span>
                    </button>
                </div>
                <div id="filter-panel-purchases" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Invoice # / PO</label>
                        <input type="text" id="filterPurchasePO" placeholder="Search..." onchange="filterPurchases()">
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <select id="filterPurchaseSupplier" onchange="filterPurchases()">
                            <option value="">All Suppliers</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Order Status</label>
                        <select id="filterPurchaseStatus" onchange="filterPurchases()">
                            <option value="">All</option>
                            <option value="Ordered">üì§ Ordered (Pending)</option>
                            <option value="Received">üì• Received</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üíµ Payment Status</label>
                        <select id="filterPurchasePaymentStatus" onchange="filterPurchases()">
                            <option value="">All</option>
                            <option value="Paid">‚úÖ Paid</option>
                            <option value="Partial">üü° Partial</option>
                            <option value="Unpaid">üî¥ Unpaid</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìÖ PO Date From</label>
                        <input type="date" id="filterPurchaseDateFrom" onchange="filterPurchases()">
                    </div>
                    <div class="form-group">
                        <label>üìÖ PO Date To</label>
                        <input type="date" id="filterPurchaseDateTo" onchange="filterPurchases()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearPurchaseFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addPurchaseForm" style="display: none; margin-top: 20px; border: 2px solid #667eea; padding: 20px; border-radius: 8px;">
                <h3>Record New Purchase</h3>
                <form onsubmit="addPurchase(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="poSupplier" required onchange="loadSupplierItems()">
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Invoice Number *</label>
                            <input type="text" id="poInvoiceNumber" required>
                        </div>
                        <div class="form-group">
                            <label>Purchase Date *</label>
                            <input type="date" id="poDate" required>
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="poDueDate">
                        </div>
                        <div class="form-group">
                            <label>Payment Terms</label>
                            <select id="poPaymentTerms">
                                <option value="Net 30">Net 30</option>
                                <option value="Net 60">Net 60</option>
                                <option value="COD">COD (Cash on Delivery)</option>
                                <option value="Prepaid">Prepaid</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="poStatus">
                                <option value="Received">Received</option>
                                <option value="Pending">Pending</option>
                                <option value="Partial">Partial</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Invoice Total *</label>
                            <input type="number" id="poTotal" step="0.01" min="0" required readonly style="background: #f0f0f0;">
                            <small style="color: #666;">Auto-calculated from line items</small>
                        </div>
                        <div class="form-group">
                            <label>Amount Paid</label>
                            <input type="number" id="poAmountPaid" step="0.01" min="0" value="0" placeholder="0.00">
                            <small style="color: #666;">Enter amount if paid at time of purchase</small>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 20px; margin-bottom: 10px;">Line Items</h4>
                    <div class="line-items-container" id="poLineItems">
                        <div class="line-item-row">
                            <select class="po-item" required>
                                <option value="">Select Item</option>
                            </select>
                            <input type="number" class="po-qty" placeholder="Quantity" min="1" required>
                            <input type="number" class="po-cost" placeholder="Unit Cost" step="0.01" min="0" required>
                            <button type="button" class="remove-btn">‚úï</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-secondary" onclick="addPOLineItem()">+ Add Line Item</button>
                        <button type="button" class="btn" onclick="addNewItemFromPO()" style="background: #9c27b0;">‚ûï Add New Item to Catalog</button>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Notes</label>
                        <textarea id="poNotes" rows="2"></textarea>
                    </div>
                    
                    <button type="submit" class="btn">üíæ Save Purchase Order</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddPurchaseForm()">Cancel</button>
                </form>
            </div>
            
            <div id="purchasesTable"></div>
        </div>

        <!-- Sales Tab -->
        <div id="sales" class="card">
            <h2>Sales Orders</h2>
            <div class="status" id="salesStatus"></div>
            
            <button class="btn" onclick="loadSales()">üîÑ Refresh</button>
            <button class="btn btn-success" onclick="showAddSaleForm()">‚ûï Record Sale</button>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;">üîç Filter Sales</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-sales')" style="background: #666;">
                        <span id="filter-panel-sales-toggle">‚ñ∂ Show</span>
                    </button>
                </div>
                <div id="filter-panel-sales" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Customer</label>
                        <select id="filterSaleCustomer" onchange="filterSales()">
                            <option value="">All Customers</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Invoice #</label>
                        <input type="text" id="filterInvoiceNumber" placeholder="INV-120725-001" oninput="filterSales()">
                    </div>
                    <div class="form-group">
                        <label>Date From</label>
                        <input type="date" id="filterSaleDateFrom" onchange="filterSales()">
                    </div>
                    <div class="form-group">
                        <label>Date To</label>
                        <input type="date" id="filterSaleDateTo" onchange="filterSales()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearSaleFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addSaleForm" style="display: none; margin-top: 20px; border: 2px solid #667eea; padding: 20px; border-radius: 8px;">
                <h3>Record New Sale</h3>
                <form onsubmit="addSale(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Customer *</label>
                            <select id="soCustomer" required>
                                <option value="">Select Customer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Sale Date *</label>
                            <input type="date" id="soDate" required>
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="soPayment">
                                <option value="Cash">Cash</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Check">Check</option>
                                <option value="Invoice">Invoice</option>
                                <option value="Terms (Net 30)">Terms (Net 30)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Due Date (if invoiced)</label>
                            <input type="date" id="soDueDate">
                        </div>
                        <div class="form-group">
                            <label>Order Total *</label>
                            <input type="number" id="soTotal" step="0.01" min="0" required readonly style="background: #f0f0f0;">
                            <small style="color: #666;">Auto-calculated from line items</small>
                        </div>
                        <div class="form-group">
                            <label>Amount Paid</label>
                            <input type="number" id="soAmountPaid" step="0.01" min="0" value="0" placeholder="0.00">
                            <small style="color: #666;">Enter amount if paid at time of sale</small>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="soStatus">
                                <option value="Completed">Completed</option>
                                <option value="Pending">Pending</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 20px; margin-bottom: 10px;">Items Sold</h4>
                    <div class="line-items-container" id="soLineItems">
                        <div class="line-item-row">
                            <select class="so-item" required>
                                <option value="">Select Item</option>
                            </select>
                            <input type="number" class="so-qty" placeholder="Quantity" min="1" required>
                            <input type="number" class="so-price" placeholder="Unit Price" step="0.01" min="0" required>
                            <button type="button" class="remove-btn">‚úï</button>
                            <div class="so-stock-info" style="grid-column: 1 / -1; font-size: 13px; padding: 5px 10px; margin-top: -5px; display: none;"></div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addSOLineItem()">+ Add Line Item</button>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Notes</label>
                        <textarea id="soNotes" rows="2"></textarea>
                    </div>
                    
                    <button type="submit" class="btn">üíæ Save Sale</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddSaleForm()">Cancel</button>
                </form>
            </div>
            
            <div id="salesTable"></div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="card">
            <h2>Inventory Report</h2>
            <div class="status" id="inventoryStatus"></div>
            
            <div style="margin-bottom: 15px;">
                <button class="btn" onclick="loadInventory()">üîÑ Refresh</button>
                <button class="btn" onclick="showAdjustInventoryForm()" style="background: #f39c12;">üìù Adjust Inventory</button>
                <button class="btn" onclick="goToAddItem()" style="background: #9c27b0;">‚ûï Add New Item</button>
            </div>
            
            <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 14px;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleSection('inventoryGuide')">
                    <strong>üìñ Quick Guide</strong>
                    <span id="inventoryGuide-toggle" style="color: #667eea;">‚ñº Hide</span>
                </div>
                <div id="inventoryGuide" style="margin-top: 10px;">
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><strong>‚ûï Add New Item</strong> - Add items you already have in stock (no purchase order needed)</li>
                        <li><strong>üìù Adjust Inventory</strong> - Fix counts, record damage, shrinkage, or physical inventory counts</li>
                        <li><strong>üì• Purchases tab</strong> - Record new inventory from suppliers (creates purchase orders)</li>
                    </ul>
                </div>
            </div>
            
            <!-- Manual Adjustment Form -->
            <div id="adjustInventoryForm" style="display: none; margin-top: 20px; border: 2px solid #f39c12; padding: 20px; border-radius: 8px; background: #fff8e1;">
                <h3>üìù Manual Inventory Adjustment</h3>
                <p style="color: #666; margin-bottom: 15px;">Use this for physical counts, damaged goods, shrinkage, etc.</p>
                <form onsubmit="submitInventoryAdjustment(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Item *</label>
                            <select id="adjustItem" required>
                                <option value="">Select Item</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Current Quantity</label>
                            <input type="number" id="adjustCurrentQty" readonly style="background: #f0f0f0;">
                        </div>
                        <div class="form-group">
                            <label>Adjustment (+/-) *</label>
                            <input type="number" id="adjustQuantity" placeholder="e.g., -5 or +10" required>
                            <small style="color: #666;">Use negative for decrease, positive for increase</small>
                        </div>
                        <div class="form-group">
                            <label>New Quantity</label>
                            <input type="number" id="adjustNewQty" readonly style="background: #e8f5e9;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Reason *</label>
                        <select id="adjustReason" required>
                            <option value="">Select Reason</option>
                            <option value="Physical Count">Physical Count</option>
                            <option value="Damaged Goods">Damaged Goods</option>
                            <option value="Expired Products">Expired Products</option>
                            <option value="Shrinkage/Theft">Shrinkage/Theft</option>
                            <option value="Found Inventory">Found Inventory</option>
                            <option value="Data Correction">Data Correction</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="adjustNotes" rows="2" placeholder="Additional details..."></textarea>
                    </div>
                    <button type="submit" class="btn">üíæ Save Adjustment</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAdjustInventoryForm()">Cancel</button>
                </form>
            </div>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;">üîç Filter Inventory</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-inventory')" style="background: #666;">
                        <span id="filter-panel-inventory-toggle">‚ñ∂ Show</span>
                    </button>
                </div>
                <div id="filter-panel-inventory" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Search SKU/Description</label>
                        <input type="text" id="filterInventorySearch" placeholder="Type to filter..." onkeyup="filterInventory()">
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <select id="filterInventorySupplier" onchange="filterInventory()">
                            <option value="">All Suppliers</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stock Status</label>
                        <select id="filterInventoryStock" onchange="filterInventoryByStatus(this.value)">
                            <option value="">All Items</option>
                            <option value="negative">üö® Negative</option>
                            <option value="out">üî¥ Out of Stock</option>
                            <option value="low">üü° Low Stock</option>
                            <option value="ok">üü¢ In Stock</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearInventoryFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="inventoryTable"></div>
        </div>
        
        <!-- PRICE SIMULATOR TAB -->
        <div id="pricesim" class="card">
            <h2>üéØ Pricing Workbench</h2>
            <div class="status" id="pricesimStatus"></div>
            
            <div style="background: linear-gradient(135deg, #667eea15, #764ba215); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                <h3 style="margin: 0 0 10px 0; color: #667eea;">üí° What You Can Do Here</h3>
                <p style="margin: 0; color: #555;">
                    <strong>üì¶ Existing Items:</strong> Adjust sell prices by % or flat amount, preview impact, then apply<br>
                    <strong>‚ûï New Items:</strong> Add items from supplier catalog, enter cost, simulate different markups to find the right sell price
                </p>
            </div>
            
            <!-- ADD NEW ITEM SECTION -->
            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #ff9800;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleSection('addNewItemContent')">
                    <h3 style="margin: 0; color: #e65100;">‚ûï Add New Item from Supplier Catalog</h3>
                    <span id="addNewItemContent-toggle" style="font-size: 14px; color: #666;">‚ñº Hide</span>
                </div>
                <div id="addNewItemContent" style="margin-top: 15px;">
                <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">Enter item details from your supplier's catalog. Set the markup % to calculate a sell price, then add to simulation to compare.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Supplier *</label>
                        <select id="newSimSupplier" required>
                            <option value="">Select Supplier</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>SKU / UPC</label>
                        <input type="text" id="newSimSKU" placeholder="e.g., 41633009999">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Description *</label>
                        <input type="text" id="newSimDescription" placeholder="e.g., Cheese Puffs, 12ct" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Package Cost *</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span>$</span>
                            <input type="number" id="newSimPackageCost" step="0.01" min="0" placeholder="18.50" oninput="calcNewSimUnitCost()">
                        </div>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Units/Package *</label>
                        <input type="number" id="newSimUnitsPerPkg" step="1" min="1" value="1" placeholder="12" oninput="calcNewSimUnitCost()">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Unit Cost</label>
                        <input type="text" id="newSimUnitCost" readonly style="background: #e0e0e0; font-weight: bold;" value="$0.00">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Markup %</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number" id="newSimMarkup" value="30" min="0" max="500" step="1" style="width: 70px;" oninput="calcNewSimSellPrice()">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Sell Price</label>
                        <input type="text" id="newSimSellPrice" readonly style="background: #c8e6c9; font-weight: bold; color: #2e7d32;" value="$0.00">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" class="btn" onclick="addNewItemToSimulation()" style="background: #ff9800;">
                        ‚ûï Add to Simulation
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearNewSimForm()">
                        üóëÔ∏è Clear Form
                    </button>
                </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0;">üîç Filter Existing Items</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Search SKU/Description</label>
                        <input type="text" id="pricesimSearch" placeholder="Type to filter..." onkeyup="filterPriceSimItems()">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Supplier</label>
                        <select id="pricesimSupplier" onchange="filterPriceSimItems()">
                            <option value="">All Suppliers</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Stock Status</label>
                        <select id="pricesimStock" onchange="filterPriceSimItems()">
                            <option value="">All Items</option>
                            <option value="instock">In Stock Only</option>
                            <option value="low">Low Stock</option>
                            <option value="out">Out of Stock</option>
                            <option value="new">üÜï New (Simulated Only)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Revenue Impact Calculator -->
            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #2196f3;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleSection('revenueCalcContent')">
                    <h3 style="margin: 0; color: #1565c0;">üí∞ Revenue Impact Calculator</h3>
                    <span id="revenueCalcContent-toggle" style="font-size: 14px; color: #666;">‚ñº Hide</span>
                </div>
                <div id="revenueCalcContent" style="margin-top: 15px;">
                    <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">See how a price increase affects your profit on a sample sale amount.</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-weight: bold;">üì¶ Sample Sale Amount</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span style="font-size: 20px; font-weight: bold;">$</span>
                                <input type="number" id="revCalcSaleAmount" value="100" min="0" step="10" style="width: 120px; font-size: 18px; padding: 10px;" oninput="calculateRevenueImpact()">
                            </div>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-weight: bold;">üìà Price Increase %</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="revCalcPercent" min="0" max="50" value="10" style="flex: 1; height: 30px;" oninput="calculateRevenueImpact()">
                                <span id="revCalcPercentLabel" style="font-size: 24px; font-weight: bold; color: #1565c0; min-width: 60px;">10%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="background: #fff; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #e0e0e0;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">BEFORE Increase</div>
                            <div id="revCalcBefore" style="font-size: 32px; font-weight: bold; color: #666;">$100.00</div>
                            <div style="font-size: 12px; color: #999;">Your Sale</div>
                        </div>
                        <div style="background: #fff; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #e0e0e0;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">AFTER Increase</div>
                            <div id="revCalcAfter" style="font-size: 32px; font-weight: bold; color: #2e7d32;">$110.00</div>
                            <div style="font-size: 12px; color: #999;">New Sale Value</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4caf50, #2e7d32); padding: 20px; border-radius: 12px; text-align: center; color: white;">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">EXTRA PROFIT</div>
                            <div id="revCalcProfit" style="font-size: 32px; font-weight: bold;">+$10.00</div>
                            <div style="font-size: 12px; opacity: 0.9;">Per Sale</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <h4 style="margin: 0 0 10px 0; color: #1565c0;">üìä Projected Impact</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                            <div>
                                <div style="color: #666; font-size: 13px;">10 Sales/Week</div>
                                <div id="revCalc10Sales" style="font-size: 20px; font-weight: bold; color: #2e7d32;">+$100/week</div>
                            </div>
                            <div>
                                <div style="color: #666; font-size: 13px;">Monthly (40 sales)</div>
                                <div id="revCalcMonthly" style="font-size: 20px; font-weight: bold; color: #2e7d32;">+$400/month</div>
                            </div>
                            <div>
                                <div style="color: #666; font-size: 13px;">Yearly (520 sales)</div>
                                <div id="revCalcYearly" style="font-size: 20px; font-weight: bold; color: #2e7d32;">+$5,200/year</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Price Adjustment Controls -->
            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; color: #2e7d32;">üìà Bulk Price Adjustment (Existing Items)</h3>
                <div style="display: flex; gap: 20px; align-items: end; flex-wrap: wrap;">
                    <div class="form-group" style="margin: 0;">
                        <label>Increase by Percentage</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number" id="pricesimPercent" value="5" min="0" max="100" step="0.5" style="width: 80px;" onchange="previewPriceChanges()">
                            <span style="font-size: 18px; font-weight: bold;">%</span>
                        </div>
                    </div>
                    <div style="color: #666; font-size: 14px; padding-bottom: 8px;">‚Äî OR ‚Äî</div>
                    <div class="form-group" style="margin: 0;">
                        <label>Increase by Flat Amount</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="font-size: 18px; font-weight: bold;">$</span>
                            <input type="number" id="pricesimFlat" value="0" min="0" step="0.01" style="width: 80px;" onchange="previewPriceChanges()">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="previewPriceChanges()" style="height: 42px;">
                        üìä Preview Changes
                    </button>
                </div>
            </div>
            
            <!-- Impact Summary Cards -->
            <div id="pricesimSummary" style="display: none; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                    <div style="background: #667eea; color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9;">Selected Items</div>
                        <div id="simSelectedCount" style="font-size: 32px; font-weight: bold;">0</div>
                    </div>
                    <div style="background: #6c757d; color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9;">Current Revenue</div>
                        <div id="simCurrentRevenue" style="font-size: 28px; font-weight: bold;">$0.00</div>
                    </div>
                    <div style="background: #28a745; color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9;">New Revenue</div>
                        <div id="simNewRevenue" style="font-size: 28px; font-weight: bold;">$0.00</div>
                    </div>
                    <div style="background: #17a2b8; color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9;">Revenue Increase</div>
                        <div id="simIncrease" style="font-size: 28px; font-weight: bold;">+$0.00</div>
                    </div>
                </div>
            </div>
            
            <!-- Items Table -->
            <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="pricesimSelectAll" onchange="toggleAllPriceSimItems()" style="width: 18px; height: 18px;">
                    <strong>Select All Visible Items</strong>
                </label>
                <button class="btn" onclick="loadPriceSimItems()" style="background: #6c757d;">üîÑ Refresh Items</button>
            </div>
            
            <div id="pricesimTable" style="overflow-x: auto;"></div>
            
            <!-- Apply Button -->
            <div id="pricesimApplySection" style="display: none; margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <strong style="font-size: 18px;">‚ö†Ô∏è Ready to Apply Changes?</strong>
                        <p style="margin: 5px 0 0 0; color: #666;">This will update the Unit Sell Price for all selected items in your database.</p>
                    </div>
                    <button class="btn btn-success" onclick="applyPriceChanges()" style="font-size: 16px; padding: 15px 30px;">
                        ‚úÖ APPLY CHANGES TO <span id="applyCount">0</span> ITEMS
                    </button>
                </div>
            </div>
        </div>
        
        <!-- REPORTS TAB -->
        <div id="reports" class="card">
            <h2>üìà Business Reports</h2>
            <div class="status" id="reportsStatus"></div>
            
            <p style="color: #666; margin-bottom: 20px;">Generate professional reports to analyze your business performance</p>
            
            <!-- Report Selection Buttons -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 30px;">
                <button class="btn" onclick="showReport('sales-by-customer')">üë• Sales by Customer</button>
                <button class="btn" onclick="showReport('sales-order-detail')">üìã Sales Order Detail</button>
                <button class="btn" onclick="showReport('sales-by-product')">üì¶ Sales by Product</button>
                <button class="btn" onclick="showReport('purchase-order-detail')">üìã Purchase Order Detail</button>
                <button class="btn" onclick="showReport('purchase-by-supplier')">üè≠ Purchase by Supplier</button>
                <button class="btn" onclick="showReport('inventory-turnover')">üîÑ Inventory Turnover</button>
                <button class="btn" onclick="showReport('gross-margin')">üí∞ Gross Margin</button>
                <button class="btn" onclick="showReport('accounts-receivable')" style="background: #28a745;">üíµ Accounts Receivable</button>
                <button class="btn" onclick="showReport('accounts-payable')" style="background: #dc3545;">üí∏ Accounts Payable</button>
                <button class="btn" onclick="showReport('simple-inventory')" style="background: #17a2b8;">üìã Inventory List</button>
            </div>
            
            <!-- Report Container -->
            <div id="reportContainer"></div>
        </div>
    </div>

    <script>
        let API_URL = localStorage.getItem('apiUrl') || 'https://script.google.com/macros/s/AKfycbwUYTRxFdSS78WZ8gK44580wLDO_C7uUozj_3ruyiNbJHZi_pH7tUDC-ojszeddEwX8Dg/exec';
        let cachedSuppliers = [];
        let cachedItems = [];
        let cachedCustomers = [];
        
        // Helper functions to lookup names from IDs
        function getCustomerName(customerId) {
            const customer = cachedCustomers.find(c => c.Customer_ID === customerId);
            return customer ? customer.Customer_Name : customerId;
        }
        
        function getSupplierName(supplierId) {
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            return supplier ? supplier.Supplier_Name : supplierId;
        }
        
        function getItemDescription(itemId) {
            const item = cachedItems.find(i => i.Item_ID === itemId);
            return item ? item.Item_Description : itemId;
        }

        window.addEventListener('DOMContentLoaded', () => {
            updateConfigStatus();
            loadInvoiceSettings();
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('poDate')) document.getElementById('poDate').value = today;
            if (document.getElementById('soDate')) document.getElementById('soDate').value = today;
            if (document.getElementById('createPODate')) document.getElementById('createPODate').value = today;
            
            // AUTO-LOAD ALL DATA ON PAGE LOAD
            console.log('üöÄ Auto-loading all data from Google Sheets...');
            loadSuppliers();
            loadItems();
            loadCustomers();
            loadPurchases();
            loadSales();
            loadInventory();
            
            // Attach event listeners to the first Create PO line item
            const firstCreatePORow = document.querySelector('#createPOLineItems div.line-item-row');
            if (firstCreatePORow) {
                const itemSelect = firstCreatePORow.querySelector('.createpo-item');
                const qtyInput = firstCreatePORow.querySelector('.createpo-qty');
                
                if (itemSelect) {
                    itemSelect.addEventListener('change', function() {
                        updateCreatePOItemCost(this);
                    });
                }
                
                if (qtyInput) {
                    qtyInput.addEventListener('input', function() {
                        calculateCreatePOTotal();
                    });
                }
            }
            
            // Attach event listeners to the first hardcoded Sales Order line item
            const firstSORow = document.querySelector('#soLineItems .line-item-row');
            if (firstSORow) {
                console.log('Attaching listeners to first SO line item'); // DEBUG
                const itemSelect = firstSORow.querySelector('.so-item');
                const qtyInput = firstSORow.querySelector('.so-qty');
                const priceInput = firstSORow.querySelector('.so-price');
                const removeBtn = firstSORow.querySelector('.remove-btn');
                
                if (itemSelect) {
                    itemSelect.addEventListener('change', function() {
                        console.log('First row CHANGE EVENT FIRED!'); // DEBUG
                        updateSOItemInfo(this);
                    });
                }
                
                if (qtyInput) {
                    qtyInput.addEventListener('input', function() {
                        // Update stock info when quantity changes
                        const row = this.closest('.line-item-row');
                        const itemSelect = row.querySelector('.so-item');
                        if (itemSelect.value) {
                            updateSOItemInfo(itemSelect);
                        }
                        calculateSOTotal();
                    });
                }
                
                if (priceInput) {
                    priceInput.addEventListener('input', function() {
                        calculateSOTotal();
                    });
                }
                
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        removeLineItem(this);
                        calculateSOTotal();
                    });
                }
                console.log('First SO row listeners attached!'); // DEBUG
            }
            
            // Attach event listeners to the first hardcoded Purchase Order line item
            const firstPORow = document.querySelector('#poLineItems .line-item-row');
            if (firstPORow) {
                console.log('Attaching listeners to first PO line item'); // DEBUG
                const itemSelect = firstPORow.querySelector('.po-item');
                const qtyInput = firstPORow.querySelector('.po-qty');
                const costInput = firstPORow.querySelector('.po-cost');
                const removeBtn = firstPORow.querySelector('.remove-btn');
                
                if (itemSelect) {
                    itemSelect.addEventListener('change', function() {
                        console.log('First PO row CHANGE EVENT FIRED!'); // DEBUG
                        updatePOItemInfo(this);
                    });
                }
                
                if (qtyInput) {
                    qtyInput.addEventListener('input', function() {
                        calculatePOTotal();
                    });
                }
                
                if (costInput) {
                    costInput.addEventListener('input', function() {
                        calculatePOTotal();
                    });
                }
                
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        removeLineItem(this);
                        calculatePOTotal();
                    });
                }
                console.log('First PO row listeners attached!'); // DEBUG
            }
            
            // Minimal pull-to-refresh prevention (only at very top)
            let lastTouchY = 0;
            
            document.body.addEventListener('touchstart', function(e) {
                if (e.touches.length !== 1) return;
                lastTouchY = e.touches[0].clientY;
            }, { passive: true });
            
            document.body.addEventListener('touchmove', function(e) {
                const touchY = e.touches[0].clientY;
                const touchYDelta = touchY - lastTouchY;
                lastTouchY = touchY;
                
                // Only prevent if at absolute top AND pulling down
                if (window.pageYOffset === 0 && touchYDelta > 0) {
                    e.preventDefault();
                }
            }, { passive: false });
        });

        // Navigation history for back button
        let navigationHistory = ['suppliers'];
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            // Add to history (avoid duplicates of current tab)
            if (navigationHistory[navigationHistory.length - 1] !== tabName) {
                navigationHistory.push(tabName);
                // Keep only last 20 tabs in history
                if (navigationHistory.length > 20) {
                    navigationHistory.shift();
                }
            }
            
            // Show/hide Back button based on history length
            const backBtn = document.getElementById('backBtn');
            if (navigationHistory.length > 1) {
                backBtn.style.display = 'block';
            } else {
                backBtn.style.display = 'none';
            }
            
            // Check if we need to restore PO form when switching to purchases
            if (tabName === 'purchases') {
                checkAndRestorePOForm();
            }
            
            // Load price sim items when switching to that tab
            if (tabName === 'pricesim') {
                loadPriceSimItems();
            }
            
            // Scroll to top when switching tabs
            window.scrollTo(0, 0);
        }
        
        function goBack() {
            // Remove current tab from history
            if (navigationHistory.length > 1) {
                navigationHistory.pop();
                const previousTab = navigationHistory[navigationHistory.length - 1];
                
                // Switch to previous tab
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                
                document.getElementById(previousTab).classList.add('active');
                
                // Highlight the correct tab button
                const tabButtons = document.querySelectorAll('.tabs .tab');
                tabButtons.forEach(btn => {
                    if (btn.textContent.toLowerCase().includes(previousTab.substring(0, 4))) {
                        btn.classList.add('active');
                    }
                });
                
                window.scrollTo(0, 0);
                
                // Check if we need to restore PO form state
                checkAndRestorePOForm();
            }
            
            // Hide Back button if only one tab in history
            const backBtn = document.getElementById('backBtn');
            if (navigationHistory.length <= 1) {
                backBtn.style.display = 'none';
            }
        }
        
        function checkAndRestorePOForm() {
            const savedState = localStorage.getItem('poFormState');
            if (savedState) {
                const state = JSON.parse(savedState);
                if (state.returnToPO) {
                    // Show a notification
                    const currentTab = document.querySelector('.card.active');
                    if (currentTab && currentTab.id === 'purchases') {
                        setTimeout(() => {
                            if (confirm('Resume your purchase order entry?')) {
                                showAddPurchaseForm();
                                
                                // Restore form fields
                                setTimeout(() => {
                                    if (state.supplier) document.getElementById('poSupplier').value = state.supplier;
                                    if (state.invoiceNumber) document.getElementById('poInvoiceNumber').value = state.invoiceNumber;
                                    if (state.purchaseDate) document.getElementById('poPurchaseDate').value = state.purchaseDate;
                                    if (state.dueDate) document.getElementById('poDueDate').value = state.dueDate;
                                    if (state.paymentTerms) document.getElementById('poPaymentTerms').value = state.paymentTerms;
                                    if (state.status) document.getElementById('poStatus').value = state.status;
                                    if (state.amountPaid) document.getElementById('poAmountPaid').value = state.amountPaid;
                                    if (state.notes) document.getElementById('poNotes').value = state.notes;
                                    
                                    // Reload supplier items
                                    if (state.supplier) {
                                        loadSupplierItems();
                                    }
                                    
                                    showStatus('purchaseStatus', '‚úÖ Purchase order form restored! The new item should now be available in the dropdown.', 'success');
                                }, 200);
                            }
                            
                            // Clear saved state
                            localStorage.removeItem('poFormState');
                        }, 500);
                    }
                }
            }
        }
        
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // Toggle collapsible sections (Quick Guides, Entry Forms)
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId + '-toggle');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                if (toggle) toggle.textContent = '‚ñº Hide';
            } else {
                section.style.display = 'none';
                if (toggle) toggle.textContent = '‚ñ∂ Show';
            }
        }
        
        // Show/hide back to top button based on scroll position
        window.addEventListener('scroll', function() {
            const backToTopBtn = document.getElementById('backToTopBtn');
            if (window.pageYOffset > 300) {
                backToTopBtn.style.display = 'block';
            } else {
                backToTopBtn.style.display = 'none';
            }
        });
        
        function goToAddItem() {
            // Switch to Items tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent.includes('Items')) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            document.getElementById('items').classList.add('active');
            
            // Open the Add Item form
            showAddItemForm();
            
            // Scroll to top of page
            window.scrollTo(0, 0);
        }
        
        function addNewItemFromPO() {
            // Get current supplier from PO form
            const currentSupplier = document.getElementById('poSupplier')?.value;
            
            if (!currentSupplier) {
                alert('Please select a supplier first before adding items');
                return;
            }
            
            // Save PO form state to localStorage for later restoration
            const poFormState = {
                supplier: currentSupplier,
                invoiceNumber: document.getElementById('poInvoiceNumber')?.value,
                purchaseDate: document.getElementById('poPurchaseDate')?.value,
                dueDate: document.getElementById('poDueDate')?.value,
                paymentTerms: document.getElementById('poPaymentTerms')?.value,
                status: document.getElementById('poStatus')?.value,
                amountPaid: document.getElementById('poAmountPaid')?.value,
                notes: document.getElementById('poNotes')?.value,
                returnToPO: true
            };
            localStorage.setItem('poFormState', JSON.stringify(poFormState));
            
            // Switch to Items tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent.includes('Items')) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            document.getElementById('items').classList.add('active');
            
            // Open Add Item form
            showAddItemForm();
            
            // Pre-select supplier if one was selected in PO
            setTimeout(() => {
                const supplierSelect = document.getElementById('itemSupplier');
                if (supplierSelect) {
                    supplierSelect.value = currentSupplier;
                }
            }, 100);
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            // Show helper message
            setTimeout(() => {
                showStatus('itemStatus', 'üí° After saving the item, click "‚¨ÖÔ∏è Back" to return to your purchase order', 'info');
            }, 200);
        }

        function updateConfigStatus() {
            const statusEl = document.getElementById('configStatusText');
            const apiInput = document.getElementById('apiUrl');
            
            if (API_URL) {
                apiInput.value = API_URL;
                statusEl.innerHTML = '‚úÖ API configured and ready!';
                statusEl.style.color = '#2e7d32';
            } else {
                statusEl.innerHTML = '‚ö†Ô∏è Not configured - enter API URL above';
                statusEl.style.color = '#f57c00';
            }
        }

        function changeTheme() {
            const theme = document.getElementById('themeSelector').value;
            const body = document.body;
            
            // Remove all existing theme classes
            body.classList.remove('theme-purple', 'theme-ocean', 'theme-forest', 'theme-sunset', 'theme-dark', 'theme-crimson', 'theme-slate', 'theme-teal', 'theme-bears', 'theme-cubs', 'theme-bulls', 'theme-blackhawks', 'theme-packers');
            
            // Add new theme class
            body.classList.add('theme-' + theme);
            
            // Save preference
            localStorage.setItem('theme', theme);
            showStatus('configStatus', `‚úÖ Theme changed to ${theme}!`, 'success');
        }
        
        // Get theme colors for print templates
        function getThemeColors() {
            const theme = localStorage.getItem('theme') || 'purple';
            const themes = {
                purple: { primary: '#667eea', accent: '#764ba2', text: '#667eea' },
                ocean: { primary: '#0077b6', accent: '#00b4d8', text: '#0077b6' },
                forest: { primary: '#2d6a4f', accent: '#40916c', text: '#2d6a4f' },
                sunset: { primary: '#e85d04', accent: '#f48c06', text: '#e85d04' },
                dark: { primary: '#1e293b', accent: '#334155', text: '#1e293b' },
                crimson: { primary: '#be123c', accent: '#e11d48', text: '#be123c' },
                slate: { primary: '#475569', accent: '#64748b', text: '#475569' },
                teal: { primary: '#0d9488', accent: '#14b8a6', text: '#0d9488' },
                bears: { primary: '#0B162A', accent: '#C83803', text: '#C83803' },
                cubs: { primary: '#0E3386', accent: '#CC3433', text: '#CC3433' },
                bulls: { primary: '#121212', accent: '#CE1141', text: '#CE1141' },
                blackhawks: { primary: '#002F6C', accent: '#CF0A2C', text: '#CF0A2C' },
                packers: { primary: '#203731', accent: '#FFB612', text: '#FFB612' }
            };
            return themes[theme] || themes.purple;
        }
        
        function openBackup() {
            if (!API_URL) {
                alert('Please configure your API URL first!');
                return;
            }
            // Extract the Google Sheets URL from API URL pattern
            alert('To backup your data:\n\n1. Go to your Google Sheets database\n2. File ‚Üí Make a copy\n3. Download as Excel or CSV\n\nYour Google Sheet contains all your data!');
        }
        
        // Load theme on startup
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'purple';
            document.getElementById('themeSelector').value = savedTheme;
            document.body.classList.remove('theme-purple', 'theme-ocean', 'theme-forest', 'theme-sunset', 'theme-dark', 'theme-crimson', 'theme-slate', 'theme-teal', 'theme-bears', 'theme-cubs', 'theme-bulls', 'theme-blackhawks', 'theme-packers');
            document.body.classList.add('theme-' + savedTheme);
        });
        
        function saveConfig() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const status = document.getElementById('configStatus');
            
            if (!apiUrl) {
                showStatus('configStatus', 'Please enter an API URL', 'error');
                return;
            }
            
            API_URL = apiUrl;
            localStorage.setItem('apiUrl', apiUrl);
            updateConfigStatus();
            
            showStatus('configStatus', '‚úÖ Configuration saved!', 'success');
        }
        
        // Save Invoice Settings
        function saveInvoiceSettings() {
            const settings = {
                companyName: document.getElementById('invoiceCompanyName').value,
                contactName: document.getElementById('invoiceContactName').value,
                phone: document.getElementById('invoicePhone').value,
                email: document.getElementById('invoiceEmail').value,
                address1: document.getElementById('invoiceAddress1').value,
                address2: document.getElementById('invoiceAddress2').value,
                cityStateZip: document.getElementById('invoiceCityStateZip').value,
                footer: document.getElementById('invoiceFooter').value,
                signatureLine: document.getElementById('invoiceSignatureLine').checked
            };
            
            localStorage.setItem('invoiceSettings', JSON.stringify(settings));
            showStatus('configStatus', '‚úÖ Invoice settings saved!', 'success');
        }
        
        // Load Invoice Settings
        function loadInvoiceSettings() {
            const saved = localStorage.getItem('invoiceSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('invoiceCompanyName').value = settings.companyName || '';
                document.getElementById('invoiceContactName').value = settings.contactName || '';
                document.getElementById('invoicePhone').value = settings.phone || '';
                document.getElementById('invoiceEmail').value = settings.email || '';
                document.getElementById('invoiceAddress1').value = settings.address1 || '';
                document.getElementById('invoiceAddress2').value = settings.address2 || '';
                document.getElementById('invoiceCityStateZip').value = settings.cityStateZip || '';
                document.getElementById('invoiceFooter').value = settings.footer || '';
                document.getElementById('invoiceSignatureLine').checked = settings.signatureLine !== false;
            }
        }
        
        // Get Invoice Settings
        function getInvoiceSettings() {
            const saved = localStorage.getItem('invoiceSettings');
            if (saved) {
                return JSON.parse(saved);
            }
            return {
                companyName: 'Nowak Distributing',
                contactName: '',
                phone: '(920)634-4351',
                email: 'jnowaksnfoodistributors@gmail.com',
                address1: '',
                address2: '',
                cityStateZip: '',
                footer: 'Thank you for doing business with us!',
                signatureLine: true
            };
        }

        // Format phone number as (999) 999-9999
        function formatPhone(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            if (value.length > 10) value = value.slice(0, 10);
            
            if (value.length >= 6) {
                input.value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6)}`;
            } else if (value.length >= 3) {
                input.value = `(${value.slice(0,3)}) ${value.slice(3)}`;
            } else if (value.length > 0) {
                input.value = `(${value}`;
            }
        }
        
        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        async function apiCall(action, data = {}) {
            if (!API_URL) {
                alert('Please configure your API URL in Settings first!');
                switchTab('config');
                return null;
            }

            try {
                // Use GET with query parameters to avoid CORS preflight
                const params = new URLSearchParams({
                    action: action,
                    data: JSON.stringify(data)
                });
                
                const url = `${API_URL}?${params.toString()}`;
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                });

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('API Error:', error);
                return { status: 'error', message: error.toString() };
            }
        }

        // ==================== SUPPLIERS ====================

        function showAddSupplierForm() {
            document.getElementById('addSupplierForm').style.display = 'block';
        }

        function hideAddSupplierForm() {
            document.getElementById('addSupplierForm').style.display = 'none';
            document.querySelector('#addSupplierForm form').reset();
        }

        async function addSupplier(e) {
            e.preventDefault();
            
            const data = {
                supplierName: document.getElementById('newSupplierName').value,
                contactName: document.getElementById('newContactName').value,
                phone: document.getElementById('newPhone').value,
                email: document.getElementById('newEmail').value,
                address: document.getElementById('newAddress').value,
                city: document.getElementById('newCity').value,
                state: document.getElementById('newState').value,
                zip: document.getElementById('newZip').value,
                paymentTerms: document.getElementById('newPaymentTerms').value,
                notes: document.getElementById('newNotes').value
            };

            const result = await apiCall('addSupplier', data);
            
            if (result && result.status === 'success') {
                showStatus('suppliersStatus', '‚úÖ Supplier added successfully!', 'success');
                hideAddSupplierForm();
                loadSuppliers();
            } else {
                showStatus('suppliersStatus', '‚ùå Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        async function loadSuppliers() {
            document.getElementById('suppliersTable').innerHTML = '<div class="loading">Loading suppliers...</div>';
            
            const result = await apiCall('getSuppliers');
            
            if (result && result.status === 'success') {
                cachedSuppliers = result.data;
                displaySuppliers(result.data);
                
                // Populate Create PO supplier dropdown
                const createPOSupplierSelect = document.getElementById('createPOSupplier');
                if (createPOSupplierSelect) {
                    createPOSupplierSelect.innerHTML = '<option value="">Select Supplier...</option>';
                    result.data.forEach(supplier => {
                        const option = document.createElement('option');
                        option.value = supplier.Supplier_ID;
                        option.textContent = supplier.Supplier_Name;
                        createPOSupplierSelect.appendChild(option);
                    });
                }
            } else {
                document.getElementById('suppliersTable').innerHTML = '<div class="loading">Error loading suppliers</div>';
            }
        }

        function displaySuppliers(suppliers) {
            if (!suppliers || suppliers.length === 0) {
                document.getElementById('suppliersTable').innerHTML = '<p>No suppliers yet. Add your first supplier!</p>';
                return;
            }

            let html = '<table class="data-table" id="suppliersDataTable"><thead><tr>';
            html += '<th>Name</th><th>Contact</th><th>Phone</th><th>Email</th><th>City</th><th>Payment Terms</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            suppliers.forEach(s => {
                html += `<tr style="cursor: pointer;" onclick='editSupplier(${JSON.stringify(s).replace(/'/g, "&#39;")})' onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                    <td><strong>${s.Supplier_Name}</strong></td>
                    <td>${s.Contact_Name || '-'}</td>
                    <td>${s.Phone || '-'}</td>
                    <td>${s.Email || '-'}</td>
                    <td>${s.City || '-'}, ${s.State || '-'}</td>
                    <td>${s.Payment_Terms || '-'}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="btn-delete-icon" onclick="deleteSupplier('${s.Supplier_ID}', '${s.Supplier_Name}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('suppliersTable').innerHTML = html;
            
            // Make table sortable
            setTimeout(() => makeSortable('suppliersDataTable'), 0);
        }
        
        // Filter suppliers
        function filterSuppliers() {
            const nameFilter = document.getElementById('filterSupplierName').value.toLowerCase();
            const cityFilter = document.getElementById('filterSupplierCity').value.toLowerCase();
            const stateFilter = document.getElementById('filterSupplierState').value.toLowerCase();
            
            const filtered = cachedSuppliers.filter(s => {
                const matchesName = !nameFilter || (s.Supplier_Name && s.Supplier_Name.toLowerCase().includes(nameFilter));
                const matchesCity = !cityFilter || (s.City && s.City.toLowerCase().includes(cityFilter));
                const matchesState = !stateFilter || (s.State && s.State.toLowerCase().includes(stateFilter));
                return matchesName && matchesCity && matchesState;
            });
            
            displaySuppliers(filtered);
        }
        
        function clearSupplierFilters() {
            document.getElementById('filterSupplierName').value = '';
            document.getElementById('filterSupplierCity').value = '';
            document.getElementById('filterSupplierState').value = '';
            displaySuppliers(cachedSuppliers);
        }
        
        // Edit supplier
        function editSupplier(supplier) {
            document.getElementById('editSupplierId').value = supplier.Supplier_ID;
            document.getElementById('editSupplierName').value = supplier.Supplier_Name || '';
            document.getElementById('editContactName').value = supplier.Contact_Name || '';
            document.getElementById('editPhone').value = supplier.Phone || '';
            document.getElementById('editEmail').value = supplier.Email || '';
            document.getElementById('editAddress').value = supplier.Address || '';
            document.getElementById('editCity').value = supplier.City || '';
            document.getElementById('editState').value = supplier.State || '';
            document.getElementById('editZip').value = supplier.ZIP || '';
            document.getElementById('editPaymentTerms').value = supplier.Payment_Terms || 'Net 30';
            document.getElementById('editNotes').value = supplier.Notes || '';
            
            document.getElementById('editSupplierForm').style.display = 'block';
            document.getElementById('addSupplierForm').style.display = 'none';
        }
        
        function hideEditSupplierForm() {
            document.getElementById('editSupplierForm').style.display = 'none';
            document.querySelector('#editSupplierForm form').reset();
            
            // Return to previous tab if we came from Reports
            if (returnToTab === 'reports') {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="reports"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('reports').classList.add('active');
                returnToTab = null;
            }
        }
        
        async function updateSupplier(e) {
            e.preventDefault();
            
            const data = {
                supplierId: document.getElementById('editSupplierId').value,
                name: document.getElementById('editSupplierName').value,
                address: document.getElementById('editAddress').value,
                city: document.getElementById('editCity').value,
                state: document.getElementById('editState').value,
                zip: document.getElementById('editZip').value,
                contactName: document.getElementById('editContactName').value,
                phone: document.getElementById('editPhone').value,
                fax: '',
                email: document.getElementById('editEmail').value,
                paymentTerms: document.getElementById('editPaymentTerms').value,
                notes: document.getElementById('editNotes').value
            };
            
            const result = await apiCall('updateSupplier', data);
            
            if (result && result.status === 'success') {
                showStatus('suppliersStatus', '‚úÖ Supplier updated successfully!', 'success');
                hideEditSupplierForm();
                loadSuppliers();
            } else {
                showStatus('suppliersStatus', '‚ùå Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        async function deleteSupplier(supplierId, supplierName) {
            if (!confirm(`Are you sure you want to delete supplier "${supplierName}"?\n\nThis cannot be undone!`)) {
                return;
            }
            
            const result = await apiCall('deleteSupplier', { supplierId });
            
            if (result && result.status === 'success') {
                showStatus('suppliersStatus', '‚úÖ Supplier deleted successfully!', 'success');
                loadSuppliers();
            } else {
                showStatus('suppliersStatus', '‚ùå Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        // ==================== ITEMS ====================

        function showAddItemForm() {
            loadSuppliersList();
            document.getElementById('addItemForm').style.display = 'block';
        }

        function hideAddItemForm() {
            document.getElementById('addItemForm').style.display = 'none';
            document.querySelector('#addItemForm form').reset();
        }

        async function loadSuppliersList() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }

            const select = document.getElementById('newItemSupplier');
            select.innerHTML = '<option value="">Select Supplier</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }

        // Calculate unit cost in Add Item form
        function calculateUnitCost() {
            const packageCost = parseFloat(document.getElementById('newPackageCost').value) || 0;
            const unitsPerPackage = parseFloat(document.getElementById('newUnitsPerPackage').value) || 1;
            const unitCost = packageCost / unitsPerPackage;
            document.getElementById('calculatedUnitCost').value = '$' + unitCost.toFixed(2);
        }
        
        // Calculate unit cost in Edit Item form
        function calculateEditUnitCost() {
            const packageCost = parseFloat(document.getElementById('editPackageCost').value) || 0;
            const unitsPerPackage = parseFloat(document.getElementById('editUnitsPerPackage').value) || 1;
            const unitCost = packageCost / unitsPerPackage;
            document.getElementById('calculatedEditUnitCost').value = '$' + unitCost.toFixed(2);
        }
        
        async function addItem(e) {
            e.preventDefault();
            
            const data = {
                supplierId: document.getElementById('newItemSupplier').value,
                description: document.getElementById('newItemDescription').value,
                purchaseUOM: document.getElementById('newItemPurchaseUOM').value,
                unitsPerPackage: document.getElementById('newUnitsPerPackage').value,
                packageCost: document.getElementById('newPackageCost').value,
                unitSellPrice: document.getElementById('newUnitSellPrice').value,
                qtyOnHand: document.getElementById('newQtyOnHand').value,
                reorderPoint: document.getElementById('newReorderPoint').value,
                sku: document.getElementById('newItemSKU').value,
                notes: document.getElementById('newItemNotes').value
            };

            const result = await apiCall('addItem', data);
            
            if (result && result.status === 'success') {
                showStatus('itemsStatus', '‚úÖ Item added successfully!', 'success');
                hideAddItemForm();
                loadItems();
            } else {
                showStatus('itemsStatus', '‚ùå Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        async function loadItems() {
            document.getElementById('itemsTable').innerHTML = '<div class="loading">Loading items...</div>';
            
            const result = await apiCall('getItems');
            
            if (result && result.status === 'success') {
                cachedItems = result.data;
                
                // DEBUG: Log the first item to see what properties it actually has
                if (cachedItems.length > 0) {
                    console.log('=== ITEM DATA STRUCTURE DEBUG ===');
                    console.log('First item keys:', Object.keys(cachedItems[0]));
                    console.log('First item full data:', cachedItems[0]);
                    console.log('Unit_Sell_Price:', cachedItems[0].Unit_Sell_Price);
                    console.log('Sell_Price:', cachedItems[0].Sell_Price);
                    console.log('=================================');
                }
                
                displayItems(result.data);
                loadItemFilterSuppliers();
            } else {
                document.getElementById('itemsTable').innerHTML = '<div class="loading">Error loading items</div>';
            }
        }

        function displayItems(items) {
            if (!items || items.length === 0) {
                document.getElementById('itemsTable').innerHTML = '<p>No items yet. Add your first item!</p>';
                return;
            }

            // Calculate totals
            let totalQty = 0;
            
            let html = '<table class="data-table" id="itemsDataTable"><thead><tr>';
            html += '<th>SKU</th><th>Description</th><th>Supplier</th><th>UOM</th><th>Units/Pkg</th><th>Pkg Cost</th><th>Unit Cost</th><th>Sell Price</th><th>Qty</th><th>On Order</th><th>Reorder</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            items.forEach(item => {
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const qtyOnOrder = parseFloat(item.Qty_On_Order) || 0;
                const unitsPerPkg = parseFloat(item.Units_Per_Package) || 1;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitCost = packageCost / unitsPerPkg;
                const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                const packages = (qty / unitsPerPkg).toFixed(1);
                const packagesOnOrder = (qtyOnOrder / unitsPerPkg).toFixed(1);
                
                // Determine row styling based on stock status
                let rowBg = '';
                let qtyStyle = '';
                if (qty < 0) {
                    rowBg = 'background:#ffcdd2;';  // Red for negative
                    qtyStyle = 'color: #b71c1c; font-weight: bold;';
                } else if (qty <= reorderPoint) {
                    rowBg = 'background:#fff3cd;';  // Yellow for low stock
                }
                
                totalQty += qty;
                
                html += `<tr style="${rowBg} cursor: pointer;" onclick="editItemById('${item.Item_ID}')" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
                    <td><strong>${item.SKU || '-'}</strong></td>
                    <td>${item.Item_Description}</td>
                    <td>${getSupplierName(item.Supplier_ID)}</td>
                    <td>${item.Purchase_UOM}</td>
                    <td>${unitsPerPkg}</td>
                    <td>$${packageCost.toFixed(2)}</td>
                    <td>$${unitCost.toFixed(2)}</td>
                    <td style="color: #28a745; font-weight: bold;">$${unitSellPrice.toFixed(2)}</td>
                    <td style="${qtyStyle}">${qty.toFixed(0)}</td>
                    <td><span style="background: ${qtyOnOrder > 0 ? '#ffc107' : '#e0e0e0'}; padding: 3px 8px; border-radius: 4px; font-weight: bold;">${qtyOnOrder > 0 ? qtyOnOrder : '-'}</span></td>
                    <td>${item.Reorder_Point || 0}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="btn-delete-icon" onclick="deleteItem('${item.Item_ID}', '${item.Item_Description.replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });

            // Add totals row
            html += `<tr style="background: #f0f0f0; font-weight: bold; border-top: 3px solid #667eea;">
                <td colspan="8" style="text-align: right; padding-right: 20px;">TOTALS:</td>
                <td>${totalQty.toLocaleString()}</td>
                <td colspan="3"></td>
            </tr>`;

            html += '</tbody></table>';
            document.getElementById('itemsTable').innerHTML = html;
            setTimeout(() => makeSortable('itemsDataTable'), 0);
        }
        
        // Filter items
        async function filterItems() {
            const searchFilter = document.getElementById('filterItemSearch').value.toLowerCase().trim();
            const supplierFilter = document.getElementById('filterItemSupplier').value;
            const stockFilter = document.getElementById('filterItemStock').value;
            
            // Ensure items are loaded
            if (cachedItems.length === 0) {
                await loadItems();
                return;
            }
            
            const filtered = cachedItems.filter(item => {
                const matchesSearch = !searchFilter || 
                    (item.SKU && item.SKU.toString().toLowerCase().includes(searchFilter)) ||
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(searchFilter));
                const matchesSupplier = !supplierFilter || item.Supplier_ID === supplierFilter;
                
                // Stock status calculations
                const qtyOnHand = parseFloat(item.Qty_On_Hand) || 0;
                const qtyOnOrder = parseFloat(item.Qty_On_Order) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                const negativeStock = qtyOnHand < 0;
                const lowStock = qtyOnHand <= reorderPoint && qtyOnHand >= 0;
                const hasOnOrder = qtyOnOrder > 0;
                const needsReorder = (lowStock || negativeStock) && !hasOnOrder;
                
                let matchesStock = true;
                if (stockFilter === 'negative') {
                    matchesStock = negativeStock;
                } else if (stockFilter === 'low') {
                    matchesStock = lowStock || negativeStock;
                } else if (stockFilter === 'onorder') {
                    matchesStock = hasOnOrder;
                } else if (stockFilter === 'reorder') {
                    matchesStock = needsReorder;
                } else if (stockFilter === 'ok') {
                    matchesStock = qtyOnHand > reorderPoint;
                }
                
                return matchesSearch && matchesSupplier && matchesStock;
            });
            
            displayItems(filtered);
        }
        
        async function clearItemFilters() {
            document.getElementById('filterItemSearch').value = '';
            document.getElementById('filterItemSupplier').value = '';
            document.getElementById('filterItemStock').value = '';
            displayItems(cachedItems);
        }
        
        async function loadItemFilterSuppliers() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }
            
            const select = document.getElementById('filterItemSupplier');
            select.innerHTML = '<option value="">All Suppliers</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }
        
        // Helper function to edit by ID
        function editItemById(itemId) {
            const item = cachedItems.find(i => i.Item_ID === itemId);
            if (item) {
                editItem(item);
            }
        }
        
        // Edit item
        async function editItem(item) {
            // Hide add form first
            document.getElementById('addItemForm').style.display = 'none';
            
            // Load suppliers for dropdown
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }
            
            const select = document.getElementById('editItemSupplier');
            select.innerHTML = '<option value="">Select Supplier</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
            
            document.getElementById('editItemId').value = item.Item_ID;
            document.getElementById('editItemSupplier').value = item.Supplier_ID || '';
            document.getElementById('editItemDescription').value = item.Item_Description || '';
            document.getElementById('editItemSKU').value = item.SKU || '';
            document.getElementById('editItemPurchaseUOM').value = item.Purchase_UOM || 'Box';
            document.getElementById('editUnitsPerPackage').value = item.Units_Per_Package || 1;
            document.getElementById('editPackageCost').value = item.Package_Cost || '';
            document.getElementById('editUnitSellPrice').value = item.Unit_Sell_Price || '';
            document.getElementById('editQtyOnHand').value = item.Qty_On_Hand || '';
            document.getElementById('editReorderPoint').value = item.Reorder_Point || '';
            document.getElementById('editItemNotes').value = item.Notes || '';
            
            // Calculate unit cost for display
            calculateEditUnitCost();
            
            document.getElementById('editItemForm').style.display = 'block';
            
            // Scroll to the edit form
            document.getElementById('editItemForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function hideEditItemForm() {
            document.getElementById('editItemForm').style.display = 'none';
            document.querySelector('#editItemForm form').reset();
            
            // Return to previous tab if we came from Reports
            if (returnToTab === 'reports') {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="reports"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('reports').classList.add('active');
                returnToTab = null;
            }
        }
        
        async function updateItem(e) {
            e.preventDefault();
            
            const data = {
                itemId: document.getElementById('editItemId').value,
                supplierId: document.getElementById('editItemSupplier').value,
                description: document.getElementById('editItemDescription').value,
                purchaseUOM: document.getElementById('editItemPurchaseUOM').value,
                unitsPerPackage: document.getElementById('editUnitsPerPackage').value,
                packageCost: document.getElementById('editPackageCost').value,
                unitSellPrice: document.getElementById('editUnitSellPrice').value,
                reorderPoint: document.getElementById('editReorderPoint').value,
                sku: document.getElementById('editItemSKU').value,
                notes: document.getElementById('editItemNotes').value
            };
            
            const result = await apiCall('updateItem', data);
            
            if (result && result.status === 'success') {
                showStatus('itemsStatus', '‚úÖ Item updated successfully!', 'success');
                hideEditItemForm();
                loadItems();
            } else {
                showStatus('itemsStatus', '‚ùå Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        async function deleteItem(itemId, itemDesc) {
            if (!confirm(`Are you sure you want to delete item "${itemDesc}"?\n\nThis cannot be undone!`)) {
                return;
            }
            
            const result = await apiCall('deleteItem', { itemId });
            
            if (result && result.status === 'success') {
                showStatus('itemsStatus', '‚úÖ Item deleted successfully!', 'success');
                loadItems();
            } else {
                showStatus('itemsStatus', '‚ùå Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        // ==================== CUSTOMERS ====================

        function showAddCustomerForm() {
            document.getElementById('addCustomerForm').style.display = 'block';
        }

        function hideAddCustomerForm() {
            document.getElementById('addCustomerForm').style.display = 'none';
            document.querySelector('#addCustomerForm form').reset();
        }

        async function addCustomer(e) {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('newCustomerName').value,
                contactName: document.getElementById('newCustomerContact').value,
                phone: document.getElementById('newCustomerPhone').value,
                mobile: document.getElementById('newCustomerMobile').value,
                email: document.getElementById('newCustomerEmail').value,
                address: document.getElementById('newCustomerAddress').value,
                city: document.getElementById('newCustomerCity').value,
                state: document.getElementById('newCustomerState').value,
                zip: document.getElementById('newCustomerZip').value,
                creditLimit: document.getElementById('newCreditLimit').value,
                paymentTerms: document.getElementById('newCustomerPaymentTerms').value,
                notes: document.getElementById('newCustomerNotes').value
            };

            const result = await apiCall('addCustomer', data);
            
            if (result && result.status === 'success') {
                showStatus('customersStatus', '‚úÖ Customer added successfully!', 'success');
                hideAddCustomerForm();
                loadCustomers();
            } else {
                showStatus('customersStatus', '‚ùå Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        async function loadCustomers() {
            document.getElementById('customersTable').innerHTML = '<div class="loading">Loading customers...</div>';
            
            const result = await apiCall('getCustomers');
            
            if (result && result.status === 'success') {
                cachedCustomers = result.data;
                displayCustomers(result.data);
            } else {
                document.getElementById('customersTable').innerHTML = '<div class="loading">Error loading customers</div>';
            }
        }

        function displayCustomers(customers) {
            if (!customers || customers.length === 0) {
                document.getElementById('customersTable').innerHTML = '<p>No customers yet. Add your first customer!</p>';
                return;
            }

            let html = '<table class="data-table" id="customersDataTable"><thead><tr>';
            html += '<th>Name</th><th>Contact</th><th>Phone</th><th>Email</th><th>City</th><th>Credit Limit</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            customers.forEach(c => {
                html += `<tr style="cursor: pointer;" onclick='editCustomer(${JSON.stringify(c).replace(/'/g, "&#39;")})' onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                    <td><strong>${c.Customer_Name}</strong></td>
                    <td>${c.Contact_Name || '-'}</td>
                    <td>${c.Phone || '-'}</td>
                    <td>${c.Email || '-'}</td>
                    <td>${c.City || '-'}, ${c.State || '-'}</td>
                    <td>$${parseFloat(c.Credit_Limit || 0).toFixed(2)}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="btn-delete-icon" onclick="deleteCustomer('${c.Customer_ID}', '${c.Customer_Name}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('customersTable').innerHTML = html;
            setTimeout(() => makeSortable('customersDataTable'), 0);
        }
        
        // Filter customers
        function filterCustomers() {
            const nameFilter = document.getElementById('filterCustomerName').value.toLowerCase();
            const contactFilter = document.getElementById('filterCustomerContact').value.toLowerCase();
            const cityFilter = document.getElementById('filterCustomerCity').value.toLowerCase();
            const stateFilter = document.getElementById('filterCustomerState').value.toLowerCase();
            
            const filtered = cachedCustomers.filter(c => {
                const matchesName = !nameFilter || (c.Customer_Name && c.Customer_Name.toLowerCase().includes(nameFilter));
                const matchesContact = !contactFilter || (c.Contact_Name && c.Contact_Name.toLowerCase().includes(contactFilter));
                const matchesCity = !cityFilter || (c.City && c.City.toLowerCase().includes(cityFilter));
                const matchesState = !stateFilter || (c.State && c.State.toLowerCase().includes(stateFilter));
                return matchesName && matchesContact && matchesCity && matchesState;
            });
            
            displayCustomers(filtered);
        }
        
        function clearCustomerFilters() {
            document.getElementById('filterCustomerName').value = '';
            document.getElementById('filterCustomerContact').value = '';
            document.getElementById('filterCustomerCity').value = '';
            document.getElementById('filterCustomerState').value = '';
            displayCustomers(cachedCustomers);
        }
        
        // Edit customer
        function editCustomer(customer) {
            document.getElementById('editCustomerId').value = customer.Customer_ID;
            document.getElementById('editCustomerName').value = customer.Customer_Name || '';
            document.getElementById('editCustomerContact').value = customer.Contact_Name || '';
            document.getElementById('editCustomerPhone').value = customer.Phone || '';
            document.getElementById('editCustomerMobile').value = customer.Mobile || '';
            document.getElementById('editCustomerEmail').value = customer.Email || '';
            document.getElementById('editCustomerAddress').value = customer.Address || '';
            document.getElementById('editCustomerCity').value = customer.City || '';
            document.getElementById('editCustomerState').value = customer.State || '';
            document.getElementById('editCustomerZip').value = customer.ZIP || '';
            document.getElementById('editCreditLimit').value = customer.Credit_Limit || '';
            document.getElementById('editCustomerPaymentTerms').value = customer.Payment_Terms || 'Net 30';
            document.getElementById('editCustomerNotes').value = customer.Notes || '';
            
            document.getElementById('editCustomerForm').style.display = 'block';
            document.getElementById('addCustomerForm').style.display = 'none';
        }
        
        function hideEditCustomerForm() {
            document.getElementById('editCustomerForm').style.display = 'none';
            document.querySelector('#editCustomerForm form').reset();
            
            // Return to previous tab if we came from Reports
            if (returnToTab === 'reports') {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="reports"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('reports').classList.add('active');
                returnToTab = null;
            }
        }
        
        async function updateCustomer(e) {
            e.preventDefault();
            
            const data = {
                customerId: document.getElementById('editCustomerId').value,
                name: document.getElementById('editCustomerName').value,
                address: document.getElementById('editCustomerAddress').value,
                city: document.getElementById('editCustomerCity').value,
                state: document.getElementById('editCustomerState').value,
                zip: document.getElementById('editCustomerZip').value,
                contactName: document.getElementById('editCustomerContact').value,
                phone: document.getElementById('editCustomerPhone').value,
                mobile: document.getElementById('editCustomerMobile').value,
                email: document.getElementById('editCustomerEmail').value,
                creditLimit: document.getElementById('editCreditLimit').value,
                paymentTerms: document.getElementById('editCustomerPaymentTerms').value,
                notes: document.getElementById('editCustomerNotes').value
            };
            
            const result = await apiCall('updateCustomer', data);
            
            if (result && result.status === 'success') {
                showStatus('customersStatus', '‚úÖ Customer updated successfully!', 'success');
                hideEditCustomerForm();
                loadCustomers();
            } else {
                showStatus('customersStatus', '‚ùå Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        async function deleteCustomer(customerId, customerName) {
            if (!confirm(`Are you sure you want to delete customer "${customerName}"?\n\nThis cannot be undone!`)) {
                return;
            }
            
            const result = await apiCall('deleteCustomer', { customerId });
            
            if (result && result.status === 'success') {
                showStatus('customersStatus', '‚úÖ Customer deleted successfully!', 'success');
                loadCustomers();
            } else {
                showStatus('customersStatus', '‚ùå Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        // ==================== PURCHASES ====================

        function showAddPurchaseForm() {
            loadPurchaseDropdowns();
            document.getElementById('addPurchaseForm').style.display = 'block';
        }

        function hideAddPurchaseForm() {
            document.getElementById('addPurchaseForm').style.display = 'none';
            document.querySelector('#addPurchaseForm form').reset();
        }

        async function loadPurchaseDropdowns() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }

            const select = document.getElementById('poSupplier');
            select.innerHTML = '<option value="">Select Supplier</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }

        async function loadSupplierItems() {
            const supplierId = document.getElementById('poSupplier').value;
            
            if (cachedItems.length === 0) {
                const result = await apiCall('getItems');
                if (result && result.status === 'success') {
                    cachedItems = result.data;
                }
            }

            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
            
            document.querySelectorAll('.po-item').forEach(select => {
                select.innerHTML = '<option value="">Select Item</option>';
                supplierItems.forEach(item => {
                    const packageCost = parseFloat(item.Package_Cost) || 0;
                    const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                    select.innerHTML += `<option value="${item.Item_ID}" data-cost="${packageCost.toFixed(2)}" data-units="${unitsPerPackage}">${item.Item_Description}</option>`;
                });
            });
        }

        function addPOLineItem() {
            const container = document.getElementById('poLineItems');
            const supplierId = document.getElementById('poSupplier').value;
            
            if (!supplierId) {
                alert('Please select a supplier first');
                return;
            }
            
            // Get supplier items once
            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
            
            const newRow = document.createElement('div');
            newRow.className = 'line-item-row';
            newRow.innerHTML = `
                <select class="po-item" required>
                    <option value="">Select Item</option>
                    ${supplierItems.map(item => `<option value="${item.Item_ID}" data-units="${item.Units_Per_Package}" data-cost="${item.Package_Cost}" data-uom="${item.Purchase_UOM}">${item.Item_Description}</option>`).join('')}
                </select>
                <input type="number" class="po-qty" placeholder="# of Packages" min="1" required>
                <input type="number" class="po-cost" placeholder="Cost per Package" step="0.01" min="0" required>
                <button type="button" class="remove-btn">‚úï</button>
            `;
            container.appendChild(newRow);
            
            // Attach event listeners programmatically (CSP-safe)
            const itemSelect = newRow.querySelector('.po-item');
            const qtyInput = newRow.querySelector('.po-qty');
            const costInput = newRow.querySelector('.po-cost');
            const removeBtn = newRow.querySelector('.remove-btn');
            
            itemSelect.addEventListener('change', function() {
                updatePOItemInfo(this);
            });
            
            qtyInput.addEventListener('input', function() {
                calculatePOTotal();
            });
            
            costInput.addEventListener('input', function() {
                calculatePOTotal();
            });
            
            removeBtn.addEventListener('click', function() {
                removeLineItem(this);
                calculatePOTotal();
            });
        }
        
        function updatePOItemInfo(selectElement) {
            const option = selectElement.options[selectElement.selectedIndex];
            const cost = option.getAttribute('data-cost');
            
            const row = selectElement.parentElement;
            const costInput = row.querySelector('.po-cost');
            
            if (cost) {
                costInput.value = cost;
            }
            
            calculatePOTotal();
        }
        
        function calculatePOTotal() {
            let total = 0;
            document.querySelectorAll('#poLineItems .line-item-row').forEach(row => {
                const qty = parseInt(row.querySelector('.po-qty')?.value) || 0;
                const cost = parseFloat(row.querySelector('.po-cost')?.value) || 0;
                total += qty * cost;
            });
            const totalField = document.getElementById('poTotal');
            if (totalField) {
                totalField.value = total.toFixed(2);
            }
        }
        
        function calculatePOLine(qtyInput) {
            const row = qtyInput.parentElement;
            const selectElement = row.querySelector('.po-item');
            const option = selectElement.options[selectElement.selectedIndex];
            const units = parseFloat(option.getAttribute('data-units')) || 1;
            const qty = parseFloat(qtyInput.value) || 0;
            const infoSpan = row.querySelector('.po-info');
            const totalUnits = qty * units;
            const uom = option.getAttribute('data-uom');
            
            infoSpan.textContent = `(${units} units/${uom} = ${totalUnits} total units)`;
        }

        function removeLineItem(btn) {
            btn.parentElement.remove();
        }

        async function addPurchase(e) {
            e.preventDefault();
            
            const lineItems = [];
            let calculatedTotal = 0;
            
            document.querySelectorAll('#poLineItems .line-item-row').forEach(row => {
                const qty = parseInt(row.querySelector('.po-qty').value) || 0;
                const cost = parseFloat(row.querySelector('.po-cost').value) || 0;
                const lineTotal = qty * cost;
                
                lineItems.push({
                    itemId: row.querySelector('.po-item').value,
                    quantity: qty,
                    unitCost: cost
                });
                
                calculatedTotal += lineTotal;
            });

            const data = {
                supplierId: document.getElementById('poSupplier').value,
                invoiceNumber: document.getElementById('poInvoiceNumber').value,
                poDate: document.getElementById('poDate').value,
                dueDate: document.getElementById('poDueDate').value || null,
                paymentTerms: document.getElementById('poPaymentTerms').value,
                totalAmount: calculatedTotal,
                amountPaid: parseFloat(document.getElementById('poAmountPaid').value) || 0,
                status: document.getElementById('poStatus').value,
                notes: document.getElementById('poNotes').value,
                lines: lineItems
            };

            const result = await apiCall('createPurchaseOrder', data);
            
            if (result && result.status === 'success') {
                showStatus('purchasesStatus', '‚úÖ Purchase order created! Inventory updated.', 'success');
                hideAddPurchaseForm();
                loadPurchases();
            } else {
                showStatus('purchasesStatus', '‚ùå Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        let purchasesData = []; // Cache for filtering
        
        async function loadPurchases() {
            document.getElementById('purchasesTable').innerHTML = '<div class="loading">Loading purchases...</div>';
            
            // Load suppliers FIRST if not cached
            if (cachedSuppliers.length === 0) {
                const suppResult = await apiCall('getSuppliers');
                if (suppResult && suppResult.status === 'success') {
                    cachedSuppliers = suppResult.data;
                }
            }
            
            // Now load and display purchases
            const result = await apiCall('getPurchaseOrders');
            
            if (result && result.status === 'success') {
                purchasesData = result.data;
                displayPurchases(result.data);
                loadPurchaseFilterSuppliers(); // Populate filter dropdown
            } else {
                document.getElementById('purchasesTable').innerHTML = '<div class="loading">Error loading purchases</div>';
            }
        }
        
        async function loadPurchaseFilterSuppliers() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }
            
            const select = document.getElementById('filterPurchaseSupplier');
            select.innerHTML = '<option value="">All Suppliers</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }
        
        function filterPurchases() {
            const poFilter = document.getElementById('filterPurchasePO').value.toLowerCase();
            const supplierFilter = document.getElementById('filterPurchaseSupplier').value;
            const statusFilter = document.getElementById('filterPurchaseStatus').value;
            const dateFrom = document.getElementById('filterPurchaseDateFrom').value;
            const dateTo = document.getElementById('filterPurchaseDateTo').value;
            const paymentStatusFilter = document.getElementById('filterPurchasePaymentStatus').value;
            
            const filtered = purchasesData.filter(po => {
                const matchesPO = !poFilter || (po.PO_ID && po.PO_ID.toLowerCase().includes(poFilter));
                const matchesSupplier = !supplierFilter || po.Supplier_ID === supplierFilter;
                const matchesStatus = !statusFilter || po.Status === statusFilter;
                const poDate = new Date(po.PO_Date);
                const matchesDateFrom = !dateFrom || poDate >= new Date(dateFrom);
                const matchesDateTo = !dateTo || poDate <= new Date(dateTo);
                const matchesPaymentStatus = !paymentStatusFilter || (po.Payment_Status === paymentStatusFilter);
                return matchesPO && matchesSupplier && matchesStatus && matchesDateFrom && matchesDateTo && matchesPaymentStatus;
            });
            
            displayPurchases(filtered);
        }
        
        function clearPurchaseFilters() {
            document.getElementById('filterPurchasePO').value = '';
            document.getElementById('filterPurchaseSupplier').value = '';
            document.getElementById('filterPurchaseStatus').value = '';
            document.getElementById('filterPurchaseDateFrom').value = '';
            document.getElementById('filterPurchaseDateTo').value = '';
            document.getElementById('filterPurchasePaymentStatus').value = '';
            displayPurchases(purchasesData);
        }

        function displayPurchases(orders) {
            if (!orders || orders.length === 0) {
                document.getElementById('purchasesTable').innerHTML = '<p>No purchase orders yet. Record your first purchase!</p>';
                return;
            }

            // Calculate totals
            let totalAmount = 0;
            let totalPaid = 0;
            
            let html = '<table class="data-table" id="purchasesDataTable"><thead><tr>';
            html += '<th>Invoice #</th><th>Supplier</th><th>Date</th><th>Status</th><th>Total</th><th>Paid</th><th>Due Date</th><th>Payment</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            orders.forEach(po => {
                const dueDate = po.Due_Date ? new Date(po.Due_Date).toLocaleDateString() : '-';
                const paymentStatus = po.Payment_Status || 'Unpaid';
                const amountPaid = parseFloat(po.Amount_Paid) || 0;
                const total = parseFloat(po.Total_Amount || po.Invoice_Total) || 0;
                
                totalAmount += total;
                totalPaid += amountPaid;
                
                // Color code payment status
                let paymentBadge = '';
                if (paymentStatus === 'Paid') paymentBadge = '<span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Paid</span>';
                else if (paymentStatus === 'Partial') paymentBadge = '<span style="background: #ffc107; color: black; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Partial</span>';
                else paymentBadge = '<span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Unpaid</span>';
                
                html += `<tr style="cursor: pointer;" onclick="viewPurchaseOrder('${po.PO_ID}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                    <td><strong>${po.Invoice_Number || po.PO_ID}</strong></td>
                    <td>${getSupplierName(po.Supplier_ID)}</td>
                    <td>${new Date(po.PO_Date).toLocaleDateString()}</td>
                    <td><span style="background: ${po.Status === 'Ordered' ? '#ffc107' : po.Status === 'Void' || po.Status === 'Cancelled' ? '#dc3545' : po.Status === 'Partial' ? '#17a2b8' : '#28a745'}; color: ${po.Status === 'Ordered' ? 'black' : 'white'}; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${po.Status === 'Void' ? '‚õî VOID' : po.Status === 'Cancelled' ? '‚ùå CANCELLED' : po.Status || 'Received'}</span></td>
                    <td>$${total.toFixed(2)}</td>
                    <td>$${amountPaid.toFixed(2)}</td>
                    <td>${dueDate}</td>
                    <td>${paymentBadge}</td>
                    <td onclick="event.stopPropagation();">
                        ${po.Status === 'Ordered' ? `<button class="btn-small" onclick="receiveOutboundPO('${po.PO_ID}')" style="background: #28a745; color: white;">üì¶ Receive</button>` : ''}
                        ${po.Status === 'Void' || po.Status === 'Cancelled' ? `<button class="btn-small" onclick="duplicatePO('${po.PO_ID}')" style="background: #17a2b8; color: white;">üìã Copy to New PO</button>` : ''}
                        <button class="btn-small" onclick="viewPurchaseOrder('${po.PO_ID}')" style="background: #17a2b8; color: white; padding: 6px 12px;">View/Print</button>
                    </td>
                </tr>`;
            });

            // Add totals row
            const balance = totalAmount - totalPaid;
            html += `<tr style="background: #f0f0f0; font-weight: bold; border-top: 3px solid #667eea;">
                <td colspan="4" style="text-align: right; padding-right: 20px;">TOTALS:</td>
                <td>$${totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>$${totalPaid.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td colspan="3" style="text-align: left;">Balance: <strong style="color: ${balance > 0 ? '#dc3545' : '#28a745'};">$${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
            </tr>`;

            html += '</tbody></table>';
            document.getElementById('purchasesTable').innerHTML = html;
            setTimeout(() => makeSortable('purchasesDataTable'), 0);
        }
        
        // Edit Purchase Order
        let currentEditingOrder = null;
        let currentEditingType = null; // 'purchase' or 'sales'
        let returnToTab = null; // Track which tab to return to after closing modal
        
        // View Purchase Order (from row click or button)
        function viewPurchaseOrder(poId) {
            const po = purchasesData.find(p => p.PO_ID === poId);
            if (po) {
                showPurchaseOrderDetails(po);
            }
        }
        
        async function editPurchaseOrder(poId) {
            // Find the PO in cached data or fetch it
            const result = await apiCall('getPurchaseOrders');
            if (result && result.status === 'success') {
                const po = result.data.find(p => p.PO_ID === poId);
                if (po) {
                    showPurchaseOrderDetails(po);
                }
            }
        }
        
        async function showPurchaseOrderDetails(po) {
            currentEditingOrder = po;
            currentEditingType = 'purchase';
            
            // Load items if not cached
            if (cachedItems.length === 0) {
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
            }
            
            // Get line items
            const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
            const lines = linesResult?.data || [];
            
            const supplierName = getSupplierName(po.Supplier_ID);
            const dueDate = po.Due_Date ? new Date(po.Due_Date).toLocaleDateString() : '-';
            const billDate = po.Bill_Date ? new Date(po.Bill_Date).toLocaleDateString() : '-';
            
            // Status color logic
            const statusColor = po.Status === 'Void' || po.Status === 'Cancelled' ? '#dc3545' : 
                               po.Status === 'Ordered' ? '#ffc107' : 
                               po.Status === 'Partial' ? '#17a2b8' : '#28a745';
            const statusTextColor = po.Status === 'Ordered' ? '#000' : '#fff';
            const statusText = po.Status === 'Void' ? '‚õî VOID' : 
                              po.Status === 'Cancelled' ? '‚ùå CANCELLED' : po.Status;
            
            document.getElementById('modalTitle').textContent = `Purchase Order: ${po.PO_ID}`;
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Order Information</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px 0; font-weight: bold; width: 140px;">Supplier:</td><td>${supplierName}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Invoice #:</td><td>${po.Invoice_Number || '-'}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">PO Date:</td><td>${new Date(po.PO_Date).toLocaleDateString()}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Bill Date:</td><td>${billDate}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Due Date:</td><td>${dueDate}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Status:</td><td><span style="background: ${statusColor}; color: ${statusTextColor}; padding: 4px 12px; border-radius: 12px; font-size: 12px;">${statusText}</span></td></tr>
                        </table>
                        ${po.Status === 'Ordered' ? `
                        <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <strong>‚ö†Ô∏è Prices Changed?</strong>
                            <p style="margin: 5px 0 10px 0; font-size: 13px; color: #666;">If supplier prices have changed, void this PO and create a new one with updated prices.</p>
                            <button class="btn" onclick="voidPurchaseOrder('${po.PO_ID}')" style="background: #dc3545; padding: 6px 12px; font-size: 13px;">
                                ‚õî Void This PO
                            </button>
                        </div>
                        ` : ''}
                        ${po.Status === 'Void' || po.Status === 'Cancelled' ? `
                        <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                            <strong>üìã Need to Reorder?</strong>
                            <p style="margin: 5px 0 10px 0; font-size: 13px; color: #666;">Copy this PO's items to create a new order with current prices.</p>
                            <button class="btn" onclick="duplicatePO('${po.PO_ID}'); closeModal();" style="background: #17a2b8; padding: 6px 12px; font-size: 13px;">
                                üìã Copy to New PO
                            </button>
                        </div>
                        ` : ''}
                    </div>
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Payment Information</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px 0; font-weight: bold; width: 140px;">Total Amount:</td><td style="font-size: 18px; color: #2c3e50;">$${parseFloat(po.Total_Amount || 0).toFixed(2)}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Amount Paid:</td><td style="color: #27ae60;">$${parseFloat(po.Amount_Paid || 0).toFixed(2)}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Balance Due:</td><td style="color: #e74c3c; font-size: 16px; font-weight: bold;">$${(parseFloat(po.Total_Amount || 0) - parseFloat(po.Amount_Paid || 0)).toFixed(2)}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Payment Status:</td><td><span style="background: ${po.Payment_Status === 'Paid' ? '#d4edda' : '#fff3cd'}; color: ${po.Payment_Status === 'Paid' ? '#155724' : '#856404'}; padding: 4px 12px; border-radius: 12px; font-size: 12px;">${po.Payment_Status}</span></td></tr>
                        </table>
                        ${po.Payment_Status !== 'Paid' && po.Status !== 'Void' && po.Status !== 'Cancelled' ? `
                        <div style="margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 8px;">
                            <div style="margin-bottom: 10px;"><strong>üíµ Quick Payment</strong></div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="number" id="quickPaymentAmount" step="0.01" min="0" 
                                       value="${(parseFloat(po.Total_Amount || 0) - parseFloat(po.Amount_Paid || 0)).toFixed(2)}"
                                       style="width: 120px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <button class="btn" onclick="recordQuickPOPayment('${po.PO_ID}')" 
                                        style="background: #28a745; padding: 8px 15px;">
                                    üíµ Record Payment
                                </button>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            if (lines.length > 0) {
                html += `
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">üì¶ Line Items</h3>
                    <div style="overflow-x: auto;">
                    <table class="data-table" style="margin-bottom: 20px; font-size: 14px;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th style="padding: 12px 15px;">Item</th>
                                <th style="padding: 12px 15px;">Description</th>
                                <th style="padding: 12px 15px;">Qty</th>
                                <th style="padding: 12px 15px;">Unit Cost</th>
                                <th style="padding: 12px 15px;">Line Total</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                lines.forEach(line => {
                    const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                    const lineTotal = (parseFloat(line.Quantity) || 0) * (parseFloat(line.Unit_Cost) || 0);
                    html += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px 15px;"><strong>${item?.SKU || line.Item_ID}</strong></td>
                            <td style="padding: 12px 15px;">${item ? item.Item_Description : '-'}</td>
                            <td style="padding: 12px 15px; text-align: center; font-weight: bold;">${line.Quantity}</td>
                            <td style="padding: 12px 15px; text-align: right;">$${parseFloat(line.Unit_Cost || 0).toFixed(2)}</td>
                            <td style="padding: 12px 15px; text-align: right; font-weight: bold;">$${lineTotal.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                    </div>
                `;
            }
            
            if (po.Notes) {
                html += `
                    <div style="margin-top: 20px;">
                        <h3 style="color: #667eea; margin-bottom: 10px;">Notes</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            ${po.Notes}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalEditBtn').style.display = 'inline-block';
            document.getElementById('modalPrintBtn').style.display = 'inline-block';
            document.getElementById('modalPrintBtn').textContent = 'üñ®Ô∏è Print PO';
            document.getElementById('modalPrintBtn').onclick = () => printPurchaseOrder();
            document.getElementById('modalSaveBtn').style.display = 'none';
            document.getElementById('orderModal').style.display = 'block';
        }
        
        async function recordQuickPOPayment(poId) {
            const paymentInput = document.getElementById('quickPaymentAmount');
            const paymentAmount = parseFloat(paymentInput.value) || 0;
            
            if (paymentAmount <= 0) {
                alert('Please enter a payment amount greater than 0');
                return;
            }
            
            const result = await apiCall('recordPurchasePayment', {
                poId: poId,
                paymentAmount: paymentAmount
            });
            
            if (result && result.status === 'success') {
                alert(`‚úÖ Payment recorded!\n\nTotal Paid: $${result.totalPaid.toFixed(2)}\nStatus: ${result.paymentStatus}`);
                document.getElementById('orderModal').style.display = 'none';
                loadPurchases();
            } else {
                alert('‚ùå Error: ' + (result?.message || 'Unknown error'));
            }
        }
        
        // PRINT PURCHASE ORDER FUNCTION
        async function printPurchaseOrder() {
            if (!currentEditingOrder || currentEditingType !== 'purchase') {
                alert('Please select a purchase order first');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('Please allow popups for this site');
                return;
            }
            printWindow.document.write('<html><body><h2>Loading PO...</h2></body></html>');
            
            const po = currentEditingOrder;
            const settings = getInvoiceSettings();
            
            // Get supplier details
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === po.Supplier_ID);
            
            // Get line items
            const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
            const lines = linesResult?.data || [];
            
            // Calculate totals
            let subtotal = 0;
            lines.forEach(line => {
                subtotal += (parseFloat(line.Quantity) || 0) * (parseFloat(line.Unit_Cost) || 0);
            });
            
            const total = parseFloat(po.Total_Amount || subtotal);
            const paid = parseFloat(po.Amount_Paid || 0);
            const balance = total - paid;
            
            // Get theme colors for print
            const themeColors = getThemeColors();
            
            let poHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Purchase Order ${po.Invoice_Number || po.PO_ID}</title>
    <style>
        @media print {
            @page { margin: 0.5in; }
            body { margin: 0; }
            .no-print { display: none; }
        }
        body {
            font-family: Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.4;
            max-width: 8in;
            margin: 0 auto;
            padding: 0.5in;
        }
        .po-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid ${themeColors.primary};
            padding-bottom: 20px;
        }
        .po-header h1 {
            color: ${themeColors.text};
            margin: 0 0 10px 0;
            font-size: 28pt;
        }
        .po-number {
            font-size: 14pt;
            font-weight: bold;
            margin: 5px 0;
        }
        .po-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .info-box {
            width: 45%;
        }
        .info-box h3 {
            color: ${themeColors.text};
            border-bottom: 2px solid ${themeColors.primary};
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .info-box p {
            margin: 5px 0;
        }
        table.items {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        table.items th {
            background: ${themeColors.primary};
            color: white;
            padding: 12px 10px;
            text-align: left;
        }
        table.items td {
            border: 1px solid #ddd;
            padding: 10px;
        }
        .totals {
            margin-top: 30px;
            float: right;
            width: 40%;
        }
        .totals table { width: 100%; }
        .totals td { padding: 8px 10px; border-bottom: 1px solid #eee; }
        .totals .label { text-align: right; font-weight: bold; }
        .totals .value { text-align: right; width: 40%; }
        .total-line { border-top: 2px solid ${themeColors.primary} !important; font-size: 14pt; font-weight: bold; }
        .footer {
            clear: both;
            margin-top: 60px;
            padding-top: 20px;
            border-top: 2px solid ${themeColors.primary};
            text-align: center;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="po-header">
        <h1>${settings.companyName}</h1>
        <p>${settings.address1}</p>
        ${settings.address2 ? `<p>${settings.address2}</p>` : ''}
        <p>${settings.cityStateZip}</p>
        <p>Phone: ${settings.phone} | Email: ${settings.email}</p>
    </div>

    <div class="po-number">PURCHASE ORDER: ${po.Invoice_Number || po.PO_ID}</div>
    <p><strong>PO Date:</strong> ${new Date(po.PO_Date).toLocaleDateString()} | <strong>Status:</strong> ${po.Status || 'Received'}</p>

    <div class="po-info">
        <div class="info-box">
            <h3>Supplier:</h3>
            <p><strong>${supplier?.Supplier_Name || 'Unknown Supplier'}</strong></p>
            ${supplier?.Contact_Name ? `<p>Attn: ${supplier.Contact_Name}</p>` : ''}
            ${supplier?.Address ? `<p>${supplier.Address}</p>` : ''}
            ${supplier?.City || supplier?.State ? `<p>${supplier.City || ''}, ${supplier.State || ''} ${supplier.ZIP || ''}</p>` : ''}
            ${supplier?.Phone ? `<p>Phone: ${supplier.Phone}</p>` : ''}
        </div>
        <div class="info-box">
            <h3>Payment Info:</h3>
            <p><strong>Terms:</strong> ${supplier?.Payment_Terms || 'Net 30'}</p>
            <p><strong>Due Date:</strong> ${po.Due_Date ? new Date(po.Due_Date).toLocaleDateString() : '-'}</p>
            <p><strong>Status:</strong> ${po.Payment_Status || 'Unpaid'}</p>
        </div>
    </div>

    <table class="items">
        <thead>
            <tr>
                <th style="width: 10%;">QTY</th>
                <th style="width: 50%;">DESCRIPTION</th>
                <th style="width: 20%; text-align: right;">UNIT COST</th>
                <th style="width: 20%; text-align: right;">AMOUNT</th>
            </tr>
        </thead>
        <tbody>`;
            
            lines.forEach(line => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                const lineTotal = (parseFloat(line.Quantity) || 0) * (parseFloat(line.Unit_Cost) || 0);
                
                poHTML += `
            <tr>
                <td style="text-align: center;">${line.Quantity}</td>
                <td>${item?.Item_Description || line.Item_ID}</td>
                <td style="text-align: right;">$${parseFloat(line.Unit_Cost || 0).toFixed(2)}</td>
                <td style="text-align: right;">$${lineTotal.toFixed(2)}</td>
            </tr>`;
            });
            
            poHTML += `
        </tbody>
    </table>

    <div class="totals">
        <table>
            <tr>
                <td class="label">SUBTOTAL:</td>
                <td class="value">$${subtotal.toFixed(2)}</td>
            </tr>
            <tr class="total-line">
                <td class="label">TOTAL:</td>
                <td class="value">$${total.toFixed(2)}</td>
            </tr>
            ${paid > 0 ? `
            <tr>
                <td class="label">PAID:</td>
                <td class="value">$${paid.toFixed(2)}</td>
            </tr>` : ''}
            ${balance > 0 ? `
            <tr>
                <td class="label" style="color: #c62828;">BALANCE DUE:</td>
                <td class="value" style="color: #c62828; font-weight: bold;">$${balance.toFixed(2)}</td>
            </tr>` : ''}
        </table>
    </div>

    <div class="footer">
        ${po.Notes ? `<p><strong>Notes:</strong> ${po.Notes}</p>` : ''}
    </div>

    <div class="no-print" style="position: fixed; top: 20px; right: 20px;">
        <button onclick="window.print()" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: ${themeColors.primary}; color: white; border: none; border-radius: 5px; margin-right: 10px;">üñ®Ô∏è Print</button>
        <button onclick="window.close()" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: #9e9e9e; color: white; border: none; border-radius: 5px;">‚úï Close</button>
    </div>

</body>
</html>`;
            
            printWindow.document.open();
            printWindow.document.write(poHTML);
            printWindow.document.close();
        }
        
        // PRINT INVOICE FUNCTION
        async function printInvoice() {
            if (!currentEditingOrder || currentEditingType !== 'sales') {
                alert('Please select a sales order first');
                return;
            }
            
            // CRITICAL: Open window BEFORE any async calls to avoid iPhone popup blocker
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('Please allow popups for this site');
                return;
            }
            printWindow.document.write('<html><body><h2>Loading invoice...</h2></body></html>');
            
            const so = currentEditingOrder;
            const settings = getInvoiceSettings();
            
            // Get customer details
            const customersResult = await apiCall('getCustomers');
            const customer = customersResult.data.find(c => c.Customer_ID === so.Customer_ID);
            
            // Get line items
            const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
            const lines = linesResult?.data || [];
            
            // Calculate totals
            let subtotal = 0;
            lines.forEach(line => {
                subtotal += parseFloat(line.Line_Total || 0);
            });
            
            const total = parseFloat(so.Total_Amount || 0);
            const paid = parseFloat(so.Amount_Paid || 0);
            const balance = total - paid;
            
            // Get theme colors for print
            const themeColors = getThemeColors();
            
            // Build invoice HTML with PO-style layout
            let invoiceHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Invoice ${so.Invoice_Number || so.SO_ID}</title>
    <style>
        @media print {
            @page { margin: 0.5in; }
            body { margin: 0; }
            .no-print { display: none; }
        }
        body {
            font-family: Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.4;
            max-width: 8in;
            margin: 0 auto;
            padding: 0.5in;
        }
        .invoice-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid ${themeColors.primary};
            padding-bottom: 20px;
        }
        .invoice-header h1 {
            color: ${themeColors.text};
            margin: 0 0 10px 0;
            font-size: 28pt;
        }
        .invoice-number {
            font-size: 14pt;
            font-weight: bold;
            margin: 5px 0;
        }
        .invoice-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .info-box {
            flex: 1;
        }
        .info-box h3 {
            margin: 0 0 10px 0;
            color: ${themeColors.text};
        }
        .info-box p {
            margin: 2px 0;
        }
        table.items {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        table.items th {
            background: ${themeColors.primary};
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        table.items td {
            border: 1px solid #ddd;
            padding: 10px;
        }
        table.items .qty { text-align: center; width: 10%; }
        table.items .desc { width: 50%; }
        table.items .price { text-align: right; width: 20%; }
        table.items .amount { text-align: right; width: 20%; }
        .totals {
            margin-top: 30px;
            float: right;
            width: 40%;
        }
        .totals table {
            width: 100%;
        }
        .totals td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
        }
        .totals .label {
            text-align: right;
            font-weight: bold;
        }
        .totals .value {
            text-align: right;
            width: 40%;
        }
        .total-line {
            border-top: 2px solid ${themeColors.primary} !important;
            border-bottom: 3px double ${themeColors.primary} !important;
            font-size: 14pt;
            font-weight: bold;
        }
        .footer {
            clear: both;
            margin-top: 60px;
            padding-top: 20px;
            border-top: 2px solid ${themeColors.primary};
            text-align: center;
            font-style: italic;
            color: #666;
        }
        .signature {
            margin-top: 40px;
            padding-top: 10px;
            border-top: 1px solid #000;
            width: 300px;
            white-space: nowrap;
        }
    </style>
</head>
<body>

    <div class="invoice-header">
        <h1>SALES INVOICE</h1>
        <p style="font-size: 16pt; margin: 5px 0;">${settings.companyName}</p>
        <div class="invoice-number">#${so.Invoice_Number || so.SO_ID}</div>
        <p>Date: ${so.Sale_Date ? new Date(so.Sale_Date).toLocaleDateString() : new Date(so.SO_Date).toLocaleDateString()}</p>
    </div>

    <div class="invoice-info">
        <div class="info-box">
            <h3>From:</h3>
            <p><strong>${settings.companyName}</strong></p>
            ${settings.contactName ? `<p>${settings.contactName}</p>` : ''}
            <p>${settings.address1}</p>
            ${settings.address2 ? `<p>${settings.address2}</p>` : ''}
            <p>${settings.cityStateZip}</p>
            <p>Phone: ${settings.phone}</p>
            <p>Email: ${settings.email}</p>
        </div>
        <div class="info-box">
            <h3>Bill To:</h3>
            <p><strong>${customer?.Customer_Name || 'Unknown Customer'}</strong></p>
            ${customer?.Contact_Name ? `<p>Attn: ${customer.Contact_Name}</p>` : ''}
            ${customer?.Address ? `<p>${customer.Address}</p>` : ''}
            ${customer?.City || customer?.State || customer?.ZIP ? `<p>${customer.City || ''}${customer.City && customer.State ? ', ' : ''}${customer.State || ''} ${customer.ZIP || ''}</p>` : ''}
            ${customer?.Phone ? `<p>Phone: ${customer.Phone}</p>` : ''}
        </div>
    </div>

    <table class="items">
        <thead>
            <tr>
                <th class="qty">QTY</th>
                <th class="desc">DESCRIPTION</th>
                <th class="price">PRICE</th>
                <th class="amount">AMOUNT</th>
            </tr>
        </thead>
        <tbody>`;
            
            // Add line items
            lines.forEach(line => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                const lineTotal = parseFloat(line.Line_Total || 0);
                
                invoiceHTML += `
            <tr>
                <td class="qty">${line.Quantity}</td>
                <td class="desc">${item?.Item_Description || line.Item_ID}</td>
                <td class="price">$${parseFloat(line.Unit_Price || 0).toFixed(2)}</td>
                <td class="amount">$${lineTotal.toFixed(2)}</td>
            </tr>`;
            });
            
            invoiceHTML += `
        </tbody>
    </table>

    <div class="totals">
        <table>
            <tr>
                <td class="label">SUBTOTAL:</td>
                <td class="value">$${subtotal.toFixed(2)}</td>
            </tr>
            <tr class="total-line">
                <td class="label">TOTAL:</td>
                <td class="value">$${total.toFixed(2)}</td>
            </tr>
            ${paid > 0 ? `
            <tr>
                <td class="label">PAID:</td>
                <td class="value">$${paid.toFixed(2)}</td>
            </tr>` : ''}
            ${balance > 0 ? `
            <tr style="background: #fff3cd;">
                <td class="label">BALANCE DUE:</td>
                <td class="value" style="color: #e74c3c; font-weight: bold;">$${balance.toFixed(2)}</td>
            </tr>` : ''}
        </table>
    </div>

    <div class="footer">
        Thank you for doing Business with ${settings.companyName}
    </div>

    <div class="signature">
        Signature: ___________________________
    </div>

    <p style="clear: both; text-align: center; margin-top: 40px; font-size: 9pt; color: #999;">
        KEEP THIS SLIP FOR REFERENCE
    </p>

    <div class="no-print" style="position: fixed; top: 20px; right: 20px;">
        <button onclick="window.print()" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: ${themeColors.primary}; color: white; border: none; border-radius: 5px; margin-right: 10px;">üñ®Ô∏è Print</button>
        <button onclick="window.close()" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: #9e9e9e; color: white; border: none; border-radius: 5px;">‚úï Close</button>
    </div>

</body>
</html>`;
            
            // Clear the loading message and write the final invoice
            printWindow.document.open();
            printWindow.document.write(invoiceHTML);
            printWindow.document.close();
        }
        
        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
            currentEditingOrder = null;
            currentEditingType = null;
            
            // Return to previous tab if we came from Reports
            if (returnToTab === 'reports') {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="reports"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('reports').classList.add('active');
                returnToTab = null;
            }
        }
        
        function enableEditMode() {
            if (currentEditingType === 'purchase') {
                enablePurchaseOrderEdit();
            } else if (currentEditingType === 'sales') {
                enableSalesOrderEdit();
            }
        }
        
        async function enablePurchaseOrderEdit() {
            const po = currentEditingOrder;
            
            // Load items and suppliers if not cached
            if (cachedItems.length === 0) {
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
            }
            if (cachedSuppliers.length === 0) {
                const suppResult = await apiCall('getSuppliers');
                if (suppResult && suppResult.status === 'success') {
                    cachedSuppliers = suppResult.data;
                }
            }
            
            // Get line items
            const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
            const lines = linesResult?.data || [];
            
            const supplierName = getSupplierName(po.Supplier_ID);
            
            document.getElementById('modalTitle').textContent = `Edit Purchase Order: ${po.PO_ID}`;
            
            // Build supplier dropdown
            let supplierOptions = '<option value="">Select Supplier</option>';
            cachedSuppliers.forEach(s => {
                supplierOptions += `<option value="${s.Supplier_ID}" ${s.Supplier_ID === po.Supplier_ID ? 'selected' : ''}>${s.Supplier_Name}</option>`;
            });
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Order Information</h3>
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="editPOSupplier" required>${supplierOptions}</select>
                        </div>
                        <div class="form-group">
                            <label>Invoice Number</label>
                            <input type="text" id="editPOInvoiceNumber" value="${po.Invoice_Number || ''}">
                        </div>
                        <div class="form-group">
                            <label>PO Date</label>
                            <input type="date" id="editPODate" value="${po.PO_Date ? new Date(po.PO_Date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="editPODueDate" value="${po.Due_Date ? new Date(po.Due_Date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="editPOStatus">
                                <option value="Ordered" ${po.Status === 'Ordered' ? 'selected' : ''}>Ordered (Pending Delivery)</option>
                                <option value="Received" ${po.Status === 'Received' ? 'selected' : ''}>Received</option>
                                <option value="Partial" ${po.Status === 'Partial' ? 'selected' : ''}>Partially Received</option>
                                <option value="Void" ${po.Status === 'Void' ? 'selected' : ''}>‚õî Void (Prices Changed)</option>
                                <option value="Cancelled" ${po.Status === 'Cancelled' ? 'selected' : ''}>‚ùå Cancelled</option>
                            </select>
                            <small style="color: #666; display: block; margin-top: 5px;">Use "Void" if supplier prices changed and you need to create a new PO</small>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Payment Information</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="margin-bottom: 10px;">
                                <strong>Current Total:</strong> $${parseFloat(po.Total_Amount || 0).toFixed(2)}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Previously Paid:</strong> $${parseFloat(po.Amount_Paid || 0).toFixed(2)}
                            </div>
                            <div>
                                <strong>Balance Due:</strong> <span style="color: #e74c3c;">$${(parseFloat(po.Total_Amount || 0) - parseFloat(po.Amount_Paid || 0)).toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Update Amount Paid</label>
                            <input type="number" id="editPOAmountPaid" step="0.01" min="0" value="${parseFloat(po.Amount_Paid || 0).toFixed(2)}">
                            <small style="color: #666;">Update if making additional payment</small>
                        </div>
                        <div style="color: #666; font-size: 13px; background: #fff3cd; padding: 10px; border-radius: 6px;">
                            ‚ö†Ô∏è Total will recalculate based on line items below
                        </div>
                    </div>
                </div>
                
                <h3 style="color: #667eea; margin-bottom: 15px;">Line Items</h3>
                <div id="editPOLineItems">
            `;
            
            // Add existing line items as editable rows
            lines.forEach((line, index) => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                html += createEditableLineItem('PO', line, index, item);
            });
            
            html += `
                </div>
                <button type="button" class="btn btn-secondary" onclick="addEditLineItem('PO')" style="margin-top: 10px;">+ Add Line Item</button>
                
                <div class="form-group" style="margin-top: 30px;">
                    <label>Notes</label>
                    <textarea id="editPONotes" rows="3" style="width: 100%;">${po.Notes || ''}</textarea>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            
            // Attach event listeners to all PO line items in the edit modal
            console.log('Attaching listeners to PO edit modal line items'); // DEBUG
            document.querySelectorAll('#editPOLineItems .edit-line-item').forEach(row => {
                attachEditLineItemListeners(row);
            });
            
            document.getElementById('modalEditBtn').style.display = 'none';
            document.getElementById('modalSaveBtn').style.display = 'inline-block';
        }
        
        function createEditableLineItem(type, line, index, item) {
            // Make sure items are loaded
            if (cachedItems.length === 0) {
                console.error('cachedItems is empty!');
            }
            
            const itemOptions = cachedItems
                .filter(i => type === 'PO' ? i.Supplier_ID === currentEditingOrder.Supplier_ID : true)
                .map(i => {
                    const priceAttr = type === 'PO' ? `data-cost="${i.Package_Cost}"` : `data-price="${i.Unit_Sell_Price}"`;
                    return `<option value="${i.Item_ID}" ${priceAttr} ${i.Item_ID === line.Item_ID ? 'selected' : ''}>${i.Item_Description}</option>`;
                })
                .join('');
            
            console.log('Items for dropdown:', cachedItems.length, 'Filtered:', itemOptions.length);
            
            const qtyField = type === 'PO' ? 'Quantity' : 'Quantity';
            const priceField = type === 'PO' ? 'Unit_Cost' : 'Unit_Price';
            const originalQty = parseFloat(line[qtyField]) || 0;
            const originalPrice = parseFloat(line[priceField]) || 0;
            
            return `
                <div class="edit-line-item" data-type="${type}" data-original-item="${line.Item_ID}" data-original-qty="${originalQty}" data-line-id="${line.Line_ID || ''}" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 50px; gap: 10px; margin-bottom: 10px; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <select class="edit-item" required>
                        <option value="">Select Item</option>
                        ${itemOptions}
                    </select>
                    <input type="number" class="edit-qty" placeholder="Qty" min="1" required value="${originalQty}">
                    <input type="number" class="edit-price" placeholder="${type === 'PO' ? 'Cost' : 'Price'}" step="0.01" min="0" required value="${originalPrice}">
                    <input type="text" class="edit-total" readonly style="background: #e9ecef; font-weight: bold;" value="$${(originalQty * originalPrice).toFixed(2)}">
                    <button type="button" class="remove-btn" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px; cursor: pointer;">‚úï</button>
                </div>
            `;
        }
        
        function calculateEditLineTotal(input) {
            const row = input.closest('.edit-line-item');
            const qty = parseFloat(row.querySelector('.edit-qty').value) || 0;
            const price = parseFloat(row.querySelector('.edit-price').value) || 0;
            const total = qty * price;
            row.querySelector('.edit-total').value = '$' + total.toFixed(2);
            
            // Update payment info if this is a sales order
            if (row.getAttribute('data-type') === 'SO') {
                updateEditPaymentInfo();
            }
        }
        
        function updateEditPaymentInfo() {
            // Calculate new total from all line items
            let newTotal = 0;
            document.querySelectorAll('#editSOLineItems .edit-line-item').forEach(row => {
                const qty = parseFloat(row.querySelector('.edit-qty').value) || 0;
                const price = parseFloat(row.querySelector('.edit-price').value) || 0;
                newTotal += qty * price;
            });
            
            // Get previously paid amount
            const previouslyPaid = parseFloat(document.getElementById('editSOAmountPaid')?.value) || 0;
            
            // Calculate balance due
            const balanceDue = newTotal - previouslyPaid;
            
            // Update the display fields using IDs
            const currentTotalDiv = document.getElementById('editSOCurrentTotal');
            const balanceDueDiv = document.getElementById('editSOBalanceDue');
            
            if (currentTotalDiv) {
                currentTotalDiv.innerHTML = `<strong>Current Total:</strong> $${newTotal.toFixed(2)}`;
            }
            
            if (balanceDueDiv) {
                balanceDueDiv.innerHTML = `<strong>Balance Due:</strong> <span style="color: #e74c3c;">$${balanceDue.toFixed(2)}</span>`;
            }
        }
        
        function attachEditLineItemListeners(row) {
            const type = row.getAttribute('data-type');
            const itemSelect = row.querySelector('.edit-item');
            const qtyInput = row.querySelector('.edit-qty');
            const priceInput = row.querySelector('.edit-price');
            const removeBtn = row.querySelector('.remove-btn');
            
            console.log('Attaching edit modal listeners, type:', type); // DEBUG
            
            // Auto-fill price when item selected
            itemSelect.addEventListener('change', function() {
                console.log('Edit modal item changed!'); // DEBUG
                const option = this.options[this.selectedIndex];
                const priceAttr = type === 'PO' ? 'data-cost' : 'data-price';
                const price = option.getAttribute(priceAttr);
                console.log('Price from data attribute:', price); // DEBUG
                
                if (price) {
                    priceInput.value = price;
                    calculateEditLineTotal(qtyInput);
                }
            });
            
            // Recalculate when qty or price changes
            qtyInput.addEventListener('input', function() {
                calculateEditLineTotal(this);
            });
            
            priceInput.addEventListener('input', function() {
                calculateEditLineTotal(this);
            });
            
            // Remove button
            removeBtn.addEventListener('click', function() {
                if (confirm('Remove this line item?')) {
                    row.remove();
                    // Update payment info if this is a sales order
                    if (type === 'SO') {
                        updateEditPaymentInfo();
                    }
                }
            });
            
            console.log('Edit modal listeners attached!'); // DEBUG
        }
        
        function addEditLineItem(type) {
            const container = document.getElementById(type === 'PO' ? 'editPOLineItems' : 'editSOLineItems');
            const newLine = {
                Item_ID: '',
                Quantity: 0,
                [type === 'PO' ? 'Unit_Cost' : 'Unit_Price']: 0
            };
            const newItem = createEditableLineItem(type, newLine, -1, null);
            container.insertAdjacentHTML('beforeend', newItem);
            
            // Attach listeners to the newly added item
            const newRow = container.lastElementChild;
            attachEditLineItemListeners(newRow);
        }
        
        function removeEditLineItem(btn) {
            if (confirm('Remove this line item?')) {
                btn.closest('.edit-line-item').remove();
            }
        }
        
        async function saveOrderChanges() {
            if (currentEditingType === 'purchase') {
                await savePurchaseOrderChanges();
            } else if (currentEditingType === 'sales') {
                await saveSalesOrderChanges();
            }
        }
        
        async function savePurchaseOrderChanges() {
            const po = currentEditingOrder;
            
            // Collect line items
            const newLines = [];
            let totalAmount = 0;
            
            document.querySelectorAll('#editPOLineItems .edit-line-item').forEach(row => {
                const itemId = row.querySelector('.edit-item').value;
                const qty = parseInt(row.querySelector('.edit-qty').value) || 0;
                const cost = parseFloat(row.querySelector('.edit-price').value) || 0;
                
                console.log('Line item:', { itemId, qty, cost });  // DEBUG
                
                if (itemId && qty > 0) {
                    newLines.push({
                        itemId: itemId,
                        quantity: qty,
                        unitCost: cost,
                        originalItem: row.dataset.originalItem,
                        originalQty: parseInt(row.dataset.originalQty) || 0,
                        lineId: row.dataset.lineId
                    });
                    totalAmount += qty * cost;
                }
            });
            
            console.log('Total lines collected:', newLines.length);  // DEBUG
            
            if (newLines.length === 0) {
                const rowCount = document.querySelectorAll('#editPOLineItems .edit-line-item').length;
                alert(`No valid line items found!\n\nRows found: ${rowCount}\n\nPlease make sure each line has:\n- An item selected\n- A quantity > 0`);
                return;
            }
            
            const data = {
                poId: po.PO_ID,
                supplierId: document.getElementById('editPOSupplier').value,
                invoiceNumber: document.getElementById('editPOInvoiceNumber').value,
                poDate: document.getElementById('editPODate').value,
                dueDate: document.getElementById('editPODueDate').value,
                status: document.getElementById('editPOStatus').value,
                notes: document.getElementById('editPONotes').value,
                totalAmount: totalAmount,
                amountPaid: parseFloat(document.getElementById('editPOAmountPaid').value) || 0,
                lines: newLines,
                oldLines: currentEditingOrder._originalLines || []
            };
            
            showStatus('purchasesStatus', '‚è≥ Saving changes...', 'info');
            
            const result = await apiCall('updatePurchaseOrder', data);
            
            if (result && result.status === 'success') {
                showStatus('purchasesStatus', '‚úÖ Purchase order updated successfully!', 'success');
                closeOrderModal();
                loadPurchases();
            } else {
                showStatus('purchasesStatus', '‚ùå Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        function enableEditMode() {
            if (currentEditingType === 'purchase') {
                enablePurchaseOrderEdit();
            } else if (currentEditingType === 'sales') {
                enableSalesOrderEdit();
            }
        }
        
        async function enableSalesOrderEdit() {
            const so = currentEditingOrder;
            
            // Load items and customers if not cached
            if (cachedItems.length === 0) {
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
            }
            if (cachedCustomers.length === 0) {
                const custResult = await apiCall('getCustomers');
                if (custResult && custResult.status === 'success') {
                    cachedCustomers = custResult.data;
                }
            }
            
            // Get line items
            const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
            const lines = linesResult?.data || [];
            
            document.getElementById('modalTitle').textContent = `Edit Sales Order: ${so.Invoice_Number || so.SO_ID}`;
            
            // Build customer dropdown
            let customerOptions = '<option value="">Select Customer</option>';
            cachedCustomers.forEach(c => {
                customerOptions += `<option value="${c.Customer_ID}" ${c.Customer_ID === so.Customer_ID ? 'selected' : ''}>${c.Customer_Name}</option>`;
            });
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Order Information</h3>
                        <div class="form-group">
                            <label>Customer *</label>
                            <select id="editSOCustomer" required>${customerOptions}</select>
                        </div>
                        <div class="form-group">
                            <label>Invoice Number</label>
                            <input type="text" id="editSOInvoiceNumber" value="${so.Invoice_Number || ''}">
                        </div>
                        <div class="form-group">
                            <label>Sale Date</label>
                            <input type="date" id="editSODate" value="${so.Sale_Date ? new Date(so.Sale_Date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="editSODueDate" value="${so.Due_Date ? new Date(so.Due_Date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="editSOPaymentMethod">
                                <option value="Cash" ${so.Payment_Method === 'Cash' ? 'selected' : ''}>Cash</option>
                                <option value="Check" ${so.Payment_Method === 'Check' ? 'selected' : ''}>Check</option>
                                <option value="Invoice" ${so.Payment_Method === 'Invoice' ? 'selected' : ''}>Invoice</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="editSOStatus">
                                <option value="Pending" ${so.Status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Completed" ${so.Status === 'Completed' ? 'selected' : ''}>Completed</option>
                                <option value="Cancelled" ${so.Status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Payment Information</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div id="editSOCurrentTotal" style="margin-bottom: 10px;">
                                <strong>Current Total:</strong> $${parseFloat(so.Total_Amount || 0).toFixed(2)}
                            </div>
                            <div id="editSOPreviouslyPaid" style="margin-bottom: 10px;">
                                <strong>Previously Paid:</strong> $${parseFloat(so.Amount_Paid || 0).toFixed(2)}
                            </div>
                            <div id="editSOBalanceDue">
                                <strong>Balance Due:</strong> <span style="color: #e74c3c;">$${(parseFloat(so.Total_Amount || 0) - parseFloat(so.Amount_Paid || 0)).toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Update Amount Paid</label>
                            <input type="number" id="editSOAmountPaid" step="0.01" min="0" value="${parseFloat(so.Amount_Paid || 0).toFixed(2)}">
                            <small style="color: #666;">Update if receiving additional payment</small>
                        </div>
                        <div style="color: #666; font-size: 13px; background: #fff3cd; padding: 10px; border-radius: 6px;">
                            ‚ö†Ô∏è Total will recalculate based on line items below
                        </div>
                    </div>
                </div>
                
                <h3 style="color: #667eea; margin-bottom: 15px;">Line Items</h3>
                <div id="editSOLineItems">
            `;
            
            // Add existing line items as editable rows
            lines.forEach((line, index) => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                html += createEditableLineItem('SO', line, index, item);
            });
            
            html += `
                </div>
                <button type="button" class="btn btn-secondary" onclick="addEditLineItem('SO')" style="margin-top: 10px;">+ Add Line Item</button>
                
                <div class="form-group" style="margin-top: 30px;">
                    <label>Notes</label>
                    <textarea id="editSONotes" rows="3" style="width: 100%;">${so.Notes || ''}</textarea>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            
            // Attach event listeners to all SO line items in the edit modal
            console.log('Attaching listeners to SO edit modal line items'); // DEBUG
            document.querySelectorAll('#editSOLineItems .edit-line-item').forEach(row => {
                attachEditLineItemListeners(row);
            });
            
            document.getElementById('modalEditBtn').style.display = 'none';
            document.getElementById('modalSaveBtn').style.display = 'inline-block';
        }
        
        async function saveSalesOrderChanges() {
            const so = currentEditingOrder;
            
            // Collect line items
            const newLines = [];
            let totalAmount = 0;
            
            document.querySelectorAll('#editSOLineItems .edit-line-item').forEach(row => {
                const itemId = row.querySelector('.edit-item').value;
                const qty = parseInt(row.querySelector('.edit-qty').value) || 0;
                const price = parseFloat(row.querySelector('.edit-price').value) || 0;
                
                if (itemId && qty > 0) {
                    newLines.push({
                        itemId: itemId,
                        quantity: qty,
                        unitPrice: price,
                        originalItem: row.dataset.originalItem,
                        originalQty: parseInt(row.dataset.originalQty) || 0,
                        lineId: row.dataset.lineId
                    });
                    totalAmount += qty * price;
                }
            });
            
            if (newLines.length === 0) {
                alert('Please add at least one line item');
                return;
            }
            
            const data = {
                soId: so.SO_ID,
                customerId: document.getElementById('editSOCustomer').value,
                invoiceNumber: document.getElementById('editSOInvoiceNumber').value,
                saleDate: document.getElementById('editSODate').value,
                dueDate: document.getElementById('editSODueDate').value,
                paymentMethod: document.getElementById('editSOPaymentMethod').value,
                status: document.getElementById('editSOStatus').value,
                notes: document.getElementById('editSONotes').value,
                totalAmount: totalAmount,
                amountPaid: parseFloat(document.getElementById('editSOAmountPaid').value) || 0,
                lines: newLines
            };
            
            showStatus('salesStatus', '‚è≥ Saving changes...', 'info');
            
            const result = await apiCall('updateSalesOrder', data);
            
            if (result && result.status === 'success') {
                showStatus('salesStatus', '‚úÖ Sales order updated successfully!', 'success');
                closeOrderModal();
                loadSales();
            } else {
                showStatus('salesStatus', '‚ùå Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        function recordPurchasePayment(poId, total, amountPaid) {
            const remaining = total - amountPaid;
            
            // Create better formatted prompt
            let message = `üí∞ Record Payment for ${poId}\n\n`;
            message += `Invoice Total:    $${total.toFixed(2)}\n`;
            message += `Already Paid:     $${amountPaid.toFixed(2)}\n`;
            message += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            message += `Balance Due:      $${remaining.toFixed(2)}\n\n`;
            
            // Suggest full payment if unpaid
            if (amountPaid === 0) {
                message += `Tip: Enter ${remaining.toFixed(2)} to pay in full\n\n`;
            }
            
            message += `Enter payment amount:`;
            
            const payment = prompt(message);
            
            if (payment === null) return; // Cancelled
            
            const paymentAmount = parseFloat(payment);
            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                alert('Please enter a valid payment amount');
                return;
            }
            
            if (paymentAmount > remaining + 0.01) { // Allow 1 cent rounding
                if (!confirm(`Payment ($${paymentAmount.toFixed(2)}) is more than balance due ($${remaining.toFixed(2)}).\n\nContinue anyway?`)) {
                    return;
                }
            }
            
            // Call backend
            apiCall('recordPurchasePayment', { poId: poId, paymentAmount: paymentAmount })
                .then(result => {
                    if (result && result.status === 'success') {
                        const newTotal = amountPaid + paymentAmount;
                        const statusMsg = result.paymentStatus === 'Paid' ? '‚úÖ PAID IN FULL!' : `Status: ${result.paymentStatus}`;
                        showStatus('purchasesStatus', `‚úÖ Payment recorded! $${newTotal.toFixed(2)} total paid. ${statusMsg}`, 'success');
                        loadPurchases();
                    } else {
                        showStatus('purchasesStatus', '‚ùå Error: ' + (result?.message || 'Unknown error'), 'error');
                    }
                })
                .catch(err => {
                    showStatus('purchasesStatus', '‚ùå Error recording payment: ' + err.message, 'error');
                });
        }

        // ==================== SALES ====================

        function showAddSaleForm() {
            loadSaleDropdowns();
            document.getElementById('addSaleForm').style.display = 'block';
        }

        function hideAddSaleForm() {
            document.getElementById('addSaleForm').style.display = 'none';
            document.querySelector('#addSaleForm form').reset();
        }

        async function loadSaleDropdowns() {
            if (cachedCustomers.length === 0) {
                const result = await apiCall('getCustomers');
                if (result && result.status === 'success') {
                    cachedCustomers = result.data;
                }
            }

            const select = document.getElementById('soCustomer');
            select.innerHTML = '<option value="">Select Customer</option>';
            cachedCustomers.forEach(c => {
                select.innerHTML += `<option value="${c.Customer_ID}">${c.Customer_Name}</option>`;
            });

            if (cachedItems.length === 0) {
                const result = await apiCall('getItems');
                if (result && result.status === 'success') {
                    cachedItems = result.data;
                    console.log('loadSaleDropdowns: Loaded items, first item Unit_Sell_Price:', cachedItems[0]?.Unit_Sell_Price); // DEBUG
                }
            }

            console.log('loadSaleDropdowns: Populating dropdowns with', cachedItems.length, 'items'); // DEBUG
            console.log('loadSaleDropdowns: First item Unit_Sell_Price:', cachedItems[0]?.Unit_Sell_Price); // DEBUG
            
            document.querySelectorAll('.so-item').forEach(select => {
                select.innerHTML = '<option value="">Select Item</option>';
                cachedItems.forEach(item => {
                    console.log(`Adding option: ${item.Item_Description}, Unit_Sell_Price: ${item.Unit_Sell_Price}`); // DEBUG
                    select.innerHTML += `<option value="${item.Item_ID}" data-price="${item.Unit_Sell_Price}" data-stock="${item.Qty_On_Hand || 0}">${item.Item_Description}</option>`;
                });
            });
            
            console.log('loadSaleDropdowns: Dropdown populated!'); // DEBUG
        }

        function addSOLineItem() {
            const container = document.getElementById('soLineItems');
            
            // Get all items once
            if (cachedItems.length === 0) {
                alert('Please wait for items to load');
                return;
            }
            
            const newRow = document.createElement('div');
            newRow.className = 'line-item-row';
            newRow.innerHTML = `
                <select class="so-item" required>
                    <option value="">Select Item</option>
                    ${cachedItems.map(item => {
                        console.log('Item:', item.Item_Description, 'Unit_Sell_Price:', item.Unit_Sell_Price); // DEBUG
                        return `<option value="${item.Item_ID}" data-price="${item.Unit_Sell_Price}" data-stock="${item.Qty_On_Hand || 0}">${item.Item_Description}</option>`;
                    }).join('')}
                </select>
                <input type="number" class="so-qty" placeholder="# of Units" min="1" required>
                <input type="number" class="so-price" placeholder="Price per Unit" step="0.01" min="0" required>
                <button type="button" class="remove-btn">‚úï</button>
                <div class="so-stock-info" style="grid-column: 1 / -1; font-size: 13px; padding: 5px 10px; margin-top: -5px; display: none;"></div>
            `;
            container.appendChild(newRow);
            
            // Attach event listeners programmatically (CSP-safe)
            const itemSelect = newRow.querySelector('.so-item');
            const qtyInput = newRow.querySelector('.so-qty');
            const priceInput = newRow.querySelector('.so-price');
            const removeBtn = newRow.querySelector('.remove-btn');
            
            console.log('Attaching listeners to:', itemSelect); // DEBUG
            
            itemSelect.addEventListener('change', function() {
                console.log('CHANGE EVENT FIRED!'); // DEBUG
                updateSOItemInfo(this);
            });
            
            qtyInput.addEventListener('input', function() {
                // Update stock info when quantity changes
                const row = this.closest('.line-item-row');
                const itemSelect = row.querySelector('.so-item');
                if (itemSelect.value) {
                    updateSOItemInfo(itemSelect);
                }
                calculateSOTotal();
            });
            
            priceInput.addEventListener('input', function() {
                calculateSOTotal();
            });
            
            removeBtn.addEventListener('click', function() {
                removeLineItem(this);
                calculateSOTotal();
            });
            
            console.log('Event listeners attached successfully!'); // DEBUG
        }
        
        function updateSOItemInfo(selectElement) {
            console.log('updateSOItemInfo called!'); // DEBUG
            const option = selectElement.options[selectElement.selectedIndex];
            console.log('Selected option:', option); // DEBUG
            console.log('Option text:', option.text); // DEBUG
            console.log('data-price attribute:', option.getAttribute('data-price')); // DEBUG
            console.log('data-stock attribute:', option.getAttribute('data-stock')); // DEBUG
            
            const price = option.getAttribute('data-price');
            const stock = parseFloat(option.getAttribute('data-stock')) || 0;
            
            const row = selectElement.closest('.line-item-row');
            const priceInput = row.querySelector('.so-price');
            const qtyInput = row.querySelector('.so-qty');
            const stockInfoDiv = row.querySelector('.so-stock-info');
            
            if (price) {
                console.log('Setting price to:', price); // DEBUG
                priceInput.value = price;
            } else {
                console.log('NO PRICE FOUND!'); // DEBUG
            }
            
            // Show stock info
            if (stockInfoDiv && option.value) {
                stockInfoDiv.style.display = 'block';
                
                const qty = parseFloat(qtyInput.value) || 0;
                const remaining = stock - qty;
                
                let message = `üì¶ Current Stock: ${stock} units`;
                let bgColor = '#e3f2fd';
                let textColor = '#1565c0';
                
                if (qty > 0) {
                    message += ` ‚Üí After sale: ${remaining} units`;
                    
                    if (remaining < 0) {
                        bgColor = '#ffebee';
                        textColor = '#c62828';
                        message += ' ‚ö†Ô∏è INSUFFICIENT STOCK - This will create a negative inventory!';
                    } else if (remaining === 0) {
                        bgColor = '#fff3e0';
                        textColor = '#ef6c00';
                        message += ' ‚ö†Ô∏è This will deplete stock to zero';
                    } else if (remaining < 10) {
                        bgColor = '#fff3e0';
                        textColor = '#ef6c00';
                        message += ' ‚ö†Ô∏è Low stock warning';
                    }
                }
                
                stockInfoDiv.textContent = message;
                stockInfoDiv.style.background = bgColor;
                stockInfoDiv.style.color = textColor;
                stockInfoDiv.style.border = `1px solid ${textColor}`;
                stockInfoDiv.style.borderRadius = '4px';
            }
            
            calculateSOTotal();
        }
        
        function calculateSOTotal() {
            let total = 0;
            document.querySelectorAll('#soLineItems .line-item-row').forEach(row => {
                const qty = parseInt(row.querySelector('.so-qty')?.value) || 0;
                const price = parseFloat(row.querySelector('.so-price')?.value) || 0;
                total += qty * price;
            });
            const totalField = document.getElementById('soTotal');
            if (totalField) {
                totalField.value = total.toFixed(2);
            }
        }

        let isSavingSale = false; // Prevent double-click
        
        async function addSale(e) {
            e.preventDefault();
            
            // Prevent double-click
            if (isSavingSale) {
                console.log('Already saving sale, ignoring duplicate click');
                return;
            }
            
            const lineItems = [];
            let calculatedTotal = 0;
            
            document.querySelectorAll('#soLineItems .line-item-row').forEach(row => {
                const qty = parseInt(row.querySelector('.so-qty').value) || 0;
                const price = parseFloat(row.querySelector('.so-price').value) || 0;
                const lineTotal = qty * price;
                
                lineItems.push({
                    itemId: row.querySelector('.so-item').value,
                    quantity: qty,
                    unitPrice: price
                });
                
                calculatedTotal += lineTotal;
            });

            // LOCK - Prevent double submit
            isSavingSale = true;
            
            // Find and disable submit button
            const submitBtn = document.querySelector('#addSaleForm button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : '';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Saving...';
            }
            
            try {
                // AUTO-GENERATE INVOICE NUMBER
                // Format: INV-MMDDYY-XXX (e.g., INV-120725-001)
                const saleDate = document.getElementById('soDate').value;
                const dateObj = saleDate ? new Date(saleDate) : new Date();
                
                // Format date as MMDDYY
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                const year = String(dateObj.getFullYear()).slice(-2); // Last 2 digits
                const dateStr = `${month}${day}${year}`;
                
                // Get all existing sales orders to find the next number for this date
                const existingSales = await apiCall('getSalesOrders');
                let nextNumber = 1;
                
                if (existingSales && existingSales.data && existingSales.data.length > 0) {
                    // Find highest invoice number for this date
                    const prefix = `INV-${dateStr}-`;
                    const todayInvoices = existingSales.data
                        .filter(so => so.Invoice_Number && so.Invoice_Number.startsWith(prefix))
                        .map(so => {
                            const parts = so.Invoice_Number.split('-');
                            return parseInt(parts[2]) || 0;
                        });
                    
                    if (todayInvoices.length > 0) {
                        nextNumber = Math.max(...todayInvoices) + 1;
                    }
                }
                
                // Generate invoice number: INV-120725-001
                const invoiceNumber = `INV-${dateStr}-${String(nextNumber).padStart(3, '0')}`;

                const data = {
                    customerId: document.getElementById('soCustomer').value,
                    saleDate: document.getElementById('soDate').value,
                    invoiceNumber: invoiceNumber,
                    paymentMethod: document.getElementById('soPayment').value,
                    dueDate: document.getElementById('soDueDate').value || null,
                    totalAmount: calculatedTotal,
                    amountPaid: parseFloat(document.getElementById('soAmountPaid').value) || 0,
                    status: document.getElementById('soStatus').value,
                    notes: document.getElementById('soNotes').value,
                    lines: lineItems
                };

                const result = await apiCall('createSalesOrder', data);
                
                if (result && result.status === 'success') {
                    showStatus('salesStatus', `‚úÖ Sale recorded! Invoice #: ${invoiceNumber}`, 'success');
                    hideAddSaleForm();
                    loadSales();
                } else {
                    showStatus('salesStatus', '‚ùå Error: ' + (result?.message || 'Unknown error'), 'error');
                }
            } finally {
                // UNLOCK
                isSavingSale = false;
                
                // Re-enable button
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText || 'üíæ Save Sale';
                }
            }
        }

        let salesData = []; // Cache for filtering
        
        async function loadSales() {
            document.getElementById('salesTable').innerHTML = '<div class="loading">Loading sales...</div>';
            
            // Load customers FIRST if not cached
            if (cachedCustomers.length === 0) {
                const custResult = await apiCall('getCustomers');
                if (custResult && custResult.status === 'success') {
                    cachedCustomers = custResult.data;
                }
            }
            
            // Now load and display sales
            const result = await apiCall('getSalesOrders');
            
            if (result && result.status === 'success') {
                salesData = result.data;
                displaySales(result.data);
                loadSaleFilterCustomers(); // Populate filter dropdown
            } else {
                document.getElementById('salesTable').innerHTML = '<div class="loading">Error loading sales</div>';
            }
        }
        
        async function loadSaleFilterCustomers() {
            if (cachedCustomers.length === 0) {
                const result = await apiCall('getCustomers');
                if (result && result.status === 'success') {
                    cachedCustomers = result.data;
                }
            }
            
            const select = document.getElementById('filterSaleCustomer');
            select.innerHTML = '<option value="">All Customers</option>';
            cachedCustomers.forEach(c => {
                select.innerHTML += `<option value="${c.Customer_ID}">${c.Customer_Name}</option>`;
            });
        }
        
        function filterSales() {
            const customerFilter = document.getElementById('filterSaleCustomer').value;
            const invoiceNumberFilter = document.getElementById('filterInvoiceNumber').value.trim().toLowerCase();
            const dateFrom = document.getElementById('filterSaleDateFrom').value;
            const dateTo = document.getElementById('filterSaleDateTo').value;
            
            const filtered = salesData.filter(so => {
                const matchesCustomer = !customerFilter || so.Customer_ID === customerFilter;
                const matchesInvoice = !invoiceNumberFilter || (so.Invoice_Number && so.Invoice_Number.toLowerCase().includes(invoiceNumberFilter));
                const soDate = new Date(so.SO_Date);
                const matchesDateFrom = !dateFrom || soDate >= new Date(dateFrom);
                const matchesDateTo = !dateTo || soDate <= new Date(dateTo);
                return matchesCustomer && matchesInvoice && matchesDateFrom && matchesDateTo;
            });
            
            displaySales(filtered);
        }
        
        function clearSaleFilters() {
            document.getElementById('filterSaleCustomer').value = '';
            document.getElementById('filterInvoiceNumber').value = '';
            document.getElementById('filterSaleDateFrom').value = '';
            document.getElementById('filterSaleDateTo').value = '';
            displaySales(salesData);
        }

        function displaySales(orders) {
            if (!orders || orders.length === 0) {
                document.getElementById('salesTable').innerHTML = '<p>No sales yet. Record your first sale!</p>';
                return;
            }

            // Calculate totals
            let totalAmount = 0;
            let totalPaid = 0;
            
            // Cache sales for row click
            window.cachedSales = orders;
            
            let html = '<table class="data-table" id="salesDataTable"><thead><tr>';
            html += '<th>Invoice #</th><th>Customer</th><th>Date</th><th>Total</th><th>Paid</th><th>Due Date</th><th>Payment</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            orders.forEach(so => {
                const dueDate = so.Due_Date ? new Date(so.Due_Date).toLocaleDateString() : '-';
                const paymentStatus = so.Payment_Status || 'Unpaid';
                const amountPaid = parseFloat(so.Amount_Paid) || 0;
                const total = parseFloat(so.Total_Amount || so.Order_Total) || 0;
                const invoiceNum = so.Invoice_Number || so.SO_ID;
                
                totalAmount += total;
                totalPaid += amountPaid;
                
                // Color code payment status badge
                let paymentBadge = '';
                if (paymentStatus === 'Paid') paymentBadge = '<span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Paid</span>';
                else if (paymentStatus === 'Partial') paymentBadge = '<span style="background: #ffc107; color: black; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Partial</span>';
                else paymentBadge = '<span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Unpaid</span>';
                
                html += `<tr style="cursor: pointer;" onclick="viewSalesOrder('${so.SO_ID}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                    <td><strong>${invoiceNum}</strong></td>
                    <td>${getCustomerName(so.Customer_ID)}</td>
                    <td>${new Date(so.Sale_Date || so.SO_Date).toLocaleDateString()}</td>
                    <td>$${total.toFixed(2)}</td>
                    <td>$${amountPaid.toFixed(2)}</td>
                    <td>${dueDate}</td>
                    <td>${paymentBadge}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="btn-small" onclick="viewSalesOrder('${so.SO_ID}')" style="background: #28a745; color: white; padding: 6px 12px;">View/Print</button>
                    </td>
                </tr>`;
            });

            // Add totals row
            const balance = totalAmount - totalPaid;
            html += `<tr style="background: #f0f0f0; font-weight: bold; border-top: 3px solid #667eea;">
                <td colspan="3" style="text-align: right; padding-right: 20px;">TOTALS:</td>
                <td>$${totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>$${totalPaid.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td colspan="3" style="text-align: left;">Balance: <strong style="color: ${balance > 0 ? '#dc3545' : '#28a745'};">$${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
            </tr>`;

            html += '</tbody></table>';
            document.getElementById('salesTable').innerHTML = html;
            setTimeout(() => makeSortable('salesDataTable'), 0);
        }
        
        // View Sales Order (opens modal with print option)
        function viewSalesOrder(soId) {
            const so = window.cachedSales?.find(s => s.SO_ID === soId);
            if (so) {
                showSalesOrderDetails(so);
            }
        }
        
        // Edit Sales Order
        async function editSalesOrder(soId) {
            // Find the SO in cached data or fetch it
            const result = await apiCall('getSalesOrders');
            if (result && result.status === 'success') {
                const so = result.data.find(s => s.SO_ID === soId);
                if (so) {
                    showSalesOrderDetails(so);
                }
            }
        }
        
        async function showSalesOrderDetails(so) {
            currentEditingOrder = so;
            currentEditingType = 'sales';
            
            // Load items if not cached
            if (cachedItems.length === 0) {
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
            }
            
            // Get line items
            const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
            const lines = linesResult?.data || [];
            
            const customerName = getCustomerName(so.Customer_ID);
            const dueDate = so.Due_Date ? new Date(so.Due_Date).toLocaleDateString() : '-';
            const invoiceDate = so.Invoice_Date ? new Date(so.Invoice_Date).toLocaleDateString() : '-';
            
            document.getElementById('modalTitle').textContent = `Sales Order: ${so.Invoice_Number || so.SO_ID}`;
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Order Information</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px 0; font-weight: bold; width: 140px;">Customer:</td><td>${customerName}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Invoice #:</td><td>${so.Invoice_Number || '-'}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Sale Date:</td><td>${new Date(so.Sale_Date).toLocaleDateString()}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Invoice Date:</td><td>${invoiceDate}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Due Date:</td><td>${dueDate}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Payment Method:</td><td>${so.Payment_Method}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Status:</td><td><span style="background: #d4edda; color: #155724; padding: 4px 12px; border-radius: 12px; font-size: 12px;">${so.Status}</span></td></tr>
                        </table>
                    </div>
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Payment Information</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px 0; font-weight: bold; width: 140px;">Total Amount:</td><td style="font-size: 18px; color: #2c3e50;">$${parseFloat(so.Total_Amount || 0).toFixed(2)}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Amount Paid:</td><td style="color: #27ae60;">$${parseFloat(so.Amount_Paid || 0).toFixed(2)}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Balance Due:</td><td style="color: #e74c3c; font-size: 16px; font-weight: bold;">$${(parseFloat(so.Total_Amount || 0) - parseFloat(so.Amount_Paid || 0)).toFixed(2)}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Payment Status:</td><td><span style="background: ${so.Payment_Status === 'Paid' ? '#d4edda' : '#fff3cd'}; color: ${so.Payment_Status === 'Paid' ? '#155724' : '#856404'}; padding: 4px 12px; border-radius: 12px; font-size: 12px;">${so.Payment_Status}</span></td></tr>
                        </table>
                    </div>
                </div>
            `;
            
            if (lines.length > 0) {
                html += `
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">üì¶ Line Items</h3>
                    <div style="overflow-x: auto;">
                    <table class="data-table" style="margin-bottom: 20px; font-size: 14px;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th style="padding: 12px 15px;">Item</th>
                                <th style="padding: 12px 15px;">Description</th>
                                <th style="padding: 12px 15px;">Qty</th>
                                <th style="padding: 12px 15px;">Unit Price</th>
                                <th style="padding: 12px 15px;">Line Total</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                lines.forEach(line => {
                    const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                    const lineTotal = (parseFloat(line.Quantity) || 0) * (parseFloat(line.Unit_Price) || 0);
                    html += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px 15px;"><strong>${item?.SKU || line.Item_ID}</strong></td>
                            <td style="padding: 12px 15px;">${item ? item.Item_Description : '-'}</td>
                            <td style="padding: 12px 15px; text-align: center; font-weight: bold;">${line.Quantity}</td>
                            <td style="padding: 12px 15px; text-align: right;">$${parseFloat(line.Unit_Price || 0).toFixed(2)}</td>
                            <td style="padding: 12px 15px; text-align: right; font-weight: bold;">$${lineTotal.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                    </div>
                `;
            }
            
            if (so.Notes) {
                html += `
                    <div style="margin-top: 20px;">
                        <h3 style="color: #667eea; margin-bottom: 10px;">Notes</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            ${so.Notes}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalEditBtn').style.display = 'inline-block';
            document.getElementById('modalPrintBtn').style.display = 'inline-block';
            document.getElementById('modalPrintBtn').textContent = 'üñ®Ô∏è Print Invoice';
            document.getElementById('modalPrintBtn').onclick = () => printInvoice();
            document.getElementById('modalSaveBtn').style.display = 'none';
            document.getElementById('orderModal').style.display = 'block';
        }
        
        function recordSalesPayment(soId, total, amountPaid) {
            const remaining = total - amountPaid;
            
            // Create better formatted prompt
            let message = `üí∞ Record Payment for ${soId}\n\n`;
            message += `Invoice Total:    $${total.toFixed(2)}\n`;
            message += `Already Paid:     $${amountPaid.toFixed(2)}\n`;
            message += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            message += `Balance Due:      $${remaining.toFixed(2)}\n\n`;
            
            // Suggest full payment if unpaid
            if (amountPaid === 0) {
                message += `Tip: Enter ${remaining.toFixed(2)} to pay in full\n\n`;
            }
            
            message += `Enter payment amount:`;
            
            const payment = prompt(message);
            
            if (payment === null) return; // Cancelled
            
            const paymentAmount = parseFloat(payment);
            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                alert('Please enter a valid payment amount');
                return;
            }
            
            if (paymentAmount > remaining + 0.01) { // Allow 1 cent rounding
                if (!confirm(`Payment ($${paymentAmount.toFixed(2)}) is more than balance due ($${remaining.toFixed(2)}).\n\nContinue anyway?`)) {
                    return;
                }
            }
            
            // Call backend
            apiCall('recordSalesPayment', { soId: soId, paymentAmount: paymentAmount })
                .then(result => {
                    if (result && result.status === 'success') {
                        const newTotal = amountPaid + paymentAmount;
                        const statusMsg = result.paymentStatus === 'Paid' ? '‚úÖ PAID IN FULL!' : `Status: ${result.paymentStatus}`;
                        showStatus('salesStatus', `‚úÖ Payment received! $${newTotal.toFixed(2)} total paid. ${statusMsg}`, 'success');
                        loadSales();
                    } else {
                        showStatus('salesStatus', '‚ùå Error: ' + (result?.message || 'Unknown error'), 'error');
                    }
                })
                .catch(err => {
                    showStatus('salesStatus', '‚ùå Error recording payment: ' + err.message, 'error');
                });
        }

        // ==================== INVENTORY ====================

        let inventoryData = []; // Cache for filtering
        
        async function loadInventory() {
            document.getElementById('inventoryTable').innerHTML = '<div class="loading">Loading inventory...</div>';
            
            // Load suppliers FIRST if not cached
            if (cachedSuppliers.length === 0) {
                const suppResult = await apiCall('getSuppliers');
                if (suppResult && suppResult.status === 'success') {
                    cachedSuppliers = suppResult.data;
                }
            }
            
            // Now load and display inventory
            const result = await apiCall('getInventoryReport');
            
            if (result && result.status === 'success') {
                inventoryData = result.data;
                displayInventory(result.data);
                loadInventoryFilterSuppliers(); // Populate filter dropdown
            } else {
                document.getElementById('inventoryTable').innerHTML = '<div class="loading">Error loading inventory</div>';
            }
        }
        
        async function loadInventoryFilterSuppliers() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }
            
            const select = document.getElementById('filterInventorySupplier');
            select.innerHTML = '<option value="">All Suppliers</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }
        
        function filterInventory() {
            const searchFilter = document.getElementById('filterInventorySearch').value.toLowerCase();
            const supplierFilter = document.getElementById('filterInventorySupplier').value;
            const stockFilter = document.getElementById('filterInventoryStock').value;
            
            const filtered = inventoryData.filter(item => {
                const matchesSearch = !searchFilter || 
                    (item.SKU && item.SKU.toString().toLowerCase().includes(searchFilter)) ||
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(searchFilter));
                const matchesSupplier = !supplierFilter || item.Supplier_ID === supplierFilter;
                const matchesStock = !stockFilter || 
                    (stockFilter === 'low' && item.Low_Stock) ||
                    (stockFilter === 'ok' && !item.Low_Stock);
                return matchesSearch && matchesSupplier && matchesStock;
            });
            
            displayInventory(filtered);
        }
        
        function clearInventoryFilters() {
            document.getElementById('filterInventorySearch').value = '';
            document.getElementById('filterInventorySupplier').value = '';
            document.getElementById('filterInventoryStock').value = '';
            displayInventory(inventoryData);
        }
        
        function filterInventoryByStatus(status, event) {
            // Prevent scroll jump
            if (event) event.preventDefault();
            
            // Save scroll position
            const scrollPos = window.scrollY;
            
            // Set the dropdown to match
            const stockDropdown = document.getElementById('filterInventoryStock');
            if (stockDropdown) stockDropdown.value = status;
            
            if (!status) {
                displayInventory(inventoryData);
                // Restore scroll position after render
                setTimeout(() => window.scrollTo(0, scrollPos), 0);
                return;
            }
            
            const filtered = inventoryData.filter(item => {
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                
                if (status === 'negative') return qty < 0;
                if (status === 'out') return qty === 0;
                if (status === 'low') return qty > 0 && qty <= reorderPoint;
                if (status === 'ok') return qty > reorderPoint;
                return true;
            });
            
            displayInventory(filtered);
            // Restore scroll position after render
            setTimeout(() => window.scrollTo(0, scrollPos), 0);
        }

        function displayInventory(items) {
            if (!items || items.length === 0) {
                document.getElementById('inventoryTable').innerHTML = '<p>No inventory yet.</p>';
                return;
            }

            // Calculate totals FIRST for summary
            let totalQty = 0;
            let totalCostValue = 0;
            let totalSellValue = 0;
            let negativeCount = 0;
            let outOfStockCount = 0;
            let lowStockCount = 0;
            let inStockCount = 0;
            
            items.forEach(item => {
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPackage;
                const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                
                totalQty += qty;
                totalCostValue += qty * unitCost;
                totalSellValue += qty * unitSellPrice;
                
                if (qty < 0) negativeCount++;
                else if (qty === 0) outOfStockCount++;
                else if (qty <= reorderPoint) lowStockCount++;
                else inStockCount++;
            });
            
            // BUILD STATUS TAGS FIRST (clickable filters) - above summary boxes
            let html = `
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    ${negativeCount > 0 ? `<span onclick="filterInventoryByStatus('negative', event)" style="background: #b71c1c; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">üö® ${negativeCount} Negative</span>` : ''}
                    ${outOfStockCount > 0 ? `<span onclick="filterInventoryByStatus('out', event)" style="background: #c62828; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">üî¥ ${outOfStockCount} Out of Stock</span>` : ''}
                    ${lowStockCount > 0 ? `<span onclick="filterInventoryByStatus('low', event)" style="background: #ef6c00; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">üü° ${lowStockCount} Low Stock</span>` : ''}
                    <span onclick="filterInventoryByStatus('ok', event)" style="background: #2e7d32; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">üü¢ ${inStockCount} In Stock</span>
                    <span onclick="filterInventoryByStatus('', event)" style="background: #6c757d; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">Show All</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; border: 2px solid #dee2e6; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: bold; color: #212529;">${items.length}</div>
                        <div style="font-size: 13px; color: #6c757d;">Total Items</div>
                    </div>
                    <div style="background: #f8f9fa; border: 2px solid #dee2e6; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: bold; color: #212529;">${totalQty.toLocaleString()}</div>
                        <div style="font-size: 13px; color: #6c757d;">Total Units</div>
                    </div>
                    <div style="background: #f8f9fa; border: 2px solid #dee2e6; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: bold; color: #dc3545;">$${totalCostValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="font-size: 13px; color: #6c757d;">Cost Value</div>
                    </div>
                    <div style="background: #f8f9fa; border: 2px solid #dee2e6; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: bold; color: #28a745;">$${totalSellValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="font-size: 13px; color: #6c757d;">Sell Value</div>
                    </div>
                    <div style="background: #f8f9fa; border: 2px solid #dee2e6; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: bold; color: ${(totalSellValue - totalCostValue) >= 0 ? '#1565c0' : '#c62828'};">$${(totalSellValue - totalCostValue).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="font-size: 13px; color: #6c757d;">Net Profit</div>
                    </div>
                </div>
            `;
            
            // BUILD TABLE
            html += '<table class="data-table" id="inventoryDataTable"><thead><tr>';
            html += '<th>SKU</th><th>Description</th><th>Supplier</th><th>Qty</th><th>Reorder</th><th>Cost</th><th>Sell</th><th>Cost Value</th><th>Sell Value</th><th>Net Profit</th><th>Updated</th><th>Status</th>';
            html += '</tr></thead><tbody>';

            items.forEach(item => {
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                const lastUpdated = item.Last_Updated ? new Date(item.Last_Updated).toLocaleDateString() : '-';
                
                // Calculate values
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPackage;
                const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const costValue = qty * unitCost;
                const sellValue = qty * unitSellPrice;
                const netProfit = sellValue - costValue;
                
                // Determine status with color coding
                let status = '';
                let statusStyle = '';
                let rowStyle = '';
                
                if (qty < 0) {
                    status = 'NEGATIVE';
                    statusStyle = 'background: #b71c1c; color: white;';
                    rowStyle = 'background: #ffcdd2;';
                } else if (qty === 0) {
                    status = 'OUT OF STOCK';
                    statusStyle = 'background: #c62828; color: white;';
                    rowStyle = 'background: #ffebee;';
                } else if (qty <= reorderPoint) {
                    status = 'LOW STOCK';
                    statusStyle = 'background: #ef6c00; color: white;';
                    rowStyle = 'background: #fff3e0;';
                } else {
                    status = 'IN STOCK';
                    statusStyle = 'background: #2e7d32; color: white;';
                }
                
                html += `<tr style="${rowStyle} cursor: pointer;" onclick="openItem('${item.Item_ID}')" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                    <td><strong>${item.SKU || '-'}</strong></td>
                    <td style="color: #667eea;"><strong>${item.Item_Description}</strong></td>
                    <td>${getSupplierName(item.Supplier_ID)}</td>
                    <td><strong style="${qty < 0 ? 'color: #b71c1c;' : ''}">${qty}</strong></td>
                    <td>${reorderPoint}</td>
                    <td>$${unitCost.toFixed(2)}</td>
                    <td>$${unitSellPrice.toFixed(2)}</td>
                    <td>$${costValue.toFixed(2)}</td>
                    <td style="color: #2e7d32; font-weight: bold;">$${sellValue.toFixed(2)}</td>
                    <td style="color: ${netProfit >= 0 ? '#1565c0' : '#c62828'}; font-weight: bold;">$${netProfit.toFixed(2)}</td>
                    <td style="font-size: 11px; color: #666;">${lastUpdated}</td>
                    <td><span style="${statusStyle} padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap;">${status}</span></td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('inventoryTable').innerHTML = html;
            setTimeout(() => makeSortable('inventoryDataTable'), 0);
        }
        
        // ==================== PRICE SIMULATOR ====================
        
        let pricesimItems = [];
        let pricesimFiltered = [];
        let simulatedNewItems = []; // Track new items added for simulation
        
        // New Item Simulation Functions
        function calcNewSimUnitCost() {
            const packageCost = parseFloat(document.getElementById('newSimPackageCost').value) || 0;
            const unitsPerPkg = parseFloat(document.getElementById('newSimUnitsPerPkg').value) || 1;
            const unitCost = packageCost / unitsPerPkg;
            document.getElementById('newSimUnitCost').value = '$' + unitCost.toFixed(2);
            calcNewSimSellPrice();
        }
        
        function calcNewSimSellPrice() {
            const packageCost = parseFloat(document.getElementById('newSimPackageCost').value) || 0;
            const unitsPerPkg = parseFloat(document.getElementById('newSimUnitsPerPkg').value) || 1;
            const markup = parseFloat(document.getElementById('newSimMarkup').value) || 0;
            const unitCost = packageCost / unitsPerPkg;
            const sellPrice = unitCost * (1 + markup / 100);
            document.getElementById('newSimSellPrice').value = '$' + sellPrice.toFixed(2);
        }
        
        function clearNewSimForm() {
            document.getElementById('newSimSupplier').value = '';
            document.getElementById('newSimSKU').value = '';
            document.getElementById('newSimDescription').value = '';
            document.getElementById('newSimPackageCost').value = '';
            document.getElementById('newSimUnitsPerPkg').value = '1';
            document.getElementById('newSimMarkup').value = '30';
            document.getElementById('newSimUnitCost').value = '$0.00';
            document.getElementById('newSimSellPrice').value = '$0.00';
        }
        
        function addNewItemToSimulation() {
            const supplierId = document.getElementById('newSimSupplier').value;
            const sku = document.getElementById('newSimSKU').value.trim();
            const description = document.getElementById('newSimDescription').value.trim();
            const packageCost = parseFloat(document.getElementById('newSimPackageCost').value) || 0;
            const unitsPerPkg = parseFloat(document.getElementById('newSimUnitsPerPkg').value) || 1;
            const markup = parseFloat(document.getElementById('newSimMarkup').value) || 0;
            
            // Validation with alerts
            if (!supplierId) {
                alert('Please select a supplier');
                return false;
            }
            if (!description) {
                alert('Please enter a description');
                return false;
            }
            if (packageCost <= 0) {
                alert('Please enter a package cost greater than 0');
                return false;
            }
            
            const unitCost = packageCost / unitsPerPkg;
            const sellPrice = unitCost * (1 + markup / 100);
            
            // Create a simulated item object
            const newItem = {
                Item_ID: 'NEW_' + Date.now(), // Temporary ID
                Supplier_ID: supplierId,
                SKU: sku || 'NEW',
                Item_Description: description,
                Package_Cost: packageCost,
                Units_Per_Package: unitsPerPkg,
                Unit_Sell_Price: sellPrice,
                Qty_On_Hand: 0,
                Reorder_Point: 0,
                isNew: true, // Flag to identify new items
                markup: markup
            };
            
            // Initialize arrays if needed
            if (!simulatedNewItems) simulatedNewItems = [];
            if (!pricesimItems) pricesimItems = [];
            if (!pricesimFiltered) pricesimFiltered = [];
            
            simulatedNewItems.push(newItem);
            pricesimItems.push(newItem);
            pricesimFiltered = [...pricesimItems];
            
            displayPriceSimItems();
            clearNewSimForm();
            
            showStatus('pricesimStatus', `‚úÖ Added "${description}" to simulation. ${simulatedNewItems.length} new item(s) pending.`, 'success');
            
            // Scroll to show the table
            document.getElementById('pricesimTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            return false;
        }
        
        function removeSimulatedItem(tempId) {
            simulatedNewItems = simulatedNewItems.filter(item => item.Item_ID !== tempId);
            pricesimItems = pricesimItems.filter(item => item.Item_ID !== tempId);
            pricesimFiltered = pricesimFiltered.filter(item => item.Item_ID !== tempId);
            displayPriceSimItems();
            showStatus('pricesimStatus', `Removed item. ${simulatedNewItems.length} new item(s) pending.`, 'info');
        }
        
        async function saveNewItemsToDatabase() {
            if (simulatedNewItems.length === 0) {
                alert('No new items to save!');
                return;
            }
            
            if (!confirm(`Save ${simulatedNewItems.length} new item(s) to your database?`)) {
                return;
            }
            
            showStatus('pricesimStatus', '‚è≥ Saving new items...', 'info');
            
            let savedCount = 0;
            for (const item of simulatedNewItems) {
                const result = await apiCall('addItem', {
                    supplierId: item.Supplier_ID,
                    sku: item.SKU,
                    description: item.Item_Description,
                    purchaseUOM: 'Each',
                    unitsPerPackage: item.Units_Per_Package,
                    packageCost: item.Package_Cost,
                    unitSellPrice: item.Unit_Sell_Price,
                    qtyOnHand: 0,
                    reorderPoint: 0
                });
                if (result?.status === 'success') savedCount++;
            }
            
            simulatedNewItems = [];
            showStatus('pricesimStatus', `‚úÖ Saved ${savedCount} new items to database!`, 'success');
            
            // Reload to get fresh data with real IDs
            await loadPriceSimItems();
        }
        
        async function loadPriceSimItems() {
            showStatus('pricesimStatus', '‚è≥ Loading items...', 'info');
            document.getElementById('pricesimTable').innerHTML = '<div class="loading">Loading items...</div>';
            
            try {
                // Load suppliers for filter
                if (cachedSuppliers.length === 0) {
                    const suppResult = await apiCall('getSuppliers');
                    if (suppResult?.status === 'success') cachedSuppliers = suppResult.data;
                }
                
                // Populate both supplier dropdowns
                const supplierSelect = document.getElementById('pricesimSupplier');
                const newSimSupplier = document.getElementById('newSimSupplier');
                
                if (supplierSelect) {
                    supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
                    cachedSuppliers.forEach(s => {
                        supplierSelect.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                    });
                }
                
                if (newSimSupplier) {
                    newSimSupplier.innerHTML = '<option value="">Select Supplier</option>';
                    cachedSuppliers.forEach(s => {
                        newSimSupplier.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                    });
                }
                
                // Load items
                const result = await apiCall('getItems');
                if (result?.status === 'success' && result.data && result.data.length > 0) {
                    pricesimItems = result.data;
                    // Add any simulated new items back
                    simulatedNewItems.forEach(item => {
                        pricesimItems.push(item);
                    });
                    pricesimFiltered = [...pricesimItems];
                    displayPriceSimItems();
                    showStatus('pricesimStatus', `‚úÖ Loaded ${pricesimItems.length} items (${simulatedNewItems.length} new)`, 'success');
                } else {
                    document.getElementById('pricesimTable').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No items found. Add items in the Items tab first.</p>';
                    showStatus('pricesimStatus', '‚ö†Ô∏è No items found in database', 'info');
                }
            } catch (error) {
                console.error('Price Sim load error:', error);
                showStatus('pricesimStatus', '‚ùå Error loading items: ' + error.message, 'error');
            }
        }
        
        function filterPriceSimItems() {
            const search = document.getElementById('pricesimSearch').value.toLowerCase();
            const supplier = document.getElementById('pricesimSupplier').value;
            const stock = document.getElementById('pricesimStock').value;
            
            pricesimFiltered = pricesimItems.filter(item => {
                const matchSearch = !search || 
                    (item.SKU && item.SKU.toString().toLowerCase().includes(search)) ||
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(search));
                const matchSupplier = !supplier || item.Supplier_ID === supplier;
                
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const reorder = parseFloat(item.Reorder_Point) || 0;
                let matchStock = true;
                if (stock === 'instock') matchStock = qty > 0 && !item.isNew;
                else if (stock === 'low') matchStock = qty > 0 && qty <= reorder && !item.isNew;
                else if (stock === 'out') matchStock = qty <= 0 && !item.isNew;
                else if (stock === 'new') matchStock = item.isNew === true;
                
                return matchSearch && matchSupplier && matchStock;
            });
            
            displayPriceSimItems();
        }
        
        function displayPriceSimItems() {
            const percent = parseFloat(document.getElementById('pricesimPercent').value) || 0;
            const flat = parseFloat(document.getElementById('pricesimFlat').value) || 0;
            
            // Debug info
            console.log('Price Sim Display - pricesimFiltered:', pricesimFiltered?.length, 'pricesimItems:', pricesimItems?.length);
            
            if (!pricesimFiltered || pricesimFiltered.length === 0) {
                if (!pricesimItems || pricesimItems.length === 0) {
                    document.getElementById('pricesimTable').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No items loaded yet. Click üîÑ Refresh to load items.</p>';
                } else {
                    document.getElementById('pricesimTable').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No items match your current filters. Try clearing the filters.</p>';
                }
                return;
            }
            
            let html = `
                <table class="data-table" id="pricesimDataTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;">‚úì</th>
                            <th>SKU</th>
                            <th>Description</th>
                            <th>Supplier</th>
                            <th>Unit Cost</th>
                            <th>Current Sell</th>
                            <th>NEW Sell</th>
                            <th>Change</th>
                            <th>Current Margin</th>
                            <th>NEW Margin</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            pricesimFiltered.forEach((item, idx) => {
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPkg = parseFloat(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPkg;
                const currentSell = parseFloat(item.Unit_Sell_Price) || 0;
                
                // Calculate new price
                let newSell = currentSell;
                if (!item.isNew) {
                    // Only apply bulk adjustment to existing items
                    if (percent > 0) {
                        newSell = currentSell * (1 + percent / 100);
                    } else if (flat > 0) {
                        newSell = currentSell + flat;
                    }
                }
                newSell = Math.round(newSell * 100) / 100; // Round to cents
                
                const change = newSell - currentSell;
                const currentMargin = currentSell > 0 ? ((currentSell - unitCost) / currentSell * 100) : 0;
                const newMargin = newSell > 0 ? ((newSell - unitCost) / newSell * 100) : 0;
                
                const hasChange = change > 0 || item.isNew;
                const isNew = item.isNew === true;
                const rowStyle = isNew ? 'background: #fff3e0;' : '';
                
                html += `
                    <tr style="${rowStyle}">
                        <td>
                            ${isNew ? 
                                `<button class="btn-delete-icon" onclick="removeSimulatedItem('${item.Item_ID}')" title="Remove">üóëÔ∏è</button>` : 
                                `<input type="checkbox" class="pricesim-check" data-idx="${idx}" data-itemid="${item.Item_ID}" data-newprice="${newSell}" data-isnew="${isNew}" onchange="updatePriceSimSummary()" ${hasChange ? 'checked' : ''}>`
                            }
                        </td>
                        <td>
                            ${isNew ? '<span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 5px;">NEW</span>' : ''}
                            <strong>${item.SKU || '-'}</strong>
                        </td>
                        <td>${item.Item_Description}</td>
                        <td>${getSupplierName(item.Supplier_ID)}</td>
                        <td>$${unitCost.toFixed(2)}</td>
                        <td>${isNew ? '-' : '$' + currentSell.toFixed(2)}</td>
                        <td style="color: #28a745; font-weight: bold;">$${newSell.toFixed(2)}</td>
                        <td style="color: ${hasChange ? '#28a745' : '#666'};">${isNew ? `+${item.markup || 0}% markup` : (hasChange ? '+$' + change.toFixed(2) : '-')}</td>
                        <td>${isNew ? '-' : currentMargin.toFixed(1) + '%'}</td>
                        <td style="color: #28a745; font-weight: bold;">${newMargin.toFixed(1)}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            // Add save new items button if there are simulated items
            if (simulatedNewItems.length > 0) {
                html += `
                    <div style="margin-top: 15px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 2px solid #ff9800;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <strong style="color: #e65100;">üÜï ${simulatedNewItems.length} New Item(s) Ready to Save</strong>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">These items are only in simulation. Click to add them to your database.</p>
                            </div>
                            <button class="btn" onclick="saveNewItemsToDatabase()" style="background: #ff9800;">
                                üíæ Save ${simulatedNewItems.length} New Item(s) to Database
                            </button>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('pricesimTable').innerHTML = html;
            
            updatePriceSimSummary();
        }
        
        // Revenue Impact Calculator
        function calculateRevenueImpact() {
            const saleAmount = parseFloat(document.getElementById('revCalcSaleAmount').value) || 100;
            const percent = parseFloat(document.getElementById('revCalcPercent').value) || 0;
            
            // Update percent label
            document.getElementById('revCalcPercentLabel').textContent = percent + '%';
            
            // Calculate values
            const afterAmount = saleAmount * (1 + percent / 100);
            const extraProfit = afterAmount - saleAmount;
            
            // Update display
            document.getElementById('revCalcBefore').textContent = '$' + saleAmount.toFixed(2);
            document.getElementById('revCalcAfter').textContent = '$' + afterAmount.toFixed(2);
            document.getElementById('revCalcProfit').textContent = '+$' + extraProfit.toFixed(2);
            
            // Projected impact (assuming 10 sales per week)
            const weekly = extraProfit * 10;
            const monthly = extraProfit * 40;
            const yearly = extraProfit * 520;
            
            document.getElementById('revCalc10Sales').textContent = '+$' + weekly.toFixed(0) + '/week';
            document.getElementById('revCalcMonthly').textContent = '+$' + monthly.toFixed(0) + '/month';
            document.getElementById('revCalcYearly').textContent = '+$' + yearly.toLocaleString() + '/year';
        }
        
        // Initialize revenue calculator on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById('revCalcSaleAmount')) {
                calculateRevenueImpact();
            }
        });
        
        function previewPriceChanges() {
            // Clear the other input when one is used
            const percent = parseFloat(document.getElementById('pricesimPercent').value) || 0;
            const flat = parseFloat(document.getElementById('pricesimFlat').value) || 0;
            
            if (percent > 0) {
                document.getElementById('pricesimFlat').value = '0';
            }
            
            displayPriceSimItems();
            document.getElementById('pricesimSummary').style.display = 'block';
        }
        
        function toggleAllPriceSimItems() {
            const selectAll = document.getElementById('pricesimSelectAll').checked;
            document.querySelectorAll('.pricesim-check').forEach(cb => {
                cb.checked = selectAll;
            });
            updatePriceSimSummary();
        }
        
        function updatePriceSimSummary() {
            const checkboxes = document.querySelectorAll('.pricesim-check:checked');
            const percent = parseFloat(document.getElementById('pricesimPercent').value) || 0;
            const flat = parseFloat(document.getElementById('pricesimFlat').value) || 0;
            
            let selectedCount = 0;
            let currentRevenue = 0;
            let newRevenue = 0;
            
            checkboxes.forEach(cb => {
                const idx = parseInt(cb.dataset.idx);
                const item = pricesimFiltered[idx];
                if (!item) return;
                
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const currentSell = parseFloat(item.Unit_Sell_Price) || 0;
                
                let newSell = currentSell;
                if (percent > 0) {
                    newSell = currentSell * (1 + percent / 100);
                } else if (flat > 0) {
                    newSell = currentSell + flat;
                }
                
                selectedCount++;
                currentRevenue += qty * currentSell;
                newRevenue += qty * newSell;
            });
            
            const increase = newRevenue - currentRevenue;
            
            document.getElementById('simSelectedCount').textContent = selectedCount;
            document.getElementById('simCurrentRevenue').textContent = '$' + currentRevenue.toFixed(2);
            document.getElementById('simNewRevenue').textContent = '$' + newRevenue.toFixed(2);
            document.getElementById('simIncrease').textContent = '+$' + increase.toFixed(2);
            document.getElementById('applyCount').textContent = selectedCount;
            
            // Show/hide apply section
            const applySection = document.getElementById('pricesimApplySection');
            const summarySection = document.getElementById('pricesimSummary');
            
            if (selectedCount > 0 && (percent > 0 || flat > 0)) {
                applySection.style.display = 'block';
                summarySection.style.display = 'block';
            } else {
                applySection.style.display = 'none';
            }
        }
        
        async function applyPriceChanges() {
            const checkboxes = document.querySelectorAll('.pricesim-check:checked');
            const count = checkboxes.length;
            
            if (count === 0) {
                alert('No items selected!');
                return;
            }
            
            if (!confirm(`Are you sure you want to update the sell price for ${count} items?\n\nThis will modify your database.`)) {
                return;
            }
            
            showStatus('pricesimStatus', `‚è≥ Updating ${count} items...`, 'info');
            
            // Collect updates
            const updates = [];
            checkboxes.forEach(cb => {
                updates.push({
                    itemId: cb.dataset.itemid,
                    newPrice: parseFloat(cb.dataset.newprice)
                });
            });
            
            // Send to backend
            const result = await apiCall('bulkUpdateSellPrices', { updates });
            
            if (result?.status === 'success') {
                showStatus('pricesimStatus', `‚úÖ Successfully updated ${count} items!`, 'success');
                // Reload items to show new prices
                await loadPriceSimItems();
                // Reset adjustment
                document.getElementById('pricesimPercent').value = '0';
                document.getElementById('pricesimFlat').value = '0';
                document.getElementById('pricesimApplySection').style.display = 'none';
            } else {
                showStatus('pricesimStatus', '‚ùå Error: ' + (result?.message || 'Failed to update'), 'error');
            }
        }
        
        // ==================== MANUAL INVENTORY ADJUSTMENT ====================
        
        async function showAdjustInventoryForm() {
            // ALWAYS load fresh inventory data from database
            showStatus('inventoryStatus', 'Loading current inventory...', 'info');
            const result = await apiCall('getInventoryReport');
            
            if (result && result.status === 'success') {
                cachedItems = result.data;
                
                const select = document.getElementById('adjustItem');
                select.innerHTML = '<option value="">Select Item</option>';
                cachedItems.forEach(item => {
                    select.innerHTML += `<option value="${item.Item_ID}">${item.Item_Description} (SKU: ${item.SKU}) - Current: ${item.Qty_On_Hand}</option>`;
                });
                
                // Attach event listeners for live calculation
                select.onchange = updateAdjustmentCalc;
                document.getElementById('adjustQuantity').oninput = updateAdjustmentCalc;
                
                document.getElementById('adjustInventoryForm').style.display = 'block';
                showStatus('inventoryStatus', '', '');
            } else {
                showStatus('inventoryStatus', '‚ùå Error loading inventory', 'error');
            }
        }
        
        function hideAdjustInventoryForm() {
            document.getElementById('adjustInventoryForm').style.display = 'none';
            document.querySelector('#adjustInventoryForm form').reset();
            document.getElementById('adjustCurrentQty').value = '';
            document.getElementById('adjustNewQty').value = '';
        }
        
        function updateAdjustmentCalc() {
            const itemSelect = document.getElementById('adjustItem');
            const selectedOption = itemSelect.options[itemSelect.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                const item = cachedItems.find(i => i.Item_ID === selectedOption.value);
                const currentQty = item ? parseInt(item.Qty_On_Hand) : 0;
                const adjustment = parseInt(document.getElementById('adjustQuantity').value) || 0;
                const newQty = currentQty + adjustment;
                
                document.getElementById('adjustCurrentQty').value = currentQty;
                document.getElementById('adjustNewQty').value = newQty;
                
                // Color code the new quantity
                const newQtyInput = document.getElementById('adjustNewQty');
                if (newQty < 0) {
                    newQtyInput.style.background = '#ffebee';
                    newQtyInput.style.color = '#c62828';
                } else if (newQty < currentQty) {
                    newQtyInput.style.background = '#fff3e0';
                } else {
                    newQtyInput.style.background = '#e8f5e9';
                }
            }
        }
        
        async function submitInventoryAdjustment(e) {
            e.preventDefault();
            
            const itemId = document.getElementById('adjustItem').value;
            const adjustment = parseInt(document.getElementById('adjustQuantity').value);
            const currentQty = parseInt(document.getElementById('adjustCurrentQty').value);
            const newQty = parseInt(document.getElementById('adjustNewQty').value);
            const reason = document.getElementById('adjustReason').value;
            const notes = document.getElementById('adjustNotes').value;
            
            if (newQty < 0) {
                if (!confirm(`Warning: This will set inventory to ${newQty} (NEGATIVE).\n\nAre you sure?`)) {
                    return;
                }
            }
            
            // Confirm the adjustment
            const item = cachedItems.find(i => i.Item_ID === itemId);
            const confirmMsg = `Adjust ${item.Item_Description}?\n\nCurrent: ${currentQty}\nAdjustment: ${adjustment > 0 ? '+' : ''}${adjustment}\nNew Total: ${newQty}\n\nReason: ${reason}`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            const data = {
                itemId: itemId,
                adjustment: adjustment,
                reference: 'MANUAL',
                reason: reason + (notes ? ' - ' + notes : '')
            };
            
            const result = await apiCall('adjustInventory', data);
            
            if (result && result.status === 'success') {
                showStatus('inventoryStatus', `‚úÖ Inventory adjusted! ${item.Item_Description}: ${currentQty} ‚Üí ${newQty}`, 'success');
                hideAdjustInventoryForm();
                loadInventory();
            } else {
                showStatus('inventoryStatus', '‚ùå Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        // ==================== REPORTS ====================
        
        let currentReport = null;
        let reportData = {};
        let rawReportData = {}; // Store unfiltered data for re-filtering
        let reportFilters = {}; // Store current filter values
        
        // Helper: Build filter UI HTML
        function buildFilterUI(reportType, options = {}) {
            const filterId = `filter-panel-${reportType}`;
            let html = '<div style="background: #f0f0f0; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;">üîç Filters</h4>
                    <button class="btn-small" onclick="toggleFilters('${filterId}')" style="background: #666;">
                        <span id="${filterId}-toggle">‚ñº Hide</span>
                    </button>
                </div>`;
            html += `<div id="${filterId}" class="form-grid">`;
            
            // Date Range (common to most reports)
            if (options.dateRange) {
                const dateLabel = options.dateLabel || 'Date';
                html += `
                    <div class="form-group">
                        <label>${dateLabel} From</label>
                        <input type="date" id="filter_fromDate" value="${reportFilters.fromDate || ''}">
                    </div>
                    <div class="form-group">
                        <label>${dateLabel} To</label>
                        <input type="date" id="filter_toDate" value="${reportFilters.toDate || ''}">
                    </div>`;
            }
            
            // Customer dropdown
            if (options.customer) {
                html += `
                    <div class="form-group">
                        <label>Customer</label>
                        <select id="filter_customer">
                            <option value="">All Customers</option>
                            ${options.customerList.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>`;
            }
            
            // Supplier dropdown
            if (options.supplier) {
                html += `
                    <div class="form-group">
                        <label>Supplier</label>
                        <select id="filter_supplier">
                            <option value="">All Suppliers</option>
                            ${options.supplierList.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                        </select>
                    </div>`;
            }
            
            // Item dropdown
            if (options.item) {
                html += `
                    <div class="form-group">
                        <label>Product</label>
                        <select id="filter_item">
                            <option value="">All Products</option>
                            ${options.itemList.map(i => `<option value="${i.id}">${i.name}</option>`).join('')}
                        </select>
                    </div>`;
            }
            
            // Payment Status
            if (options.paymentStatus) {
                html += `
                    <div class="form-group">
                        <label>Payment Status</label>
                        <select id="filter_paymentStatus">
                            <option value="">All</option>
                            <option value="Paid">Paid</option>
                            <option value="Partial">Partial</option>
                            <option value="Unpaid">Unpaid</option>
                            <option value="Overdue">Overdue</option>
                        </select>
                    </div>`;
            }
            
            // Stock Status
            if (options.stockStatus) {
                html += `
                    <div class="form-group">
                        <label>Stock Status</label>
                        <select id="filter_stockStatus">
                            <option value="">All Items</option>
                            <option value="negative">üö® Negative Inventory</option>
                            <option value="out">üî¥ Out of Stock</option>
                            <option value="low">üü° Low Stock</option>
                            <option value="ok">üü¢ In Stock</option>
                        </select>
                    </div>`;
            }
            
            // Turnover Status
            if (options.turnoverStatus) {
                html += `
                    <div class="form-group">
                        <label>Movement</label>
                        <select id="filter_turnoverStatus">
                            <option value="">All</option>
                            <option value="Fast">Fast Movers</option>
                            <option value="Normal">Normal</option>
                            <option value="Slow">Slow Movers</option>
                        </select>
                    </div>`;
            }
            
            // Aging Filter (for AR/AP)
            if (options.aging) {
                html += `
                    <div class="form-group">
                        <label>Aging</label>
                        <select id="filter_aging">
                            <option value="">All</option>
                            <option value="Current">Current</option>
                            <option value="1-30">1-30 days</option>
                            <option value="31-60">31-60 days</option>
                            <option value="60+">60+ days</option>
                        </select>
                    </div>`;
            }
            
            // Minimum Amount
            if (options.minAmount) {
                html += `
                    <div class="form-group">
                        <label>Min Amount ($)</label>
                        <input type="number" id="filter_minAmount" step="0.01" placeholder="0.00">
                    </div>`;
            }
            
            html += `
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn" onclick="applyReportFilters('${reportType}')">üîç Apply Filters</button>
                    <button class="btn btn-secondary" onclick="clearReportFilters('${reportType}')">üßπ Clear Filters</button>
                </div>
            </div>`;
            html += '</div>';
            
            return html;
        }
        
        // Apply filters to current report
        async function applyReportFilters(reportType) {
            // Capture filter values
            reportFilters = {
                fromDate: document.getElementById('filter_fromDate')?.value || '',
                toDate: document.getElementById('filter_toDate')?.value || '',
                customer: document.getElementById('filter_customer')?.value || '',
                supplier: document.getElementById('filter_supplier')?.value || '',
                item: document.getElementById('filter_item')?.value || '',
                paymentStatus: document.getElementById('filter_paymentStatus')?.value || '',
                stockStatus: document.getElementById('filter_stockStatus')?.value || '',
                turnoverStatus: document.getElementById('filter_turnoverStatus')?.value || '',
                aging: document.getElementById('filter_aging')?.value || '',
                minAmount: parseFloat(document.getElementById('filter_minAmount')?.value) || 0
            };
            
            // Re-render report with filters
            await showReport(reportType);
        }
        
        // Clear all filters
        function clearReportFilters(reportType) {
            reportFilters = {};
            showReport(reportType);
        }
        
        // Toggle filter panel visibility
        function toggleFilters(panelId) {
            const panel = document.getElementById(panelId);
            const toggle = document.getElementById(`${panelId}-toggle`);
            
            if (panel.style.display === 'none') {
                panel.style.display = 'grid';
                toggle.textContent = '‚ñº Hide';
            } else {
                panel.style.display = 'none';
                toggle.textContent = '‚ñ∂ Show';
            }
        }
        
        // Universal table sorting function
        function sortTable(tableId, columnIndex) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determine sort direction
            const header = table.querySelectorAll('th')[columnIndex];
            const currentDir = header.dataset.sortDir || 'asc';
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';
            
            // Clear all header indicators
            table.querySelectorAll('th').forEach(th => {
                th.style.cursor = 'pointer';
                th.dataset.sortDir = '';
                th.innerHTML = th.innerHTML.replace(' ‚ñ≤', '').replace(' ‚ñº', '');
            });
            
            // Sort rows
            rows.sort((a, b) => {
                // Safety checks for undefined cells
                const aCell = a.cells[columnIndex];
                const bCell = b.cells[columnIndex];
                
                if (!aCell || !bCell) return 0;
                
                const aCellText = (aCell.textContent || '').trim();
                const bCellText = (bCell.textContent || '').trim();
                
                // Handle empty cells
                if (!aCellText && !bCellText) return 0;
                if (!aCellText) return 1;
                if (!bCellText) return -1;
                
                // Try numeric comparison first
                const aNum = parseFloat(aCellText.replace(/[$,]/g, ''));
                const bNum = parseFloat(bCellText.replace(/[$,]/g, ''));
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return newDir === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // Try date comparison
                const aDate = new Date(aCellText);
                const bDate = new Date(bCellText);
                if (!isNaN(aDate.getTime()) && !isNaN(bDate.getTime()) && aCellText.match(/\d/)) {
                    return newDir === 'asc' ? aDate - bDate : bDate - aDate;
                }
                
                // String comparison
                return newDir === 'asc' 
                    ? aCellText.localeCompare(bCellText)
                    : bCellText.localeCompare(aCellText);
            });
            
            // Update table
            rows.forEach(row => tbody.appendChild(row));
            
            // Update header
            header.dataset.sortDir = newDir;
            header.innerHTML += newDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
        }
        
        // Make table sortable
        function makeSortable(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                header.style.cursor = 'pointer';
                header.style.userSelect = 'none';
                header.onclick = () => sortTable(tableId, index);
                header.title = 'Click to sort';
            });
        }
        
        async function showReport(reportType) {
            currentReport = reportType;
            const container = document.getElementById('reportContainer');
            
            // Show loading
            container.innerHTML = '<div class="loading">Generating report...</div>';
            
            try {
                switch(reportType) {
                    case 'sales-by-customer':
                        await generateSalesByCustomer();
                        break;
                    case 'sales-order-detail':
                        await generateSalesOrderDetail();
                        break;
                    case 'sales-by-product':
                        await generateSalesByProduct();
                        break;
                    case 'purchase-order-detail':
                        await generatePurchaseOrderDetail();
                        break;
                    case 'purchase-by-supplier':
                        await generatePurchaseBySupplier();
                        break;
                    case 'inventory-turnover':
                        await generateInventoryTurnover();
                        break;
                    case 'gross-margin':
                        await generateGrossMargin();
                        break;
                    case 'accounts-receivable':
                        await generateAccountsReceivable();
                        break;
                    case 'accounts-payable':
                        await generateAccountsPayable();
                        break;
                    case 'simple-inventory':
                        await generateSimpleInventory();
                        break;
                }
            } catch (error) {
                container.innerHTML = `<div class="loading" style="color: red;">Error generating report: ${error.message}</div>`;
            }
        }
        
        // 1. SALES BY CUSTOMER REPORT
        async function generateSalesByCustomer() {
            const salesResult = await apiCall('getSalesOrders');
            const customersResult = await apiCall('getCustomers');
            const itemsResult = await apiCall('getItems');
            
            if (!salesResult?.data || !customersResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const customers = customersResult.data;
            const items = itemsResult.data;
            let sales = salesResult.data;
            
            // Fetch ALL sales order lines with their SO info
            const allDetails = [];
            for (const so of sales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const unitsPerPackage = parseFloat(item?.Units_Per_Package) || 1;
                        const packageCost = parseFloat(item?.Package_Cost) || 0;
                        const unitCost = packageCost / unitsPerPackage;
                        const quantity = parseInt(line.Quantity || 0);
                        const unitPrice = parseFloat(line.Unit_Price || 0);
                        const lineTotal = parseFloat(line.Line_Total || 0);
                        const lineCost = quantity * unitCost;
                        
                        allDetails.push({
                            soId: so.SO_ID,
                            soDate: so.Sale_Date || so.SO_Date,
                            customerId: so.Customer_ID,
                            customerName: getCustomerName(so.Customer_ID),
                            itemId: line.Item_ID,
                            itemDescription: item?.Item_Description || line.Item_ID,
                            quantity: quantity,
                            unitsPerPackage: unitsPerPackage,
                            unitPrice: unitPrice,
                            unitCost: unitCost,
                            lineTotal: lineTotal,
                            lineCost: lineCost,
                            lineProfit: lineTotal - lineCost,
                            paymentStatus: so.Payment_Status || 'Unknown'
                        });
                    });
                }
            }
            
            // Store raw data
            rawReportData['sales-by-customer'] = { sales, customers, items, allDetails };
            
            // APPLY FILTERS
            let filtered = allDetails;
            if (reportFilters.fromDate) {
                const fromDate = new Date(reportFilters.fromDate);
                filtered = filtered.filter(d => new Date(d.soDate) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = new Date(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                filtered = filtered.filter(d => new Date(d.soDate) <= toDate);
            }
            if (reportFilters.customer) {
                filtered = filtered.filter(d => d.customerId === reportFilters.customer);
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(d => d.lineTotal >= reportFilters.minAmount);
            }
            
            // GROUP BY CUSTOMER and calculate totals
            const customerSummary = {};
            filtered.forEach(detail => {
                if (!customerSummary[detail.customerId]) {
                    customerSummary[detail.customerId] = {
                        customerId: detail.customerId,
                        customerName: detail.customerName,
                        totalCases: 0,
                        totalUnits: 0,
                        totalRevenue: 0,
                        totalCost: 0,
                        totalProfit: 0
                    };
                }
                
                const summary = customerSummary[detail.customerId];
                // Calculate cases (divide units by units per package)
                const cases = detail.quantity / detail.unitsPerPackage;
                summary.totalCases += cases;
                summary.totalUnits += detail.quantity;
                summary.totalRevenue += detail.lineTotal;
                summary.totalCost += detail.lineCost;
                summary.totalProfit += detail.lineProfit;
            });
            
            // Convert to array and calculate margin %
            const summaryArray = Object.values(customerSummary).map(s => ({
                ...s,
                marginPercent: s.totalRevenue > 0 ? (s.totalProfit / s.totalRevenue) * 100 : 0
            }));
            
            // Sort by total revenue (highest first)
            summaryArray.sort((a, b) => b.totalRevenue - a.totalRevenue);
            
            // Calculate grand totals
            const grandTotalRevenue = summaryArray.reduce((sum, s) => sum + s.totalRevenue, 0);
            const grandTotalCost = summaryArray.reduce((sum, s) => sum + s.totalCost, 0);
            const grandTotalProfit = summaryArray.reduce((sum, s) => sum + s.totalProfit, 0);
            const grandTotalCases = summaryArray.reduce((sum, s) => sum + s.totalCases, 0);
            const grandTotalUnits = summaryArray.reduce((sum, s) => sum + s.totalUnits, 0);
            const grandMargin = grandTotalRevenue > 0 ? (grandTotalProfit / grandTotalRevenue) * 100 : 0;
            
            // Build customer list for filter
            const customerList = customers.map(c => ({ id: c.Customer_ID, name: c.Customer_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('sales-by-customer', {
                dateRange: true,
                dateLabel: 'Sale Date',
                customer: true,
                customerList: customerList,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>üìä Sales by Customer Summary</h3>
                    <p style="color: #666;">Total Customers: ${summaryArray.length} | Total Revenue: $${grandTotalRevenue.toFixed(2)} | Total Profit: $${grandTotalProfit.toFixed(2)} | Gross Margin: ${grandMargin.toFixed(1)}%</p>
                </div>`;
            
            if (summaryArray.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table" id="salesByCustomerTable">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Total Cases</th>
                            <th>Total Units</th>
                            <th>Total Revenue</th>
                            <th>Total Cost</th>
                            <th>Total Profit</th>
                            <th>Gross Margin %</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                summaryArray.forEach(summary => {
                    const marginColor = summary.marginPercent >= 30 ? '#2e7d32' : summary.marginPercent >= 20 ? '#f57c00' : '#c62828';
                    html += `<tr style="cursor: pointer;" onclick="openCustomer('${summary.customerId}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td><strong style="color: #667eea;">${summary.customerName}</strong></td>
                        <td>${summary.totalCases.toFixed(1)}</td>
                        <td>${Math.round(summary.totalUnits).toLocaleString()}</td>
                        <td><strong>$${summary.totalRevenue.toFixed(2)}</strong></td>
                        <td>$${summary.totalCost.toFixed(2)}</td>
                        <td style="color: ${summary.totalProfit >= 0 ? 'green' : 'red'};"><strong>$${summary.totalProfit.toFixed(2)}</strong></td>
                        <td style="color: ${marginColor}; font-weight: bold;">${summary.marginPercent.toFixed(1)}%</td>
                    </tr>`;
                });
                
                // Add totals row
                html += `<tr style="background: #f0f0f0; font-weight: bold; border-top: 3px solid #667eea;">
                    <td style="text-align: right; padding-right: 20px;">TOTALS:</td>
                    <td>${grandTotalCases.toFixed(1)}</td>
                    <td>${Math.round(grandTotalUnits).toLocaleString()}</td>
                    <td><strong>$${grandTotalRevenue.toFixed(2)}</strong></td>
                    <td>$${grandTotalCost.toFixed(2)}</td>
                    <td style="color: ${grandTotalProfit >= 0 ? 'green' : 'red'};"><strong>$${grandTotalProfit.toFixed(2)}</strong></td>
                    <td style="color: ${grandMargin >= 30 ? '#2e7d32' : grandMargin >= 20 ? '#f57c00' : '#c62828'}; font-weight: bold;">${grandMargin.toFixed(1)}%</td>
                </tr>`;
            
                html += '</tbody></table>';
            }
            
            reportData['sales-by-customer'] = summaryArray;
            document.getElementById('reportContainer').innerHTML = html;
            setTimeout(() => makeSortable('salesByCustomerTable'), 0);
        }
        
        // SALES ORDER DETAIL REPORT (NEW!)
        async function generateSalesOrderDetail() {
            const salesResult = await apiCall('getSalesOrders');
            const customersResult = await apiCall('getCustomers');
            const itemsResult = await apiCall('getItems');
            
            if (!salesResult?.data || !customersResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const customers = customersResult.data;
            const items = itemsResult.data;
            let sales = salesResult.data;
            
            // Fetch ALL sales order lines with their SO info
            const allDetails = [];
            for (const so of sales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        allDetails.push({
                            soId: so.SO_ID,
                            soDate: so.Sale_Date || so.SO_Date,
                            customerId: so.Customer_ID,
                            customerName: getCustomerName(so.Customer_ID),
                            itemId: line.Item_ID,
                            itemDescription: item?.Item_Description || line.Item_ID,
                            sku: item?.SKU || '',
                            quantity: parseInt(line.Quantity || 0),
                            unitPrice: parseFloat(line.Unit_Price || 0),
                            lineTotal: parseFloat(line.Line_Total || 0),
                            paymentStatus: so.Payment_Status || 'Unknown',
                            status: so.Status || 'Completed'
                        });
                    });
                }
            }
            
            // Store raw data
            rawReportData['sales-order-detail'] = { sales, customers, items, allDetails };
            
            // APPLY FILTERS
            let filtered = allDetails;
            if (reportFilters.fromDate) {
                const fromDate = new Date(reportFilters.fromDate);
                filtered = filtered.filter(d => new Date(d.soDate) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = new Date(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                filtered = filtered.filter(d => new Date(d.soDate) <= toDate);
            }
            if (reportFilters.customer) {
                filtered = filtered.filter(d => d.customerId === reportFilters.customer);
            }
            if (reportFilters.item) {
                filtered = filtered.filter(d => d.itemId === reportFilters.item);
            }
            if (reportFilters.paymentStatus) {
                filtered = filtered.filter(d => d.paymentStatus === reportFilters.paymentStatus);
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(d => d.lineTotal >= reportFilters.minAmount);
            }
            
            // Sort by date (newest first), then by SO ID
            filtered.sort((a, b) => {
                const dateCompare = new Date(b.soDate) - new Date(a.soDate);
                if (dateCompare !== 0) return dateCompare;
                return b.soId.localeCompare(a.soId);
            });
            
            // Calculate totals
            const totalSales = filtered.reduce((sum, d) => sum + d.lineTotal, 0);
            const totalOrders = new Set(filtered.map(d => d.soId)).size;
            
            // Build lists for filters
            const customerList = customers.map(c => ({ id: c.Customer_ID, name: c.Customer_Name }));
            const itemList = items.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            
            // Build HTML with filters
            let html = buildFilterUI('sales-order-detail', {
                dateRange: true,
                dateLabel: 'Sale Date',
                customer: true,
                customerList: customerList,
                item: true,
                itemList: itemList,
                paymentStatus: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>üìã Sales Order Detail Report</h3>
                    <p style="color: #666;">Total Orders: ${totalOrders} | Total Lines: ${filtered.length} | Total Sales: $${totalSales.toFixed(2)}</p>
                </div>`;
            
            if (filtered.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table" id="salesOrderDetailTable">
                    <thead>
                        <tr>
                            <th>SO #</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Item</th>
                            <th>SKU</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Payment</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                filtered.forEach(detail => {
                    html += `<tr style="cursor: pointer;" onclick="openSalesOrder('${detail.soId}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td><strong style="color: #667eea;">${detail.soId}</strong></td>
                        <td>${new Date(detail.soDate).toLocaleDateString()}</td>
                        <td style="color: #667eea;">${detail.customerName}</td>
                        <td style="color: #667eea;">${detail.itemDescription}</td>
                        <td>${detail.sku}</td>
                        <td>${detail.quantity}</td>
                        <td>$${detail.unitPrice.toFixed(2)}</td>
                        <td>$${detail.lineTotal.toFixed(2)}</td>
                        <td>${detail.status}</td>
                        <td><span style="color: ${detail.paymentStatus === 'Paid' ? 'green' : detail.paymentStatus === 'Partial' ? 'orange' : 'red'};">${detail.paymentStatus}</span></td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['sales-order-detail'] = filtered;
            document.getElementById('reportContainer').innerHTML = html;
            setTimeout(() => makeSortable('salesOrderDetailTable'), 0);
        }
        
        // 2. SALES BY PRODUCT REPORT
        async function generateSalesByProduct() {
            const itemsResult = await apiCall('getItems');
            const suppliersResult = await apiCall('getSuppliers');
            const salesResult = await apiCall('getSalesOrders');
            
            if (!itemsResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const suppliers = suppliersResult.data;
            let sales = salesResult?.data || [];
            
            // Fetch ALL sales order lines to get units sold
            const allLines = [];
            for (const so of sales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        line.SO_Date = so.Sale_Date || so.SO_Date;
                        allLines.push(line);
                    });
                }
            }
            
            // APPLY DATE FILTERS to sales lines
            let filteredLines = allLines;
            if (reportFilters.fromDate) {
                const fromDate = new Date(reportFilters.fromDate);
                filteredLines = filteredLines.filter(line => new Date(line.SO_Date) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = new Date(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                filteredLines = filteredLines.filter(line => new Date(line.SO_Date) <= toDate);
            }
            
            // Calculate units sold per item
            const unitsSoldByItem = {};
            filteredLines.forEach(line => {
                const itemId = line.Item_ID;
                unitsSoldByItem[itemId] = (unitsSoldByItem[itemId] || 0) + parseInt(line.Quantity || 0);
            });
            
            // Build product list with margins - INCLUDE ALL ITEMS
            const productData = items.map(item => {
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitCost = packageCost / unitsPerPackage;
                const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const margin = unitSellPrice - unitCost;
                const marginPercent = unitSellPrice > 0 ? (margin / unitSellPrice) * 100 : 0;
                const unitsSold = unitsSoldByItem[item.Item_ID] || 0;
                const totalProfit = unitsSold * margin;
                
                return {
                    id: item.Item_ID,
                    description: item.Item_Description || '',
                    sku: item.SKU || '',
                    supplierId: item.Supplier_ID || '',
                    unitCost: unitCost,
                    unitSellPrice: unitSellPrice,
                    margin: margin,
                    marginPercent: marginPercent,
                    unitsSold: unitsSold,
                    totalProfit: totalProfit
                };
            });
            
            // Store raw data
            rawReportData['sales-by-product'] = { items, suppliers, productData };
            
            // APPLY FILTERS
            let filtered = productData;
            
            if (reportFilters.item) {
                filtered = filtered.filter(p => p.id === reportFilters.item);
            }
            if (reportFilters.supplier) {
                filtered = filtered.filter(p => p.supplierId === reportFilters.supplier);
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(p => p.margin >= reportFilters.minAmount);
            }
            
            // Sort by margin % (highest first)
            const sorted = filtered.sort((a, b) => b.marginPercent - a.marginPercent);
            
            // Build filter lists
            const itemList = items.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('sales-by-product', {
                dateRange: false, // Remove date filter - this is about pricing, not sales history
                item: true,
                itemList: itemList,
                supplier: true,
                supplierList: supplierList,
                minAmount: true,
                amountLabel: 'Min Margin ($)'
            });
            
            // Calculate totals
            const avgMarginPercent = sorted.length > 0 
                ? sorted.reduce((sum, p) => sum + p.marginPercent, 0) / sorted.length 
                : 0;
            const totalPotentialProfit = sorted.reduce((sum, p) => sum + p.totalProfit, 0);
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>üì¶ Product Pricing & Margin Analysis</h3>
                    <p style="color: #666;">Total Products: ${sorted.length} | Average Margin: ${avgMarginPercent.toFixed(1)}% | Total Profit (from sales): $${totalPotentialProfit.toFixed(2)}</p>
                    
                </div>`;
            
            if (sorted.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table" id="salesByProductTable">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Cost</th>
                            <th>Sell</th>
                            <th>Margin</th>
                            <th>Margin %</th>
                            <th>Units Sold</th>
                            <th>Total Profit</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                sorted.forEach(product => {
                    const marginColor = product.marginPercent >= 30 ? '#2e7d32' : product.marginPercent >= 20 ? '#f57c00' : '#c62828';
                    html += `<tr style="cursor: pointer;" onclick="openItem('${product.id}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td><strong style="color: #667eea;">${product.description}</strong></td>
                        <td>${product.sku}</td>
                        <td>$${product.unitCost.toFixed(2)}</td>
                        <td>$${product.unitSellPrice.toFixed(2)}</td>
                        <td style="color: ${product.margin >= 0 ? 'green' : 'red'};">$${product.margin.toFixed(2)}</td>
                        <td style="color: ${marginColor}; font-weight: bold;">${product.marginPercent.toFixed(1)}%</td>
                        <td>${product.unitsSold.toLocaleString()}</td>
                        <td style="color: ${product.totalProfit >= 0 ? 'green' : 'red'};"><strong>$${product.totalProfit.toFixed(2)}</strong></td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['sales-by-product'] = sorted;
            document.getElementById('reportContainer').innerHTML = html;
            setTimeout(() => makeSortable('salesByProductTable'), 0);
        }
        
        // PURCHASE ORDER DETAIL REPORT (NEW!)
        async function generatePurchaseOrderDetail() {
            const purchasesResult = await apiCall('getPurchaseOrders');
            const suppliersResult = await apiCall('getSuppliers');
            const itemsResult = await apiCall('getItems');
            
            if (!purchasesResult?.data || !suppliersResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            const items = itemsResult.data;
            let purchases = purchasesResult.data;
            
            // Fetch ALL purchase order lines with their PO info
            const allDetails = [];
            for (const po of purchases) {
                const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        allDetails.push({
                            poId: po.PO_ID,
                            poDate: po.PO_Date,
                            supplierId: po.Supplier_ID,
                            supplierName: getSupplierName(po.Supplier_ID),
                            itemId: line.Item_ID,
                            itemDescription: item?.Item_Description || line.Item_ID,
                            sku: item?.SKU || '',
                            quantity: parseInt(line.Quantity || 0),
                            unitCost: parseFloat(line.Unit_Cost || 0),
                            lineTotal: parseFloat(line.Line_Total || 0),
                            paymentStatus: po.Payment_Status || 'Unknown',
                            status: po.Status || 'Received'
                        });
                    });
                }
            }
            
            // Store raw data
            rawReportData['purchase-order-detail'] = { purchases, suppliers, items, allDetails };
            
            // APPLY FILTERS
            let filtered = allDetails;
            if (reportFilters.fromDate) {
                const fromDate = new Date(reportFilters.fromDate);
                filtered = filtered.filter(d => new Date(d.poDate) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = new Date(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                filtered = filtered.filter(d => new Date(d.poDate) <= toDate);
            }
            if (reportFilters.supplier) {
                filtered = filtered.filter(d => d.supplierId === reportFilters.supplier);
            }
            if (reportFilters.item) {
                filtered = filtered.filter(d => d.itemId === reportFilters.item);
            }
            if (reportFilters.paymentStatus) {
                filtered = filtered.filter(d => d.paymentStatus === reportFilters.paymentStatus);
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(d => d.lineTotal >= reportFilters.minAmount);
            }
            
            // Sort by date (newest first), then by PO ID
            filtered.sort((a, b) => {
                const dateCompare = new Date(b.poDate) - new Date(a.poDate);
                if (dateCompare !== 0) return dateCompare;
                return b.poId.localeCompare(a.poId);
            });
            
            // Calculate totals
            const totalPurchases = filtered.reduce((sum, d) => sum + d.lineTotal, 0);
            const totalOrders = new Set(filtered.map(d => d.poId)).size;
            
            // Build lists for filters
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            const itemList = items.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            
            // Build HTML with filters
            let html = buildFilterUI('purchase-order-detail', {
                dateRange: true,
                dateLabel: 'Purchase Date',
                supplier: true,
                supplierList: supplierList,
                item: true,
                itemList: itemList,
                paymentStatus: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>üìã Purchase Order Detail Report</h3>
                    <p style="color: #666;">Total Orders: ${totalOrders} | Total Lines: ${filtered.length} | Total Purchases: $${totalPurchases.toFixed(2)}</p>
                    
                </div>`;
            
            if (filtered.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table" id="purchaseOrderDetailTable">
                    <thead>
                        <tr>
                            <th>PO #</th>
                            <th>Date</th>
                            <th>Supplier</th>
                            <th>Item</th>
                            <th>SKU</th>
                            <th>Qty</th>
                            <th>Cost</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Payment</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                filtered.forEach(detail => {
                    html += `<tr style="cursor: pointer;" onclick="openPurchaseOrder('${detail.poId}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td><strong style="color: #667eea;">${detail.poId}</strong></td>
                        <td>${new Date(detail.poDate).toLocaleDateString()}</td>
                        <td style="color: #667eea;">${detail.supplierName}</td>
                        <td style="color: #667eea;">${detail.itemDescription}</td>
                        <td>${detail.sku}</td>
                        <td>${detail.quantity}</td>
                        <td>$${detail.unitCost.toFixed(2)}</td>
                        <td>$${detail.lineTotal.toFixed(2)}</td>
                        <td>${detail.status}</td>
                        <td><span style="color: ${detail.paymentStatus === 'Paid' ? 'green' : detail.paymentStatus === 'Partial' ? 'orange' : 'red'};">${detail.paymentStatus}</span></td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['purchase-order-detail'] = filtered;
            document.getElementById('reportContainer').innerHTML = html;
            setTimeout(() => makeSortable('purchaseOrderDetailTable'), 0);
        }
        
        // 3. PURCHASE BY SUPPLIER REPORT
        async function generatePurchaseBySupplier() {
            const purchasesResult = await apiCall('getPurchaseOrders');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!purchasesResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            let purchases = purchasesResult.data;
            
            // Store raw data
            rawReportData['purchase-by-supplier'] = { purchases, suppliers };
            
            // APPLY FILTERS
            if (reportFilters.fromDate) {
                const fromDate = new Date(reportFilters.fromDate);
                purchases = purchases.filter(po => new Date(po.PO_Date) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = new Date(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                purchases = purchases.filter(po => new Date(po.PO_Date) <= toDate);
            }
            if (reportFilters.supplier) {
                purchases = purchases.filter(po => po.Supplier_ID === reportFilters.supplier);
            }
            if (reportFilters.minAmount) {
                purchases = purchases.filter(po => parseFloat(po.Total_Amount || po.Invoice_Total || 0) >= reportFilters.minAmount);
            }
            
            // Build supplier purchase summary
            const supplierPurchases = {};
            
            purchases.forEach(po => {
                const suppId = po.Supplier_ID;
                if (!supplierPurchases[suppId]) {
                    const supplier = suppliers.find(s => s.Supplier_ID === suppId);
                    supplierPurchases[suppId] = {
                        id: suppId,
                        name: supplier?.Supplier_Name || suppId,
                        totalSpent: 0,
                        orderCount: 0,
                        lastOrderDate: null
                    };
                }
                
                const total = parseFloat(po.Total_Amount || po.Invoice_Total || 0);
                supplierPurchases[suppId].totalSpent += total;
                supplierPurchases[suppId].orderCount++;
                
                const orderDate = new Date(po.PO_Date);
                if (!supplierPurchases[suppId].lastOrderDate || orderDate > supplierPurchases[suppId].lastOrderDate) {
                    supplierPurchases[suppId].lastOrderDate = orderDate;
                }
            });
            
            // Sort by total spent
            const sorted = Object.values(supplierPurchases).sort((a, b) => b.totalSpent - a.totalSpent);
            
            // Build supplier list for filter
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('purchase-by-supplier', {
                dateRange: true,
                dateLabel: 'Purchase Date',
                supplier: true,
                supplierList: supplierList,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>üè≠ Purchase by Supplier Report</h3>
                    <p style="color: #666;">Suppliers: ${sorted.length} | Total Spent: $${sorted.reduce((sum, s) => sum + s.totalSpent, 0).toFixed(2)}</p>
                    
                </div>`;
            
            if (sorted.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Supplier</th>
                            <th>Orders</th>
                            <th>Total Spent</th>
                            <th>Avg Order</th>
                            <th>Last Order</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                sorted.forEach(supp => {
                    const avgOrder = supp.totalSpent / supp.orderCount;
                    
                    html += `<tr>
                        <td><strong>${supp.name}</strong></td>
                        <td>${supp.orderCount}</td>
                        <td>$${supp.totalSpent.toFixed(2)}</td>
                        <td>$${avgOrder.toFixed(2)}</td>
                        <td>${supp.lastOrderDate ? supp.lastOrderDate.toLocaleDateString() : '-'}</td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['purchase-by-supplier'] = sorted;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 4. INVENTORY TURNOVER REPORT
        async function generateInventoryTurnover() {
            const inventoryResult = await apiCall('getInventoryReport');
            const salesResult = await apiCall('getSalesOrders');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!inventoryResult?.data || !salesResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const inventory = inventoryResult.data;
            const sales = salesResult.data;
            const suppliers = suppliersResult.data;
            
            // Fetch ALL sales order lines
            const allLines = [];
            for (const so of sales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    allLines.push(...linesResult.data);
                }
            }
            
            // Store raw data
            rawReportData['inventory-turnover'] = { inventory, sales, suppliers, allLines };
            
            // Calculate units sold per item
            const unitsSold = {};
            allLines.forEach(line => {
                const itemId = line.Item_ID;
                unitsSold[itemId] = (unitsSold[itemId] || 0) + parseInt(line.Quantity || 0);
            });
            
            // Build turnover report
            let turnoverData = inventory.map(item => {
                const sold = unitsSold[item.Item_ID] || 0;
                const onHand = parseInt(item.Qty_On_Hand) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                const avgInventory = onHand + (sold / 2);
                const turnover = avgInventory > 0 ? sold / avgInventory : 0;
                
                // Calculate cost from package cost
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPackage;
                const value = onHand * unitCost;
                
                return {
                    id: item.Item_ID,
                    description: item.Item_Description,
                    sku: item.SKU,
                    supplierId: item.Supplier_ID,
                    onHand: onHand,
                    onOrder: onOrder,
                    sold: sold,
                    turnover: turnover,
                    value: value,
                    status: turnover > 4 ? 'Fast' : turnover > 2 ? 'Normal' : 'Slow'
                };
            });
            
            // APPLY FILTERS
            if (reportFilters.supplier) {
                turnoverData = turnoverData.filter(item => item.supplierId === reportFilters.supplier);
            }
            if (reportFilters.turnoverStatus) {
                turnoverData = turnoverData.filter(item => item.status === reportFilters.turnoverStatus);
            }
            if (reportFilters.minAmount) {
                turnoverData = turnoverData.filter(item => item.value >= reportFilters.minAmount);
            }
            
            // Sort by turnover
            turnoverData.sort((a, b) => b.turnover - a.turnover);
            
            // Build supplier list for filter
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('inventory-turnover', {
                supplier: true,
                supplierList: supplierList,
                turnoverStatus: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>üîÑ Inventory Turnover Report</h3>
                    <p style="color: #666;">Total Items: ${turnoverData.length}</p>
                    
                </div>`;
            
            if (turnoverData.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>On Hand</th>
                            <th>On Order</th>
                            <th>Units Sold</th>
                            <th>Turnover Rate</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                turnoverData.forEach(item => {
                    const statusColor = item.status === 'Fast' ? 'green' : item.status === 'Normal' ? 'orange' : 'red';
                    const qtyOnOrder = parseFloat(item.onOrder) || 0;
                    
                    html += `<tr>
                        <td><strong>${item.description}</strong></td>
                        <td>${item.sku}</td>
                        <td>${item.onHand}</td>
                        <td><span style="background: ${qtyOnOrder > 0 ? '#ffc107' : '#e0e0e0'}; padding: 3px 8px; border-radius: 4px; font-weight: bold;">${qtyOnOrder}</span></td>
                        <td>${item.sold}</td>
                        <td>${item.turnover.toFixed(2)}</td>
                        <td style="color: ${statusColor}; font-weight: bold;">${item.status}</td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['inventory-turnover'] = turnoverData;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 5. GROSS MARGIN REPORT
        async function generateGrossMargin() {
            const itemsResult = await apiCall('getItems');
            const salesResult = await apiCall('getSalesOrders');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!itemsResult?.data || !salesResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const sales = salesResult.data;
            const suppliers = suppliersResult.data;
            
            // Store raw data
            rawReportData['gross-margin'] = { items, sales, suppliers };
            
            // Calculate margin per item
            let marginData = items.map(item => {
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const cost = packageCost / unitsPerPackage;
                const sell = parseFloat(item.Unit_Sell_Price) || 0;
                const margin = sell - cost;
                const marginPercent = sell > 0 ? (margin / sell) * 100 : 0;
                
                // Calculate units sold
                let unitsSold = 0;
                sales.forEach(so => {
                    // Parse lines if they're stored as JSON string
                    let lines = so.lines;
                    if (typeof lines === 'string') {
                        try {
                            lines = JSON.parse(lines);
                        } catch (e) {
                            lines = [];
                        }
                    }
                    
                    if (lines && Array.isArray(lines)) {
                        lines.forEach(line => {
                            if ((line.itemId || line.Item_ID) === item.Item_ID) {
                                unitsSold += parseInt(line.quantity || line.Quantity || 0);
                            }
                        });
                    }
                });
                
                const totalProfit = margin * unitsSold;
                
                return {
                    id: item.Item_ID,
                    description: item.Item_Description,
                    sku: item.SKU,
                    supplierId: item.Supplier_ID,
                    cost: cost,
                    sell: sell,
                    margin: margin,
                    marginPercent: marginPercent,
                    unitsSold: unitsSold,
                    totalProfit: totalProfit
                };
            });
            
            // APPLY FILTERS
            if (reportFilters.supplier) {
                marginData = marginData.filter(item => item.supplierId === reportFilters.supplier);
            }
            if (reportFilters.item) {
                marginData = marginData.filter(item => item.id === reportFilters.item);
            }
            if (reportFilters.minAmount) {
                marginData = marginData.filter(item => item.marginPercent >= reportFilters.minAmount);
            }
            // Add max margin filter (using minAmount field with special handling)
            const maxMarginFilter = document.getElementById('filter_maxMargin');
            if (maxMarginFilter && maxMarginFilter.value) {
                const maxMargin = parseFloat(maxMarginFilter.value);
                marginData = marginData.filter(item => item.marginPercent <= maxMargin);
            }
            
            // Sort by total profit
            marginData.sort((a, b) => b.totalProfit - a.totalProfit);
            
            // Build filter lists
            const itemList = items.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters (with custom min/max margin)
            let html = buildFilterUI('gross-margin', {
                supplier: true,
                supplierList: supplierList,
                item: true,
                itemList: itemList,
                minAmount: false // We'll add custom margin filters
            });
            
            // Add custom min/max margin filters
            const filterDiv = html.lastIndexOf('</div>');
            html = html.substring(0, filterDiv) + `
                <div class="form-group">
                    <label>Min Margin %</label>
                    <input type="number" id="filter_minMargin" step="0.1" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Max Margin %</label>
                    <input type="number" id="filter_maxMargin" step="0.1" placeholder="100">
                </div>
            ` + html.substring(filterDiv);
            
            const totalProfit = marginData.reduce((sum, item) => sum + item.totalProfit, 0);
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>üí∞ Gross Margin Report</h3>
                    <p style="color: #666;">Total Products: ${marginData.length} | Total Profit: $${totalProfit.toFixed(2)}</p>
                    
                </div>`;
            
            if (marginData.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Cost</th>
                            <th>Sell</th>
                            <th>Margin</th>
                            <th>Margin %</th>
                            <th>Units Sold</th>
                            <th>Total Profit</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                marginData.forEach(item => {
                    const marginColor = item.marginPercent > 40 ? 'green' : item.marginPercent > 20 ? 'orange' : 'red';
                    
                    html += `<tr>
                        <td><strong>${item.description}</strong></td>
                        <td>${item.sku}</td>
                        <td>$${item.cost.toFixed(2)}</td>
                        <td>$${item.sell.toFixed(2)}</td>
                        <td>$${item.margin.toFixed(2)}</td>
                        <td style="color: ${marginColor}; font-weight: bold;">${item.marginPercent.toFixed(1)}%</td>
                        <td>${item.unitsSold}</td>
                        <td style="font-weight: bold;">$${item.totalProfit.toFixed(2)}</td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['gross-margin'] = marginData;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 6. ACCOUNTS RECEIVABLE REPORT (Who owes you money)
        async function generateAccountsReceivable() {
            const salesResult = await apiCall('getSalesOrders');
            const customersResult = await apiCall('getCustomers');
            
            if (!salesResult?.data || !customersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const customers = customersResult.data;
            const sales = salesResult.data;
            
            // Store raw data
            rawReportData['accounts-receivable'] = { sales, customers };
            
            // Filter for unpaid/partial invoices
            let receivables = sales
                .filter(so => {
                    const status = so.Payment_Status || 'Unpaid';
                    return status !== 'Paid';
                })
                .map(so => {
                    const customer = customers.find(c => c.Customer_ID === so.Customer_ID);
                    const total = parseFloat(so.Total_Amount || so.Order_Total || 0);
                    const paid = parseFloat(so.Amount_Paid || 0);
                    const balance = total - paid;
                    const dueDate = so.Due_Date ? new Date(so.Due_Date) : null;
                    const today = new Date();
                    const daysOverdue = dueDate ? Math.floor((today - dueDate) / (1000 * 60 * 60 * 24)) : 0;
                    
                    let aging = 'Current';
                    if (daysOverdue > 60) aging = '60+ days';
                    else if (daysOverdue > 30) aging = '31-60 days';
                    else if (daysOverdue > 0) aging = '1-30 days';
                    
                    return {
                        customerId: so.Customer_ID,
                        customer: customer?.Customer_Name || so.Customer_ID,
                        invoiceId: so.SO_ID,
                        invoiceDate: new Date(so.Sale_Date || so.SO_Date).toLocaleDateString(),
                        dueDate: dueDate ? dueDate.toLocaleDateString() : '-',
                        total: total,
                        paid: paid,
                        balance: balance,
                        status: so.Payment_Status || 'Unpaid',
                        daysOverdue: daysOverdue,
                        aging: aging,
                        agingCategory: aging // For filtering
                    };
                });
            
            // APPLY FILTERS
            if (reportFilters.customer) {
                receivables = receivables.filter(r => r.customerId === reportFilters.customer);
            }
            if (reportFilters.minAmount) {
                receivables = receivables.filter(r => r.balance >= reportFilters.minAmount);
            }
            if (reportFilters.paymentStatus) {
                if (reportFilters.paymentStatus === 'Overdue') {
                    receivables = receivables.filter(r => r.daysOverdue > 0);
                } else {
                    receivables = receivables.filter(r => r.status === reportFilters.paymentStatus);
                }
            }
            if (reportFilters.aging) {
                const agingFilter = reportFilters.aging;
                if (agingFilter === '1-30') {
                    receivables = receivables.filter(r => r.aging === '1-30 days');
                } else if (agingFilter === '31-60') {
                    receivables = receivables.filter(r => r.aging === '31-60 days');
                } else if (agingFilter === '60+') {
                    receivables = receivables.filter(r => r.aging === '60+ days');
                } else if (agingFilter === 'Current') {
                    receivables = receivables.filter(r => r.aging === 'Current');
                }
            }
            
            // Sort by days overdue
            receivables.sort((a, b) => b.daysOverdue - a.daysOverdue);
            
            const totalOutstanding = receivables.reduce((sum, r) => sum + r.balance, 0);
            
            // Build customer list for filter
            const customerList = customers.map(c => ({ id: c.Customer_ID, name: c.Customer_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('accounts-receivable', {
                customer: true,
                customerList: customerList,
                paymentStatus: true,
                aging: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>üíµ Accounts Receivable Report</h3>
                    <p style="color: #666;">Outstanding Invoices: ${receivables.length} | Total AR: $${totalOutstanding.toFixed(2)}</p>
                    
                </div>`;
            
            if (receivables.length === 0) {
                html += '<p style="color: green; font-size: 18px; text-align: center; padding: 40px;">‚úÖ All invoices paid! No outstanding receivables.</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Invoice #</th>
                            <th>Invoice Date</th>
                            <th>Due Date</th>
                            <th>Total</th>
                            <th>Paid</th>
                            <th>Balance Due</th>
                            <th>Days Overdue</th>
                            <th>Aging</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                receivables.forEach(r => {
                    const statusColor = r.status === 'Overdue' || r.daysOverdue > 0 ? 'red' : 'orange';
                    const agingColor = r.daysOverdue > 60 ? 'red' : r.daysOverdue > 30 ? 'orange' : r.daysOverdue > 0 ? '#f39c12' : 'green';
                    
                    html += `<tr>
                        <td><a href="javascript:void(0)" onclick="openCustomer('${r.customerId}')" style="color: #667eea; text-decoration: none;"><strong>${r.customer}</strong></a></td>
                        <td><a href="javascript:void(0)" onclick="openSalesOrder('${r.invoiceId}')" style="color: #667eea; text-decoration: none;"><strong>${r.invoiceId}</strong></a></td>
                        <td>${r.invoiceDate}</td>
                        <td>${r.dueDate}</td>
                        <td>$${r.total.toFixed(2)}</td>
                        <td>$${r.paid.toFixed(2)}</td>
                        <td style="font-weight: bold; color: ${statusColor};">$${r.balance.toFixed(2)}</td>
                        <td style="color: ${r.daysOverdue > 0 ? 'red' : 'green'};">${r.daysOverdue > 0 ? r.daysOverdue : '-'}</td>
                        <td style="color: ${agingColor}; font-weight: bold;">${r.aging}</td>
                        <td style="color: ${statusColor};">${r.status}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            }
            
            reportData['accounts-receivable'] = receivables;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 7. ACCOUNTS PAYABLE REPORT (Who you owe money to)
        async function generateAccountsPayable() {
            const purchasesResult = await apiCall('getPurchaseOrders');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!purchasesResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            const purchases = purchasesResult.data;
            
            // Store raw data
            rawReportData['accounts-payable'] = { purchases, suppliers };
            
            // Filter for unpaid/partial invoices
            let payables = purchases
                .filter(po => {
                    const status = po.Payment_Status || 'Unpaid';
                    return status !== 'Paid';
                })
                .map(po => {
                    const supplier = suppliers.find(s => s.Supplier_ID === po.Supplier_ID);
                    const total = parseFloat(po.Total_Amount || po.Invoice_Total || 0);
                    const paid = parseFloat(po.Amount_Paid || 0);
                    const balance = total - paid;
                    const dueDate = po.Due_Date ? new Date(po.Due_Date) : null;
                    const today = new Date();
                    const daysOverdue = dueDate ? Math.floor((today - dueDate) / (1000 * 60 * 60 * 24)) : 0;
                    
                    let aging = 'Current';
                    if (daysOverdue > 60) aging = '60+ days';
                    else if (daysOverdue > 30) aging = '31-60 days';
                    else if (daysOverdue > 0) aging = '1-30 days';
                    
                    return {
                        supplierId: po.Supplier_ID,
                        supplier: supplier?.Supplier_Name || po.Supplier_ID,
                        invoiceId: po.Invoice_Number || po.PO_ID,
                        poId: po.PO_ID,
                        invoiceDate: new Date(po.PO_Date).toLocaleDateString(),
                        dueDate: dueDate ? dueDate.toLocaleDateString() : '-',
                        total: total,
                        paid: paid,
                        balance: balance,
                        status: po.Payment_Status || 'Unpaid',
                        daysOverdue: daysOverdue,
                        aging: aging,
                        agingCategory: aging // For filtering
                    };
                });
            
            // APPLY FILTERS
            if (reportFilters.supplier) {
                payables = payables.filter(p => p.supplierId === reportFilters.supplier);
            }
            if (reportFilters.minAmount) {
                payables = payables.filter(p => p.balance >= reportFilters.minAmount);
            }
            if (reportFilters.paymentStatus) {
                if (reportFilters.paymentStatus === 'Overdue') {
                    payables = payables.filter(p => p.daysOverdue > 0);
                } else {
                    payables = payables.filter(p => p.status === reportFilters.paymentStatus);
                }
            }
            if (reportFilters.aging) {
                const agingFilter = reportFilters.aging;
                if (agingFilter === '1-30') {
                    payables = payables.filter(p => p.aging === '1-30 days');
                } else if (agingFilter === '31-60') {
                    payables = payables.filter(p => p.aging === '31-60 days');
                } else if (agingFilter === '60+') {
                    payables = payables.filter(p => p.aging === '60+ days');
                } else if (agingFilter === 'Current') {
                    payables = payables.filter(p => p.aging === 'Current');
                }
            }
            
            // Sort by days overdue
            payables.sort((a, b) => b.daysOverdue - a.daysOverdue);
            
            const totalOutstanding = payables.reduce((sum, p) => sum + p.balance, 0);
            
            // Build supplier list for filter
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('accounts-payable', {
                supplier: true,
                supplierList: supplierList,
                paymentStatus: true,
                aging: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>üí∏ Accounts Payable Report</h3>
                    <p style="color: #666;">Outstanding Bills: ${payables.length} | Total AP: $${totalOutstanding.toFixed(2)}</p>
                    
                </div>`;
            
            if (payables.length === 0) {
                html += '<p style="color: green; font-size: 18px; text-align: center; padding: 40px;">‚úÖ All bills paid! No outstanding payables.</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Supplier</th>
                            <th>Invoice #</th>
                            <th>PO #</th>
                            <th>Invoice Date</th>
                            <th>Due Date</th>
                            <th>Total</th>
                            <th>Paid</th>
                            <th>Balance Due</th>
                            <th>Days Overdue</th>
                            <th>Aging</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                payables.forEach(p => {
                    const statusColor = p.daysOverdue > 0 ? 'red' : 'orange';
                    const agingColor = p.daysOverdue > 60 ? 'red' : p.daysOverdue > 30 ? 'orange' : p.daysOverdue > 0 ? '#f39c12' : 'green';
                    
                    html += `<tr>
                        <td><a href="javascript:void(0)" onclick="openSupplier('${p.supplierId}')" style="color: #667eea; text-decoration: none;"><strong>${p.supplier}</strong></a></td>
                        <td>${p.invoiceId}</td>
                        <td><a href="javascript:void(0)" onclick="openPurchaseOrder('${p.poId}')" style="color: #667eea; text-decoration: none;"><strong>${p.poId}</strong></a></td>
                        <td>${p.invoiceDate}</td>
                        <td>${p.dueDate}</td>
                        <td>$${p.total.toFixed(2)}</td>
                        <td>$${p.paid.toFixed(2)}</td>
                        <td style="font-weight: bold; color: ${statusColor};">$${p.balance.toFixed(2)}</td>
                        <td style="color: ${p.daysOverdue > 0 ? 'red' : 'green'};">${p.daysOverdue > 0 ? p.daysOverdue : '-'}</td>
                        <td style="color: ${agingColor}; font-weight: bold;">${p.aging}</td>
                        <td style="color: ${statusColor};">${p.status}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            }
            
            reportData['accounts-payable'] = payables;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 8. SIMPLE INVENTORY REPORT
        async function generateSimpleInventory() {
            const inventoryResult = await apiCall('getInventoryReport');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!inventoryResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            let inventory = inventoryResult.data;
            
            // Store raw data
            rawReportData['simple-inventory'] = { inventory, suppliers };
            
            // APPLY FILTERS
            if (reportFilters.supplier) {
                inventory = inventory.filter(item => item.Supplier_ID === reportFilters.supplier);
            }
            if (reportFilters.item) {
                inventory = inventory.filter(item => item.Item_ID === reportFilters.item);
            }
            if (reportFilters.stockStatus) {
                if (reportFilters.stockStatus === 'negative') {
                    inventory = inventory.filter(item => parseFloat(item.Qty_On_Hand || 0) < 0);
                } else if (reportFilters.stockStatus === 'out') {
                    inventory = inventory.filter(item => parseFloat(item.Qty_On_Hand || 0) === 0);
                } else if (reportFilters.stockStatus === 'low') {
                    inventory = inventory.filter(item => {
                        const qty = parseFloat(item.Qty_On_Hand || 0);
                        const reorder = parseFloat(item.Reorder_Point || 0);
                        return qty > 0 && qty <= reorder;
                    });
                } else if (reportFilters.stockStatus === 'ok') {
                    inventory = inventory.filter(item => {
                        const qty = parseFloat(item.Qty_On_Hand || 0);
                        const reorder = parseFloat(item.Reorder_Point || 0);
                        return qty > reorder;
                    });
                }
            }
            if (reportFilters.minAmount) {
                inventory = inventory.filter(item => parseFloat(item.Total_Value || 0) >= reportFilters.minAmount);
            }
            
            // Sort alphabetically
            inventory.sort((a, b) => a.Item_Description.localeCompare(b.Item_Description));
            
            const totalValue = inventory.reduce((sum, item) => sum + parseFloat(item.Total_Value || 0), 0);
            const totalItems = inventory.length;
            const lowStockCount = inventory.filter(item => item.Low_Stock).length;
            
            // Build filter lists
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            const itemList = inventoryResult.data.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            
            // Build HTML with filters
            let html = buildFilterUI('simple-inventory', {
                supplier: true,
                supplierList: supplierList,
                item: true,
                itemList: itemList,
                stockStatus: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>üìã Inventory List Report</h3>
                    <p style="color: #666;">
                        Total Items: ${totalItems} | 
                        Total Value: $${totalValue.toFixed(2)} | 
                        Low Stock Items: ${lowStockCount}
                    </p>
                    
                </div>`;
            
            if (inventory.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No items match your filters</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Description</th>
                            <th>Supplier</th>
                            <th>UOM</th>
                            <th>Qty On Hand</th>
                            <th>On Order</th>
                            <th>Reorder Point</th>
                            <th>Cost</th>
                            <th>Sell Price</th>
                            <th>Total Value</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                inventory.forEach(item => {
                    const lowStock = item.Low_Stock;
                    const qtyOnOrder = parseFloat(item.Qty_On_Order) || 0;
                    const rowStyle = lowStock ? 'background: #fff3cd;' : '';
                    const status = lowStock ? '‚ö†Ô∏è Low Stock' : '‚úÖ OK';
                    const statusColor = lowStock ? '#f39c12' : 'green';
                    
                    html += `<tr style="${rowStyle}">
                        <td><strong>${item.SKU || '-'}</strong></td>
                        <td>${item.Item_Description}</td>
                        <td>${getSupplierName(item.Supplier_ID)}</td>
                        <td>${item.UOM}</td>
                        <td style="font-weight: bold;">${item.Qty_On_Hand}</td>
                        <td><span style="background: ${qtyOnOrder > 0 ? '#ffc107' : '#e0e0e0'}; padding: 3px 8px; border-radius: 4px; font-weight: bold;">${qtyOnOrder}</span></td>
                        <td>${item.Reorder_Point}</td>
                        <td>$${(parseFloat(item.Package_Cost) / parseFloat(item.Units_Per_Package || 1)).toFixed(2)}</td>
                        <td>$${parseFloat(item.Unit_Sell_Price).toFixed(2)}</td>
                        <td>$${parseFloat(item.Total_Value).toFixed(2)}</td>
                        <td style="color: ${statusColor}; font-weight: bold;">${status}</td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['simple-inventory'] = inventory;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // ==================== HOT LINK FUNCTIONS ====================
        
        async function openSalesOrder(soId) {
            // Remember current tab to return to later
            const currentTab = document.querySelector('.card.active');
            if (currentTab && currentTab.id === 'reports') {
                returnToTab = 'reports';
            } else {
                returnToTab = null;
            }
            
            // Load the sales order and open edit modal
            const result = await apiCall('getSalesOrders');
            const so = result.data.find(s => s.SO_ID === soId);
            if (so) {
                // Switch to Sales tab and show the order
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="sales"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('sales').classList.add('active');
                
                // Open the order details modal
                await showSalesOrderDetails(so);
                document.getElementById('orderModal').style.display = 'block';
            } else {
                alert('Sales order not found: ' + soId);
            }
        }
        
        async function openPurchaseOrder(poId) {
            // Remember current tab to return to later
            const currentTab = document.querySelector('.card.active');
            if (currentTab && currentTab.id === 'reports') {
                returnToTab = 'reports';
            } else {
                returnToTab = null;
            }
            
            // Load the purchase order and open edit modal
            const result = await apiCall('getPurchaseOrders');
            const po = result.data.find(p => p.PO_ID === poId);
            if (po) {
                // Switch to Purchases tab and show the order
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="purchases"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('purchases').classList.add('active');
                
                // Open the order details modal
                await showPurchaseOrderDetails(po);
                document.getElementById('orderModal').style.display = 'block';
            } else {
                alert('Purchase order not found: ' + poId);
            }
        }
        
        async function openCustomer(customerId) {
            // Remember current tab to return to later
            const currentTab = document.querySelector('.card.active');
            if (currentTab && currentTab.id === 'reports') {
                returnToTab = 'reports';
            } else {
                returnToTab = null;
            }
            
            // Load customer and open edit modal
            const result = await apiCall('getCustomers');
            const customer = result.data.find(c => c.Customer_ID === customerId);
            if (customer) {
                // Switch to Customers tab
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="customers"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('customers').classList.add('active');
                
                // Show edit form
                showEditCustomerForm(customer);
            } else {
                alert('Customer not found: ' + customerId);
            }
        }
        
        async function openSupplier(supplierId) {
            // Remember current tab to return to later
            const currentTab = document.querySelector('.card.active');
            if (currentTab && currentTab.id === 'reports') {
                returnToTab = 'reports';
            } else {
                returnToTab = null;
            }
            
            // Load supplier and open edit modal
            const result = await apiCall('getSuppliers');
            const supplier = result.data.find(s => s.Supplier_ID === supplierId);
            if (supplier) {
                // Switch to Suppliers tab
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="suppliers"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('suppliers').classList.add('active');
                
                // Show edit form
                showEditSupplierForm(supplier);
            } else {
                alert('Supplier not found: ' + supplierId);
            }
        }
        
        async function openItem(itemId) {
            // Load items if not cached
            if (cachedItems.length === 0) {
                const result = await apiCall('getItems');
                if (result && result.status === 'success') {
                    cachedItems = result.data;
                }
            }
            
            // Switch to Items tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('.tab[onclick*="items"]').classList.add('active');
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            document.getElementById('items').classList.add('active');
            
            // Call editItemById which handles the edit form
            editItemById(itemId);
        }
        
        
        // ==================== CREATE PO (PRINT ONLY) FUNCTIONS ====================
        
        function filterItemsBySupplier() {
            const supplierId = document.getElementById('createPOSupplier').value;
            const itemSelects = document.querySelectorAll('.createpo-item');
            
            itemSelects.forEach(select => {
                // Clear existing options
                select.innerHTML = '<option value="">Select item...</option>';
                
                if (supplierId) {
                    // Filter items by supplier
                    const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
                    supplierItems.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.Item_ID;
                        option.textContent = `${item.SKU || item.Item_ID} - ${item.Item_Description}`;
                        option.dataset.cost = item.Package_Cost || 0;
                        option.dataset.units = item.Units_Per_Package || 1;
                        select.appendChild(option);
                    });
                }
            });
            
            calculateCreatePOTotal();
        }
        
        function addCreatePOLineItem() {
            const container = document.getElementById('createPOLineItems');
            const supplierId = document.getElementById('createPOSupplier').value;
            
            if (!supplierId) {
                alert('Please select a supplier first');
                return;
            }
            
            const newRow = document.createElement('div');
            newRow.className = 'line-item-row';
            newRow.style.cssText = 'display: grid; grid-template-columns: 2fr 0.6fr 0.6fr 0.8fr 0.8fr 0.8fr 60px; gap: 4px; margin-bottom: 6px; align-items: center;';
            newRow.innerHTML = `
                <select class="createpo-item" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" onchange="updateCreatePOItemCost(this)">
                    <option value="">Select item...</option>
                </select>
                <input type="number" class="createpo-qty" placeholder="0" min="1" oninput="calculateCreatePOTotal()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 13px;">
                <div class="createpo-units" style="text-align: center; font-size: 13px; color: #666; padding: 4px;">-</div>
                <div class="createpo-totalunits" style="text-align: center; font-size: 15px; font-weight: bold; color: #1565C0; padding: 4px;">-</div>
                <div class="createpo-cost" style="text-align: center; font-size: 13px; font-weight: bold; color: #28a745; background: #e8f5e9; padding: 8px; border-radius: 4px;">-</div>
                <div class="createpo-linetotal" style="text-align: right; font-size: 13px; font-weight: bold; color: #1565C0; background: #E3F2FD; padding: 8px; border-radius: 4px;">$0.00</div>
                <button type="button" class="btn-danger" onclick="removeLineItem(this); calculateCreatePOTotal();" style="width: 100%; padding: 8px; font-size: 14px;">üóëÔ∏è</button>
            `;
            
            container.appendChild(newRow);
            
            // Populate the new select with filtered items
            const itemSelect = newRow.querySelector('.createpo-item');
            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
            supplierItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.Item_ID;
                option.textContent = `${item.SKU || item.Item_ID} - ${item.Item_Description}`;
                option.dataset.cost = item.Package_Cost || 0;
                option.dataset.units = item.Units_Per_Package || 1;
                itemSelect.appendChild(option);
            });
        }
        
        function updateCreatePOItemCost(selectElement) {
            const row = selectElement.closest('.line-item-row');
            const costDiv = row.querySelector('.createpo-cost');
            const unitsDiv = row.querySelector('.createpo-units');
            const qtyInput = row.querySelector('.createpo-qty');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.cost) {
                const cost = parseFloat(selectedOption.dataset.cost);
                const units = parseFloat(selectedOption.dataset.units) || 1;
                
                costDiv.textContent = '$' + cost.toFixed(2);
                unitsDiv.textContent = units;
                
                // Calculate total units if qty is entered
                const qty = parseFloat(qtyInput.value) || 0;
                const totalUnitsDiv = row.querySelector('.createpo-totalunits');
                totalUnitsDiv.textContent = qty > 0 ? (qty * units) : '-';
            } else {
                costDiv.textContent = '-';
                unitsDiv.textContent = '-';
                row.querySelector('.createpo-totalunits').textContent = '-';
            }
            
            calculateCreatePOTotal();
        }
        
        function calculateCreatePOTotal() {
            let totalCost = 0;
            let totalCases = 0;
            let totalUnits = 0;
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            
            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                const costDiv = row.querySelector('.createpo-cost');
                const unitsDiv = row.querySelector('.createpo-units');
                const totalUnitsDiv = row.querySelector('.createpo-totalunits');
                const lineTotalDiv = row.querySelector('.createpo-linetotal');
                
                // Get cost from text (strip $ and parse)
                const costText = costDiv.textContent.replace('$', '');
                const cost = costText === '-' ? 0 : parseFloat(costText);
                
                // Get units per case
                const unitsText = unitsDiv.textContent;
                const unitsPerCase = unitsText === '-' ? 0 : parseFloat(unitsText);
                
                // Update total units for this line
                if (unitsPerCase > 0 && qty > 0) {
                    const lineUnits = qty * unitsPerCase;
                    totalUnitsDiv.textContent = lineUnits;
                    totalUnits += lineUnits;
                } else {
                    totalUnitsDiv.textContent = '-';
                }
                
                // Update line total
                const lineTotal = qty * cost;
                if (lineTotal > 0) {
                    lineTotalDiv.textContent = '$' + lineTotal.toFixed(2);
                } else {
                    lineTotalDiv.textContent = '$0.00';
                }
                
                totalCost += lineTotal;
                totalCases += qty;
            });
            
            // Update all totals
            document.getElementById('createPOTotalCases').textContent = totalCases;
            document.getElementById('createPOTotalUnits').textContent = totalUnits;
            document.getElementById('createPOTotal').textContent = '$' + totalCost.toFixed(2);
            return totalCost;
        }
        
        // ==================== OUTBOUND PO FUNCTIONS ====================
        
        // Void a PO (when supplier prices changed)
        async function voidPurchaseOrder(poId) {
            if (!confirm(`‚õî VOID Purchase Order ${poId}?\n\nThis will mark the PO as invalid. Use this when:\n‚Ä¢ Supplier prices have changed\n‚Ä¢ Order was entered incorrectly\n‚Ä¢ Order is no longer needed\n\nThe PO will remain in your records but won't affect inventory.`)) {
                return;
            }
            
            const reason = prompt('Optional: Enter reason for voiding (e.g., "Prices increased 10%"):', 'Supplier prices changed');
            
            try {
                const result = await apiCall('updatePurchaseOrder', {
                    poId: poId,
                    status: 'Void',
                    notes: `VOIDED: ${reason || 'No reason provided'} - ${new Date().toLocaleDateString()}`
                });
                
                if (result && result.status === 'success') {
                    showStatus('purchasesStatus', `‚õî PO ${poId} has been voided. You can copy it to create a new PO with updated prices.`, 'success');
                    closeModal();
                    loadPurchases();
                } else {
                    alert('Error voiding PO: ' + (result?.message || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        // Duplicate a PO (useful when original was voided due to price changes)
        async function duplicatePO(poId) {
            try {
                // Load the original PO
                const result = await apiCall('getPurchaseOrders');
                if (!result || result.status !== 'success') {
                    alert('Error loading purchase order');
                    return;
                }
                
                const originalPO = result.data.find(p => p.PO_ID === poId);
                if (!originalPO) {
                    alert('Purchase order not found');
                    return;
                }
                
                // Get original line items
                const linesResult = await apiCall('getPurchaseOrderLines', { poId: poId });
                const originalLines = linesResult?.data || [];
                
                if (originalLines.length === 0) {
                    alert('No line items found in original PO');
                    return;
                }
                
                // Confirm with user
                const itemCount = originalLines.length;
                if (!confirm(`Create a NEW Purchase Order with ${itemCount} item(s) from ${poId}?\n\n‚ö†Ô∏è You'll need to update prices in the new PO if they've changed.`)) {
                    return;
                }
                
                // Switch to Create PO tab
                switchTab('createpo');
                
                // Pre-select the supplier
                const supplierSelect = document.getElementById('poSupplier');
                if (supplierSelect) {
                    supplierSelect.value = originalPO.Supplier_ID;
                    await loadSupplierItems(); // Load items for this supplier
                }
                
                // Wait a moment for items to load
                setTimeout(async () => {
                    // Add each line item to the new PO
                    for (const line of originalLines) {
                        // Find the item in the dropdown and select it
                        const itemSelect = document.getElementById('poItemSelect');
                        if (itemSelect) {
                            itemSelect.value = line.Item_ID;
                            
                            // Set quantity
                            const qtyInput = document.getElementById('poItemQty');
                            if (qtyInput) {
                                qtyInput.value = line.Quantity || 1;
                            }
                            
                            // Add to PO
                            addItemToPO();
                        }
                    }
                    
                    showStatus('poStatus', `‚úÖ Copied ${itemCount} items from ${poId}. Review prices and quantities, then save!`, 'success');
                    
                    // Scroll to the line items
                    const poTable = document.getElementById('poLineItemsTable');
                    if (poTable) {
                        poTable.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 500);
                
            } catch (e) {
                alert('Error duplicating PO: ' + e.message);
            }
        }
        
        async function receiveOutboundPO(poId) {
            // Load the OUTBOUND PO
            const result = await apiCall('getPurchaseOrders');
            if (!result || result.status !== 'success') {
                alert('Error loading purchase order');
                return;
            }
            
            const po = result.data.find(p => p.PO_ID === poId);
            if (!po) {
                alert('Purchase order not found');
                return;
            }
            
            if (po.Status !== 'Ordered') {
                alert('This PO has already been received');
                return;
            }
            
            // Load line items
            const linesResult = await apiCall('getPurchaseOrderLines', { poId: poId });
            if (!linesResult || linesResult.status !== 'success') {
                alert('Error loading PO line items');
                return;
            }
            
            const lines = linesResult.data || [];
            
            // Show receive modal
            showReceiveModal(po, lines);
        }
        
        function showReceiveModal(po, lines) {
            // Store supplier ID for adding items
            window.currentReceivePO = po;
            window.currentReceiveLines = lines;
            window.receiveLineCounter = lines.length;
            
            let html = `
                <div style="max-height: 70vh; overflow-y: auto;">
                    <h2>üì¶ Receive OUTBOUND PO</h2>
                    <p><strong>PO:</strong> ${po.PO_ID} | <strong>Supplier:</strong> ${getSupplierName(po.Supplier_ID)}</p>
                    <p><strong>Order Date:</strong> ${new Date(po.PO_Date).toLocaleDateString()}</p>
                    
                    <h3>Items Ordered</h3>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 0;"><strong>üìã Instructions:</strong></p>
                        <ul style="margin: 10px 0 0 20px;">
                            <li><strong>Uncheck</strong> items you did NOT receive (or click üóëÔ∏è to remove)</li>
                            <li><strong>Adjust quantities</strong> if you received less/more than ordered</li>
                            <li><strong>Add items</strong> if extra items arrived (click "+ Add Item")</li>
                            <li>Click "‚úÖ Commit to Inventory" to complete receipt</li>
                        </ul>
                    </div>
                    
                    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                    <table class="data-table" id="receiveItemsTable" style="table-layout: fixed; min-width: 600px; width: 100%;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th style="width: 40px; text-align: center;">‚úì</th>
                                <th style="width: 35%;">Item</th>
                                <th style="width: 60px; text-align: center;">Ord</th>
                                <th style="width: 80px; text-align: center;">Recv</th>
                                <th style="width: 80px; text-align: right;">Cost</th>
                                <th style="width: 90px; text-align: right;">Total</th>
                                <th style="width: 40px; text-align: center;">üóëÔ∏è</th>
                            </tr>
                        </thead>
                        <tbody id="receiveItemsBody">
            `;
            
            lines.forEach((line, index) => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                const itemName = item ? item.Item_Description : line.Item_ID;
                const unitCost = parseFloat(line.Unit_Cost) || 0;
                const qtyOrdered = parseFloat(line.Quantity) || 0;
                
                html += `
                    <tr id="receiveLine${index}" data-is-original="true">
                        <td style="text-align: center; padding: 8px 4px;">
                            <input type="checkbox" id="receiveCheck${index}" checked onchange="updateReceiveLine(${index})" style="width: 20px; height: 20px;">
                        </td>
                        <td style="padding: 8px; font-size: 13px; word-wrap: break-word;"><strong>${itemName}</strong></td>
                        <td style="text-align: center; padding: 8px 4px;">${qtyOrdered}</td>
                        <td style="padding: 8px 4px;">
                            <input type="number" 
                                   id="receiveQty${index}" 
                                   value="${qtyOrdered}" 
                                   min="0" 
                                   step="1"
                                   data-item-id="${line.Item_ID}"
                                   data-ordered="${qtyOrdered}"
                                   data-cost="${unitCost}"
                                   style="width: 100%; padding: 8px; font-size: 14px; text-align: center; box-sizing: border-box;"
                                   oninput="updateReceiveLine(${index})">
                        </td>
                        <td style="text-align: right; padding: 8px 4px; font-size: 13px;">$${unitCost.toFixed(2)}</td>
                        <td style="text-align: right; padding: 8px 4px; font-weight: bold;" id="receiveLineTotal${index}">$${(qtyOrdered * unitCost).toFixed(2)}</td>
                        <td style="text-align: center; padding: 8px 4px;">
                            <button type="button" class="btn-danger" onclick="removeReceiveLine(${index})" style="padding: 6px 10px; font-size: 14px;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td colspan="5" style="text-align: right; padding: 12px;">TOTAL:</td>
                                <td style="text-align: right; padding: 12px;" id="receiveGrandTotal">$0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                    </div>
                    
                    <button type="button" class="btn btn-secondary" onclick="addReceiveLine()" style="margin-top: 15px; width: 100%;">
                        ‚ûï Add Item
                    </button>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Invoice Number (from supplier)</label>
                        <input type="text" id="receiveInvoiceNumber" placeholder="Enter actual invoice #" style="width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box;">
                    </div>
                    
                    <div class="form-group">
                        <label>Received Date</label>
                        <input type="date" id="receiveDate" value="${new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box;">
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="receiveNotes" rows="2" placeholder="Any discrepancies, damage, or special notes..." style="width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box;"></textarea>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalEditBtn').style.display = 'none';
            document.getElementById('modalPrintBtn').style.display = 'none';
            document.getElementById('modalSaveBtn').style.display = 'inline-block';
            document.getElementById('modalSaveBtn').textContent = '‚úÖ Commit to Inventory';
            document.getElementById('modalSaveBtn').onclick = () => commitReceive(po.PO_ID);
            document.getElementById('orderModal').style.display = 'block';
            
            // Calculate initial total
            setTimeout(() => {
                for (let i = 0; i < lines.length; i++) {
                    updateReceiveLine(i);
                }
            }, 100);
        }
        
        function removeReceiveLine(index) {
            const row = document.getElementById(`receiveLine${index}`);
            if (row) {
                row.remove();
                recalculateReceiveTotal();
            }
        }
        
        function addReceiveLine() {
            const tbody = document.getElementById('receiveItemsBody');
            const index = window.receiveLineCounter++;
            const supplierId = window.currentReceivePO.Supplier_ID;
            
            // Get items for this supplier
            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
            
            const row = document.createElement('tr');
            row.id = `receiveLine${index}`;
            row.dataset.isOriginal = 'false';
            row.innerHTML = `
                <td style="text-align: center; padding: 8px 4px;">
                    <input type="checkbox" id="receiveCheck${index}" checked onchange="updateReceiveLine(${index})" style="width: 20px; height: 20px;">
                </td>
                <td style="padding: 8px;">
                    <select id="receiveItem${index}" onchange="updateReceiveItemCost(${index})" style="width: 100%; padding: 8px; font-size: 14px; box-sizing: border-box;">
                        <option value="">Select item...</option>
                        ${supplierItems.map(item => `<option value="${item.Item_ID}" data-cost="${item.Package_Cost}">${item.Item_Description}</option>`).join('')}
                    </select>
                </td>
                <td style="text-align: center; padding: 8px 4px; color: #999;">N/A</td>
                <td style="padding: 8px 4px;">
                    <input type="number" 
                           id="receiveQty${index}" 
                           value="1" 
                           min="0" 
                           step="1"
                           data-item-id=""
                           data-ordered="0"
                           data-cost="0"
                           style="width: 100%; padding: 8px; font-size: 14px; text-align: center; box-sizing: border-box;"
                           oninput="updateReceiveLine(${index})">
                </td>
                <td style="text-align: right; padding: 8px 4px; font-size: 13px;" id="receiveCost${index}">$0.00</td>
                <td style="text-align: right; padding: 8px 4px; font-weight: bold;" id="receiveLineTotal${index}">$0.00</td>
                <td style="text-align: center; padding: 8px 4px;">
                    <button type="button" class="btn-danger" onclick="removeReceiveLine(${index})" style="padding: 6px 10px; font-size: 14px;">üóëÔ∏è</button>
                </td>
            `;
            tbody.appendChild(row);
        }
        
        function updateReceiveItemCost(index) {
            const select = document.getElementById(`receiveItem${index}`);
            const qtyInput = document.getElementById(`receiveQty${index}`);
            const costTd = document.getElementById(`receiveCost${index}`);
            
            const selectedOption = select.options[select.selectedIndex];
            const cost = parseFloat(selectedOption.dataset.cost) || 0;
            
            qtyInput.dataset.itemId = select.value;
            qtyInput.dataset.cost = cost;
            costTd.textContent = '$' + cost.toFixed(2);
            
            updateReceiveLine(index);
        }
        
        function recalculateReceiveTotal() {
            let grandTotal = 0;
            document.querySelectorAll('[id^="receiveLineTotal"]').forEach(td => {
                const amount = parseFloat(td.textContent.replace('$', '')) || 0;
                grandTotal += amount;
            });
            const grandTotalEl = document.getElementById('receiveGrandTotal');
            if (grandTotalEl) {
                grandTotalEl.textContent = '$' + grandTotal.toFixed(2);
            }
        }
        
        function updateReceiveLine(index) {
            const checkbox = document.getElementById(`receiveCheck${index}`);
            const qtyInput = document.getElementById(`receiveQty${index}`);
            const lineTotal = document.getElementById(`receiveLineTotal${index}`);
            
            if (!checkbox || !qtyInput || !lineTotal) return;
            
            if (!checkbox.checked) {
                qtyInput.value = 0;
                qtyInput.disabled = true;
            } else {
                qtyInput.disabled = false;
            }
            
            const qty = parseFloat(qtyInput.value) || 0;
            const cost = parseFloat(qtyInput.dataset.cost) || 0;
            const total = qty * cost;
            
            lineTotal.textContent = '$' + total.toFixed(2);
            
            // Recalculate grand total
            recalculateReceiveTotal();
        }
        
        let isCommittingReceive = false; // Prevent double-click
        
        async function commitReceive(poId) {
            // Prevent double-click
            if (isCommittingReceive) {
                console.log('Already committing receive, ignoring duplicate click');
                return;
            }
            
            const invoiceNumber = document.getElementById('receiveInvoiceNumber').value;
            const receiveDate = document.getElementById('receiveDate').value;
            const notes = document.getElementById('receiveNotes').value;
            
            if (!invoiceNumber) {
                if (!confirm('No invoice number entered. Continue anyway?')) {
                    return;
                }
            }
            
            // Collect all receive lines (including added ones)
            const receivedLines = [];
            const rows = document.querySelectorAll('#receiveItemsBody tr');
            
            rows.forEach(row => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                const qtyInput = row.querySelector('input[type="number"]');
                
                if (checkbox && checkbox.checked && qtyInput) {
                    const qty = parseFloat(qtyInput.value) || 0;
                    const itemId = qtyInput.dataset.itemId;
                    const qtyOrdered = parseFloat(qtyInput.dataset.ordered) || 0;
                    const cost = parseFloat(qtyInput.dataset.cost) || 0;
                    
                    if (qty > 0 && itemId) {
                        receivedLines.push({
                            itemId: itemId,
                            qtyOrdered: qtyOrdered,
                            qtyReceived: qty,
                            unitCost: cost
                        });
                    }
                }
            });
            
            if (receivedLines.length === 0) {
                alert('Please select at least one item to receive');
                return;
            }
            
            // LOCK - Prevent double submit
            isCommittingReceive = true;
            
            // Disable the commit button
            const commitBtn = document.getElementById('modalSaveBtn');
            if (commitBtn) {
                commitBtn.disabled = true;
                commitBtn.textContent = '‚è≥ Processing...';
            }
            
            try {
                // Call API to convert OUTBOUND to INBOUND
                const data = {
                    poId: poId,
                    invoiceNumber: invoiceNumber,
                    receiveDate: receiveDate,
                    notes: notes,
                    lines: receivedLines
                };
                
                const result = await apiCall('receiveOutboundPO', data);
                
                if (result && result.status === 'success') {
                    alert('‚úÖ Items received successfully! Inventory has been updated.');
                    document.getElementById('orderModal').style.display = 'none';
                    
                    // Reload purchases and items
                    await loadPurchases();
                    await loadItems();
                } else {
                    alert('‚ùå Error receiving items: ' + (result?.message || 'Unknown error'));
                }
            } finally {
                // UNLOCK
                isCommittingReceive = false;
                
                // Re-enable button
                if (commitBtn) {
                    commitBtn.disabled = false;
                    commitBtn.textContent = '‚úÖ Commit to Inventory';
                }
            }
        }
        
        let isSavingOutboundPO = false; // Prevent double-click
        
        async function saveOutboundPO() {
            // Prevent double-click
            if (isSavingOutboundPO) {
                console.log('Already saving PO, ignoring duplicate click');
                return;
            }
            
            const supplierId = document.getElementById('createPOSupplier').value;
            const poDate = document.getElementById('createPODate').value;
            const notes = document.getElementById('createPONotes')?.value;
            
            if (!supplierId || !poDate) {
                alert('Please select supplier and date');
                return;
            }
            
            // Get line items
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            const lineItems = [];
            
            rows.forEach(row => {
                const itemId = row.querySelector('.createpo-item').value;
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                const costDiv = row.querySelector('.createpo-cost');
                
                // Parse cost from text
                const costText = costDiv.textContent.replace('$', '');
                const cost = costText === '-' ? 0 : parseFloat(costText);
                
                if (itemId && qty > 0) {
                    lineItems.push({
                        itemId: itemId,
                        quantity: qty,
                        unitCost: cost
                    });
                }
            });
            
            if (lineItems.length === 0) {
                alert('Please add at least one line item');
                return;
            }
            
            // LOCK - Prevent double submit
            isSavingOutboundPO = true;
            
            // Disable the button visually
            const saveBtn = document.querySelector('button[onclick="saveOutboundPO()"]');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = '‚è≥ Saving...';
            }
            
            try {
                // Calculate total
                const total = lineItems.reduce((sum, item) => sum + (item.quantity * item.unitCost), 0);
            
            // AUTO-GENERATE PO NUMBER
            // Format: PO-MMDDYY-XXX (e.g., PO-120725-001)
            const dateObj = poDate ? new Date(poDate) : new Date();
            
            // Format date as MMDDYY
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const year = String(dateObj.getFullYear()).slice(-2); // Last 2 digits
            const dateStr = `${month}${day}${year}`;
            
            // Get all existing POs to find the next number for this date
            const existingPOs = await apiCall('getPurchaseOrders');
            let nextNumber = 1;
            
            if (existingPOs && existingPOs.data && existingPOs.data.length > 0) {
                // Find highest PO number for this date
                const prefix = `PO-${dateStr}-`;
                const todayPOs = existingPOs.data
                    .filter(po => po.Invoice_Number && po.Invoice_Number.startsWith(prefix))
                    .map(po => {
                        const parts = po.Invoice_Number.split('-');
                        return parseInt(parts[2]) || 0;
                    });
                
                if (todayPOs.length > 0) {
                    nextNumber = Math.max(...todayPOs) + 1;
                }
            }
            
            // Generate PO number: PO-120725-001
            const poNumber = `PO-${dateStr}-${String(nextNumber).padStart(3, '0')}`;
            
            // Create OUTBOUND PO
            const data = {
                supplierId: supplierId,
                invoiceNumber: poNumber,
                purchaseDate: poDate,
                dueDate: null,
                paymentTerms: 'Net 30',
                status: 'Ordered', // OUTBOUND status
                totalAmount: total,
                amountPaid: 0,
                notes: notes || '',
                lines: lineItems,
                poType: 'OUTBOUND' // New field to distinguish
            };
            
            const result = await apiCall('createPurchaseOrder', data);
            
            if (result && result.status === 'success') {
                alert(`‚úÖ OUTBOUND PO created successfully!\n\nPO Number: ${poNumber}\n\nItems marked as "On Order".`);
                clearCreatePOForm();
                
                // Refresh items to update Qty_On_Order
                await loadItems();
                
                // Ask if they want to print
                if (confirm('Would you like to print this PO?')) {
                    // Need to reload the PO we just created to print it
                    // For now, just tell them to go to Purchases tab
                    alert('Go to Purchases tab to view and print your OUTBOUND PO');
                }
            } else {
                alert('‚ùå Error creating OUTBOUND PO: ' + (result?.message || 'Unknown error'));
            }
            } finally {
                // UNLOCK - Always reset even if error
                isSavingOutboundPO = false;
                
                // Re-enable button
                const saveBtn = document.querySelector('button[onclick="saveOutboundPO()"]');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'üíæ Save as OUTBOUND PO';
                }
            }
        }
        
        function generatePrintablePO() {
            const supplierId = document.getElementById('createPOSupplier').value;
            const poDate = document.getElementById('createPODate').value;
            
            if (!supplierId || !poDate) {
                alert('Please select supplier and date');
                return;
            }
            
            // Get line items
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            const lineItems = [];
            
            rows.forEach(row => {
                const itemId = row.querySelector('.createpo-item').value;
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                const costDiv = row.querySelector('.createpo-cost');
                const unitsDiv = row.querySelector('.createpo-units');
                const totalUnitsDiv = row.querySelector('.createpo-totalunits');
                
                // Parse cost from text
                const costText = costDiv.textContent.replace('$', '');
                const cost = costText === '-' ? 0 : parseFloat(costText);
                
                // Parse units from text
                const unitsText = unitsDiv.textContent;
                const unitsPerCase = unitsText === '-' ? 0 : parseFloat(unitsText);
                
                // Parse total units from text
                const totalUnitsText = totalUnitsDiv.textContent;
                const totalUnits = totalUnitsText === '-' ? 0 : parseFloat(totalUnitsText);
                
                if (itemId && qty > 0) {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    if (item) {
                        lineItems.push({
                            sku: item.SKU || item.Item_ID,
                            description: item.Item_Description,
                            qty: qty,
                            unitsPerCase: unitsPerCase,
                            totalUnits: totalUnits,
                            cost: cost,
                            total: qty * cost
                        });
                    }
                }
            });
            
            if (lineItems.length === 0) {
                alert('Please add at least one line item');
                return;
            }
            
            // Get supplier info
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            if (!supplier) {
                alert('Supplier not found');
                return;
            }
            
            // Get invoice settings - USE THE SAME METHOD AS SALES INVOICES
            const settings = getInvoiceSettings();
            const companyName = settings.companyName;
            const companyContactName = settings.contactName;
            const companyPhone = settings.phone;
            const companyEmail = settings.email;
            const companyAddress1 = settings.address1;
            const companyAddress2 = settings.address2;
            const companyCityStateZip = settings.cityStateZip;
            
            const total = lineItems.reduce((sum, item) => sum + item.total, 0);
            
            // Generate printable HTML
            let html = `
                <style>
                    @media print {
                        body * { visibility: hidden; }
                        #printablePO, #printablePO * { visibility: visible; }
                        #printablePO { position: absolute; left: 0; top: 0; width: 100%; }
                        button { display: none !important; }
                    }
                    .po-header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #667eea; padding-bottom: 20px; }
                    .po-info { display: flex; justify-content: space-between; margin-bottom: 30px; }
                    .po-box { flex: 1; }
                    .po-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    .po-table th { background: #667eea; color: white; padding: 12px; text-align: left; }
                    .po-table td { border: 1px solid #ddd; padding: 10px; }
                    .po-total { text-align: right; font-size: 20px; font-weight: bold; margin-top: 20px; }
                </style>
                
                <div class="po-header">
                    <h1 style="color: #667eea; margin: 0;">PURCHASE ORDER</h1>
                    <p style="font-size: 16pt; margin: 5px 0;">${companyName}</p>
                    <p style="margin: 5px 0;">Date: ${new Date(poDate).toLocaleDateString()}</p>
                </div>
                
                <div class="po-info">
                    <div class="po-box">
                        <h3>From:</h3>
                        <p><strong>${companyName}</strong></p>
                        ${companyContactName ? `<p>${companyContactName}</p>` : ''}
                        <p>${companyAddress1}</p>
                        ${companyAddress2 ? `<p>${companyAddress2}</p>` : ''}
                        <p>${companyCityStateZip}</p>
                        <p>Phone: ${companyPhone}</p>
                        <p>Email: ${companyEmail}</p>
                    </div>
                    <div class="po-box">
                        <h3>To:</h3>
                        <p><strong>${supplier.Supplier_Name}</strong></p>
                        ${supplier.Address ? `<p>${supplier.Address}</p>` : ''}
                        ${supplier.City || supplier.State || supplier.ZIP ? `<p>${supplier.City || ''}${supplier.City && supplier.State ? ', ' : ''}${supplier.State || ''} ${supplier.ZIP || ''}</p>` : ''}
                        ${supplier.Phone ? `<p>Phone: ${supplier.Phone}</p>` : ''}
                        ${supplier.Email ? `<p>Email: ${supplier.Email}</p>` : ''}
                    </div>
                </div>
                
                <table class="po-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Description</th>
                            <th style="text-align: center;">Cases</th>
                            <th style="text-align: center;">Units/Case</th>
                            <th style="text-align: center;">Total Units</th>
                            <th style="text-align: right;">Cost/Case</th>
                            <th style="text-align: right;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            lineItems.forEach(item => {
                html += `
                    <tr>
                        <td>${item.sku}</td>
                        <td>${item.description}</td>
                        <td style="text-align: center;">${item.qty}</td>
                        <td style="text-align: center;">${item.unitsPerCase}</td>
                        <td style="text-align: center;"><strong>${item.totalUnits}</strong></td>
                        <td style="text-align: right;">$${item.cost.toFixed(2)}</td>
                        <td style="text-align: right;">$${item.total.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <div class="po-total">
                    <p>TOTAL: $${total.toFixed(2)}</p>
                </div>
                
                <div style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <p style="color: #666; font-size: 14px;">
                        Please confirm receipt of this purchase order and provide expected delivery date.
                    </p>
                </div>
            `;
            
            // Display printable PO
            document.getElementById('printablePO').innerHTML = html;
            document.getElementById('printablePOContainer').style.display = 'block';
            document.getElementById('createPOForm').style.display = 'none';
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
        
        function closePrintablePO() {
            document.getElementById('printablePOContainer').style.display = 'none';
            document.getElementById('createPOForm').style.display = 'block';
        }
        
        function downloadPOAsPDF() {
            // Get PO details
            const supplierId = document.getElementById('createPOSupplier').value;
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            const poDate = document.getElementById('createPODate').value;
            
            if (!supplier) {
                alert('Supplier not found');
                return;
            }
            
            // Create a clean filename
            const fileName = `PO_${supplier.Supplier_Name.replace(/[^a-z0-9]/gi, '_')}_${poDate}.pdf`;
            
            // For now, trigger print dialog with instruction
            alert('PDF Download:\n\n1. Click OK\n2. In the print dialog, select "Save as PDF"\n3. Click Save\n\nNote: Full automated PDF generation requires a backend service.');
            window.print();
        }
        
        function emailPO() {
            // Get supplier email
            const supplierId = document.getElementById('createPOSupplier').value;
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            const poDate = document.getElementById('createPODate').value;
            
            if (!supplier) {
                alert('Supplier not found');
                return;
            }
            
            const supplierEmail = supplier.Email || '';
            
            if (!supplierEmail) {
                alert('No email address found for ' + supplier.Supplier_Name + '. Please add an email address to the supplier record first.');
                return;
            }
            
            // Get company info - USE THE SAME METHOD AS SALES INVOICES
            const settings = getInvoiceSettings();
            const companyName = settings.companyName;
            
            // Get line items for email body
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            let itemsList = '';
            rows.forEach(row => {
                const itemId = row.querySelector('.createpo-item').value;
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                if (itemId && qty > 0) {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    if (item) {
                        itemsList += `‚Ä¢ ${item.Item_Description} - ${qty} cases\n`;
                    }
                }
            });
            
            const totalCases = document.getElementById('createPOTotalCases').textContent;
            const totalCost = document.getElementById('createPOTotal').textContent;
            
            // Create email subject and body
            const subject = `Purchase Order from ${companyName} - ${poDate}`;
            const body = `Dear ${supplier.Supplier_Name},

Please find our purchase order for ${poDate}:

${itemsList}
---
Total Cases: ${totalCases}
Total: ${totalCost}

Please confirm receipt and expected delivery date.

Best regards,
${companyName}

---
NOTE: Please print the attached PO document for full details.`;
            
            // Create mailto link
            const mailtoLink = `mailto:${supplierEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Inform user to attach the PO
            alert('Email Instructions:\n\n1. Your email client will open with the supplier\'s email pre-filled\n2. IMPORTANT: Print or save this PO as PDF first (use Print button)\n3. Attach the PDF to the email before sending\n\nClick OK to open your email client.');
            
            // Open email client
            window.location.href = mailtoLink;
        }
        
        function clearCreatePOForm() {
            document.getElementById('createPOSupplier').value = '';
            document.getElementById('createPODate').value = new Date().toISOString().split('T')[0];
            
            // Clear all line items except the first one
            const container = document.getElementById('createPOLineItems');
            const rows = container.querySelectorAll('.line-item-row');
            rows.forEach((row, index) => {
                if (index === 0) {
                    row.querySelector('.createpo-item').value = '';
                    row.querySelector('.createpo-qty').value = '';
                    row.querySelector('.createpo-units').textContent = '-';
                    row.querySelector('.createpo-totalunits').textContent = '-';
                    row.querySelector('.createpo-cost').textContent = '-';
                    row.querySelector('.createpo-linetotal').textContent = '$0.00';
                } else {
                    row.remove();
                }
            });
            
            calculateCreatePOTotal();
        }
    </script>
    
    <!-- Order View/Edit Modal -->
    <div id="orderModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto;">
        <div style="background: white; margin: 50px auto; max-width: 900px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h2 id="modalTitle" style="margin: 0;">Order Details</h2>
                <button onclick="closeOrderModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <div id="modalContent" style="padding: 30px; max-height: 70vh; overflow-y: auto;">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div id="modalFooter" style="padding: 20px 30px; border-top: 1px solid #ddd; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeOrderModal()">Close</button>
                <button id="modalPrintBtn" class="btn" onclick="printInvoice()" style="display: none; background: #28a745;">üñ®Ô∏è Print Invoice</button>
                <button id="modalEditBtn" class="btn" onclick="enableEditMode()" style="display: none;">‚úèÔ∏è Edit Order</button>
                <button id="modalSaveBtn" class="btn" onclick="saveOrderChanges()" style="display: none;">üíæ Save Changes</button>
            </div>
        </div>
    </div>
</body>
</html>
