<!DOCTYPE html>
<html lang="en">
<head>
    <!-- âš¡ CACHE BUSTER: Version 2024-12-09-18:10 - Gradient background only, solid buttons -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Nowak Distributing - Inventory Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary, #667eea);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            margin: 0;
            /* Minimal pull-to-refresh prevention */
            overscroll-behavior-y: contain;
        }
        
        html {
            /* Allow normal scrolling */
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-left: 4px solid rgba(255, 255, 255, 0.4);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.3);
            border-left-color: rgba(255, 255, 255, 0.6);
        }

        .tab.active {
            background: white;
            color: #667eea;
            font-weight: 600;
            border-left: 4px solid #c0c0c0;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
            /* Contain content in landscape mode */
            overflow-x: auto;
            max-width: 100%;
            border-left: 5px solid #c0c0c0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        .card.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
        }
        
        /* Section cards within main cards - consistent grey shadow edge */
        .section-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #c0c0c0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }
        
        /* All accent colors now use consistent grey */
        .section-card.accent-blue,
        .section-card.accent-green,
        .section-card.accent-orange,
        .section-card.accent-purple,
        .section-card.accent-red,
        .section-card.accent-teal,
        .section-card.accent-pink,
        .section-card.accent-indigo,
        .section-card.accent-cyan,
        .section-card.accent-amber,
        .section-card.accent-theme,
        .section-card.accent-secondary { 
            border-left-color: #c0c0c0; 
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Table wrapper for horizontal scroll on mobile landscape */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 20px 0;
        }

        .btn {
            background: var(--primary, #667eea);
            color: white;
            border: none;
            border-left: 4px solid rgba(255, 255, 255, 0.4);
            padding: 12px 28px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            border-left-color: rgba(255, 255, 255, 0.6);
        }

        .btn-success {
            background: var(--primary, #667eea);
        }

        .btn-secondary {
            background: var(--secondary, #764ba2) !important;
            color: white !important;
            border-left: 4px solid rgba(255, 255, 255, 0.4) !important;
            opacity: 0.85;
        }
        
        .btn-secondary:hover {
            opacity: 1;
        }
        
        .btn-small {
            background: var(--primary, #667eea);
            color: white;
            border: none;
            border-left: 3px solid rgba(255, 255, 255, 0.4);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            margin-right: 5px;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .btn-small:hover {
            filter: brightness(0.9);
            transform: translateY(-1px);
            border-left-color: rgba(255, 255, 255, 0.6);
        }
        
        .btn-danger {
            background: transparent;
            color: #dc3545;
            border: 1px solid #dc3545;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .btn-danger:hover {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete-icon {
            background: transparent;
            color: #999;
            border: none;
            padding: 4px 8px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .btn-delete-icon:hover {
            background: #ffebee;
            color: #dc3545;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        /* Report Grid Layout */
        .report-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .report-category {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-left: 5px solid #c0c0c0;
        }
        
        .report-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 12px;
        }
        
        .report-category-header:hover {
            opacity: 0.8;
        }
        
        .report-category h4 {
            margin: 0;
            color: #555;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .report-toggle {
            color: #888;
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .report-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .report-buttons.collapsed {
            display: none;
        }
        
        .report-category.collapsed .report-category-header {
            margin-bottom: 0;
        }
        
        .report-btn {
            width: 100%;
            text-align: left;
            padding: 12px 15px !important;
            font-size: 14px !important;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-radius: 8px !important;
            border-left: 4px solid rgba(255,255,255,0.4) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .report-btn:hover {
            transform: translateX(3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .report-btn-green {
            background: #28a745 !important;
        }
        
        .report-btn-red {
            background: #dc3545 !important;
        }
        
        /* Mobile: Stack categories vertically */
        @media (max-width: 600px) {
            .report-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Landscape phone: 2x2 grid */
        @media (min-width: 601px) and (max-width: 900px) {
            .report-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Desktop: 4 columns */
        @media (min-width: 901px) {
            .report-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background: #f8f9ff;
            font-weight: 600;
            color: #667eea;
        }

        .data-table tr:hover {
            background: #f8f9ff;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .line-items-container {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .line-item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 50px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        
        /* Make line item selects and inputs MUCH larger and more visible */
        .line-item-row select,
        .line-item-row input[type="number"],
        .line-items-container select,
        .line-items-container input[type="number"],
        #createPOLineItems select,
        #createPOLineItems input[type="number"],
        #poLineItems select,
        #poLineItems input[type="number"],
        #soLineItems select,
        #soLineItems input[type="number"],
        .edit-line-item select,
        .edit-line-item input[type="number"] {
            padding: 14px 12px !important;
            font-size: 16px !important;
            min-height: 52px;
            border: 2px solid #667eea !important;
            border-radius: 8px !important;
            background: white !important;
        }
        
        /* Item dropdown - make extra wide and prominent */
        .line-item-row select,
        .line-items-container select,
        #createPOLineItems select,
        #poLineItems select,
        #soLineItems select,
        .edit-line-item select {
            font-size: 15px !important;
            font-weight: 500 !important;
            color: #333 !important;
            cursor: pointer;
        }
        
        /* Cases/Qty input - make VERY prominent */
        .line-item-row input[type="number"],
        .line-items-container input[type="number"],
        #createPOLineItems input[type="number"],
        #poLineItems input[type="number"],
        #soLineItems input[type="number"],
        .edit-line-item input[type="number"] {
            font-size: 18px !important;
            font-weight: bold !important;
            text-align: center !important;
            background: #fffde7 !important;
            border: 2px solid #f9a825 !important;
            min-width: 80px;
        }
        
        .line-item-row select:focus,
        .line-items-container select:focus,
        #createPOLineItems select:focus,
        #poLineItems select:focus,
        #soLineItems select:focus,
        .edit-line-item select:focus,
        .line-item-row input:focus,
        .line-items-container input:focus,
        #createPOLineItems input:focus,
        #poLineItems input:focus,
        #soLineItems input:focus,
        .edit-line-item input:focus {
            border-color: var(--primary, #667eea) !important;
            outline: none;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.25);
        }
        
        /* Item dropdown should be wider */
        .createpo-item,
        .so-item,
        .po-item,
        .edit-item {
            min-width: 250px;
        }
        
        /* Quantity/Cases input highlight on focus */
        .createpo-qty:focus,
        .so-qty:focus,
        .po-qty:focus,
        .edit-qty:focus {
            background: #fff59d !important;
            border-color: #f57f17 !important;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .config-box {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        /* ==================== MOBILE RESPONSIVE STYLES ==================== */
        
        /* Tablets and smaller (768px and below) */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .tabs {
                gap: 5px;
            }
            
            .tab {
                padding: 10px 16px;
                font-size: 14px;
                flex: 1 1 auto;
            }
            
            .card {
                padding: 15px;
                border-radius: 12px;
            }
            
            /* Stack form fields vertically on mobile */
            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 15px;
            }
            
            /* Make line items stack vertically */
            .line-item-row {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }
            
            .line-item-row select,
            .line-item-row input {
                width: 100%;
            }
            
            .remove-btn {
                width: 100%;
                padding: 12px;
            }
            
            /* Make tables scrollable horizontally */
            .data-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px;
                font-size: 14px;
            }
            
            /* Stack buttons vertically */
            .btn {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .btn-small {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
        
        /* Phones (480px and below) */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .card {
                padding: 10px;
            }
            
            .form-group label {
                font-size: 14px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 10px;
            }
            
            /* Make table text smaller on very small screens */
            .data-table th,
            .data-table td {
                padding: 6px;
                font-size: 12px;
            }
            
            /* Smaller buttons on very small screens */
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
        
        /* Landscape orientation on mobile devices */
        @media (max-height: 600px) and (orientation: landscape) {
            body {
                padding: 5px;
                min-height: 100vh;
                height: auto;
            }
            
            .container {
                max-width: 100%;
                padding: 0 5px;
                height: auto;
            }
            
            .header {
                margin-bottom: 5px;
            }
            
            .header h1 {
                font-size: 1.1em;
                margin-bottom: 3px;
            }
            
            .header p {
                font-size: 0.75em;
                margin: 0;
            }
            
            /* CRITICAL: Make navigation single-row horizontal scroll in landscape */
            /* Outer wrapper - reduce padding dramatically */
            body > .container > div[style*="position: static"][style*="border: 3px solid"] {
                padding: 2px !important;
                margin: 0px 2px 5px 2px !important;
                border-width: 2px !important;
            }
            
            /* Inner grid container - make it horizontal scroll with ALL cards in ONE row */
            body > .container > div[style*="position: static"] > div[style*="grid-template-columns"] {
                display: flex !important;
                flex-direction: row !important;
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                gap: 4px !important;
                padding: 4px 6px !important;
                scrollbar-width: thin !important;
            }
            
            /* Navigation cards - compact size for landscape */
            .landing-nav-card {
                flex: 0 0 auto !important;
                min-width: 60px !important;
                max-width: 60px !important;
                padding: 4px 3px !important;
                margin: 0 !important;
            }
            
            .landing-nav-card div[style*="font-size: 24px"] {
                font-size: 18px !important;
                margin-bottom: 2px !important;
            }
            
            .landing-nav-card h3 {
                font-size: 8px !important;
                line-height: 1.2 !important;
                margin: 0 !important;
            }
            
            .tabs {
                margin-bottom: 5px;
                gap: 3px;
            }
            
            .tab {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .card {
                padding: 8px;
                height: auto;
                max-height: none !important;
                overflow-y: visible !important;
            }
            
            /* Hide floating navigation buttons in landscape - use compact nav instead */
            #backToTopBtn,
            #backBtn {
                display: none !important;
            }
            
            /* Make tables scroll horizontally in landscape */
            .data-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
                max-width: 100%;
            }
            
            .data-table th,
            .data-table td {
                padding: 6px 8px;
                font-size: 11px;
            }
            
            /* Compact form fields in landscape */
            .form-group {
                margin-bottom: 8px;
            }
            
            .form-group label {
                font-size: 12px;
                margin-bottom: 3px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 6px;
                font-size: 14px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .btn-small {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            /* Reduce spacing in landscape */
            .form-grid {
                gap: 8px;
            }
        }
        
        /* ==================== COMPLETE THEME SYSTEM ==================== */
        
        /* Ocean Blue Theme */
        body.theme-ocean {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
        }
        body.theme-ocean .btn,
        body.theme-ocean .btn-small {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
        }
        body.theme-ocean .btn-success {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%) !important;
        }
        body.theme-ocean .btn-danger {
            background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%) !important;
        }
        body.theme-ocean .tab.active {
            color: #1e3c72 !important;
        }
        body.theme-ocean .tab:hover {
            background: rgba(30, 60, 114, 0.3) !important;
        }
        
        /* Forest Green Theme */
        body.theme-forest {
            background: linear-gradient(135deg, #134e4a 0%, #059669 100%) !important;
        }
        body.theme-forest .btn,
        body.theme-forest .btn-small {
            background: linear-gradient(135deg, #134e4a 0%, #059669 100%) !important;
        }
        body.theme-forest .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%) !important;
        }
        body.theme-forest .btn-danger {
            background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%) !important;
        }
        body.theme-forest .tab.active {
            color: #134e4a !important;
        }
        body.theme-forest .tab:hover {
            background: rgba(19, 78, 74, 0.3) !important;
        }
        
        /* Sunset Orange Theme */
        body.theme-sunset {
            background: linear-gradient(135deg, #c2410c 0%, #ea580c 100%) !important;
        }
        body.theme-sunset .btn,
        body.theme-sunset .btn-small {
            background: linear-gradient(135deg, #c2410c 0%, #ea580c 100%) !important;
        }
        body.theme-sunset .btn-success {
            background: linear-gradient(135deg, #ea580c 0%, #f97316 100%) !important;
        }
        body.theme-sunset .btn-danger {
            background: linear-gradient(135deg, #991b1b 0%, #b91c1c 100%) !important;
        }
        body.theme-sunset .tab.active {
            color: #c2410c !important;
        }
        body.theme-sunset .tab:hover {
            background: rgba(194, 65, 12, 0.3) !important;
        }
        
        /* Professional Dark Theme */
        body.theme-dark {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%) !important;
        }
        body.theme-dark .btn,
        body.theme-dark .btn-small {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%) !important;
        }
        body.theme-dark .btn-success {
            background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%) !important;
        }
        body.theme-dark .btn-danger {
            background: linear-gradient(135deg, #991b1b 0%, #b91c1c 100%) !important;
        }
        body.theme-dark .tab {
            background: rgba(255, 255, 255, 0.15) !important;
        }
        body.theme-dark .tab.active {
            background: white !important;
            color: #1f2937 !important;
            border-left: 4px solid #c0c0c0 !important;
        }
        body.theme-dark .tab:hover {
            background: rgba(255, 255, 255, 0.25) !important;
        }
        body.theme-dark .card {
            background: #f9fafb !important;
        }
        
        /* Crimson Red Theme */
        body.theme-crimson {
            background: linear-gradient(135deg, #be123c 0%, #e11d48 100%) !important;
        }
        body.theme-crimson .btn,
        body.theme-crimson .btn-small {
            background: linear-gradient(135deg, #be123c 0%, #e11d48 100%) !important;
        }
        body.theme-crimson .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%) !important;
        }
        body.theme-crimson .tab.active {
            color: #be123c !important;
        }
        body.theme-crimson .tab:hover {
            background: rgba(190, 18, 60, 0.3) !important;
        }
        
        /* Slate Gray Theme */
        body.theme-slate {
            background: linear-gradient(135deg, #475569 0%, #64748b 100%) !important;
        }
        body.theme-slate .btn,
        body.theme-slate .btn-small {
            background: linear-gradient(135deg, #475569 0%, #64748b 100%) !important;
        }
        body.theme-slate .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%) !important;
        }
        body.theme-slate .tab.active {
            color: #475569 !important;
        }
        body.theme-slate .tab:hover {
            background: rgba(71, 85, 105, 0.3) !important;
        }
        
        /* Teal Theme */
        body.theme-teal {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%) !important;
        }
        body.theme-teal .btn,
        body.theme-teal .btn-small {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%) !important;
        }
        body.theme-teal .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%) !important;
        }
        body.theme-teal .tab.active {
            color: #0d9488 !important;
        }
        body.theme-teal .tab:hover {
            background: rgba(13, 148, 136, 0.3) !important;
        }
        
        /* Royal Purple Theme (Default) */
        body.theme-purple {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        body.theme-purple .btn,
        body.theme-purple .btn-small {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        body.theme-purple .btn-success {
            background: linear-gradient(135deg, #764ba2 0%, #9333ea 100%) !important;
        }
        body.theme-purple .btn-danger {
            background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%) !important;
        }
        body.theme-purple .tab.active {
            color: #667eea !important;
        }
        body.theme-purple .tab:hover {
            background: rgba(102, 126, 234, 0.3) !important;
        }
        
        /* Chicago Bears Theme */
        body.theme-bears {
            background: linear-gradient(135deg, #0B162A 0%, #1C2B3A 100%) !important;
        }
        body.theme-bears .btn,
        body.theme-bears .btn-small {
            background: linear-gradient(135deg, #C83803 0%, #E04A15 100%) !important;
        }
        body.theme-bears .btn-success {
            background: linear-gradient(135deg, #C83803 0%, #E04A15 100%) !important;
        }
        body.theme-bears .tab.active {
            color: #C83803 !important;
        }
        body.theme-bears .tab:hover {
            background: rgba(200, 56, 3, 0.3) !important;
        }
        body.theme-bears .card {
            background: #E4E7EB !important;
        }
        body.theme-bears .header h1 {
            color: #C83803 !important;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        /* Chicago Cubs Theme */
        body.theme-cubs {
            background: linear-gradient(135deg, #0E3386 0%, #142C5C 100%) !important;
        }
        body.theme-cubs .btn,
        body.theme-cubs .btn-small {
            background: linear-gradient(135deg, #CC3433 0%, #E04545 100%) !important;
        }
        body.theme-cubs .btn-success {
            background: linear-gradient(135deg, #0E3386 0%, #1A4AA8 100%) !important;
        }
        body.theme-cubs .tab.active {
            color: #CC3433 !important;
        }
        body.theme-cubs .tab:hover {
            background: rgba(204, 52, 51, 0.3) !important;
        }
        body.theme-cubs .card {
            background: #F1F4F8 !important;
        }
        body.theme-cubs .header h1 {
            color: #CC3433 !important;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        /* Chicago Bulls Theme */
        body.theme-bulls {
            background: linear-gradient(135deg, #121212 0%, #231F20 100%) !important;
        }
        body.theme-bulls .btn,
        body.theme-bulls .btn-small {
            background: linear-gradient(135deg, #CE1141 0%, #E02050 100%) !important;
        }
        body.theme-bulls .btn-success {
            background: linear-gradient(135deg, #A31D3A 0%, #CE1141 100%) !important;
        }
        body.theme-bulls .tab.active {
            color: #CE1141 !important;
        }
        body.theme-bulls .tab:hover {
            background: rgba(206, 17, 65, 0.3) !important;
        }
        body.theme-bulls .card {
            background: #FAFAFA !important;
        }
        body.theme-bulls .header h1 {
            color: #CE1141 !important;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        body.theme-bulls .header {
            border-bottom: 3px solid #CE1141 !important;
        }
        
        /* Chicago Blackhawks Theme */
        body.theme-blackhawks {
            background: linear-gradient(135deg, #001F3F 0%, #112A3C 100%) !important;
        }
        body.theme-blackhawks .btn,
        body.theme-blackhawks .btn-small {
            background: linear-gradient(135deg, #CF0A2C 0%, #E02040 100%) !important;
        }
        body.theme-blackhawks .btn-success {
            background: linear-gradient(135deg, #01583A 0%, #027A50 100%) !important;
        }
        body.theme-blackhawks .tab.active {
            color: #CF0A2C !important;
        }
        body.theme-blackhawks .tab:hover {
            background: rgba(207, 10, 44, 0.3) !important;
        }
        body.theme-blackhawks .card {
            background: #F5F7FA !important;
        }
        body.theme-blackhawks .header h1 {
            color: #CF0A2C !important;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        body.theme-blackhawks .header p {
            color: #E7B08B !important;
        }
        body.theme-blackhawks .header {
            border-bottom: 3px solid #01583A !important;
        }
        
        /* Green Bay Packers Theme */
        body.theme-packers {
            background: linear-gradient(135deg, #172B27 0%, #2C4A42 100%) !important;
        }
        body.theme-packers .btn,
        body.theme-packers .btn-small {
            background: linear-gradient(135deg, #203731 0%, #2C4A42 100%) !important;
            color: #FFB612 !important;
            border: 2px solid #D4A017 !important;
        }
        body.theme-packers .btn:hover {
            background: linear-gradient(135deg, #FFB612 0%, #D4A017 100%) !important;
            color: #203731 !important;
        }
        body.theme-packers .btn-success {
            background: linear-gradient(135deg, #FFB612 0%, #D4A017 100%) !important;
            color: #203731 !important;
            border: none !important;
        }
        body.theme-packers .tab.active {
            color: #FFB612 !important;
        }
        body.theme-packers .tab:hover {
            background: rgba(255, 182, 18, 0.2) !important;
        }
        body.theme-packers .card {
            background: #F9F6EE !important;
        }
        body.theme-packers .header h1 {
            color: #FFB612 !important;
            text-shadow: 0 4px 12px rgba(0,0,0,0.6);
        }
        body.theme-packers .header p {
            color: #D4A017 !important;
        }
        body.theme-packers .header {
            border-bottom: 4px solid #FFB612 !important;
        }
        
        /* Landing Page Navigation Cards */
        .landing-nav-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 30px rgba(0,0,0,0.2) !important;
        }
        
        .landing-nav-card:active {
            transform: translateY(-4px) scale(1.01);
        }
        
        /* Desktop Modal Features - Draggable & Resizable */
        @media (min-width: 769px) {
            /* Add resize handle indicator to modals on desktop */
            .resizable-added::after {
                content: 'â‹°';
                position: absolute;
                bottom: 5px;
                right: 5px;
                font-size: 20px;
                color: #999;
                pointer-events: none;
                line-height: 1;
            }
            
            /* Center modals initially */
            #orderModal > div,
            #reportSetupModal > div,
            .item-picker-container {
                position: relative;
                margin: 50px auto !important;
            }
        }
        
        /* Mobile - keep modals full screen friendly */
        @media (max-width: 768px) {
            /* Lock modal containers to prevent scrolling/movement */
            #orderModal,
            #reportSetupModal,
            #howToGuideModal,
            #uploadItemsModal,
            #itemPickerModal {
                padding: 0 !important;
                overflow: hidden !important; /* Prevent outer scroll */
            }
            
            /* Lock inner modal content - prevent movement */
            #orderModal > div,
            #reportSetupModal > div,
            #howToGuideModal > div,
            #uploadItemsModal > div,
            .item-picker-container {
                position: fixed !important; /* Lock to viewport */
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
                max-height: 100% !important;
                width: 100% !important;
                height: 100% !important;
                transform: none !important;
                border-radius: 0 !important;
                overflow-y: auto !important; /* Content scrolls, but modal doesn't move */
                -webkit-overflow-scrolling: touch !important;
            }
        }
    </style>
    <link rel="stylesheet" href="sports-themes.css">
</head>
<body class="theme-purple">
    <!-- Immediate theme application -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'purple';
            document.body.className = 'theme-' + savedTheme;
        })();
    </script>
    <div class="container">
        <div class="header">
            <h1>ğŸšš Nowak Distributing <span style="transform: scaleX(-1); display: inline-block;">ğŸšš</span></h1>
            <p>Professional Inventory & Order Management System</p>
        </div>

        <!-- Navigation Cards - Always Visible at Top -->
        <!-- Navigation Cards - LOCKED (Not Sticky) - V13 -->
        <div style="position: static; z-index: 100; background: var(--bg-color, #f5f5f5); padding: 5px; margin: 0px 5px 5px 5px; border: 3px solid var(--primary, #667eea); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; padding: 8px; background: linear-gradient(135deg, var(--primary, #1e3a8a) 0%, var(--accent, #3b82f6) 100%); border-radius: 10px; box-shadow: 0 4px 16px rgba(0,0,0,0.2);">
                
                <!-- Suppliers Card -->
                <div class="landing-nav-card active-nav-card" onclick="switchTab('suppliers')" style="background: rgba(255,255,255,0.95); color: #1e3a8a; padding: 8px 6px; border: 2px solid #1e3a8a; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;">ğŸ­</div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Suppliers</h3>
                </div>

                <!-- Items Card -->
                <div class="landing-nav-card" onclick="switchTab('items')" style="background: rgba(255,255,255,0.95); color: #475569; padding: 8px 6px; border: 2px solid #475569; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;">ğŸ“¦</div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Items</h3>
                </div>

                <!-- Customers Card -->
                <div class="landing-nav-card" onclick="switchTab('customers')" style="background: rgba(255,255,255,0.95); color: #0369a1; padding: 8px 6px; border: 2px solid #0369a1; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;">ğŸ‘¥</div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Customers</h3>
                </div>

                <!-- Create PO Card -->
                <div class="landing-nav-card" onclick="switchTab('createpo')" style="background: rgba(255,255,255,0.95); color: #0f766e; padding: 8px 6px; border: 2px solid #0f766e; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;">ğŸ“</div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Create PO</h3>
                </div>

                <!-- Purchases Card -->
                <div class="landing-nav-card" onclick="switchTab('purchases')" style="background: rgba(255,255,255,0.95); color: #4338ca; padding: 8px 6px; border: 2px solid #4338ca; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;">ğŸ“¥</div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Purchases</h3>
                </div>

                <!-- Sales Card -->
                <div class="landing-nav-card" onclick="switchTab('sales')" style="background: rgba(255,255,255,0.95); color: #065f46; padding: 8px 6px; border: 2px solid #065f46; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;">ğŸ’°</div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Sales</h3>
                </div>

                <!-- Inventory Card -->
                <div class="landing-nav-card" onclick="switchTab('inventory')" style="background: rgba(255,255,255,0.95); color: #374151; padding: 8px 6px; border: 2px solid #374151; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;">ğŸ“Š</div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Inventory</h3>
                </div>

                <!-- Price Simulator Card -->
                <div class="landing-nav-card" onclick="switchTab('pricesim')" style="background: rgba(255,255,255,0.95); color: #1e40af; padding: 8px 6px; border: 2px solid #1e40af; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;">ğŸ¯</div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Price Sim</h3>
                </div>

                <!-- Reports Card -->
                <div class="landing-nav-card" onclick="switchTab('reports')" style="background: rgba(255,255,255,0.95); color: #4c1d95; padding: 8px 6px; border: 2px solid #4c1d95; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;">ğŸ“ˆ</div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Reports</h3>
                </div>

                <!-- Settings Card -->
                <div class="landing-nav-card" onclick="switchTab('config')" style="background: rgba(255,255,255,0.95); color: #52525b; padding: 8px 6px; border: 2px solid #52525b; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;">âš™ï¸</div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Settings</h3>
                </div>
            </div>
        </div>
        
        <!-- Floating Navigation Buttons - Bottom Left Corner -->
        <!-- Back to Top Button - Top -->
        <button id="backToTopBtn" onclick="scrollToTop()" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" style="display: none; position: fixed; bottom: 100px; left: 30px; z-index: 1000; background: var(--primary, #667eea); color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.3s ease;" title="Back to top">
            â¬†ï¸
        </button>
        
        <!-- Back Button - Bottom -->
        <button id="backBtn" onclick="goBack()" style="display: none; position: fixed; bottom: 30px; left: 30px; z-index: 1000; background: var(--primary, #667eea); color: white; border: none; border-left: 4px solid rgba(255,255,255,0.4); border-radius: 50%; width: 60px; height: 60px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="Go back to previous tab">
            â¬…ï¸
        </button>

        <!-- Settings Tab -->
        <div id="config" class="card">
            <h2>System Configuration</h2>
            <div class="status" id="configStatus"></div>
            
            <!-- How-To Guide Section -->
            <div style="margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3); color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0 0 8px 0; font-size: 20px;">ğŸ“š How-To Guide</h3>
                        <p style="margin: 0; opacity: 0.95; font-size: 14px;">Complete instructions for using the ERP system</p>
                    </div>
                    <button onclick="openHowToGuide()" style="background: white; color: var(--primary, #667eea); border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)'">
                        ğŸ“– Open Guide
                    </button>
                </div>
            </div>
            
            <!-- Theme Selection - First and prominent -->
            <div style="margin-bottom: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸ¨ Theme</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('themeSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="themeSection-toggle">â–¼ Hide</span>
                    </button>
                </div>
                <div id="themeSection">
                    <p style="margin-bottom: 10px; color: #666;">
                        Choose your color scheme (280+ options!)
                    </p>
                    <div onclick="openThemePicker()" style="cursor: pointer; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; background: white; display: flex; align-items: center; gap: 15px; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary, #667eea)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                        <div id="themePreviewSwatch" style="width: 50px; height: 50px; border-radius: 10px; background: var(--primary, #667eea); box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>
                        <div style="flex: 1;">
                            <div id="themePreviewName" style="font-weight: 600; font-size: 16px; color: #333;">ğŸŸ£ Royal Purple</div>
                            <div style="font-size: 13px; color: #888;">Click to browse 280+ themes</div>
                        </div>
                        <div style="font-size: 24px; color: #999;">â†’</div>
                    </div>
                    <input type="hidden" id="themeSelector" value="purple">
                </div>
            </div>
            
            <!-- Backup Data Section -->
            <div style="margin-bottom: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸ’¾ Backup Data</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('backupSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="backupSection-toggle">â–¼ Hide</span>
                    </button>
                </div>
                <div id="backupSection">
                    <p style="margin-bottom: 10px; color: #666;">
                        Access your Google Sheet database directly
                    </p>
                    <button class="btn btn-secondary" onclick="openBackup()">ğŸ“¥ Open Google Sheet</button>
                </div>
            </div>
            
            <!-- Invoice Settings Section -->
            <div style="margin-bottom: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸ“„ Invoice Settings</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('invoiceSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="invoiceSection-toggle">â–¼ Hide</span>
                    </button>
                </div>
                <div id="invoiceSection">
                    <p style="margin-bottom: 15px; color: #666;">
                        Customize your printed invoices
                    </p>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Company Name *</label>
                            <input type="text" id="invoiceCompanyName" placeholder="Nowak Distributing">
                        </div>
                        
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="invoiceContactName" placeholder="Joe Nowak">
                        </div>
                        
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="text" id="invoicePhone" placeholder="(920)634-4351">
                        </div>
                        
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="invoiceEmail" placeholder="jnowaksnfoodistributors@gmail.com">
                        </div>
                        
                        <div class="form-group">
                            <label>Address Line 1</label>
                            <input type="text" id="invoiceAddress1" placeholder="123 Business Street">
                        </div>
                        
                        <div class="form-group">
                            <label>Address Line 2</label>
                            <input type="text" id="invoiceAddress2" placeholder="Suite 100 (optional)">
                        </div>
                        
                        <div class="form-group">
                            <label>City, State, ZIP</label>
                            <input type="text" id="invoiceCityStateZip" placeholder="Milwaukee, WI 53201">
                        </div>
                        
                        <div class="form-group">
                            <label>Footer Message</label>
                            <textarea id="invoiceFooter" rows="2" placeholder="Thank you for doing business with us!"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 10px;">
                        <label>
                            <input type="checkbox" id="invoiceSignatureLine" checked>
                            Include signature line on invoices
                        </label>
                    </div>
                    
                    <button class="btn" onclick="if(event && debounceButton(event.currentTarget)) saveInvoiceSettings()">ğŸ’¾ Save Invoice Settings</button>
                </div>
            </div>
            
            <!-- Current Status Section -->
            <div style="margin-bottom: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸ“Š Current Status</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('statusSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="statusSection-toggle">â–¼ Hide</span>
                    </button>
                </div>
                <div id="statusSection">
                    <p id="configStatusText">âš ï¸ Not configured</p>
                </div>
            </div>
            
            <!-- Backend API URL - At bottom, collapsed by default -->
            <div style="margin-bottom: 20px; background: #f8f9fa; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #999;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; color: #666;">ğŸ”§ Backend API URL</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('apiSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="apiSection-toggle">â–¶ Show</span>
                    </button>
                </div>
                <div id="apiSection" style="display: none; margin-top: 15px;">
                    <p style="margin-bottom: 10px; color: #888; font-size: 13px;">
                        âš ï¸ Advanced setting - only change if instructed
                    </p>
                    <input type="text" id="apiUrl" class="form-group" style="width: 100%; padding: 10px; margin-bottom: 15px;" 
                           placeholder="https://script.google.com/macros/s/.../exec">
                    <button class="btn" onclick="if(event && debounceButton(event.currentTarget)) saveConfig()">ğŸ’¾ Save Configuration</button>
                </div>
            </div>
        </div>

        <!-- HOME / LANDING PAGE -->
        <!-- Suppliers Tab -->
        <div id="suppliers" class="card active">
            <h2>Suppliers</h2>
            <div class="status" id="suppliersStatus"></div>
            
            <button class="btn" onclick="loadSuppliers()">ğŸ”„ Refresh</button>
            <button class="btn" onclick="showAddSupplierForm()">â• Add Supplier</button>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;">ğŸ” Filter Suppliers</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-suppliers')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-suppliers-toggle">â–¶ Show</span>
                    </button>
                </div>
                <div id="filter-panel-suppliers" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Search Name</label>
                        <input type="text" id="filterSupplierName" placeholder="ğŸ” Click to search..." onkeyup="filterSuppliers()" onclick="openSupplierPickerForFilter(this)" readonly style="cursor: pointer; background: #fff;">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="filterSupplierCity" placeholder="Filter by city..." onkeyup="filterSuppliers()">
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <input type="text" id="filterSupplierState" placeholder="Filter by state..." onkeyup="filterSuppliers()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearSupplierFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addSupplierForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <h3>Add New Supplier</h3>
                <form onsubmit="addSupplier(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier Name *</label>
                            <input type="text" id="newSupplierName" required>
                        </div>
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="newContactName">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="newPhone" placeholder="(999) 999-9999" oninput="formatPhone(this)">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="newEmail">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="newAddress">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="newCity">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" id="newState" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" id="newZip">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Payment Terms</label>
                        <select id="newPaymentTerms">
                            <option value="Net 30">Net 30</option>
                            <option value="Net 45">Net 45</option>
                            <option value="Net 60">Net 60</option>
                            <option value="COD">COD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="newNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn">ğŸ’¾ Save Supplier</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddSupplierForm()">Cancel</button>
                </form>
            </div>
            
            <!-- Edit Supplier Form -->
            <div id="editSupplierForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #f39c12;">
                <h3>âœï¸ Edit Supplier</h3>
                <form onsubmit="updateSupplier(event)">
                    <input type="hidden" id="editSupplierId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier Name *</label>
                            <input type="text" id="editSupplierName" required>
                        </div>
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="editContactName">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="editPhone">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="editEmail">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="editAddress">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="editCity">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" id="editState" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" id="editZip">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Payment Terms</label>
                        <select id="editPaymentTerms">
                            <option value="Net 30">Net 30</option>
                            <option value="Net 45">Net 45</option>
                            <option value="Net 60">Net 60</option>
                            <option value="COD">COD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn">ğŸ’¾ Update Supplier</button>
                    <button type="button" class="btn btn-secondary" onclick="hideEditSupplierForm()">Cancel</button>
                </form>
            </div>
            
            <div id="suppliersTable"></div>
        </div>

        <!-- Items Tab -->
        <div id="items" class="card">
            <h2>Items</h2>
            <div class="status" id="itemsStatus"></div>
            
            <button class="btn" onclick="loadItems()">ğŸ”„ Refresh</button>
            <button class="btn" onclick="showAddItemForm()">â• Add Item</button>
            <button class="btn" onclick="downloadItemsReport()" style="background: #17a2b8;">ğŸ“¥ Download Items</button>
            <button class="btn" onclick="openUploadItemsModal()" style="background: #28a745;">ğŸ“¤ Upload Items</button>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;">ğŸ” Filter Items</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-items')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-items-toggle">â–¶ Show</span>
                    </button>
                </div>
                <div id="filter-panel-items" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Search SKU/Description</label>
                        <input type="text" id="filterItemSearch" placeholder="ğŸ” Click to search..." onkeyup="filterItems()" onclick="openItemPickerForFilter(this)" readonly style="cursor: pointer; background: #fff;">
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <select id="filterItemSupplier" onchange="filterItems()">
                            <option value="">All Suppliers</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stock Status</label>
                        <select id="filterItemStock" onchange="filterItems()">
                            <option value="">All Items</option>
                            <option value="negative">ğŸš¨ Negative Inventory</option>
                            <option value="low">âš ï¸ Low Stock (Below Reorder)</option>
                            <option value="onorder">ğŸ“¦ On Order (Pending Delivery)</option>
                            <option value="reorder">ğŸ›’ Needs Reorder (Low + No Order)</option>
                            <option value="ok">âœ… Normal Stock</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Item Status</label>
                        <select id="filterItemActive" onchange="filterItems()">
                            <option value="active">âœ… Active Items Only</option>
                            <option value="archived">ğŸ“¦ Archived Items Only</option>
                            <option value="">All Items</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearItemFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addItemForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <h3>Add New Item</h3>
                <form onsubmit="addItem(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="newItemSupplier" required>
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Item Description *</label>
                            <input type="text" id="newItemDescription" required>
                        </div>
                        <div class="form-group">
                            <label>SKU *</label>
                            <input type="text" id="newItemSKU" required placeholder="e.g. BM-BBQ-001">
                        </div>
                        <div class="form-group">
                            <label>Purchase UOM (What you buy)</label>
                            <input type="text" id="newItemPurchaseUOMDisplay" value="Case" 
                                   onclick="openUOMPicker('newItemPurchaseUOM')" readonly
                                   style="cursor: pointer; background: #fff;">
                            <input type="hidden" id="newItemPurchaseUOM" value="Case">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Units Per Package * <span style="font-size: 12px; color: #666;">(How many individual units in one box/case)</span></label>
                            <input type="number" id="newUnitsPerPackage" step="1" min="1" required placeholder="e.g. 27">
                        </div>
                        <div class="form-group">
                            <label>Package Cost * <span style="font-size: 12px; color: #666;">(Cost per box/case)</span></label>
                            <input type="number" id="newPackageCost" step="0.01" required placeholder="e.g. 20.00" oninput="calculateUnitCost()">
                        </div>
                        <div class="form-group">
                            <label>Unit Cost (Calculated)</label>
                            <input type="text" id="calculatedUnitCost" readonly style="background: #f0f0f0; font-weight: bold;" value="$0.00">
                        </div>
                        <div class="form-group">
                            <label>Unit Sell Price * <span style="font-size: 12px; color: #666;">(Price per individual unit)</span></label>
                            <input type="number" id="newUnitSellPrice" step="0.01" required placeholder="e.g. 3.00">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Initial Quantity <span style="font-size: 12px; color: #666;">(In individual units)</span></label>
                            <input type="number" id="newQtyOnHand" value="0">
                        </div>
                        <div class="form-group">
                            <label>Reorder Point <span style="font-size: 12px; color: #666;">(In individual units)</span></label>
                            <input type="number" id="newReorderPoint" value="10">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="newItemNotes" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn">ğŸ’¾ Save Item</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddItemForm()">Cancel</button>
                </form>
            </div>
            
            <!-- Edit Item Form -->
            <div id="editItemForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #f39c12;">
                <h3>âœï¸ Edit Item</h3>
                <form onsubmit="updateItem(event)">
                    <input type="hidden" id="editItemId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="editItemSupplier" required>
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Item Description *</label>
                            <input type="text" id="editItemDescription" required>
                        </div>
                        <div class="form-group">
                            <label>SKU *</label>
                            <input type="text" id="editItemSKU" required>
                        </div>
                        <div class="form-group">
                            <label>Purchase UOM</label>
                            <input type="text" id="editItemPurchaseUOMDisplay" 
                                   onclick="openUOMPicker('editItemPurchaseUOM')" readonly
                                   style="cursor: pointer; background: #fff;">
                            <input type="hidden" id="editItemPurchaseUOM">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Units Per Package *</label>
                            <input type="number" id="editUnitsPerPackage" step="1" min="1" required oninput="calculateEditUnitCost()">
                        </div>
                        <div class="form-group">
                            <label>Package Cost *</label>
                            <input type="number" id="editPackageCost" step="0.01" required oninput="calculateEditUnitCost()">
                        </div>
                        <div class="form-group">
                            <label>Unit Cost (Calculated)</label>
                            <input type="text" id="calculatedEditUnitCost" readonly style="background: #f0f0f0; font-weight: bold;" value="$0.00">
                        </div>
                        <div class="form-group">
                            <label>Unit Sell Price *</label>
                            <input type="number" id="editUnitSellPrice" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Current Quantity <span style="font-size: 12px; color: #666;">(In individual units)</span></label>
                            <input type="number" id="editQtyOnHand" readonly style="background: #f0f0f0;">
                            <small style="color: #666;">Use Purchases/Sales to adjust quantity</small>
                        </div>
                        <div class="form-group">
                            <label>Reorder Point <span style="font-size: 12px; color: #666;">(In individual units)</span></label>
                            <input type="number" id="editReorderPoint">
                        </div>
                        <div class="form-group">
                            <label>Item Status</label>
                            <select id="editItemStatus">
                                <option value="Active">âœ… Active</option>
                                <option value="Archived">ğŸ“¦ Archived</option>
                            </select>
                            <small style="color: #666;">Archived items won't appear in new PO/SO dropdowns</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editItemNotes" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn">ğŸ’¾ Update Item</button>
                    <button type="button" class="btn btn-secondary" onclick="hideEditItemForm()">Cancel</button>
                </form>
            </div>
            
            <div id="itemsTable"></div>
        </div>

        <!-- Customers Tab -->
        <div id="customers" class="card">
            <h2>Customers</h2>
            <div class="status" id="customersStatus"></div>
            
            <button class="btn" onclick="loadCustomers()">ğŸ”„ Refresh</button>
            <button class="btn" onclick="showAddCustomerForm()">â• Add Customer</button>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;">ğŸ” Filter Customers</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-customers')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-customers-toggle">â–¶ Show</span>
                    </button>
                </div>
                <div id="filter-panel-customers" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Search Name</label>
                        <input type="text" id="filterCustomerName" placeholder="ğŸ” Click to search..." onkeyup="filterCustomers()" onclick="openCustomerPickerForFilter(this)" readonly style="cursor: pointer; background: #fff;">
                    </div>
                    <div class="form-group">
                        <label>Contact Name</label>
                        <input type="text" id="filterCustomerContact" placeholder="Contact name..." onkeyup="filterCustomers()">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="filterCustomerCity" placeholder="Filter by city..." onkeyup="filterCustomers()">
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <input type="text" id="filterCustomerState" placeholder="Filter by state..." onkeyup="filterCustomers()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearCustomerFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addCustomerForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <h3>Add New Customer</h3>
                <form onsubmit="addCustomer(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Customer Name *</label>
                            <input type="text" id="newCustomerName" required>
                        </div>
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="newCustomerContact">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="newCustomerPhone">
                        </div>
                        <div class="form-group">
                            <label>Mobile</label>
                            <input type="tel" id="newCustomerMobile">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="newCustomerEmail">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="newCustomerAddress">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="newCustomerCity">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" id="newCustomerState" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" id="newCustomerZip">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Credit Limit</label>
                            <input type="number" id="newCreditLimit" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Payment Terms</label>
                            <select id="newCustomerPaymentTerms">
                                <option value="Net 30">Net 30</option>
                                <option value="Net 15">Net 15</option>
                                <option value="Net 45">Net 45</option>
                                <option value="COD">COD</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="newCustomerNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn">ğŸ’¾ Save Customer</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddCustomerForm()">Cancel</button>
                </form>
            </div>
            
            <!-- Edit Customer Form -->
            <div id="editCustomerForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #f39c12;">
                <h3>âœï¸ Edit Customer</h3>
                <form onsubmit="updateCustomer(event)">
                    <input type="hidden" id="editCustomerId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Customer Name *</label>
                            <input type="text" id="editCustomerName" required>
                        </div>
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="editCustomerContact">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="editCustomerPhone">
                        </div>
                        <div class="form-group">
                            <label>Mobile</label>
                            <input type="tel" id="editCustomerMobile">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="editCustomerEmail">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="editCustomerAddress">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="editCustomerCity">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" id="editCustomerState" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" id="editCustomerZip">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Credit Limit</label>
                            <input type="number" id="editCreditLimit" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Payment Terms</label>
                            <select id="editCustomerPaymentTerms">
                                <option value="Net 30">Net 30</option>
                                <option value="Net 15">Net 15</option>
                                <option value="Net 45">Net 45</option>
                                <option value="COD">COD</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editCustomerNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn">ğŸ’¾ Update Customer</button>
                    <button type="button" class="btn btn-secondary" onclick="hideEditCustomerForm()">Cancel</button>
                </form>
            </div>
            
            <div id="customersTable"></div>
        </div>

        <!-- Create PO Tab (Generate Only - No Database Save) -->
        <div id="createpo" class="card">
            <div style="max-width: 100%; overflow: hidden;">
                <h2>ğŸ“ Create Purchase Order</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Create an OUTGOING purchase order to track items on order from suppliers. Use <strong>"Save as OUTGOING PO"</strong> to save to database and mark items as "On Order", or use <strong>"Print PO (No Save)"</strong> to just generate a printable document.
                </p>
                
                <div id="createPOForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="createPOSupplier" required onchange="filterItemsBySupplier()">
                                <option value="">Select Supplier...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>PO Date *</label>
                            <input type="date" id="createPODate" required>
                        </div>
                        <div class="form-group">
                            <label>Expected Delivery Date</label>
                            <input type="date" id="createPOExpectedDate">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Notes</label>
                            <textarea id="createPONotes" rows="2" placeholder="Special instructions, delivery notes, etc."></textarea>
                        </div>
                    </div>
                
                <h3>Line Items</h3>
                
                <!-- Wrapper for horizontal scroll on mobile -->
                <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 20px; width: 100%; position: relative;">
                    <div style="min-width: 700px; width: 100%; max-width: 100%;">
                        <!-- Header Row -->
                        <div style="display: grid; grid-template-columns: 2.5fr 1fr 0.6fr 0.8fr 0.8fr 0.8fr 50px; gap: 6px; padding: 12px; background: var(--primary, #667eea); color: white; font-weight: bold; border-radius: 8px 8px 0 0; font-size: 14px;">
                            <div>Item</div>
                            <div style="text-align: center;">Cases</div>
                            <div style="text-align: center;">Units/Case</div>
                            <div style="text-align: center;">Total Units</div>
                            <div style="text-align: center;">Catalog Cost</div>
                            <div style="text-align: right;">Line Total</div>
                            <div style="text-align: center;">Del</div>
                        </div>
                        
                        <!-- Line Items Container -->
                        <div id="createPOLineItems" style="border: 2px solid #667eea; border-top: none; border-radius: 0 0 8px 8px; padding: 10px; background: #fafafa;">
                            <div class="line-item-row" style="display: grid; grid-template-columns: 2.5fr 1fr 0.6fr 0.8fr 0.8fr 0.8fr 50px; gap: 8px; margin-bottom: 10px; align-items: end;">
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;">ğŸ“¦ Item</label>
                                    <select class="createpo-item" style="width: 100%; padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white;">
                                        <option value="">Select item...</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;">ğŸ“¦ Cases</label>
                                    <input type="number" class="createpo-qty" placeholder="0" min="1" style="width: 100%; padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px;">
                                </div>
                                <div style="margin-top: 26px;">
                                    <div class="createpo-units" style="text-align: center; font-size: 14px; color: #666; padding: 6px;">-</div>
                                </div>
                                <div style="margin-top: 26px;">
                                    <div class="createpo-totalunits" style="text-align: center; font-size: 16px; font-weight: bold; color: var(--primary, #667eea); padding: 6px;">-</div>
                                </div>
                                <div style="margin-top: 26px;">
                                    <div class="createpo-cost" style="text-align: center; font-size: 14px; font-weight: bold; color: #28a745; background: #e8f5e9; padding: 10px; border-radius: 6px;">-</div>
                                </div>
                                <div style="margin-top: 26px;">
                                    <div class="createpo-linetotal" style="text-align: right; font-size: 14px; font-weight: bold; color: var(--primary, #667eea); background: var(--primary-light, #E3F2FD); padding: 10px; border-radius: 6px;">$0.00</div>
                                </div>
                                <button type="button" class="btn-danger" onclick="removeLineItem(this)" style="width: 100%; padding: 10px; font-size: 14px; margin-top: 26px;">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-secondary" onclick="addCreatePOLineItem()">â• Add Line Item</button>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <h3 style="margin: 0 0 10px 0; color: #666; font-size: 16px;">Total Cases</h3>
                            <p style="font-size: 28px; font-weight: bold; color: var(--primary, #667eea); margin: 0;" id="createPOTotalCases">0</p>
                        </div>
                        <div style="text-align: center;">
                            <h3 style="margin: 0 0 10px 0; color: #666; font-size: 16px;">Total Units</h3>
                            <p style="font-size: 28px; font-weight: bold; color: var(--primary, #667eea); margin: 0;" id="createPOTotalUnits">0</p>
                        </div>
                        <div style="text-align: center;">
                            <h3 style="margin: 0 0 10px 0; color: #666; font-size: 16px;">Total Cost</h3>
                            <p style="font-size: 28px; font-weight: bold; color: var(--primary, #667eea); margin: 0;" id="createPOTotal">$0.00</p>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
                    <button class="btn" onclick="if(event && debounceButton(event.currentTarget)) saveOutgoingPO()" style="flex: 1; min-width: 200px;">ğŸ’¾ Save as OUTGOING PO</button>
                    <button class="btn" onclick="generatePrintablePO()" style="flex: 1; min-width: 200px;">ğŸ–¨ï¸ Print PO (No Save)</button>
                    <button class="btn btn-secondary" onclick="clearCreatePOForm()" style="flex: 1; min-width: 200px;">ğŸ”„ Clear Form</button>
                </div>
            </div>
            </div>
            
            <!-- Printable PO Document (Hidden initially) -->
            <div id="printablePOContainer" style="display: none; margin-top: 30px;">
                <div style="text-align: right; margin-bottom: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn" onclick="window.print()">ğŸ–¨ï¸ Print</button>
                    <button class="btn" onclick="downloadPOAsPDF()">ğŸ“¥ Download PDF</button>
                    <button class="btn" onclick="emailPO()">ğŸ“§ Email PO</button>
                    <button class="btn btn-secondary" onclick="closePrintablePO()">âŒ Close</button>
                </div>
                <div id="printablePO" style="background: white; padding: 40px; border: 1px solid #ddd; max-width: 800px; margin: 0 auto;">
                    <!-- Printable PO will be generated here -->
                </div>
            </div>
        </div>

        <!-- Purchases Tab -->
        <div id="purchases" class="card">
            <h2>Purchase Orders</h2>
            <div class="status" id="purchasesStatus"></div>
            
            <button class="btn" onclick="loadPurchases()">ğŸ”„ Refresh</button>
            <button class="btn" onclick="showAddPurchaseForm()">â• Record Purchase</button>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;">ğŸ” Filter Purchases</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-purchases')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-purchases-toggle">â–¶ Show</span>
                    </button>
                </div>
                <div id="filter-panel-purchases" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Invoice # / PO</label>
                        <input type="text" id="filterPurchasePO" placeholder="ğŸ” Click to search..." onclick="openPOPicker(this)" readonly style="cursor: pointer; background: #fff;">
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <select id="filterPurchaseSupplier" onchange="filterPurchases()">
                            <option value="">All Suppliers</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Order Status</label>
                        <select id="filterPurchaseStatus" onchange="filterPurchases()">
                            <option value="">All</option>
                            <option value="Ordered">ğŸ“¤ Ordered (Pending)</option>
                            <option value="Received">ğŸ“¥ Received</option>
                            <option value="Voided">âŒ Voided</option>
                            <option value="exclude-voided">ğŸš« Exclude Voided</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ğŸ’µ Payment Status</label>
                        <select id="filterPurchasePaymentStatus" onchange="filterPurchases()">
                            <option value="">All</option>
                            <option value="Paid">âœ… Paid</option>
                            <option value="Partial">ğŸŸ¡ Partial</option>
                            <option value="Unpaid">ğŸ”´ Unpaid</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ğŸ“… PO Date From</label>
                        <input type="date" id="filterPurchaseDateFrom" onchange="filterPurchases()">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“… PO Date To</label>
                        <input type="date" id="filterPurchaseDateTo" onchange="filterPurchases()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearPurchaseFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addPurchaseForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <h3>Record New Purchase</h3>
                <form onsubmit="addPurchase(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="poSupplier" required onchange="loadSupplierItems()">
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Invoice Number *</label>
                            <input type="text" id="poInvoiceNumber" required>
                        </div>
                        <div class="form-group">
                            <label>Purchase Date *</label>
                            <input type="date" id="poDate" required>
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="poDueDate">
                        </div>
                        <div class="form-group">
                            <label>Payment Terms</label>
                            <select id="poPaymentTerms">
                                <option value="Net 30">Net 30</option>
                                <option value="Net 60">Net 60</option>
                                <option value="COD">COD (Cash on Delivery)</option>
                                <option value="Prepaid">Prepaid</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="poStatus">
                                <option value="Received">Received</option>
                                <option value="Pending">Pending</option>
                                <option value="Partial">Partial</option>
                                <option value="Voided">âŒ Voided</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Invoice Total *</label>
                            <input type="number" id="poTotal" step="0.01" min="0" required readonly style="background: #f0f0f0;">
                            <small style="color: #666;">Auto-calculated from line items</small>
                        </div>
                        <div class="form-group">
                            <label>Amount Paid</label>
                            <input type="number" id="poAmountPaid" step="0.01" min="0" value="0" placeholder="0.00">
                            <small style="color: #666;">Enter amount if paid at time of purchase</small>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 20px; margin-bottom: 10px;">Line Items</h4>
                    <div class="line-items-container" id="poLineItems">
                        <div class="line-item-row">
                            <select class="po-item" required>
                                <option value="">Select Item</option>
                            </select>
                            <input type="number" class="po-qty" placeholder="Quantity" min="1" required>
                            <input type="number" class="po-cost" placeholder="Unit Cost" step="0.01" min="0" required>
                            <button type="button" class="remove-btn">âœ•</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-secondary" onclick="addPOLineItem()">+ Add Line Item</button>
                        <button type="button" class="btn" onclick="addNewItemFromPO()" style="background: #9c27b0;">â• Add New Item to Catalog</button>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Notes</label>
                        <textarea id="poNotes" rows="2"></textarea>
                    </div>
                    
                    <button type="submit" class="btn">ğŸ’¾ Save Purchase Order</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddPurchaseForm()">Cancel</button>
                </form>
            </div>
            
            <div id="purchasesTable"></div>
        </div>

        <!-- Sales Tab -->
        <div id="sales" class="card">
            <h2>Sales Orders</h2>
            <div class="status" id="salesStatus"></div>
            
            <button class="btn" onclick="loadSales()">ğŸ”„ Refresh</button>
            <button class="btn" onclick="showAddSaleForm()">â• Record Sale</button>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;">ğŸ” Filter Sales</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-sales')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-sales-toggle">â–¶ Show</span>
                    </button>
                </div>
                <div id="filter-panel-sales" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Customer</label>
                        <select id="filterSaleCustomer" onchange="filterSales()">
                            <option value="">All Customers</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Invoice #</label>
                        <input type="text" id="filterInvoiceNumber" placeholder="ğŸ” Click to search..." onclick="openInvoicePicker(this)" readonly style="cursor: pointer; background: #fff;">
                    </div>
                    <div class="form-group">
                        <label>Order Status</label>
                        <select id="filterSaleStatus" onchange="filterSales()">
                            <option value="">All</option>
                            <option value="Completed">âœ… Completed</option>
                            <option value="Pending">ğŸŸ¡ Pending</option>
                            <option value="Cancelled">ğŸš« Cancelled</option>
                            <option value="Voided">âŒ Voided</option>
                            <option value="exclude-voided">ğŸš« Exclude Voided</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date From</label>
                        <input type="date" id="filterSaleDateFrom" onchange="filterSales()">
                    </div>
                    <div class="form-group">
                        <label>Date To</label>
                        <input type="date" id="filterSaleDateTo" onchange="filterSales()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearSaleFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addSaleForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <h3>Record New Sale</h3>
                <form onsubmit="addSale(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Customer *</label>
                            <select id="soCustomer" required>
                                <option value="">Select Customer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Sale Date *</label>
                            <input type="date" id="soDate" required>
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="soPayment">
                                <option value="Cash">Cash</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Check">Check</option>
                                <option value="Invoice">Invoice</option>
                                <option value="Terms (Net 30)">Terms (Net 30)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Due Date (if invoiced)</label>
                            <input type="date" id="soDueDate">
                        </div>
                        <div class="form-group">
                            <label>Order Total *</label>
                            <input type="number" id="soTotal" step="0.01" min="0" required readonly style="background: #f0f0f0;">
                            <small style="color: #666;">Auto-calculated from line items</small>
                        </div>
                        <div class="form-group">
                            <label>Amount Paid</label>
                            <input type="number" id="soAmountPaid" step="0.01" min="0" value="0" placeholder="0.00">
                            <small style="color: #666;">Enter amount if paid at time of sale</small>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="soStatus">
                                <option value="Completed">Completed</option>
                                <option value="Pending">Pending</option>
                                <option value="Cancelled">Cancelled</option>
                                <option value="Voided">âŒ Voided</option>
                            </select>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 20px; margin-bottom: 10px;">Items Sold</h4>
                    <div class="line-items-container" id="soLineItems" style="background: #fafafa; padding: 15px; border-radius: 8px; border: 2px solid #667eea;">
                        <div class="line-item-row" style="display: grid; grid-template-columns: 2.5fr 1fr 1fr 50px; gap: 10px; margin-bottom: 10px; align-items: end;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;">ğŸ“¦ Item</label>
                                <select class="so-item" required style="padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white; width: 100%;">
                                    <option value="">Select Item</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;">ğŸ“Š Quantity</label>
                                <input type="number" class="so-qty" placeholder="0" min="1" required style="padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px; width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;">ğŸ’° Price</label>
                                <input type="number" class="so-price" placeholder="0.00" step="0.01" min="0" required style="padding: 14px 10px; border: 2px solid #667eea; border-radius: 8px; text-align: center; font-size: 16px; min-height: 52px; background: white; width: 100%;">
                            </div>
                            <button type="button" class="remove-btn" style="min-height: 52px; font-size: 18px; margin-top: 26px;">âœ•</button>
                            <div class="so-stock-info" style="grid-column: 1 / -1; font-size: 13px; padding: 5px 10px; margin-top: -5px; display: none;"></div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addSOLineItem()">+ Add Line Item</button>
                    
                    <!-- Summary Boxes -->
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #667eea;">
                        <h4 style="margin: 0 0 15px 0; color: #667eea; text-align: center;">ğŸ“Š Order Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;">
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <h3 style="margin: 0 0 10px 0; color: #666; font-size: 14px;">ğŸ“¦ Total Items</h3>
                                <p style="font-size: 32px; font-weight: bold; color: #667eea; margin: 0;" id="soTotalQty">0</p>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <h3 style="margin: 0 0 10px 0; color: #666; font-size: 14px;">ğŸ’° Total Amount</h3>
                                <p style="font-size: 32px; font-weight: bold; color: #2e7d32; margin: 0;" id="soTotalAmount">$0.00</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Notes</label>
                        <textarea id="soNotes" rows="2"></textarea>
                    </div>
                    
                    <button type="submit" class="btn">ğŸ’¾ Save Sale</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddSaleForm()">Cancel</button>
                </form>
            </div>
            
            <div id="salesTable"></div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="card">
            <h2>Inventory Report</h2>
            <div class="status" id="inventoryStatus"></div>
            
            <div style="margin-bottom: 15px;">
                <button class="btn" onclick="loadInventory()">ğŸ”„ Refresh</button>
                <button class="btn" onclick="showAdjustInventoryForm()" style="background: #f39c12;">ğŸ“ Adjust Inventory</button>
                <button class="btn" onclick="goToAddItem()" style="background: #9c27b0;">â• Add New Item</button>
            </div>
            
            <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 14px;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleSection('inventoryGuide')">
                    <strong>ğŸ“– Quick Guide</strong>
                    <span id="inventoryGuide-toggle" style="color: var(--primary, #667eea);">â–¼ Hide</span>
                </div>
                <div id="inventoryGuide" style="margin-top: 10px;">
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><strong>â• Add New Item</strong> - Add items you already have in stock (no purchase order needed)</li>
                        <li><strong>ğŸ“ Adjust Inventory</strong> - Fix counts, record damage, shrinkage, or physical inventory counts</li>
                        <li><strong>ğŸ“¥ Purchases tab</strong> - Record new inventory from suppliers (creates purchase orders)</li>
                    </ul>
                </div>
            </div>
            
            <!-- Manual Adjustment Form -->
            <div id="adjustInventoryForm" style="display: none; margin-top: 20px; background: #fff8e1; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #f39c12;">
                <h3>ğŸ“ Manual Inventory Adjustment</h3>
                <p style="color: #666; margin-bottom: 15px;">Use this for physical counts, damaged goods, shrinkage, etc.</p>
                <form onsubmit="submitInventoryAdjustment(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Item * <small style="color: #888;">(click to search)</small></label>
                            <input type="text" id="adjustItemDisplay" placeholder="ğŸ” Click to select item..." 
                                   onclick="openItemPickerForAdjustment()" readonly
                                   style="cursor: pointer; background: #fff;">
                            <input type="hidden" id="adjustItem" required>
                        </div>
                        <div class="form-group">
                            <label>Current Quantity</label>
                            <input type="number" id="adjustCurrentQty" readonly style="background: #f0f0f0;">
                        </div>
                        <div class="form-group">
                            <label>Adjustment (+/-) *</label>
                            <input type="number" id="adjustQuantity" placeholder="e.g., -5 or +10" required oninput="updateAdjustNewQty()">
                            <small style="color: #666;">Use negative for decrease, positive for increase</small>
                        </div>
                        <div class="form-group">
                            <label>New Quantity</label>
                            <input type="number" id="adjustNewQty" readonly style="background: #e8f5e9;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Reason *</label>
                        <input type="text" id="adjustReasonDisplay" placeholder="ğŸ” Click to select reason..." 
                               onclick="openReasonPicker()" readonly
                               style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="adjustReason" required>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="adjustNotes" rows="2" placeholder="Additional details..."></textarea>
                    </div>
                    <button type="submit" class="btn">ğŸ’¾ Save Adjustment</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAdjustInventoryForm()">Cancel</button>
                </form>
            </div>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;">ğŸ” Filter Inventory</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-inventory')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-inventory-toggle">â–¶ Show</span>
                    </button>
                </div>
                <div id="filter-panel-inventory" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Search SKU/Description</label>
                        <input type="text" id="filterInventorySearch" placeholder="ğŸ” Click to search..." onkeyup="filterInventory()" onclick="openItemPickerForFilter(this)" readonly style="cursor: pointer; background: #fff;">
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <select id="filterInventorySupplier" onchange="filterInventory()">
                            <option value="">All Suppliers</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stock Status</label>
                        <select id="filterInventoryStock" onchange="filterInventory()">
                            <option value="">All Items</option>
                            <option value="negative">ğŸš¨ Negative</option>
                            <option value="out">ğŸ”´ Out of Stock</option>
                            <option value="low">ğŸŸ¡ Low Stock</option>
                            <option value="ok">ğŸŸ¢ In Stock</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearInventoryFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="inventoryTable"></div>
        </div>
        
        <!-- PRICE SIMULATOR TAB -->
        <div id="pricesim" class="card">
            <h2>ğŸ¯ Pricing Workbench</h2>
            <div class="status" id="pricesimStatus"></div>
            
            <!-- Revenue Impact Calculator - MOVED TO TOP -->
            <div class="section-card accent-theme" style="background: var(--primary-light, #e3f2fd);">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleSection('revenueCalcContent')">
                    <h3 style="margin: 0; color: var(--primary, #667eea);">ğŸ’° Revenue Impact Calculator</h3>
                    <span id="revenueCalcContent-toggle" style="font-size: 14px; color: #666;">â–¼ Hide</span>
                </div>
                <div id="revenueCalcContent" style="margin-top: 15px;">
                    <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">See how a price increase affects your profit on a sample sale amount.</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="form-group" style="margin: 0;">
                            <label>ğŸ• Sample Sale Amount</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span style="font-size: 18px; font-weight: bold;">$</span>
                                <input type="number" id="revCalcSaleAmount" value="100" min="1" step="1" style="width: 100px;" oninput="updateRevenueCalc()">
                            </div>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>ğŸ“ˆ Price Increase %</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="revCalcPercent" min="0" max="25" value="10" step="0.5" style="flex: 1;" oninput="updateRevenueCalc()">
                                <span id="revCalcPercentLabel" style="font-weight: bold; color: var(--primary, #667eea); min-width: 45px;">10%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="background: #fff; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #e0e0e0;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">BEFORE Increase</div>
                            <div id="revCalcBefore" style="font-size: 32px; font-weight: bold; color: #666;">$100.00</div>
                            <div style="font-size: 12px; color: #999;">Your Sale</div>
                        </div>
                        <div style="background: #fff; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #e0e0e0;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">AFTER Increase</div>
                            <div id="revCalcAfter" style="font-size: 32px; font-weight: bold; color: #2e7d32;">$110.00</div>
                            <div style="font-size: 12px; color: #999;">New Sale Value</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4caf50, #2e7d32); padding: 20px; border-radius: 12px; text-align: center; color: white;">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">EXTRA PROFIT</div>
                            <div id="revCalcProfit" style="font-size: 32px; font-weight: bold;">+$10.00</div>
                            <div style="font-size: 12px; opacity: 0.9;">Per Sale</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #c0c0c0;">
                        <h4 style="margin: 0 0 10px 0; color: var(--primary, #667eea);">ğŸ“Š Projected Impact</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                            <div>
                                <div style="color: #666; font-size: 13px;">10 Sales/Week</div>
                                <div id="revCalc10Sales" style="font-size: 20px; font-weight: bold; color: #2e7d32;">+$100/week</div>
                            </div>
                            <div>
                                <div style="color: #666; font-size: 13px;">Monthly (40 sales)</div>
                                <div id="revCalcMonthly" style="font-size: 20px; font-weight: bold; color: #2e7d32;">+$400/month</div>
                            </div>
                            <div>
                                <div style="color: #666; font-size: 13px;">Yearly (520 sales)</div>
                                <div id="revCalcYearly" style="font-size: 20px; font-weight: bold; color: #2e7d32;">+$5,200/year</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section-card accent-theme" style="background: linear-gradient(135deg, #667eea15, #764ba215);">
                <h3 style="margin: 0 0 10px 0; color: #667eea;">ğŸ’¡ What You Can Do Here</h3>
                <p style="margin: 0; color: #555;">
                    <strong>ğŸ“¦ Existing Items:</strong> Adjust sell prices by % or flat amount, preview impact, then apply<br>
                    <strong>â• New Items:</strong> Add items from supplier catalog, enter cost, simulate different markups to find the right sell price
                </p>
            </div>
            
            <!-- ADD NEW ITEM SECTION -->
            <div class="section-card accent-theme" style="background: #fff3e0;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleSection('addNewItemContent')">
                    <h3 style="margin: 0; color: #e65100;">â• Add New Item from Supplier Catalog</h3>
                    <span id="addNewItemContent-toggle" style="font-size: 14px; color: #666;">â–¼ Hide</span>
                </div>
                <div id="addNewItemContent" style="margin-top: 15px;">
                <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">Enter item details from your supplier's catalog. Set the markup % to calculate a sell price, then add to simulation to compare.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Supplier *</label>
                        <select id="newSimSupplier" required>
                            <option value="">Select Supplier</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>SKU / UPC</label>
                        <input type="text" id="newSimSKU" placeholder="e.g., 41633009999">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Description *</label>
                        <input type="text" id="newSimDescription" placeholder="e.g., Cheese Puffs, 12ct" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Package Cost *</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span>$</span>
                            <input type="number" id="newSimPackageCost" step="0.01" min="0" placeholder="18.50" oninput="calcNewSimUnitCost()">
                        </div>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Units/Package *</label>
                        <input type="number" id="newSimUnitsPerPkg" step="1" min="1" value="1" placeholder="12" oninput="calcNewSimUnitCost()">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Unit Cost</label>
                        <input type="text" id="newSimUnitCost" readonly style="background: #e0e0e0; font-weight: bold;" value="$0.00">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Markup %</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number" id="newSimMarkup" value="30" min="0" max="500" step="1" style="width: 70px;" oninput="calcNewSimSellPrice()">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Sell Price</label>
                        <input type="text" id="newSimSellPrice" readonly style="background: #c8e6c9; font-weight: bold; color: #2e7d32;" value="$0.00">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" class="btn" onclick="addNewItemToSimulation()" style="background: #ff9800;">
                        â• Add to Simulation
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearNewSimForm()">
                        ğŸ—‘ï¸ Clear Form
                    </button>
                </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="section-card accent-theme" style="background: #f8f9fa;">
                <h3 style="margin: 0 0 15px 0;">ğŸ” Filter Existing Items</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Search SKU/Description</label>
                        <input type="text" id="pricesimSearch" placeholder="ğŸ” Click to search..." onkeyup="filterPriceSimItems()" onclick="openItemPickerForFilter(this)" readonly style="cursor: pointer; background: #fff;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Supplier</label>
                        <select id="pricesimSupplier" onchange="filterPriceSimItems()">
                            <option value="">All Suppliers</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Stock Status</label>
                        <select id="pricesimStock" onchange="filterPriceSimItems()">
                            <option value="">All Items</option>
                            <option value="instock">In Stock Only</option>
                            <option value="low">Low Stock</option>
                            <option value="out">Out of Stock</option>
                            <option value="new">ğŸ†• New (Simulated Only)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Price Adjustment Controls -->
            <div class="section-card accent-theme" style="background: #e8f5e9;">
                <h3 style="margin: 0 0 15px 0; color: #2e7d32;">ğŸ“ˆ Bulk Price Adjustment (Existing Items)</h3>
                <div style="display: flex; gap: 20px; align-items: end; flex-wrap: wrap;">
                    <div class="form-group" style="margin: 0; min-width: 200px;">
                        <label>Increase by Percentage</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="pricesimPercent" value="10" min="0" max="50" step="0.5" style="flex: 1;" oninput="updatePercentLabel(); clearFlatAmount()">
                            <span id="pricesimPercentLabel" style="font-weight: bold; color: #2e7d32; min-width: 50px; text-align: right;">10%</span>
                        </div>
                    </div>
                    <div style="color: #666; font-size: 14px; padding-bottom: 8px;">â€” OR â€”</div>
                    <div class="form-group" style="margin: 0;">
                        <label>Increase by Flat Amount</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="font-size: 18px; font-weight: bold;">$</span>
                            <input type="number" id="pricesimFlat" value="0" min="0" step="0.01" style="width: 80px;" oninput="clearPercentAmount()">
                        </div>
                    </div>
                    <button class="btn" onclick="previewPriceChanges()" style="height: 42px;">
                        ğŸ“Š Preview Changes
                    </button>
                </div>
            </div>
            
            <!-- Impact Summary Cards -->
            <div id="pricesimSummary" style="display: none; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                    <div style="background: #667eea; color: white; padding: 15px; border-radius: 12px; text-align: center; overflow: hidden;">
                        <div style="font-size: 12px; opacity: 0.9;">Selected Items</div>
                        <div id="simSelectedCount" style="font-size: 28px; font-weight: bold;">0</div>
                    </div>
                    <div style="background: #6c757d; color: white; padding: 15px; border-radius: 12px; text-align: center; overflow: hidden;">
                        <div style="font-size: 12px; opacity: 0.9;">Current Revenue</div>
                        <div id="simCurrentRevenue" style="font-size: 20px; font-weight: bold; word-break: break-all;">$0.00</div>
                    </div>
                    <div style="background: #28a745; color: white; padding: 15px; border-radius: 12px; text-align: center; overflow: hidden;">
                        <div style="font-size: 12px; opacity: 0.9;">New Revenue</div>
                        <div id="simNewRevenue" style="font-size: 20px; font-weight: bold; word-break: break-all;">$0.00</div>
                    </div>
                    <div style="background: #17a2b8; color: white; padding: 15px; border-radius: 12px; text-align: center; overflow: hidden;">
                        <div style="font-size: 12px; opacity: 0.9;">Revenue Increase</div>
                        <div id="simIncrease" style="font-size: 20px; font-weight: bold; word-break: break-all;">+$0.00</div>
                    </div>
                </div>
            </div>
            
            <!-- INVENTORY IMPACT - Simple info strip style -->
            <div id="pricesimInventoryImpact" style="display: none; margin-bottom: 20px; padding: 15px 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px;">ğŸ“¦</span>
                        <span style="font-weight: 600; color: #495057;">Inventory Impact:</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: #6c757d; text-transform: uppercase;">Current Value</div>
                            <div id="simCurrentInvValue" style="font-size: 16px; font-weight: bold; color: #495057;">$0.00</div>
                        </div>
                        <div style="font-size: 20px; color: #adb5bd;">â†’</div>
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: #6c757d; text-transform: uppercase;">New Value</div>
                            <div id="simNewInvValue" style="font-size: 16px; font-weight: bold; color: #495057;">$0.00</div>
                        </div>
                        <div style="font-size: 20px; color: #adb5bd;">=</div>
                        <div style="text-align: center; background: #d4edda; padding: 8px 15px; border-radius: 6px;">
                            <div style="font-size: 11px; color: #155724; text-transform: uppercase;">Extra Profit</div>
                            <div id="simInvProfit" style="font-size: 18px; font-weight: bold; color: #155724;">+$0.00</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Apply Button - MOVED BEFORE TABLE (#5) -->
            <div id="pricesimApplySection" class="section-card accent-theme" style="display: none; background: #fff3cd;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <strong style="font-size: 18px;">âš ï¸ Ready to Apply Changes?</strong>
                        <p style="margin: 5px 0 0 0; color: #666;">This will update the Unit Sell Price for all selected items in your database.</p>
                    </div>
                    <button class="btn" onclick="applyPriceChanges()" style="font-size: 16px; padding: 15px 30px;">
                        âœ… APPLY CHANGES TO <span id="applyCount">0</span> ITEMS
                    </button>
                </div>
            </div>
            
            <!-- Items Table -->
            <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="pricesimSelectAll" onchange="toggleAllPriceSimItems()" style="width: 18px; height: 18px;">
                    <strong>Select All Visible Items</strong>
                </label>
                <button class="btn" onclick="loadPriceSimItems()" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">ğŸ”„ Refresh Items</button>
            </div>
            
            <div id="pricesimTable" style="overflow-x: auto;"></div>
        </div>
        
        <!-- REPORTS TAB -->
        <div id="reports" class="card">
            <h2>ğŸ“ˆ Business Reports</h2>
            <div class="status" id="reportsStatus"></div>
            
            <p style="color: #666; margin-bottom: 20px;">Generate professional reports to analyze your business performance</p>
            
            <!-- Report Selection Buttons - Organized Grid -->
            <div class="report-grid">
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('dashboardReports')">
                        <h4>ğŸ“Š Dashboards</h4>
                        <span id="dashboardReports-toggle" class="report-toggle">â–¼</span>
                    </div>
                    <div id="dashboardReports" class="report-buttons">
                        <button class="btn report-btn" onclick="showReport('daily-dashboard')" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">ğŸ¯ Sales Dashboard</button>
                        <button class="btn report-btn" onclick="showReport('customer-dashboard')" style="background: linear-gradient(135deg, #2e7d32, #4caf50); color: white;">ğŸ‘¤ Customer Dashboard</button>
                        <button class="btn report-btn" onclick="showReport('supplier-dashboard')" style="background: linear-gradient(135deg, #1565c0, #42a5f5); color: white;">ğŸ­ Supplier Dashboard</button>
                    </div>
                </div>
                
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('salesReports')">
                        <h4>ğŸ“Š Sales Reports</h4>
                        <span id="salesReports-toggle" class="report-toggle">â–¼</span>
                    </div>
                    <div id="salesReports" class="report-buttons">
                        <button class="btn report-btn" onclick="showReport('sales-by-customer')">ğŸ‘¥ Sales by Customer</button>
                        <button class="btn report-btn" onclick="showReport('sales-order-detail')">ğŸ“‹ Sales Order Detail</button>
                        <button class="btn report-btn" onclick="showReport('sales-by-product')">ğŸ“¦ Sales by Item</button>
                    </div>
                </div>
                
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('purchaseReports')">
                        <h4>ğŸ›’ Purchase Reports</h4>
                        <span id="purchaseReports-toggle" class="report-toggle">â–¼</span>
                    </div>
                    <div id="purchaseReports" class="report-buttons">
                        <button class="btn report-btn" onclick="showReport('purchase-order-detail')">ğŸ“‹ Purchase Order Detail</button>
                        <button class="btn report-btn" onclick="showReport('purchase-by-supplier')">ğŸ­ Purchase by Supplier</button>
                    </div>
                </div>
                
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('inventoryReports')">
                        <h4>ğŸ“¦ Inventory Reports</h4>
                        <span id="inventoryReports-toggle" class="report-toggle">â–¼</span>
                    </div>
                    <div id="inventoryReports" class="report-buttons">
                        <button class="btn report-btn" onclick="showReport('simple-inventory')">ğŸ“‹ Inventory List</button>
                        <button class="btn report-btn" onclick="showReport('inventory-turnover')">ğŸ”„ Inventory Turnover</button>
                        <button class="btn report-btn" onclick="showReport('gross-margin')">ğŸ’° Gross Margin</button>
                        <button class="btn report-btn" onclick="showReport('inventory-adjustments')">ğŸ“ Adjustment History</button>
                    </div>
                </div>
                
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('financialReports')">
                        <h4>ğŸ’µ Financial Reports</h4>
                        <span id="financialReports-toggle" class="report-toggle">â–¼</span>
                    </div>
                    <div id="financialReports" class="report-buttons">
                        <button class="btn report-btn report-btn-green" onclick="showReport('accounts-receivable')">ğŸ’µ Accounts Receivable</button>
                        <button class="btn report-btn report-btn-red" onclick="showReport('accounts-payable')">ğŸ’¸ Accounts Payable</button>
                    </div>
                </div>
                
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('taxReports')">
                        <h4>ğŸ§¾ Tax & Annual Reports</h4>
                        <span id="taxReports-toggle" class="report-toggle">â–¼</span>
                    </div>
                    <div id="taxReports" class="report-buttons">
                        <button class="btn report-btn" onclick="showReport('profit-loss')">ğŸ“Š Profit & Loss Statement</button>
                        <button class="btn report-btn" onclick="showReport('annual-sales-summary')">ğŸ“ˆ Annual Sales Summary</button>
                        <button class="btn report-btn" onclick="showReport('annual-purchase-summary')">ğŸ“‰ Annual Purchase Summary</button>
                        <button class="btn report-btn" onclick="showReport('inventory-valuation')">ğŸ’° Inventory Valuation</button>
                        <button class="btn report-btn" onclick="showReport('cash-flow-summary')">ğŸ’µ Cash Flow Summary</button>
                    </div>
                </div>
            </div>
            
            <!-- Report Container -->
            <div id="reportContainer"></div>
        </div>
    </div>

    <!-- How-To Guide Modal -->
    <div id="howToGuideModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto; padding: 20px 0;">
        <div style="max-width: 900px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); position: relative; max-height: calc(100vh - 40px); display: flex; flex-direction: column;">
            <!-- Header -->
            <div id="howToGuideHeader" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0 0 5px 0; font-size: 28px;">ğŸ“š Nowak Distributing ERP - How-To Guide</h2>
                    <p style="margin: 0; opacity: 0.95; font-size: 14px;">Complete instructions for using the system</p>
                </div>
                <button onclick="closeHowToGuide()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">Ã—</button>
            </div>

            <!-- Tab Navigation -->
            <div style="display: flex; gap: 0; border-bottom: 2px solid #e0e0e0; background: #f8f9fa; padding: 0 20px; overflow-x: auto;">
                <button class="guide-tab active" onclick="showGuideSection('getting-started')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                    ğŸš€ Getting Started
                </button>
                <button class="guide-tab" onclick="showGuideSection('suppliers')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                    ğŸ­ Suppliers
                </button>
                <button class="guide-tab" onclick="showGuideSection('items')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                    ğŸ“¦ Items
                </button>
                <button class="guide-tab" onclick="showGuideSection('customers')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                    ğŸ‘¥ Customers
                </button>
                <button class="guide-tab" onclick="showGuideSection('orders')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                    ğŸ“ Orders
                </button>
                <button class="guide-tab" onclick="showGuideSection('advanced')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                    âš¡ Advanced
                </button>
            </div>

            <!-- Content -->
            <div style="padding: 30px; max-height: 600px; overflow-y: auto;">
                
                <!-- Getting Started Section -->
                <div id="guide-getting-started" class="guide-section">
                    <h3 style="color: #667eea; margin-top: 0;">ğŸš€ Getting Started</h3>
                    
                    <div style="background: #f0f7ff; border-left: 4px solid #667eea; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <strong>Welcome to Nowak Distributing ERP!</strong><br>
                        This system helps you manage suppliers, inventory, customers, and orders all in one place.
                    </div>

                    <h4>ğŸ  Home / Landing Page</h4>
                    <ul style="line-height: 1.8;">
                        <li>The <strong>Home tab</strong> is your dashboard - click any card to navigate to that section</li>
                        <li>Each card shows a different area of the system</li>
                        <li>Perfect for showing to customers (no data visible)</li>
                    </ul>

                    <h4>ğŸ¨ Choosing a Theme</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Settings</strong> tab</li>
                        <li>Click the <strong>Theme</strong> box</li>
                        <li>Browse 280+ themes (sports teams, colors, etc.)</li>
                        <li>Click any theme to apply it instantly</li>
                    </ol>

                    <h4>ğŸ“Š Navigation Tips</h4>
                    <ul style="line-height: 1.8;">
                        <li>Use the <strong>tabs at the top</strong> to switch between sections</li>
                        <li>Click <strong>ğŸ”™ Back button</strong> (bottom-left) to return to previous page</li>
                        <li>The active tab is highlighted</li>
                    </ul>
                </div>

                <!-- Suppliers Section -->
                <div id="guide-suppliers" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;">ğŸ­ Managing Suppliers</h3>

                    <h4>â• Adding a New Supplier</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Suppliers</strong> tab</li>
                        <li>Click <strong>â• Add Supplier</strong></li>
                        <li>Fill in:
                            <ul>
                                <li><strong>Supplier Name</strong> (required)</li>
                                <li><strong>Contact Name</strong></li>
                                <li><strong>Email & Phone</strong></li>
                                <li><strong>Address</strong></li>
                                <li><strong>Payment Terms</strong> (Net 30, Net 60, etc.)</li>
                            </ul>
                        </li>
                        <li>Click <strong>ğŸ’¾ Save</strong></li>
                    </ol>

                    <h4>âœï¸ Editing a Supplier</h4>
                    <ol style="line-height: 1.8;">
                        <li>Find the supplier in the list</li>
                        <li>Click the <strong>âœï¸ Edit</strong> button</li>
                        <li>Update any information</li>
                        <li>Click <strong>ğŸ’¾ Save Changes</strong></li>
                    </ol>

                    <h4>ğŸ—‘ï¸ Deleting a Supplier</h4>
                    <ol style="line-height: 1.8;">
                        <li>Click <strong>ğŸ—‘ï¸ Delete</strong> on the supplier</li>
                        <li>Confirm deletion</li>
                        <li><strong>Warning:</strong> You cannot delete suppliers with existing items or orders</li>
                    </ol>

                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-top: 20px; border-radius: 4px;">
                        <strong>ğŸ’¡ Tip:</strong> Keep supplier information up-to-date for accurate purchase orders and invoicing.
                    </div>
                </div>

                <!-- Items Section -->
                <div id="guide-items" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;">ğŸ“¦ Managing Items</h3>

                    <h4>â• Adding a New Item</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Items</strong> tab</li>
                        <li>Click <strong>â• Add Item</strong></li>
                        <li>Fill in:
                            <ul>
                                <li><strong>SKU</strong> - Your product code</li>
                                <li><strong>Description</strong> - What is it?</li>
                                <li><strong>Supplier</strong> - Who do you buy from?</li>
                                <li><strong>Cost</strong> - What you pay</li>
                                <li><strong>Sell Price</strong> - What you charge</li>
                                <li><strong>Qty On Hand</strong> - Current stock</li>
                                <li><strong>Reorder Point</strong> - When to reorder</li>
                            </ul>
                        </li>
                        <li>Click <strong>ğŸ’¾ Save</strong></li>
                    </ol>

                    <h4>ğŸ“¥ Bulk Import Items (from Excel)</h4>
                    <ol style="line-height: 1.8;">
                        <li>Click <strong>ğŸ“¥ Download Items</strong> button</li>
                        <li>Save the PDF, then convert to Excel (use ilovepdf.com)</li>
                        <li>Edit prices, quantities, etc. in Excel</li>
                        <li>Click <strong>ğŸ“¤ Upload Items</strong></li>
                        <li>Select your Excel file</li>
                        <li>Choose mode: <strong>Update Existing + Add New</strong> OR <strong>Full Refresh</strong></li>
                        <li>Click <strong>ğŸ” Preview Changes</strong></li>
                        <li>Review what will change</li>
                        <li>Click <strong>âœ… Commit Changes</strong> or <strong>âŒ Cancel</strong></li>
                    </ol>

                    <h4>ğŸ” Filtering Items</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Search:</strong> Type SKU or description</li>
                        <li><strong>Supplier:</strong> Filter by supplier</li>
                        <li><strong>Stock Status:</strong> Low Stock, Negative, On Order, Needs Reorder</li>
                        <li><strong>Active/Archived:</strong> Show only active items</li>
                    </ul>

                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-top: 20px; border-radius: 4px;">
                        <strong>ğŸ’¡ Tip:</strong> Use the bulk import feature for price updates or inventory counts!
                    </div>
                </div>

                <!-- Customers Section -->
                <div id="guide-customers" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;">ğŸ‘¥ Managing Customers</h3>

                    <h4>â• Adding a New Customer</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Customers</strong> tab</li>
                        <li>Click <strong>â• Add Customer</strong></li>
                        <li>Fill in:
                            <ul>
                                <li><strong>Customer Name</strong></li>
                                <li><strong>Contact Name</strong></li>
                                <li><strong>Email & Phone</strong></li>
                                <li><strong>Billing Address</strong></li>
                                <li><strong>Shipping Address</strong> (if different)</li>
                                <li><strong>Payment Terms</strong></li>
                            </ul>
                        </li>
                        <li>Click <strong>ğŸ’¾ Save</strong></li>
                    </ol>

                    <h4>âœï¸ Editing a Customer</h4>
                    <ol style="line-height: 1.8;">
                        <li>Find customer in the list</li>
                        <li>Click <strong>âœï¸ Edit</strong></li>
                        <li>Update information</li>
                        <li>Click <strong>ğŸ’¾ Save Changes</strong></li>
                    </ol>

                    <div style="background: #f0f7ff; border-left: 4px solid #667eea; padding: 15px; margin-top: 20px; border-radius: 4px;">
                        <strong>ğŸ“ Note:</strong> Customer information is used for sales orders and invoices.
                    </div>
                </div>

                <!-- Orders Section -->
                <div id="guide-orders" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;">ğŸ“ Managing Orders</h3>

                    <h4>ğŸ“¥ Creating a Purchase Order</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Create PO</strong> tab</li>
                        <li>Select <strong>Supplier</strong></li>
                        <li>Click <strong>â• Add Line Item</strong></li>
                        <li>Select <strong>Item</strong> and enter <strong>Quantity</strong></li>
                        <li>Add more line items as needed</li>
                        <li>Review <strong>Total Amount</strong></li>
                        <li>Click <strong>ğŸ’¾ Save Purchase Order</strong></li>
                    </ol>

                    <h4>ğŸ’° Creating a Sales Order</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Sales</strong> tab</li>
                        <li>Click <strong>â• Create Sales Order</strong></li>
                        <li>Select <strong>Customer</strong></li>
                        <li>Add line items (items and quantities)</li>
                        <li>Review total</li>
                        <li>Click <strong>ğŸ’¾ Save</strong></li>
                    </ol>

                    <h4>âœ… Receiving a Purchase Order</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Purchases</strong> tab</li>
                        <li>Find the PO</li>
                        <li>Click <strong>ğŸ‘ï¸ View</strong></li>
                        <li>Change status to <strong>Received</strong></li>
                        <li>Inventory automatically updates!</li>
                    </ol>

                    <h4>ğŸš« Voiding an Order</h4>
                    <ol style="line-height: 1.8;">
                        <li>Open the order</li>
                        <li>Change status to <strong>Voided</strong></li>
                        <li>Inventory reverses automatically</li>
                    </ol>

                    <h4>ğŸ–¨ï¸ Printing Orders</h4>
                    <ul style="line-height: 1.8;">
                        <li>Open any order</li>
                        <li>Click <strong>ğŸ–¨ï¸ Print</strong></li>
                        <li>Print matches your selected theme!</li>
                    </ul>

                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-top: 20px; border-radius: 4px;">
                        <strong>ğŸ’¡ Tip:</strong> Status changes automatically update inventory counts.
                    </div>
                </div>

                <!-- Advanced Section -->
                <div id="guide-advanced" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;">âš¡ Advanced Features</h3>

                    <h4>ğŸ“Š Inventory Management</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Manual Adjustments:</strong> Add/remove inventory manually</li>
                        <li><strong>Audit Trail:</strong> See all inventory changes with dates</li>
                        <li><strong>Low Stock Alerts:</strong> Filter by items below reorder point</li>
                    </ul>

                    <h4>ğŸ¯ Price Simulator</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Price Sim</strong> tab</li>
                        <li>Select an item</li>
                        <li>Try different sell prices</li>
                        <li>See profit margin and revenue impact</li>
                        <li>Apply new price if desired</li>
                    </ol>

                    <h4>ğŸ“ˆ Reports</h4>
                    <p><strong>Available Reports:</strong></p>
                    <ul style="line-height: 1.8;">
                        <li><strong>Low Stock Report:</strong> Items below reorder point</li>
                        <li><strong>Supplier Report:</strong> All items by supplier</li>
                        <li><strong>Customer Report:</strong> Sales by customer</li>
                        <li><strong>Inventory Value:</strong> Total inventory cost</li>
                    </ul>

                    <h4>ğŸ’¾ Backup & Data Access</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Settings</strong> tab</li>
                        <li>Click <strong>ğŸ“¥ Open Google Sheet</strong></li>
                        <li>Access raw data directly</li>
                        <li>Make backups as needed</li>
                    </ol>

                    <h4>ğŸ¨ Customization</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>280+ Themes:</strong> NFL, NHL, MLB teams + colors</li>
                        <li><strong>Print Templates:</strong> Auto-match theme colors</li>
                        <li><strong>Landing Page:</strong> Customer-safe first screen</li>
                    </ul>

                    <div style="background: #d1f2eb; border-left: 4px solid #28a745; padding: 15px; margin-top: 20px; border-radius: 4px;">
                        <strong>âœ… Pro Tip:</strong> Regularly backup your Google Sheet and use the bulk import for major updates!
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <div style="background: #f8f9fa; padding: 20px 30px; border-radius: 0 0 16px 16px; border-top: 1px solid #e0e0e0; text-align: center; color: #666;">
                <p style="margin: 0; font-size: 14px;">Need more help? Contact support or refer to the Google Sheet for raw data access.</p>
            </div>
        </div>
    </div>

    <!-- Upload Items Modal -->
    <div id="uploadItemsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto; padding: 20px 0;">
        <div style="max-width: 700px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); padding: 30px; max-height: calc(100vh - 40px); overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; color: #667eea;">ğŸ“¤ Upload Items - Bulk Import</h2>
                <button onclick="closeUploadItemsModal()" style="background: #f44336; border: none; color: white; font-size: 24px; width: 35px; height: 35px; border-radius: 6px; cursor: pointer;">Ã—</button>
            </div>

            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                <strong>âš ï¸ Important Instructions:</strong>
                <ul style="margin: 10px 0 0 0; padding-left: 20px; line-height: 1.7;">
                    <li><strong>DO NOT modify the Item_ID column</strong> - This is your primary key</li>
                    <li>You can edit SKU, Description, Supplier_ID, Cost, Sell_Price, quantities, Status</li>
                    <li>To add new items, leave Item_ID blank or type "NEW"</li>
                    <li><strong>BACKUP RECOMMENDED:</strong> Download a copy before uploading</li>
                    <li>Accepted formats: Excel (.xlsx, .xls) or CSV (.csv)</li>
                </ul>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Select File:</label>
                <input type="file" id="uploadItemsFile" accept=".xlsx,.xls,.csv" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
            </div>

            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 12px; font-weight: 600;">Upload Mode:</label>
                
                <label style="display: block; padding: 15px; border: 2px solid #28a745; border-radius: 8px; margin-bottom: 10px; cursor: pointer; background: #f0f7ff;">
                    <input type="radio" name="uploadMode" value="update-add" checked style="margin-right: 10px;">
                    <strong style="color: #28a745;">âœ… Update Existing + Add New (Recommended)</strong>
                    <div style="margin-left: 28px; margin-top: 5px; font-size: 13px; color: #666;">
                        â€¢ Matches on Item_ID<br>
                        â€¢ Updates existing items<br>
                        â€¢ Adds new items if Item_ID is blank or "NEW"<br>
                        â€¢ Safe - does not delete anything
                    </div>
                </label>

                <label style="display: block; padding: 15px; border: 2px solid #f44336; border-radius: 8px; cursor: pointer; background: #ffebee;">
                    <input type="radio" name="uploadMode" value="full-refresh" style="margin-right: 10px;">
                    <strong style="color: #f44336;">âš ï¸ Full Refresh (DANGER)</strong>
                    <div style="margin-left: 28px; margin-top: 5px; font-size: 13px; color: #666;">
                        â€¢ <strong>DELETES ALL existing items</strong><br>
                        â€¢ Replaces with uploaded file<br>
                        â€¢ Requires 3 confirmations<br>
                        â€¢ Use with extreme caution!
                    </div>
                </label>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn" onclick="previewItemsUpload()" style="background: #17a2b8; width: 100%; padding: 15px; font-size: 16px;">
                    ğŸ” Preview Changes
                </button>
                <button class="btn btn-secondary" onclick="closeUploadItemsModal()" style="width: 100%; margin-top: 10px;">
                    Cancel
                </button>
            </div>

            <div id="uploadItemsPreview" style="margin-top: 20px; display: none;">
                <h3 style="color: #667eea; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0;">ğŸ“Š Preview Changes</h3>
                <div id="uploadItemsSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin: 15px 0;"></div>
                <div id="uploadItemsPreviewContent" style="max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 12px; border-radius: 8px; border: 2px solid #667eea; font-size: 13px;"></div>
                
                <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <strong>âš ï¸ Review carefully before committing!</strong> Once you click "Commit Changes", the database will be updated.
                </div>
                
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn" onclick="commitItemsUpload()" style="background: #28a745; flex: 1; padding: 12px; font-size: 15px;">
                        âœ… Commit Changes
                    </button>
                    <button class="btn btn-secondary" onclick="cancelPreview()" style="flex: 1; padding: 12px; font-size: 15px;">
                        âŒ Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let API_URL = localStorage.getItem('apiUrl') || 'https://script.google.com/macros/s/AKfycbwUYTRxFdSS78WZ8gK44580wLDO_C7uUozj_3ruyiNbJHZi_pH7tUDC-ojszeddEwX8Dg/exec';
        let cachedSuppliers = [];
        let cachedItems = [];
        let cachedCustomers = [];
        
        // ==================== BUTTON DEBOUNCE SYSTEM ====================
        // Prevents double-clicks/taps from submitting forms twice
        let buttonDebounceMap = new Map();
        
        function debounceButton(buttonElement, duration = 2000) {
            if (!buttonElement) return false;
            
            const buttonId = buttonElement.id || buttonElement.outerHTML.substring(0, 100);
            const now = Date.now();
            const lastClick = buttonDebounceMap.get(buttonId) || 0;
            
            if (now - lastClick < duration) {
                console.log('â¸ï¸ Button debounced - click ignored');
                return false; // Too soon, ignore click
            }
            
            buttonDebounceMap.set(buttonId, now);
            
            // Visually disable button
            buttonElement.disabled = true;
            buttonElement.style.opacity = '0.6';
            buttonElement.style.cursor = 'not-allowed';
            
            // Re-enable after duration
            setTimeout(() => {
                buttonElement.disabled = false;
                buttonElement.style.opacity = '';
                buttonElement.style.cursor = '';
            }, duration);
            
            return true; // Allow click
        }
        
        // Helper functions to lookup names from IDs
        function getCustomerName(customerId) {
            const customer = cachedCustomers.find(c => c.Customer_ID === customerId);
            return customer ? customer.Customer_Name : customerId;
        }
        
        function getSupplierName(supplierId) {
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            return supplier ? supplier.Supplier_Name : supplierId;
        }
        
        function getItemDescription(itemId) {
            const item = cachedItems.find(i => i.Item_ID === itemId);
            return item ? item.Item_Description : itemId;
        }

        window.addEventListener('DOMContentLoaded', () => {
            // Apply gradient for current theme
            applyThemeGradient();
            
            updateConfigStatus();
            loadInvoiceSettings();
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('poDate')) document.getElementById('poDate').value = today;
            if (document.getElementById('soDate')) document.getElementById('soDate').value = today;
            if (document.getElementById('createPODate')) document.getElementById('createPODate').value = today;
            
            // Restore report section visibility preferences
            restoreReportSections();
            
            // Restore settings section visibility preferences
            restoreSettingsSections();
            
            // AUTO-LOAD ALL DATA ON PAGE LOAD
            console.log('ğŸš€ Auto-loading all data from Google Sheets...');
            loadSuppliers();
            loadItems();
            loadCustomers();
            loadPurchases();
            loadSales();
            loadInventory();
            
            // Attach event listeners to the first Create PO line item
            const firstCreatePORow = document.querySelector('#createPOLineItems div.line-item-row');
            if (firstCreatePORow) {
                const itemSelect = firstCreatePORow.querySelector('.createpo-item');
                const qtyInput = firstCreatePORow.querySelector('.createpo-qty');
                
                if (itemSelect) {
                    itemSelect.addEventListener('change', function() {
                        updateCreatePOItemCost(this);
                    });
                }
                
                if (qtyInput) {
                    qtyInput.addEventListener('input', function() {
                        calculateCreatePOTotal();
                    });
                }
            }
            
            // Attach event listeners to the first hardcoded Sales Order line item
            const firstSORow = document.querySelector('#soLineItems .line-item-row');
            if (firstSORow) {
                console.log('Attaching listeners to first SO line item'); // DEBUG
                const itemSelect = firstSORow.querySelector('.so-item');
                const qtyInput = firstSORow.querySelector('.so-qty');
                const priceInput = firstSORow.querySelector('.so-price');
                const removeBtn = firstSORow.querySelector('.remove-btn');
                
                if (itemSelect) {
                    itemSelect.addEventListener('change', function() {
                        console.log('First row CHANGE EVENT FIRED!'); // DEBUG
                        updateSOItemInfo(this);
                    });
                }
                
                if (qtyInput) {
                    qtyInput.addEventListener('input', function() {
                        // Update stock info when quantity changes
                        const row = this.closest('.line-item-row');
                        const itemSelect = row.querySelector('.so-item');
                        if (itemSelect.value) {
                            updateSOItemInfo(itemSelect);
                        }
                        calculateSOTotal();
                    });
                }
                
                if (priceInput) {
                    priceInput.addEventListener('input', function() {
                        calculateSOTotal();
                    });
                }
                
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        removeLineItem(this);
                        calculateSOTotal();
                    });
                }
                console.log('First SO row listeners attached!'); // DEBUG
            }
            
            // Attach event listeners to the first hardcoded Purchase Order line item
            const firstPORow = document.querySelector('#poLineItems .line-item-row');
            if (firstPORow) {
                console.log('Attaching listeners to first PO line item'); // DEBUG
                const itemSelect = firstPORow.querySelector('.po-item');
                const qtyInput = firstPORow.querySelector('.po-qty');
                const costInput = firstPORow.querySelector('.po-cost');
                const removeBtn = firstPORow.querySelector('.remove-btn');
                
                if (itemSelect) {
                    itemSelect.addEventListener('change', function() {
                        console.log('First PO row CHANGE EVENT FIRED!'); // DEBUG
                        updatePOItemInfo(this);
                    });
                }
                
                if (qtyInput) {
                    qtyInput.addEventListener('input', function() {
                        calculatePOTotal();
                    });
                }
                
                if (costInput) {
                    costInput.addEventListener('input', function() {
                        calculatePOTotal();
                    });
                }
                
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        removeLineItem(this);
                        calculatePOTotal();
                    });
                }
                console.log('First PO row listeners attached!'); // DEBUG
            }
            
            // Minimal pull-to-refresh prevention (only at very top)
            let lastTouchY = 0;
            
            document.body.addEventListener('touchstart', function(e) {
                if (e.touches.length !== 1) return;
                lastTouchY = e.touches[0].clientY;
            }, { passive: true });
            
            document.body.addEventListener('touchmove', function(e) {
                const touchY = e.touches[0].clientY;
                const touchYDelta = touchY - lastTouchY;
                lastTouchY = touchY;
                
                // Only prevent if at absolute top AND pulling down
                if (window.pageYOffset === 0 && touchYDelta > 0) {
                    e.preventDefault();
                }
            }, { passive: false });
        });

        // Navigation history for back button
        let navigationHistory = ['suppliers'];
        
        function switchTab(tabName) {
            // Remove active class from all navigation cards
            document.querySelectorAll('.landing-nav-card').forEach(card => {
                card.classList.remove('active-nav-card');
                // Reset styling
                card.style.transform = 'scale(1)';
                card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
            });
            
            // Find and highlight the clicked navigation card
            document.querySelectorAll('.landing-nav-card').forEach(card => {
                if (card.onclick && card.onclick.toString().includes(`'${tabName}'`)) {
                    card.classList.add('active-nav-card');
                    card.style.transform = 'scale(1.05)';
                    card.style.boxShadow = '0 4px 16px rgba(0,0,0,0.3)';
                }
            });
            
            // Hide all content sections and show the selected one
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            const targetCard = document.getElementById(tabName);
            if (targetCard) {
                targetCard.classList.add('active');
            }
            
            // Add to history (avoid duplicates of current tab)
            if (navigationHistory[navigationHistory.length - 1] !== tabName) {
                navigationHistory.push(tabName);
                // Keep only last 20 tabs in history
                if (navigationHistory.length > 20) {
                    navigationHistory.shift();
                }
            }
            
            // Show/hide Back button based on history length
            const backBtn = document.getElementById('backBtn');
            if (navigationHistory.length > 1) {
                backBtn.style.display = 'block';
            } else {
                backBtn.style.display = 'none';
            }
            
            // Check if we need to restore PO form when switching to purchases
            if (tabName === 'purchases') {
                checkAndRestorePOForm();
            }
            
            // Load price sim items when switching to that tab
            if (tabName === 'pricesim') {
                loadPriceSimItems();
            }
            
            // Scroll to top when switching tabs
            window.scrollTo(0, 0);
        }
        
        function goBack() {
            // Remove current tab from history
            if (navigationHistory.length > 1) {
                navigationHistory.pop();
                const previousTab = navigationHistory[navigationHistory.length - 1];
                
                // Switch to previous tab
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                
                document.getElementById(previousTab).classList.add('active');
                
                // Highlight the correct tab button
                const tabButtons = document.querySelectorAll('.tabs .tab');
                tabButtons.forEach(btn => {
                    if (btn.textContent.toLowerCase().includes(previousTab.substring(0, 4))) {
                        btn.classList.add('active');
                    }
                });
                
                window.scrollTo(0, 0);
                
                // Check if we need to restore PO form state
                checkAndRestorePOForm();
            }
            
            // Hide Back button if only one tab in history
            const backBtn = document.getElementById('backBtn');
            if (navigationHistory.length <= 1) {
                backBtn.style.display = 'none';
            }
        }
        
        function checkAndRestorePOForm() {
            const savedState = localStorage.getItem('poFormState');
            if (savedState) {
                const state = JSON.parse(savedState);
                if (state.returnToPO) {
                    // Show a notification
                    const currentTab = document.querySelector('.card.active');
                    if (currentTab && currentTab.id === 'purchases') {
                        setTimeout(() => {
                            if (confirm('Resume your purchase order entry?')) {
                                showAddPurchaseForm();
                                
                                // Restore form fields
                                setTimeout(() => {
                                    if (state.supplier) document.getElementById('poSupplier').value = state.supplier;
                                    if (state.invoiceNumber) document.getElementById('poInvoiceNumber').value = state.invoiceNumber;
                                    if (state.purchaseDate) document.getElementById('poPurchaseDate').value = state.purchaseDate;
                                    if (state.dueDate) document.getElementById('poDueDate').value = state.dueDate;
                                    if (state.paymentTerms) document.getElementById('poPaymentTerms').value = state.paymentTerms;
                                    if (state.status) document.getElementById('poStatus').value = state.status;
                                    if (state.amountPaid) document.getElementById('poAmountPaid').value = state.amountPaid;
                                    if (state.notes) document.getElementById('poNotes').value = state.notes;
                                    
                                    // Reload supplier items
                                    if (state.supplier) {
                                        loadSupplierItems();
                                    }
                                    
                                    showStatus('purchaseStatus', 'âœ… Purchase order form restored! The new item should now be available in the dropdown.', 'success');
                                }, 200);
                            }
                            
                            // Clear saved state
                            localStorage.removeItem('poFormState');
                        }, 500);
                    }
                }
            }
        }
        
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // Toggle collapsible sections (Quick Guides, Entry Forms)
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId + '-toggle');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                if (toggle) toggle.textContent = 'â–¼ Hide';
            } else {
                section.style.display = 'none';
                if (toggle) toggle.textContent = 'â–¶ Show';
            }
        }
        
        // Toggle report category sections with localStorage persistence
        function toggleReportSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId + '-toggle');
            const category = section.parentElement;
            
            if (section.classList.contains('collapsed')) {
                // Show
                section.classList.remove('collapsed');
                category.classList.remove('collapsed');
                if (toggle) toggle.textContent = 'â–¼';
                localStorage.setItem('report_' + sectionId, 'visible');
            } else {
                // Hide
                section.classList.add('collapsed');
                category.classList.add('collapsed');
                if (toggle) toggle.textContent = 'â–¶';
                localStorage.setItem('report_' + sectionId, 'hidden');
            }
        }
        
        // Restore report section visibility on page load
        function restoreReportSections() {
            const sections = ['salesReports', 'purchaseReports', 'inventoryReports', 'financialReports'];
            sections.forEach(sectionId => {
                const state = localStorage.getItem('report_' + sectionId);
                if (state === 'hidden') {
                    const section = document.getElementById(sectionId);
                    const toggle = document.getElementById(sectionId + '-toggle');
                    const category = section?.parentElement;
                    if (section) {
                        section.classList.add('collapsed');
                        if (category) category.classList.add('collapsed');
                        if (toggle) toggle.textContent = 'â–¶';
                    }
                }
            });
        }
        
        // Toggle settings page sections with localStorage persistence
        function toggleSettingsSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId + '-toggle');
            
            if (section.style.display === 'none') {
                // Show
                section.style.display = 'block';
                if (toggle) toggle.textContent = 'â–¼ Hide';
                localStorage.setItem('settings_' + sectionId, 'visible');
            } else {
                // Hide
                section.style.display = 'none';
                if (toggle) toggle.textContent = 'â–¶ Show';
                localStorage.setItem('settings_' + sectionId, 'hidden');
            }
        }
        
        // Restore settings section visibility on page load
        function restoreSettingsSections() {
            const sections = ['themeSection', 'backupSection', 'invoiceSection', 'statusSection', 'apiSection'];
            sections.forEach(sectionId => {
                const state = localStorage.getItem('settings_' + sectionId);
                const section = document.getElementById(sectionId);
                const toggle = document.getElementById(sectionId + '-toggle');
                
                if (sectionId === 'apiSection') {
                    // API section hidden by default unless explicitly shown
                    if (state === 'visible') {
                        if (section) section.style.display = 'block';
                        if (toggle) toggle.textContent = 'â–¼ Hide';
                    }
                } else {
                    // Other sections shown by default unless explicitly hidden
                    if (state === 'hidden') {
                        if (section) section.style.display = 'none';
                        if (toggle) toggle.textContent = 'â–¶ Show';
                    }
                }
            });
        }
        
        // Show/hide back to top button based on scroll position
        window.addEventListener('scroll', function() {
            const backToTopBtn = document.getElementById('backToTopBtn');
            if (window.pageYOffset > 300) {
                backToTopBtn.style.display = 'block';
            } else {
                backToTopBtn.style.display = 'none';
            }
        });
        
        function goToAddItem() {
            // Switch to Items tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent.includes('Items')) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            document.getElementById('items').classList.add('active');
            
            // Open the Add Item form
            showAddItemForm();
            
            // Scroll to top of page
            window.scrollTo(0, 0);
        }
        
        function addNewItemFromPO() {
            // Get current supplier from PO form
            const currentSupplier = document.getElementById('poSupplier')?.value;
            
            if (!currentSupplier) {
                alert('Please select a supplier first before adding items');
                return;
            }
            
            // Save PO form state to localStorage for later restoration
            const poFormState = {
                supplier: currentSupplier,
                invoiceNumber: document.getElementById('poInvoiceNumber')?.value,
                purchaseDate: document.getElementById('poPurchaseDate')?.value,
                dueDate: document.getElementById('poDueDate')?.value,
                paymentTerms: document.getElementById('poPaymentTerms')?.value,
                status: document.getElementById('poStatus')?.value,
                amountPaid: document.getElementById('poAmountPaid')?.value,
                notes: document.getElementById('poNotes')?.value,
                returnToPO: true
            };
            localStorage.setItem('poFormState', JSON.stringify(poFormState));
            
            // Switch to Items tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent.includes('Items')) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            document.getElementById('items').classList.add('active');
            
            // Open Add Item form
            showAddItemForm();
            
            // Pre-select supplier if one was selected in PO
            setTimeout(() => {
                const supplierSelect = document.getElementById('itemSupplier');
                if (supplierSelect) {
                    supplierSelect.value = currentSupplier;
                }
            }, 100);
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            // Show helper message
            setTimeout(() => {
                showStatus('itemStatus', 'ğŸ’¡ After saving the item, click "â¬…ï¸ Back" to return to your purchase order', 'info');
            }, 200);
        }

        function updateConfigStatus() {
            const statusEl = document.getElementById('configStatusText');
            const apiInput = document.getElementById('apiUrl');
            
            if (API_URL) {
                apiInput.value = API_URL;
                statusEl.innerHTML = 'âœ… API configured and ready!';
                statusEl.style.color = '#2e7d32';
            } else {
                statusEl.innerHTML = 'âš ï¸ Not configured - enter API URL above';
                statusEl.style.color = '#f57c00';
            }
        }

        
        // Apply gradient for current theme (called on page load)
        function applyThemeGradient() {
            const themeColors = getThemeColors();
            const gradient = `linear-gradient(135deg, ${themeColors.primary} 0%, ${themeColors.accent} 100%)`;
            document.documentElement.style.setProperty('--theme-gradient', gradient);
            document.body.style.background = gradient;
        }
        
        function changeTheme() {
            const theme = document.getElementById('themeSelector').value;
            const body = document.body;
            
            // Remove all existing theme classes (ALL themes)
            body.classList.remove(
                // Classic themes
                'theme-purple', 'theme-ocean', 'theme-forest', 'theme-sunset', 'theme-dark', 'theme-crimson', 'theme-slate', 'theme-teal',
                // NFL Teams
                'theme-bills', 'theme-dolphins', 'theme-patriots', 'theme-jets',
                'theme-ravens', 'theme-bengals', 'theme-browns', 'theme-steelers',
                'theme-texans', 'theme-colts', 'theme-jaguars', 'theme-titans',
                'theme-broncos', 'theme-chiefs', 'theme-raiders', 'theme-chargers',
                'theme-cowboys', 'theme-giants', 'theme-eagles', 'theme-commanders',
                'theme-bears', 'theme-lions', 'theme-packers', 'theme-vikings',
                'theme-falcons', 'theme-panthers', 'theme-saints', 'theme-bucs',
                'theme-azcardinals', 'theme-rams', 'theme-niners', 'theme-seahawks',
                // MLB Teams
                'theme-orioles', 'theme-redsox', 'theme-yankees', 'theme-rays', 'theme-bluejays',
                'theme-whitesox', 'theme-guardians', 'theme-tigers', 'theme-royals', 'theme-twins',
                'theme-astros', 'theme-angels', 'theme-athletics', 'theme-mariners', 'theme-rangers',
                'theme-braves', 'theme-marlins', 'theme-mets', 'theme-phillies', 'theme-nationals',
                'theme-cubs', 'theme-reds', 'theme-brewers', 'theme-pirates', 'theme-stlcardinals',
                'theme-dbacks', 'theme-rockies', 'theme-dodgers', 'theme-padres', 'theme-sfgiants',
                // Chicago extras
                'theme-bulls', 'theme-blackhawks',
                // NHL Teams
                'theme-ducks', 'theme-coyotes', 'theme-bruins', 'theme-sabres', 'theme-flames',
                'theme-hurricanes', 'theme-avalanche', 'theme-bluejackets', 'theme-stars', 'theme-redwings',
                'theme-oilers', 'theme-flapanthers', 'theme-kings', 'theme-wild', 'theme-canadiens',
                'theme-predators', 'theme-devils', 'theme-islanders', 'theme-nhlrangers', 'theme-senators',
                'theme-flyers', 'theme-penguins', 'theme-sharks', 'theme-kraken', 'theme-stlblues',
                'theme-lightning', 'theme-mapleleafs', 'theme-canucks', 'theme-goldenknights',
                'theme-capitals', 'theme-nhljets',
                // NBA Teams
                'theme-hawks', 'theme-celtics', 'theme-nets', 'theme-hornets', 'theme-cavs',
                'theme-mavs', 'theme-nuggets', 'theme-pistons', 'theme-warriors', 'theme-rockets',
                'theme-pacers', 'theme-clippers', 'theme-lakers', 'theme-grizzlies', 'theme-heat',
                'theme-bucks', 'theme-twolves', 'theme-pelicans', 'theme-knicks', 'theme-thunder',
                'theme-magic', 'theme-sixers', 'theme-suns', 'theme-blazers', 'theme-nbakings',
                'theme-spurs', 'theme-raptors', 'theme-jazz', 'theme-wizards',
                // College Teams
                'theme-alabama', 'theme-arkansas', 'theme-auburn', 'theme-clemson', 'theme-florida',
                'theme-fsu', 'theme-georgia', 'theme-lsu', 'theme-michigan', 'theme-michiganst',
                'theme-ohiostate', 'theme-oklahoma', 'theme-okstate', 'theme-oregon', 'theme-oregonst',
                'theme-pennstate', 'theme-tennessee', 'theme-texas', 'theme-texasam', 'theme-usc',
                'theme-ucla', 'theme-notredame', 'theme-wisconsin', 'theme-nebraska', 'theme-miami', 'theme-byu',
                // Fast Food
                'theme-mcdonalds', 'theme-burgerking', 'theme-wendys', 'theme-tacobell', 'theme-kfc',
                'theme-subway', 'theme-pizzahut', 'theme-chickfila', 'theme-dunkin', 'theme-dominos',
                'theme-sonic', 'theme-arbys', 'theme-dairyqueen', 'theme-jackinthebox', 'theme-popeyes',
                'theme-chipotle', 'theme-fiveguys', 'theme-innout', 'theme-culvers', 'theme-timhortons',
                // Wisconsin Local
                'theme-kwiktrip', 'theme-rutters', 'theme-cenex', 'theme-cenexcoop', 'theme-fleetfarm',
                'theme-woodmans', 'theme-picknsave', 'theme-sentry', 'theme-festival', 'theme-pigglywiggly',
                'theme-holiday', 'theme-bp', 'theme-caseys', 'theme-shell', 'theme-mobil',
                // Retro Gaming
                'theme-nes', 'theme-snes', 'theme-genesis', 'theme-gameboy', 'theme-n64',
                'theme-ps1', 'theme-windows95', 'theme-windowsxp', 'theme-macos9', 'theme-amiga', 'theme-c64',
                // Cars
                'theme-camaro', 'theme-challenger', 'theme-bullitt', 'theme-supra', 'theme-skyline', 'theme-typer',
                // Sneakers
                'theme-jordan1', 'theme-yeezy', 'theme-pigeon', 'theme-wotherspoon',
                // National Parks
                'theme-yellowstone', 'theme-grandcanyon', 'theme-yosemite',
                // Lo-Fi / Vaporwave / Synthwave
                'theme-lofi', 'theme-chillhop', 'theme-vaporwave', 'theme-mallsoft', 'theme-miamivice', 'theme-outrun',
                // Airlines
                'theme-panam', 'theme-braniff', 'theme-southwest', 'theme-pokemon',
                // NFL Throwbacks
                'theme-bucscreamsicle', 'theme-steelersbee', 'theme-oilersthrow', 'theme-patpatriot',
                'theme-chargerspowder', 'theme-orangecrush', 'theme-kellygreen', 'theme-niners94',
                'theme-rams99', 'theme-seahawkslime', 'theme-falcons66', 'theme-jets98',
                'theme-bears36', 'theme-acme', 'theme-cards47',
                // NFL Alternates
                'theme-billsred', 'theme-chiefsred', 'theme-raidersblack', 'theme-whitetiger',
                'theme-brownsrush', 'theme-eaglesblack', 'theme-titansoilers', 'theme-actiongreen',
                'theme-jagsteal', 'theme-purplepeople',
                // Superheroes
                'theme-reaper', 'theme-spiderman', 'theme-symbiote', 'theme-batman', 'theme-superman',
                'theme-wonderwoman', 'theme-ironman', 'theme-captainamerica', 'theme-hulk', 'theme-thor',
                'theme-harleyquinn', 'theme-starlord', 'theme-groot', 'theme-marvelrivals',
                'theme-flash', 'theme-greenlantern',
                // Cyberpunk
                'theme-nightcity', 'theme-arasaka', 'theme-militech', 'theme-moxes', 'theme-valentinos',
                'theme-vjacket', 'theme-silverhand', 'theme-cyberpunkui', 'theme-phantomliberty', 'theme-cyberpunklogo',
                // Retro Search Engines
                'theme-yahoo1996', 'theme-yahoo2000s', 'theme-aol1995', 'theme-aol2000s', 'theme-excite1997',
                'theme-lycos', 'theme-altavista', 'theme-askjeeves', 'theme-webcrawler', 'theme-infoseek',
                'theme-msn1998', 'theme-netscape', 'theme-dogpile', 'theme-geocities',
                // MAME Arcade
                'theme-mamepacman', 'theme-mamemspacman', 'theme-mamedonkeykong', 'theme-mamespaceinvaders',
                'theme-mamegalaga', 'theme-mamefrogger', 'theme-mamestreetfighter', 'theme-mamemortalkombat',
                'theme-mamedefender', 'theme-mamecentipede', 'theme-mamedigdug', 'theme-mameqbert',
                'theme-mametempest', 'theme-mameasteroids', 'theme-mamebubble', 'theme-mamegauntlet',
                'theme-mamerampage', 'theme-mamerobotron', 'theme-mamejoust', 'theme-mametron',
                'theme-mamenbajam', 'theme-mamecontra', 'theme-mamemetalslug', 'theme-mametmnt',
                'theme-mamedoubledragon', 'theme-mamefinalfight', 'theme-mamegradius', 'theme-mamegoldenaxe',
                'theme-mamestrider', 'theme-mamertype',
                // Monster Energy
                'theme-monstergreen', 'theme-monsterblack', 'theme-monstersunrise', 'theme-monsterparadise',
                'theme-monsterviolet', 'theme-monsterpipeline', 'theme-monsterrehab', 'theme-monsterred',
                // Mountain Dew
                'theme-mtndewgreen', 'theme-mtndewcodered', 'theme-mtndewvoltage', 'theme-mtndewbaja',
                'theme-mtndewlivewire', 'theme-mtndewwhiteout',
                // Root Beer & Soda
                'theme-awrootbeer', 'theme-barqs', 'theme-mugcream', 'theme-ibccherry',
                'theme-cocacola', 'theme-drpepper', 'theme-pepsi', 'theme-sprite', 'theme-fanta',
                // Energy Drinks
                'theme-redbull', 'theme-rockstar', 'theme-nos', 'theme-bang', 'theme-c4energy',
                'theme-alaninu', 'theme-ghostenergy', 'theme-celsius', 'theme-prime', 'theme-reign', 'theme-gamerfuel'
            );
            
            // Add new theme class
            body.classList.add('theme-' + theme);
            
            // Save preference FIRST (so getThemeColors reads the correct theme)
            localStorage.setItem('theme', theme);
            
            // Set --primary CSS variable based on theme
            const themeColors = getThemeColors();
            document.documentElement.style.setProperty('--primary', themeColors.primary);
            document.documentElement.style.setProperty('--secondary', themeColors.accent);
            document.documentElement.style.setProperty('--primary-light', hexToRgbaLight(themeColors.primary));
            
            // âœ¨ NEW: Apply dynamic gradient to ALL themes
            const gradient = `linear-gradient(135deg, ${themeColors.primary} 0%, ${themeColors.accent} 100%)`;
            document.documentElement.style.setProperty('--theme-gradient', gradient);
            
            // Apply gradient to body background
            document.body.style.background = gradient;
            
            showStatus('configStatus', `âœ… Theme changed to ${theme}!`, 'success');
        }
        
        // Convert hex to light background color
        function hexToRgbaLight(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, 0.1)`;
        }
        
        // Get theme colors for print templates
        function getThemeColors() {
            const theme = localStorage.getItem('theme') || 'purple';
            const themes = {
                // Classic themes
                purple: { primary: '#667eea', accent: '#764ba2', text: '#667eea' },
                ocean: { primary: '#0077b6', accent: '#00b4d8', text: '#0077b6' },
                forest: { primary: '#2d6a4f', accent: '#40916c', text: '#2d6a4f' },
                sunset: { primary: '#e85d04', accent: '#f48c06', text: '#e85d04' },
                dark: { primary: '#1e293b', accent: '#334155', text: '#1e293b' },
                crimson: { primary: '#be123c', accent: '#e11d48', text: '#be123c' },
                slate: { primary: '#475569', accent: '#64748b', text: '#475569' },
                teal: { primary: '#0d9488', accent: '#14b8a6', text: '#0d9488' },
                // NFL AFC East
                bills: { primary: '#00338D', accent: '#C60C30', text: '#C60C30' },
                dolphins: { primary: '#008E97', accent: '#FC4C02', text: '#FC4C02' },
                patriots: { primary: '#002244', accent: '#C60C30', text: '#C60C30' },
                jets: { primary: '#125740', accent: '#000000', text: '#FFFFFF' },
                // NFL AFC North
                ravens: { primary: '#241773', accent: '#9E7C0C', text: '#9E7C0C' },
                bengals: { primary: '#FB4F14', accent: '#000000', text: '#FFFFFF' },
                browns: { primary: '#311D00', accent: '#FF3C00', text: '#FF3C00' },
                steelers: { primary: '#FFB612', accent: '#000000', text: '#000000' },
                // NFL AFC South
                texans: { primary: '#03202F', accent: '#A71930', text: '#A71930' },
                colts: { primary: '#002C5F', accent: '#A2AAAD', text: '#FFFFFF' },
                jaguars: { primary: '#006778', accent: '#D7A22A', text: '#D7A22A' },
                titans: { primary: '#0C2340', accent: '#4B92DB', text: '#4B92DB' },
                // NFL AFC West
                broncos: { primary: '#FB4F14', accent: '#002244', text: '#002244' },
                chiefs: { primary: '#E31937', accent: '#FFB612', text: '#FFB612' },
                raiders: { primary: '#000000', accent: '#A5ACAF', text: '#A5ACAF' },
                chargers: { primary: '#0080C6', accent: '#FFC20E', text: '#FFC20E' },
                // NFL NFC East
                cowboys: { primary: '#003594', accent: '#869397', text: '#FFFFFF' },
                giants: { primary: '#0B2265', accent: '#A71930', text: '#A71930' },
                eagles: { primary: '#004C54', accent: '#A5ACAF', text: '#A5ACAF' },
                commanders: { primary: '#5A1414', accent: '#FFB612', text: '#FFB612' },
                // NFL NFC North
                bears: { primary: '#0B162A', accent: '#C83803', text: '#C83803' },
                lions: { primary: '#0076B6', accent: '#B0B7BC', text: '#FFFFFF' },
                packers: { primary: '#203731', accent: '#FFB612', text: '#FFB612' },
                vikings: { primary: '#4F2683', accent: '#FFC62F', text: '#FFC62F' },
                // NFL NFC South
                falcons: { primary: '#A71930', accent: '#000000', text: '#FFFFFF' },
                panthers: { primary: '#0085CA', accent: '#BFC0BF', text: '#FFFFFF' },
                saints: { primary: '#D3BC8D', accent: '#101820', text: '#101820' },
                bucs: { primary: '#D50A0A', accent: '#34302B', text: '#FFFFFF' },
                // NFL NFC West
                azcardinals: { primary: '#97233F', accent: '#000000', text: '#FFFFFF' },
                rams: { primary: '#003594', accent: '#FFA300', text: '#FFA300' },
                niners: { primary: '#AA0000', accent: '#B3995D', text: '#B3995D' },
                seahawks: { primary: '#002244', accent: '#69BE28', text: '#69BE28' },
                // MLB AL East
                orioles: { primary: '#DF4601', accent: '#000000', text: '#FFFFFF' },
                redsox: { primary: '#BD3039', accent: '#0C2340', text: '#0C2340' },
                yankees: { primary: '#0C2340', accent: '#C4CED4', text: '#FFFFFF' },
                rays: { primary: '#092C5C', accent: '#8FBCE6', text: '#F5D130' },
                bluejays: { primary: '#134A8E', accent: '#E8291C', text: '#E8291C' },
                // MLB AL Central
                whitesox: { primary: '#000000', accent: '#C4CED4', text: '#C4CED4' },
                guardians: { primary: '#E31937', accent: '#003087', text: '#003087' },
                tigers: { primary: '#0C2340', accent: '#FA4616', text: '#FA4616' },
                royals: { primary: '#004687', accent: '#BD9B60', text: '#BD9B60' },
                twins: { primary: '#002B5C', accent: '#D31145', text: '#D31145' },
                // MLB AL West
                astros: { primary: '#002D62', accent: '#EB6E1F', text: '#EB6E1F' },
                angels: { primary: '#BA0021', accent: '#003263', text: '#FFFFFF' },
                athletics: { primary: '#003831', accent: '#EFB21E', text: '#EFB21E' },
                mariners: { primary: '#0C2C56', accent: '#005C5C', text: '#00A3E0' },
                rangers: { primary: '#003278', accent: '#C0111F', text: '#C0111F' },
                // MLB NL East
                braves: { primary: '#CE1141', accent: '#13274F', text: '#13274F' },
                marlins: { primary: '#00A3E0', accent: '#FF6600', text: '#FF6600' },
                mets: { primary: '#002D72', accent: '#FF5910', text: '#FF5910' },
                phillies: { primary: '#E81838', accent: '#002D72', text: '#002D72' },
                nationals: { primary: '#AB0003', accent: '#14225A', text: '#14225A' },
                // MLB NL Central
                cubs: { primary: '#0E3386', accent: '#CC3433', text: '#CC3433' },
                reds: { primary: '#C6011F', accent: '#000000', text: '#FFFFFF' },
                brewers: { primary: '#12284B', accent: '#FFB81C', text: '#FFB81C' },
                pirates: { primary: '#FDB827', accent: '#000000', text: '#000000' },
                stlcardinals: { primary: '#C41E3A', accent: '#0C2340', text: '#FEDB00' },
                // MLB NL West
                dbacks: { primary: '#A71930', accent: '#E3D4AD', text: '#E3D4AD' },
                rockies: { primary: '#33006B', accent: '#C4CED4', text: '#C4CED4' },
                dodgers: { primary: '#005A9C', accent: '#EF3E42', text: '#FFFFFF' },
                padres: { primary: '#2F241D', accent: '#FFC425', text: '#FFC425' },
                sfgiants: { primary: '#FD5A1E', accent: '#000000', text: '#000000' },
                // Chicago extras
                bulls: { primary: '#121212', accent: '#CE1141', text: '#CE1141' },
                blackhawks: { primary: '#002F6C', accent: '#CF0A2C', text: '#CF0A2C' },
                // Retro Search Engines
                yahoo1996: { primary: '#6001A8', accent: '#FF9900', text: '#FF9900' },
                yahoo2000s: { primary: '#7B0099', accent: '#FF0000', text: '#FF0000' },
                aol1995: { primary: '#00C8FF', accent: '#FFCC00', text: '#FFCC00' },
                aol2000s: { primary: '#00A0D8', accent: '#FFFFFF', text: '#FFFFFF' },
                excite1997: { primary: '#E4002B', accent: '#000000', text: '#FFFFFF' },
                lycos: { primary: '#FF0000', accent: '#000000', text: '#FFFFFF' },
                altavista: { primary: '#0066CC', accent: '#FF9900', text: '#FF9900' },
                askjeeves: { primary: '#00A99D', accent: '#FF6600', text: '#FF6600' },
                webcrawler: { primary: '#009900', accent: '#FFFF00', text: '#FFFF00' },
                infoseek: { primary: '#660099', accent: '#FFCC00', text: '#FFCC00' },
                msn1998: { primary: '#00ADEF', accent: '#FFB900', text: '#FFB900' },
                netscape: { primary: '#0033CC', accent: '#FFCC00', text: '#FFCC00' },
                dogpile: { primary: '#FF6600', accent: '#6600CC', text: '#6600CC' },
                geocities: { primary: '#FF0099', accent: '#00FF00', text: '#00FF00' },
                // MAME Arcade
                mamepacman: { primary: '#FFFF00', accent: '#FF0000', text: '#FFFF00' },
                mamemspacman: { primary: '#FF21AE', accent: '#00FFFF', text: '#00FFFF' },
                mamedonkeykong: { primary: '#E80709', accent: '#EE7511', text: '#EE7511' },
                mamespaceinvaders: { primary: '#62DE6D', accent: '#F83B3A', text: '#62DE6D' },
                mamegalaga: { primary: '#00FF00', accent: '#EC4705', text: '#00FF00' },
                mamefrogger: { primary: '#66A400', accent: '#EB1C2D', text: '#66A400' },
                mamestreetfighter: { primary: '#FFFFFF', accent: '#E70000', text: '#E70000' },
                mamemortalkombat: { primary: '#EED911', accent: '#F53929', text: '#EED911' },
                mamedefender: { primary: '#00A651', accent: '#FF4500', text: '#00A651' },
                mamecentipede: { primary: '#228B22', accent: '#8B4513', text: '#FFFFFF' },
                mamedigdug: { primary: '#4169E1', accent: '#FF0000', text: '#4169E1' },
                mameqbert: { primary: '#9370DB', accent: '#FF8C00', text: '#9370DB' },
                mametempest: { primary: '#8A2BE2', accent: '#00BFFF', text: '#00BFFF' },
                mameasteroids: { primary: '#FFFFFF', accent: '#00FFFF', text: '#00FFFF' },
                mamebubble: { primary: '#FFB6C1', accent: '#87CEEB', text: '#FFB6C1' },
                mamegauntlet: { primary: '#40FF40', accent: '#FF4040', text: '#40FF40' },
                mamerampage: { primary: '#00A000', accent: '#FF69B4', text: '#00A000' },
                mamerobotron: { primary: '#00FFFF', accent: '#FF00FF', text: '#00FFFF' },
                mamejoust: { primary: '#FFD700', accent: '#FF0000', text: '#FFD700' },
                mametron: { primary: '#00FFFF', accent: '#FF0000', text: '#00FFFF' },
                mamenbajam: { primary: '#C8102E', accent: '#002244', text: '#FFFFFF' },
                mamecontra: { primary: '#0000FF', accent: '#FF0000', text: '#FF0000' },
                mamemetalslug: { primary: '#FFD700', accent: '#4169E1', text: '#FFD700' },
                mametmnt: { primary: '#008000', accent: '#FF0000', text: '#008000' },
                mamedoubledragon: { primary: '#0000FF', accent: '#FF0000', text: '#0000FF' },
                mamefinalfight: { primary: '#FFFF00', accent: '#FF0000', text: '#FFFF00' },
                mamegradius: { primary: '#00FFFF', accent: '#FF4500', text: '#00FFFF' },
                mamegoldenaxe: { primary: '#8B0000', accent: '#FF4500', text: '#FF4500' },
                mamestrider: { primary: '#00FF00', accent: '#FF00FF', text: '#00FF00' },
                mamertype: { primary: '#4169E1', accent: '#FF0000', text: '#4169E1' },
                // Monster Energy
                monstergreen: { primary: '#8DC63F', accent: '#000000', text: '#8DC63F' },
                monsterblack: { primary: '#000000', accent: '#C0C0C0', text: '#C0C0C0' },
                monstersunrise: { primary: '#FF6B00', accent: '#FFD700', text: '#FFD700' },
                monsterparadise: { primary: '#00FF7F', accent: '#FFFFFF', text: '#00FF7F' },
                monsterviolet: { primary: '#9932CC', accent: '#E0B0FF', text: '#E0B0FF' },
                monsterpipeline: { primary: '#FF69B4', accent: '#FFD700', text: '#FFD700' },
                monsterrehab: { primary: '#FFD700', accent: '#8B4513', text: '#FFD700' },
                monsterred: { primary: '#C8102E', accent: '#FFFFFF', text: '#FFFFFF' },
                // Mountain Dew
                mtndewgreen: { primary: '#99CC00', accent: '#006633', text: '#99CC00' },
                mtndewcodered: { primary: '#C8102E', accent: '#000000', text: '#C8102E' },
                mtndewvoltage: { primary: '#00B7EB', accent: '#000000', text: '#00B7EB' },
                mtndewbaja: { primary: '#66CCCC', accent: '#FFFFFF', text: '#FFFFFF' },
                mtndewlivewire: { primary: '#FF6B00', accent: '#000000', text: '#FF6B00' },
                mtndewwhiteout: { primary: '#FFFFFF', accent: '#00BFFF', text: '#00BFFF' },
                // Root Beer & Soda
                awrootbeer: { primary: '#8B4513', accent: '#FFD700', text: '#FFD700' },
                barqs: { primary: '#C8102E', accent: '#FFFFFF', text: '#FFFFFF' },
                mugcream: { primary: '#FFF8DC', accent: '#8B4513', text: '#8B4513' },
                ibccherry: { primary: '#4B0082', accent: '#C71585', text: '#C71585' },
                cocacola: { primary: '#C8102E', accent: '#FFFFFF', text: '#FFFFFF' },
                drpepper: { primary: '#8B0000', accent: '#DAA520', text: '#DAA520' },
                pepsi: { primary: '#004B8D', accent: '#E4002B', text: '#FFFFFF' },
                sprite: { primary: '#00A550', accent: '#FFFFFF', text: '#FFFFFF' },
                fanta: { primary: '#FF6600', accent: '#003DA5', text: '#FF6600' },
                // Energy Drinks
                redbull: { primary: '#0050A4', accent: '#C0C0C0', text: '#C0C0C0' },
                rockstar: { primary: '#800080', accent: '#FFD700', text: '#FFD700' },
                nos: { primary: '#000000', accent: '#FF0000', text: '#FF0000' },
                bang: { primary: '#FF6B00', accent: '#FFD700', text: '#FFD700' },
                c4energy: { primary: '#00BFFF', accent: '#FFFFFF', text: '#FFFFFF' },
                alaninu: { primary: '#FF69B4', accent: '#E0B0FF', text: '#E0B0FF' },
                ghostenergy: { primary: '#39FF14', accent: '#000000', text: '#39FF14' },
                celsius: { primary: '#FF4500', accent: '#FFD700', text: '#FFD700' },
                prime: { primary: '#00AEEF', accent: '#FF6B00', text: '#FF6B00' },
                reign: { primary: '#000000', accent: '#C0C0C0', text: '#C0C0C0' },
                gamerfuel: { primary: '#00FFFF', accent: '#FF00FF', text: '#00FFFF' }
            };
            return themes[theme] || themes.purple;
        }
        
        function openBackup() {
            if (!API_URL) {
                alert('Please configure your API URL first!');
                return;
            }
            // Extract the Google Sheets URL from API URL pattern
            alert('To backup your data:\n\n1. Go to your Google Sheets database\n2. File â†’ Make a copy\n3. Download as Excel or CSV\n\nYour Google Sheet contains all your data!');
        }
        
        // Load theme on startup
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'purple';
            document.getElementById('themeSelector').value = savedTheme;
            document.body.classList.remove(
                'theme-purple', 'theme-ocean', 'theme-forest', 'theme-sunset', 'theme-dark', 'theme-crimson', 'theme-slate', 'theme-teal',
                'theme-bills', 'theme-dolphins', 'theme-patriots', 'theme-jets',
                'theme-ravens', 'theme-bengals', 'theme-browns', 'theme-steelers',
                'theme-texans', 'theme-colts', 'theme-jaguars', 'theme-titans',
                'theme-broncos', 'theme-chiefs', 'theme-raiders', 'theme-chargers',
                'theme-cowboys', 'theme-giants', 'theme-eagles', 'theme-commanders',
                'theme-bears', 'theme-lions', 'theme-packers', 'theme-vikings',
                'theme-falcons', 'theme-panthers', 'theme-saints', 'theme-bucs',
                'theme-azcardinals', 'theme-rams', 'theme-niners', 'theme-seahawks',
                'theme-orioles', 'theme-redsox', 'theme-yankees', 'theme-rays', 'theme-bluejays',
                'theme-whitesox', 'theme-guardians', 'theme-tigers', 'theme-royals', 'theme-twins',
                'theme-astros', 'theme-angels', 'theme-athletics', 'theme-mariners', 'theme-rangers',
                'theme-braves', 'theme-marlins', 'theme-mets', 'theme-phillies', 'theme-nationals',
                'theme-cubs', 'theme-reds', 'theme-brewers', 'theme-pirates', 'theme-stlcardinals',
                'theme-dbacks', 'theme-rockies', 'theme-dodgers', 'theme-padres', 'theme-sfgiants',
                'theme-bulls', 'theme-blackhawks'
            );
            document.body.classList.add('theme-' + savedTheme);
            
            // Set --primary CSS variable based on saved theme
            setTimeout(() => {
                const themeColors = getThemeColors();
                document.documentElement.style.setProperty('--primary', themeColors.primary);
                document.documentElement.style.setProperty('--secondary', themeColors.accent);
                document.documentElement.style.setProperty('--primary-light', hexToRgbaLight(themeColors.primary));
                
                // Update theme preview in settings
                if (typeof updateThemePreview === 'function') {
                    updateThemePreview();
                }
            }, 100);
        });
        
        function saveConfig() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const status = document.getElementById('configStatus');
            
            if (!apiUrl) {
                showStatus('configStatus', 'Please enter an API URL', 'error');
                return;
            }
            
            API_URL = apiUrl;
            localStorage.setItem('apiUrl', apiUrl);
            updateConfigStatus();
            
            showStatus('configStatus', 'âœ… Configuration saved!', 'success');
        }
        
        // Save Invoice Settings
        function saveInvoiceSettings() {
            const settings = {
                companyName: document.getElementById('invoiceCompanyName').value,
                contactName: document.getElementById('invoiceContactName').value,
                phone: document.getElementById('invoicePhone').value,
                email: document.getElementById('invoiceEmail').value,
                address1: document.getElementById('invoiceAddress1').value,
                address2: document.getElementById('invoiceAddress2').value,
                cityStateZip: document.getElementById('invoiceCityStateZip').value,
                footer: document.getElementById('invoiceFooter').value,
                signatureLine: document.getElementById('invoiceSignatureLine').checked
            };
            
            localStorage.setItem('invoiceSettings', JSON.stringify(settings));
            showStatus('configStatus', 'âœ… Invoice settings saved!', 'success');
        }
        
        // Load Invoice Settings
        function loadInvoiceSettings() {
            const saved = localStorage.getItem('invoiceSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('invoiceCompanyName').value = settings.companyName || '';
                document.getElementById('invoiceContactName').value = settings.contactName || '';
                document.getElementById('invoicePhone').value = settings.phone || '';
                document.getElementById('invoiceEmail').value = settings.email || '';
                document.getElementById('invoiceAddress1').value = settings.address1 || '';
                document.getElementById('invoiceAddress2').value = settings.address2 || '';
                document.getElementById('invoiceCityStateZip').value = settings.cityStateZip || '';
                document.getElementById('invoiceFooter').value = settings.footer || '';
                document.getElementById('invoiceSignatureLine').checked = settings.signatureLine !== false;
            }
        }
        
        // Get Invoice Settings
        function getInvoiceSettings() {
            const saved = localStorage.getItem('invoiceSettings');
            if (saved) {
                return JSON.parse(saved);
            }
            return {
                companyName: 'Nowak Distributing',
                contactName: '',
                phone: '(920)634-4351',
                email: 'jnowaksnfoodistributors@gmail.com',
                address1: '',
                address2: '',
                cityStateZip: '',
                footer: 'Thank you for doing business with us!',
                signatureLine: true
            };
        }

        // Format phone number as (999) 999-9999
        function formatPhone(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            if (value.length > 10) value = value.slice(0, 10);
            
            if (value.length >= 6) {
                input.value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6)}`;
            } else if (value.length >= 3) {
                input.value = `(${value.slice(0,3)}) ${value.slice(3)}`;
            } else if (value.length > 0) {
                input.value = `(${value}`;
            }
        }
        
        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        async function apiCall(action, data = {}) {
            if (!API_URL) {
                alert('Please configure your API URL in Settings first!');
                switchTab('config');
                return null;
            }

            try {
                // Use GET with query parameters to avoid CORS preflight
                const params = new URLSearchParams({
                    action: action,
                    data: JSON.stringify(data)
                });
                
                const url = `${API_URL}?${params.toString()}`;
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                });

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('API Error:', error);
                return { status: 'error', message: error.toString() };
            }
        }

        // ==================== SUPPLIERS ====================

        function showAddSupplierForm() {
            document.getElementById('addSupplierForm').style.display = 'block';
        }

        function hideAddSupplierForm() {
            document.getElementById('addSupplierForm').style.display = 'none';
            document.querySelector('#addSupplierForm form').reset();
        }

        async function addSupplier(e) {
            e.preventDefault();
            
            const data = {
                supplierName: document.getElementById('newSupplierName').value,
                contactName: document.getElementById('newContactName').value,
                phone: document.getElementById('newPhone').value,
                email: document.getElementById('newEmail').value,
                address: document.getElementById('newAddress').value,
                city: document.getElementById('newCity').value,
                state: document.getElementById('newState').value,
                zip: document.getElementById('newZip').value,
                paymentTerms: document.getElementById('newPaymentTerms').value,
                notes: document.getElementById('newNotes').value
            };

            const result = await apiCall('addSupplier', data);
            
            if (result && result.status === 'success') {
                showStatus('suppliersStatus', 'âœ… Supplier added successfully!', 'success');
                hideAddSupplierForm();
                loadSuppliers();
            } else {
                showStatus('suppliersStatus', 'âŒ Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        async function loadSuppliers() {
            document.getElementById('suppliersTable').innerHTML = '<div class="loading">Loading suppliers...</div>';
            
            const result = await apiCall('getSuppliers');
            
            if (result && result.status === 'success') {
                cachedSuppliers = result.data;
                displaySuppliers(result.data);
                
                // Populate Create PO supplier dropdown
                const createPOSupplierSelect = document.getElementById('createPOSupplier');
                if (createPOSupplierSelect) {
                    createPOSupplierSelect.innerHTML = '<option value="">Select Supplier...</option>';
                    result.data.forEach(supplier => {
                        const option = document.createElement('option');
                        option.value = supplier.Supplier_ID;
                        option.textContent = supplier.Supplier_Name;
                        createPOSupplierSelect.appendChild(option);
                    });
                }
            } else {
                document.getElementById('suppliersTable').innerHTML = '<div class="loading">Error loading suppliers</div>';
            }
        }

        function displaySuppliers(suppliers) {
            if (!suppliers || suppliers.length === 0) {
                document.getElementById('suppliersTable').innerHTML = '<p>No suppliers yet. Add your first supplier!</p>';
                return;
            }

            let html = '<table class="data-table" id="suppliersDataTable"><thead><tr>';
            html += '<th>Name</th><th>Contact</th><th>Phone</th><th>Email</th><th>City</th><th>Payment Terms</th>';
            html += '</tr></thead><tbody>';

            suppliers.forEach(s => {
                html += `<tr style="cursor: pointer;" onclick='editSupplier(${JSON.stringify(s).replace(/'/g, "&#39;")})' onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                    <td><strong>${s.Supplier_Name}</strong></td>
                    <td>${s.Contact_Name || '-'}</td>
                    <td>${s.Phone || '-'}</td>
                    <td>${s.Email || '-'}</td>
                    <td>${s.City || '-'}, ${s.State || '-'}</td>
                    <td>${s.Payment_Terms || '-'}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('suppliersTable').innerHTML = html;
            
            // Make table sortable
            setTimeout(() => makeSortable('suppliersDataTable'), 0);
        }
        
        // Filter suppliers
        function filterSuppliers() {
            const nameFilter = document.getElementById('filterSupplierName').value.toLowerCase();
            const cityFilter = document.getElementById('filterSupplierCity').value.toLowerCase();
            const stateFilter = document.getElementById('filterSupplierState').value.toLowerCase();
            
            const filtered = cachedSuppliers.filter(s => {
                const matchesName = !nameFilter || (s.Supplier_Name && s.Supplier_Name.toLowerCase().includes(nameFilter));
                const matchesCity = !cityFilter || (s.City && s.City.toLowerCase().includes(cityFilter));
                const matchesState = !stateFilter || (s.State && s.State.toLowerCase().includes(stateFilter));
                return matchesName && matchesCity && matchesState;
            });
            
            displaySuppliers(filtered);
        }
        
        function clearSupplierFilters() {
            document.getElementById('filterSupplierName').value = '';
            document.getElementById('filterSupplierCity').value = '';
            document.getElementById('filterSupplierState').value = '';
            displaySuppliers(cachedSuppliers);
        }
        
        // Edit supplier
        function editSupplier(supplier) {
            document.getElementById('editSupplierId').value = supplier.Supplier_ID;
            document.getElementById('editSupplierName').value = supplier.Supplier_Name || '';
            document.getElementById('editContactName').value = supplier.Contact_Name || '';
            document.getElementById('editPhone').value = supplier.Phone || '';
            document.getElementById('editEmail').value = supplier.Email || '';
            document.getElementById('editAddress').value = supplier.Address || '';
            document.getElementById('editCity').value = supplier.City || '';
            document.getElementById('editState').value = supplier.State || '';
            document.getElementById('editZip').value = supplier.ZIP || '';
            document.getElementById('editPaymentTerms').value = supplier.Payment_Terms || 'Net 30';
            document.getElementById('editNotes').value = supplier.Notes || '';
            
            document.getElementById('editSupplierForm').style.display = 'block';
            document.getElementById('addSupplierForm').style.display = 'none';
        }
        
        function hideEditSupplierForm() {
            document.getElementById('editSupplierForm').style.display = 'none';
            document.querySelector('#editSupplierForm form').reset();
            
            // Return to previous tab if we came from Reports
            if (returnToTab === 'reports') {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="reports"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('reports').classList.add('active');
                returnToTab = null;
            }
        }
        
        async function updateSupplier(e) {
            e.preventDefault();
            
            const data = {
                supplierId: document.getElementById('editSupplierId').value,
                name: document.getElementById('editSupplierName').value,
                address: document.getElementById('editAddress').value,
                city: document.getElementById('editCity').value,
                state: document.getElementById('editState').value,
                zip: document.getElementById('editZip').value,
                contactName: document.getElementById('editContactName').value,
                phone: document.getElementById('editPhone').value,
                fax: '',
                email: document.getElementById('editEmail').value,
                paymentTerms: document.getElementById('editPaymentTerms').value,
                notes: document.getElementById('editNotes').value
            };
            
            const result = await apiCall('updateSupplier', data);
            
            if (result && result.status === 'success') {
                showStatus('suppliersStatus', 'âœ… Supplier updated successfully!', 'success');
                hideEditSupplierForm();
                loadSuppliers();
            } else {
                showStatus('suppliersStatus', 'âŒ Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        async function deleteSupplier(supplierId, supplierName) {
            if (!confirm(`Are you sure you want to delete supplier "${supplierName}"?\n\nThis cannot be undone!`)) {
                return;
            }
            
            const result = await apiCall('deleteSupplier', { supplierId });
            
            if (result && result.status === 'success') {
                showStatus('suppliersStatus', 'âœ… Supplier deleted successfully!', 'success');
                loadSuppliers();
            } else {
                showStatus('suppliersStatus', 'âŒ Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        // ==================== ITEMS ====================

        function showAddItemForm() {
            loadSuppliersList();
            document.getElementById('addItemForm').style.display = 'block';
        }

        function hideAddItemForm() {
            document.getElementById('addItemForm').style.display = 'none';
            document.querySelector('#addItemForm form').reset();
        }

        async function loadSuppliersList() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }

            const select = document.getElementById('newItemSupplier');
            select.innerHTML = '<option value="">Select Supplier</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }

        // Calculate unit cost in Add Item form
        function calculateUnitCost() {
            const packageCost = parseFloat(document.getElementById('newPackageCost').value) || 0;
            const unitsPerPackage = parseFloat(document.getElementById('newUnitsPerPackage').value) || 1;
            const unitCost = packageCost / unitsPerPackage;
            document.getElementById('calculatedUnitCost').value = '$' + unitCost.toFixed(2);
        }
        
        // Calculate unit cost in Edit Item form
        function calculateEditUnitCost() {
            const packageCost = parseFloat(document.getElementById('editPackageCost').value) || 0;
            const unitsPerPackage = parseFloat(document.getElementById('editUnitsPerPackage').value) || 1;
            const unitCost = packageCost / unitsPerPackage;
            document.getElementById('calculatedEditUnitCost').value = '$' + unitCost.toFixed(2);
        }
        
        async function addItem(e) {
            e.preventDefault();
            
            const data = {
                supplierId: document.getElementById('newItemSupplier').value,
                description: document.getElementById('newItemDescription').value,
                purchaseUOM: document.getElementById('newItemPurchaseUOM').value,
                unitsPerPackage: document.getElementById('newUnitsPerPackage').value,
                packageCost: document.getElementById('newPackageCost').value,
                unitSellPrice: document.getElementById('newUnitSellPrice').value,
                qtyOnHand: document.getElementById('newQtyOnHand').value,
                reorderPoint: document.getElementById('newReorderPoint').value,
                sku: document.getElementById('newItemSKU').value,
                notes: document.getElementById('newItemNotes').value
            };

            const result = await apiCall('addItem', data);
            
            if (result && result.status === 'success') {
                showStatus('itemsStatus', 'âœ… Item added successfully!', 'success');
                hideAddItemForm();
                loadItems();
            } else {
                showStatus('itemsStatus', 'âŒ Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        async function loadItems() {
            document.getElementById('itemsTable').innerHTML = '<div class="loading">Loading items...</div>';
            
            // Ensure suppliers are loaded first so getSupplierName works
            if (cachedSuppliers.length === 0) {
                const suppResult = await apiCall('getSuppliers');
                if (suppResult && suppResult.status === 'success') {
                    cachedSuppliers = suppResult.data;
                }
            }
            
            const result = await apiCall('getItems');
            
            if (result && result.status === 'success') {
                cachedItems = result.data;
                
                // DEBUG: Log the first item to see what properties it actually has
                if (cachedItems.length > 0) {
                    console.log('=== ITEM DATA STRUCTURE DEBUG ===');
                    console.log('First item keys:', Object.keys(cachedItems[0]));
                    console.log('First item full data:', cachedItems[0]);
                    console.log('Unit_Sell_Price:', cachedItems[0].Unit_Sell_Price);
                    console.log('Sell_Price:', cachedItems[0].Sell_Price);
                    console.log('=================================');
                }
                
                // Apply active filter by default (show only active items)
                const activeFilter = document.getElementById('filterItemActive')?.value || 'active';
                let itemsToDisplay = result.data;
                if (activeFilter === 'active') {
                    itemsToDisplay = result.data.filter(item => item.Status !== 'Archived');
                } else if (activeFilter === 'archived') {
                    itemsToDisplay = result.data.filter(item => item.Status === 'Archived');
                }
                
                displayItems(itemsToDisplay);
                loadItemFilterSuppliers();
            } else {
                document.getElementById('itemsTable').innerHTML = '<div class="loading">Error loading items</div>';
            }
        }

        function displayItems(items) {
            if (!items || items.length === 0) {
                document.getElementById('itemsTable').innerHTML = '<p>No items yet. Add your first item!</p>';
                return;
            }

            // Calculate totals
            let totalQty = 0;
            
            let html = '<table class="data-table" id="itemsDataTable"><thead><tr>';
            html += '<th>SKU</th><th>Description</th><th>Supplier</th><th>UOM</th><th>Units/Pkg</th><th>Pkg Cost</th><th>Unit Cost</th><th>Sell Price</th><th>Qty</th><th>On Order</th><th>Reorder</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            items.forEach(item => {
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const qtyOnOrder = parseFloat(item.Qty_On_Order) || 0;
                const unitsPerPkg = parseFloat(item.Units_Per_Package) || 1;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitCost = packageCost / unitsPerPkg;
                const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                const packages = (qty / unitsPerPkg).toFixed(1);
                const packagesOnOrder = (qtyOnOrder / unitsPerPkg).toFixed(1);
                const isArchived = item.Status === 'Archived';
                
                // Determine row styling based on stock status
                let rowBg = '';
                let qtyStyle = '';
                if (isArchived) {
                    rowBg = 'background:#f0f0f0; opacity: 0.7;';  // Grey for archived
                } else if (qty < 0) {
                    rowBg = 'background:#ffcdd2;';  // Red for negative
                    qtyStyle = 'color: #b71c1c; font-weight: bold;';
                } else if (qty <= reorderPoint) {
                    rowBg = 'background:#fff3cd;';  // Yellow for low stock
                }
                
                totalQty += qty;
                
                html += `<tr style="${rowBg} cursor: pointer;" onclick="editItemById('${item.Item_ID}')" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
                    <td><strong>${item.SKU || '-'}</strong>${isArchived ? ' <span style="background: #9e9e9e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">ARCHIVED</span>' : ''}</td>
                    <td>${item.Item_Description}</td>
                    <td>${getSupplierName(item.Supplier_ID)}</td>
                    <td>${item.Purchase_UOM}</td>
                    <td>${unitsPerPkg}</td>
                    <td>$${packageCost.toFixed(2)}</td>
                    <td>$${unitCost.toFixed(2)}</td>
                    <td style="color: #28a745; font-weight: bold;">$${unitSellPrice.toFixed(2)}</td>
                    <td style="${qtyStyle}">${qty.toFixed(0)}</td>
                    <td><span style="background: ${qtyOnOrder > 0 ? '#ffc107' : '#e0e0e0'}; padding: 3px 8px; border-radius: 4px; font-weight: bold;">${qtyOnOrder > 0 ? qtyOnOrder : '-'}</span></td>
                    <td>${item.Reorder_Point || 0}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="btn-delete-icon" onclick="toggleArchiveItem('${item.Item_ID}', '${item.Item_Description.replace(/'/g, "\\'")}', ${isArchived})" title="${isArchived ? 'Reactivate Item' : 'Archive Item'}">${isArchived ? 'â™»ï¸' : 'ğŸ“¦'}</button>
                    </td>
                </tr>`;
            });

            // Add totals row
            html += `<tr style="background: #f0f0f0; font-weight: bold; border-top: 3px solid #667eea;">
                <td colspan="8" style="text-align: right; padding-right: 20px;">TOTALS:</td>
                <td>${totalQty.toLocaleString()}</td>
                <td colspan="3"></td>
            </tr>`;

            html += '</tbody></table>';
            document.getElementById('itemsTable').innerHTML = html;
            setTimeout(() => makeSortable('itemsDataTable'), 0);
        }
        
        // Filter items
        async function filterItems() {
            const searchFilter = document.getElementById('filterItemSearch').value.toLowerCase().trim();
            const supplierFilter = document.getElementById('filterItemSupplier').value;
            const stockFilter = document.getElementById('filterItemStock').value;
            const activeFilter = document.getElementById('filterItemActive')?.value || 'active';
            
            // Ensure items are loaded
            if (cachedItems.length === 0) {
                await loadItems();
                return;
            }
            
            const filtered = cachedItems.filter(item => {
                const matchesSearch = !searchFilter || 
                    (item.SKU && item.SKU.toString().toLowerCase().includes(searchFilter)) ||
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(searchFilter));
                const matchesSupplier = !supplierFilter || item.Supplier_ID === supplierFilter;
                
                // Active/Archived status filter
                const isArchived = item.Status === 'Archived';
                let matchesActive = true;
                if (activeFilter === 'active') {
                    matchesActive = !isArchived;
                } else if (activeFilter === 'archived') {
                    matchesActive = isArchived;
                }
                
                // Stock status calculations
                const qtyOnHand = parseFloat(item.Qty_On_Hand) || 0;
                const qtyOnOrder = parseFloat(item.Qty_On_Order) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                const negativeStock = qtyOnHand < 0;
                const lowStock = qtyOnHand <= reorderPoint && qtyOnHand >= 0;
                const hasOnOrder = qtyOnOrder > 0;
                const needsReorder = (lowStock || negativeStock) && !hasOnOrder;
                
                let matchesStock = true;
                if (stockFilter === 'negative') {
                    matchesStock = negativeStock;
                } else if (stockFilter === 'low') {
                    matchesStock = lowStock || negativeStock;
                } else if (stockFilter === 'onorder') {
                    matchesStock = hasOnOrder;
                } else if (stockFilter === 'reorder') {
                    matchesStock = needsReorder;
                } else if (stockFilter === 'ok') {
                    matchesStock = qtyOnHand > reorderPoint;
                }
                
                return matchesSearch && matchesSupplier && matchesStock && matchesActive;
            });
            
            displayItems(filtered);
        }
        
        async function clearItemFilters() {
            document.getElementById('filterItemSearch').value = '';
            document.getElementById('filterItemSupplier').value = '';
            document.getElementById('filterItemStock').value = '';
            document.getElementById('filterItemActive').value = 'active';
            // Show only active items by default after clearing
            filterItems();
        }
        
        async function loadItemFilterSuppliers() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }
            
            const select = document.getElementById('filterItemSupplier');
            select.innerHTML = '<option value="">All Suppliers</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }
        
        // Helper function to edit by ID
        function editItemById(itemId) {
            const item = cachedItems.find(i => i.Item_ID === itemId);
            if (item) {
                editItem(item);
            }
        }
        
        // Edit item
        async function editItem(item) {
            // Hide add form first
            document.getElementById('addItemForm').style.display = 'none';
            
            // Load suppliers for dropdown
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }
            
            const select = document.getElementById('editItemSupplier');
            select.innerHTML = '<option value="">Select Supplier</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
            
            document.getElementById('editItemId').value = item.Item_ID;
            document.getElementById('editItemSupplier').value = item.Supplier_ID || '';
            document.getElementById('editItemDescription').value = item.Item_Description || '';
            document.getElementById('editItemSKU').value = item.SKU || '';
            const uomValue = item.Purchase_UOM || 'Case';
            document.getElementById('editItemPurchaseUOM').value = uomValue;
            document.getElementById('editItemPurchaseUOMDisplay').value = uomValue;
            document.getElementById('editUnitsPerPackage').value = item.Units_Per_Package || 1;
            document.getElementById('editPackageCost').value = item.Package_Cost || '';
            document.getElementById('editUnitSellPrice').value = item.Unit_Sell_Price || '';
            document.getElementById('editQtyOnHand').value = item.Qty_On_Hand || '';
            document.getElementById('editReorderPoint').value = item.Reorder_Point || '';
            document.getElementById('editItemStatus').value = item.Status || 'Active';
            document.getElementById('editItemNotes').value = item.Notes || '';
            
            // Calculate unit cost for display
            calculateEditUnitCost();
            
            document.getElementById('editItemForm').style.display = 'block';
            
            // Scroll to the edit form
            document.getElementById('editItemForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function hideEditItemForm() {
            document.getElementById('editItemForm').style.display = 'none';
            document.querySelector('#editItemForm form').reset();
            
            // Return to previous tab if we came from Reports
            if (returnToTab === 'reports') {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="reports"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('reports').classList.add('active');
                returnToTab = null;
            }
        }
        
        async function updateItem(e) {
            e.preventDefault();
            
            const data = {
                itemId: document.getElementById('editItemId').value,
                supplierId: document.getElementById('editItemSupplier').value,
                description: document.getElementById('editItemDescription').value,
                purchaseUOM: document.getElementById('editItemPurchaseUOM').value,
                unitsPerPackage: document.getElementById('editUnitsPerPackage').value,
                packageCost: document.getElementById('editPackageCost').value,
                unitSellPrice: document.getElementById('editUnitSellPrice').value,
                reorderPoint: document.getElementById('editReorderPoint').value,
                sku: document.getElementById('editItemSKU').value,
                status: document.getElementById('editItemStatus').value,
                notes: document.getElementById('editItemNotes').value
            };
            
            const result = await apiCall('updateItem', data);
            
            if (result && result.status === 'success') {
                showStatus('itemsStatus', 'âœ… Item updated successfully!', 'success');
                hideEditItemForm();
                loadItems();
            } else {
                showStatus('itemsStatus', 'âŒ Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        async function toggleArchiveItem(itemId, itemDesc, isCurrentlyArchived) {
            const action = isCurrentlyArchived ? 'reactivate' : 'archive';
            const actionLabel = isCurrentlyArchived ? 'Reactivate' : 'Archive';
            const confirmMsg = isCurrentlyArchived 
                ? `Reactivate item "${itemDesc}"?\n\nThis will make it available in dropdowns again.`
                : `Archive item "${itemDesc}"?\n\nThis will hide it from new PO/SO dropdowns but preserve all history.\n\nYou can reactivate it later if needed.`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            const newStatus = isCurrentlyArchived ? 'Active' : 'Archived';
            const result = await apiCall('updateItem', { 
                itemId: itemId,
                status: newStatus
            });
            
            if (result && result.status === 'success') {
                showStatus('itemsStatus', `âœ… Item ${action}d successfully!`, 'success');
                loadItems();
            } else {
                showStatus('itemsStatus', 'âŒ Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        // ==================== CUSTOMERS ====================

        function showAddCustomerForm() {
            document.getElementById('addCustomerForm').style.display = 'block';
        }

        function hideAddCustomerForm() {
            document.getElementById('addCustomerForm').style.display = 'none';
            document.querySelector('#addCustomerForm form').reset();
        }

        async function addCustomer(e) {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('newCustomerName').value,
                contactName: document.getElementById('newCustomerContact').value,
                phone: document.getElementById('newCustomerPhone').value,
                mobile: document.getElementById('newCustomerMobile').value,
                email: document.getElementById('newCustomerEmail').value,
                address: document.getElementById('newCustomerAddress').value,
                city: document.getElementById('newCustomerCity').value,
                state: document.getElementById('newCustomerState').value,
                zip: document.getElementById('newCustomerZip').value,
                creditLimit: document.getElementById('newCreditLimit').value,
                paymentTerms: document.getElementById('newCustomerPaymentTerms').value,
                notes: document.getElementById('newCustomerNotes').value
            };

            const result = await apiCall('addCustomer', data);
            
            if (result && result.status === 'success') {
                showStatus('customersStatus', 'âœ… Customer added successfully!', 'success');
                hideAddCustomerForm();
                loadCustomers();
            } else {
                showStatus('customersStatus', 'âŒ Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        async function loadCustomers() {
            document.getElementById('customersTable').innerHTML = '<div class="loading">Loading customers...</div>';
            
            const result = await apiCall('getCustomers');
            
            if (result && result.status === 'success') {
                cachedCustomers = result.data;
                displayCustomers(result.data);
            } else {
                document.getElementById('customersTable').innerHTML = '<div class="loading">Error loading customers</div>';
            }
        }

        function displayCustomers(customers) {
            if (!customers || customers.length === 0) {
                document.getElementById('customersTable').innerHTML = '<p>No customers yet. Add your first customer!</p>';
                return;
            }

            let html = '<table class="data-table" id="customersDataTable"><thead><tr>';
            html += '<th>Name</th><th>Contact</th><th>Phone</th><th>Email</th><th>City</th><th>Credit Limit</th>';
            html += '</tr></thead><tbody>';

            customers.forEach(c => {
                html += `<tr style="cursor: pointer;" onclick='editCustomer(${JSON.stringify(c).replace(/'/g, "&#39;")})' onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                    <td><strong>${c.Customer_Name}</strong></td>
                    <td>${c.Contact_Name || '-'}</td>
                    <td>${c.Phone || '-'}</td>
                    <td>${c.Email || '-'}</td>
                    <td>${c.City || '-'}, ${c.State || '-'}</td>
                    <td>$${parseFloat(c.Credit_Limit || 0).toFixed(2)}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('customersTable').innerHTML = html;
            setTimeout(() => makeSortable('customersDataTable'), 0);
        }
        
        // Filter customers
        function filterCustomers() {
            const nameFilter = document.getElementById('filterCustomerName').value.toLowerCase();
            const contactFilter = document.getElementById('filterCustomerContact').value.toLowerCase();
            const cityFilter = document.getElementById('filterCustomerCity').value.toLowerCase();
            const stateFilter = document.getElementById('filterCustomerState').value.toLowerCase();
            
            const filtered = cachedCustomers.filter(c => {
                const matchesName = !nameFilter || (c.Customer_Name && c.Customer_Name.toLowerCase().includes(nameFilter));
                const matchesContact = !contactFilter || (c.Contact_Name && c.Contact_Name.toLowerCase().includes(contactFilter));
                const matchesCity = !cityFilter || (c.City && c.City.toLowerCase().includes(cityFilter));
                const matchesState = !stateFilter || (c.State && c.State.toLowerCase().includes(stateFilter));
                return matchesName && matchesContact && matchesCity && matchesState;
            });
            
            displayCustomers(filtered);
        }
        
        function clearCustomerFilters() {
            document.getElementById('filterCustomerName').value = '';
            document.getElementById('filterCustomerContact').value = '';
            document.getElementById('filterCustomerCity').value = '';
            document.getElementById('filterCustomerState').value = '';
            displayCustomers(cachedCustomers);
        }
        
        // Edit customer
        function editCustomer(customer) {
            document.getElementById('editCustomerId').value = customer.Customer_ID;
            document.getElementById('editCustomerName').value = customer.Customer_Name || '';
            document.getElementById('editCustomerContact').value = customer.Contact_Name || '';
            document.getElementById('editCustomerPhone').value = customer.Phone || '';
            document.getElementById('editCustomerMobile').value = customer.Mobile || '';
            document.getElementById('editCustomerEmail').value = customer.Email || '';
            document.getElementById('editCustomerAddress').value = customer.Address || '';
            document.getElementById('editCustomerCity').value = customer.City || '';
            document.getElementById('editCustomerState').value = customer.State || '';
            document.getElementById('editCustomerZip').value = customer.ZIP || '';
            document.getElementById('editCreditLimit').value = customer.Credit_Limit || '';
            document.getElementById('editCustomerPaymentTerms').value = customer.Payment_Terms || 'Net 30';
            document.getElementById('editCustomerNotes').value = customer.Notes || '';
            
            document.getElementById('editCustomerForm').style.display = 'block';
            document.getElementById('addCustomerForm').style.display = 'none';
        }
        
        function hideEditCustomerForm() {
            document.getElementById('editCustomerForm').style.display = 'none';
            document.querySelector('#editCustomerForm form').reset();
            
            // Return to previous tab if we came from Reports
            if (returnToTab === 'reports') {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="reports"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('reports').classList.add('active');
                returnToTab = null;
            }
        }
        
        async function updateCustomer(e) {
            e.preventDefault();
            
            const data = {
                customerId: document.getElementById('editCustomerId').value,
                name: document.getElementById('editCustomerName').value,
                address: document.getElementById('editCustomerAddress').value,
                city: document.getElementById('editCustomerCity').value,
                state: document.getElementById('editCustomerState').value,
                zip: document.getElementById('editCustomerZip').value,
                contactName: document.getElementById('editCustomerContact').value,
                phone: document.getElementById('editCustomerPhone').value,
                mobile: document.getElementById('editCustomerMobile').value,
                email: document.getElementById('editCustomerEmail').value,
                creditLimit: document.getElementById('editCreditLimit').value,
                paymentTerms: document.getElementById('editCustomerPaymentTerms').value,
                notes: document.getElementById('editCustomerNotes').value
            };
            
            const result = await apiCall('updateCustomer', data);
            
            if (result && result.status === 'success') {
                showStatus('customersStatus', 'âœ… Customer updated successfully!', 'success');
                hideEditCustomerForm();
                loadCustomers();
            } else {
                showStatus('customersStatus', 'âŒ Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        async function deleteCustomer(customerId, customerName) {
            if (!confirm(`Are you sure you want to delete customer "${customerName}"?\n\nThis cannot be undone!`)) {
                return;
            }
            
            const result = await apiCall('deleteCustomer', { customerId });
            
            if (result && result.status === 'success') {
                showStatus('customersStatus', 'âœ… Customer deleted successfully!', 'success');
                loadCustomers();
            } else {
                showStatus('customersStatus', 'âŒ Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        // ==================== PURCHASES ====================

        function showAddPurchaseForm() {
            loadPurchaseDropdowns();
            document.getElementById('addPurchaseForm').style.display = 'block';
        }

        function hideAddPurchaseForm() {
            document.getElementById('addPurchaseForm').style.display = 'none';
            document.querySelector('#addPurchaseForm form').reset();
        }

        async function loadPurchaseDropdowns() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }

            const select = document.getElementById('poSupplier');
            select.innerHTML = '<option value="">Select Supplier</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }

        async function loadSupplierItems() {
            const supplierId = document.getElementById('poSupplier').value;
            
            if (cachedItems.length === 0) {
                const result = await apiCall('getItems');
                if (result && result.status === 'success') {
                    cachedItems = result.data;
                }
            }

            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
            
            document.querySelectorAll('.po-item').forEach(select => {
                select.innerHTML = '<option value="">Select Item</option>';
                supplierItems.forEach(item => {
                    const packageCost = parseFloat(item.Package_Cost) || 0;
                    const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                    select.innerHTML += `<option value="${item.Item_ID}" data-cost="${packageCost.toFixed(2)}" data-units="${unitsPerPackage}">${item.Item_Description}</option>`;
                });
            });
        }

        function addPOLineItem() {
            const container = document.getElementById('poLineItems');
            const supplierId = document.getElementById('poSupplier').value;
            
            if (!supplierId) {
                alert('Please select a supplier first');
                return;
            }
            
            // Get supplier items once
            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
            
            const newRow = document.createElement('div');
            newRow.className = 'line-item-row';
            newRow.innerHTML = `
                <select class="po-item" required>
                    <option value="">Select Item</option>
                    ${supplierItems.map(item => `<option value="${item.Item_ID}" data-units="${item.Units_Per_Package}" data-cost="${item.Package_Cost}" data-uom="${item.Purchase_UOM}">${item.Item_Description}</option>`).join('')}
                </select>
                <input type="number" class="po-qty" placeholder="# of Packages" min="1" required>
                <input type="number" class="po-cost" placeholder="Cost per Package" step="0.01" min="0" required>
                <button type="button" class="remove-btn">âœ•</button>
            `;
            container.appendChild(newRow);
            
            // Attach event listeners programmatically (CSP-safe)
            const itemSelect = newRow.querySelector('.po-item');
            const qtyInput = newRow.querySelector('.po-qty');
            const costInput = newRow.querySelector('.po-cost');
            const removeBtn = newRow.querySelector('.remove-btn');
            
            itemSelect.addEventListener('change', function() {
                updatePOItemInfo(this);
            });
            
            qtyInput.addEventListener('input', function() {
                calculatePOTotal();
            });
            
            costInput.addEventListener('input', function() {
                calculatePOTotal();
            });
            
            removeBtn.addEventListener('click', function() {
                removeLineItem(this);
                calculatePOTotal();
            });
        }
        
        function updatePOItemInfo(selectElement) {
            const option = selectElement.options[selectElement.selectedIndex];
            const cost = option.getAttribute('data-cost');
            
            const row = selectElement.parentElement;
            const costInput = row.querySelector('.po-cost');
            
            if (cost) {
                costInput.value = cost;
            }
            
            calculatePOTotal();
        }
        
        function calculatePOTotal() {
            let total = 0;
            document.querySelectorAll('#poLineItems .line-item-row').forEach(row => {
                const qty = parseInt(row.querySelector('.po-qty')?.value) || 0;
                const cost = parseFloat(row.querySelector('.po-cost')?.value) || 0;
                total += qty * cost;
            });
            const totalField = document.getElementById('poTotal');
            if (totalField) {
                totalField.value = total.toFixed(2);
            }
        }
        
        function calculatePOLine(qtyInput) {
            const row = qtyInput.parentElement;
            const selectElement = row.querySelector('.po-item');
            const option = selectElement.options[selectElement.selectedIndex];
            const units = parseFloat(option.getAttribute('data-units')) || 1;
            const qty = parseFloat(qtyInput.value) || 0;
            const infoSpan = row.querySelector('.po-info');
            const totalUnits = qty * units;
            const uom = option.getAttribute('data-uom');
            
            infoSpan.textContent = `(${units} units/${uom} = ${totalUnits} total units)`;
        }

        function removeLineItem(btn) {
            btn.parentElement.remove();
        }

        async function addPurchase(e) {
            e.preventDefault();
            
            const lineItems = [];
            let calculatedTotal = 0;
            
            document.querySelectorAll('#poLineItems .line-item-row').forEach(row => {
                const itemId = row.querySelector('.po-item').value;
                const qty = parseInt(row.querySelector('.po-qty').value) || 0;
                const cost = parseFloat(row.querySelector('.po-cost').value) || 0;
                const lineTotal = qty * cost;
                
                // Only add valid line items (has item selected, qty > 0)
                if (itemId && qty > 0) {
                    lineItems.push({
                        itemId: itemId,
                        quantity: qty,
                        unitCost: cost
                    });
                    calculatedTotal += lineTotal;
                }
            });

            // Validate at least one line item
            if (lineItems.length === 0) {
                alert('âš ï¸ Please add at least one item to the purchase order.\n\nSelect an item and enter a quantity before saving.');
                return;
            }

            const data = {
                supplierId: document.getElementById('poSupplier').value,
                invoiceNumber: document.getElementById('poInvoiceNumber').value,
                poDate: document.getElementById('poDate').value,
                dueDate: document.getElementById('poDueDate').value || null,
                paymentTerms: document.getElementById('poPaymentTerms').value,
                totalAmount: calculatedTotal,
                amountPaid: parseFloat(document.getElementById('poAmountPaid').value) || 0,
                status: document.getElementById('poStatus').value,
                notes: document.getElementById('poNotes').value,
                lineItems: lineItems,
                poType: 'INCOMING'
            };

            const result = await apiCall('createPurchaseOrder', data);
            
            if (result && result.status === 'success') {
                showStatus('purchasesStatus', 'âœ… Purchase order created! Inventory updated.', 'success');
                hideAddPurchaseForm();
                loadPurchases();
            } else {
                showStatus('purchasesStatus', 'âŒ Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        let purchasesData = []; // Cache for filtering
        
        async function loadPurchases() {
            document.getElementById('purchasesTable').innerHTML = '<div class="loading">Loading purchases...</div>';
            
            // Load suppliers FIRST if not cached
            if (cachedSuppliers.length === 0) {
                const suppResult = await apiCall('getSuppliers');
                if (suppResult && suppResult.status === 'success') {
                    cachedSuppliers = suppResult.data;
                }
            }
            
            // Now load and display purchases
            const result = await apiCall('getPurchaseOrders');
            
            if (result && result.status === 'success') {
                purchasesData = result.data;
                displayPurchases(result.data);
                loadPurchaseFilterSuppliers(); // Populate filter dropdown
            } else {
                document.getElementById('purchasesTable').innerHTML = '<div class="loading">Error loading purchases</div>';
            }
        }
        
        async function loadPurchaseFilterSuppliers() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }
            
            const select = document.getElementById('filterPurchaseSupplier');
            select.innerHTML = '<option value="">All Suppliers</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }
        
        function filterPurchases() {
            const poFilter = document.getElementById('filterPurchasePO').value.toLowerCase();
            const supplierFilter = document.getElementById('filterPurchaseSupplier').value;
            const statusFilter = document.getElementById('filterPurchaseStatus').value;
            const dateFrom = document.getElementById('filterPurchaseDateFrom').value;
            const dateTo = document.getElementById('filterPurchaseDateTo').value;
            const paymentStatusFilter = document.getElementById('filterPurchasePaymentStatus').value;
            
            const filtered = purchasesData.filter(po => {
                const matchesPO = !poFilter || 
                    (po.PO_ID && po.PO_ID.toLowerCase().includes(poFilter)) ||
                    (po.Invoice_Number && po.Invoice_Number.toLowerCase().includes(poFilter));
                const matchesSupplier = !supplierFilter || po.Supplier_ID === supplierFilter;
                
                // Handle exclude-voided option
                let matchesStatus = true;
                if (statusFilter === 'exclude-voided') {
                    matchesStatus = po.Status !== 'Voided';
                } else if (statusFilter) {
                    matchesStatus = po.Status === statusFilter;
                }
                
                const poDate = new Date(po.PO_Date);
                const matchesDateFrom = !dateFrom || poDate >= new Date(dateFrom);
                const matchesDateTo = !dateTo || poDate <= new Date(dateTo);
                const matchesPaymentStatus = !paymentStatusFilter || (po.Payment_Status === paymentStatusFilter);
                return matchesPO && matchesSupplier && matchesStatus && matchesDateFrom && matchesDateTo && matchesPaymentStatus;
            });
            
            displayPurchases(filtered);
        }
        
        function clearPurchaseFilters() {
            document.getElementById('filterPurchasePO').value = '';
            document.getElementById('filterPurchaseSupplier').value = '';
            document.getElementById('filterPurchaseStatus').value = '';
            document.getElementById('filterPurchaseDateFrom').value = '';
            document.getElementById('filterPurchaseDateTo').value = '';
            document.getElementById('filterPurchasePaymentStatus').value = '';
            displayPurchases(purchasesData);
        }

        function displayPurchases(orders) {
            if (!orders || orders.length === 0) {
                document.getElementById('purchasesTable').innerHTML = '<p>No purchase orders yet. Record your first purchase!</p>';
                return;
            }

            // Calculate totals first
            let totalAmount = 0;
            let totalPaid = 0;
            
            orders.forEach(po => {
                totalAmount += parseFloat(po.Total_Amount || po.Invoice_Total) || 0;
                totalPaid += parseFloat(po.Amount_Paid) || 0;
            });
            const balance = totalAmount - totalPaid;
            
            // Summary boxes
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #f57c00;">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Total Purchases</div>
                        <div style="font-size: 28px; font-weight: bold; color: #f57c00;">$${totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="font-size: 12px; color: #888;">${orders.length} orders</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #388e3c;">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Paid</div>
                        <div style="font-size: 28px; font-weight: bold; color: #388e3c;">$${totalPaid.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="font-size: 12px; color: #888;">${((totalPaid/totalAmount)*100 || 0).toFixed(0)}% paid</div>
                    </div>
                    <div style="background: linear-gradient(135deg, ${balance > 0 ? '#ffebee, #ffcdd2' : '#e8f5e9, #c8e6c9'}); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid ${balance > 0 ? '#c62828' : '#388e3c'};">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Outstanding</div>
                        <div style="font-size: 28px; font-weight: bold; color: ${balance > 0 ? '#c62828' : '#388e3c'};">$${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="font-size: 12px; color: #888;">${balance > 0 ? 'to pay' : 'all paid!'}</div>
                    </div>
                </div>
            `;
            
            html += '<table class="data-table" id="purchasesDataTable"><thead><tr>';
            html += '<th>Invoice #</th><th>Supplier</th><th>Date</th><th>Status</th><th>Total</th><th>Paid</th><th>Due Date</th><th>Payment</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            orders.forEach(po => {
                const dueDate = po.Due_Date ? new Date(po.Due_Date).toLocaleDateString() : '-';
                const paymentStatus = po.Payment_Status || 'Unpaid';
                const amountPaid = parseFloat(po.Amount_Paid) || 0;
                const total = parseFloat(po.Total_Amount || po.Invoice_Total) || 0;
                
                // Color code payment status
                let paymentBadge = '';
                if (paymentStatus === 'Paid') paymentBadge = '<span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Paid</span>';
                else if (paymentStatus === 'Partial') paymentBadge = '<span style="background: #ffc107; color: black; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Partial</span>';
                else paymentBadge = '<span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Unpaid</span>';
                
                html += `<tr style="cursor: pointer;" onclick="viewPurchaseOrder('${po.PO_ID}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                    <td><strong>${po.Invoice_Number || po.PO_ID}</strong></td>
                    <td>${getSupplierName(po.Supplier_ID)}</td>
                    <td>${new Date(po.PO_Date).toLocaleDateString()}</td>
                    <td><span style="background: ${po.Status === 'Ordered' ? '#ffc107' : po.Status === 'Void' || po.Status === 'Cancelled' ? '#dc3545' : po.Status === 'Partial' ? '#17a2b8' : '#28a745'}; color: ${po.Status === 'Ordered' ? 'black' : 'white'}; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${po.Status === 'Void' ? 'â›” VOID' : po.Status === 'Cancelled' ? 'âŒ CANCELLED' : po.Status || 'Received'}</span></td>
                    <td>$${total.toFixed(2)}</td>
                    <td>$${amountPaid.toFixed(2)}</td>
                    <td>${dueDate}</td>
                    <td>${paymentBadge}</td>
                    <td onclick="event.stopPropagation();">
                        ${po.Status === 'Ordered' ? `<button class="btn-small" onclick="receiveOutgoingPO('${po.PO_ID}')" style="background: #28a745; color: white;">ğŸ“¦ Receive</button>` : ''}
                        ${po.Status === 'Void' || po.Status === 'Cancelled' ? `<button class="btn-small" onclick="duplicatePO('${po.PO_ID}')" style="background: #17a2b8; color: white;">ğŸ“‹ Copy to New PO</button>` : ''}
                        <button class="btn-small" onclick="viewPurchaseOrder('${po.PO_ID}')" style="background: #17a2b8; color: white; padding: 6px 12px;">View/Print</button>
                    </td>
                </tr>`;
            });

            // Add totals row
            html += `<tr style="background: #f0f0f0; font-weight: bold; border-top: 3px solid #667eea;">
                <td colspan="4" style="text-align: right; padding-right: 20px;">TOTALS:</td>
                <td>$${totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>$${totalPaid.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td colspan="3" style="text-align: left;">Balance: <strong style="color: ${balance > 0 ? '#dc3545' : '#28a745'};">$${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
            </tr>`;

            html += '</tbody></table>';
            document.getElementById('purchasesTable').innerHTML = html;
            setTimeout(() => makeSortable('purchasesDataTable'), 0);
        }
        
        // Edit Purchase Order
        let currentEditingOrder = null;
        let currentEditingType = null; // 'purchase' or 'sales'
        let returnToTab = null; // Track which tab to return to after closing modal
        
        // View Purchase Order (from row click or button)
        function viewPurchaseOrder(poId) {
            const po = purchasesData.find(p => p.PO_ID === poId);
            if (po) {
                showPurchaseOrderDetails(po);
            }
        }
        
        async function editPurchaseOrder(poId) {
            // Find the PO in cached data or fetch it
            const result = await apiCall('getPurchaseOrders');
            if (result && result.status === 'success') {
                const po = result.data.find(p => p.PO_ID === poId);
                if (po) {
                    showPurchaseOrderDetails(po);
                }
            }
        }
        
        async function showPurchaseOrderDetails(po) {
            currentEditingOrder = po;
            currentEditingType = 'purchase';
            
            // Load items if not cached
            if (cachedItems.length === 0) {
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
            }
            
            // Get line items
            const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
            const lines = linesResult?.data || [];
            
            const supplierName = getSupplierName(po.Supplier_ID);
            const dueDate = po.Due_Date ? new Date(po.Due_Date).toLocaleDateString() : '-';
            const billDate = po.Bill_Date ? new Date(po.Bill_Date).toLocaleDateString() : '-';
            
            // Status color logic
            const statusColor = po.Status === 'Void' || po.Status === 'Cancelled' ? '#dc3545' : 
                               po.Status === 'Ordered' ? '#ffc107' : 
                               po.Status === 'Partial' ? '#17a2b8' : '#28a745';
            const statusTextColor = po.Status === 'Ordered' ? '#000' : '#fff';
            const statusText = po.Status === 'Void' ? 'â›” VOID' : 
                              po.Status === 'Cancelled' ? 'âŒ CANCELLED' : po.Status;
            
            document.getElementById('modalTitle').textContent = `Purchase Order: ${po.PO_ID}`;
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Order Information</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px 0; font-weight: bold; width: 140px;">Supplier:</td><td>${supplierName}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Invoice #:</td><td>${po.Invoice_Number || '-'}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">PO Date:</td><td>${new Date(po.PO_Date).toLocaleDateString()}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Bill Date:</td><td>${billDate}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Due Date:</td><td>${dueDate}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Status:</td><td><span style="background: ${statusColor}; color: ${statusTextColor}; padding: 4px 12px; border-radius: 12px; font-size: 12px;">${statusText}</span></td></tr>
                        </table>
                        ${po.Status === 'Ordered' ? `
                        <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #c0c0c0;">
                            <strong>âš ï¸ Prices Changed?</strong>
                            <p style="margin: 5px 0 10px 0; font-size: 13px; color: #666;">If supplier prices have changed, void this PO and create a new one with updated prices.</p>
                            <button class="btn" onclick="voidPurchaseOrder('${po.PO_ID}')" style="background: #dc3545; padding: 6px 12px; font-size: 13px;">
                                â›” Void This PO
                            </button>
                        </div>
                        ` : ''}
                        ${po.Status === 'Void' || po.Status === 'Cancelled' ? `
                        <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #c0c0c0;">
                            <strong>ğŸ“‹ Need to Reorder?</strong>
                            <p style="margin: 5px 0 10px 0; font-size: 13px; color: #666;">Copy this PO's items to create a new order with current prices.</p>
                            <button class="btn" onclick="duplicatePO('${po.PO_ID}'); closeModal();" style="background: #17a2b8; padding: 6px 12px; font-size: 13px;">
                                ğŸ“‹ Copy to New PO
                            </button>
                        </div>
                        ` : ''}
                    </div>
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Payment Information</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px 0; font-weight: bold; width: 140px;">Total Amount:</td><td style="font-size: 18px; color: #2c3e50;">$${parseFloat(po.Total_Amount || 0).toFixed(2)}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Amount Paid:</td><td style="color: #27ae60;">$${parseFloat(po.Amount_Paid || 0).toFixed(2)}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Balance Due:</td><td style="color: #e74c3c; font-size: 16px; font-weight: bold;">$${(parseFloat(po.Total_Amount || 0) - parseFloat(po.Amount_Paid || 0)).toFixed(2)}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Payment Status:</td><td><span style="background: ${po.Payment_Status === 'Paid' ? '#d4edda' : '#fff3cd'}; color: ${po.Payment_Status === 'Paid' ? '#155724' : '#856404'}; padding: 4px 12px; border-radius: 12px; font-size: 12px;">${po.Payment_Status}</span></td></tr>
                        </table>
                        ${po.Payment_Status !== 'Paid' && po.Status !== 'Void' && po.Status !== 'Cancelled' ? `
                        <div style="margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 8px;">
                            <div style="margin-bottom: 10px;"><strong>ğŸ’µ Quick Payment</strong></div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="number" id="quickPaymentAmount" step="0.01" min="0" 
                                       value="${(parseFloat(po.Total_Amount || 0) - parseFloat(po.Amount_Paid || 0)).toFixed(2)}"
                                       style="width: 120px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <button class="btn" onclick="if(event && debounceButton(event.currentTarget)) recordQuickPOPayment('${po.PO_ID}')" 
                                        style="background: #28a745; padding: 8px 15px;">
                                    ğŸ’µ Record Payment
                                </button>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            if (lines.length > 0) {
                html += `
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">ğŸ“¦ Line Items</h3>
                    <div style="overflow-x: auto;">
                    <table class="data-table" style="margin-bottom: 20px; font-size: 14px;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th style="padding: 12px 15px;">Item</th>
                                <th style="padding: 12px 15px;">Description</th>
                                <th style="padding: 12px 15px;">Qty</th>
                                <th style="padding: 12px 15px;">Unit Cost</th>
                                <th style="padding: 12px 15px;">Line Total</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                lines.forEach(line => {
                    const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                    const lineTotal = (parseFloat(line.Quantity) || 0) * (parseFloat(line.Unit_Cost) || 0);
                    html += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px 15px;"><strong>${item?.SKU || line.Item_ID}</strong></td>
                            <td style="padding: 12px 15px;">${item ? item.Item_Description : '-'}</td>
                            <td style="padding: 12px 15px; text-align: center; font-weight: bold;">${line.Quantity}</td>
                            <td style="padding: 12px 15px; text-align: right;">$${parseFloat(line.Unit_Cost || 0).toFixed(2)}</td>
                            <td style="padding: 12px 15px; text-align: right; font-weight: bold;">$${lineTotal.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                    </div>
                `;
            }
            
            if (po.Notes) {
                html += `
                    <div style="margin-top: 20px;">
                        <h3 style="color: var(--primary, #667eea); margin-bottom: 10px;">Notes</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #c0c0c0;">
                            ${po.Notes}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalEditBtn').style.display = 'inline-block';
            document.getElementById('modalPrintBtn').style.display = 'inline-block';
            document.getElementById('modalPrintBtn').textContent = 'ğŸ–¨ï¸ Print PO';
            document.getElementById('modalPrintBtn').onclick = () => printPurchaseOrder();
            document.getElementById('modalSaveBtn').style.display = 'none';
            document.getElementById('orderModal').style.display = 'block'; document.body.classList.add('modal-open');
        }
        
        async function recordQuickPOPayment(poId) {
            const paymentInput = document.getElementById('quickPaymentAmount');
            const paymentAmount = parseFloat(paymentInput.value) || 0;
            
            if (paymentAmount <= 0) {
                alert('Please enter a payment amount greater than 0');
                return;
            }
            
            const result = await apiCall('recordPurchasePayment', {
                poId: poId,
                paymentAmount: paymentAmount
            });
            
            if (result && result.status === 'success') {
                alert(`âœ… Payment recorded!\n\nTotal Paid: $${result.totalPaid.toFixed(2)}\nStatus: ${result.paymentStatus}`);
                document.getElementById('orderModal').style.display = 'none';
                loadPurchases();
            } else {
                alert('âŒ Error: ' + (result?.message || 'Unknown error'));
            }
        }
        
        // PRINT PURCHASE ORDER FUNCTION
        async function printPurchaseOrder() {
            if (!currentEditingOrder || currentEditingType !== 'purchase') {
                alert('Please select a purchase order first');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('Please allow popups for this site');
                return;
            }
            printWindow.document.write('<html><body><h2>Loading PO...</h2></body></html>');
            
            const po = currentEditingOrder;
            const settings = getInvoiceSettings();
            
            // Get supplier details
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === po.Supplier_ID);
            
            // Get line items
            const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
            const lines = linesResult?.data || [];
            
            // Calculate totals
            let subtotal = 0;
            lines.forEach(line => {
                subtotal += (parseFloat(line.Quantity) || 0) * (parseFloat(line.Unit_Cost) || 0);
            });
            
            const total = parseFloat(po.Total_Amount || subtotal);
            const paid = parseFloat(po.Amount_Paid || 0);
            const balance = total - paid;
            
            // Get theme colors for print
            const themeColors = getThemeColors();
            
            let poHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Purchase Order ${po.Invoice_Number || po.PO_ID}</title>
    <style>
        @media print {
            @page { margin: 0.5in; }
            body { margin: 0; }
            .no-print { display: none; }
        }
        body {
            font-family: Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.4;
            max-width: 8in;
            margin: 0 auto;
            padding: 0.5in;
        }
        .po-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid ${themeColors.primary};
            padding-bottom: 20px;
        }
        .po-header h1 {
            color: ${themeColors.text};
            margin: 0 0 10px 0;
            font-size: 28pt;
        }
        .po-number {
            font-size: 14pt;
            font-weight: bold;
            margin: 5px 0;
        }
        .po-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .info-box {
            width: 45%;
        }
        .info-box h3 {
            color: ${themeColors.text};
            border-bottom: 2px solid ${themeColors.primary};
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .info-box p {
            margin: 5px 0;
        }
        table.items {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        table.items th {
            background: ${themeColors.primary};
            color: white;
            padding: 12px 10px;
            text-align: left;
        }
        table.items td {
            border: 1px solid #ddd;
            padding: 10px;
        }
        .totals {
            margin-top: 30px;
            float: right;
            width: 40%;
        }
        .totals table { width: 100%; }
        .totals td { padding: 8px 10px; border-bottom: 1px solid #eee; }
        .totals .label { text-align: right; font-weight: bold; }
        .totals .value { text-align: right; width: 40%; }
        .total-line { border-top: 2px solid ${themeColors.primary} !important; font-size: 14pt; font-weight: bold; }
        .footer {
            clear: both;
            margin-top: 60px;
            padding-top: 20px;
            border-top: 2px solid ${themeColors.primary};
            text-align: center;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="po-header">
        <h1>${settings.companyName}</h1>
        <p>${settings.address1}</p>
        ${settings.address2 ? `<p>${settings.address2}</p>` : ''}
        <p>${settings.cityStateZip}</p>
        <p>Phone: ${settings.phone} | Email: ${settings.email}</p>
    </div>

    <div class="po-number">PURCHASE ORDER: ${po.Invoice_Number || po.PO_ID}</div>
    <p><strong>PO Date:</strong> ${new Date(po.PO_Date).toLocaleDateString()} | <strong>Status:</strong> ${po.Status || 'Received'}</p>

    <div class="po-info">
        <div class="info-box">
            <h3>Supplier:</h3>
            <p><strong>${supplier?.Supplier_Name || 'Unknown Supplier'}</strong></p>
            ${supplier?.Contact_Name ? `<p>Attn: ${supplier.Contact_Name}</p>` : ''}
            ${supplier?.Address ? `<p>${supplier.Address}</p>` : ''}
            ${supplier?.City || supplier?.State ? `<p>${supplier.City || ''}, ${supplier.State || ''} ${supplier.ZIP || ''}</p>` : ''}
            ${supplier?.Phone ? `<p>Phone: ${supplier.Phone}</p>` : ''}
        </div>
        <div class="info-box">
            <h3>Payment Info:</h3>
            <p><strong>Terms:</strong> ${supplier?.Payment_Terms || 'Net 30'}</p>
            <p><strong>Due Date:</strong> ${po.Due_Date ? new Date(po.Due_Date).toLocaleDateString() : '-'}</p>
            <p><strong>Status:</strong> ${po.Payment_Status || 'Unpaid'}</p>
        </div>
    </div>

    <table class="items">
        <thead>
            <tr>
                <th style="width: 10%;">QTY</th>
                <th style="width: 50%;">DESCRIPTION</th>
                <th style="width: 20%; text-align: right;">UNIT COST</th>
                <th style="width: 20%; text-align: right;">AMOUNT</th>
            </tr>
        </thead>
        <tbody>`;
            
            lines.forEach(line => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                const lineTotal = (parseFloat(line.Quantity) || 0) * (parseFloat(line.Unit_Cost) || 0);
                
                poHTML += `
            <tr>
                <td style="text-align: center;">${line.Quantity}</td>
                <td>${item?.Item_Description || line.Item_ID}</td>
                <td style="text-align: right;">$${parseFloat(line.Unit_Cost || 0).toFixed(2)}</td>
                <td style="text-align: right;">$${lineTotal.toFixed(2)}</td>
            </tr>`;
            });
            
            poHTML += `
        </tbody>
    </table>

    <div class="totals">
        <table>
            <tr>
                <td class="label">SUBTOTAL:</td>
                <td class="value">$${subtotal.toFixed(2)}</td>
            </tr>
            <tr class="total-line">
                <td class="label">TOTAL:</td>
                <td class="value">$${total.toFixed(2)}</td>
            </tr>
            ${paid > 0 ? `
            <tr>
                <td class="label">PAID:</td>
                <td class="value">$${paid.toFixed(2)}</td>
            </tr>` : ''}
            ${balance > 0 ? `
            <tr>
                <td class="label" style="color: #c62828;">BALANCE DUE:</td>
                <td class="value" style="color: #c62828; font-weight: bold;">$${balance.toFixed(2)}</td>
            </tr>` : ''}
        </table>
    </div>

    <div class="footer">
        ${po.Notes ? `<p><strong>Notes:</strong> ${po.Notes}</p>` : ''}
    </div>

    <div class="no-print" style="position: fixed; top: 20px; right: 20px;">
        <button onclick="window.print()" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: ${themeColors.primary}; color: white; border: none; border-radius: 5px; margin-right: 10px;">ğŸ–¨ï¸ Print</button>
        <button onclick="window.close()" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: var(--primary, #667eea); color: white; border: none; border-left: 4px solid rgba(255,255,255,0.4); border-radius: 5px;">âœ• Close</button>
    </div>

</body>
</html>`;
            
            printWindow.document.open();
            printWindow.document.write(poHTML);
            printWindow.document.close();
        }
        
        // PRINT INVOICE FUNCTION
        async function printInvoice() {
            if (!currentEditingOrder || currentEditingType !== 'sales') {
                alert('Please select a sales order first');
                return;
            }
            
            // CRITICAL: Open window BEFORE any async calls to avoid iPhone popup blocker
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('Please allow popups for this site');
                return;
            }
            printWindow.document.write('<html><body><h2>Loading invoice...</h2></body></html>');
            
            const so = currentEditingOrder;
            const settings = getInvoiceSettings();
            
            // Get customer details
            const customersResult = await apiCall('getCustomers');
            const customer = customersResult.data.find(c => c.Customer_ID === so.Customer_ID);
            
            // Get line items
            const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
            const lines = linesResult?.data || [];
            
            // Calculate totals
            let subtotal = 0;
            lines.forEach(line => {
                subtotal += parseFloat(line.Line_Total || 0);
            });
            
            const total = parseFloat(so.Total_Amount || 0);
            const paid = parseFloat(so.Amount_Paid || 0);
            const balance = total - paid;
            
            // Get theme colors for print
            const themeColors = getThemeColors();
            
            // Build invoice HTML with PO-style layout
            let invoiceHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Invoice ${so.Invoice_Number || so.SO_ID}</title>
    <style>
        @media print {
            @page { margin: 0.5in; }
            body { margin: 0; }
            .no-print { display: none; }
        }
        body {
            font-family: Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.4;
            max-width: 8in;
            margin: 0 auto;
            padding: 0.5in;
        }
        .invoice-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid ${themeColors.primary};
            padding-bottom: 20px;
        }
        .invoice-header h1 {
            color: ${themeColors.text};
            margin: 0 0 10px 0;
            font-size: 28pt;
        }
        .invoice-number {
            font-size: 14pt;
            font-weight: bold;
            margin: 5px 0;
        }
        .invoice-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .info-box {
            flex: 1;
        }
        .info-box h3 {
            margin: 0 0 10px 0;
            color: ${themeColors.text};
        }
        .info-box p {
            margin: 2px 0;
        }
        table.items {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        table.items th {
            background: ${themeColors.primary};
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        table.items td {
            border: 1px solid #ddd;
            padding: 10px;
        }
        table.items .qty { text-align: center; width: 10%; }
        table.items .desc { width: 50%; }
        table.items .price { text-align: right; width: 20%; }
        table.items .amount { text-align: right; width: 20%; }
        .totals {
            margin-top: 30px;
            float: right;
            width: 40%;
        }
        .totals table {
            width: 100%;
        }
        .totals td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
        }
        .totals .label {
            text-align: right;
            font-weight: bold;
        }
        .totals .value {
            text-align: right;
            width: 40%;
        }
        .total-line {
            border-top: 2px solid ${themeColors.primary} !important;
            border-bottom: 3px double ${themeColors.primary} !important;
            font-size: 14pt;
            font-weight: bold;
        }
        .footer {
            clear: both;
            margin-top: 60px;
            padding-top: 20px;
            border-top: 2px solid ${themeColors.primary};
            text-align: center;
            font-style: italic;
            color: #666;
        }
        .signature {
            margin-top: 40px;
            padding-top: 10px;
            border-top: 1px solid #000;
            width: 300px;
            white-space: nowrap;
        }
    </style>
</head>
<body>

    <div class="invoice-header">
        <h1>SALES INVOICE</h1>
        <p style="font-size: 16pt; margin: 5px 0;">${settings.companyName}</p>
        <div class="invoice-number">#${so.Invoice_Number || so.SO_ID}</div>
        <p>Date: ${so.Sale_Date ? new Date(so.Sale_Date).toLocaleDateString() : new Date(so.SO_Date).toLocaleDateString()}</p>
    </div>

    <div class="invoice-info">
        <div class="info-box">
            <h3>From:</h3>
            <p><strong>${settings.companyName}</strong></p>
            ${settings.contactName ? `<p>${settings.contactName}</p>` : ''}
            <p>${settings.address1}</p>
            ${settings.address2 ? `<p>${settings.address2}</p>` : ''}
            <p>${settings.cityStateZip}</p>
            <p>Phone: ${settings.phone}</p>
            <p>Email: ${settings.email}</p>
        </div>
        <div class="info-box">
            <h3>Bill To:</h3>
            <p><strong>${customer?.Customer_Name || 'Unknown Customer'}</strong></p>
            ${customer?.Contact_Name ? `<p>Attn: ${customer.Contact_Name}</p>` : ''}
            ${customer?.Address ? `<p>${customer.Address}</p>` : ''}
            ${customer?.City || customer?.State || customer?.ZIP ? `<p>${customer.City || ''}${customer.City && customer.State ? ', ' : ''}${customer.State || ''} ${customer.ZIP || ''}</p>` : ''}
            ${customer?.Phone ? `<p>Phone: ${customer.Phone}</p>` : ''}
        </div>
    </div>

    <table class="items">
        <thead>
            <tr>
                <th class="qty">QTY</th>
                <th class="desc">DESCRIPTION</th>
                <th class="price">PRICE</th>
                <th class="amount">AMOUNT</th>
            </tr>
        </thead>
        <tbody>`;
            
            // Add line items
            lines.forEach(line => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                const lineTotal = parseFloat(line.Line_Total || 0);
                
                invoiceHTML += `
            <tr>
                <td class="qty">${line.Quantity}</td>
                <td class="desc">${item?.Item_Description || line.Item_ID}</td>
                <td class="price">$${parseFloat(line.Unit_Price || 0).toFixed(2)}</td>
                <td class="amount">$${lineTotal.toFixed(2)}</td>
            </tr>`;
            });
            
            invoiceHTML += `
        </tbody>
    </table>

    <div class="totals">
        <table>
            <tr>
                <td class="label">SUBTOTAL:</td>
                <td class="value">$${subtotal.toFixed(2)}</td>
            </tr>
            <tr class="total-line">
                <td class="label">TOTAL:</td>
                <td class="value">$${total.toFixed(2)}</td>
            </tr>
            ${paid > 0 ? `
            <tr>
                <td class="label">PAID:</td>
                <td class="value">$${paid.toFixed(2)}</td>
            </tr>` : ''}
            ${balance > 0 ? `
            <tr style="background: #fff3cd;">
                <td class="label">BALANCE DUE:</td>
                <td class="value" style="color: #e74c3c; font-weight: bold;">$${balance.toFixed(2)}</td>
            </tr>` : ''}
        </table>
    </div>

    <div class="footer">
        Thank you for doing Business with ${settings.companyName}
    </div>

    <div class="signature">
        Signature: ___________________________
    </div>

    <p style="clear: both; text-align: center; margin-top: 40px; font-size: 9pt; color: #999;">
        KEEP THIS SLIP FOR REFERENCE
    </p>

    <div class="no-print" style="position: fixed; top: 20px; right: 20px;">
        <button onclick="window.print()" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: ${themeColors.primary}; color: white; border: none; border-radius: 5px; margin-right: 10px;">ğŸ–¨ï¸ Print</button>
        <button onclick="window.close()" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: var(--primary, #667eea); color: white; border: none; border-left: 4px solid rgba(255,255,255,0.4); border-radius: 5px;">âœ• Close</button>
    </div>

</body>
</html>`;
            
            // Clear the loading message and write the final invoice
            printWindow.document.open();
            printWindow.document.write(invoiceHTML);
            printWindow.document.close();
        }
        
        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
            currentEditingOrder = null;
            currentEditingType = null;
            
            // Only remove modal-open if no other modals are open
            const reportModal = document.getElementById('reportSetupModal');
            if (!reportModal || reportModal.style.display === 'none') {
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
            }
            
            // Return to previous tab if we came from Reports
            if (returnToTab === 'reports') {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="reports"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('reports').classList.add('active');
                returnToTab = null;
            }
        }
        
        function enableEditMode() {
            if (currentEditingType === 'purchase') {
                enablePurchaseOrderEdit();
            } else if (currentEditingType === 'sales') {
                enableSalesOrderEdit();
            }
        }
        
        async function enablePurchaseOrderEdit() {
            const po = currentEditingOrder;
            
            // Load items and suppliers if not cached
            if (cachedItems.length === 0) {
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
            }
            if (cachedSuppliers.length === 0) {
                const suppResult = await apiCall('getSuppliers');
                if (suppResult && suppResult.status === 'success') {
                    cachedSuppliers = suppResult.data;
                }
            }
            
            // Get line items
            const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
            const lines = linesResult?.data || [];
            
            const supplierName = getSupplierName(po.Supplier_ID);
            
            document.getElementById('modalTitle').textContent = `Edit Purchase Order: ${po.PO_ID}`;
            
            // Build supplier dropdown
            let supplierOptions = '<option value="">Select Supplier</option>';
            cachedSuppliers.forEach(s => {
                supplierOptions += `<option value="${s.Supplier_ID}" ${s.Supplier_ID === po.Supplier_ID ? 'selected' : ''}>${s.Supplier_Name}</option>`;
            });
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Order Information</h3>
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="editPOSupplier" required>${supplierOptions}</select>
                        </div>
                        <div class="form-group">
                            <label>Invoice Number</label>
                            <input type="text" id="editPOInvoiceNumber" value="${po.Invoice_Number || ''}">
                        </div>
                        <div class="form-group">
                            <label>PO Date</label>
                            <input type="date" id="editPODate" value="${po.PO_Date ? new Date(po.PO_Date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="editPODueDate" value="${po.Due_Date ? new Date(po.Due_Date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="editPOStatus">
                                <option value="Ordered" ${po.Status === 'Ordered' ? 'selected' : ''}>Ordered (Pending Delivery)</option>
                                <option value="Received" ${po.Status === 'Received' ? 'selected' : ''}>Received</option>
                                <option value="Partial" ${po.Status === 'Partial' ? 'selected' : ''}>Partially Received</option>
                                <option value="Void" ${po.Status === 'Void' ? 'selected' : ''}>â›” Void (Prices Changed)</option>
                                <option value="Cancelled" ${po.Status === 'Cancelled' ? 'selected' : ''}>âŒ Cancelled</option>
                            </select>
                            <small style="color: #666; display: block; margin-top: 5px;">Use "Void" if supplier prices changed and you need to create a new PO</small>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Payment Information</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="margin-bottom: 10px;">
                                <strong>Current Total:</strong> $${parseFloat(po.Total_Amount || 0).toFixed(2)}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Previously Paid:</strong> $${parseFloat(po.Amount_Paid || 0).toFixed(2)}
                            </div>
                            <div>
                                <strong>Balance Due:</strong> <span style="color: #e74c3c;">$${(parseFloat(po.Total_Amount || 0) - parseFloat(po.Amount_Paid || 0)).toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ğŸ’µ Amount Paid</label>
                            <div style="position: relative; display: flex; align-items: center;">
                                <span style="position: absolute; left: 12px; font-size: 16px; font-weight: bold; color: #666;">$</span>
                                <input type="number" id="editPOAmountPaid" step="0.01" min="0" placeholder="0.00" value="${parseFloat(po.Amount_Paid || 0).toFixed(2)}" style="padding-left: 28px; font-size: 16px; font-weight: 600;">
                            </div>
                            <small style="color: #666;">ğŸ’¡ Enter numbers only (e.g., 115.46 for $115.46)</small>
                        </div>
                        <div style="color: #666; font-size: 13px; background: #fff3cd; padding: 10px; border-radius: 6px;">
                            âš ï¸ Total will recalculate based on line items below
                        </div>
                    </div>
                </div>
                
                <h3 style="color: #667eea; margin-bottom: 15px;">Line Items</h3>
                <div id="editPOLineItems">
            `;
            
            // Add existing line items as editable rows
            lines.forEach((line, index) => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                html += createEditableLineItem('PO', line, index, item);
            });
            
            html += `
                </div>
                <button type="button" class="btn btn-secondary" onclick="addEditLineItem('PO')" style="margin-top: 10px;">+ Add Line Item</button>
                
                <div class="form-group" style="margin-top: 30px;">
                    <label>Notes</label>
                    <textarea id="editPONotes" rows="3" style="width: 100%;">${po.Notes || ''}</textarea>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            
            // Attach event listeners to all PO line items in the edit modal
            console.log('Attaching listeners to PO edit modal line items'); // DEBUG
            document.querySelectorAll('#editPOLineItems .edit-line-item').forEach(row => {
                attachEditLineItemListeners(row);
            });
            
            document.getElementById('modalEditBtn').style.display = 'none';
            document.getElementById('modalSaveBtn').style.display = 'inline-block';
        }
        
        function createEditableLineItem(type, line, index, item) {
            // Make sure items are loaded
            if (cachedItems.length === 0) {
                console.error('cachedItems is empty!');
            }
            
            const itemOptions = cachedItems
                .filter(i => type === 'PO' ? i.Supplier_ID === currentEditingOrder.Supplier_ID : true)
                .map(i => {
                    const priceAttr = type === 'PO' ? `data-cost="${i.Package_Cost}"` : `data-price="${i.Unit_Sell_Price}"`;
                    return `<option value="${i.Item_ID}" ${priceAttr} ${i.Item_ID === line.Item_ID ? 'selected' : ''}>${i.Item_Description}</option>`;
                })
                .join('');
            
            console.log('Items for dropdown:', cachedItems.length, 'Filtered:', itemOptions.length);
            
            const qtyField = type === 'PO' ? 'Quantity' : 'Quantity';
            const priceField = type === 'PO' ? 'Unit_Cost' : 'Unit_Price';
            const originalQty = parseFloat(line[qtyField]) || 0;
            const originalPrice = parseFloat(line[priceField]) || 0;
            
            return `
                <div class="edit-line-item" data-type="${type}" data-original-item="${line.Item_ID}" data-original-qty="${originalQty}" data-line-id="${line.Line_ID || ''}" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 50px; gap: 10px; margin-bottom: 10px; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <select class="edit-item" required>
                        <option value="">Select Item</option>
                        ${itemOptions}
                    </select>
                    <input type="number" class="edit-qty" placeholder="Qty" min="1" required value="${originalQty}">
                    <input type="number" class="edit-price" placeholder="${type === 'PO' ? 'Cost' : 'Price'}" step="0.01" min="0" required value="${originalPrice}">
                    <input type="text" class="edit-total" readonly style="background: #e9ecef; font-weight: bold;" value="$${(originalQty * originalPrice).toFixed(2)}">
                    <button type="button" class="remove-btn" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px; cursor: pointer;">âœ•</button>
                </div>
            `;
        }
        
        function calculateEditLineTotal(input) {
            const row = input.closest('.edit-line-item');
            const qty = parseFloat(row.querySelector('.edit-qty').value) || 0;
            const price = parseFloat(row.querySelector('.edit-price').value) || 0;
            const total = qty * price;
            row.querySelector('.edit-total').value = '$' + total.toFixed(2);
            
            // Update payment info if this is a sales order
            if (row.getAttribute('data-type') === 'SO') {
                updateEditPaymentInfo();
            }
        }
        
        function updateEditPaymentInfo() {
            // Calculate new total from all line items
            let newTotal = 0;
            document.querySelectorAll('#editSOLineItems .edit-line-item').forEach(row => {
                const qty = parseFloat(row.querySelector('.edit-qty').value) || 0;
                const price = parseFloat(row.querySelector('.edit-price').value) || 0;
                newTotal += qty * price;
            });
            
            // Get previously paid amount
            const previouslyPaid = parseFloat(document.getElementById('editSOAmountPaid')?.value) || 0;
            
            // Calculate balance due
            const balanceDue = newTotal - previouslyPaid;
            
            // Update the display fields using IDs
            const currentTotalDiv = document.getElementById('editSOCurrentTotal');
            const balanceDueDiv = document.getElementById('editSOBalanceDue');
            
            if (currentTotalDiv) {
                currentTotalDiv.innerHTML = `<strong>Current Total:</strong> $${newTotal.toFixed(2)}`;
            }
            
            if (balanceDueDiv) {
                balanceDueDiv.innerHTML = `<strong>Balance Due:</strong> <span style="color: #e74c3c;">$${balanceDue.toFixed(2)}</span>`;
            }
        }
        
        function attachEditLineItemListeners(row) {
            const type = row.getAttribute('data-type');
            const itemSelect = row.querySelector('.edit-item');
            const qtyInput = row.querySelector('.edit-qty');
            const priceInput = row.querySelector('.edit-price');
            const removeBtn = row.querySelector('.remove-btn');
            
            console.log('Attaching edit modal listeners, type:', type); // DEBUG
            
            // Auto-fill price when item selected
            itemSelect.addEventListener('change', function() {
                console.log('Edit modal item changed!'); // DEBUG
                const option = this.options[this.selectedIndex];
                const priceAttr = type === 'PO' ? 'data-cost' : 'data-price';
                const price = option.getAttribute(priceAttr);
                console.log('Price from data attribute:', price); // DEBUG
                
                if (price) {
                    priceInput.value = price;
                    calculateEditLineTotal(qtyInput);
                }
            });
            
            // Recalculate when qty or price changes
            qtyInput.addEventListener('input', function() {
                calculateEditLineTotal(this);
            });
            
            priceInput.addEventListener('input', function() {
                calculateEditLineTotal(this);
            });
            
            // Remove button
            removeBtn.addEventListener('click', function() {
                if (confirm('Remove this line item?')) {
                    row.remove();
                    // Update payment info if this is a sales order
                    if (type === 'SO') {
                        updateEditPaymentInfo();
                    }
                }
            });
            
            console.log('Edit modal listeners attached!'); // DEBUG
        }
        
        function addEditLineItem(type) {
            const container = document.getElementById(type === 'PO' ? 'editPOLineItems' : 'editSOLineItems');
            const newLine = {
                Item_ID: '',
                Quantity: 0,
                [type === 'PO' ? 'Unit_Cost' : 'Unit_Price']: 0
            };
            const newItem = createEditableLineItem(type, newLine, -1, null);
            container.insertAdjacentHTML('beforeend', newItem);
            
            // Attach listeners to the newly added item
            const newRow = container.lastElementChild;
            attachEditLineItemListeners(newRow);
        }
        
        function removeEditLineItem(btn) {
            if (confirm('Remove this line item?')) {
                btn.closest('.edit-line-item').remove();
            }
        }
        
        async function saveOrderChanges() {
            if (currentEditingType === 'purchase') {
                await savePurchaseOrderChanges();
            } else if (currentEditingType === 'sales') {
                await saveSalesOrderChanges();
            }
        }
        
        async function savePurchaseOrderChanges() {
            const po = currentEditingOrder;
            
            // Collect line items
            const newLines = [];
            let totalAmount = 0;
            
            document.querySelectorAll('#editPOLineItems .edit-line-item').forEach(row => {
                const itemId = row.querySelector('.edit-item').value;
                const qty = parseInt(row.querySelector('.edit-qty').value) || 0;
                const cost = parseFloat(row.querySelector('.edit-price').value) || 0;
                
                if (itemId && qty > 0) {
                    newLines.push({
                        itemId: itemId,
                        quantity: qty,
                        unitCost: cost,
                        originalItem: row.dataset.originalItem,
                        originalQty: parseInt(row.dataset.originalQty) || 0,
                        lineId: row.dataset.lineId
                    });
                    totalAmount += qty * cost;
                }
            });
            
            console.log('Total lines collected:', newLines.length);
            
            if (newLines.length === 0) {
                const rowCount = document.querySelectorAll('#editPOLineItems .edit-line-item').length;
                alert(`No valid line items found!\n\nRows found: ${rowCount}\n\nPlease make sure each line has:\n- An item selected\n- A quantity > 0`);
                return;
            }
            
            const data = {
                poId: po.PO_ID,
                supplierId: document.getElementById('editPOSupplier').value,
                invoiceNumber: document.getElementById('editPOInvoiceNumber').value,
                poDate: document.getElementById('editPODate').value,
                dueDate: document.getElementById('editPODueDate').value,
                status: document.getElementById('editPOStatus').value,
                notes: document.getElementById('editPONotes').value,
                totalAmount: totalAmount,
                amountPaid: parseFloat(document.getElementById('editPOAmountPaid').value) || 0,
                lines: newLines,
                oldLines: currentEditingOrder._originalLines || []
            };
            
            // Check if voiding - show confirmation
            const newStatus = document.getElementById('editPOStatus').value;
            const oldStatus = po.Status;
            if (newStatus === 'Voided' && oldStatus !== 'Voided') {
                let message = 'âš ï¸ VOID PURCHASE ORDER?\n\n' +
                    'This will:\n' +
                    'â€¢ Mark the order as VOIDED\n';
                
                if (oldStatus === 'Received') {
                    message += 'â€¢ REMOVE inventory for all line items\n';
                }
                message += 'â€¢ Create adjustment log entries\n' +
                    'â€¢ Exclude from tax reports\n\n' +
                    'This action cannot be easily undone.\n\n' +
                    'Continue with voiding ' + (po.Invoice_Number || po.PO_ID) + '?';
                
                const confirmVoid = confirm(message);
                if (!confirmVoid) return;
            }
            
            showStatus('purchasesStatus', 'â³ Saving changes...', 'info');
            
            const result = await apiCall('updatePurchaseOrder', data);
            
            if (result && result.status === 'success') {
                showStatus('purchasesStatus', 'âœ… Purchase order updated successfully!', 'success');
                closeOrderModal();
                loadPurchases();
            } else {
                showStatus('purchasesStatus', 'âŒ Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        function enableEditMode() {
            if (currentEditingType === 'purchase') {
                enablePurchaseOrderEdit();
            } else if (currentEditingType === 'sales') {
                enableSalesOrderEdit();
            }
        }
        
        async function enableSalesOrderEdit() {
            const so = currentEditingOrder;
            
            // Load items and customers if not cached
            if (cachedItems.length === 0) {
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
            }
            if (cachedCustomers.length === 0) {
                const custResult = await apiCall('getCustomers');
                if (custResult && custResult.status === 'success') {
                    cachedCustomers = custResult.data;
                }
            }
            
            // Get line items
            const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
            const lines = linesResult?.data || [];
            
            document.getElementById('modalTitle').textContent = `Edit Sales Order: ${so.Invoice_Number || so.SO_ID}`;
            
            // Build customer dropdown
            let customerOptions = '<option value="">Select Customer</option>';
            cachedCustomers.forEach(c => {
                customerOptions += `<option value="${c.Customer_ID}" ${c.Customer_ID === so.Customer_ID ? 'selected' : ''}>${c.Customer_Name}</option>`;
            });
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Order Information</h3>
                        <div class="form-group">
                            <label>Customer *</label>
                            <select id="editSOCustomer" required>${customerOptions}</select>
                        </div>
                        <div class="form-group">
                            <label>Invoice Number</label>
                            <input type="text" id="editSOInvoiceNumber" value="${so.Invoice_Number || ''}">
                        </div>
                        <div class="form-group">
                            <label>Sale Date</label>
                            <input type="date" id="editSODate" value="${so.Sale_Date ? new Date(so.Sale_Date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="editSODueDate" value="${so.Due_Date ? new Date(so.Due_Date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="editSOPaymentMethod">
                                <option value="Cash" ${so.Payment_Method === 'Cash' ? 'selected' : ''}>Cash</option>
                                <option value="Check" ${so.Payment_Method === 'Check' ? 'selected' : ''}>Check</option>
                                <option value="Invoice" ${so.Payment_Method === 'Invoice' ? 'selected' : ''}>Invoice</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="editSOStatus">
                                <option value="Pending" ${so.Status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Completed" ${so.Status === 'Completed' ? 'selected' : ''}>Completed</option>
                                <option value="Cancelled" ${so.Status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Payment Information</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div id="editSOCurrentTotal" style="margin-bottom: 10px;">
                                <strong>Current Total:</strong> $${parseFloat(so.Total_Amount || 0).toFixed(2)}
                            </div>
                            <div id="editSOPreviouslyPaid" style="margin-bottom: 10px;">
                                <strong>Previously Paid:</strong> $${parseFloat(so.Amount_Paid || 0).toFixed(2)}
                            </div>
                            <div id="editSOBalanceDue">
                                <strong>Balance Due:</strong> <span style="color: #e74c3c;">$${(parseFloat(so.Total_Amount || 0) - parseFloat(so.Amount_Paid || 0)).toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ğŸ’µ Amount Paid</label>
                            <div style="position: relative; display: flex; align-items: center;">
                                <span style="position: absolute; left: 12px; font-size: 16px; font-weight: bold; color: #666;">$</span>
                                <input type="number" id="editSOAmountPaid" step="0.01" min="0" placeholder="0.00" value="${parseFloat(so.Amount_Paid || 0).toFixed(2)}" style="padding-left: 28px; font-size: 16px; font-weight: 600;">
                            </div>
                            <small style="color: #666;">ğŸ’¡ Enter numbers only (e.g., 115.46 for $115.46)</small>
                        </div>
                        <div style="color: #666; font-size: 13px; background: #fff3cd; padding: 10px; border-radius: 6px;">
                            âš ï¸ Total will recalculate based on line items below
                        </div>
                    </div>
                </div>
                
                <h3 style="color: #667eea; margin-bottom: 15px;">Line Items</h3>
                <div id="editSOLineItems">
            `;
            
            // Add existing line items as editable rows
            lines.forEach((line, index) => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                html += createEditableLineItem('SO', line, index, item);
            });
            
            html += `
                </div>
                <button type="button" class="btn btn-secondary" onclick="addEditLineItem('SO')" style="margin-top: 10px;">+ Add Line Item</button>
                
                <div class="form-group" style="margin-top: 30px;">
                    <label>Notes</label>
                    <textarea id="editSONotes" rows="3" style="width: 100%;">${so.Notes || ''}</textarea>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            
            // Attach event listeners to all SO line items in the edit modal
            console.log('Attaching listeners to SO edit modal line items'); // DEBUG
            document.querySelectorAll('#editSOLineItems .edit-line-item').forEach(row => {
                attachEditLineItemListeners(row);
            });
            
            document.getElementById('modalEditBtn').style.display = 'none';
            document.getElementById('modalSaveBtn').style.display = 'inline-block';
        }
        
        async function saveSalesOrderChanges() {
            const so = currentEditingOrder;
            
            // Collect line items
            const newLines = [];
            let totalAmount = 0;
            
            document.querySelectorAll('#editSOLineItems .edit-line-item').forEach(row => {
                const itemId = row.querySelector('.edit-item').value;
                const qty = parseInt(row.querySelector('.edit-qty').value) || 0;
                const price = parseFloat(row.querySelector('.edit-price').value) || 0;
                
                if (itemId && qty > 0) {
                    newLines.push({
                        itemId: itemId,
                        quantity: qty,
                        unitPrice: price,
                        originalItem: row.dataset.originalItem,
                        originalQty: parseInt(row.dataset.originalQty) || 0,
                        lineId: row.dataset.lineId
                    });
                    totalAmount += qty * price;
                }
            });
            
            if (newLines.length === 0) {
                alert('Please add at least one line item');
                return;
            }
            
            const data = {
                soId: so.SO_ID,
                customerId: document.getElementById('editSOCustomer').value,
                invoiceNumber: document.getElementById('editSOInvoiceNumber').value,
                saleDate: document.getElementById('editSODate').value,
                dueDate: document.getElementById('editSODueDate').value,
                paymentMethod: document.getElementById('editSOPaymentMethod').value,
                status: document.getElementById('editSOStatus').value,
                notes: document.getElementById('editSONotes').value,
                totalAmount: totalAmount,
                amountPaid: parseFloat(document.getElementById('editSOAmountPaid').value) || 0,
                lines: newLines
            };
            
            // Check if voiding - show confirmation
            const newStatus = document.getElementById('editSOStatus').value;
            const oldStatus = so.Status;
            if (newStatus === 'Voided' && oldStatus !== 'Voided') {
                const confirmVoid = confirm(
                    'âš ï¸ VOID SALES ORDER?\n\n' +
                    'This will:\n' +
                    'â€¢ Mark the order as VOIDED\n' +
                    'â€¢ ADD inventory back for all line items\n' +
                    'â€¢ Create adjustment log entries\n' +
                    'â€¢ Exclude from tax reports\n\n' +
                    'This action cannot be easily undone.\n\n' +
                    'Continue with voiding ' + (so.Invoice_Number || so.SO_ID) + '?'
                );
                if (!confirmVoid) return;
            }
            
            showStatus('salesStatus', 'â³ Saving changes...', 'info');
            
            const result = await apiCall('updateSalesOrder', data);
            
            if (result && result.status === 'success') {
                showStatus('salesStatus', 'âœ… Sales order updated successfully!', 'success');
                closeOrderModal();
                loadSales();
            } else {
                showStatus('salesStatus', 'âŒ Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        function recordPurchasePayment(poId, total, amountPaid) {
            const remaining = total - amountPaid;
            
            // Create better formatted prompt
            let message = `ğŸ’° Record Payment for ${poId}\n\n`;
            message += `Invoice Total:    $${total.toFixed(2)}\n`;
            message += `Already Paid:     $${amountPaid.toFixed(2)}\n`;
            message += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
            message += `Balance Due:      $${remaining.toFixed(2)}\n\n`;
            
            // Suggest full payment if unpaid
            if (amountPaid === 0) {
                message += `Tip: Enter ${remaining.toFixed(2)} to pay in full\n\n`;
            }
            
            message += `Enter payment amount:`;
            
            const payment = prompt(message);
            
            if (payment === null) return; // Cancelled
            
            const paymentAmount = parseFloat(payment);
            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                alert('Please enter a valid payment amount');
                return;
            }
            
            if (paymentAmount > remaining + 0.01) { // Allow 1 cent rounding
                if (!confirm(`Payment ($${paymentAmount.toFixed(2)}) is more than balance due ($${remaining.toFixed(2)}).\n\nContinue anyway?`)) {
                    return;
                }
            }
            
            // Call backend
            apiCall('recordPurchasePayment', { poId: poId, paymentAmount: paymentAmount })
                .then(result => {
                    if (result && result.status === 'success') {
                        const newTotal = amountPaid + paymentAmount;
                        const statusMsg = result.paymentStatus === 'Paid' ? 'âœ… PAID IN FULL!' : `Status: ${result.paymentStatus}`;
                        showStatus('purchasesStatus', `âœ… Payment recorded! $${newTotal.toFixed(2)} total paid. ${statusMsg}`, 'success');
                        loadPurchases();
                    } else {
                        showStatus('purchasesStatus', 'âŒ Error: ' + (result?.message || 'Unknown error'), 'error');
                    }
                })
                .catch(err => {
                    showStatus('purchasesStatus', 'âŒ Error recording payment: ' + err.message, 'error');
                });
        }

        // ==================== SALES ====================

        function showAddSaleForm() {
            loadSaleDropdowns();
            document.getElementById('addSaleForm').style.display = 'block';
            
            // Setup event listeners for the initial line item
            setTimeout(() => {
                const firstRow = document.querySelector('#soLineItems .line-item-row');
                if (firstRow) {
                    const itemSelect = firstRow.querySelector('.so-item');
                    const qtyInput = firstRow.querySelector('.so-qty');
                    const priceInput = firstRow.querySelector('.so-price');
                    const removeBtn = firstRow.querySelector('.remove-btn');
                    
                    if (itemSelect) {
                        itemSelect.addEventListener('change', function() {
                            updateSOItemInfo(this);
                        });
                    }
                    
                    if (qtyInput) {
                        qtyInput.addEventListener('input', function() {
                            const row = this.closest('.line-item-row');
                            const itemSelect = row.querySelector('.so-item');
                            if (itemSelect.value) {
                                updateSOItemInfo(itemSelect);
                            }
                            calculateSOTotal();
                        });
                    }
                    
                    if (priceInput) {
                        priceInput.addEventListener('input', function() {
                            calculateSOTotal();
                        });
                    }
                    
                    if (removeBtn) {
                        removeBtn.addEventListener('click', function() {
                            removeLineItem(this);
                            calculateSOTotal();
                        });
                    }
                }
                
                // Initialize summary boxes
                calculateSOTotal();
            }, 100);
        }

        function hideAddSaleForm() {
            document.getElementById('addSaleForm').style.display = 'none';
            document.querySelector('#addSaleForm form').reset();
            
            // Reset summary boxes
            const qtyBox = document.getElementById('soTotalQty');
            const amountBox = document.getElementById('soTotalAmount');
            if (qtyBox) qtyBox.textContent = '0';
            if (amountBox) amountBox.textContent = '$0.00';
        }

        async function loadSaleDropdowns() {
            if (cachedCustomers.length === 0) {
                const result = await apiCall('getCustomers');
                if (result && result.status === 'success') {
                    cachedCustomers = result.data;
                }
            }

            const select = document.getElementById('soCustomer');
            select.innerHTML = '<option value="">Select Customer</option>';
            cachedCustomers.forEach(c => {
                select.innerHTML += `<option value="${c.Customer_ID}">${c.Customer_Name}</option>`;
            });

            if (cachedItems.length === 0) {
                const result = await apiCall('getItems');
                if (result && result.status === 'success') {
                    cachedItems = result.data;
                    console.log('loadSaleDropdowns: Loaded items, first item Unit_Sell_Price:', cachedItems[0]?.Unit_Sell_Price); // DEBUG
                }
            }

            console.log('loadSaleDropdowns: Populating dropdowns with', cachedItems.length, 'items'); // DEBUG
            console.log('loadSaleDropdowns: First item Unit_Sell_Price:', cachedItems[0]?.Unit_Sell_Price); // DEBUG
            
            document.querySelectorAll('.so-item').forEach(select => {
                select.innerHTML = '<option value="">Select Item</option>';
                cachedItems.forEach(item => {
                    console.log(`Adding option: ${item.Item_Description}, Unit_Sell_Price: ${item.Unit_Sell_Price}`); // DEBUG
                    select.innerHTML += `<option value="${item.Item_ID}" data-price="${item.Unit_Sell_Price}" data-stock="${item.Qty_On_Hand || 0}">${item.Item_Description}</option>`;
                });
            });
            
            console.log('loadSaleDropdowns: Dropdown populated!'); // DEBUG
        }

        function addSOLineItem() {
            const container = document.getElementById('soLineItems');
            
            // Get all items once
            if (cachedItems.length === 0) {
                alert('Please wait for items to load');
                return;
            }
            
            const newRow = document.createElement('div');
            newRow.className = 'line-item-row';
            newRow.style.cssText = 'display: grid; grid-template-columns: 2.5fr 1fr 1fr 50px; gap: 10px; margin-bottom: 10px; align-items: end;';
            newRow.innerHTML = `
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;">ğŸ“¦ Item</label>
                    <select class="so-item" required style="padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white; width: 100%;">
                        <option value="">Select Item</option>
                        ${cachedItems.map(item => {
                            console.log('Item:', item.Item_Description, 'Unit_Sell_Price:', item.Unit_Sell_Price); // DEBUG
                            return `<option value="${item.Item_ID}" data-price="${item.Unit_Sell_Price}" data-stock="${item.Qty_On_Hand || 0}">${item.Item_Description}</option>`;
                        }).join('')}
                    </select>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;">ğŸ“Š Quantity</label>
                    <input type="number" class="so-qty" placeholder="0" min="1" required style="padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px; width: 100%;">
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;">ğŸ’° Price</label>
                    <input type="number" class="so-price" placeholder="0.00" step="0.01" min="0" required style="padding: 14px 10px; border: 2px solid #667eea; border-radius: 8px; text-align: center; font-size: 16px; min-height: 52px; background: white; width: 100%;">
                </div>
                <button type="button" class="remove-btn" style="min-height: 52px; font-size: 18px; margin-top: 26px;">âœ•</button>
                <div class="so-stock-info" style="grid-column: 1 / -1; font-size: 13px; padding: 5px 10px; margin-top: -5px; display: none;"></div>
            `;
            container.appendChild(newRow);
            
            // Attach event listeners programmatically (CSP-safe)
            const itemSelect = newRow.querySelector('.so-item');
            const qtyInput = newRow.querySelector('.so-qty');
            const priceInput = newRow.querySelector('.so-price');
            const removeBtn = newRow.querySelector('.remove-btn');
            
            console.log('Attaching listeners to:', itemSelect); // DEBUG
            
            itemSelect.addEventListener('change', function() {
                console.log('CHANGE EVENT FIRED!'); // DEBUG
                updateSOItemInfo(this);
            });
            
            qtyInput.addEventListener('input', function() {
                // Update stock info when quantity changes
                const row = this.closest('.line-item-row');
                const itemSelect = row.querySelector('.so-item');
                if (itemSelect.value) {
                    updateSOItemInfo(itemSelect);
                }
                calculateSOTotal();
            });
            
            priceInput.addEventListener('input', function() {
                calculateSOTotal();
            });
            
            removeBtn.addEventListener('click', function() {
                removeLineItem(this);
                calculateSOTotal();
            });
            
            console.log('Event listeners attached successfully!'); // DEBUG
        }
        
        function updateSOItemInfo(selectElement) {
            console.log('updateSOItemInfo called!'); // DEBUG
            const option = selectElement.options[selectElement.selectedIndex];
            console.log('Selected option:', option); // DEBUG
            console.log('Option text:', option.text); // DEBUG
            console.log('data-price attribute:', option.getAttribute('data-price')); // DEBUG
            console.log('data-stock attribute:', option.getAttribute('data-stock')); // DEBUG
            
            const price = option.getAttribute('data-price');
            const stock = parseFloat(option.getAttribute('data-stock')) || 0;
            
            const row = selectElement.closest('.line-item-row');
            const priceInput = row.querySelector('.so-price');
            const qtyInput = row.querySelector('.so-qty');
            const stockInfoDiv = row.querySelector('.so-stock-info');
            
            if (price) {
                console.log('Setting price to:', price); // DEBUG
                priceInput.value = price;
            } else {
                console.log('NO PRICE FOUND!'); // DEBUG
            }
            
            // Show stock info
            if (stockInfoDiv && option.value) {
                stockInfoDiv.style.display = 'block';
                
                const qty = parseFloat(qtyInput.value) || 0;
                const remaining = stock - qty;
                
                let message = `ğŸ“¦ Current Stock: ${stock} units`;
                let bgColor = '#e3f2fd';
                let textColor = '#1565c0';
                
                if (qty > 0) {
                    message += ` â†’ After sale: ${remaining} units`;
                    
                    if (remaining < 0) {
                        bgColor = '#ffebee';
                        textColor = '#c62828';
                        message += ' âš ï¸ INSUFFICIENT STOCK - This will create a negative inventory!';
                    } else if (remaining === 0) {
                        bgColor = '#fff3e0';
                        textColor = '#ef6c00';
                        message += ' âš ï¸ This will deplete stock to zero';
                    } else if (remaining < 10) {
                        bgColor = '#fff3e0';
                        textColor = '#ef6c00';
                        message += ' âš ï¸ Low stock warning';
                    }
                }
                
                stockInfoDiv.textContent = message;
                stockInfoDiv.style.background = bgColor;
                stockInfoDiv.style.color = textColor;
                stockInfoDiv.style.border = `1px solid ${textColor}`;
                stockInfoDiv.style.borderRadius = '4px';
            }
            
            calculateSOTotal();
        }
        
        function calculateSOTotal() {
            let total = 0;
            let totalQty = 0;
            
            document.querySelectorAll('#soLineItems .line-item-row').forEach(row => {
                const qty = parseInt(row.querySelector('.so-qty')?.value) || 0;
                const price = parseFloat(row.querySelector('.so-price')?.value) || 0;
                const lineTotal = qty * price;
                total += lineTotal;
                totalQty += qty;
            });
            
            // Update hidden total field (if exists)
            const totalField = document.getElementById('soTotal');
            if (totalField) {
                totalField.value = total.toFixed(2);
            }
            
            // Update summary boxes
            const qtyBox = document.getElementById('soTotalQty');
            const amountBox = document.getElementById('soTotalAmount');
            
            if (qtyBox) qtyBox.textContent = totalQty;
            if (amountBox) amountBox.textContent = '$' + total.toFixed(2);
        }

        let isSavingSale = false; // Prevent double-click
        
        async function addSale(e) {
            e.preventDefault();
            
            // Prevent double-click
            if (isSavingSale) {
                console.log('Already saving sale, ignoring duplicate click');
                return;
            }
            
            const lineItems = [];
            let calculatedTotal = 0;
            
            document.querySelectorAll('#soLineItems .line-item-row').forEach(row => {
                const itemId = row.querySelector('.so-item').value;
                const qty = parseInt(row.querySelector('.so-qty').value) || 0;
                const price = parseFloat(row.querySelector('.so-price').value) || 0;
                const lineTotal = qty * price;
                
                // Only add valid line items (has item selected, qty > 0)
                if (itemId && qty > 0) {
                    lineItems.push({
                        itemId: itemId,
                        quantity: qty,
                        unitPrice: price
                    });
                    calculatedTotal += lineTotal;
                }
            });

            // Validate at least one line item
            if (lineItems.length === 0) {
                alert('âš ï¸ Please add at least one item to the sale.\n\nSelect an item and enter a quantity before saving.');
                return;
            }

            // LOCK - Prevent double submit
            isSavingSale = true;
            
            // Find and disable submit button
            const submitBtn = document.querySelector('#addSaleForm button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : '';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'â³ Saving...';
            }
            
            try {
                // AUTO-GENERATE INVOICE NUMBER
                // Format: INV-MMDDYY-XXX (e.g., INV-120725-001)
                const saleDate = document.getElementById('soDate').value;
                const dateObj = saleDate ? new Date(saleDate) : new Date();
                
                // Format date as MMDDYY
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                const year = String(dateObj.getFullYear()).slice(-2); // Last 2 digits
                const dateStr = `${month}${day}${year}`;
                
                // Get all existing sales orders to find the next number for this date
                const existingSales = await apiCall('getSalesOrders');
                let nextNumber = 1;
                
                if (existingSales && existingSales.data && existingSales.data.length > 0) {
                    // Find highest invoice number for this date
                    const prefix = `INV-${dateStr}-`;
                    const todayInvoices = existingSales.data
                        .filter(so => so.Invoice_Number && so.Invoice_Number.startsWith(prefix))
                        .map(so => {
                            const parts = so.Invoice_Number.split('-');
                            return parseInt(parts[2]) || 0;
                        });
                    
                    if (todayInvoices.length > 0) {
                        nextNumber = Math.max(...todayInvoices) + 1;
                    }
                }
                
                // Generate invoice number: INV-120725-001
                const invoiceNumber = `INV-${dateStr}-${String(nextNumber).padStart(3, '0')}`;

                const data = {
                    customerId: document.getElementById('soCustomer').value,
                    saleDate: document.getElementById('soDate').value,
                    invoiceNumber: invoiceNumber,
                    paymentMethod: document.getElementById('soPayment').value,
                    dueDate: document.getElementById('soDueDate').value || null,
                    totalAmount: calculatedTotal,
                    amountPaid: parseFloat(document.getElementById('soAmountPaid').value) || 0,
                    status: document.getElementById('soStatus').value,
                    notes: document.getElementById('soNotes').value,
                    lineItems: lineItems  // FIXED: was "lines", backend expects "lineItems"
                };

                const result = await apiCall('createSalesOrder', data);
                
                if (result && result.status === 'success') {
                    showStatus('salesStatus', `âœ… Sale recorded! Invoice #: ${invoiceNumber}`, 'success');
                    hideAddSaleForm();
                    loadSales();
                } else {
                    showStatus('salesStatus', 'âŒ Error: ' + (result?.message || 'Unknown error'), 'error');
                }
            } finally {
                // UNLOCK
                isSavingSale = false;
                
                // Re-enable button
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText || 'ğŸ’¾ Save Sale';
                }
            }
        }

        let salesData = []; // Cache for filtering
        
        async function loadSales() {
            document.getElementById('salesTable').innerHTML = '<div class="loading">Loading sales...</div>';
            
            // Load customers FIRST if not cached
            if (cachedCustomers.length === 0) {
                const custResult = await apiCall('getCustomers');
                if (custResult && custResult.status === 'success') {
                    cachedCustomers = custResult.data;
                }
            }
            
            // Now load and display sales
            const result = await apiCall('getSalesOrders');
            
            if (result && result.status === 'success') {
                salesData = result.data;
                displaySales(result.data);
                loadSaleFilterCustomers(); // Populate filter dropdown
            } else {
                document.getElementById('salesTable').innerHTML = '<div class="loading">Error loading sales</div>';
            }
        }
        
        async function loadSaleFilterCustomers() {
            if (cachedCustomers.length === 0) {
                const result = await apiCall('getCustomers');
                if (result && result.status === 'success') {
                    cachedCustomers = result.data;
                }
            }
            
            const select = document.getElementById('filterSaleCustomer');
            select.innerHTML = '<option value="">All Customers</option>';
            cachedCustomers.forEach(c => {
                select.innerHTML += `<option value="${c.Customer_ID}">${c.Customer_Name}</option>`;
            });
        }
        
        function filterSales() {
            const customerFilter = document.getElementById('filterSaleCustomer').value;
            const invoiceNumberFilter = document.getElementById('filterInvoiceNumber').value.trim().toLowerCase();
            const dateFrom = document.getElementById('filterSaleDateFrom').value;
            const dateTo = document.getElementById('filterSaleDateTo').value;
            const statusFilter = document.getElementById('filterSaleStatus')?.value || '';
            
            const filtered = salesData.filter(so => {
                const matchesCustomer = !customerFilter || so.Customer_ID === customerFilter;
                const matchesInvoice = !invoiceNumberFilter || (so.Invoice_Number && so.Invoice_Number.toLowerCase().includes(invoiceNumberFilter));
                const soDate = new Date(so.SO_Date);
                const matchesDateFrom = !dateFrom || soDate >= new Date(dateFrom);
                const matchesDateTo = !dateTo || soDate <= new Date(dateTo);
                
                // Status filter
                let matchesStatus = true;
                if (statusFilter === 'exclude-voided') {
                    matchesStatus = so.Status !== 'Voided';
                } else if (statusFilter) {
                    matchesStatus = so.Status === statusFilter;
                }
                
                return matchesCustomer && matchesInvoice && matchesDateFrom && matchesDateTo && matchesStatus;
            });
            
            displaySales(filtered);
        }
        
        function clearSaleFilters() {
            document.getElementById('filterSaleCustomer').value = '';
            document.getElementById('filterInvoiceNumber').value = '';
            document.getElementById('filterSaleDateFrom').value = '';
            document.getElementById('filterSaleDateTo').value = '';
            if (document.getElementById('filterSaleStatus')) {
                document.getElementById('filterSaleStatus').value = '';
            }
            displaySales(salesData);
        }

        function displaySales(orders) {
            if (!orders || orders.length === 0) {
                document.getElementById('salesTable').innerHTML = '<p>No sales yet. Record your first sale!</p>';
                return;
            }

            // Calculate totals
            let totalAmount = 0;
            let totalPaid = 0;
            
            // Cache sales for row click
            window.cachedSales = orders;
            
            // Calculate totals first
            orders.forEach(so => {
                totalAmount += parseFloat(so.Total_Amount || so.Order_Total) || 0;
                totalPaid += parseFloat(so.Amount_Paid) || 0;
            });
            const balance = totalAmount - totalPaid;
            
            // Summary boxes
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #1976d2;">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Total Sales</div>
                        <div style="font-size: 28px; font-weight: bold; color: #1976d2;">$${totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="font-size: 12px; color: #888;">${orders.length} orders</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #388e3c;">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Collected</div>
                        <div style="font-size: 28px; font-weight: bold; color: #388e3c;">$${totalPaid.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="font-size: 12px; color: #888;">${((totalPaid/totalAmount)*100 || 0).toFixed(0)}% collected</div>
                    </div>
                    <div style="background: linear-gradient(135deg, ${balance > 0 ? '#ffebee, #ffcdd2' : '#e8f5e9, #c8e6c9'}); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid ${balance > 0 ? '#c62828' : '#388e3c'};">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Outstanding</div>
                        <div style="font-size: 28px; font-weight: bold; color: ${balance > 0 ? '#c62828' : '#388e3c'};">$${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="font-size: 12px; color: #888;">${balance > 0 ? 'to collect' : 'all paid!'}</div>
                    </div>
                </div>
            `;
            
            html += '<table class="data-table" id="salesDataTable"><thead><tr>';
            html += '<th>Invoice #</th><th>Customer</th><th>Date</th><th>Total</th><th>Paid</th><th>Due Date</th><th>Payment</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            orders.forEach(so => {
                const dueDate = so.Due_Date ? new Date(so.Due_Date).toLocaleDateString() : '-';
                const paymentStatus = so.Payment_Status || 'Unpaid';
                const amountPaid = parseFloat(so.Amount_Paid) || 0;
                const total = parseFloat(so.Total_Amount || so.Order_Total) || 0;
                const invoiceNum = so.Invoice_Number || so.SO_ID;
                
                // Color code payment status badge
                let paymentBadge = '';
                if (paymentStatus === 'Paid') paymentBadge = '<span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Paid</span>';
                else if (paymentStatus === 'Partial') paymentBadge = '<span style="background: #ffc107; color: black; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Partial</span>';
                else paymentBadge = '<span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Unpaid</span>';
                
                html += `<tr style="cursor: pointer;" onclick="viewSalesOrder('${so.SO_ID}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                    <td><strong>${invoiceNum}</strong></td>
                    <td>${getCustomerName(so.Customer_ID)}</td>
                    <td>${new Date(so.Sale_Date || so.SO_Date).toLocaleDateString()}</td>
                    <td>$${total.toFixed(2)}</td>
                    <td>$${amountPaid.toFixed(2)}</td>
                    <td>${dueDate}</td>
                    <td>${paymentBadge}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="btn-small" onclick="viewSalesOrder('${so.SO_ID}')" style="background: #28a745; color: white; padding: 6px 12px;">View/Print</button>
                    </td>
                </tr>`;
            });

            // Add totals row
            html += `<tr style="background: #f0f0f0; font-weight: bold; border-top: 3px solid #667eea;">
                <td colspan="3" style="text-align: right; padding-right: 20px;">TOTALS:</td>
                <td>$${totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>$${totalPaid.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td colspan="3" style="text-align: left;">Balance: <strong style="color: ${balance > 0 ? '#dc3545' : '#28a745'};">$${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
            </tr>`;

            html += '</tbody></table>';
            document.getElementById('salesTable').innerHTML = html;
            setTimeout(() => makeSortable('salesDataTable'), 0);
        }
        
        // View Sales Order (opens modal with print option)
        function viewSalesOrder(soId) {
            const so = window.cachedSales?.find(s => s.SO_ID === soId);
            if (so) {
                showSalesOrderDetails(so);
            }
        }
        
        // Edit Sales Order
        async function editSalesOrder(soId) {
            // Find the SO in cached data or fetch it
            const result = await apiCall('getSalesOrders');
            if (result && result.status === 'success') {
                const so = result.data.find(s => s.SO_ID === soId);
                if (so) {
                    showSalesOrderDetails(so);
                }
            }
        }
        
        async function showSalesOrderDetails(so) {
            currentEditingOrder = so;
            currentEditingType = 'sales';
            
            // Load items if not cached
            if (cachedItems.length === 0) {
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
            }
            
            // Get line items
            const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
            const lines = linesResult?.data || [];
            
            const customerName = getCustomerName(so.Customer_ID);
            const dueDate = so.Due_Date ? new Date(so.Due_Date).toLocaleDateString() : '-';
            const invoiceDate = so.Invoice_Date ? new Date(so.Invoice_Date).toLocaleDateString() : '-';
            
            document.getElementById('modalTitle').textContent = `Sales Order: ${so.Invoice_Number || so.SO_ID}`;
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Order Information</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px 0; font-weight: bold; width: 140px;">Customer:</td><td>${customerName}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Invoice #:</td><td>${so.Invoice_Number || '-'}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Sale Date:</td><td>${new Date(so.Sale_Date).toLocaleDateString()}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Invoice Date:</td><td>${invoiceDate}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Due Date:</td><td>${dueDate}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Payment Method:</td><td>${so.Payment_Method}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Status:</td><td><span style="background: #d4edda; color: #155724; padding: 4px 12px; border-radius: 12px; font-size: 12px;">${so.Status}</span></td></tr>
                        </table>
                    </div>
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Payment Information</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px 0; font-weight: bold; width: 140px;">Total Amount:</td><td style="font-size: 18px; color: #2c3e50;">$${parseFloat(so.Total_Amount || 0).toFixed(2)}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Amount Paid:</td><td style="color: #27ae60;">$${parseFloat(so.Amount_Paid || 0).toFixed(2)}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Balance Due:</td><td style="color: #e74c3c; font-size: 16px; font-weight: bold;">$${(parseFloat(so.Total_Amount || 0) - parseFloat(so.Amount_Paid || 0)).toFixed(2)}</td></tr>
                            <tr><td style="padding: 8px 0; font-weight: bold;">Payment Status:</td><td><span style="background: ${so.Payment_Status === 'Paid' ? '#d4edda' : '#fff3cd'}; color: ${so.Payment_Status === 'Paid' ? '#155724' : '#856404'}; padding: 4px 12px; border-radius: 12px; font-size: 12px;">${so.Payment_Status}</span></td></tr>
                        </table>
                    </div>
                </div>
            `;
            
            if (lines.length > 0) {
                html += `
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">ğŸ“¦ Line Items</h3>
                    <div style="overflow-x: auto;">
                    <table class="data-table" style="margin-bottom: 20px; font-size: 14px;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th style="padding: 12px 15px;">Item</th>
                                <th style="padding: 12px 15px;">Description</th>
                                <th style="padding: 12px 15px;">Qty</th>
                                <th style="padding: 12px 15px;">Unit Price</th>
                                <th style="padding: 12px 15px;">Line Total</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                lines.forEach(line => {
                    const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                    const lineTotal = (parseFloat(line.Quantity) || 0) * (parseFloat(line.Unit_Price) || 0);
                    html += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px 15px;"><strong>${item?.SKU || line.Item_ID}</strong></td>
                            <td style="padding: 12px 15px;">${item ? item.Item_Description : '-'}</td>
                            <td style="padding: 12px 15px; text-align: center; font-weight: bold;">${line.Quantity}</td>
                            <td style="padding: 12px 15px; text-align: right;">$${parseFloat(line.Unit_Price || 0).toFixed(2)}</td>
                            <td style="padding: 12px 15px; text-align: right; font-weight: bold;">$${lineTotal.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                    </div>
                `;
            }
            
            if (so.Notes) {
                html += `
                    <div style="margin-top: 20px;">
                        <h3 style="color: var(--primary, #667eea); margin-bottom: 10px;">Notes</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #c0c0c0;">
                            ${so.Notes}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalEditBtn').style.display = 'inline-block';
            document.getElementById('modalPrintBtn').style.display = 'inline-block';
            document.getElementById('modalPrintBtn').textContent = 'ğŸ–¨ï¸ Print Invoice';
            document.getElementById('modalPrintBtn').onclick = () => printInvoice();
            document.getElementById('modalSaveBtn').style.display = 'none';
            document.getElementById('orderModal').style.display = 'block'; document.body.classList.add('modal-open');
        }
        
        function recordSalesPayment(soId, total, amountPaid) {
            const remaining = total - amountPaid;
            
            // Create better formatted prompt
            let message = `ğŸ’° Record Payment for ${soId}\n\n`;
            message += `Invoice Total:    $${total.toFixed(2)}\n`;
            message += `Already Paid:     $${amountPaid.toFixed(2)}\n`;
            message += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
            message += `Balance Due:      $${remaining.toFixed(2)}\n\n`;
            
            // Suggest full payment if unpaid
            if (amountPaid === 0) {
                message += `Tip: Enter ${remaining.toFixed(2)} to pay in full\n\n`;
            }
            
            message += `Enter payment amount:`;
            
            const payment = prompt(message);
            
            if (payment === null) return; // Cancelled
            
            const paymentAmount = parseFloat(payment);
            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                alert('Please enter a valid payment amount');
                return;
            }
            
            if (paymentAmount > remaining + 0.01) { // Allow 1 cent rounding
                if (!confirm(`Payment ($${paymentAmount.toFixed(2)}) is more than balance due ($${remaining.toFixed(2)}).\n\nContinue anyway?`)) {
                    return;
                }
            }
            
            // Call backend
            apiCall('recordSalesPayment', { soId: soId, paymentAmount: paymentAmount })
                .then(result => {
                    if (result && result.status === 'success') {
                        const newTotal = amountPaid + paymentAmount;
                        const statusMsg = result.paymentStatus === 'Paid' ? 'âœ… PAID IN FULL!' : `Status: ${result.paymentStatus}`;
                        showStatus('salesStatus', `âœ… Payment received! $${newTotal.toFixed(2)} total paid. ${statusMsg}`, 'success');
                        loadSales();
                    } else {
                        showStatus('salesStatus', 'âŒ Error: ' + (result?.message || 'Unknown error'), 'error');
                    }
                })
                .catch(err => {
                    showStatus('salesStatus', 'âŒ Error recording payment: ' + err.message, 'error');
                });
        }

        // ==================== INVENTORY ====================

        let inventoryData = []; // Cache for filtering
        
        async function loadInventory() {
            document.getElementById('inventoryTable').innerHTML = '<div class="loading">Loading inventory...</div>';
            
            // Load suppliers FIRST if not cached
            if (cachedSuppliers.length === 0) {
                const suppResult = await apiCall('getSuppliers');
                if (suppResult && suppResult.status === 'success') {
                    cachedSuppliers = suppResult.data;
                }
            }
            
            // Now load and display inventory
            const result = await apiCall('getInventoryReport');
            
            if (result && result.status === 'success') {
                inventoryData = result.data;
                // Filter out archived items by default
                const activeItems = result.data.filter(item => item.Status !== 'Archived');
                displayInventory(activeItems);
                loadInventoryFilterSuppliers(); // Populate filter dropdown
            } else {
                document.getElementById('inventoryTable').innerHTML = '<div class="loading">Error loading inventory</div>';
            }
        }
        
        async function loadInventoryFilterSuppliers() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }
            
            const select = document.getElementById('filterInventorySupplier');
            select.innerHTML = '<option value="">All Suppliers</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }
        
        function filterInventory() {
            const searchFilter = document.getElementById('filterInventorySearch').value.toLowerCase();
            const supplierFilter = document.getElementById('filterInventorySupplier').value;
            const stockFilter = document.getElementById('filterInventoryStock').value;
            
            const filtered = inventoryData.filter(item => {
                // Hide archived items in inventory view
                if (item.Status === 'Archived') return false;
                
                // Search filter
                const matchesSearch = !searchFilter || 
                    (item.SKU && item.SKU.toString().toLowerCase().includes(searchFilter)) ||
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(searchFilter));
                
                // Supplier filter
                const matchesSupplier = !supplierFilter || item.Supplier_ID === supplierFilter;
                
                // Stock status filter - calculate dynamically based on qty vs reorder point
                let matchesStock = true;
                if (stockFilter) {
                    const qty = parseFloat(item.Qty_On_Hand) || 0;
                    const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                    
                    if (stockFilter === 'negative') matchesStock = qty < 0;
                    else if (stockFilter === 'out') matchesStock = qty === 0;
                    else if (stockFilter === 'low') matchesStock = qty > 0 && qty <= reorderPoint;
                    else if (stockFilter === 'ok') matchesStock = qty > reorderPoint;
                }
                
                return matchesSearch && matchesSupplier && matchesStock;
            });
            
            displayInventory(filtered);
        }
        
        function clearInventoryFilters() {
            document.getElementById('filterInventorySearch').value = '';
            document.getElementById('filterInventorySupplier').value = '';
            document.getElementById('filterInventoryStock').value = '';
            // Filter out archived items by default
            displayInventory(inventoryData.filter(item => item.Status !== 'Archived'));
        }
        
        function filterInventoryByStatus(status, event) {
            // Prevent scroll jump
            if (event) event.preventDefault();
            
            // Save scroll position
            const scrollPos = window.scrollY;
            
            // Set the dropdown to match
            const stockDropdown = document.getElementById('filterInventoryStock');
            if (stockDropdown) stockDropdown.value = status;
            
            // Use the unified filter function that respects ALL filters
            filterInventory();
            
            // Restore scroll position after render
            setTimeout(() => window.scrollTo(0, scrollPos), 0);
        }

        function displayInventory(items) {
            if (!items || items.length === 0) {
                document.getElementById('inventoryTable').innerHTML = '<p>No inventory yet.</p>';
                return;
            }

            // Calculate totals FIRST for summary
            let totalQty = 0;
            let totalCostValue = 0;
            let totalSellValue = 0;
            let negativeCount = 0;
            let outOfStockCount = 0;
            let lowStockCount = 0;
            let inStockCount = 0;
            
            items.forEach(item => {
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPackage;
                const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                
                totalQty += qty;
                totalCostValue += qty * unitCost;
                totalSellValue += qty * unitSellPrice;
                
                if (qty < 0) negativeCount++;
                else if (qty === 0) outOfStockCount++;
                else if (qty <= reorderPoint) lowStockCount++;
                else inStockCount++;
            });
            
            // BUILD STATUS TAGS FIRST (clickable filters) - above summary boxes
            let html = `
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    ${negativeCount > 0 ? `<span onclick="filterInventoryByStatus('negative', event)" style="background: #b71c1c; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">ğŸš¨ ${negativeCount} Negative</span>` : ''}
                    ${outOfStockCount > 0 ? `<span onclick="filterInventoryByStatus('out', event)" style="background: #c62828; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">ğŸ”´ ${outOfStockCount} Out of Stock</span>` : ''}
                    ${lowStockCount > 0 ? `<span onclick="filterInventoryByStatus('low', event)" style="background: #ef6c00; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">ğŸŸ¡ ${lowStockCount} Low Stock</span>` : ''}
                    <span onclick="filterInventoryByStatus('ok', event)" style="background: #2e7d32; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">ğŸŸ¢ ${inStockCount} In Stock</span>
                    <span onclick="filterInventoryByStatus('', event)" style="background: #6c757d; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">Show All</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; border: 2px solid #dee2e6; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: bold; color: #212529;">${items.length}</div>
                        <div style="font-size: 13px; color: #6c757d;">Total Items</div>
                    </div>
                    <div style="background: #f8f9fa; border: 2px solid #dee2e6; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: bold; color: #212529;">${totalQty.toLocaleString()}</div>
                        <div style="font-size: 13px; color: #6c757d;">Total Units</div>
                    </div>
                    <div style="background: #f8f9fa; border: 2px solid #dee2e6; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: bold; color: #dc3545;">$${totalCostValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="font-size: 13px; color: #6c757d;">Cost Value</div>
                    </div>
                    <div style="background: #f8f9fa; border: 2px solid #dee2e6; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: bold; color: #28a745;">$${totalSellValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="font-size: 13px; color: #6c757d;">Sell Value</div>
                    </div>
                    <div style="background: #f8f9fa; border: 2px solid #dee2e6; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: bold; color: ${(totalSellValue - totalCostValue) >= 0 ? '#1565c0' : '#c62828'};">$${(totalSellValue - totalCostValue).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="font-size: 13px; color: #6c757d;">Net Profit</div>
                    </div>
                </div>
            `;
            
            // BUILD TABLE
            html += '<table class="data-table" id="inventoryDataTable"><thead><tr>';
            html += '<th>SKU</th><th>Description</th><th>Supplier</th><th>Qty</th><th>Reorder</th><th>Cost</th><th>Sell</th><th>Cost Value</th><th>Sell Value</th><th>Net Profit</th><th>Updated</th><th>Status</th>';
            html += '</tr></thead><tbody>';

            items.forEach(item => {
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                const lastUpdated = item.Last_Updated ? new Date(item.Last_Updated).toLocaleDateString() : '-';
                
                // Calculate values
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPackage;
                const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const costValue = qty * unitCost;
                const sellValue = qty * unitSellPrice;
                const netProfit = sellValue - costValue;
                
                // Determine status with color coding
                let status = '';
                let statusStyle = '';
                let rowStyle = '';
                
                if (qty < 0) {
                    status = 'NEGATIVE';
                    statusStyle = 'background: #b71c1c; color: white;';
                    rowStyle = 'background: #ffcdd2;';
                } else if (qty === 0) {
                    status = 'OUT OF STOCK';
                    statusStyle = 'background: #c62828; color: white;';
                    rowStyle = 'background: #ffebee;';
                } else if (qty <= reorderPoint) {
                    status = 'LOW STOCK';
                    statusStyle = 'background: #ef6c00; color: white;';
                    rowStyle = 'background: #fff3e0;';
                } else {
                    status = 'IN STOCK';
                    statusStyle = 'background: #2e7d32; color: white;';
                }
                
                html += `<tr style="${rowStyle} cursor: pointer;" onclick="openItem('${item.Item_ID}')" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                    <td><strong>${item.SKU || '-'}</strong></td>
                    <td style="color: #667eea;"><strong>${item.Item_Description}</strong></td>
                    <td>${getSupplierName(item.Supplier_ID)}</td>
                    <td><strong style="${qty < 0 ? 'color: #b71c1c;' : ''}">${qty}</strong></td>
                    <td>${reorderPoint}</td>
                    <td>$${unitCost.toFixed(3)}</td>
                    <td>$${unitSellPrice.toFixed(2)}</td>
                    <td>$${costValue.toFixed(2)}</td>
                    <td style="color: #2e7d32; font-weight: bold;">$${sellValue.toFixed(2)}</td>
                    <td style="color: ${netProfit >= 0 ? '#1565c0' : '#c62828'}; font-weight: bold;">$${netProfit.toFixed(2)}</td>
                    <td style="font-size: 11px; color: #666;">${lastUpdated}</td>
                    <td><span style="${statusStyle} padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap;">${status}</span></td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('inventoryTable').innerHTML = html;
            setTimeout(() => makeSortable('inventoryDataTable'), 0);
        }
        
        // ==================== PRICE SIMULATOR ====================
        
        let pricesimItems = [];
        let pricesimFiltered = [];
        let simulatedNewItems = []; // Track new items added for simulation
        
        // New Item Simulation Functions
        function calcNewSimUnitCost() {
            const packageCost = parseFloat(document.getElementById('newSimPackageCost').value) || 0;
            const unitsPerPkg = parseFloat(document.getElementById('newSimUnitsPerPkg').value) || 1;
            const unitCost = packageCost / unitsPerPkg;
            document.getElementById('newSimUnitCost').value = '$' + unitCost.toFixed(2);
            calcNewSimSellPrice();
        }
        
        function calcNewSimSellPrice() {
            const packageCost = parseFloat(document.getElementById('newSimPackageCost').value) || 0;
            const unitsPerPkg = parseFloat(document.getElementById('newSimUnitsPerPkg').value) || 1;
            const markup = parseFloat(document.getElementById('newSimMarkup').value) || 0;
            const unitCost = packageCost / unitsPerPkg;
            const sellPrice = unitCost * (1 + markup / 100);
            document.getElementById('newSimSellPrice').value = '$' + sellPrice.toFixed(2);
        }
        
        function clearNewSimForm() {
            document.getElementById('newSimSupplier').value = '';
            document.getElementById('newSimSKU').value = '';
            document.getElementById('newSimDescription').value = '';
            document.getElementById('newSimPackageCost').value = '';
            document.getElementById('newSimUnitsPerPkg').value = '1';
            document.getElementById('newSimMarkup').value = '30';
            document.getElementById('newSimUnitCost').value = '$0.00';
            document.getElementById('newSimSellPrice').value = '$0.00';
        }
        
        function addNewItemToSimulation() {
            const supplierId = document.getElementById('newSimSupplier').value;
            const sku = document.getElementById('newSimSKU').value.trim();
            const description = document.getElementById('newSimDescription').value.trim();
            const packageCost = parseFloat(document.getElementById('newSimPackageCost').value) || 0;
            const unitsPerPkg = parseFloat(document.getElementById('newSimUnitsPerPkg').value) || 1;
            const markup = parseFloat(document.getElementById('newSimMarkup').value) || 0;
            
            // Validation with alerts
            if (!supplierId) {
                alert('Please select a supplier');
                return false;
            }
            if (!description) {
                alert('Please enter a description');
                return false;
            }
            if (packageCost <= 0) {
                alert('Please enter a package cost greater than 0');
                return false;
            }
            
            const unitCost = packageCost / unitsPerPkg;
            const sellPrice = unitCost * (1 + markup / 100);
            
            // Create a simulated item object
            const newItem = {
                Item_ID: 'NEW_' + Date.now(), // Temporary ID
                Supplier_ID: supplierId,
                SKU: sku || 'NEW',
                Item_Description: description,
                Package_Cost: packageCost,
                Units_Per_Package: unitsPerPkg,
                Unit_Sell_Price: sellPrice,
                Qty_On_Hand: 0,
                Reorder_Point: 0,
                isNew: true, // Flag to identify new items
                markup: markup
            };
            
            // Initialize arrays if needed
            if (!simulatedNewItems) simulatedNewItems = [];
            if (!pricesimItems) pricesimItems = [];
            if (!pricesimFiltered) pricesimFiltered = [];
            
            simulatedNewItems.push(newItem);
            pricesimItems.push(newItem);
            pricesimFiltered = [...pricesimItems];
            
            displayPriceSimItems();
            clearNewSimForm();
            
            showStatus('pricesimStatus', `âœ… Added "${description}" to simulation. ${simulatedNewItems.length} new item(s) pending.`, 'success');
            
            // Scroll to show the table
            document.getElementById('pricesimTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            return false;
        }
        
        function removeSimulatedItem(tempId) {
            simulatedNewItems = simulatedNewItems.filter(item => item.Item_ID !== tempId);
            pricesimItems = pricesimItems.filter(item => item.Item_ID !== tempId);
            pricesimFiltered = pricesimFiltered.filter(item => item.Item_ID !== tempId);
            displayPriceSimItems();
            showStatus('pricesimStatus', `Removed item. ${simulatedNewItems.length} new item(s) pending.`, 'info');
        }
        
        async function saveNewItemsToDatabase() {
            if (simulatedNewItems.length === 0) {
                alert('No new items to save!');
                return;
            }
            
            if (!confirm(`Save ${simulatedNewItems.length} new item(s) to your database?`)) {
                return;
            }
            
            showStatus('pricesimStatus', 'â³ Saving new items...', 'info');
            
            let savedCount = 0;
            for (const item of simulatedNewItems) {
                const result = await apiCall('addItem', {
                    supplierId: item.Supplier_ID,
                    sku: item.SKU,
                    description: item.Item_Description,
                    purchaseUOM: 'Each',
                    unitsPerPackage: item.Units_Per_Package,
                    packageCost: item.Package_Cost,
                    unitSellPrice: item.Unit_Sell_Price,
                    qtyOnHand: 0,
                    reorderPoint: 0
                });
                if (result?.status === 'success') savedCount++;
            }
            
            simulatedNewItems = [];
            showStatus('pricesimStatus', `âœ… Saved ${savedCount} new items to database!`, 'success');
            
            // Reload to get fresh data with real IDs
            await loadPriceSimItems();
        }
        
        async function loadPriceSimItems() {
            showStatus('pricesimStatus', 'â³ Loading items...', 'info');
            document.getElementById('pricesimTable').innerHTML = '<div class="loading">Loading items...</div>';
            
            try {
                // Load suppliers for filter
                if (cachedSuppliers.length === 0) {
                    const suppResult = await apiCall('getSuppliers');
                    if (suppResult?.status === 'success') cachedSuppliers = suppResult.data;
                }
                
                // Populate both supplier dropdowns
                const supplierSelect = document.getElementById('pricesimSupplier');
                const newSimSupplier = document.getElementById('newSimSupplier');
                
                if (supplierSelect) {
                    supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
                    cachedSuppliers.forEach(s => {
                        supplierSelect.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                    });
                }
                
                if (newSimSupplier) {
                    newSimSupplier.innerHTML = '<option value="">Select Supplier</option>';
                    cachedSuppliers.forEach(s => {
                        newSimSupplier.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                    });
                }
                
                // Load items
                const result = await apiCall('getItems');
                if (result?.status === 'success' && result.data && result.data.length > 0) {
                    pricesimItems = result.data;
                    // Add any simulated new items back
                    simulatedNewItems.forEach(item => {
                        pricesimItems.push(item);
                    });
                    pricesimFiltered = [...pricesimItems];
                    displayPriceSimItems();
                    showStatus('pricesimStatus', `âœ… Loaded ${pricesimItems.length} items (${simulatedNewItems.length} new)`, 'success');
                } else {
                    document.getElementById('pricesimTable').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No items found. Add items in the Items tab first.</p>';
                    showStatus('pricesimStatus', 'âš ï¸ No items found in database', 'info');
                }
            } catch (error) {
                console.error('Price Sim load error:', error);
                showStatus('pricesimStatus', 'âŒ Error loading items: ' + error.message, 'error');
            }
        }
        
        function filterPriceSimItems() {
            const search = document.getElementById('pricesimSearch').value.toLowerCase();
            const supplier = document.getElementById('pricesimSupplier').value;
            const stock = document.getElementById('pricesimStock').value;
            
            pricesimFiltered = pricesimItems.filter(item => {
                const matchSearch = !search || 
                    (item.SKU && item.SKU.toString().toLowerCase().includes(search)) ||
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(search));
                const matchSupplier = !supplier || item.Supplier_ID === supplier;
                
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const reorder = parseFloat(item.Reorder_Point) || 0;
                let matchStock = true;
                if (stock === 'instock') matchStock = qty > 0 && !item.isNew;
                else if (stock === 'low') matchStock = qty > 0 && qty <= reorder && !item.isNew;
                else if (stock === 'out') matchStock = qty <= 0 && !item.isNew;
                else if (stock === 'new') matchStock = item.isNew === true;
                
                return matchSearch && matchSupplier && matchStock;
            });
            
            displayPriceSimItems();
        }
        
        function displayPriceSimItems() {
            const percent = parseFloat(document.getElementById('pricesimPercent').value) || 0;
            const flat = parseFloat(document.getElementById('pricesimFlat').value) || 0;
            
            // Debug info
            console.log('Price Sim Display - pricesimFiltered:', pricesimFiltered?.length, 'pricesimItems:', pricesimItems?.length);
            
            if (!pricesimFiltered || pricesimFiltered.length === 0) {
                if (!pricesimItems || pricesimItems.length === 0) {
                    document.getElementById('pricesimTable').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No items loaded yet. Click ğŸ”„ Refresh to load items.</p>';
                } else {
                    document.getElementById('pricesimTable').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No items match your current filters. Try clearing the filters.</p>';
                }
                return;
            }
            
            let html = `
                <table class="data-table" id="pricesimDataTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;">âœ“</th>
                            <th>SKU</th>
                            <th>Description</th>
                            <th>Supplier</th>
                            <th>Unit Cost</th>
                            <th>Current Sell</th>
                            <th>NEW Sell</th>
                            <th>Change</th>
                            <th>Current Margin</th>
                            <th>NEW Margin</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            pricesimFiltered.forEach((item, idx) => {
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPkg = parseFloat(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPkg;
                const currentSell = parseFloat(item.Unit_Sell_Price) || 0;
                
                // Calculate new price
                let newSell = currentSell;
                if (!item.isNew) {
                    // Only apply bulk adjustment to existing items
                    if (percent > 0) {
                        newSell = currentSell * (1 + percent / 100);
                    } else if (flat > 0) {
                        newSell = currentSell + flat;
                    }
                }
                newSell = Math.round(newSell * 100) / 100; // Round to cents
                
                const change = newSell - currentSell;
                const currentMargin = currentSell > 0 ? ((currentSell - unitCost) / currentSell * 100) : 0;
                const newMargin = newSell > 0 ? ((newSell - unitCost) / newSell * 100) : 0;
                
                const hasChange = change > 0 || item.isNew;
                const isNew = item.isNew === true;
                const rowStyle = isNew ? 'background: #fff3e0;' : '';
                
                html += `
                    <tr style="${rowStyle}">
                        <td>
                            ${isNew ? 
                                `<button class="btn-delete-icon" onclick="removeSimulatedItem('${item.Item_ID}')" title="Remove">ğŸ—‘ï¸</button>` : 
                                `<input type="checkbox" class="pricesim-check" data-idx="${idx}" data-itemid="${item.Item_ID}" data-newprice="${newSell}" data-isnew="${isNew}" onchange="updatePriceSimSummary()" ${hasChange ? 'checked' : ''}>`
                            }
                        </td>
                        <td>
                            ${isNew ? '<span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 5px;">NEW</span>' : ''}
                            <strong>${item.SKU || '-'}</strong>
                        </td>
                        <td>${item.Item_Description}</td>
                        <td>${getSupplierName(item.Supplier_ID)}</td>
                        <td>$${unitCost.toFixed(2)}</td>
                        <td>${isNew ? '-' : '$' + currentSell.toFixed(2)}</td>
                        <td style="color: #28a745; font-weight: bold;">$${newSell.toFixed(2)}</td>
                        <td style="color: ${hasChange ? '#28a745' : '#666'};">${isNew ? `+${item.markup || 0}% markup` : (hasChange ? '+$' + change.toFixed(2) : '-')}</td>
                        <td>${isNew ? '-' : currentMargin.toFixed(1) + '%'}</td>
                        <td style="color: #28a745; font-weight: bold;">${newMargin.toFixed(1)}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            // Add save new items button if there are simulated items
            if (simulatedNewItems.length > 0) {
                html += `
                    <div style="margin-top: 15px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 2px solid #ff9800;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <strong style="color: #e65100;">ğŸ†• ${simulatedNewItems.length} New Item(s) Ready to Save</strong>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">These items are only in simulation. Click to add them to your database.</p>
                            </div>
                            <button class="btn" onclick="if(event && debounceButton(event.currentTarget)) saveNewItemsToDatabase()" style="background: #ff9800;">
                                ğŸ’¾ Save ${simulatedNewItems.length} New Item(s) to Database
                            </button>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('pricesimTable').innerHTML = html;
            
            // Make table sortable
            setTimeout(() => makeSortable('pricesimDataTable'), 0);
            
            updatePriceSimSummary();
        }
        
        // Revenue Impact Calculator
        function updateRevenueCalc() {
            calculateRevenueImpact();
        }
        
        function calculateRevenueImpact() {
            const saleAmount = parseFloat(document.getElementById('revCalcSaleAmount').value) || 100;
            const percent = parseFloat(document.getElementById('revCalcPercent').value) || 0;
            
            // Update percent label
            document.getElementById('revCalcPercentLabel').textContent = percent + '%';
            
            // Calculate values
            const afterAmount = saleAmount * (1 + percent / 100);
            const extraProfit = afterAmount - saleAmount;
            
            // Update display
            document.getElementById('revCalcBefore').textContent = '$' + saleAmount.toFixed(2);
            document.getElementById('revCalcAfter').textContent = '$' + afterAmount.toFixed(2);
            document.getElementById('revCalcProfit').textContent = '+$' + extraProfit.toFixed(2);
            
            // Projected impact (assuming 10 sales per week)
            const weekly = extraProfit * 10;
            const monthly = extraProfit * 40;
            const yearly = extraProfit * 520;
            
            document.getElementById('revCalc10Sales').textContent = '+$' + weekly.toFixed(0) + '/week';
            document.getElementById('revCalcMonthly').textContent = '+$' + monthly.toFixed(0) + '/month';
            document.getElementById('revCalcYearly').textContent = '+$' + yearly.toLocaleString() + '/year';
        }
        
        // Initialize revenue calculator on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById('revCalcSaleAmount')) {
                calculateRevenueImpact();
            }
        });
        
        function previewPriceChanges() {
            displayPriceSimItems();
            document.getElementById('pricesimSummary').style.display = 'block';
        }
        
        // Helper functions to clear one when the other is used
        function clearFlatAmount() {
            document.getElementById('pricesimFlat').value = '0';
        }
        
        function clearPercentAmount() {
            document.getElementById('pricesimPercent').value = '0';
            updatePercentLabel();
        }
        
        function updatePercentLabel() {
            const value = document.getElementById('pricesimPercent').value;
            document.getElementById('pricesimPercentLabel').textContent = value + '%';
        }
        
        function toggleAllPriceSimItems() {
            const selectAll = document.getElementById('pricesimSelectAll').checked;
            document.querySelectorAll('.pricesim-check').forEach(cb => {
                cb.checked = selectAll;
            });
            updatePriceSimSummary();
        }
        
        function updatePriceSimSummary() {
            const checkboxes = document.querySelectorAll('.pricesim-check:checked');
            const percent = parseFloat(document.getElementById('pricesimPercent').value) || 0;
            const flat = parseFloat(document.getElementById('pricesimFlat').value) || 0;
            
            let selectedCount = 0;
            let currentRevenue = 0;
            let newRevenue = 0;
            
            // For inventory impact calculation
            let currentInvValue = 0;
            let newInvValue = 0;
            let itemsWithStock = 0;
            
            checkboxes.forEach(cb => {
                const idx = parseInt(cb.dataset.idx);
                const item = pricesimFiltered[idx];
                if (!item) return;
                
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const currentSell = parseFloat(item.Unit_Sell_Price) || 0;
                
                let newSell = currentSell;
                if (percent > 0) {
                    newSell = currentSell * (1 + percent / 100);
                } else if (flat > 0) {
                    newSell = currentSell + flat;
                }
                
                selectedCount++;
                currentRevenue += qty * currentSell;
                newRevenue += qty * newSell;
                
                // Calculate inventory impact for items with stock
                if (qty > 0) {
                    itemsWithStock++;
                    currentInvValue += qty * currentSell;
                    newInvValue += qty * newSell;
                }
            });
            
            const increase = newRevenue - currentRevenue;
            const invProfit = newInvValue - currentInvValue;
            
            document.getElementById('simSelectedCount').textContent = selectedCount;
            document.getElementById('simCurrentRevenue').textContent = '$' + currentRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('simNewRevenue').textContent = '$' + newRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('simIncrease').textContent = '+$' + increase.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('applyCount').textContent = selectedCount;
            
            // Update inventory impact section
            document.getElementById('simCurrentInvValue').textContent = '$' + currentInvValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('simNewInvValue').textContent = '$' + newInvValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('simInvProfit').textContent = '+$' + invProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // Show/hide sections
            const applySection = document.getElementById('pricesimApplySection');
            const summarySection = document.getElementById('pricesimSummary');
            const invImpactSection = document.getElementById('pricesimInventoryImpact');
            
            if (selectedCount > 0 && (percent > 0 || flat > 0)) {
                applySection.style.display = 'block';
                summarySection.style.display = 'block';
                // Show inventory impact if there are items with stock
                invImpactSection.style.display = itemsWithStock > 0 ? 'block' : 'none';
            } else {
                applySection.style.display = 'none';
                invImpactSection.style.display = 'none';
            }
        }
        
        async function applyPriceChanges() {
            const checkboxes = document.querySelectorAll('.pricesim-check:checked');
            const count = checkboxes.length;
            
            if (count === 0) {
                alert('No items selected!');
                return;
            }
            
            if (!confirm(`Are you sure you want to update the sell price for ${count} items?\n\nThis will modify your database.`)) {
                return;
            }
            
            showStatus('pricesimStatus', `â³ Updating ${count} items...`, 'info');
            
            // Collect updates
            const updates = [];
            checkboxes.forEach(cb => {
                updates.push({
                    itemId: cb.dataset.itemid,
                    newPrice: parseFloat(cb.dataset.newprice)
                });
            });
            
            // Send to backend
            const result = await apiCall('bulkUpdateSellPrices', { updates });
            
            if (result?.status === 'success') {
                showStatus('pricesimStatus', `âœ… Successfully updated ${count} items!`, 'success');
                // Reload items to show new prices
                await loadPriceSimItems();
                // Reset adjustment
                document.getElementById('pricesimPercent').value = '0';
                document.getElementById('pricesimFlat').value = '0';
                document.getElementById('pricesimApplySection').style.display = 'none';
            } else {
                showStatus('pricesimStatus', 'âŒ Error: ' + (result?.message || 'Failed to update'), 'error');
            }
        }
        
        // ==================== MANUAL INVENTORY ADJUSTMENT ====================
        
        async function showAdjustInventoryForm() {
            // ALWAYS load fresh inventory data from database
            showStatus('inventoryStatus', 'Loading current inventory...', 'info');
            const result = await apiCall('getInventoryReport');
            
            if (result && result.status === 'success') {
                cachedItems = result.data;
                
                // Clear fields
                document.getElementById('adjustItemDisplay').value = '';
                document.getElementById('adjustItem').value = '';
                document.getElementById('adjustCurrentQty').value = '';
                document.getElementById('adjustNewQty').value = '';
                document.getElementById('adjustQuantity').value = '';
                
                document.getElementById('adjustInventoryForm').style.display = 'block';
                showStatus('inventoryStatus', '', '');
            } else {
                showStatus('inventoryStatus', 'âŒ Error loading inventory', 'error');
            }
        }
        
        // Open item picker for inventory adjustment
        function openItemPickerForAdjustment() {
            window.adjustmentPickerActive = true;
            window.itemPickerIsFilter = false; // Reset filter mode
            window.itemPickerSupplierContext = ''; // No supplier context for adjustments
            window.itemPickerCallback = {
                tagName: 'ADJUSTMENT_FORM',
                value: document.getElementById('adjustItem').value
            };
            
            // Show supplier filter
            const supplierFilterDiv = document.getElementById('itemPickerSupplierFilter');
            if (supplierFilterDiv) {
                supplierFilterDiv.style.display = 'block';
            }
            
            // Populate supplier filter
            const supplierSelect = document.getElementById('itemPickerSupplier');
            supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
            if (cachedSuppliers && cachedSuppliers.length > 0) {
                cachedSuppliers.forEach(s => {
                    supplierSelect.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                });
            }
            
            // Get items from cache
            window.itemPickerItems = cachedItems || [];
            
            // Clear search
            document.getElementById('itemPickerSearch').value = '';
            document.getElementById('itemPickerSupplier').value = '';
            
            // Render items
            renderItemPickerList();
            
            // Show modal
            document.getElementById('itemPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Focus search
            setTimeout(() => {
                document.getElementById('itemPickerSearch').focus();
            }, 100);
        }
        
        function onAdjustItemSelected() {
            const itemId = document.getElementById('adjustItem').value;
            if (itemId) {
                const item = cachedItems.find(i => i.Item_ID === itemId);
                if (item) {
                    const currentQty = parseInt(item.Qty_On_Hand) || 0;
                    document.getElementById('adjustCurrentQty').value = currentQty;
                    document.getElementById('adjustItemDisplay').value = `${item.SKU} - ${item.Item_Description}`;
                    updateAdjustNewQty();
                }
            }
        }
        
        function updateAdjustNewQty() {
            const currentQty = parseInt(document.getElementById('adjustCurrentQty').value) || 0;
            const adjustment = parseInt(document.getElementById('adjustQuantity').value) || 0;
            const newQty = currentQty + adjustment;
            
            document.getElementById('adjustNewQty').value = newQty;
            
            // Color code the new quantity
            const newQtyInput = document.getElementById('adjustNewQty');
            if (newQty < 0) {
                newQtyInput.style.background = '#ffebee';
                newQtyInput.style.color = '#c62828';
            } else if (adjustment < 0) {
                newQtyInput.style.background = '#fff3e0';
                newQtyInput.style.color = '#ef6c00';
            } else {
                newQtyInput.style.background = '#e8f5e9';
                newQtyInput.style.color = '#2e7d32';
            }
        }
        
        // (Removed old adjustItemResults click handler - now uses card picker)
        
        function hideAdjustInventoryForm() {
            document.getElementById('adjustInventoryForm').style.display = 'none';
            document.querySelector('#adjustInventoryForm form').reset();
            document.getElementById('adjustCurrentQty').value = '';
            document.getElementById('adjustNewQty').value = '';
            document.getElementById('adjustItemDisplay').value = '';
            document.getElementById('adjustItem').value = '';
            document.getElementById('adjustReasonDisplay').value = '';
            document.getElementById('adjustReason').value = '';
        }
        
        function updateAdjustmentCalc() {
            const itemId = document.getElementById('adjustItem').value;
            
            if (itemId) {
                const item = cachedItems.find(i => i.Item_ID === itemId);
                const currentQty = item ? parseInt(item.Qty_On_Hand) : 0;
                const adjustment = parseInt(document.getElementById('adjustQuantity').value) || 0;
                const newQty = currentQty + adjustment;
                
                document.getElementById('adjustCurrentQty').value = currentQty;
                document.getElementById('adjustNewQty').value = newQty;
                
                // Color code the new quantity
                const newQtyInput = document.getElementById('adjustNewQty');
                if (newQty < 0) {
                    newQtyInput.style.background = '#ffebee';
                    newQtyInput.style.color = '#c62828';
                } else if (newQty < currentQty) {
                    newQtyInput.style.background = '#fff3e0';
                } else {
                    newQtyInput.style.background = '#e8f5e9';
                }
            }
        }
        
        async function submitInventoryAdjustment(e) {
            e.preventDefault();
            
            const itemId = document.getElementById('adjustItem').value;
            const adjustment = parseInt(document.getElementById('adjustQuantity').value);
            const currentQty = parseInt(document.getElementById('adjustCurrentQty').value);
            const newQty = parseInt(document.getElementById('adjustNewQty').value);
            const reason = document.getElementById('adjustReason').value;
            const notes = document.getElementById('adjustNotes').value;
            
            if (newQty < 0) {
                if (!confirm(`Warning: This will set inventory to ${newQty} (NEGATIVE).\n\nAre you sure?`)) {
                    return;
                }
            }
            
            // Confirm the adjustment
            const item = cachedItems.find(i => i.Item_ID === itemId);
            const confirmMsg = `Adjust ${item.Item_Description}?\n\nCurrent: ${currentQty}\nAdjustment: ${adjustment > 0 ? '+' : ''}${adjustment}\nNew Total: ${newQty}\n\nReason: ${reason}`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            const data = {
                itemId: itemId,
                adjustment: adjustment,
                reference: 'MANUAL',
                reason: reason + (notes ? ' - ' + notes : '')
            };
            
            const result = await apiCall('adjustInventory', data);
            
            if (result && result.status === 'success') {
                showStatus('inventoryStatus', `âœ… Inventory adjusted! ${item.Item_Description}: ${currentQty} â†’ ${newQty}`, 'success');
                hideAdjustInventoryForm();
                loadInventory();
            } else {
                showStatus('inventoryStatus', 'âŒ Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        // ==================== REPORTS ====================
        
        let currentReport = null;
        let reportData = {};
        let rawReportData = {}; // Store unfiltered data for re-filtering
        let reportFilters = {}; // Store current filter values
        
        // Helper: Build filter UI HTML
        function buildFilterUI(reportType, options = {}) {
            const filterId = `filter-panel-${reportType}`;
            let html = '<div style="background: #f0f0f0; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;">ğŸ” Filters</h4>
                    <button class="btn-small" onclick="toggleFilters('${filterId}')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="${filterId}-toggle">â–¼ Hide</span>
                    </button>
                </div>`;
            html += `<div id="${filterId}" class="form-grid">`;
            
            // Date Range (common to most reports)
            if (options.dateRange) {
                const dateLabel = options.dateLabel || 'Date';
                html += `
                    <div class="form-group">
                        <label>${dateLabel} From</label>
                        <input type="date" id="filter_fromDate" value="${reportFilters.fromDate || ''}">
                    </div>
                    <div class="form-group">
                        <label>${dateLabel} To</label>
                        <input type="date" id="filter_toDate" value="${reportFilters.toDate || ''}">
                    </div>`;
            }
            
            // Customer dropdown
            if (options.customer) {
                html += `
                    <div class="form-group">
                        <label>Customer</label>
                        <select id="filter_customer">
                            <option value="">All Customers</option>
                            ${options.customerList.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>`;
            }
            
            // Supplier dropdown
            if (options.supplier) {
                html += `
                    <div class="form-group">
                        <label>Supplier</label>
                        <select id="filter_supplier">
                            <option value="">All Suppliers</option>
                            ${options.supplierList.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                        </select>
                    </div>`;
            }
            
            // Item dropdown
            if (options.item) {
                html += `
                    <div class="form-group">
                        <label>Product</label>
                        <select id="filter_item">
                            <option value="">All Products</option>
                            ${options.itemList.map(i => `<option value="${i.id}">${i.name}</option>`).join('')}
                        </select>
                    </div>`;
            }
            
            // Payment Status
            if (options.paymentStatus) {
                html += `
                    <div class="form-group">
                        <label>Payment Status</label>
                        <select id="filter_paymentStatus">
                            <option value="">All</option>
                            <option value="Paid">Paid</option>
                            <option value="Partial">Partial</option>
                            <option value="Unpaid">Unpaid</option>
                            <option value="Overdue">Overdue</option>
                        </select>
                    </div>`;
            }
            
            // Stock Status
            if (options.stockStatus) {
                html += `
                    <div class="form-group">
                        <label>Stock Status</label>
                        <select id="filter_stockStatus">
                            <option value="">All Items</option>
                            <option value="negative">ğŸš¨ Negative Inventory</option>
                            <option value="out">ğŸ”´ Out of Stock</option>
                            <option value="low">ğŸŸ¡ Low Stock</option>
                            <option value="ok">ğŸŸ¢ In Stock</option>
                        </select>
                    </div>`;
            }
            
            // Turnover Status
            if (options.turnoverStatus) {
                html += `
                    <div class="form-group">
                        <label>Movement</label>
                        <select id="filter_turnoverStatus">
                            <option value="">All</option>
                            <option value="Fast">Fast Movers</option>
                            <option value="Normal">Normal</option>
                            <option value="Slow">Slow Movers</option>
                        </select>
                    </div>`;
            }
            
            // Aging Filter (for AR/AP)
            if (options.aging) {
                html += `
                    <div class="form-group">
                        <label>Aging</label>
                        <select id="filter_aging">
                            <option value="">All</option>
                            <option value="Current">Current</option>
                            <option value="1-30">1-30 days</option>
                            <option value="31-60">31-60 days</option>
                            <option value="60+">60+ days</option>
                        </select>
                    </div>`;
            }
            
            // Minimum Amount
            if (options.minAmount) {
                html += `
                    <div class="form-group">
                        <label>Min Amount ($)</label>
                        <input type="number" id="filter_minAmount" step="0.01" placeholder="0.00">
                    </div>`;
            }
            
            html += `
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn" onclick="applyReportFilters('${reportType}')">ğŸ” Apply Filters</button>
                    <button class="btn btn-secondary" onclick="clearReportFilters('${reportType}')">ğŸ§¹ Clear Filters</button>
                </div>
            </div>`;
            html += '</div>';
            
            return html;
        }
        
        // Apply filters to current report
        async function applyReportFilters(reportType) {
            // Capture filter values
            reportFilters = {
                fromDate: document.getElementById('filter_fromDate')?.value || '',
                toDate: document.getElementById('filter_toDate')?.value || '',
                customer: document.getElementById('filter_customer')?.value || '',
                supplier: document.getElementById('filter_supplier')?.value || '',
                item: document.getElementById('filter_item')?.value || '',
                paymentStatus: document.getElementById('filter_paymentStatus')?.value || '',
                stockStatus: document.getElementById('filter_stockStatus')?.value || '',
                turnoverStatus: document.getElementById('filter_turnoverStatus')?.value || '',
                aging: document.getElementById('filter_aging')?.value || '',
                minAmount: parseFloat(document.getElementById('filter_minAmount')?.value) || 0
            };
            
            // Re-render report with filters
            await showReport(reportType);
        }
        
        // Clear all filters
        function clearReportFilters(reportType) {
            reportFilters = {};
            showReport(reportType);
        }
        
        // Toggle filter panel visibility
        function toggleFilters(panelId) {
            const panel = document.getElementById(panelId);
            const toggle = document.getElementById(`${panelId}-toggle`);
            
            if (panel.style.display === 'none') {
                panel.style.display = 'grid';
                toggle.textContent = 'â–¼ Hide';
            } else {
                panel.style.display = 'none';
                toggle.textContent = 'â–¶ Show';
            }
        }
        
        // Universal table sorting function
        function sortTable(tableId, columnIndex) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determine sort direction
            const header = table.querySelectorAll('th')[columnIndex];
            const currentDir = header.dataset.sortDir || 'asc';
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';
            
            // Clear all header indicators
            table.querySelectorAll('th').forEach(th => {
                th.style.cursor = 'pointer';
                th.dataset.sortDir = '';
                th.innerHTML = th.innerHTML.replace(' â–²', '').replace(' â–¼', '');
            });
            
            // Sort rows
            rows.sort((a, b) => {
                // Safety checks for undefined cells
                const aCell = a.cells[columnIndex];
                const bCell = b.cells[columnIndex];
                
                if (!aCell || !bCell) return 0;
                
                const aCellText = (aCell.textContent || '').trim();
                const bCellText = (bCell.textContent || '').trim();
                
                // Handle empty cells
                if (!aCellText && !bCellText) return 0;
                if (!aCellText) return 1;
                if (!bCellText) return -1;
                
                // Try numeric comparison first
                const aNum = parseFloat(aCellText.replace(/[$,]/g, ''));
                const bNum = parseFloat(bCellText.replace(/[$,]/g, ''));
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return newDir === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // Try date comparison
                const aDate = new Date(aCellText);
                const bDate = new Date(bCellText);
                if (!isNaN(aDate.getTime()) && !isNaN(bDate.getTime()) && aCellText.match(/\d/)) {
                    return newDir === 'asc' ? aDate - bDate : bDate - aDate;
                }
                
                // String comparison
                return newDir === 'asc' 
                    ? aCellText.localeCompare(bCellText)
                    : bCellText.localeCompare(aCellText);
            });
            
            // Update table
            rows.forEach(row => tbody.appendChild(row));
            
            // Update header
            header.dataset.sortDir = newDir;
            header.innerHTML += newDir === 'asc' ? ' â–²' : ' â–¼';
        }
        
        // Make table sortable
        function makeSortable(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                header.style.cursor = 'pointer';
                header.style.userSelect = 'none';
                header.onclick = () => sortTable(tableId, index);
                header.title = 'Click to sort';
            });
        }
        
        async function showReport(reportType) {
            // Mobile debugging - show what's happening
            console.log('ğŸ“± showReport called with:', reportType);
            
            // Open the report setup modal instead of running immediately
            try {
                openReportSetup(reportType);
            } catch (e) {
                alert('âŒ Error opening report setup: ' + e.message);
                console.error('Error in showReport:', e);
            }
        }
        
        // Report configuration for each report type
        const reportConfig = {
            'sales-by-customer': {
                title: 'ğŸ‘¥ Sales by Customer',
                filters: ['dateRange', 'customer', 'minAmount', 'transactionStatus'],
                dateLabel: 'Sale Date'
            },
            'sales-order-detail': {
                title: 'ğŸ“‹ Sales Order Detail',
                filters: ['dateRange', 'customer', 'paymentStatus', 'transactionStatus'],
                dateLabel: 'Sale Date'
            },
            'sales-by-product': {
                title: 'ğŸ“¦ Sales by Item',
                filters: ['dateRange', 'item', 'transactionStatus'],
                dateLabel: 'Sale Date'
            },
            'purchase-order-detail': {
                title: 'ğŸ“‹ Purchase Order Detail',
                filters: ['dateRange', 'supplier', 'poType', 'paymentStatus', 'transactionStatus'],
                dateLabel: 'PO Date'
            },
            'purchase-by-supplier': {
                title: 'ğŸ­ Purchase by Supplier',
                filters: ['dateRange', 'supplier', 'poType', 'transactionStatus'],
                dateLabel: 'PO Date'
            },
            'inventory-turnover': {
                title: 'ğŸ”„ Inventory Turnover',
                filters: ['supplier', 'stockStatus', 'turnoverStatus'],
                dateLabel: ''
            },
            'gross-margin': {
                title: 'ğŸ’° Gross Margin',
                filters: ['supplier', 'stockStatus'],
                dateLabel: ''
            },
            'accounts-receivable': {
                title: 'ğŸ’µ Accounts Receivable',
                filters: ['customer', 'aging'],
                dateLabel: ''
            },
            'accounts-payable': {
                title: 'ğŸ’¸ Accounts Payable',
                filters: ['supplier', 'aging'],
                dateLabel: ''
            },
            'simple-inventory': {
                title: 'ğŸ“‹ Inventory List',
                filters: ['supplier', 'stockStatus'],
                dateLabel: ''
            },
            'inventory-adjustments': {
                title: 'ğŸ“ Inventory Adjustment History',
                filters: ['dateRange', 'item', 'adjustmentType'],
                dateLabel: 'Adjustment Date'
            },
            'profit-loss': {
                title: 'ğŸ“Š Profit & Loss Statement',
                filters: ['yearSelect', 'quarterSelect', 'cogsMethod'],
                dateLabel: ''
            },
            'annual-sales-summary': {
                title: 'ğŸ“ˆ Annual Sales Summary',
                filters: ['yearSelect'],
                dateLabel: ''
            },
            'annual-purchase-summary': {
                title: 'ğŸ“‰ Annual Purchase Summary',
                filters: ['yearSelect'],
                dateLabel: ''
            },
            'inventory-valuation': {
                title: 'ğŸ’° Inventory Valuation',
                filters: ['supplier'],
                dateLabel: ''
            },
            'cash-flow-summary': {
                title: 'ğŸ’µ Cash Flow Summary',
                filters: ['yearSelect', 'quarterSelect'],
                dateLabel: ''
            },
            'daily-dashboard': {
                title: 'ğŸ¯ Sales Dashboard',
                filters: ['dateRange', 'customer'],
                dateLabel: 'Date'
            },
            'customer-dashboard': {
                title: 'ğŸ‘¤ Customer Dashboard',
                filters: ['customer', 'dateRange'],
                dateLabel: 'Date',
                customerRequired: true
            },
            'supplier-dashboard': {
                title: 'ğŸ­ Supplier Dashboard',
                filters: ['supplier', 'dateRange'],
                dateLabel: 'Date',
                supplierRequired: true
            }
        };
        
        function openReportSetup(reportType) {
            console.log('ğŸ“± openReportSetup called with:', reportType);
            currentReport = reportType;
            reportFilters = {}; // Reset filters
            
            const config = reportConfig[reportType] || { title: 'Report', filters: [] };
            console.log('ğŸ“± Report config:', config);
            
            // Set title
            document.getElementById('reportSetupTitle').textContent = config.title;
            
            // Build filter UI
            let filterHtml = '<div class="form-grid" style="gap: 15px;">';
            
            // Date Range
            if (config.filters.includes('dateRange')) {
                // Don't set default dates - show ALL records by default
                // User can add filters if they want to narrow it down
                
                filterHtml += `
                    <div class="form-group">
                        <label>ğŸ“… ${config.dateLabel || 'Date'} From</label>
                        <input type="date" id="rptFilter_fromDate" value="" placeholder="All dates">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“… ${config.dateLabel || 'Date'} To</label>
                        <input type="date" id="rptFilter_toDate" value="" placeholder="All dates">
                    </div>`;
            }
            
            // Customer dropdown - use card picker
            if (config.filters.includes('customer')) {
                filterHtml += `
                    <div class="form-group">
                        <label>ğŸ‘¤ Customer</label>
                        <input type="text" id="rptFilter_customer_display" placeholder="ğŸ” Click to select customer..." 
                            onclick="openCustomerPickerForReport()" readonly 
                            style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_customer" value="">
                    </div>`;
            }
            
            // Supplier dropdown - use card picker
            if (config.filters.includes('supplier')) {
                filterHtml += `
                    <div class="form-group">
                        <label>ğŸ­ Supplier</label>
                        <input type="text" id="rptFilter_supplier_display" placeholder="ğŸ” Click to select supplier..." 
                            onclick="openSupplierPickerForReport()" readonly 
                            style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_supplier" value="">
                    </div>`;
            }
            
            // Item/Product picker (smart search)
            if (config.filters.includes('item')) {
                filterHtml += `
                    <div class="form-group">
                        <label>ğŸ“¦ Item</label>
                        <input type="text" id="rptFilter_item_display" placeholder="ğŸ” All Items (click to filter)" onclick="openItemPickerForReport()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_item" value="">
                    </div>`;
            }
            
            // Payment Status
            if (config.filters.includes('paymentStatus')) {
                filterHtml += `
                    <div class="form-group">
                        <label>ğŸ’³ Payment Status</label>
                        <select id="rptFilter_paymentStatus">
                            <option value="">All</option>
                            <option value="Paid">âœ… Paid</option>
                            <option value="Partial">ğŸ”¶ Partial</option>
                            <option value="Unpaid">âŒ Unpaid</option>
                        </select>
                    </div>`;
            }
            
            // PO Type (Incoming/Outgoing)
            if (config.filters.includes('poType')) {
                filterHtml += `
                    <div class="form-group">
                        <label>ğŸ“¦ PO Type</label>
                        <input type="text" id="rptFilter_poType_display" placeholder="ğŸ” All Types (click to select)" onclick="openPOTypePicker()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_poType" value="">
                    </div>`;
            }
            
            // Stock Status
            if (config.filters.includes('stockStatus')) {
                filterHtml += `
                    <div class="form-group">
                        <label>ğŸ“Š Stock Status</label>
                        <select id="rptFilter_stockStatus">
                            <option value="">All Items</option>
                            <option value="negative">ğŸš¨ Negative Inventory</option>
                            <option value="out">ğŸ”´ Out of Stock</option>
                            <option value="low">ğŸŸ¡ Low Stock</option>
                            <option value="ok">ğŸŸ¢ In Stock</option>
                        </select>
                    </div>`;
            }
            
            // Turnover Status
            if (config.filters.includes('turnoverStatus')) {
                filterHtml += `
                    <div class="form-group">
                        <label>ğŸ”„ Turnover</label>
                        <select id="rptFilter_turnoverStatus">
                            <option value="">All</option>
                            <option value="dead">ğŸ’€ Dead Stock (0 sold)</option>
                            <option value="slow">ğŸ¢ Slow Moving</option>
                            <option value="fast">ğŸš€ Fast Moving</option>
                        </select>
                    </div>`;
            }
            
            // Aging
            if (config.filters.includes('aging')) {
                filterHtml += `
                    <div class="form-group">
                        <label>ğŸ“† Aging</label>
                        <select id="rptFilter_aging">
                            <option value="">All</option>
                            <option value="current">Current (0-30 days)</option>
                            <option value="30">31-60 days</option>
                            <option value="60">61-90 days</option>
                            <option value="90">90+ days</option>
                        </select>
                    </div>`;
            }
            
            // Min Amount
            if (config.filters.includes('minAmount')) {
                filterHtml += `
                    <div class="form-group">
                        <label>ğŸ’µ Min Amount</label>
                        <input type="number" id="rptFilter_minAmount" placeholder="0.00" min="0" step="0.01">
                    </div>`;
            }
            
            // Transaction Status (for filtering voided transactions)
            if (config.filters.includes('transactionStatus')) {
                filterHtml += `
                    <div class="form-group">
                        <label>ğŸ“‹ Transaction Status</label>
                        <select id="rptFilter_transactionStatus">
                            <option value="exclude-voided" selected>ğŸš« Exclude Voided</option>
                            <option value="">All Transactions</option>
                            <option value="Completed">âœ… Completed Only</option>
                            <option value="Pending">ğŸŸ¡ Pending Only</option>
                            <option value="Voided">âŒ Voided Only</option>
                        </select>
                    </div>`;
            }
            
            // Adjustment Type (for inventory adjustments report)
            if (config.filters.includes('adjustmentType')) {
                filterHtml += `
                    <div class="form-group">
                        <label>ğŸ“ Adjustment Type</label>
                        <select id="rptFilter_adjustmentType">
                            <option value="">All Types</option>
                            <option value="VOID REVERSAL">ğŸ”„ Void Reversals</option>
                            <option value="Manual">âœï¸ Manual Adjustments</option>
                            <option value="Sale">ğŸ“¤ Sales (Out)</option>
                            <option value="Purchase">ğŸ“¥ Purchases (In)</option>
                            <option value="OUTGOING">ğŸšš Outgoing/Returns</option>
                        </select>
                    </div>`;
            }
            
            // Year Select (for tax reports)
            if (config.filters.includes('yearSelect')) {
                const currentYear = new Date().getFullYear();
                const years = [];
                for (let y = currentYear; y >= currentYear - 5; y--) {
                    years.push(y);
                }
                filterHtml += `
                    <div class="form-group">
                        <label>ğŸ“… Year</label>
                        <select id="rptFilter_year">
                            ${years.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('')}
                        </select>
                    </div>`;
            }
            
            // Quarter Select (for tax reports)
            if (config.filters.includes('quarterSelect')) {
                filterHtml += `
                    <div class="form-group">
                        <label>ğŸ“Š Period</label>
                        <select id="rptFilter_quarter">
                            <option value="annual">Full Year</option>
                            <option value="Q1">Q1 (Jan-Mar)</option>
                            <option value="Q2">Q2 (Apr-Jun)</option>
                            <option value="Q3">Q3 (Jul-Sep)</option>
                            <option value="Q4">Q4 (Oct-Dec)</option>
                        </select>
                    </div>`;
            }
            
            // COGS Method (for P&L report)
            if (config.filters.includes('cogsMethod')) {
                filterHtml += `
                    <div class="form-group">
                        <label>ğŸ“¦ Cost of Goods Method</label>
                        <select id="rptFilter_cogsMethod">
                            <option value="actual">Actual Purchase Costs (from POs)</option>
                            <option value="standard">Standard Costs (from Items table)</option>
                        </select>
                    </div>`;
            }
            
            filterHtml += '</div>';
            
            // Add quick date presets if dateRange filter exists
            if (config.filters.includes('dateRange')) {
                filterHtml += `
                    <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                        <span style="color: #666; font-size: 13px;">Quick Select:</span>
                        <div style="position: relative; display: inline-block;">
                            <button type="button" class="btn" onclick="toggleDatePresetPicker()" 
                                    style="padding: 8px 16px; font-size: 13px; display: flex; align-items: center; gap: 8px;">
                                <span>ğŸ“…</span>
                                <span id="datePresetLabel">Choose Period</span>
                                <span style="opacity: 0.7;">â–¼</span>
                            </button>
                            <div id="datePresetDropdown" style="display: none; position: absolute; top: 100%; left: 0; z-index: 1000; margin-top: 5px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); min-width: 180px; overflow: hidden;">
                                <div onclick="selectDatePreset('today', 'ğŸ“† Today')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span>ğŸ“†</span> Today
                                </div>
                                <div onclick="selectDatePreset('week', 'ğŸ“… This Week')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span>ğŸ“…</span> This Week
                                </div>
                                <div onclick="selectDatePreset('month', 'ğŸ—“ï¸ This Month')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span>ğŸ—“ï¸</span> This Month
                                </div>
                                <div onclick="selectDatePreset('quarter', 'ğŸ“Š This Quarter')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span>ğŸ“Š</span> This Quarter
                                </div>
                                <div onclick="selectDatePreset('year', 'ğŸ“ˆ This Year')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span>ğŸ“ˆ</span> This Year
                                </div>
                                <div onclick="selectDatePreset('all', 'ğŸ—ƒï¸ All Time')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span>ğŸ—ƒï¸</span> All Time
                                </div>
                                <div onclick="selectDatePreset('clear', 'ğŸ”„ Clear Dates')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; background: #f8f9fa;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                    <span>ğŸ”„</span> <strong>Clear Dates</strong>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
            
            document.getElementById('reportSetupFilters').innerHTML = filterHtml;
            
            // Reset content area
            document.getElementById('reportSetupContent').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #888;">
                    <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“‹</div>
                    <p>Configure filters above and click <strong>Run Report</strong></p>
                </div>`;
            
            // Show modal
            console.log('ğŸ“± About to show report setup modal...');
            const modalElement = document.getElementById('reportSetupModal');
            console.log('ğŸ“± Modal element:', modalElement ? 'Found' : 'NOT FOUND');
            
            if (!modalElement) {
                alert('âŒ ERROR: Report modal element not found in DOM!');
                return;
            }
            
            modalElement.style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            console.log('ğŸ“± Modal should now be visible');
        }
        
        function setDatePreset(preset) {
            const today = new Date();
            let fromDate = new Date();
            let toDate = new Date();
            
            switch(preset) {
                case 'today':
                    fromDate = today;
                    toDate = today;
                    break;
                case 'week':
                    fromDate.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
                    toDate = today;
                    break;
                case 'month':
                    fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    toDate = today;
                    break;
                case 'quarter':
                    const quarter = Math.floor(today.getMonth() / 3);
                    fromDate = new Date(today.getFullYear(), quarter * 3, 1);
                    toDate = today;
                    break;
                case 'year':
                    fromDate = new Date(today.getFullYear(), 0, 1);
                    toDate = today;
                    break;
                case 'all':
                case 'clear':
                    // For "All Time" or "Clear Dates", CLEAR the date filters completely
                    // This shows ALL records without any date filtering
                    const fromEl = document.getElementById('rptFilter_fromDate');
                    const toEl = document.getElementById('rptFilter_toDate');
                    if (fromEl) fromEl.value = '';
                    if (toEl) toEl.value = '';
                    console.log('ğŸ“… Dates cleared - will show all records');
                    return; // Exit early, don't set dates below
            }
            
            const fromEl = document.getElementById('rptFilter_fromDate');
            const toEl = document.getElementById('rptFilter_toDate');
            if (fromEl) fromEl.value = fromDate.toISOString().split('T')[0];
            if (toEl) toEl.value = toDate.toISOString().split('T')[0];
            console.log('ğŸ“… Date preset applied:', preset, 'From:', fromDate.toISOString().split('T')[0], 'To:', toDate.toISOString().split('T')[0]);
        }
        
        function toggleDatePresetPicker() {
            const dropdown = document.getElementById('datePresetDropdown');
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
                // Close when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', closeDatePresetOnClickOutside);
                }, 10);
            } else {
                dropdown.style.display = 'none';
            }
        }
        
        function closeDatePresetOnClickOutside(e) {
            const dropdown = document.getElementById('datePresetDropdown');
            if (!e.target.closest('#datePresetDropdown') && !e.target.closest('[onclick*="toggleDatePresetPicker"]')) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeDatePresetOnClickOutside);
            }
        }
        
        function selectDatePreset(preset, label) {
            // Update the button label
            document.getElementById('datePresetLabel').textContent = label;
            // Close dropdown
            document.getElementById('datePresetDropdown').style.display = 'none';
            document.removeEventListener('click', closeDatePresetOnClickOutside);
            // Apply the preset
            setDatePreset(preset);
        }
        
        function closeReportSetup() {
            document.getElementById('reportSetupModal').style.display = 'none';
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open');
        }
        
        // Sort report table by column
        function sortReportTable(headerEl, colIndex) {
            const table = headerEl.closest('table');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const tfoot = table.querySelector('tfoot');
            if (!tbody) return;
            
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determine sort direction
            const currentDir = headerEl.dataset.sortDir || 'none';
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';
            
            // Reset all headers
            table.querySelectorAll('th').forEach(th => {
                th.dataset.sortDir = 'none';
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Set new direction
            headerEl.dataset.sortDir = newDir;
            headerEl.classList.add(newDir === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // Sort rows
            rows.sort((a, b) => {
                const aCell = a.cells[colIndex];
                const bCell = b.cells[colIndex];
                if (!aCell || !bCell) return 0;
                
                let aVal = aCell.textContent.trim();
                let bVal = bCell.textContent.trim();
                
                // Remove $ and , for numeric comparison
                const aNum = parseFloat(aVal.replace(/[$,%]/g, '').replace(/,/g, ''));
                const bNum = parseFloat(bVal.replace(/[$,%]/g, '').replace(/,/g, ''));
                
                // Check if both are numbers
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return newDir === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // String comparison
                return newDir === 'asc' 
                    ? aVal.localeCompare(bVal) 
                    : bVal.localeCompare(aVal);
            });
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }
        
        // Add sort styles to document
        (function addSortStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .sortable-header {
                    cursor: pointer;
                    user-select: none;
                    position: relative;
                    padding-right: 20px !important;
                }
                .sortable-header:hover {
                    background: rgba(0,0,0,0.1) !important;
                }
                .sortable-header::after {
                    content: 'â‡…';
                    position: absolute;
                    right: 5px;
                    opacity: 0.4;
                    font-size: 12px;
                }
                .sortable-header.sort-asc::after {
                    content: 'â–²';
                    opacity: 1;
                }
                .sortable-header.sort-desc::after {
                    content: 'â–¼';
                    opacity: 1;
                }
            `;
            document.head.appendChild(style);
        })();
        
        // Make all tables in report content sortable
        function makeReportTablesSortable() {
            const content = document.getElementById('reportSetupContent');
            if (!content) return;
            
            content.querySelectorAll('table.data-table thead th').forEach((th, idx) => {
                // Skip if already sortable
                if (th.classList.contains('sortable-header')) return;
                
                th.classList.add('sortable-header');
                th.onclick = function() { sortReportTable(this, idx); };
            });
        }
        
        // Print report with professional invoice-style formatting
        function printReport() {
            const content = document.getElementById('reportSetupContent');
            const title = document.getElementById('reportSetupTitle').textContent;
            
            if (!content.innerHTML || content.innerHTML.includes('Configure filters')) {
                alert('Please run the report first before printing.');
                return;
            }
            
            // Get invoice settings for company info
            const settings = {
                companyName: document.getElementById('invoiceCompanyName')?.value || 'Nowak Distributing',
                contactName: document.getElementById('invoiceContactName')?.value || '',
                address1: document.getElementById('invoiceAddress1')?.value || '',
                address2: document.getElementById('invoiceAddress2')?.value || '',
                cityStateZip: document.getElementById('invoiceCityStateZip')?.value || '',
                phone: document.getElementById('invoicePhone')?.value || '',
                email: document.getElementById('invoiceEmail')?.value || '',
                footer: document.getElementById('invoiceFooter')?.value || 'Thank you for your business!'
            };
            
            // Use professional navy color for all reports (not theme-dependent)
            const reportColor = '#1a365d';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title} - ${settings.companyName}</title>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        * { box-sizing: border-box; }
                        body { 
                            font-family: Arial, sans-serif; 
                            padding: 15px;
                            padding-top: 70px;
                            margin: 0;
                            color: #333;
                            width: 100%;
                            max-width: 100%;
                            overflow-x: visible;
                        }
                        
                        /* Fixed toolbar at top */
                        .print-toolbar {
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            background: #333;
                            color: white;
                            padding: 10px 15px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            flex-wrap: wrap;
                            gap: 10px;
                            z-index: 9999;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                        }
                        .print-toolbar .toolbar-title {
                            font-size: 12px;
                            flex: 1;
                            min-width: 150px;
                        }
                        .print-toolbar .toolbar-buttons {
                            display: flex;
                            gap: 8px;
                        }
                        .print-toolbar button {
                            padding: 12px 20px;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: bold;
                            white-space: nowrap;
                        }
                        .print-toolbar .btn-print {
                            background: #4CAF50;
                            color: white;
                        }
                        .print-toolbar .btn-close {
                            background: #f44336;
                            color: white;
                        }
                        @media (max-width: 500px) {
                            .print-toolbar {
                                flex-direction: column;
                                text-align: center;
                            }
                            .print-toolbar .toolbar-title {
                                font-size: 11px;
                            }
                            .print-toolbar .toolbar-buttons {
                                width: 100%;
                                justify-content: center;
                            }
                            body {
                                padding-top: 100px;
                            }
                        }
                        
                        /* Header - matches invoice style */
                        .report-header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 3px solid ${reportColor};
                            padding-bottom: 20px;
                        }
                        .report-header h1 {
                            color: ${reportColor};
                            margin: 0 0 5px 0;
                            font-size: 24pt;
                        }
                        .report-header .company-name {
                            font-size: 16pt;
                            margin: 5px 0;
                            font-weight: bold;
                        }
                        .report-header .report-date {
                            color: #666;
                            font-size: 11pt;
                        }
                        
                        /* Company Info Box - simplified for mobile */
                        .company-info {
                            background: #f8f9fa;
                            border: 1px solid #dee2e6;
                            border-left: 4px solid ${reportColor};
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 25px;
                        }
                        .company-info h3 {
                            margin: 0 0 10px 0;
                            color: ${reportColor};
                            font-size: 12pt;
                        }
                        .company-info p {
                            margin: 4px 0;
                            font-size: 11pt;
                            line-height: 1.4;
                        }
                        .company-info .section {
                            margin-bottom: 15px;
                        }
                        .company-info .section:last-child {
                            margin-bottom: 0;
                        }
                        
                        /* Tables */
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 15px 0; 
                            font-size: 10pt;
                        }
                        th { 
                            background: ${reportColor}; 
                            color: white; 
                            padding: 10px 8px; 
                            text-align: left;
                            font-weight: bold;
                        }
                        td { 
                            border: 1px solid #ddd; 
                            padding: 8px; 
                        }
                        tfoot tr { 
                            font-weight: bold; 
                            background: #f5f5f5; 
                        }
                        tfoot td {
                            border-top: 2px solid ${reportColor};
                        }
                        
                        /* Dashboard Cards (for print) */
                        .dash-card-grid {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 10px;
                            margin: 15px 0;
                        }
                        .dash-card {
                            border: 1px solid #ddd;
                            border-left: 4px solid ${reportColor};
                            padding: 10px;
                            border-radius: 6px;
                        }
                        .dash-card-label {
                            font-size: 8pt;
                            color: #666;
                            text-transform: uppercase;
                        }
                        .dash-card-value {
                            font-size: 16pt;
                            font-weight: bold;
                        }
                        .dash-card-sub {
                            font-size: 8pt;
                            color: #888;
                        }
                        .dash-section {
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            padding: 15px;
                            margin: 10px 0;
                        }
                        .top-item {
                            display: flex;
                            justify-content: space-between;
                            padding: 8px 0;
                            border-bottom: 1px solid #eee;
                        }
                        .top-item-rank {
                            display: inline-block;
                            width: 20px;
                            height: 20px;
                            border-radius: 50%;
                            text-align: center;
                            line-height: 20px;
                            font-size: 10px;
                            margin-right: 8px;
                            background: #f0f0f0;
                        }
                        
                        /* Print adjustments */
                        @media print { 
                            body { 
                                print-color-adjust: exact; 
                                -webkit-print-color-adjust: exact;
                                padding: 0.5in;
                                padding-top: 0.5in;
                            }
                            .no-print, .print-toolbar { display: none !important; }
                        }
                        
                        /* General content */
                        h3, h4 { color: ${reportColor}; margin: 15px 0 10px 0; }
                        p { margin: 5px 0; }
                    </style>
                </head>
                <body>
                    <div class="print-toolbar no-print">
                        <span class="toolbar-title">ğŸ“„ Report Preview - Click Print or Save as PDF, then Close</span>
                        <div class="toolbar-buttons">
                            <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ Print / Save PDF</button>
                            <button class="btn-close" onclick="window.close()">âœ• Close</button>
                        </div>
                    </div>
                    
                    <div class="report-header">
                        <h1>${title.replace(/^[^\w]+/, '')}</h1>
                        <div class="company-name">${settings.companyName}</div>
                        <div class="report-date">Generated: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</div>
                    </div>
                    
                    ${content.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            
            // Don't auto-print - let user review first, then click Print button
            // This avoids the browser's PDF viewer taking over with no escape
        }
        
        // Helper to get current theme colors for printing
        function getCurrentThemeColors() {
            const root = document.documentElement;
            const styles = getComputedStyle(root);
            return {
                primary: styles.getPropertyValue('--primary').trim() || '#667eea',
                secondary: styles.getPropertyValue('--secondary').trim() || '#764ba2',
                text: styles.getPropertyValue('--text-dark').trim() || '#333333'
            };
        }
        
        // Email report
        function emailReport() {
            const title = document.getElementById('reportSetupTitle').textContent;
            const content = document.getElementById('reportSetupContent');
            
            if (!content.innerHTML || content.innerHTML.includes('Configure filters')) {
                alert('Please run the report first before emailing.');
                return;
            }
            
            const companyName = document.getElementById('invoiceCompanyName')?.value || 'Nowak Distributing';
            
            // Extract text content for email body
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content.innerHTML;
            const textContent = tempDiv.innerText.substring(0, 1500) + '...';
            
            const subject = encodeURIComponent(`${title} - ${companyName} - ${new Date().toLocaleDateString()}`);
            const body = encodeURIComponent(`${title}\n${companyName}\nGenerated: ${new Date().toLocaleString()}\n\n${textContent}\n\n---\nFull report available in the ERP system.`);
            
            window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
        }
        
        // Text/SMS report
        function textReport() {
            const title = document.getElementById('reportSetupTitle').textContent;
            const content = document.getElementById('reportSetupContent');
            
            if (!content.innerHTML || content.innerHTML.includes('Configure filters')) {
                alert('Please run the report first before texting.');
                return;
            }
            
            const companyName = document.getElementById('invoiceCompanyName')?.value || 'Nowak Distributing';
            
            // Extract key numbers for SMS
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content.innerHTML;
            const textContent = tempDiv.innerText.substring(0, 250);
            
            const message = encodeURIComponent(`${companyName}\n${title}\n${new Date().toLocaleDateString()}\n\n${textContent}...`);
            
            // Try SMS on mobile, fallback to prompt
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                window.open(`sms:?body=${message}`, '_blank');
            } else {
                const phone = prompt('Enter phone number to text:');
                if (phone) {
                    window.open(`sms:${phone}?body=${message}`, '_blank');
                }
            }
        }
        
        // Save report as PDF (print to PDF)
        function saveReportPDF() {
            const content = document.getElementById('reportSetupContent');
            
            if (!content.innerHTML || content.innerHTML.includes('Configure filters')) {
                alert('Please run the report first before saving.');
                return;
            }
            
            alert('ğŸ’¡ Tip: Use the Print button and select "Save as PDF" as your printer to save this report.');
            printReport();
        }
        
        async function executeReport() {
            console.log('ğŸ“± executeReport called for:', currentReport);
            
            // Gather filter values
            reportFilters = {
                fromDate: document.getElementById('rptFilter_fromDate')?.value || '',
                toDate: document.getElementById('rptFilter_toDate')?.value || '',
                customer: document.getElementById('rptFilter_customer')?.value || '',
                supplier: document.getElementById('rptFilter_supplier')?.value || '',
                item: document.getElementById('rptFilter_item')?.value || '',
                paymentStatus: document.getElementById('rptFilter_paymentStatus')?.value || '',
                poType: document.getElementById('rptFilter_poType')?.value || '',
                stockStatus: document.getElementById('rptFilter_stockStatus')?.value || '',
                turnoverStatus: document.getElementById('rptFilter_turnoverStatus')?.value || '',
                aging: document.getElementById('rptFilter_aging')?.value || '',
                minAmount: parseFloat(document.getElementById('rptFilter_minAmount')?.value) || 0,
                year: document.getElementById('rptFilter_year')?.value || new Date().getFullYear(),
                quarter: document.getElementById('rptFilter_quarter')?.value || 'annual',
                cogsMethod: document.getElementById('rptFilter_cogsMethod')?.value || 'actual',
                transactionStatus: document.getElementById('rptFilter_transactionStatus')?.value || 'exclude-voided',
                adjustmentType: document.getElementById('rptFilter_adjustmentType')?.value || ''
            };
            
            console.log('ğŸ“± Report filters:', reportFilters);
            
            const container = document.getElementById('reportSetupContent');
            
            // Show loading
            container.innerHTML = '<div style="padding: 40px; text-align: center;"><div style="font-size: 24px; margin-bottom: 10px;">â³</div>Generating report...</div>';
            
            try {
                console.log('ğŸ“± About to generate report:', currentReport);
                let reportHtml = '';
                
                switch(currentReport) {
                    case 'sales-by-customer':
                        reportHtml = await generateSalesByCustomerModal();
                        break;
                    case 'sales-order-detail':
                        reportHtml = await generateSalesOrderDetailModal();
                        break;
                    case 'sales-by-product':
                        reportHtml = await generateSalesByProductModal();
                        break;
                    case 'purchase-order-detail':
                        reportHtml = await generatePurchaseOrderDetailModal();
                        break;
                    case 'purchase-by-supplier':
                        reportHtml = await generatePurchaseBySupplierModal();
                        break;
                    case 'inventory-turnover':
                        reportHtml = await generateInventoryTurnoverModal();
                        break;
                    case 'gross-margin':
                        reportHtml = await generateGrossMarginModal();
                        break;
                    case 'accounts-receivable':
                        reportHtml = await generateAccountsReceivableModal();
                        break;
                    case 'accounts-payable':
                        reportHtml = await generateAccountsPayableModal();
                        break;
                    case 'simple-inventory':
                        reportHtml = await generateSimpleInventoryModal();
                        break;
                    case 'inventory-adjustments':
                        reportHtml = await generateInventoryAdjustmentsModal();
                        break;
                    case 'profit-loss':
                        reportHtml = await generateProfitLossModal();
                        break;
                    case 'annual-sales-summary':
                        reportHtml = await generateAnnualSalesSummaryModal();
                        break;
                    case 'annual-purchase-summary':
                        reportHtml = await generateAnnualPurchaseSummaryModal();
                        break;
                    case 'inventory-valuation':
                        reportHtml = await generateInventoryValuationModal();
                        break;
                    case 'cash-flow-summary':
                        reportHtml = await generateCashFlowSummaryModal();
                        break;
                    case 'daily-dashboard':
                        reportHtml = await generateDailyDashboardModal();
                        break;
                    case 'customer-dashboard':
                        if (!reportFilters.customer) {
                            throw new Error('Please select a customer first');
                        }
                        reportHtml = await generateCustomerDashboardModal();
                        break;
                    case 'supplier-dashboard':
                        if (!reportFilters.supplier) {
                            throw new Error('Please select a supplier first');
                        }
                        reportHtml = await generateSupplierDashboardModal();
                        break;
                }
                
                container.innerHTML = reportHtml;
                
                // Make tables sortable
                makeReportTablesSortable();
                
            } catch (error) {
                container.innerHTML = `<div style="padding: 40px; text-align: center; color: red;"><div style="font-size: 24px; margin-bottom: 10px;">âŒ</div>Error: ${error.message}</div>`;
            }
        }
        
        // Modal versions of report generators that return HTML instead of writing to reportContainer
        async function generateSalesByCustomerModal() {
            const salesResult = await apiCall('getSalesOrders');
            const customersResult = await apiCall('getCustomers');
            const itemsResult = await apiCall('getItems');
            
            if (!salesResult?.data || !customersResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const customers = customersResult.data;
            const items = itemsResult.data;
            let sales = salesResult.data;
            
            // Apply transaction status filter to sales orders first
            const statusFilter = reportFilters.transactionStatus || 'exclude-voided';
            if (statusFilter === 'exclude-voided') {
                sales = sales.filter(s => s.Status !== 'Voided');
            } else if (statusFilter && statusFilter !== '') {
                sales = sales.filter(s => s.Status === statusFilter);
            }
            
            // Fetch ALL sales order lines
            const allDetails = [];
            for (const so of sales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const unitsPerPackage = parseFloat(item?.Units_Per_Package) || 1;
                        const packageCost = parseFloat(item?.Package_Cost) || 0;
                        const unitCost = packageCost / unitsPerPackage;
                        const quantity = parseInt(line.Quantity || 0);
                        const lineTotal = parseFloat(line.Line_Total || 0);
                        const lineCost = quantity * unitCost;
                        
                        allDetails.push({
                            soId: so.SO_ID,
                            soDate: so.Sale_Date || so.SO_Date,
                            customerId: so.Customer_ID,
                            customerName: getCustomerName(so.Customer_ID),
                            itemId: line.Item_ID,
                            itemDescription: item?.Item_Description || line.Item_ID,
                            quantity: quantity,
                            lineTotal: lineTotal,
                            lineCost: lineCost,
                            profit: lineTotal - lineCost
                        });
                    });
                }
            }
            
            // Helper function to parse dates in various formats
            function parseFlexibleDate(dateVal) {
                if (!dateVal) return null;
                
                // If already a Date object
                if (dateVal instanceof Date) return dateVal;
                
                // Convert to string
                const dateStr = String(dateVal).trim();
                if (!dateStr) return null;
                
                // Try ISO format first (2025-12-09)
                let parsed = new Date(dateStr);
                if (!isNaN(parsed.getTime())) return parsed;
                
                // Try parsing MM/DD/YYYY or M/D/YYYY format (with optional time)
                const usMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (usMatch) {
                    const month = parseInt(usMatch[1]) - 1;
                    const day = parseInt(usMatch[2]);
                    const year = parseInt(usMatch[3]);
                    return new Date(year, month, day);
                }
                
                return null;
            }
            
            // Apply filters with mobile-safe date parsing
            let filtered = allDetails;
            
            // Date filters
            if (reportFilters.fromDate && reportFilters.fromDate.trim() !== '') {
                const fromDate = new Date(reportFilters.fromDate);
                if (!isNaN(fromDate.getTime())) {
                    fromDate.setHours(0, 0, 0, 0);
                    filtered = filtered.filter(d => {
                        const soDate = parseDateSafe(d.soDate);
                        return soDate && soDate >= fromDate;
                    });
                }
            }
            if (reportFilters.toDate && reportFilters.toDate.trim() !== '') {
                const toDate = new Date(reportFilters.toDate);
                if (!isNaN(toDate.getTime())) {
                    toDate.setHours(23, 59, 59, 999);
                    filtered = filtered.filter(d => {
                        const soDate = parseDateSafe(d.soDate);
                        return soDate && soDate <= toDate;
                    });
                }
            }
            if (reportFilters.customer) {
                filtered = filtered.filter(d => d.customerId === reportFilters.customer);
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(d => d.lineTotal >= reportFilters.minAmount);
            }
            
            // Group by customer
            const byCustomer = {};
            filtered.forEach(d => {
                if (!byCustomer[d.customerId]) {
                    byCustomer[d.customerId] = { name: d.customerName, sales: 0, cost: 0, profit: 0, orders: new Set() };
                }
                byCustomer[d.customerId].sales += d.lineTotal;
                byCustomer[d.customerId].cost += d.lineCost;
                byCustomer[d.customerId].profit += d.profit;
                byCustomer[d.customerId].orders.add(d.soId);
            });
            
            // Build filter summary
            const filterSummary = generateFilterSummary();
            
            // Build HTML
            let html = `<h3 style="margin-top: 0;">Sales by Customer Report</h3>`;
            html += filterSummary;
            html += `<p style="color: #666; margin-bottom: 20px;">${filtered.length} line items from ${Object.keys(byCustomer).length} customers</p>`;
            
            html += `<div style="overflow-x: auto;"><table class="data-table">
                <thead><tr>
                    <th>Customer</th>
                    <th style="text-align: right;">Orders</th>
                    <th style="text-align: right;">Sales</th>
                    <th style="text-align: right;">Cost</th>
                    <th style="text-align: right;">Profit</th>
                    <th style="text-align: right;">Margin</th>
                </tr></thead><tbody>`;
            
            let totalSales = 0, totalCost = 0, totalProfit = 0, totalOrders = 0;
            Object.entries(byCustomer)
                .sort((a, b) => b[1].sales - a[1].sales)
                .forEach(([id, data]) => {
                    const margin = data.sales > 0 ? (data.profit / data.sales * 100) : 0;
                    totalSales += data.sales;
                    totalCost += data.cost;
                    totalProfit += data.profit;
                    totalOrders += data.orders.size;
                    html += `<tr>
                        <td>${data.name}</td>
                        <td style="text-align: right;">${data.orders.size}</td>
                        <td style="text-align: right;">$${data.sales.toFixed(2)}</td>
                        <td style="text-align: right;">$${data.cost.toFixed(2)}</td>
                        <td style="text-align: right; color: ${data.profit >= 0 ? '#2e7d32' : '#c62828'};">$${data.profit.toFixed(2)}</td>
                        <td style="text-align: right;">${margin.toFixed(1)}%</td>
                    </tr>`;
                });
            
            const totalMargin = totalSales > 0 ? (totalProfit / totalSales * 100) : 0;
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td>TOTAL</td>
                <td style="text-align: right;">${totalOrders}</td>
                <td style="text-align: right;">$${totalSales.toFixed(2)}</td>
                <td style="text-align: right;">$${totalCost.toFixed(2)}</td>
                <td style="text-align: right; color: ${totalProfit >= 0 ? '#2e7d32' : '#c62828'};">$${totalProfit.toFixed(2)}</td>
                <td style="text-align: right;">${totalMargin.toFixed(1)}%</td>
            </tr></tfoot></table></div>`;
            
            return html;
        }
        
        // Simplified modal generators for other reports - they use the same data but return HTML
        async function generateSalesOrderDetailModal() {
            const salesResult = await apiCall('getSalesOrders');
            if (!salesResult?.data) throw new Error('Failed to load sales data');
            
            let sales = salesResult.data;
            
            // Helper function to parse dates in various formats
            function parseFlexibleDate(dateVal) {
                if (!dateVal) return null;
                if (dateVal instanceof Date) return dateVal;
                const dateStr = String(dateVal).trim();
                if (!dateStr) return null;
                let parsed = new Date(dateStr);
                if (!isNaN(parsed.getTime())) return parsed;
                const usMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (usMatch) {
                    return new Date(parseInt(usMatch[3]), parseInt(usMatch[1]) - 1, parseInt(usMatch[2]));
                }
                return null;
            }
            
            // Apply filters with mobile-safe date parsing
            if (reportFilters.fromDate && reportFilters.fromDate.trim() !== '') {
                const fromDate = new Date(reportFilters.fromDate);
                if (!isNaN(fromDate.getTime())) {
                    fromDate.setHours(0, 0, 0, 0);
                    sales = sales.filter(s => {
                        const saleDate = parseDateSafe(s.Sale_Date || s.SO_Date);
                        return saleDate && saleDate >= fromDate;
                    });
                }
            }
            if (reportFilters.toDate && reportFilters.toDate.trim() !== '') {
                const toDate = new Date(reportFilters.toDate);
                if (!isNaN(toDate.getTime())) {
                    toDate.setHours(23, 59, 59, 999);
                    sales = sales.filter(s => {
                        const saleDate = parseDateSafe(s.Sale_Date || s.SO_Date);
                        return saleDate && saleDate <= toDate;
                    });
                }
            }
            if (reportFilters.customer) {
                sales = sales.filter(s => s.Customer_ID === reportFilters.customer);
            }
            if (reportFilters.paymentStatus) {
                sales = sales.filter(s => s.Payment_Status === reportFilters.paymentStatus);
            }
            
            let html = `<h3 style="margin-top: 0;">Sales Order Detail</h3>`;
            html += `<p style="color: #666; margin-bottom: 20px;">${sales.length} orders found</p>`;
            
            html += `<div style="overflow-x: auto;"><table class="data-table">
                <thead><tr>
                    <th>Invoice #</th>
                    <th>Date</th>
                    <th>Customer</th>
                    <th style="text-align: right;">Total</th>
                    <th>Payment</th>
                </tr></thead><tbody>`;
            
            let total = 0;
            sales.sort((a, b) => new Date(b.Sale_Date || b.SO_Date) - new Date(a.Sale_Date || a.SO_Date))
                .forEach(s => {
                    const amt = parseFloat(s.Total_Amount) || 0;
                    total += amt;
                    html += `<tr>
                        <td>${s.Invoice_Number || s.SO_Number || '-'}</td>
                        <td>${s.Sale_Date || s.SO_Date || '-'}</td>
                        <td>${getCustomerName(s.Customer_ID)}</td>
                        <td style="text-align: right;">$${amt.toFixed(2)}</td>
                        <td>${s.Payment_Status || 'Unpaid'}</td>
                    </tr>`;
                });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="3">TOTAL</td>
                <td style="text-align: right;">$${total.toFixed(2)}</td>
                <td></td>
            </tr></tfoot></table></div>`;
            
            return html;
        }
        
        async function generateSalesByProductModal() {
            const itemsResult = await apiCall('getItems');
            const suppliersResult = await apiCall('getSuppliers');
            const salesResult = await apiCall('getSalesOrders');
            
            if (!itemsResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const suppliers = suppliersResult.data;
            let sales = salesResult?.data || [];
            
            // Apply transaction status filter to sales orders
            const statusFilter = reportFilters.transactionStatus || 'exclude-voided';
            if (statusFilter === 'exclude-voided') {
                sales = sales.filter(so => so.Status !== 'Voided');
            } else if (statusFilter && statusFilter !== '') {
                sales = sales.filter(so => so.Status === statusFilter);
            }
            
            // Fetch ALL sales order lines to get units sold
            const allLines = [];
            for (const so of sales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        line.SO_Date = so.Sale_Date || so.SO_Date;
                        allLines.push(line);
                    });
                }
            }
            
            // APPLY DATE FILTERS to sales lines using safe parsing
            let filteredLines = allLines;
            filteredLines = applyDateRangeFilter(filteredLines, 'SO_Date');
            
            // APPLY ITEM FILTER if specified
            if (reportFilters.item) {
                filteredLines = filteredLines.filter(line => line.Item_ID === reportFilters.item);
            }
            
            // Calculate units sold per item
            const unitsSoldByItem = {};
            const revenueBYItem = {};
            filteredLines.forEach(line => {
                const itemId = line.Item_ID;
                const qty = parseInt(line.Quantity || 0);
                const lineTotal = parseFloat(line.Line_Total || 0);
                unitsSoldByItem[itemId] = (unitsSoldByItem[itemId] || 0) + qty;
                revenueBYItem[itemId] = (revenueBYItem[itemId] || 0) + lineTotal;
            });
            
            // Build product list with margins - ONLY items that were sold
            const productData = items
                .filter(item => unitsSoldByItem[item.Item_ID] > 0) // Only items with sales
                .map(item => {
                    const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                    const packageCost = parseFloat(item.Package_Cost) || 0;
                    const unitCost = packageCost / unitsPerPackage;
                    const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                    const margin = unitSellPrice - unitCost;
                    const marginPercent = unitSellPrice > 0 ? (margin / unitSellPrice) * 100 : 0;
                    const unitsSold = unitsSoldByItem[item.Item_ID] || 0;
                    const revenue = revenueBYItem[item.Item_ID] || 0;
                    const cost = unitsSold * unitCost;
                    const totalProfit = revenue - cost;
                    
                    return {
                        id: item.Item_ID,
                        description: item.Item_Description || '',
                        sku: item.SKU || '',
                        supplierId: item.Supplier_ID || '',
                        supplierName: suppliers.find(s => s.Supplier_ID === item.Supplier_ID)?.Supplier_Name || '',
                        unitCost: unitCost,
                        unitSellPrice: unitSellPrice,
                        margin: margin,
                        marginPercent: marginPercent,
                        unitsSold: unitsSold,
                        revenue: revenue,
                        cost: cost,
                        totalProfit: totalProfit
                    };
                });
            
            // Sort by units sold (highest first)
            const sorted = productData.sort((a, b) => b.unitsSold - a.unitsSold);
            
            // Calculate totals
            const totalUnits = sorted.reduce((sum, p) => sum + p.unitsSold, 0);
            const totalRevenue = sorted.reduce((sum, p) => sum + p.revenue, 0);
            const totalCost = sorted.reduce((sum, p) => sum + p.cost, 0);
            const totalProfit = sorted.reduce((sum, p) => sum + p.totalProfit, 0);
            const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
            
            let html = `
                <h3 style="margin-top: 0;">Sales by Item</h3>
                <p style="color: #666; margin-bottom: 20px;">${sorted.length} items sold | ${totalUnits.toLocaleString()} units | ${avgMargin.toFixed(1)}% avg margin</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 5px;">ğŸ’° Revenue</div>
                        <div style="font-size: 24px; font-weight: bold; color: #1976d2;">$${totalRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maxFractionDigits: 2})}</div>
                    </div>
                    <div style="background: #ffebee; padding: 15px; border-radius: 8px; border-left: 4px solid #f44336;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 5px;">ğŸ’¸ Cost</div>
                        <div style="font-size: 24px; font-weight: bold; color: #c62828;">$${totalCost.toLocaleString('en-US', {minimumFractionDigits: 2, maxFractionDigits: 2})}</div>
                    </div>
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 5px;">ğŸ“ˆ Profit</div>
                        <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">$${totalProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maxFractionDigits: 2})}</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 5px;">ğŸ“Š Margin</div>
                        <div style="font-size: 24px; font-weight: bold; color: #f57c00;">${avgMargin.toFixed(1)}%</div>
                    </div>
                </div>
            `;
            
            if (sorted.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No sales found for the selected period</p>';
            } else {
                html += `<div style="overflow-x: auto;"><table class="data-table">
                    <thead><tr>
                        <th>SKU</th>
                        <th>Item</th>
                        <th>Supplier</th>
                        <th style="text-align: right;">Units Sold</th>
                        <th style="text-align: right;">Revenue</th>
                        <th style="text-align: right;">Cost</th>
                        <th style="text-align: right;">Profit</th>
                        <th style="text-align: right;">Margin %</th>
                    </tr></thead>
                    <tbody>`;
                
                sorted.forEach(item => {
                    html += `<tr>
                        <td><strong>${item.sku}</strong></td>
                        <td>${item.description}</td>
                        <td>${item.supplierName}</td>
                        <td style="text-align: right;"><strong>${item.unitsSold.toLocaleString()}</strong></td>
                        <td style="text-align: right;">$${item.revenue.toFixed(2)}</td>
                        <td style="text-align: right;">$${item.cost.toFixed(2)}</td>
                        <td style="text-align: right; color: ${item.totalProfit >= 0 ? '#2e7d32' : '#c62828'}; font-weight: bold;">$${item.totalProfit.toFixed(2)}</td>
                        <td style="text-align: right; font-weight: bold;">${item.marginPercent.toFixed(1)}%</td>
                    </tr>`;
                });
                
                html += `</tbody></table></div>`;
            }
            
            return html;
        }
        
        async function generatePurchaseOrderDetailModal() {
            const poResult = await apiCall('getPurchaseOrders');
            if (!poResult?.data) throw new Error('Failed to load PO data');
            
            let purchases = poResult.data;
            
            // Helper function to parse dates in various formats
            function parseFlexibleDate(dateVal) {
                if (!dateVal) return null;
                if (dateVal instanceof Date) return dateVal;
                const dateStr = String(dateVal).trim();
                if (!dateStr) return null;
                let parsed = new Date(dateStr);
                if (!isNaN(parsed.getTime())) return parsed;
                const usMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (usMatch) {
                    return new Date(parseInt(usMatch[3]), parseInt(usMatch[1]) - 1, parseInt(usMatch[2]));
                }
                return null;
            }
            
            if (reportFilters.fromDate) {
                const fromDate = new Date(reportFilters.fromDate);
                fromDate.setHours(0, 0, 0, 0);
                purchases = purchases.filter(p => {
                    const poDate = parseFlexibleDate(p.PO_Date);
                    return poDate && poDate >= fromDate;
                });
            }
            if (reportFilters.toDate) {
                const toDate = new Date(reportFilters.toDate);
                toDate.setHours(23, 59, 59, 999);
                purchases = purchases.filter(p => {
                    const poDate = parseFlexibleDate(p.PO_Date);
                    return poDate && poDate <= toDate;
                });
            }
            if (reportFilters.supplier) {
                purchases = purchases.filter(p => p.Supplier_ID === reportFilters.supplier);
            }
            if (reportFilters.paymentStatus) {
                purchases = purchases.filter(p => p.Payment_Status === reportFilters.paymentStatus);
            }
            
            // Filter by PO Type
            if (reportFilters.poType) {
                purchases = purchases.filter(p => (p.PO_Type || 'INCOMING') === reportFilters.poType);
            }
            
            // Apply transaction status filter
            const statusFilter = reportFilters.transactionStatus || 'exclude-voided';
            if (statusFilter === 'exclude-voided') {
                purchases = purchases.filter(p => p.Status !== 'Voided');
            } else if (statusFilter && statusFilter !== '') {
                purchases = purchases.filter(p => p.Status === statusFilter);
            }
            
            // Show PO type filter in header
            const poTypeLabel = reportFilters.poType === 'INCOMING' ? 'ğŸ“¥ Incoming Only' : 
                               reportFilters.poType === 'OUTGOING' ? 'ğŸ“¤ Outgoing Only' : 'ğŸ“‹ All Types';
            
            let html = `<h3 style="margin-top: 0;">Purchase Order Detail</h3>`;
            html += `<p style="color: #666; margin-bottom: 20px;">${purchases.length} orders found | ${poTypeLabel}</p>`;
            
            html += `<div style="overflow-x: auto;"><table class="data-table">
                <thead><tr>
                    <th>PO #</th>
                    <th>Date</th>
                    <th>Supplier</th>
                    <th>Type</th>
                    <th style="text-align: right;">Total</th>
                    <th>Status</th>
                </tr></thead><tbody>`;
            
            let total = 0;
            purchases.sort((a, b) => new Date(b.PO_Date) - new Date(a.PO_Date))
                .forEach(p => {
                    const amt = parseFloat(p.Total_Amount) || 0;
                    total += amt;
                    const poType = p.PO_Type || 'INCOMING';
                    const typeStyle = poType === 'OUTGOING' 
                        ? 'background: #e3f2fd; color: #1565c0;' 
                        : 'background: #e8f5e9; color: #2e7d32;';
                    html += `<tr>
                        <td>${p.PO_Number || p.Invoice_Number || '-'}</td>
                        <td>${p.PO_Date || '-'}</td>
                        <td>${getSupplierName(p.Supplier_ID)}</td>
                        <td><span style="${typeStyle} padding: 3px 8px; border-radius: 4px; font-size: 11px;">${poType === 'OUTGOING' ? 'ğŸ“¤ Out' : 'ğŸ“¥ In'}</span></td>
                        <td style="text-align: right;">$${amt.toFixed(2)}</td>
                        <td>${p.Status || '-'}</td>
                    </tr>`;
                });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="4">TOTAL</td>
                <td style="text-align: right;">$${total.toFixed(2)}</td>
                <td></td>
            </tr></tfoot></table></div>`;
            
            return html;
        }
        
        async function generatePurchaseBySupplierModal() {
            const poResult = await apiCall('getPurchaseOrders');
            if (!poResult?.data) throw new Error('Failed to load PO data');
            
            let purchases = poResult.data;
            
            // Helper function to parse dates in various formats
            function parseFlexibleDate(dateVal) {
                if (!dateVal) return null;
                if (dateVal instanceof Date) return dateVal;
                const dateStr = String(dateVal).trim();
                if (!dateStr) return null;
                let parsed = new Date(dateStr);
                if (!isNaN(parsed.getTime())) return parsed;
                const usMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (usMatch) {
                    return new Date(parseInt(usMatch[3]), parseInt(usMatch[1]) - 1, parseInt(usMatch[2]));
                }
                return null;
            }
            
            if (reportFilters.fromDate) {
                const fromDate = new Date(reportFilters.fromDate);
                fromDate.setHours(0, 0, 0, 0);
                purchases = purchases.filter(p => {
                    const poDate = parseFlexibleDate(p.PO_Date);
                    return poDate && poDate >= fromDate;
                });
            }
            if (reportFilters.toDate) {
                const toDate = new Date(reportFilters.toDate);
                toDate.setHours(23, 59, 59, 999);
                purchases = purchases.filter(p => {
                    const poDate = parseFlexibleDate(p.PO_Date);
                    return poDate && poDate <= toDate;
                });
            }
            if (reportFilters.supplier) {
                purchases = purchases.filter(p => p.Supplier_ID === reportFilters.supplier);
            }
            
            // Filter by PO Type
            if (reportFilters.poType) {
                purchases = purchases.filter(p => (p.PO_Type || 'INCOMING') === reportFilters.poType);
            }
            
            // Apply transaction status filter
            const statusFilter = reportFilters.transactionStatus || 'exclude-voided';
            if (statusFilter === 'exclude-voided') {
                purchases = purchases.filter(p => p.Status !== 'Voided');
            } else if (statusFilter && statusFilter !== '') {
                purchases = purchases.filter(p => p.Status === statusFilter);
            }
            
            // Group by supplier
            const bySupplier = {};
            purchases.forEach(p => {
                const suppId = p.Supplier_ID;
                if (!bySupplier[suppId]) {
                    bySupplier[suppId] = { name: getSupplierName(suppId), total: 0, count: 0 };
                }
                bySupplier[suppId].total += parseFloat(p.Total_Amount) || 0;
                bySupplier[suppId].count++;
            });
            
            // Show PO type filter in header
            const poTypeLabel = reportFilters.poType === 'INCOMING' ? 'ğŸ“¥ Incoming Only' : 
                               reportFilters.poType === 'OUTGOING' ? 'ğŸ“¤ Outgoing Only' : 'ğŸ“‹ All Types';
            
            let html = `<h3 style="margin-top: 0;">Purchase by Supplier</h3>`;
            html += `<p style="color: #666; margin-bottom: 20px;">${Object.keys(bySupplier).length} suppliers | ${purchases.length} orders | ${poTypeLabel}</p>`;
            
            html += `<div style="overflow-x: auto;"><table class="data-table">
                <thead><tr>
                    <th>Supplier</th>
                    <th style="text-align: right;">Orders</th>
                    <th style="text-align: right;">Total</th>
                </tr></thead><tbody>`;
            
            let grandTotal = 0;
            let totalOrderCount = 0;
            Object.entries(bySupplier)
                .sort((a, b) => b[1].total - a[1].total)
                .forEach(([id, data]) => {
                    grandTotal += data.total;
                    totalOrderCount += data.count;
                    html += `<tr>
                        <td>${data.name}</td>
                        <td style="text-align: right;">${data.count}</td>
                        <td style="text-align: right;">$${data.total.toFixed(2)}</td>
                    </tr>`;
                });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td>TOTAL</td>
                <td style="text-align: right;">${totalOrderCount}</td>
                <td style="text-align: right;">$${grandTotal.toFixed(2)}</td>
            </tr></tfoot></table></div>`;
            
            return html;
        }
        
        async function generateInventoryTurnoverModal() {
            return await generateInventoryReportModal('turnover');
        }
        
        async function generateGrossMarginModal() {
            return await generateInventoryReportModal('margin');
        }
        
        async function generateSimpleInventoryModal() {
            return await generateInventoryReportModal('simple');
        }
        
        // Inventory Adjustments Report
        async function generateInventoryAdjustmentsModal() {
            try {
                console.log('ğŸ“ Loading inventory adjustments report...');
                console.log('ğŸ“± User agent:', navigator.userAgent);
                console.log('ğŸ” Report filters:', reportFilters);
                
                const [adjustmentsResult, itemsResult] = await Promise.all([
                    apiCall('getInventoryAdjustments'),
                    apiCall('getItems')
                ]);
                
                console.log('âœ… Adjustments API result:', adjustmentsResult);
                console.log('âœ… Items API result:', itemsResult);
                
                if (!adjustmentsResult) {
                    console.error('âŒ adjustmentsResult is null/undefined');
                    return `<h3 style="margin-top: 0;">ğŸ“ Inventory Adjustment History</h3>
                        <div style="background: #ffebee; border: 2px solid #f44336; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <p style="color: #c62828; margin: 0;"><strong>âš ï¸ Error:</strong> Failed to load adjustments data.</p>
                            <p style="color: #666; font-size: 13px; margin: 10px 0 0 0;">This might be a network issue or the Inventory_Adjustments sheet doesn't exist. Check your Google Sheets.</p>
                        </div>`;
                }
                
                if (!adjustmentsResult?.data) {
                    console.log('âš ï¸ adjustmentsResult.data is undefined');
                    return `<h3 style="margin-top: 0;">ğŸ“ Inventory Adjustment History</h3>
                        <div style="background: #fff3e0; border: 2px solid #ff9800; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <p style="color: #e65100; margin: 0;"><strong>â„¹ï¸ No Data:</strong> The adjustments table exists but is empty.</p>
                            <p style="color: #666; font-size: 13px; margin: 10px 0 0 0;">Adjustments are logged automatically when:<br>
                            â€¢ You create sales orders<br>
                            â€¢ You receive purchase orders<br>
                            â€¢ You manually adjust inventory</p>
                        </div>`;
                }
                
                const items = itemsResult?.data || [];
                let adjustments = adjustmentsResult.data;
                
                console.log('ğŸ“Š Total adjustments retrieved:', adjustments.length);
                if (adjustments.length > 0) {
                    console.log('ğŸ“‹ Sample adjustment:', adjustments[0]);
                }
                
                // Helper to get item description
                function getItemDesc(itemId) {
                    const item = items.find(i => String(i.Item_ID) === String(itemId));
                    return item ? item.Item_Description : itemId;
                }
                
                function getItemSKU(itemId) {
                    const item = items.find(i => String(i.Item_ID) === String(itemId));
                    return item ? item.SKU : '-';
                }
                
                // More robust date parsing for mobile
                function parseDateSafe(dateVal) {
                    if (!dateVal) return null;
                    if (dateVal instanceof Date) return dateVal;
                    
                    try {
                        // Try standard parsing
                        const d = new Date(dateVal);
                        if (!isNaN(d.getTime())) return d;
                        
                        // Try parsing common formats manually (mobile Safari can be picky)
                        if (typeof dateVal === 'string') {
                            // Handle YYYY-MM-DD format
                            const parts = dateVal.split(/[-/]/);
                            if (parts.length === 3) {
                                const year = parseInt(parts[0]);
                                const month = parseInt(parts[1]) - 1; // JS months are 0-indexed
                                const day = parseInt(parts[2]);
                                const d2 = new Date(year, month, day);
                                if (!isNaN(d2.getTime())) return d2;
                            }
                        }
                        
                        console.warn('Could not parse date:', dateVal);
                        return null;
                    } catch (e) {
                        console.error('Error parsing date:', dateVal, e);
                        return null;
                    }
                }
                
                // Apply date filters with better error handling
                try {
                    if (reportFilters.fromDate && reportFilters.fromDate.trim() !== '') {
                        console.log('Applying fromDate filter:', reportFilters.fromDate);
                        const fromDate = new Date(reportFilters.fromDate);
                        if (!isNaN(fromDate.getTime())) {
                            fromDate.setHours(0, 0, 0, 0);
                            adjustments = adjustments.filter(a => {
                                const adjDate = parseDateSafe(a.Adjustment_Date || a.Date);
                                return adjDate && adjDate >= fromDate;
                            });
                            console.log('After fromDate filter:', adjustments.length);
                        } else {
                            console.warn('Invalid fromDate:', reportFilters.fromDate);
                        }
                    } else {
                        console.log('No fromDate filter - showing all dates');
                    }
                    
                    if (reportFilters.toDate && reportFilters.toDate.trim() !== '') {
                        console.log('Applying toDate filter:', reportFilters.toDate);
                        const toDate = new Date(reportFilters.toDate);
                        if (!isNaN(toDate.getTime())) {
                            toDate.setHours(23, 59, 59, 999);
                            adjustments = adjustments.filter(a => {
                                const adjDate = parseDateSafe(a.Adjustment_Date || a.Date);
                                return adjDate && adjDate <= toDate;
                            });
                            console.log('After toDate filter:', adjustments.length);
                        } else {
                            console.warn('Invalid toDate:', reportFilters.toDate);
                        }
                    } else {
                        console.log('No toDate filter - showing all dates');
                    }
                } catch (e) {
                    console.error('Error applying date filters:', e);
                }
                
                // Apply item filter
                if (reportFilters.item) {
                    console.log('Applying item filter:', reportFilters.item);
                    adjustments = adjustments.filter(a => String(a.Item_ID) === String(reportFilters.item));
                    console.log('After item filter:', adjustments.length);
                }
                
                // Apply adjustment type filter
                if (reportFilters.adjustmentType) {
                    console.log('Applying adjustment type filter:', reportFilters.adjustmentType);
                    adjustments = adjustments.filter(a => {
                        const reason = String(a.Reason || '').toUpperCase();
                        const filterType = String(reportFilters.adjustmentType).toUpperCase();
                        return reason.includes(filterType);
                    });
                    console.log('After adjustment type filter:', adjustments.length);
                }
                
                console.log('Total adjustments after all filtering:', adjustments.length);
                
                // Sort by date (newest first)
                adjustments.sort((a, b) => {
                    const dateA = parseDateSafe(a.Adjustment_Date || a.Date) || new Date(0);
                    const dateB = parseDateSafe(b.Adjustment_Date || b.Date) || new Date(0);
                    return dateB - dateA;
                });
                
                // Build filter summary
                const filterSummary = generateFilterSummary();
                
                // Calculate summary stats
                let totalPositive = 0, totalNegative = 0;
                adjustments.forEach(a => {
                    const qty = parseFloat(a.Qty_Change || a.Adjustment) || 0;
                    if (qty > 0) totalPositive += qty;
                    else totalNegative += Math.abs(qty);
                });
                
                let html = `<h3 style="margin-top: 0;">ğŸ“ Inventory Adjustment History</h3>`;
                html += filterSummary;
                
                // Summary cards
                html += `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #1565c0;">${adjustments.length}</div>
                            <div style="font-size: 12px; color: #666;">Total Adjustments</div>
                        </div>
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">+${totalPositive.toLocaleString()}</div>
                            <div style="font-size: 12px; color: #666;">Units Added</div>
                        </div>
                        <div style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #c62828;">-${totalNegative.toLocaleString()}</div>
                            <div style="font-size: 12px; color: #666;">Units Removed</div>
                        </div>
                        <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">${(totalPositive - totalNegative).toLocaleString()}</div>
                            <div style="font-size: 12px; color: #666;">Net Change</div>
                        </div>
                    </div>
                `;
                
                if (adjustments.length === 0) {
                    html += `<p style="color: #888; text-align: center; padding: 40px;">No adjustments found for the selected filters.</p>`;
                    return html;
                }
                
                html += `<div style="overflow-x: auto; -webkit-overflow-scrolling: touch;"><table class="data-table" style="min-width: 100%; width: auto;">
                    <thead><tr>
                        <th style="white-space: nowrap;">Date</th>
                        <th style="white-space: nowrap;">Item</th>
                        <th style="white-space: nowrap;">SKU</th>
                        <th style="white-space: nowrap;">Reason</th>
                        <th style="text-align: right; white-space: nowrap;">Before</th>
                        <th style="text-align: right; white-space: nowrap;">Change</th>
                        <th style="text-align: right; white-space: nowrap;">After</th>
                        <th style="white-space: nowrap;">Notes</th>
                    </tr></thead><tbody>`;
                
                adjustments.forEach(a => {
                    const adjDate = parseDateSafe(a.Adjustment_Date || a.Date);
                    const dateStr = adjDate ? adjDate.toLocaleDateString() : '-';
                    const qtyChange = parseFloat(a.Qty_Change || a.Adjustment) || 0;
                    const qtyBefore = parseFloat(a.Qty_Before || a.Previous_Qty) || 0;
                    const qtyAfter = parseFloat(a.Qty_After || a.New_Qty) || 0;
                    const reason = String(a.Reason || '-');
                    const notes = a.Notes || '';
                    
                    // Color code the reason
                    let reasonBadge = reason;
                    if (reason.includes('VOID')) {
                        reasonBadge = `<span style="background: #ffcdd2; color: #c62828; padding: 2px 8px; border-radius: 10px; font-size: 11px; white-space: nowrap;">ğŸ”„ ${reason}</span>`;
                    } else if (reason.includes('Sale') || reason.includes('SALE')) {
                        reasonBadge = `<span style="background: #fff3e0; color: #e65100; padding: 2px 8px; border-radius: 10px; font-size: 11px; white-space: nowrap;">ğŸ“¤ ${reason}</span>`;
                    } else if (reason.includes('Purchase') || reason.includes('PURCHASE') || reason.includes('Received')) {
                        reasonBadge = `<span style="background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 10px; font-size: 11px; white-space: nowrap;">ğŸ“¥ ${reason}</span>`;
                    } else if (reason.includes('Manual')) {
                        reasonBadge = `<span style="background: #e3f2fd; color: #1565c0; padding: 2px 8px; border-radius: 10px; font-size: 11px; white-space: nowrap;">âœï¸ ${reason}</span>`;
                    } else if (reason.includes('OUTGOING')) {
                        reasonBadge = `<span style="background: #f3e5f5; color: #7b1fa2; padding: 2px 8px; border-radius: 10px; font-size: 11px; white-space: nowrap;">ğŸšš ${reason}</span>`;
                    }
                    
                    html += `<tr>
                        <td style="white-space: nowrap;">${dateStr}</td>
                        <td style="min-width: 150px;">${getItemDesc(a.Item_ID)}</td>
                        <td style="font-family: monospace; font-size: 11px; white-space: nowrap;">${getItemSKU(a.Item_ID)}</td>
                        <td>${reasonBadge}</td>
                        <td style="text-align: right; white-space: nowrap;">${qtyBefore}</td>
                        <td style="text-align: right; font-weight: bold; color: ${qtyChange >= 0 ? '#2e7d32' : '#c62828'}; white-space: nowrap;">
                            ${qtyChange >= 0 ? '+' : ''}${qtyChange}
                        </td>
                        <td style="text-align: right; white-space: nowrap;">${qtyAfter}</td>
                        <td style="max-width: 200px; min-width: 100px; font-size: 11px; color: #666;">${notes}</td>
                    </tr>`;
                });
                
                html += `</tbody></table></div>`;
                
                return html;
                
            } catch (error) {
                console.error('Error in generateInventoryAdjustmentsModal:', error);
                console.error('Error stack:', error.stack);
                return `<h3 style="margin-top: 0;">ğŸ“ Inventory Adjustment History</h3>
                    <div style="background: #ffebee; border: 2px solid #f44336; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <p style="color: #c62828; margin: 0;"><strong>Error loading adjustments:</strong></p>
                        <p style="color: #666; font-size: 13px; margin: 10px 0 0 0;">${error.message}</p>
                        <p style="color: #888; font-size: 11px; margin: 10px 0 0 0;">Check browser console (F12) for more details.</p>
                    </div>`;
            }
        }
        
        async function generateInventoryReportModal(type) {
            const itemsResult = await apiCall('getItems');
            if (!itemsResult?.data) throw new Error('Failed to load items');
            
            let items = itemsResult.data;
            
            // Apply filters
            if (reportFilters.supplier) {
                items = items.filter(i => i.Supplier_ID === reportFilters.supplier);
            }
            if (reportFilters.stockStatus) {
                items = items.filter(i => {
                    const qty = parseInt(i.Qty_On_Hand) || 0;
                    const reorder = parseInt(i.Reorder_Level) || 0;
                    switch(reportFilters.stockStatus) {
                        case 'negative': return qty < 0;
                        case 'out': return qty === 0;
                        case 'low': return qty > 0 && qty <= reorder;
                        case 'ok': return qty > reorder;
                        default: return true;
                    }
                });
            }
            
            let html = `<h3 style="margin-top: 0;">${type === 'turnover' ? 'Inventory Turnover' : type === 'margin' ? 'Gross Margin' : 'Inventory List'}</h3>`;
            html += `<p style="color: #666; margin-bottom: 20px;">${items.length} items</p>`;
            
            html += `<div style="overflow-x: auto;"><table class="data-table">
                <thead><tr>
                    <th>SKU</th>
                    <th>Description</th>
                    <th style="text-align: right;">Qty</th>
                    <th style="text-align: right;">Cost</th>
                    <th style="text-align: right;">Sell</th>
                    <th style="text-align: right;">Value</th>
                    ${type === 'margin' ? '<th style="text-align: right;">Margin</th>' : ''}
                </tr></thead><tbody>`;
            
            let totalQty = 0;
            let totalValue = 0;
            let totalSellValue = 0;
            
            items.forEach(item => {
                const qty = parseInt(item.Qty_On_Hand) || 0;
                const cost = parseFloat(item.Package_Cost) || 0;
                const sell = parseFloat(item.Unit_Sell_Price) || parseFloat(item.Sell_Price) || 0;
                const units = parseInt(item.Units_Per_Package) || 1;
                const unitCost = cost / units;
                const margin = sell > 0 ? ((sell - unitCost) / sell * 100) : 0;
                const itemValue = qty * unitCost;
                const itemSellValue = qty * sell;
                
                totalQty += qty;
                totalValue += itemValue;
                totalSellValue += itemSellValue;
                
                html += `<tr>
                    <td>${item.SKU || '-'}</td>
                    <td>${item.Item_Description || '-'}</td>
                    <td style="text-align: right; color: ${qty <= 0 ? '#c62828' : '#333'};">${qty}</td>
                    <td style="text-align: right;">$${unitCost.toFixed(2)}</td>
                    <td style="text-align: right;">$${sell.toFixed(2)}</td>
                    <td style="text-align: right;">$${itemValue.toFixed(2)}</td>
                    ${type === 'margin' ? `<td style="text-align: right; color: ${margin >= 20 ? '#2e7d32' : '#ff9800'};">${margin.toFixed(1)}%</td>` : ''}
                </tr>`;
            });
            
            const totalMargin = totalSellValue > 0 ? ((totalSellValue - totalValue) / totalSellValue * 100) : 0;
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="2">TOTAL (${items.length} items)</td>
                <td style="text-align: right;">${totalQty}</td>
                <td colspan="2" style="text-align: right;">Inventory Value:</td>
                <td style="text-align: right;">$${totalValue.toFixed(2)}</td>
                ${type === 'margin' ? `<td style="text-align: right;">${totalMargin.toFixed(1)}%</td>` : ''}
            </tr></tfoot></table></div>`;
            return html;
        }
        
        async function generateAccountsReceivableModal() {
            const salesResult = await apiCall('getSalesOrders');
            if (!salesResult?.data) throw new Error('Failed to load sales');
            
            let unpaid = salesResult.data.filter(s => s.Payment_Status !== 'Paid');
            
            if (reportFilters.customer) {
                unpaid = unpaid.filter(s => s.Customer_ID === reportFilters.customer);
            }
            
            let html = `<h3 style="margin-top: 0;">Accounts Receivable</h3>`;
            html += `<p style="color: #666; margin-bottom: 20px;">${unpaid.length} unpaid invoices</p>`;
            
            html += `<div style="overflow-x: auto;"><table class="data-table">
                <thead><tr>
                    <th>Invoice</th>
                    <th>Customer</th>
                    <th>Date</th>
                    <th style="text-align: right;">Total</th>
                    <th style="text-align: right;">Paid</th>
                    <th style="text-align: right;">Balance Due</th>
                    <th>Status</th>
                </tr></thead><tbody>`;
            
            let totalAmount = 0;
            let totalPaid = 0;
            let totalDue = 0;
            unpaid.forEach(s => {
                const amt = parseFloat(s.Total_Amount) || 0;
                const paid = parseFloat(s.Amount_Paid) || 0;
                const due = amt - paid;
                totalAmount += amt;
                totalPaid += paid;
                totalDue += due;
                html += `<tr>
                    <td>${s.Invoice_Number || s.SO_Number || '-'}</td>
                    <td>${getCustomerName(s.Customer_ID)}</td>
                    <td>${s.Sale_Date || '-'}</td>
                    <td style="text-align: right;">$${amt.toFixed(2)}</td>
                    <td style="text-align: right;">$${paid.toFixed(2)}</td>
                    <td style="text-align: right; color: #c62828; font-weight: bold;">$${due.toFixed(2)}</td>
                    <td>${s.Payment_Status || 'Unpaid'}</td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="3">TOTAL (${unpaid.length} invoices)</td>
                <td style="text-align: right;">$${totalAmount.toFixed(2)}</td>
                <td style="text-align: right;">$${totalPaid.toFixed(2)}</td>
                <td style="text-align: right; color: #2e7d32;">$${totalDue.toFixed(2)}</td>
                <td></td>
            </tr></tfoot></table></div>`;
            
            return html;
        }
        
        async function generateAccountsPayableModal() {
            const poResult = await apiCall('getPurchaseOrders');
            if (!poResult?.data) throw new Error('Failed to load POs');
            
            let unpaid = poResult.data.filter(p => p.Payment_Status !== 'Paid' && p.Status !== 'Void');
            
            if (reportFilters.supplier) {
                unpaid = unpaid.filter(p => p.Supplier_ID === reportFilters.supplier);
            }
            
            let html = `<h3 style="margin-top: 0;">Accounts Payable</h3>`;
            html += `<p style="color: #666; margin-bottom: 20px;">${unpaid.length} unpaid POs</p>`;
            
            html += `<div style="overflow-x: auto;"><table class="data-table">
                <thead><tr>
                    <th>PO #</th>
                    <th>Supplier</th>
                    <th>Date</th>
                    <th style="text-align: right;">Total</th>
                    <th style="text-align: right;">Paid</th>
                    <th style="text-align: right;">Balance Due</th>
                    <th>Status</th>
                </tr></thead><tbody>`;
            
            let totalAmount = 0;
            let totalPaid = 0;
            let totalDue = 0;
            unpaid.forEach(p => {
                const amt = parseFloat(p.Total_Amount) || 0;
                const paid = parseFloat(p.Amount_Paid) || 0;
                const due = amt - paid;
                totalAmount += amt;
                totalPaid += paid;
                totalDue += due;
                html += `<tr>
                    <td>${p.PO_ID || '-'}</td>
                    <td>${getSupplierName(p.Supplier_ID)}</td>
                    <td>${p.PO_Date || '-'}</td>
                    <td style="text-align: right;">$${amt.toFixed(2)}</td>
                    <td style="text-align: right;">$${paid.toFixed(2)}</td>
                    <td style="text-align: right; color: #c62828; font-weight: bold;">$${due.toFixed(2)}</td>
                    <td>${p.Payment_Status || 'Unpaid'}</td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="3">TOTAL (${unpaid.length} POs)</td>
                <td style="text-align: right;">$${totalAmount.toFixed(2)}</td>
                <td style="text-align: right;">$${totalPaid.toFixed(2)}</td>
                <td style="text-align: right; color: #c62828;">$${totalDue.toFixed(2)}</td>
                <td></td>
            </tr></tfoot></table></div>`;
            
            return html;
        }
        
        // ==================== TAX & ANNUAL REPORT GENERATORS ====================
        
        // Helper function to get date range for year/quarter
        function getDateRangeForPeriod(year, quarter) {
            year = parseInt(year);
            let startDate, endDate;
            
            if (quarter === 'annual' || !quarter) {
                startDate = new Date(year, 0, 1);  // Jan 1
                endDate = new Date(year, 11, 31, 23, 59, 59);  // Dec 31
            } else if (quarter === 'Q1') {
                startDate = new Date(year, 0, 1);  // Jan 1
                endDate = new Date(year, 2, 31, 23, 59, 59);  // Mar 31
            } else if (quarter === 'Q2') {
                startDate = new Date(year, 3, 1);  // Apr 1
                endDate = new Date(year, 5, 30, 23, 59, 59);  // Jun 30
            } else if (quarter === 'Q3') {
                startDate = new Date(year, 6, 1);  // Jul 1
                endDate = new Date(year, 8, 30, 23, 59, 59);  // Sep 30
            } else if (quarter === 'Q4') {
                startDate = new Date(year, 9, 1);  // Oct 1
                endDate = new Date(year, 11, 31, 23, 59, 59);  // Dec 31
            }
            
            return { startDate, endDate };
        }
        
        // Helper to parse dates flexibly
        function parseDate(dateVal) {
            if (!dateVal) return null;
            if (dateVal instanceof Date) return dateVal;
            const d = new Date(dateVal);
            return isNaN(d.getTime()) ? null : d;
        }
        
        // Enhanced date parsing for mobile Safari compatibility - used by all reports
        function parseDateSafe(dateVal) {
            if (!dateVal) return null;
            if (dateVal instanceof Date) return dateVal;
            
            try {
                // Try standard parsing first
                const d = new Date(dateVal);
                if (!isNaN(d.getTime())) return d;
                
                // Mobile Safari fallback: Try parsing common formats manually
                if (typeof dateVal === 'string') {
                    // Handle YYYY-MM-DD, MM/DD/YYYY, etc.
                    const parts = dateVal.split(/[-/]/);
                    if (parts.length === 3) {
                        const year = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // JS months are 0-indexed
                        const day = parseInt(parts[2]);
                        const d2 = new Date(year, month, day);
                        if (!isNaN(d2.getTime())) return d2;
                    }
                }
                
                return null;
            } catch (e) {
                console.error('Error parsing date:', dateVal, e);
                return null;
            }
        }
        
        // Apply date range filter with mobile-safe parsing
        function applyDateRangeFilter(items, dateField) {
            let filtered = items;
            
            try {
                // From date
                if (reportFilters.fromDate && reportFilters.fromDate.trim() !== '') {
                    const fromDate = new Date(reportFilters.fromDate);
                    if (!isNaN(fromDate.getTime())) {
                        fromDate.setHours(0, 0, 0, 0);
                        filtered = filtered.filter(item => {
                            const itemDate = parseDateSafe(item[dateField]);
                            return itemDate && itemDate >= fromDate;
                        });
                    }
                }
                
                // To date
                if (reportFilters.toDate && reportFilters.toDate.trim() !== '') {
                    const toDate = new Date(reportFilters.toDate);
                    if (!isNaN(toDate.getTime())) {
                        toDate.setHours(23, 59, 59, 999);
                        filtered = filtered.filter(item => {
                            const itemDate = parseDateSafe(item[dateField]);
                            return itemDate && itemDate <= toDate;
                        });
                    }
                }
            } catch (e) {
                console.error('Error applying date filter:', e);
            }
            
            return filtered;
        }
        
        // Helper to filter transactions by status
        function filterByTransactionStatus(items, statusField = 'Status') {
            const statusFilter = reportFilters.transactionStatus || 'exclude-voided';
            
            if (statusFilter === 'exclude-voided') {
                return items.filter(item => item[statusField] !== 'Voided');
            } else if (statusFilter === '') {
                return items; // All transactions
            } else {
                return items.filter(item => item[statusField] === statusFilter);
            }
        }
        
        // Helper to generate filter summary HTML
        function generateFilterSummary(options = {}) {
            const parts = [];
            
            // Date range
            if (reportFilters.fromDate && reportFilters.toDate) {
                parts.push(`ğŸ“… ${new Date(reportFilters.fromDate).toLocaleDateString()} - ${new Date(reportFilters.toDate).toLocaleDateString()}`);
            } else if (reportFilters.fromDate) {
                parts.push(`ğŸ“… From ${new Date(reportFilters.fromDate).toLocaleDateString()}`);
            } else if (reportFilters.toDate) {
                parts.push(`ğŸ“… Through ${new Date(reportFilters.toDate).toLocaleDateString()}`);
            }
            
            // Year/Quarter for tax reports
            if (options.showYear && reportFilters.year) {
                const periodLabel = reportFilters.quarter === 'annual' ? `Year ${reportFilters.year}` : `${reportFilters.quarter} ${reportFilters.year}`;
                parts.push(`ğŸ“… ${periodLabel}`);
            }
            
            // Customer
            if (reportFilters.customer) {
                parts.push(`ğŸ‘¤ ${getCustomerName(reportFilters.customer)}`);
            }
            
            // Supplier
            if (reportFilters.supplier) {
                parts.push(`ğŸ­ ${getSupplierName(reportFilters.supplier)}`);
            }
            
            // Payment Status
            if (reportFilters.paymentStatus) {
                const statusLabels = { 'Paid': 'âœ… Paid', 'Partial': 'ğŸŸ¡ Partial', 'Unpaid': 'ğŸ”´ Unpaid' };
                parts.push(statusLabels[reportFilters.paymentStatus] || reportFilters.paymentStatus);
            }
            
            // Transaction Status
            if (reportFilters.transactionStatus) {
                const statusLabels = {
                    'exclude-voided': 'ğŸš« Excluding Voided',
                    'Completed': 'âœ… Completed Only',
                    'Pending': 'ğŸŸ¡ Pending Only',
                    'Voided': 'âŒ Voided Only'
                };
                if (reportFilters.transactionStatus !== 'exclude-voided' || options.showVoidedFilter) {
                    parts.push(statusLabels[reportFilters.transactionStatus] || reportFilters.transactionStatus);
                }
            }
            
            // Min Amount
            if (reportFilters.minAmount > 0) {
                parts.push(`ğŸ’µ Min $${reportFilters.minAmount.toFixed(2)}`);
            }
            
            // Stock Status
            if (reportFilters.stockStatus) {
                const labels = { 'negative': 'ğŸš¨ Negative', 'out': 'ğŸ”´ Out of Stock', 'low': 'ğŸŸ¡ Low Stock', 'ok': 'ğŸŸ¢ In Stock' };
                parts.push(labels[reportFilters.stockStatus] || reportFilters.stockStatus);
            }
            
            // COGS Method
            if (options.showCogsMethod && reportFilters.cogsMethod) {
                parts.push(`ğŸ“¦ COGS: ${reportFilters.cogsMethod === 'actual' ? 'Actual Costs' : 'Standard Costs'}`);
            }
            
            if (parts.length === 0) {
                return '';
            }
            
            return `
                <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    <span style="font-weight: 600; color: #666; font-size: 12px;">FILTERS:</span>
                    ${parts.map(p => `<span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;">${p}</span>`).join('')}
                </div>
            `;
        }
        
        // Profit & Loss Statement
        async function generateProfitLossModal() {
            const year = reportFilters.year || new Date().getFullYear();
            const quarter = reportFilters.quarter || 'annual';
            const cogsMethod = reportFilters.cogsMethod || 'actual';
            
            const { startDate, endDate } = getDateRangeForPeriod(year, quarter);
            
            // Fetch all data
            const [salesResult, poResult, itemsResult] = await Promise.all([
                apiCall('getSalesOrders'),
                apiCall('getPurchaseOrders'),
                apiCall('getItems')
            ]);
            
            if (!salesResult?.data || !poResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            
            // Filter sales by date AND exclude voided (tax reports always exclude voided)
            const salesInPeriod = salesResult.data.filter(s => {
                if (s.Status === 'Voided') return false; // Always exclude voided for tax reports
                const saleDate = parseDate(s.Sale_Date || s.SO_Date);
                return saleDate && saleDate >= startDate && saleDate <= endDate;
            });
            
            // Filter purchases by date AND exclude voided
            const purchasesInPeriod = poResult.data.filter(p => {
                if (p.Status === 'Voided') return false; // Always exclude voided for tax reports
                const poDate = parseDate(p.PO_Date);
                return poDate && poDate >= startDate && poDate <= endDate;
            });
            
            // Calculate Revenue (total sales)
            let totalRevenue = 0;
            salesInPeriod.forEach(s => {
                totalRevenue += parseFloat(s.Total_Amount) || 0;
            });
            
            // Calculate COGS based on method
            let totalCOGS = 0;
            
            if (cogsMethod === 'actual') {
                // COGS from actual purchase orders (INCOMING POs only)
                purchasesInPeriod.forEach(p => {
                    if (p.PO_Type !== 'OUTGOING') {
                        totalCOGS += parseFloat(p.Total_Amount) || 0;
                    }
                });
            } else {
                // COGS from standard costs based on units sold
                for (const so of salesInPeriod) {
                    const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                    if (linesResult?.data) {
                        linesResult.data.forEach(line => {
                            const item = items.find(i => i.Item_ID === line.Item_ID);
                            const unitsPerPackage = parseFloat(item?.Units_Per_Package) || 1;
                            const packageCost = parseFloat(item?.Package_Cost) || 0;
                            const unitCost = packageCost / unitsPerPackage;
                            const qty = parseInt(line.Quantity) || 0;
                            totalCOGS += qty * unitCost;
                        });
                    }
                }
            }
            
            // Calculate Gross Profit
            const grossProfit = totalRevenue - totalCOGS;
            const grossMargin = totalRevenue > 0 ? (grossProfit / totalRevenue * 100) : 0;
            
            // Period label
            const periodLabel = quarter === 'annual' ? `Year ${year}` : `${quarter} ${year}`;
            const cogsLabel = cogsMethod === 'actual' ? 'Actual Purchase Costs' : 'Standard Costs';
            
            let html = `
                <h3 style="margin-top: 0;">ğŸ“Š Profit & Loss Statement</h3>
                
                <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    <span style="font-weight: 600; color: #666; font-size: 12px;">REPORT PARAMETERS:</span>
                    <span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;">ğŸ“… ${periodLabel}</span>
                    <span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;">ğŸ“¦ COGS: ${cogsLabel}</span>
                    <span style="background: #fff3e0; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ffe0b2;">ğŸš« Voided Excluded</span>
                </div>
                
                <div style="max-width: 500px; margin: 0 auto;">
                    <table class="data-table" style="width: 100%;">
                        <tbody>
                            <tr style="background: #e8f5e9;">
                                <td style="padding: 15px; font-weight: bold; font-size: 16px;">ğŸ’° REVENUE</td>
                                <td style="padding: 15px; text-align: right; font-weight: bold; font-size: 16px; color: #2e7d32;">$${totalRevenue.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; padding-left: 30px; color: #666;">Sales Orders (${salesInPeriod.length})</td>
                                <td style="padding: 12px; text-align: right;">$${totalRevenue.toFixed(2)}</td>
                            </tr>
                            
                            <tr style="background: #ffebee;">
                                <td style="padding: 15px; font-weight: bold; font-size: 16px;">ğŸ“¦ COST OF GOODS SOLD</td>
                                <td style="padding: 15px; text-align: right; font-weight: bold; font-size: 16px; color: #c62828;">($${totalCOGS.toFixed(2)})</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; padding-left: 30px; color: #666;">
                                    ${cogsMethod === 'actual' ? `Purchase Orders (${purchasesInPeriod.filter(p => p.PO_Type !== 'OUTGOING').length})` : 'Standard unit costs Ã— units sold'}
                                </td>
                                <td style="padding: 12px; text-align: right;">$${totalCOGS.toFixed(2)}</td>
                            </tr>
                            
                            <tr style="background: linear-gradient(135deg, #667eea15, #764ba215); border-top: 3px solid #667eea;">
                                <td style="padding: 20px; font-weight: bold; font-size: 18px;">ğŸ“ˆ GROSS PROFIT</td>
                                <td style="padding: 20px; text-align: right; font-weight: bold; font-size: 18px; color: ${grossProfit >= 0 ? '#2e7d32' : '#c62828'};">
                                    $${grossProfit.toFixed(2)}
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; padding-left: 30px; color: #666;">Gross Margin</td>
                                <td style="padding: 12px; text-align: right; font-weight: bold; color: ${grossMargin >= 20 ? '#2e7d32' : '#ff9800'};">${grossMargin.toFixed(1)}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 30px; padding: 15px; background: #f5f5f5; border-radius: 8px; font-size: 12px; color: #666;">
                    <strong>Note:</strong> This is a simplified P&L showing gross profit only. Operating expenses, taxes, and net income are not tracked in this system.
                </div>
            `;
            
            return html;
        }
        
        // Annual Sales Summary
        async function generateAnnualSalesSummaryModal() {
            const year = parseInt(reportFilters.year) || new Date().getFullYear();
            const { startDate, endDate } = getDateRangeForPeriod(year, 'annual');
            
            const salesResult = await apiCall('getSalesOrders');
            if (!salesResult?.data) throw new Error('Failed to load sales data');
            
            // Filter by year AND exclude voided (tax reports always exclude voided)
            const salesInYear = salesResult.data.filter(s => {
                if (s.Status === 'Voided') return false;
                const saleDate = parseDate(s.Sale_Date || s.SO_Date);
                return saleDate && saleDate >= startDate && saleDate <= endDate;
            });
            
            // Group by month
            const byMonth = {};
            for (let m = 0; m < 12; m++) {
                byMonth[m] = { sales: 0, orders: 0, paid: 0 };
            }
            
            salesInYear.forEach(s => {
                const saleDate = parseDate(s.Sale_Date || s.SO_Date);
                if (saleDate) {
                    const month = saleDate.getMonth();
                    byMonth[month].sales += parseFloat(s.Total_Amount) || 0;
                    byMonth[month].orders++;
                    byMonth[month].paid += parseFloat(s.Amount_Paid) || 0;
                }
            });
            
            // Group by customer for summary
            const byCustomer = {};
            salesInYear.forEach(s => {
                const custId = s.Customer_ID;
                if (!byCustomer[custId]) {
                    byCustomer[custId] = { name: getCustomerName(custId), total: 0, orders: 0 };
                }
                byCustomer[custId].total += parseFloat(s.Total_Amount) || 0;
                byCustomer[custId].orders++;
            });
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            let totalSales = 0, totalOrders = 0, totalPaid = 0;
            
            let html = `
                <h3 style="margin-top: 0;">ğŸ“ˆ Annual Sales Summary - ${year}</h3>
                
                <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    <span style="font-weight: 600; color: #666; font-size: 12px;">REPORT PARAMETERS:</span>
                    <span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;">ğŸ“… Calendar Year ${year}</span>
                    <span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;">ğŸ“‹ ${salesInYear.length} Orders</span>
                    <span style="background: #fff3e0; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ffe0b2;">ğŸš« Voided Excluded</span>
                </div>
                
                <h4 style="margin: 20px 0 10px 0;">Monthly Breakdown</h4>
                <div style="overflow-x: auto;"><table class="data-table">
                    <thead><tr>
                        <th>Month</th>
                        <th style="text-align: right;">Orders</th>
                        <th style="text-align: right;">Sales</th>
                        <th style="text-align: right;">Collected</th>
                    </tr></thead><tbody>`;
            
            for (let m = 0; m < 12; m++) {
                const data = byMonth[m];
                totalSales += data.sales;
                totalOrders += data.orders;
                totalPaid += data.paid;
                
                html += `<tr${data.orders === 0 ? ' style="color: #999;"' : ''}>
                    <td>${monthNames[m]}</td>
                    <td style="text-align: right;">${data.orders}</td>
                    <td style="text-align: right;">$${data.sales.toFixed(2)}</td>
                    <td style="text-align: right;">$${data.paid.toFixed(2)}</td>
                </tr>`;
            }
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td>TOTAL</td>
                <td style="text-align: right;">${totalOrders}</td>
                <td style="text-align: right;">$${totalSales.toFixed(2)}</td>
                <td style="text-align: right;">$${totalPaid.toFixed(2)}</td>
            </tr></tfoot></table></div>`;
            
            // Customer summary
            html += `<h4 style="margin: 30px 0 10px 0;">Sales by Customer</h4>
                <div style="overflow-x: auto;"><table class="data-table">
                    <thead><tr>
                        <th>Customer</th>
                        <th style="text-align: right;">Orders</th>
                        <th style="text-align: right;">Total Sales</th>
                    </tr></thead><tbody>`;
            
            Object.entries(byCustomer)
                .sort((a, b) => b[1].total - a[1].total)
                .forEach(([id, data]) => {
                    html += `<tr>
                        <td>${data.name}</td>
                        <td style="text-align: right;">${data.orders}</td>
                        <td style="text-align: right;">$${data.total.toFixed(2)}</td>
                    </tr>`;
                });
            
            html += `</tbody></table></div>`;
            
            return html;
        }
        
        // Annual Purchase Summary
        async function generateAnnualPurchaseSummaryModal() {
            const year = parseInt(reportFilters.year) || new Date().getFullYear();
            const { startDate, endDate } = getDateRangeForPeriod(year, 'annual');
            
            const poResult = await apiCall('getPurchaseOrders');
            if (!poResult?.data) throw new Error('Failed to load PO data');
            
            // Filter by year AND exclude voided (tax reports always exclude voided)
            const posInYear = poResult.data.filter(p => {
                if (p.Status === 'Voided') return false;
                const poDate = parseDate(p.PO_Date);
                return poDate && poDate >= startDate && poDate <= endDate;
            });
            
            // Group by month
            const byMonth = {};
            for (let m = 0; m < 12; m++) {
                byMonth[m] = { total: 0, orders: 0, paid: 0 };
            }
            
            posInYear.forEach(p => {
                const poDate = parseDate(p.PO_Date);
                if (poDate) {
                    const month = poDate.getMonth();
                    byMonth[month].total += parseFloat(p.Total_Amount) || 0;
                    byMonth[month].orders++;
                    byMonth[month].paid += parseFloat(p.Amount_Paid) || 0;
                }
            });
            
            // Group by supplier
            const bySupplier = {};
            posInYear.forEach(p => {
                const suppId = p.Supplier_ID;
                if (!bySupplier[suppId]) {
                    bySupplier[suppId] = { name: getSupplierName(suppId), total: 0, orders: 0 };
                }
                bySupplier[suppId].total += parseFloat(p.Total_Amount) || 0;
                bySupplier[suppId].orders++;
            });
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            let totalPurchases = 0, totalOrders = 0, totalPaid = 0;
            
            let html = `
                <h3 style="margin-top: 0;">ğŸ“‰ Annual Purchase Summary - ${year}</h3>
                
                <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    <span style="font-weight: 600; color: #666; font-size: 12px;">REPORT PARAMETERS:</span>
                    <span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;">ğŸ“… Calendar Year ${year}</span>
                    <span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;">ğŸ“‹ ${posInYear.length} POs</span>
                    <span style="background: #fff3e0; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ffe0b2;">ğŸš« Voided Excluded</span>
                </div>
                
                <h4 style="margin: 20px 0 10px 0;">Monthly Breakdown</h4>
                <div style="overflow-x: auto;"><table class="data-table">
                    <thead><tr>
                        <th>Month</th>
                        <th style="text-align: right;">POs</th>
                        <th style="text-align: right;">Purchases</th>
                        <th style="text-align: right;">Paid</th>
                    </tr></thead><tbody>`;
            
            for (let m = 0; m < 12; m++) {
                const data = byMonth[m];
                totalPurchases += data.total;
                totalOrders += data.orders;
                totalPaid += data.paid;
                
                html += `<tr${data.orders === 0 ? ' style="color: #999;"' : ''}>
                    <td>${monthNames[m]}</td>
                    <td style="text-align: right;">${data.orders}</td>
                    <td style="text-align: right;">$${data.total.toFixed(2)}</td>
                    <td style="text-align: right;">$${data.paid.toFixed(2)}</td>
                </tr>`;
            }
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td>TOTAL</td>
                <td style="text-align: right;">${totalOrders}</td>
                <td style="text-align: right;">$${totalPurchases.toFixed(2)}</td>
                <td style="text-align: right;">$${totalPaid.toFixed(2)}</td>
            </tr></tfoot></table></div>`;
            
            // Supplier summary
            html += `<h4 style="margin: 30px 0 10px 0;">Purchases by Supplier</h4>
                <div style="overflow-x: auto;"><table class="data-table">
                    <thead><tr>
                        <th>Supplier</th>
                        <th style="text-align: right;">POs</th>
                        <th style="text-align: right;">Total Purchases</th>
                    </tr></thead><tbody>`;
            
            Object.entries(bySupplier)
                .sort((a, b) => b[1].total - a[1].total)
                .forEach(([id, data]) => {
                    html += `<tr>
                        <td>${data.name}</td>
                        <td style="text-align: right;">${data.orders}</td>
                        <td style="text-align: right;">$${data.total.toFixed(2)}</td>
                    </tr>`;
                });
            
            html += `</tbody></table></div>`;
            
            return html;
        }
        
        // Inventory Valuation
        async function generateInventoryValuationModal() {
            const itemsResult = await apiCall('getItems');
            if (!itemsResult?.data) throw new Error('Failed to load items');
            
            let items = itemsResult.data;
            
            // Filter by supplier if selected
            if (reportFilters.supplier) {
                items = items.filter(i => i.Supplier_ID === reportFilters.supplier);
            }
            
            const today = new Date().toLocaleDateString();
            
            let html = `
                <h3 style="margin-top: 0;">ğŸ’° Inventory Valuation Report</h3>
                <p style="color: #666; margin-bottom: 20px;">As of ${today}</p>
                
                <div style="overflow-x: auto;"><table class="data-table">
                    <thead><tr>
                        <th>SKU</th>
                        <th>Description</th>
                        <th>Supplier</th>
                        <th style="text-align: right;">Qty</th>
                        <th style="text-align: right;">Unit Cost</th>
                        <th style="text-align: right;">Ext. Value</th>
                    </tr></thead><tbody>`;
            
            let totalUnits = 0;
            let totalValue = 0;
            let itemCount = 0;
            
            items.forEach(item => {
                const qty = parseInt(item.Qty_On_Hand) || 0;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPkg = parseInt(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPkg;
                const extValue = qty * unitCost;
                
                totalUnits += qty;
                totalValue += extValue;
                itemCount++;
                
                html += `<tr>
                    <td>${item.SKU || '-'}</td>
                    <td>${item.Item_Description || '-'}</td>
                    <td>${getSupplierName(item.Supplier_ID)}</td>
                    <td style="text-align: right; color: ${qty < 0 ? '#c62828' : '#333'};">${qty}</td>
                    <td style="text-align: right;">$${unitCost.toFixed(2)}</td>
                    <td style="text-align: right;">$${extValue.toFixed(2)}</td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="3">TOTAL (${itemCount} items)</td>
                <td style="text-align: right;">${totalUnits}</td>
                <td></td>
                <td style="text-align: right; color: #2e7d32;">$${totalValue.toFixed(2)}</td>
            </tr></tfoot></table></div>
            
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #667eea15, #764ba215); border-radius: 8px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #667eea;">${itemCount}</div>
                        <div style="color: #666; font-size: 12px;">Total SKUs</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #667eea;">${totalUnits.toLocaleString()}</div>
                        <div style="color: #666; font-size: 12px;">Total Units</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">$${totalValue.toFixed(2)}</div>
                        <div style="color: #666; font-size: 12px;">Total Value at Cost</div>
                    </div>
                </div>
            </div>`;
            
            return html;
        }
        
        // Cash Flow Summary
        async function generateCashFlowSummaryModal() {
            const year = parseInt(reportFilters.year) || new Date().getFullYear();
            const quarter = reportFilters.quarter || 'annual';
            
            const { startDate, endDate } = getDateRangeForPeriod(year, quarter);
            
            const [salesResult, poResult] = await Promise.all([
                apiCall('getSalesOrders'),
                apiCall('getPurchaseOrders')
            ]);
            
            if (!salesResult?.data || !poResult?.data) {
                throw new Error('Failed to load data');
            }
            
            // Filter by period AND exclude voided (tax reports always exclude voided)
            const salesInPeriod = salesResult.data.filter(s => {
                if (s.Status === 'Voided') return false;
                const d = parseDate(s.Sale_Date || s.SO_Date);
                return d && d >= startDate && d <= endDate;
            });
            
            const posInPeriod = poResult.data.filter(p => {
                if (p.Status === 'Voided') return false;
                const d = parseDate(p.PO_Date);
                return d && d >= startDate && d <= endDate;
            });
            
            // Calculate totals
            let totalSalesInvoiced = 0, totalSalesCollected = 0;
            let totalPurchasesInvoiced = 0, totalPurchasesPaid = 0;
            
            salesInPeriod.forEach(s => {
                totalSalesInvoiced += parseFloat(s.Total_Amount) || 0;
                totalSalesCollected += parseFloat(s.Amount_Paid) || 0;
            });
            
            posInPeriod.forEach(p => {
                totalPurchasesInvoiced += parseFloat(p.Total_Amount) || 0;
                totalPurchasesPaid += parseFloat(p.Amount_Paid) || 0;
            });
            
            const outstandingReceivables = totalSalesInvoiced - totalSalesCollected;
            const outstandingPayables = totalPurchasesInvoiced - totalPurchasesPaid;
            const netCashFlow = totalSalesCollected - totalPurchasesPaid;
            
            const periodLabel = quarter === 'annual' ? `Year ${year}` : `${quarter} ${year}`;
            
            let html = `
                <h3 style="margin-top: 0;">ğŸ’µ Cash Flow Summary</h3>
                
                <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    <span style="font-weight: 600; color: #666; font-size: 12px;">REPORT PARAMETERS:</span>
                    <span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;">ğŸ“… ${periodLabel}</span>
                    <span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;">ğŸ“‹ ${salesInPeriod.length} Sales / ${posInPeriod.length} POs</span>
                    <span style="background: #fff3e0; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ffe0b2;">ğŸš« Voided Excluded</span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    
                    <!-- Cash In -->
                    <div style="background: #e8f5e9; padding: 20px; border-radius: 12px; border-left: 4px solid #2e7d32;">
                        <h4 style="margin: 0 0 15px 0; color: #2e7d32;">ğŸ“¥ Cash In (Collections)</h4>
                        <table style="width: 100%;">
                            <tr>
                                <td style="padding: 8px 0; color: #666;">Sales Invoiced</td>
                                <td style="text-align: right;">$${totalSalesInvoiced.toFixed(2)}</td>
                            </tr>
                            <tr style="font-weight: bold; font-size: 18px;">
                                <td style="padding: 8px 0; color: #2e7d32;">Collected</td>
                                <td style="text-align: right; color: #2e7d32;">$${totalSalesCollected.toFixed(2)}</td>
                            </tr>
                            <tr style="border-top: 1px solid #c8e6c9;">
                                <td style="padding: 8px 0; color: #666;">Outstanding A/R</td>
                                <td style="text-align: right; color: #ff9800;">$${outstandingReceivables.toFixed(2)}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Cash Out -->
                    <div style="background: #ffebee; padding: 20px; border-radius: 12px; border-left: 4px solid #c62828;">
                        <h4 style="margin: 0 0 15px 0; color: #c62828;">ğŸ“¤ Cash Out (Payments)</h4>
                        <table style="width: 100%;">
                            <tr>
                                <td style="padding: 8px 0; color: #666;">Purchases Invoiced</td>
                                <td style="text-align: right;">$${totalPurchasesInvoiced.toFixed(2)}</td>
                            </tr>
                            <tr style="font-weight: bold; font-size: 18px;">
                                <td style="padding: 8px 0; color: #c62828;">Paid Out</td>
                                <td style="text-align: right; color: #c62828;">$${totalPurchasesPaid.toFixed(2)}</td>
                            </tr>
                            <tr style="border-top: 1px solid #ffcdd2;">
                                <td style="padding: 8px 0; color: #666;">Outstanding A/P</td>
                                <td style="text-align: right; color: #ff9800;">$${outstandingPayables.toFixed(2)}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Net Cash Flow -->
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 25px; border-radius: 12px; color: white; text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">NET CASH FLOW</div>
                    <div style="font-size: 36px; font-weight: bold;">
                        ${netCashFlow >= 0 ? '+' : ''}$${netCashFlow.toFixed(2)}
                    </div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Collections minus Payments</div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0;">Summary</h4>
                    <table class="data-table">
                        <tr>
                            <td>Total Sales Orders</td>
                            <td style="text-align: right;">${salesInPeriod.length}</td>
                        </tr>
                        <tr>
                            <td>Total Purchase Orders</td>
                            <td style="text-align: right;">${posInPeriod.length}</td>
                        </tr>
                        <tr>
                            <td>Collection Rate</td>
                            <td style="text-align: right;">${totalSalesInvoiced > 0 ? (totalSalesCollected / totalSalesInvoiced * 100).toFixed(1) : 0}%</td>
                        </tr>
                        <tr>
                            <td>Payment Rate</td>
                            <td style="text-align: right;">${totalPurchasesInvoiced > 0 ? (totalPurchasesPaid / totalPurchasesInvoiced * 100).toFixed(1) : 0}%</td>
                        </tr>
                    </table>
                </div>
            `;
            
            return html;
        }
        
        // ==================== DAILY DASHBOARD ====================
        
        async function generateDailyDashboardModal() {
            const fromDate = reportFilters.fromDate ? new Date(reportFilters.fromDate) : new Date();
            const toDate = reportFilters.toDate ? new Date(reportFilters.toDate + 'T23:59:59') : new Date();
            fromDate.setHours(0, 0, 0, 0);
            
            // Fetch all data
            const [salesResult, itemsResult, customersResult] = await Promise.all([
                apiCall('getSalesOrders'),
                apiCall('getItems'),
                apiCall('getCustomers')
            ]);
            
            if (!salesResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const customers = customersResult?.data || [];
            
            // Filter sales by date range
            let salesInPeriod = salesResult.data.filter(s => {
                const saleDate = parseDate(s.Sale_Date || s.SO_Date);
                return saleDate && saleDate >= fromDate && saleDate <= toDate;
            });
            
            // Filter by customer if selected
            if (reportFilters.customer) {
                salesInPeriod = salesInPeriod.filter(s => s.Customer_ID === reportFilters.customer);
            }
            
            // Calculate metrics
            let totalQtySold = 0;
            let totalSales = 0;
            let totalCost = 0;
            let orderCount = salesInPeriod.length;
            
            // Get line items for each sale
            const productSales = {};
            const customerSales = {};
            
            for (const so of salesInPeriod) {
                const soTotal = parseFloat(so.Total_Amount) || 0;
                totalSales += soTotal;
                
                // Track customer sales
                const custId = so.Customer_ID;
                if (!customerSales[custId]) {
                    customerSales[custId] = { 
                        name: getCustomerName(custId), 
                        sales: 0, 
                        orders: 0 
                    };
                }
                customerSales[custId].sales += soTotal;
                customerSales[custId].orders++;
                
                // Get line items
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const qty = parseInt(line.Quantity) || 0;
                        totalQtySold += qty;
                        
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const unitsPerPkg = parseFloat(item?.Units_Per_Package) || 1;
                        const pkgCost = parseFloat(item?.Package_Cost) || 0;
                        const unitCost = pkgCost / unitsPerPkg;
                        totalCost += qty * unitCost;
                        
                        // Track product sales
                        const itemId = line.Item_ID;
                        if (!productSales[itemId]) {
                            productSales[itemId] = {
                                name: item?.Item_Description || itemId,
                                sku: item?.SKU || '-',
                                qty: 0,
                                sales: 0
                            };
                        }
                        productSales[itemId].qty += qty;
                        productSales[itemId].sales += parseFloat(line.Line_Total) || 0;
                    });
                }
            }
            
            const profit = totalSales - totalCost;
            const grossMargin = totalSales > 0 ? (profit / totalSales * 100) : 0;
            const avgOrderValue = orderCount > 0 ? (totalSales / orderCount) : 0;
            const avgUnitPrice = totalQtySold > 0 ? (totalSales / totalQtySold) : 0;
            const avgUnitCost = totalQtySold > 0 ? (totalCost / totalQtySold) : 0;
            
            // Sort top performers
            const topCustomers = Object.values(customerSales).sort((a, b) => b.sales - a.sales).slice(0, 5);
            const topProducts = Object.values(productSales).sort((a, b) => b.sales - a.sales).slice(0, 5);
            
            // Date range label
            const fromStr = fromDate.toLocaleDateString();
            const toStr = toDate.toLocaleDateString();
            const dateLabel = fromStr === toStr ? fromStr : `${fromStr} - ${toStr}`;
            
            // Build dashboard HTML with card styling
            let html = `
                <style>
                    .dash-header {
                        text-align: center;
                        padding: 25px;
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        border-radius: 12px;
                        margin-bottom: 25px;
                        border-left: 6px solid white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    }
                    .dash-header h2 {
                        margin: 0;
                        font-size: 28px;
                    }
                    .dash-header p {
                        margin: 8px 0 0 0;
                        opacity: 0.9;
                    }
                    .dash-card-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    .dash-card {
                        background: white;
                        border-radius: 12px;
                        padding: 15px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        border-left: 4px solid #667eea;
                        transition: transform 0.2s, box-shadow 0.2s;
                    }
                    .dash-card:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 15px rgba(0,0,0,0.12);
                    }
                    .dash-card-label {
                        font-size: 11px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        margin-bottom: 8px;
                    }
                    .dash-card-value {
                        font-size: 28px;
                        font-weight: bold;
                        color: #333;
                        line-height: 1.1;
                    }
                    .dash-card-sub {
                        font-size: 12px;
                        color: #888;
                        margin-top: 5px;
                    }
                    .dash-section {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    }
                    .dash-section h4 {
                        margin: 0 0 15px 0;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    .top-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 10px 0;
                        border-bottom: 1px solid #f0f0f0;
                    }
                    .top-item:last-child { border-bottom: none; }
                    .top-item-rank {
                        width: 28px;
                        height: 28px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 12px;
                        margin-right: 12px;
                    }
                    .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: white; }
                    .rank-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); color: white; }
                    .rank-3 { background: linear-gradient(135deg, #CD7F32, #8B4513); color: white; }
                    .rank-other { background: #f0f0f0; color: #666; }
                </style>
                
                <div class="dash-header">
                    <h2>ğŸ¯ Sales Dashboard</h2>
                    <p>${dateLabel}${reportFilters.customer ? ' â€¢ ' + getCustomerName(reportFilters.customer) : ''}</p>
                </div>
                
                <!-- Main KPI Cards -->
                <div class="dash-card-grid">
                    <div class="dash-card" style="border-color: #2196F3;">
                        <div class="dash-card-label" style="color: #2196F3;">ğŸ“¦ QTY SOLD</div>
                        <div class="dash-card-value">${totalQtySold.toLocaleString()}</div>
                        <div class="dash-card-sub">units</div>
                    </div>
                    
                    <div class="dash-card" style="border-color: #9C27B0;">
                        <div class="dash-card-label" style="color: #9C27B0;">ğŸ“‹ ORDERS</div>
                        <div class="dash-card-value">${orderCount}</div>
                        <div class="dash-card-sub">sales orders</div>
                    </div>
                    
                    <div class="dash-card" style="border-color: #4CAF50;">
                        <div class="dash-card-label" style="color: #4CAF50;">ğŸ’° SALES</div>
                        <div class="dash-card-value">$${totalSales.toFixed(0)}</div>
                        <div class="dash-card-sub">total revenue</div>
                    </div>
                    
                    <div class="dash-card" style="border-color: #FF9800;">
                        <div class="dash-card-label" style="color: #FF9800;">ğŸ“¦ COST</div>
                        <div class="dash-card-value">$${totalCost.toFixed(0)}</div>
                        <div class="dash-card-sub">cost of goods</div>
                    </div>
                    
                    <div class="dash-card" style="border-color: #4CAF50;">
                        <div class="dash-card-label" style="color: #4CAF50;">ğŸ“ˆ PROFIT</div>
                        <div class="dash-card-value" style="color: ${profit >= 0 ? '#2e7d32' : '#c62828'};">$${profit.toFixed(0)}</div>
                        <div class="dash-card-sub">gross profit</div>
                    </div>
                    
                    <div class="dash-card" style="border-color: ${grossMargin >= 20 ? '#4CAF50' : grossMargin >= 10 ? '#FF9800' : '#f44336'};">
                        <div class="dash-card-label" style="color: ${grossMargin >= 20 ? '#4CAF50' : grossMargin >= 10 ? '#FF9800' : '#f44336'};">ğŸ“Š MARGIN</div>
                        <div class="dash-card-value">${grossMargin.toFixed(1)}%</div>
                        <div class="dash-card-sub">gross margin</div>
                    </div>
                </div>
                
                <!-- Secondary KPIs -->
                <div class="dash-card-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                    <div class="dash-card" style="border-color: #607D8B;">
                        <div class="dash-card-label" style="color: #607D8B;">ğŸ›’ AVG ORDER</div>
                        <div class="dash-card-value">$${avgOrderValue.toFixed(2)}</div>
                        <div class="dash-card-sub">average order value</div>
                    </div>
                    
                    <div class="dash-card" style="border-color: #795548;">
                        <div class="dash-card-label" style="color: #795548;">ğŸ’µ AVG PRICE</div>
                        <div class="dash-card-value">$${avgUnitPrice.toFixed(2)}</div>
                        <div class="dash-card-sub">per unit sold</div>
                    </div>
                    
                    <div class="dash-card" style="border-color: #9E9E9E;">
                        <div class="dash-card-label" style="color: #9E9E9E;">ğŸ“¦ AVG COST</div>
                        <div class="dash-card-value">$${avgUnitCost.toFixed(2)}</div>
                        <div class="dash-card-sub">per unit cost</div>
                    </div>
                </div>
                
                <!-- Top Performers Section -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    
                    <!-- Top Customers -->
                    <div class="dash-section">
                        <h4>ğŸ† Top Customers</h4>
                        ${topCustomers.length === 0 ? '<p style="color: #888; text-align: center;">No sales in this period</p>' : ''}
                        ${topCustomers.map((c, i) => `
                            <div class="top-item">
                                <div style="display: flex; align-items: center;">
                                    <div class="top-item-rank ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other'}">${i + 1}</div>
                                    <div>
                                        <div style="font-weight: 500;">${c.name}</div>
                                        <div style="font-size: 12px; color: #888;">${c.orders} order${c.orders !== 1 ? 's' : ''}</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: #2e7d32;">$${c.sales.toFixed(2)}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Top Products -->
                    <div class="dash-section">
                        <h4>ğŸ¥‡ Top Products</h4>
                        ${topProducts.length === 0 ? '<p style="color: #888; text-align: center;">No sales in this period</p>' : ''}
                        ${topProducts.map((p, i) => `
                            <div class="top-item">
                                <div style="display: flex; align-items: center;">
                                    <div class="top-item-rank ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other'}">${i + 1}</div>
                                    <div>
                                        <div style="font-weight: 500;">${p.name}</div>
                                        <div style="font-size: 12px; color: #888;">${p.qty} units â€¢ ${p.sku}</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: #2e7d32;">$${p.sales.toFixed(2)}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // ==================== CUSTOMER PRESENTATION DASHBOARD ====================
        
        async function generateCustomerDashboardModal() {
            const customerId = reportFilters.customer;
            const fromDate = reportFilters.fromDate ? new Date(reportFilters.fromDate) : null;
            const toDate = reportFilters.toDate ? new Date(reportFilters.toDate + 'T23:59:59') : null;
            
            // Fetch all data
            const [salesResult, itemsResult, customersResult] = await Promise.all([
                apiCall('getSalesOrders'),
                apiCall('getItems'),
                apiCall('getCustomers')
            ]);
            
            if (!salesResult?.data || !itemsResult?.data || !customersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const customer = customersResult.data.find(c => c.Customer_ID === customerId);
            const customerName = customer?.Customer_Name || 'Customer';
            
            // Get all sales for this customer
            let allCustomerSales = salesResult.data.filter(s => s.Customer_ID === customerId);
            
            // Apply date filter if provided
            let filteredSales = allCustomerSales;
            if (fromDate) {
                fromDate.setHours(0, 0, 0, 0);
                filteredSales = filteredSales.filter(s => {
                    const d = parseDate(s.Sale_Date || s.SO_Date);
                    return d && d >= fromDate;
                });
            }
            if (toDate) {
                filteredSales = filteredSales.filter(s => {
                    const d = parseDate(s.Sale_Date || s.SO_Date);
                    return d && d <= toDate;
                });
            }
            
            // Calculate time period stats (regardless of date filter)
            const now = new Date();
            const periods = {
                '1 MONTH': { start: new Date(now.getFullYear(), now.getMonth() - 1, now.getDate()), sales: 0, orders: 0 },
                '3 MONTH': { start: new Date(now.getFullYear(), now.getMonth() - 3, now.getDate()), sales: 0, orders: 0 },
                'YTD': { start: new Date(now.getFullYear(), 0, 1), sales: 0, orders: 0 },
                '1 YEAR': { start: new Date(now.getFullYear() - 1, now.getMonth(), now.getDate()), sales: 0, orders: 0 },
                '3 YEAR': { start: new Date(now.getFullYear() - 3, now.getMonth(), now.getDate()), sales: 0, orders: 0 },
                'ALL TIME': { start: new Date(2000, 0, 1), sales: 0, orders: 0 }
            };
            
            allCustomerSales.forEach(s => {
                const saleDate = parseDate(s.Sale_Date || s.SO_Date);
                const amount = parseFloat(s.Total_Amount) || 0;
                if (saleDate) {
                    Object.keys(periods).forEach(key => {
                        if (saleDate >= periods[key].start) {
                            periods[key].sales += amount;
                            periods[key].orders++;
                        }
                    });
                }
            });
            
            // Get product breakdown for filtered period
            const productSales = {};
            let totalQty = 0, totalSales = 0, totalOrders = filteredSales.length;
            
            for (const so of filteredSales) {
                totalSales += parseFloat(so.Total_Amount) || 0;
                
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const qty = parseInt(line.Quantity) || 0;
                        totalQty += qty;
                        
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const itemId = line.Item_ID;
                        if (!productSales[itemId]) {
                            productSales[itemId] = {
                                name: item?.Item_Description || itemId,
                                sku: item?.SKU || '-',
                                qty: 0,
                                sales: 0
                            };
                        }
                        productSales[itemId].qty += qty;
                        productSales[itemId].sales += parseFloat(line.Line_Total) || 0;
                    });
                }
            }
            
            const topProducts = Object.values(productSales).sort((a, b) => b.sales - a.sales).slice(0, 5);
            const avgOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;
            
            // Period colors matching the reference image
            const periodColors = ['#2196F3', '#9C27B0', '#FF9800', '#f44336', '#4CAF50', '#607D8B'];
            
            // Date range label
            let dateLabel = 'All Time';
            if (fromDate && toDate) {
                dateLabel = `${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`;
            } else if (fromDate) {
                dateLabel = `Since ${fromDate.toLocaleDateString()}`;
            } else if (toDate) {
                dateLabel = `Through ${toDate.toLocaleDateString()}`;
            }
            
            let html = `
                <style>
                    .pres-header {
                        text-align: center;
                        padding: 25px;
                        background: linear-gradient(135deg, #2e7d32, #4caf50);
                        color: white;
                        border-radius: 12px;
                        margin-bottom: 25px;
                        border-left: 6px solid white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    }
                    .pres-header h2 {
                        margin: 0;
                        font-size: 28px;
                    }
                    .pres-header p {
                        margin: 8px 0 0 0;
                        opacity: 0.9;
                    }
                    .period-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                        gap: 12px;
                        margin-bottom: 25px;
                    }
                    .period-card {
                        background: white;
                        border-radius: 10px;
                        padding: 15px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        border-left: 4px solid #2e7d32;
                        transition: transform 0.2s;
                    }
                    .period-card:hover {
                        transform: translateY(-3px);
                        box-shadow: 0 4px 15px rgba(0,0,0,0.12);
                    }
                    .period-label {
                        font-size: 11px;
                        font-weight: 600;
                        text-transform: uppercase;
                        margin-bottom: 8px;
                    }
                    .period-value {
                        font-size: 26px;
                        font-weight: bold;
                        color: #333;
                    }
                    .period-sub {
                        font-size: 11px;
                        color: #888;
                        margin-top: 4px;
                    }
                    .section-title {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        margin: 25px 0 15px 0;
                        padding-bottom: 10px;
                        border-bottom: 2px solid #e0e0e0;
                    }
                    .section-title h3 {
                        margin: 0;
                        color: #333;
                    }
                    .summary-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    .summary-card {
                        background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
                        border-radius: 10px;
                        padding: 20px;
                        text-align: center;
                    }
                    .summary-card .label {
                        font-size: 12px;
                        color: #666;
                        text-transform: uppercase;
                    }
                    .summary-card .value {
                        font-size: 32px;
                        font-weight: bold;
                        color: #2e7d32;
                        margin: 5px 0;
                    }
                    .product-row {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 15px;
                        background: white;
                        border-radius: 8px;
                        margin-bottom: 8px;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                    }
                    .product-rank {
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 14px;
                        margin-right: 15px;
                        color: white;
                    }
                    .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); }
                    .rank-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
                    .rank-3 { background: linear-gradient(135deg, #CD7F32, #8B4513); }
                    .rank-other { background: #9e9e9e; }
                </style>
                
                <div class="pres-header">
                    <h2>ğŸ‘¤ ${customerName}</h2>
                    <p>Sales Performance Report</p>
                </div>
                
                <div class="section-title">
                    <span style="font-size: 20px;">ğŸ†</span>
                    <h3>Sales by Time Period</h3>
                </div>
                <p style="color: #666; margin: -10px 0 15px 0; font-size: 13px;">Click any tile to see detailed breakdown</p>
                
                <div class="period-grid">
                    ${Object.entries(periods).map(([label, data], i) => `
                        <div class="period-card" style="border-color: ${periodColors[i]};">
                            <div class="period-label" style="color: ${periodColors[i]};">${label}</div>
                            <div class="period-value">$${data.sales.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div class="period-sub">${data.orders} order${data.orders !== 1 ? 's' : ''}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="section-title">
                    <span style="font-size: 20px;">ğŸ“Š</span>
                    <h3>Selected Period Summary</h3>
                    <span style="color: #666; font-size: 13px; margin-left: auto;">${dateLabel}</span>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="label">Total Sales</div>
                        <div class="value">$${totalSales.toFixed(2)}</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">Orders</div>
                        <div class="value" style="color: #1565c0;">${totalOrders}</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">Units Purchased</div>
                        <div class="value" style="color: #7b1fa2;">${totalQty.toLocaleString()}</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">Avg Order Value</div>
                        <div class="value" style="color: #e65100;">$${avgOrderValue.toFixed(2)}</div>
                    </div>
                </div>
                
                <div class="section-title">
                    <span style="font-size: 20px;">ğŸ¥‡</span>
                    <h3>Top Products Purchased</h3>
                </div>
                
                ${topProducts.length === 0 ? '<p style="color: #888; text-align: center; padding: 20px;">No purchases in selected period</p>' : ''}
                ${topProducts.map((p, i) => `
                    <div class="product-row">
                        <div style="display: flex; align-items: center;">
                            <div class="product-rank ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other'}">${i + 1}</div>
                            <div>
                                <div style="font-weight: 600;">${p.name}</div>
                                <div style="font-size: 12px; color: #888;">${p.qty} units â€¢ SKU: ${p.sku}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: bold; color: #2e7d32;">$${p.sales.toFixed(2)}</div>
                        </div>
                    </div>
                `).join('')}
            `;
            
            return html;
        }
        
        // ==================== SUPPLIER PRESENTATION DASHBOARD ====================
        
        async function generateSupplierDashboardModal() {
            const supplierId = reportFilters.supplier;
            const fromDate = reportFilters.fromDate ? new Date(reportFilters.fromDate) : null;
            const toDate = reportFilters.toDate ? new Date(reportFilters.toDate + 'T23:59:59') : null;
            
            // Fetch all data
            const [poResult, itemsResult, suppliersResult] = await Promise.all([
                apiCall('getPurchaseOrders'),
                apiCall('getItems'),
                apiCall('getSuppliers')
            ]);
            
            if (!poResult?.data || !itemsResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const supplier = suppliersResult.data.find(s => s.Supplier_ID === supplierId);
            const supplierName = supplier?.Supplier_Name || 'Supplier';
            
            // Get all POs for this supplier (exclude OUTGOING)
            let allSupplierPOs = poResult.data.filter(p => p.Supplier_ID === supplierId && p.PO_Type !== 'OUTGOING');
            
            // Apply date filter if provided
            let filteredPOs = allSupplierPOs;
            if (fromDate) {
                fromDate.setHours(0, 0, 0, 0);
                filteredPOs = filteredPOs.filter(p => {
                    const d = parseDate(p.PO_Date);
                    return d && d >= fromDate;
                });
            }
            if (toDate) {
                filteredPOs = filteredPOs.filter(p => {
                    const d = parseDate(p.PO_Date);
                    return d && d <= toDate;
                });
            }
            
            // Calculate time period stats
            const now = new Date();
            const periods = {
                '1 MONTH': { start: new Date(now.getFullYear(), now.getMonth() - 1, now.getDate()), purchases: 0, orders: 0 },
                '3 MONTH': { start: new Date(now.getFullYear(), now.getMonth() - 3, now.getDate()), purchases: 0, orders: 0 },
                'YTD': { start: new Date(now.getFullYear(), 0, 1), purchases: 0, orders: 0 },
                '1 YEAR': { start: new Date(now.getFullYear() - 1, now.getMonth(), now.getDate()), purchases: 0, orders: 0 },
                '3 YEAR': { start: new Date(now.getFullYear() - 3, now.getMonth(), now.getDate()), purchases: 0, orders: 0 },
                'ALL TIME': { start: new Date(2000, 0, 1), purchases: 0, orders: 0 }
            };
            
            allSupplierPOs.forEach(p => {
                const poDate = parseDate(p.PO_Date);
                const amount = parseFloat(p.Total_Amount) || 0;
                if (poDate) {
                    Object.keys(periods).forEach(key => {
                        if (poDate >= periods[key].start) {
                            periods[key].purchases += amount;
                            periods[key].orders++;
                        }
                    });
                }
            });
            
            // Get product breakdown for filtered period
            const productPurchases = {};
            let totalQty = 0, totalPurchases = 0, totalOrders = filteredPOs.length;
            let totalPaid = 0;
            
            for (const po of filteredPOs) {
                totalPurchases += parseFloat(po.Total_Amount) || 0;
                totalPaid += parseFloat(po.Amount_Paid) || 0;
                
                const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const qty = parseInt(line.Quantity) || 0;
                        totalQty += qty;
                        
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const itemId = line.Item_ID;
                        if (!productPurchases[itemId]) {
                            productPurchases[itemId] = {
                                name: item?.Item_Description || itemId,
                                sku: item?.SKU || '-',
                                qty: 0,
                                cost: 0
                            };
                        }
                        productPurchases[itemId].qty += qty;
                        productPurchases[itemId].cost += parseFloat(line.Line_Total) || 0;
                    });
                }
            }
            
            const topProducts = Object.values(productPurchases).sort((a, b) => b.cost - a.cost).slice(0, 5);
            const avgOrderValue = totalOrders > 0 ? totalPurchases / totalOrders : 0;
            
            // Period colors
            const periodColors = ['#1565c0', '#0097a7', '#00897b', '#43a047', '#7cb342', '#afb42b'];
            
            // Date range label
            let dateLabel = 'All Time';
            if (fromDate && toDate) {
                dateLabel = `${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`;
            } else if (fromDate) {
                dateLabel = `Since ${fromDate.toLocaleDateString()}`;
            } else if (toDate) {
                dateLabel = `Through ${toDate.toLocaleDateString()}`;
            }
            
            let html = `
                <style>
                    .pres-header-supplier {
                        text-align: center;
                        padding: 25px;
                        background: linear-gradient(135deg, #1565c0, #42a5f5);
                        color: white;
                        border-radius: 12px;
                        margin-bottom: 25px;
                        border-left: 6px solid white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    }
                    .pres-header-supplier h2 {
                        margin: 0;
                        font-size: 28px;
                    }
                    .pres-header-supplier p {
                        margin: 8px 0 0 0;
                        opacity: 0.9;
                    }
                    .period-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                        gap: 12px;
                        margin-bottom: 25px;
                    }
                    .period-card {
                        background: white;
                        border-radius: 10px;
                        padding: 15px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        border-left: 4px solid #1565c0;
                        transition: transform 0.2s;
                    }
                    .period-card:hover {
                        transform: translateY(-3px);
                        box-shadow: 0 4px 15px rgba(0,0,0,0.12);
                    }
                    .period-label {
                        font-size: 11px;
                        font-weight: 600;
                        text-transform: uppercase;
                        margin-bottom: 8px;
                    }
                    .period-value {
                        font-size: 26px;
                        font-weight: bold;
                        color: #333;
                    }
                    .period-sub {
                        font-size: 11px;
                        color: #888;
                        margin-top: 4px;
                    }
                    .section-title {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        margin: 25px 0 15px 0;
                        padding-bottom: 10px;
                        border-bottom: 2px solid #e0e0e0;
                    }
                    .section-title h3 {
                        margin: 0;
                        color: #333;
                    }
                    .summary-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    .summary-card-blue {
                        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
                        border-radius: 10px;
                        padding: 20px;
                        text-align: center;
                    }
                    .summary-card-blue .label {
                        font-size: 12px;
                        color: #1565c0;
                        text-transform: uppercase;
                        font-weight: 600;
                    }
                    .summary-card-blue .value {
                        font-size: 28px;
                        font-weight: bold;
                        color: #0d47a1;
                        margin: 5px 0;
                    }
                    .product-row {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 15px;
                        background: white;
                        border-radius: 8px;
                        margin-bottom: 8px;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                    }
                    .product-rank {
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 14px;
                        margin-right: 15px;
                        color: white;
                    }
                    .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); }
                    .rank-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
                    .rank-3 { background: linear-gradient(135deg, #CD7F32, #8B4513); }
                    .rank-other { background: #9e9e9e; }
                    .partnership-box {
                        background: linear-gradient(135deg, #1a237e, #283593);
                        color: white;
                        padding: 25px;
                        border-radius: 12px;
                        text-align: center;
                        margin-top: 25px;
                    }
                    .partnership-box h3 {
                        margin: 0 0 15px 0;
                        font-size: 18px;
                    }
                    .partnership-value {
                        font-size: 42px;
                        font-weight: bold;
                    }
                    .partnership-label {
                        font-size: 14px;
                        opacity: 0.9;
                        margin-top: 5px;
                    }
                </style>
                
                <div class="pres-header-supplier">
                    <h2>ğŸ­ ${supplierName}</h2>
                    <p>Partnership Performance Report</p>
                </div>
                
                <div class="section-title">
                    <span style="font-size: 20px;">ğŸ“ˆ</span>
                    <h3>Purchase Volume by Time Period</h3>
                </div>
                <p style="color: #666; margin: -10px 0 15px 0; font-size: 13px;">Our business relationship over time</p>
                
                <div class="period-grid">
                    ${Object.entries(periods).map(([label, data], i) => `
                        <div class="period-card" style="border-color: ${periodColors[i]};">
                            <div class="period-label" style="color: ${periodColors[i]};">${label}</div>
                            <div class="period-value">$${data.purchases.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div class="period-sub">${data.orders} PO${data.orders !== 1 ? 's' : ''}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="section-title">
                    <span style="font-size: 20px;">ğŸ“Š</span>
                    <h3>Selected Period Details</h3>
                    <span style="color: #666; font-size: 13px; margin-left: auto;">${dateLabel}</span>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-card-blue">
                        <div class="label">Total Purchases</div>
                        <div class="value">$${totalPurchases.toFixed(2)}</div>
                    </div>
                    <div class="summary-card-blue">
                        <div class="label">Purchase Orders</div>
                        <div class="value">${totalOrders}</div>
                    </div>
                    <div class="summary-card-blue">
                        <div class="label">Units Ordered</div>
                        <div class="value">${totalQty.toLocaleString()}</div>
                    </div>
                    <div class="summary-card-blue">
                        <div class="label">Avg PO Value</div>
                        <div class="value">$${avgOrderValue.toFixed(2)}</div>
                    </div>
                    <div class="summary-card-blue">
                        <div class="label">Amount Paid</div>
                        <div class="value" style="color: #2e7d32;">$${totalPaid.toFixed(2)}</div>
                    </div>
                </div>
                
                <div class="section-title">
                    <span style="font-size: 20px;">ğŸ“¦</span>
                    <h3>Top Products Ordered</h3>
                </div>
                
                ${topProducts.length === 0 ? '<p style="color: #888; text-align: center; padding: 20px;">No purchases in selected period</p>' : ''}
                ${topProducts.map((p, i) => `
                    <div class="product-row">
                        <div style="display: flex; align-items: center;">
                            <div class="product-rank ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other'}">${i + 1}</div>
                            <div>
                                <div style="font-weight: 600;">${p.name}</div>
                                <div style="font-size: 12px; color: #888;">${p.qty} units â€¢ SKU: ${p.sku}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: bold; color: #1565c0;">$${p.cost.toFixed(2)}</div>
                        </div>
                    </div>
                `).join('')}
                
                <div class="partnership-box">
                    <h3>ğŸ¤ Total Partnership Value</h3>
                    <div class="partnership-value">$${periods['ALL TIME'].purchases.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div class="partnership-label">${periods['ALL TIME'].orders} purchase orders â€¢ All Time</div>
                </div>
            `;
            
            return html;
        }
        
        // 1. SALES BY CUSTOMER REPORT
        async function generateSalesByCustomer() {
            const salesResult = await apiCall('getSalesOrders');
            const customersResult = await apiCall('getCustomers');
            const itemsResult = await apiCall('getItems');
            
            if (!salesResult?.data || !customersResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const customers = customersResult.data;
            const items = itemsResult.data;
            let sales = salesResult.data;
            
            // Fetch ALL sales order lines with their SO info
            const allDetails = [];
            for (const so of sales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const unitsPerPackage = parseFloat(item?.Units_Per_Package) || 1;
                        const packageCost = parseFloat(item?.Package_Cost) || 0;
                        const unitCost = packageCost / unitsPerPackage;
                        const quantity = parseInt(line.Quantity || 0);
                        const unitPrice = parseFloat(line.Unit_Price || 0);
                        const lineTotal = parseFloat(line.Line_Total || 0);
                        const lineCost = quantity * unitCost;
                        
                        allDetails.push({
                            soId: so.SO_ID,
                            soDate: so.Sale_Date || so.SO_Date,
                            customerId: so.Customer_ID,
                            customerName: getCustomerName(so.Customer_ID),
                            itemId: line.Item_ID,
                            itemDescription: item?.Item_Description || line.Item_ID,
                            quantity: quantity,
                            unitsPerPackage: unitsPerPackage,
                            unitPrice: unitPrice,
                            unitCost: unitCost,
                            lineTotal: lineTotal,
                            lineCost: lineCost,
                            lineProfit: lineTotal - lineCost,
                            paymentStatus: so.Payment_Status || 'Unknown'
                        });
                    });
                }
            }
            
            // Store raw data
            rawReportData['sales-by-customer'] = { sales, customers, items, allDetails };
            
            // APPLY FILTERS
            let filtered = allDetails;
            if (reportFilters.fromDate) {
                const fromDate = new Date(reportFilters.fromDate);
                filtered = filtered.filter(d => new Date(d.soDate) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = new Date(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                filtered = filtered.filter(d => new Date(d.soDate) <= toDate);
            }
            if (reportFilters.customer) {
                filtered = filtered.filter(d => d.customerId === reportFilters.customer);
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(d => d.lineTotal >= reportFilters.minAmount);
            }
            
            // GROUP BY CUSTOMER and calculate totals
            const customerSummary = {};
            filtered.forEach(detail => {
                if (!customerSummary[detail.customerId]) {
                    customerSummary[detail.customerId] = {
                        customerId: detail.customerId,
                        customerName: detail.customerName,
                        totalCases: 0,
                        totalUnits: 0,
                        totalRevenue: 0,
                        totalCost: 0,
                        totalProfit: 0
                    };
                }
                
                const summary = customerSummary[detail.customerId];
                // Calculate cases (divide units by units per package)
                const cases = detail.quantity / detail.unitsPerPackage;
                summary.totalCases += cases;
                summary.totalUnits += detail.quantity;
                summary.totalRevenue += detail.lineTotal;
                summary.totalCost += detail.lineCost;
                summary.totalProfit += detail.lineProfit;
            });
            
            // Convert to array and calculate margin %
            const summaryArray = Object.values(customerSummary).map(s => ({
                ...s,
                marginPercent: s.totalRevenue > 0 ? (s.totalProfit / s.totalRevenue) * 100 : 0
            }));
            
            // Sort by total revenue (highest first)
            summaryArray.sort((a, b) => b.totalRevenue - a.totalRevenue);
            
            // Calculate grand totals
            const grandTotalRevenue = summaryArray.reduce((sum, s) => sum + s.totalRevenue, 0);
            const grandTotalCost = summaryArray.reduce((sum, s) => sum + s.totalCost, 0);
            const grandTotalProfit = summaryArray.reduce((sum, s) => sum + s.totalProfit, 0);
            const grandTotalCases = summaryArray.reduce((sum, s) => sum + s.totalCases, 0);
            const grandTotalUnits = summaryArray.reduce((sum, s) => sum + s.totalUnits, 0);
            const grandMargin = grandTotalRevenue > 0 ? (grandTotalProfit / grandTotalRevenue) * 100 : 0;
            
            // Build customer list for filter
            const customerList = customers.map(c => ({ id: c.Customer_ID, name: c.Customer_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('sales-by-customer', {
                dateRange: true,
                dateLabel: 'Sale Date',
                customer: true,
                customerList: customerList,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>ğŸ“Š Sales by Customer Summary</h3>
                    <p style="color: #666;">Total Customers: ${summaryArray.length} | Total Revenue: $${grandTotalRevenue.toFixed(2)} | Total Profit: $${grandTotalProfit.toFixed(2)} | Gross Margin: ${grandMargin.toFixed(1)}%</p>
                </div>`;
            
            if (summaryArray.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table" id="salesByCustomerTable">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Total Cases</th>
                            <th>Total Units</th>
                            <th>Total Revenue</th>
                            <th>Total Cost</th>
                            <th>Total Profit</th>
                            <th>Gross Margin %</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                summaryArray.forEach(summary => {
                    const marginColor = summary.marginPercent >= 30 ? '#2e7d32' : summary.marginPercent >= 20 ? '#f57c00' : '#c62828';
                    html += `<tr style="cursor: pointer;" onclick="openCustomer('${summary.customerId}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td><strong style="color: #667eea;">${summary.customerName}</strong></td>
                        <td>${summary.totalCases.toFixed(1)}</td>
                        <td>${Math.round(summary.totalUnits).toLocaleString()}</td>
                        <td><strong>$${summary.totalRevenue.toFixed(2)}</strong></td>
                        <td>$${summary.totalCost.toFixed(2)}</td>
                        <td style="color: ${summary.totalProfit >= 0 ? 'green' : 'red'};"><strong>$${summary.totalProfit.toFixed(2)}</strong></td>
                        <td style="color: ${marginColor}; font-weight: bold;">${summary.marginPercent.toFixed(1)}%</td>
                    </tr>`;
                });
                
                // Add totals row
                html += `<tr style="background: #f0f0f0; font-weight: bold; border-top: 3px solid #667eea;">
                    <td style="text-align: right; padding-right: 20px;">TOTALS:</td>
                    <td>${grandTotalCases.toFixed(1)}</td>
                    <td>${Math.round(grandTotalUnits).toLocaleString()}</td>
                    <td><strong>$${grandTotalRevenue.toFixed(2)}</strong></td>
                    <td>$${grandTotalCost.toFixed(2)}</td>
                    <td style="color: ${grandTotalProfit >= 0 ? 'green' : 'red'};"><strong>$${grandTotalProfit.toFixed(2)}</strong></td>
                    <td style="color: ${grandMargin >= 30 ? '#2e7d32' : grandMargin >= 20 ? '#f57c00' : '#c62828'}; font-weight: bold;">${grandMargin.toFixed(1)}%</td>
                </tr>`;
            
                html += '</tbody></table>';
            }
            
            reportData['sales-by-customer'] = summaryArray;
            document.getElementById('reportContainer').innerHTML = html;
            setTimeout(() => makeSortable('salesByCustomerTable'), 0);
        }
        
        // SALES ORDER DETAIL REPORT (NEW!)
        async function generateSalesOrderDetail() {
            const salesResult = await apiCall('getSalesOrders');
            const customersResult = await apiCall('getCustomers');
            const itemsResult = await apiCall('getItems');
            
            if (!salesResult?.data || !customersResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const customers = customersResult.data;
            const items = itemsResult.data;
            let sales = salesResult.data;
            
            // Fetch ALL sales order lines with their SO info
            const allDetails = [];
            for (const so of sales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        allDetails.push({
                            soId: so.SO_ID,
                            soDate: so.Sale_Date || so.SO_Date,
                            customerId: so.Customer_ID,
                            customerName: getCustomerName(so.Customer_ID),
                            itemId: line.Item_ID,
                            itemDescription: item?.Item_Description || line.Item_ID,
                            sku: item?.SKU || '',
                            quantity: parseInt(line.Quantity || 0),
                            unitPrice: parseFloat(line.Unit_Price || 0),
                            lineTotal: parseFloat(line.Line_Total || 0),
                            paymentStatus: so.Payment_Status || 'Unknown',
                            status: so.Status || 'Completed'
                        });
                    });
                }
            }
            
            // Store raw data
            rawReportData['sales-order-detail'] = { sales, customers, items, allDetails };
            
            // APPLY FILTERS
            let filtered = allDetails;
            if (reportFilters.fromDate) {
                const fromDate = new Date(reportFilters.fromDate);
                filtered = filtered.filter(d => new Date(d.soDate) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = new Date(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                filtered = filtered.filter(d => new Date(d.soDate) <= toDate);
            }
            if (reportFilters.customer) {
                filtered = filtered.filter(d => d.customerId === reportFilters.customer);
            }
            if (reportFilters.item) {
                filtered = filtered.filter(d => d.itemId === reportFilters.item);
            }
            if (reportFilters.paymentStatus) {
                filtered = filtered.filter(d => d.paymentStatus === reportFilters.paymentStatus);
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(d => d.lineTotal >= reportFilters.minAmount);
            }
            
            // Sort by date (newest first), then by SO ID
            filtered.sort((a, b) => {
                const dateCompare = new Date(b.soDate) - new Date(a.soDate);
                if (dateCompare !== 0) return dateCompare;
                return b.soId.localeCompare(a.soId);
            });
            
            // Calculate totals
            const totalSales = filtered.reduce((sum, d) => sum + d.lineTotal, 0);
            const totalOrders = new Set(filtered.map(d => d.soId)).size;
            
            // Build lists for filters
            const customerList = customers.map(c => ({ id: c.Customer_ID, name: c.Customer_Name }));
            const itemList = items.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            
            // Build HTML with filters
            let html = buildFilterUI('sales-order-detail', {
                dateRange: true,
                dateLabel: 'Sale Date',
                customer: true,
                customerList: customerList,
                item: true,
                itemList: itemList,
                paymentStatus: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>ğŸ“‹ Sales Order Detail Report</h3>
                    <p style="color: #666;">Total Orders: ${totalOrders} | Total Lines: ${filtered.length} | Total Sales: $${totalSales.toFixed(2)}</p>
                </div>`;
            
            if (filtered.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table" id="salesOrderDetailTable">
                    <thead>
                        <tr>
                            <th>SO #</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Item</th>
                            <th>SKU</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Payment</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                filtered.forEach(detail => {
                    html += `<tr style="cursor: pointer;" onclick="openSalesOrder('${detail.soId}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td><strong style="color: #667eea;">${detail.soId}</strong></td>
                        <td>${new Date(detail.soDate).toLocaleDateString()}</td>
                        <td style="color: #667eea;">${detail.customerName}</td>
                        <td style="color: #667eea;">${detail.itemDescription}</td>
                        <td>${detail.sku}</td>
                        <td>${detail.quantity}</td>
                        <td>$${detail.unitPrice.toFixed(2)}</td>
                        <td>$${detail.lineTotal.toFixed(2)}</td>
                        <td>${detail.status}</td>
                        <td><span style="color: ${detail.paymentStatus === 'Paid' ? 'green' : detail.paymentStatus === 'Partial' ? 'orange' : 'red'};">${detail.paymentStatus}</span></td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['sales-order-detail'] = filtered;
            document.getElementById('reportContainer').innerHTML = html;
            setTimeout(() => makeSortable('salesOrderDetailTable'), 0);
        }
        
        // 2. SALES BY PRODUCT REPORT
        async function generateSalesByProduct() {
            const itemsResult = await apiCall('getItems');
            const suppliersResult = await apiCall('getSuppliers');
            const salesResult = await apiCall('getSalesOrders');
            
            if (!itemsResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const suppliers = suppliersResult.data;
            let sales = salesResult?.data || [];
            
            // Fetch ALL sales order lines to get units sold
            const allLines = [];
            for (const so of sales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        line.SO_Date = so.Sale_Date || so.SO_Date;
                        allLines.push(line);
                    });
                }
            }
            
            // APPLY DATE FILTERS to sales lines
            let filteredLines = allLines;
            if (reportFilters.fromDate) {
                const fromDate = new Date(reportFilters.fromDate);
                filteredLines = filteredLines.filter(line => new Date(line.SO_Date) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = new Date(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                filteredLines = filteredLines.filter(line => new Date(line.SO_Date) <= toDate);
            }
            
            // Calculate units sold per item
            const unitsSoldByItem = {};
            filteredLines.forEach(line => {
                const itemId = line.Item_ID;
                unitsSoldByItem[itemId] = (unitsSoldByItem[itemId] || 0) + parseInt(line.Quantity || 0);
            });
            
            // Build product list with margins - INCLUDE ALL ITEMS
            const productData = items.map(item => {
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitCost = packageCost / unitsPerPackage;
                const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const margin = unitSellPrice - unitCost;
                const marginPercent = unitSellPrice > 0 ? (margin / unitSellPrice) * 100 : 0;
                const unitsSold = unitsSoldByItem[item.Item_ID] || 0;
                const totalProfit = unitsSold * margin;
                
                return {
                    id: item.Item_ID,
                    description: item.Item_Description || '',
                    sku: item.SKU || '',
                    supplierId: item.Supplier_ID || '',
                    unitCost: unitCost,
                    unitSellPrice: unitSellPrice,
                    margin: margin,
                    marginPercent: marginPercent,
                    unitsSold: unitsSold,
                    totalProfit: totalProfit
                };
            });
            
            // Store raw data
            rawReportData['sales-by-product'] = { items, suppliers, productData };
            
            // APPLY FILTERS
            let filtered = productData;
            
            if (reportFilters.item) {
                filtered = filtered.filter(p => p.id === reportFilters.item);
            }
            if (reportFilters.supplier) {
                filtered = filtered.filter(p => p.supplierId === reportFilters.supplier);
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(p => p.margin >= reportFilters.minAmount);
            }
            
            // Sort by margin % (highest first)
            const sorted = filtered.sort((a, b) => b.marginPercent - a.marginPercent);
            
            // Build filter lists
            const itemList = items.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('sales-by-product', {
                dateRange: false, // Remove date filter - this is about pricing, not sales history
                item: true,
                itemList: itemList,
                supplier: true,
                supplierList: supplierList,
                minAmount: true,
                amountLabel: 'Min Margin ($)'
            });
            
            // Calculate totals
            const avgMarginPercent = sorted.length > 0 
                ? sorted.reduce((sum, p) => sum + p.marginPercent, 0) / sorted.length 
                : 0;
            const totalPotentialProfit = sorted.reduce((sum, p) => sum + p.totalProfit, 0);
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>ğŸ“¦ Sales by Item - Pricing & Margin Analysis</h3>
                    <p style="color: #666;">Total Items: ${sorted.length} | Average Margin: ${avgMarginPercent.toFixed(1)}% | Total Profit (from sales): $${totalPotentialProfit.toFixed(2)}</p>
                    
                </div>`;
            
            if (sorted.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table" id="salesByProductTable">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>SKU</th>
                            <th>Cost</th>
                            <th>Sell</th>
                            <th>Margin</th>
                            <th>Margin %</th>
                            <th>Units Sold</th>
                            <th>Total Profit</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                sorted.forEach(product => {
                    const marginColor = product.marginPercent >= 30 ? '#2e7d32' : product.marginPercent >= 20 ? '#f57c00' : '#c62828';
                    html += `<tr style="cursor: pointer;" onclick="openItem('${product.id}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td><strong style="color: #667eea;">${product.description}</strong></td>
                        <td>${product.sku}</td>
                        <td>$${product.unitCost.toFixed(2)}</td>
                        <td>$${product.unitSellPrice.toFixed(2)}</td>
                        <td style="color: ${product.margin >= 0 ? 'green' : 'red'};">$${product.margin.toFixed(2)}</td>
                        <td style="color: ${marginColor}; font-weight: bold;">${product.marginPercent.toFixed(1)}%</td>
                        <td>${product.unitsSold.toLocaleString()}</td>
                        <td style="color: ${product.totalProfit >= 0 ? 'green' : 'red'};"><strong>$${product.totalProfit.toFixed(2)}</strong></td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['sales-by-product'] = sorted;
            document.getElementById('reportContainer').innerHTML = html;
            setTimeout(() => makeSortable('salesByProductTable'), 0);
        }
        
        // PURCHASE ORDER DETAIL REPORT (NEW!)
        async function generatePurchaseOrderDetail() {
            const purchasesResult = await apiCall('getPurchaseOrders');
            const suppliersResult = await apiCall('getSuppliers');
            const itemsResult = await apiCall('getItems');
            
            if (!purchasesResult?.data || !suppliersResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            const items = itemsResult.data;
            let purchases = purchasesResult.data;
            
            // Fetch ALL purchase order lines with their PO info
            const allDetails = [];
            for (const po of purchases) {
                const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        allDetails.push({
                            poId: po.PO_ID,
                            poDate: po.PO_Date,
                            supplierId: po.Supplier_ID,
                            supplierName: getSupplierName(po.Supplier_ID),
                            itemId: line.Item_ID,
                            itemDescription: item?.Item_Description || line.Item_ID,
                            sku: item?.SKU || '',
                            quantity: parseInt(line.Quantity || 0),
                            unitCost: parseFloat(line.Unit_Cost || 0),
                            lineTotal: parseFloat(line.Line_Total || 0),
                            paymentStatus: po.Payment_Status || 'Unknown',
                            status: po.Status || 'Received'
                        });
                    });
                }
            }
            
            // Store raw data
            rawReportData['purchase-order-detail'] = { purchases, suppliers, items, allDetails };
            
            // APPLY FILTERS
            let filtered = allDetails;
            if (reportFilters.fromDate) {
                const fromDate = new Date(reportFilters.fromDate);
                filtered = filtered.filter(d => new Date(d.poDate) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = new Date(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                filtered = filtered.filter(d => new Date(d.poDate) <= toDate);
            }
            if (reportFilters.supplier) {
                filtered = filtered.filter(d => d.supplierId === reportFilters.supplier);
            }
            if (reportFilters.item) {
                filtered = filtered.filter(d => d.itemId === reportFilters.item);
            }
            if (reportFilters.paymentStatus) {
                filtered = filtered.filter(d => d.paymentStatus === reportFilters.paymentStatus);
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(d => d.lineTotal >= reportFilters.minAmount);
            }
            
            // Sort by date (newest first), then by PO ID
            filtered.sort((a, b) => {
                const dateCompare = new Date(b.poDate) - new Date(a.poDate);
                if (dateCompare !== 0) return dateCompare;
                return b.poId.localeCompare(a.poId);
            });
            
            // Calculate totals
            const totalPurchases = filtered.reduce((sum, d) => sum + d.lineTotal, 0);
            const totalOrders = new Set(filtered.map(d => d.poId)).size;
            
            // Build lists for filters
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            const itemList = items.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            
            // Build HTML with filters
            let html = buildFilterUI('purchase-order-detail', {
                dateRange: true,
                dateLabel: 'Purchase Date',
                supplier: true,
                supplierList: supplierList,
                item: true,
                itemList: itemList,
                paymentStatus: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>ğŸ“‹ Purchase Order Detail Report</h3>
                    <p style="color: #666;">Total Orders: ${totalOrders} | Total Lines: ${filtered.length} | Total Purchases: $${totalPurchases.toFixed(2)}</p>
                    
                </div>`;
            
            if (filtered.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table" id="purchaseOrderDetailTable">
                    <thead>
                        <tr>
                            <th>PO #</th>
                            <th>Date</th>
                            <th>Supplier</th>
                            <th>Item</th>
                            <th>SKU</th>
                            <th>Qty</th>
                            <th>Cost</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Payment</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                filtered.forEach(detail => {
                    html += `<tr style="cursor: pointer;" onclick="openPurchaseOrder('${detail.poId}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td><strong style="color: #667eea;">${detail.poId}</strong></td>
                        <td>${new Date(detail.poDate).toLocaleDateString()}</td>
                        <td style="color: #667eea;">${detail.supplierName}</td>
                        <td style="color: #667eea;">${detail.itemDescription}</td>
                        <td>${detail.sku}</td>
                        <td>${detail.quantity}</td>
                        <td>$${detail.unitCost.toFixed(2)}</td>
                        <td>$${detail.lineTotal.toFixed(2)}</td>
                        <td>${detail.status}</td>
                        <td><span style="color: ${detail.paymentStatus === 'Paid' ? 'green' : detail.paymentStatus === 'Partial' ? 'orange' : 'red'};">${detail.paymentStatus}</span></td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['purchase-order-detail'] = filtered;
            document.getElementById('reportContainer').innerHTML = html;
            setTimeout(() => makeSortable('purchaseOrderDetailTable'), 0);
        }
        
        // 3. PURCHASE BY SUPPLIER REPORT
        async function generatePurchaseBySupplier() {
            const purchasesResult = await apiCall('getPurchaseOrders');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!purchasesResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            let purchases = purchasesResult.data;
            
            // Store raw data
            rawReportData['purchase-by-supplier'] = { purchases, suppliers };
            
            // APPLY FILTERS
            if (reportFilters.fromDate) {
                const fromDate = new Date(reportFilters.fromDate);
                purchases = purchases.filter(po => new Date(po.PO_Date) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = new Date(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                purchases = purchases.filter(po => new Date(po.PO_Date) <= toDate);
            }
            if (reportFilters.supplier) {
                purchases = purchases.filter(po => po.Supplier_ID === reportFilters.supplier);
            }
            if (reportFilters.minAmount) {
                purchases = purchases.filter(po => parseFloat(po.Total_Amount || po.Invoice_Total || 0) >= reportFilters.minAmount);
            }
            
            // Build supplier purchase summary
            const supplierPurchases = {};
            
            purchases.forEach(po => {
                const suppId = po.Supplier_ID;
                if (!supplierPurchases[suppId]) {
                    const supplier = suppliers.find(s => s.Supplier_ID === suppId);
                    supplierPurchases[suppId] = {
                        id: suppId,
                        name: supplier?.Supplier_Name || suppId,
                        totalSpent: 0,
                        orderCount: 0,
                        lastOrderDate: null
                    };
                }
                
                const total = parseFloat(po.Total_Amount || po.Invoice_Total || 0);
                supplierPurchases[suppId].totalSpent += total;
                supplierPurchases[suppId].orderCount++;
                
                const orderDate = new Date(po.PO_Date);
                if (!supplierPurchases[suppId].lastOrderDate || orderDate > supplierPurchases[suppId].lastOrderDate) {
                    supplierPurchases[suppId].lastOrderDate = orderDate;
                }
            });
            
            // Sort by total spent
            const sorted = Object.values(supplierPurchases).sort((a, b) => b.totalSpent - a.totalSpent);
            
            // Build supplier list for filter
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('purchase-by-supplier', {
                dateRange: true,
                dateLabel: 'Purchase Date',
                supplier: true,
                supplierList: supplierList,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>ğŸ­ Purchase by Supplier Report</h3>
                    <p style="color: #666;">Suppliers: ${sorted.length} | Total Spent: $${sorted.reduce((sum, s) => sum + s.totalSpent, 0).toFixed(2)}</p>
                    
                </div>`;
            
            if (sorted.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Supplier</th>
                            <th>Orders</th>
                            <th>Total Spent</th>
                            <th>Avg Order</th>
                            <th>Last Order</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                sorted.forEach(supp => {
                    const avgOrder = supp.totalSpent / supp.orderCount;
                    
                    html += `<tr>
                        <td><strong>${supp.name}</strong></td>
                        <td>${supp.orderCount}</td>
                        <td>$${supp.totalSpent.toFixed(2)}</td>
                        <td>$${avgOrder.toFixed(2)}</td>
                        <td>${supp.lastOrderDate ? supp.lastOrderDate.toLocaleDateString() : '-'}</td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['purchase-by-supplier'] = sorted;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 4. INVENTORY TURNOVER REPORT
        async function generateInventoryTurnover() {
            const inventoryResult = await apiCall('getInventoryReport');
            const salesResult = await apiCall('getSalesOrders');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!inventoryResult?.data || !salesResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const inventory = inventoryResult.data;
            const sales = salesResult.data;
            const suppliers = suppliersResult.data;
            
            // Fetch ALL sales order lines
            const allLines = [];
            for (const so of sales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    allLines.push(...linesResult.data);
                }
            }
            
            // Store raw data
            rawReportData['inventory-turnover'] = { inventory, sales, suppliers, allLines };
            
            // Calculate units sold per item
            const unitsSold = {};
            allLines.forEach(line => {
                const itemId = line.Item_ID;
                unitsSold[itemId] = (unitsSold[itemId] || 0) + parseInt(line.Quantity || 0);
            });
            
            // Build turnover report
            let turnoverData = inventory.map(item => {
                const sold = unitsSold[item.Item_ID] || 0;
                const onHand = parseInt(item.Qty_On_Hand) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                const avgInventory = onHand + (sold / 2);
                const turnover = avgInventory > 0 ? sold / avgInventory : 0;
                
                // Calculate cost from package cost
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPackage;
                const value = onHand * unitCost;
                
                return {
                    id: item.Item_ID,
                    description: item.Item_Description,
                    sku: item.SKU,
                    supplierId: item.Supplier_ID,
                    onHand: onHand,
                    onOrder: onOrder,
                    sold: sold,
                    turnover: turnover,
                    value: value,
                    status: turnover > 4 ? 'Fast' : turnover > 2 ? 'Normal' : 'Slow'
                };
            });
            
            // APPLY FILTERS
            if (reportFilters.supplier) {
                turnoverData = turnoverData.filter(item => item.supplierId === reportFilters.supplier);
            }
            if (reportFilters.turnoverStatus) {
                turnoverData = turnoverData.filter(item => item.status === reportFilters.turnoverStatus);
            }
            if (reportFilters.minAmount) {
                turnoverData = turnoverData.filter(item => item.value >= reportFilters.minAmount);
            }
            
            // Sort by turnover
            turnoverData.sort((a, b) => b.turnover - a.turnover);
            
            // Build supplier list for filter
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('inventory-turnover', {
                supplier: true,
                supplierList: supplierList,
                turnoverStatus: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>ğŸ”„ Inventory Turnover Report</h3>
                    <p style="color: #666;">Total Items: ${turnoverData.length}</p>
                    
                </div>`;
            
            if (turnoverData.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>On Hand</th>
                            <th>On Order</th>
                            <th>Units Sold</th>
                            <th>Turnover Rate</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                turnoverData.forEach(item => {
                    const statusColor = item.status === 'Fast' ? 'green' : item.status === 'Normal' ? 'orange' : 'red';
                    const qtyOnOrder = parseFloat(item.onOrder) || 0;
                    
                    html += `<tr>
                        <td><strong>${item.description}</strong></td>
                        <td>${item.sku}</td>
                        <td>${item.onHand}</td>
                        <td><span style="background: ${qtyOnOrder > 0 ? '#ffc107' : '#e0e0e0'}; padding: 3px 8px; border-radius: 4px; font-weight: bold;">${qtyOnOrder}</span></td>
                        <td>${item.sold}</td>
                        <td>${item.turnover.toFixed(2)}</td>
                        <td style="color: ${statusColor}; font-weight: bold;">${item.status}</td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['inventory-turnover'] = turnoverData;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 5. GROSS MARGIN REPORT
        async function generateGrossMargin() {
            const itemsResult = await apiCall('getItems');
            const salesResult = await apiCall('getSalesOrders');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!itemsResult?.data || !salesResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const sales = salesResult.data;
            const suppliers = suppliersResult.data;
            
            // Store raw data
            rawReportData['gross-margin'] = { items, sales, suppliers };
            
            // Calculate margin per item
            let marginData = items.map(item => {
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const cost = packageCost / unitsPerPackage;
                const sell = parseFloat(item.Unit_Sell_Price) || 0;
                const margin = sell - cost;
                const marginPercent = sell > 0 ? (margin / sell) * 100 : 0;
                
                // Calculate units sold
                let unitsSold = 0;
                sales.forEach(so => {
                    // Parse lines if they're stored as JSON string
                    let lines = so.lines;
                    if (typeof lines === 'string') {
                        try {
                            lines = JSON.parse(lines);
                        } catch (e) {
                            lines = [];
                        }
                    }
                    
                    if (lines && Array.isArray(lines)) {
                        lines.forEach(line => {
                            if ((line.itemId || line.Item_ID) === item.Item_ID) {
                                unitsSold += parseInt(line.quantity || line.Quantity || 0);
                            }
                        });
                    }
                });
                
                const totalProfit = margin * unitsSold;
                
                return {
                    id: item.Item_ID,
                    description: item.Item_Description,
                    sku: item.SKU,
                    supplierId: item.Supplier_ID,
                    cost: cost,
                    sell: sell,
                    margin: margin,
                    marginPercent: marginPercent,
                    unitsSold: unitsSold,
                    totalProfit: totalProfit
                };
            });
            
            // APPLY FILTERS
            if (reportFilters.supplier) {
                marginData = marginData.filter(item => item.supplierId === reportFilters.supplier);
            }
            if (reportFilters.item) {
                marginData = marginData.filter(item => item.id === reportFilters.item);
            }
            if (reportFilters.minAmount) {
                marginData = marginData.filter(item => item.marginPercent >= reportFilters.minAmount);
            }
            // Add max margin filter (using minAmount field with special handling)
            const maxMarginFilter = document.getElementById('filter_maxMargin');
            if (maxMarginFilter && maxMarginFilter.value) {
                const maxMargin = parseFloat(maxMarginFilter.value);
                marginData = marginData.filter(item => item.marginPercent <= maxMargin);
            }
            
            // Sort by total profit
            marginData.sort((a, b) => b.totalProfit - a.totalProfit);
            
            // Build filter lists
            const itemList = items.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters (with custom min/max margin)
            let html = buildFilterUI('gross-margin', {
                supplier: true,
                supplierList: supplierList,
                item: true,
                itemList: itemList,
                minAmount: false // We'll add custom margin filters
            });
            
            // Add custom min/max margin filters
            const filterDiv = html.lastIndexOf('</div>');
            html = html.substring(0, filterDiv) + `
                <div class="form-group">
                    <label>Min Margin %</label>
                    <input type="number" id="filter_minMargin" step="0.1" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Max Margin %</label>
                    <input type="number" id="filter_maxMargin" step="0.1" placeholder="100">
                </div>
            ` + html.substring(filterDiv);
            
            const totalProfit = marginData.reduce((sum, item) => sum + item.totalProfit, 0);
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>ğŸ’° Gross Margin Report</h3>
                    <p style="color: #666;">Total Products: ${marginData.length} | Total Profit: $${totalProfit.toFixed(2)}</p>
                    
                </div>`;
            
            if (marginData.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Cost</th>
                            <th>Sell</th>
                            <th>Margin</th>
                            <th>Margin %</th>
                            <th>Units Sold</th>
                            <th>Total Profit</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                marginData.forEach(item => {
                    const marginColor = item.marginPercent > 40 ? 'green' : item.marginPercent > 20 ? 'orange' : 'red';
                    
                    html += `<tr>
                        <td><strong>${item.description}</strong></td>
                        <td>${item.sku}</td>
                        <td>$${item.cost.toFixed(2)}</td>
                        <td>$${item.sell.toFixed(2)}</td>
                        <td>$${item.margin.toFixed(2)}</td>
                        <td style="color: ${marginColor}; font-weight: bold;">${item.marginPercent.toFixed(1)}%</td>
                        <td>${item.unitsSold}</td>
                        <td style="font-weight: bold;">$${item.totalProfit.toFixed(2)}</td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['gross-margin'] = marginData;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 6. ACCOUNTS RECEIVABLE REPORT (Who owes you money)
        async function generateAccountsReceivable() {
            const salesResult = await apiCall('getSalesOrders');
            const customersResult = await apiCall('getCustomers');
            
            if (!salesResult?.data || !customersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const customers = customersResult.data;
            const sales = salesResult.data;
            
            // Store raw data
            rawReportData['accounts-receivable'] = { sales, customers };
            
            // Filter for unpaid/partial invoices
            let receivables = sales
                .filter(so => {
                    const status = so.Payment_Status || 'Unpaid';
                    return status !== 'Paid';
                })
                .map(so => {
                    const customer = customers.find(c => c.Customer_ID === so.Customer_ID);
                    const total = parseFloat(so.Total_Amount || so.Order_Total || 0);
                    const paid = parseFloat(so.Amount_Paid || 0);
                    const balance = total - paid;
                    const dueDate = so.Due_Date ? new Date(so.Due_Date) : null;
                    const today = new Date();
                    const daysOverdue = dueDate ? Math.floor((today - dueDate) / (1000 * 60 * 60 * 24)) : 0;
                    
                    let aging = 'Current';
                    if (daysOverdue > 60) aging = '60+ days';
                    else if (daysOverdue > 30) aging = '31-60 days';
                    else if (daysOverdue > 0) aging = '1-30 days';
                    
                    return {
                        customerId: so.Customer_ID,
                        customer: customer?.Customer_Name || so.Customer_ID,
                        invoiceId: so.SO_ID,
                        invoiceDate: new Date(so.Sale_Date || so.SO_Date).toLocaleDateString(),
                        dueDate: dueDate ? dueDate.toLocaleDateString() : '-',
                        total: total,
                        paid: paid,
                        balance: balance,
                        status: so.Payment_Status || 'Unpaid',
                        daysOverdue: daysOverdue,
                        aging: aging,
                        agingCategory: aging // For filtering
                    };
                });
            
            // APPLY FILTERS
            if (reportFilters.customer) {
                receivables = receivables.filter(r => r.customerId === reportFilters.customer);
            }
            if (reportFilters.minAmount) {
                receivables = receivables.filter(r => r.balance >= reportFilters.minAmount);
            }
            if (reportFilters.paymentStatus) {
                if (reportFilters.paymentStatus === 'Overdue') {
                    receivables = receivables.filter(r => r.daysOverdue > 0);
                } else {
                    receivables = receivables.filter(r => r.status === reportFilters.paymentStatus);
                }
            }
            if (reportFilters.aging) {
                const agingFilter = reportFilters.aging;
                if (agingFilter === '1-30') {
                    receivables = receivables.filter(r => r.aging === '1-30 days');
                } else if (agingFilter === '31-60') {
                    receivables = receivables.filter(r => r.aging === '31-60 days');
                } else if (agingFilter === '60+') {
                    receivables = receivables.filter(r => r.aging === '60+ days');
                } else if (agingFilter === 'Current') {
                    receivables = receivables.filter(r => r.aging === 'Current');
                }
            }
            
            // Sort by days overdue
            receivables.sort((a, b) => b.daysOverdue - a.daysOverdue);
            
            const totalOutstanding = receivables.reduce((sum, r) => sum + r.balance, 0);
            
            // Build customer list for filter
            const customerList = customers.map(c => ({ id: c.Customer_ID, name: c.Customer_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('accounts-receivable', {
                customer: true,
                customerList: customerList,
                paymentStatus: true,
                aging: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>ğŸ’µ Accounts Receivable Report</h3>
                    <p style="color: #666;">Outstanding Invoices: ${receivables.length} | Total AR: $${totalOutstanding.toFixed(2)}</p>
                    
                </div>`;
            
            if (receivables.length === 0) {
                html += '<p style="color: green; font-size: 18px; text-align: center; padding: 40px;">âœ… All invoices paid! No outstanding receivables.</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Invoice #</th>
                            <th>Invoice Date</th>
                            <th>Due Date</th>
                            <th>Total</th>
                            <th>Paid</th>
                            <th>Balance Due</th>
                            <th>Days Overdue</th>
                            <th>Aging</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                receivables.forEach(r => {
                    const statusColor = r.status === 'Overdue' || r.daysOverdue > 0 ? 'red' : 'orange';
                    const agingColor = r.daysOverdue > 60 ? 'red' : r.daysOverdue > 30 ? 'orange' : r.daysOverdue > 0 ? '#f39c12' : 'green';
                    
                    html += `<tr>
                        <td><a href="javascript:void(0)" onclick="openCustomer('${r.customerId}')" style="color: #667eea; text-decoration: none;"><strong>${r.customer}</strong></a></td>
                        <td><a href="javascript:void(0)" onclick="openSalesOrder('${r.invoiceId}')" style="color: #667eea; text-decoration: none;"><strong>${r.invoiceId}</strong></a></td>
                        <td>${r.invoiceDate}</td>
                        <td>${r.dueDate}</td>
                        <td>$${r.total.toFixed(2)}</td>
                        <td>$${r.paid.toFixed(2)}</td>
                        <td style="font-weight: bold; color: ${statusColor};">$${r.balance.toFixed(2)}</td>
                        <td style="color: ${r.daysOverdue > 0 ? 'red' : 'green'};">${r.daysOverdue > 0 ? r.daysOverdue : '-'}</td>
                        <td style="color: ${agingColor}; font-weight: bold;">${r.aging}</td>
                        <td style="color: ${statusColor};">${r.status}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            }
            
            reportData['accounts-receivable'] = receivables;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 7. ACCOUNTS PAYABLE REPORT (Who you owe money to)
        async function generateAccountsPayable() {
            const purchasesResult = await apiCall('getPurchaseOrders');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!purchasesResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            const purchases = purchasesResult.data;
            
            // Store raw data
            rawReportData['accounts-payable'] = { purchases, suppliers };
            
            // Filter for unpaid/partial invoices
            let payables = purchases
                .filter(po => {
                    const status = po.Payment_Status || 'Unpaid';
                    return status !== 'Paid';
                })
                .map(po => {
                    const supplier = suppliers.find(s => s.Supplier_ID === po.Supplier_ID);
                    const total = parseFloat(po.Total_Amount || po.Invoice_Total || 0);
                    const paid = parseFloat(po.Amount_Paid || 0);
                    const balance = total - paid;
                    const dueDate = po.Due_Date ? new Date(po.Due_Date) : null;
                    const today = new Date();
                    const daysOverdue = dueDate ? Math.floor((today - dueDate) / (1000 * 60 * 60 * 24)) : 0;
                    
                    let aging = 'Current';
                    if (daysOverdue > 60) aging = '60+ days';
                    else if (daysOverdue > 30) aging = '31-60 days';
                    else if (daysOverdue > 0) aging = '1-30 days';
                    
                    return {
                        supplierId: po.Supplier_ID,
                        supplier: supplier?.Supplier_Name || po.Supplier_ID,
                        invoiceId: po.Invoice_Number || po.PO_ID,
                        poId: po.PO_ID,
                        invoiceDate: new Date(po.PO_Date).toLocaleDateString(),
                        dueDate: dueDate ? dueDate.toLocaleDateString() : '-',
                        total: total,
                        paid: paid,
                        balance: balance,
                        status: po.Payment_Status || 'Unpaid',
                        daysOverdue: daysOverdue,
                        aging: aging,
                        agingCategory: aging // For filtering
                    };
                });
            
            // APPLY FILTERS
            if (reportFilters.supplier) {
                payables = payables.filter(p => p.supplierId === reportFilters.supplier);
            }
            if (reportFilters.minAmount) {
                payables = payables.filter(p => p.balance >= reportFilters.minAmount);
            }
            if (reportFilters.paymentStatus) {
                if (reportFilters.paymentStatus === 'Overdue') {
                    payables = payables.filter(p => p.daysOverdue > 0);
                } else {
                    payables = payables.filter(p => p.status === reportFilters.paymentStatus);
                }
            }
            if (reportFilters.aging) {
                const agingFilter = reportFilters.aging;
                if (agingFilter === '1-30') {
                    payables = payables.filter(p => p.aging === '1-30 days');
                } else if (agingFilter === '31-60') {
                    payables = payables.filter(p => p.aging === '31-60 days');
                } else if (agingFilter === '60+') {
                    payables = payables.filter(p => p.aging === '60+ days');
                } else if (agingFilter === 'Current') {
                    payables = payables.filter(p => p.aging === 'Current');
                }
            }
            
            // Sort by days overdue
            payables.sort((a, b) => b.daysOverdue - a.daysOverdue);
            
            const totalOutstanding = payables.reduce((sum, p) => sum + p.balance, 0);
            
            // Build supplier list for filter
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('accounts-payable', {
                supplier: true,
                supplierList: supplierList,
                paymentStatus: true,
                aging: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>ğŸ’¸ Accounts Payable Report</h3>
                    <p style="color: #666;">Outstanding Bills: ${payables.length} | Total AP: $${totalOutstanding.toFixed(2)}</p>
                    
                </div>`;
            
            if (payables.length === 0) {
                html += '<p style="color: green; font-size: 18px; text-align: center; padding: 40px;">âœ… All bills paid! No outstanding payables.</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Supplier</th>
                            <th>Invoice #</th>
                            <th>PO #</th>
                            <th>Invoice Date</th>
                            <th>Due Date</th>
                            <th>Total</th>
                            <th>Paid</th>
                            <th>Balance Due</th>
                            <th>Days Overdue</th>
                            <th>Aging</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                payables.forEach(p => {
                    const statusColor = p.daysOverdue > 0 ? 'red' : 'orange';
                    const agingColor = p.daysOverdue > 60 ? 'red' : p.daysOverdue > 30 ? 'orange' : p.daysOverdue > 0 ? '#f39c12' : 'green';
                    
                    html += `<tr>
                        <td><a href="javascript:void(0)" onclick="openSupplier('${p.supplierId}')" style="color: #667eea; text-decoration: none;"><strong>${p.supplier}</strong></a></td>
                        <td>${p.invoiceId}</td>
                        <td><a href="javascript:void(0)" onclick="openPurchaseOrder('${p.poId}')" style="color: #667eea; text-decoration: none;"><strong>${p.poId}</strong></a></td>
                        <td>${p.invoiceDate}</td>
                        <td>${p.dueDate}</td>
                        <td>$${p.total.toFixed(2)}</td>
                        <td>$${p.paid.toFixed(2)}</td>
                        <td style="font-weight: bold; color: ${statusColor};">$${p.balance.toFixed(2)}</td>
                        <td style="color: ${p.daysOverdue > 0 ? 'red' : 'green'};">${p.daysOverdue > 0 ? p.daysOverdue : '-'}</td>
                        <td style="color: ${agingColor}; font-weight: bold;">${p.aging}</td>
                        <td style="color: ${statusColor};">${p.status}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            }
            
            reportData['accounts-payable'] = payables;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 8. SIMPLE INVENTORY REPORT
        async function generateSimpleInventory() {
            const inventoryResult = await apiCall('getInventoryReport');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!inventoryResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            let inventory = inventoryResult.data;
            
            // Store raw data
            rawReportData['simple-inventory'] = { inventory, suppliers };
            
            // APPLY FILTERS
            if (reportFilters.supplier) {
                inventory = inventory.filter(item => item.Supplier_ID === reportFilters.supplier);
            }
            if (reportFilters.item) {
                inventory = inventory.filter(item => item.Item_ID === reportFilters.item);
            }
            if (reportFilters.stockStatus) {
                if (reportFilters.stockStatus === 'negative') {
                    inventory = inventory.filter(item => parseFloat(item.Qty_On_Hand || 0) < 0);
                } else if (reportFilters.stockStatus === 'out') {
                    inventory = inventory.filter(item => parseFloat(item.Qty_On_Hand || 0) === 0);
                } else if (reportFilters.stockStatus === 'low') {
                    inventory = inventory.filter(item => {
                        const qty = parseFloat(item.Qty_On_Hand || 0);
                        const reorder = parseFloat(item.Reorder_Point || 0);
                        return qty > 0 && qty <= reorder;
                    });
                } else if (reportFilters.stockStatus === 'ok') {
                    inventory = inventory.filter(item => {
                        const qty = parseFloat(item.Qty_On_Hand || 0);
                        const reorder = parseFloat(item.Reorder_Point || 0);
                        return qty > reorder;
                    });
                }
            }
            if (reportFilters.minAmount) {
                inventory = inventory.filter(item => parseFloat(item.Total_Value || 0) >= reportFilters.minAmount);
            }
            
            // Sort alphabetically
            inventory.sort((a, b) => a.Item_Description.localeCompare(b.Item_Description));
            
            const totalValue = inventory.reduce((sum, item) => sum + parseFloat(item.Total_Value || 0), 0);
            const totalItems = inventory.length;
            const lowStockCount = inventory.filter(item => item.Low_Stock).length;
            
            // Build filter lists
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            const itemList = inventoryResult.data.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            
            // Build HTML with filters
            let html = buildFilterUI('simple-inventory', {
                supplier: true,
                supplierList: supplierList,
                item: true,
                itemList: itemList,
                stockStatus: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>ğŸ“‹ Inventory List Report</h3>
                    <p style="color: #666;">
                        Total Items: ${totalItems} | 
                        Total Value: $${totalValue.toFixed(2)} | 
                        Low Stock Items: ${lowStockCount}
                    </p>
                    
                </div>`;
            
            if (inventory.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No items match your filters</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Description</th>
                            <th>Supplier</th>
                            <th>UOM</th>
                            <th>Qty On Hand</th>
                            <th>On Order</th>
                            <th>Reorder Point</th>
                            <th>Cost</th>
                            <th>Sell Price</th>
                            <th>Total Value</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                inventory.forEach(item => {
                    const lowStock = item.Low_Stock;
                    const qtyOnOrder = parseFloat(item.Qty_On_Order) || 0;
                    const rowStyle = lowStock ? 'background: #fff3cd;' : '';
                    const status = lowStock ? 'âš ï¸ Low Stock' : 'âœ… OK';
                    const statusColor = lowStock ? '#f39c12' : 'green';
                    
                    html += `<tr style="${rowStyle}">
                        <td><strong>${item.SKU || '-'}</strong></td>
                        <td>${item.Item_Description}</td>
                        <td>${getSupplierName(item.Supplier_ID)}</td>
                        <td>${item.UOM}</td>
                        <td style="font-weight: bold;">${item.Qty_On_Hand}</td>
                        <td><span style="background: ${qtyOnOrder > 0 ? '#ffc107' : '#e0e0e0'}; padding: 3px 8px; border-radius: 4px; font-weight: bold;">${qtyOnOrder}</span></td>
                        <td>${item.Reorder_Point}</td>
                        <td>$${(parseFloat(item.Package_Cost) / parseFloat(item.Units_Per_Package || 1)).toFixed(2)}</td>
                        <td>$${parseFloat(item.Unit_Sell_Price).toFixed(2)}</td>
                        <td>$${parseFloat(item.Total_Value).toFixed(2)}</td>
                        <td style="color: ${statusColor}; font-weight: bold;">${status}</td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['simple-inventory'] = inventory;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // ==================== HOT LINK FUNCTIONS ====================
        
        async function openSalesOrder(soId) {
            // Remember current tab to return to later
            const currentTab = document.querySelector('.card.active');
            if (currentTab && currentTab.id === 'reports') {
                returnToTab = 'reports';
            } else {
                returnToTab = null;
            }
            
            // Load the sales order and open edit modal
            const result = await apiCall('getSalesOrders');
            const so = result.data.find(s => s.SO_ID === soId);
            if (so) {
                // Switch to Sales tab and show the order
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="sales"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('sales').classList.add('active');
                
                // Open the order details modal
                await showSalesOrderDetails(so);
                document.getElementById('orderModal').style.display = 'block'; document.body.classList.add('modal-open');
            } else {
                alert('Sales order not found: ' + soId);
            }
        }
        
        async function openPurchaseOrder(poId) {
            // Remember current tab to return to later
            const currentTab = document.querySelector('.card.active');
            if (currentTab && currentTab.id === 'reports') {
                returnToTab = 'reports';
            } else {
                returnToTab = null;
            }
            
            // Load the purchase order and open edit modal
            const result = await apiCall('getPurchaseOrders');
            const po = result.data.find(p => p.PO_ID === poId);
            if (po) {
                // Switch to Purchases tab and show the order
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="purchases"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('purchases').classList.add('active');
                
                // Open the order details modal
                await showPurchaseOrderDetails(po);
                document.getElementById('orderModal').style.display = 'block'; document.body.classList.add('modal-open');
            } else {
                alert('Purchase order not found: ' + poId);
            }
        }
        
        async function openCustomer(customerId) {
            // Remember current tab to return to later
            const currentTab = document.querySelector('.card.active');
            if (currentTab && currentTab.id === 'reports') {
                returnToTab = 'reports';
            } else {
                returnToTab = null;
            }
            
            // Load customer and open edit modal
            const result = await apiCall('getCustomers');
            const customer = result.data.find(c => c.Customer_ID === customerId);
            if (customer) {
                // Switch to Customers tab
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="customers"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('customers').classList.add('active');
                
                // Show edit form
                showEditCustomerForm(customer);
            } else {
                alert('Customer not found: ' + customerId);
            }
        }
        
        async function openSupplier(supplierId) {
            // Remember current tab to return to later
            const currentTab = document.querySelector('.card.active');
            if (currentTab && currentTab.id === 'reports') {
                returnToTab = 'reports';
            } else {
                returnToTab = null;
            }
            
            // Load supplier and open edit modal
            const result = await apiCall('getSuppliers');
            const supplier = result.data.find(s => s.Supplier_ID === supplierId);
            if (supplier) {
                // Switch to Suppliers tab
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="suppliers"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('suppliers').classList.add('active');
                
                // Show edit form
                showEditSupplierForm(supplier);
            } else {
                alert('Supplier not found: ' + supplierId);
            }
        }
        
        async function openItem(itemId) {
            // Load items if not cached
            if (cachedItems.length === 0) {
                const result = await apiCall('getItems');
                if (result && result.status === 'success') {
                    cachedItems = result.data;
                }
            }
            
            // Switch to Items tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('.tab[onclick*="items"]').classList.add('active');
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            document.getElementById('items').classList.add('active');
            
            // Call editItemById which handles the edit form
            editItemById(itemId);
        }
        
        
        // ==================== CREATE PO (PRINT ONLY) FUNCTIONS ====================
        
        function filterItemsBySupplier() {
            const supplierId = document.getElementById('createPOSupplier').value;
            const itemSelects = document.querySelectorAll('.createpo-item');
            
            itemSelects.forEach(select => {
                // Clear existing options
                select.innerHTML = '<option value="">Select item...</option>';
                
                if (supplierId) {
                    // Filter items by supplier
                    const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
                    supplierItems.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.Item_ID;
                        option.textContent = `${item.SKU || item.Item_ID} - ${item.Item_Description}`;
                        option.dataset.cost = item.Package_Cost || 0;
                        option.dataset.units = item.Units_Per_Package || 1;
                        select.appendChild(option);
                    });
                }
            });
            
            calculateCreatePOTotal();
        }
        
        function addCreatePOLineItem() {
            const container = document.getElementById('createPOLineItems');
            const supplierId = document.getElementById('createPOSupplier').value;
            
            if (!supplierId) {
                alert('Please select a supplier first');
                return;
            }
            
            const newRow = document.createElement('div');
            newRow.className = 'line-item-row';
            newRow.style.cssText = 'display: grid; grid-template-columns: 2.5fr 1fr 0.6fr 0.8fr 0.8fr 0.8fr 50px; gap: 8px; margin-bottom: 10px; align-items: end;';
            newRow.innerHTML = `
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;">ğŸ“¦ Item</label>
                    <select class="createpo-item" style="width: 100%; padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white;" onchange="updateCreatePOItemCost(this)">
                        <option value="">Select item...</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;">ğŸ“¦ Cases</label>
                    <input type="number" class="createpo-qty" placeholder="0" min="1" oninput="calculateCreatePOTotal()" style="width: 100%; padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px;">
                </div>
                <div style="margin-top: 26px;">
                    <div class="createpo-units" style="text-align: center; font-size: 14px; color: #666; padding: 6px;">-</div>
                </div>
                <div style="margin-top: 26px;">
                    <div class="createpo-totalunits" style="text-align: center; font-size: 16px; font-weight: bold; color: var(--primary, #667eea); padding: 6px;">-</div>
                </div>
                <div style="margin-top: 26px;">
                    <div class="createpo-cost" style="text-align: center; font-size: 14px; font-weight: bold; color: #28a745; background: #e8f5e9; padding: 10px; border-radius: 6px;">-</div>
                </div>
                <div style="margin-top: 26px;">
                    <div class="createpo-linetotal" style="text-align: right; font-size: 14px; font-weight: bold; color: var(--primary, #667eea); background: var(--primary-light, #E3F2FD); padding: 10px; border-radius: 6px;">$0.00</div>
                </div>
                <button type="button" class="btn-danger" onclick="removeLineItem(this); calculateCreatePOTotal();" style="width: 100%; padding: 10px; font-size: 14px; margin-top: 26px;">ğŸ—‘ï¸</button>
            `;
            
            container.appendChild(newRow);
            
            // Populate the new select with filtered items
            const itemSelect = newRow.querySelector('.createpo-item');
            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
            supplierItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.Item_ID;
                option.textContent = `${item.SKU || item.Item_ID} - ${item.Item_Description}`;
                option.dataset.cost = item.Package_Cost || 0;
                option.dataset.units = item.Units_Per_Package || 1;
                itemSelect.appendChild(option);
            });
        }
        
        function updateCreatePOItemCost(selectElement) {
            const row = selectElement.closest('.line-item-row');
            const costDiv = row.querySelector('.createpo-cost');
            const unitsDiv = row.querySelector('.createpo-units');
            const qtyInput = row.querySelector('.createpo-qty');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.cost) {
                const cost = parseFloat(selectedOption.dataset.cost);
                const units = parseFloat(selectedOption.dataset.units) || 1;
                
                costDiv.textContent = '$' + cost.toFixed(2);
                unitsDiv.textContent = units;
                
                // Calculate total units if qty is entered
                const qty = parseFloat(qtyInput.value) || 0;
                const totalUnitsDiv = row.querySelector('.createpo-totalunits');
                totalUnitsDiv.textContent = qty > 0 ? (qty * units) : '-';
            } else {
                costDiv.textContent = '-';
                unitsDiv.textContent = '-';
                row.querySelector('.createpo-totalunits').textContent = '-';
            }
            
            calculateCreatePOTotal();
        }
        
        function calculateCreatePOTotal() {
            let totalCost = 0;
            let totalCases = 0;
            let totalUnits = 0;
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            
            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                const costDiv = row.querySelector('.createpo-cost');
                const unitsDiv = row.querySelector('.createpo-units');
                const totalUnitsDiv = row.querySelector('.createpo-totalunits');
                const lineTotalDiv = row.querySelector('.createpo-linetotal');
                
                // Get cost from text (strip $ and parse)
                const costText = costDiv.textContent.replace('$', '');
                const cost = costText === '-' ? 0 : parseFloat(costText);
                
                // Get units per case
                const unitsText = unitsDiv.textContent;
                const unitsPerCase = unitsText === '-' ? 0 : parseFloat(unitsText);
                
                // Update total units for this line
                if (unitsPerCase > 0 && qty > 0) {
                    const lineUnits = qty * unitsPerCase;
                    totalUnitsDiv.textContent = lineUnits;
                    totalUnits += lineUnits;
                } else {
                    totalUnitsDiv.textContent = '-';
                }
                
                // Update line total
                const lineTotal = qty * cost;
                if (lineTotal > 0) {
                    lineTotalDiv.textContent = '$' + lineTotal.toFixed(2);
                } else {
                    lineTotalDiv.textContent = '$0.00';
                }
                
                totalCost += lineTotal;
                totalCases += qty;
            });
            
            // Update all totals
            document.getElementById('createPOTotalCases').textContent = totalCases;
            document.getElementById('createPOTotalUnits').textContent = totalUnits;
            document.getElementById('createPOTotal').textContent = '$' + totalCost.toFixed(2);
            return totalCost;
        }
        
        // ==================== OUTGOING PO FUNCTIONS ====================
        
        // Void a PO (when supplier prices changed)
        async function voidPurchaseOrder(poId) {
            if (!confirm(`â›” VOID Purchase Order ${poId}?\n\nThis will mark the PO as invalid. Use this when:\nâ€¢ Supplier prices have changed\nâ€¢ Order was entered incorrectly\nâ€¢ Order is no longer needed\n\nThe PO will remain in your records but won't affect inventory.`)) {
                return;
            }
            
            const reason = prompt('Optional: Enter reason for voiding (e.g., "Prices increased 10%"):', 'Supplier prices changed');
            
            try {
                const result = await apiCall('updatePurchaseOrder', {
                    poId: poId,
                    status: 'Void',
                    notes: `VOIDED: ${reason || 'No reason provided'} - ${new Date().toLocaleDateString()}`
                });
                
                if (result && result.status === 'success') {
                    showStatus('purchasesStatus', `â›” PO ${poId} has been voided. You can copy it to create a new PO with updated prices.`, 'success');
                    closeModal();
                    loadPurchases();
                } else {
                    alert('Error voiding PO: ' + (result?.message || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        // Duplicate a PO (useful when original was voided due to price changes)
        async function duplicatePO(poId) {
            try {
                // Load the original PO
                const result = await apiCall('getPurchaseOrders');
                if (!result || result.status !== 'success') {
                    alert('Error loading purchase order');
                    return;
                }
                
                const originalPO = result.data.find(p => p.PO_ID === poId);
                if (!originalPO) {
                    alert('Purchase order not found');
                    return;
                }
                
                // Get original line items
                const linesResult = await apiCall('getPurchaseOrderLines', { poId: poId });
                const originalLines = linesResult?.data || [];
                
                if (originalLines.length === 0) {
                    alert('No line items found in original PO');
                    return;
                }
                
                // Confirm with user
                const itemCount = originalLines.length;
                if (!confirm(`Create a NEW Purchase Order with ${itemCount} item(s) from ${poId}?\n\nâš ï¸ You'll need to update prices in the new PO if they've changed.`)) {
                    return;
                }
                
                // Switch to Create PO tab
                switchTab('createpo');
                
                // Pre-select the supplier
                const supplierSelect = document.getElementById('poSupplier');
                if (supplierSelect) {
                    supplierSelect.value = originalPO.Supplier_ID;
                    await loadSupplierItems(); // Load items for this supplier
                }
                
                // Wait a moment for items to load
                setTimeout(async () => {
                    // Add each line item to the new PO
                    for (const line of originalLines) {
                        // Find the item in the dropdown and select it
                        const itemSelect = document.getElementById('poItemSelect');
                        if (itemSelect) {
                            itemSelect.value = line.Item_ID;
                            
                            // Set quantity
                            const qtyInput = document.getElementById('poItemQty');
                            if (qtyInput) {
                                qtyInput.value = line.Quantity || 1;
                            }
                            
                            // Add to PO
                            addItemToPO();
                        }
                    }
                    
                    showStatus('poStatus', `âœ… Copied ${itemCount} items from ${poId}. Review prices and quantities, then save!`, 'success');
                    
                    // Scroll to the line items
                    const poTable = document.getElementById('poLineItemsTable');
                    if (poTable) {
                        poTable.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 500);
                
            } catch (e) {
                alert('Error duplicating PO: ' + e.message);
            }
        }
        
        async function receiveOutgoingPO(poId) {
            // Load the OUTGOING PO
            const result = await apiCall('getPurchaseOrders');
            if (!result || result.status !== 'success') {
                alert('Error loading purchase order');
                return;
            }
            
            const po = result.data.find(p => p.PO_ID === poId);
            if (!po) {
                alert('Purchase order not found');
                return;
            }
            
            if (po.Status !== 'Ordered') {
                alert('This PO has already been received');
                return;
            }
            
            // Load line items
            const linesResult = await apiCall('getPurchaseOrderLines', { poId: poId });
            if (!linesResult || linesResult.status !== 'success') {
                alert('Error loading PO line items');
                return;
            }
            
            const lines = linesResult.data || [];
            
            // Show receive modal
            showReceiveModal(po, lines);
        }
        
        function showReceiveModal(po, lines) {
            // Store supplier ID for adding items
            window.currentReceivePO = po;
            window.currentReceiveLines = lines;
            window.receiveLineCounter = lines.length;
            
            let html = `
                <div style="max-height: 70vh; overflow-y: auto;">
                    <h2>ğŸ“¦ Receive OUTGOING PO</h2>
                    <p><strong>PO:</strong> ${po.PO_ID} | <strong>Supplier:</strong> ${getSupplierName(po.Supplier_ID)}</p>
                    <p><strong>Order Date:</strong> ${new Date(po.PO_Date).toLocaleDateString()}</p>
                    
                    <h3>Items Ordered</h3>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 0;"><strong>ğŸ“‹ Instructions:</strong></p>
                        <ul style="margin: 10px 0 0 20px;">
                            <li><strong>Uncheck</strong> items you did NOT receive (or click ğŸ—‘ï¸ to remove)</li>
                            <li><strong>Adjust quantities</strong> if you received less/more than ordered</li>
                            <li><strong>Add items</strong> if extra items arrived (click "+ Add Item")</li>
                            <li>Click "âœ… Commit to Inventory" to complete receipt</li>
                        </ul>
                    </div>
                    
                    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                    <table class="data-table" id="receiveItemsTable" style="table-layout: fixed; min-width: 600px; width: 100%;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th style="width: 40px; text-align: center;">âœ“</th>
                                <th style="width: 35%;">Item</th>
                                <th style="width: 60px; text-align: center;">Ord</th>
                                <th style="width: 80px; text-align: center;">Recv</th>
                                <th style="width: 80px; text-align: right;">Cost</th>
                                <th style="width: 90px; text-align: right;">Total</th>
                                <th style="width: 40px; text-align: center;">ğŸ—‘ï¸</th>
                            </tr>
                        </thead>
                        <tbody id="receiveItemsBody">
            `;
            
            lines.forEach((line, index) => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                const itemName = item ? item.Item_Description : line.Item_ID;
                const unitCost = parseFloat(line.Unit_Cost) || 0;
                const qtyOrdered = parseFloat(line.Quantity) || 0;
                
                html += `
                    <tr id="receiveLine${index}" data-is-original="true">
                        <td style="text-align: center; padding: 8px 4px;">
                            <input type="checkbox" id="receiveCheck${index}" checked onchange="updateReceiveLine(${index})" style="width: 20px; height: 20px;">
                        </td>
                        <td style="padding: 8px; font-size: 13px; word-wrap: break-word;"><strong>${itemName}</strong></td>
                        <td style="text-align: center; padding: 8px 4px;">${qtyOrdered}</td>
                        <td style="padding: 8px 4px;">
                            <input type="number" 
                                   id="receiveQty${index}" 
                                   value="${qtyOrdered}" 
                                   min="0" 
                                   step="1"
                                   data-item-id="${line.Item_ID}"
                                   data-ordered="${qtyOrdered}"
                                   data-cost="${unitCost}"
                                   style="width: 100%; padding: 8px; font-size: 14px; text-align: center; box-sizing: border-box;"
                                   oninput="updateReceiveLine(${index})">
                        </td>
                        <td style="text-align: right; padding: 8px 4px; font-size: 13px;">$${unitCost.toFixed(2)}</td>
                        <td style="text-align: right; padding: 8px 4px; font-weight: bold;" id="receiveLineTotal${index}">$${(qtyOrdered * unitCost).toFixed(2)}</td>
                        <td style="text-align: center; padding: 8px 4px;">
                            <button type="button" class="btn-danger" onclick="removeReceiveLine(${index})" style="padding: 6px 10px; font-size: 14px;">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td colspan="5" style="text-align: right; padding: 12px;">TOTAL:</td>
                                <td style="text-align: right; padding: 12px;" id="receiveGrandTotal">$0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                    </div>
                    
                    <button type="button" class="btn btn-secondary" onclick="addReceiveLine()" style="margin-top: 15px; width: 100%;">
                        â• Add Item
                    </button>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Invoice Number (from supplier)</label>
                        <input type="text" id="receiveInvoiceNumber" placeholder="Enter actual invoice #" style="width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box;">
                    </div>
                    
                    <div class="form-group">
                        <label>Received Date</label>
                        <input type="date" id="receiveDate" value="${new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box;">
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="receiveNotes" rows="2" placeholder="Any discrepancies, damage, or special notes..." style="width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box;"></textarea>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalEditBtn').style.display = 'none';
            document.getElementById('modalPrintBtn').style.display = 'none';
            document.getElementById('modalSaveBtn').style.display = 'inline-block';
            document.getElementById('modalSaveBtn').textContent = 'âœ… Commit to Inventory';
            document.getElementById('modalSaveBtn').onclick = () => commitReceive(po.PO_ID);
            document.getElementById('orderModal').style.display = 'block'; document.body.classList.add('modal-open');
            
            // Calculate initial total
            setTimeout(() => {
                for (let i = 0; i < lines.length; i++) {
                    updateReceiveLine(i);
                }
            }, 100);
        }
        
        function removeReceiveLine(index) {
            const row = document.getElementById(`receiveLine${index}`);
            if (row) {
                row.remove();
                recalculateReceiveTotal();
            }
        }
        
        function addReceiveLine() {
            const tbody = document.getElementById('receiveItemsBody');
            const index = window.receiveLineCounter++;
            const supplierId = window.currentReceivePO.Supplier_ID;
            
            // Get items for this supplier
            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
            
            const row = document.createElement('tr');
            row.id = `receiveLine${index}`;
            row.dataset.isOriginal = 'false';
            row.innerHTML = `
                <td style="text-align: center; padding: 8px 4px;">
                    <input type="checkbox" id="receiveCheck${index}" checked onchange="updateReceiveLine(${index})" style="width: 20px; height: 20px;">
                </td>
                <td style="padding: 8px;">
                    <select id="receiveItem${index}" onchange="updateReceiveItemCost(${index})" style="width: 100%; padding: 8px; font-size: 14px; box-sizing: border-box;">
                        <option value="">Select item...</option>
                        ${supplierItems.map(item => `<option value="${item.Item_ID}" data-cost="${item.Package_Cost}">${item.Item_Description}</option>`).join('')}
                    </select>
                </td>
                <td style="text-align: center; padding: 8px 4px; color: #999;">N/A</td>
                <td style="padding: 8px 4px;">
                    <input type="number" 
                           id="receiveQty${index}" 
                           value="1" 
                           min="0" 
                           step="1"
                           data-item-id=""
                           data-ordered="0"
                           data-cost="0"
                           style="width: 100%; padding: 8px; font-size: 14px; text-align: center; box-sizing: border-box;"
                           oninput="updateReceiveLine(${index})">
                </td>
                <td style="text-align: right; padding: 8px 4px; font-size: 13px;" id="receiveCost${index}">$0.00</td>
                <td style="text-align: right; padding: 8px 4px; font-weight: bold;" id="receiveLineTotal${index}">$0.00</td>
                <td style="text-align: center; padding: 8px 4px;">
                    <button type="button" class="btn-danger" onclick="removeReceiveLine(${index})" style="padding: 6px 10px; font-size: 14px;">ğŸ—‘ï¸</button>
                </td>
            `;
            tbody.appendChild(row);
        }
        
        function updateReceiveItemCost(index) {
            const select = document.getElementById(`receiveItem${index}`);
            const qtyInput = document.getElementById(`receiveQty${index}`);
            const costTd = document.getElementById(`receiveCost${index}`);
            
            const selectedOption = select.options[select.selectedIndex];
            const cost = parseFloat(selectedOption.dataset.cost) || 0;
            
            qtyInput.dataset.itemId = select.value;
            qtyInput.dataset.cost = cost;
            costTd.textContent = '$' + cost.toFixed(2);
            
            updateReceiveLine(index);
        }
        
        function recalculateReceiveTotal() {
            let grandTotal = 0;
            document.querySelectorAll('[id^="receiveLineTotal"]').forEach(td => {
                const amount = parseFloat(td.textContent.replace('$', '')) || 0;
                grandTotal += amount;
            });
            const grandTotalEl = document.getElementById('receiveGrandTotal');
            if (grandTotalEl) {
                grandTotalEl.textContent = '$' + grandTotal.toFixed(2);
            }
        }
        
        function updateReceiveLine(index) {
            const checkbox = document.getElementById(`receiveCheck${index}`);
            const qtyInput = document.getElementById(`receiveQty${index}`);
            const lineTotal = document.getElementById(`receiveLineTotal${index}`);
            
            if (!checkbox || !qtyInput || !lineTotal) return;
            
            if (!checkbox.checked) {
                qtyInput.value = 0;
                qtyInput.disabled = true;
            } else {
                qtyInput.disabled = false;
            }
            
            const qty = parseFloat(qtyInput.value) || 0;
            const cost = parseFloat(qtyInput.dataset.cost) || 0;
            const total = qty * cost;
            
            lineTotal.textContent = '$' + total.toFixed(2);
            
            // Recalculate grand total
            recalculateReceiveTotal();
        }
        
        let isCommittingReceive = false; // Prevent double-click
        
        async function commitReceive(poId) {
            // Prevent double-click
            if (isCommittingReceive) {
                console.log('Already committing receive, ignoring duplicate click');
                return;
            }
            
            const invoiceNumber = document.getElementById('receiveInvoiceNumber').value;
            const receiveDate = document.getElementById('receiveDate').value;
            const notes = document.getElementById('receiveNotes').value;
            
            if (!invoiceNumber) {
                if (!confirm('No invoice number entered. Continue anyway?')) {
                    return;
                }
            }
            
            // Collect all receive lines (including added ones)
            const receivedLines = [];
            const rows = document.querySelectorAll('#receiveItemsBody tr');
            
            rows.forEach(row => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                const qtyInput = row.querySelector('input[type="number"]');
                
                if (checkbox && checkbox.checked && qtyInput) {
                    const qty = parseFloat(qtyInput.value) || 0;
                    const itemId = qtyInput.dataset.itemId;
                    const qtyOrdered = parseFloat(qtyInput.dataset.ordered) || 0;
                    const cost = parseFloat(qtyInput.dataset.cost) || 0;
                    
                    if (qty > 0 && itemId) {
                        receivedLines.push({
                            itemId: itemId,
                            qtyOrdered: qtyOrdered,
                            qtyReceived: qty,
                            unitCost: cost
                        });
                    }
                }
            });
            
            if (receivedLines.length === 0) {
                alert('Please select at least one item to receive');
                return;
            }
            
            // LOCK - Prevent double submit
            isCommittingReceive = true;
            
            // Disable the commit button
            const commitBtn = document.getElementById('modalSaveBtn');
            if (commitBtn) {
                commitBtn.disabled = true;
                commitBtn.textContent = 'â³ Processing...';
            }
            
            try {
                // Call API to convert OUTGOING to INCOMING
                const data = {
                    poId: poId,
                    invoiceNumber: invoiceNumber,
                    receiveDate: receiveDate,
                    notes: notes,
                    lines: receivedLines
                };
                
                const result = await apiCall('receiveOutgoingPO', data);
                
                if (result && result.status === 'success') {
                    alert('âœ… Items received successfully! Inventory has been updated.');
                    document.getElementById('orderModal').style.display = 'none';
                    
                    // Reload purchases and items
                    await loadPurchases();
                    await loadItems();
                } else {
                    alert('âŒ Error receiving items: ' + (result?.message || 'Unknown error'));
                }
            } finally {
                // UNLOCK
                isCommittingReceive = false;
                
                // Re-enable button
                if (commitBtn) {
                    commitBtn.disabled = false;
                    commitBtn.textContent = 'âœ… Commit to Inventory';
                }
            }
        }
        
        let isSavingOutgoingPO = false; // Prevent double-click
        
        async function saveOutgoingPO() {
            // Prevent double-click
            if (isSavingOutgoingPO) {
                console.log('Already saving PO, ignoring duplicate click');
                return;
            }
            
            const supplierId = document.getElementById('createPOSupplier').value;
            const poDate = document.getElementById('createPODate').value;
            const notes = document.getElementById('createPONotes')?.value;
            
            if (!supplierId || !poDate) {
                alert('Please select supplier and date');
                return;
            }
            
            // Get line items
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            const lineItems = [];
            
            rows.forEach(row => {
                const itemId = row.querySelector('.createpo-item').value;
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                const costDiv = row.querySelector('.createpo-cost');
                
                // Parse cost from text
                const costText = costDiv.textContent.replace('$', '');
                const cost = costText === '-' ? 0 : parseFloat(costText);
                
                if (itemId && qty > 0) {
                    lineItems.push({
                        itemId: itemId,
                        quantity: qty,
                        unitCost: cost
                    });
                }
            });
            
            if (lineItems.length === 0) {
                alert('Please add at least one line item');
                return;
            }
            
            // LOCK - Prevent double submit
            isSavingOutgoingPO = true;
            
            // Disable the button visually
            const saveBtn = document.querySelector('button[onclick="saveOutgoingPO()"]');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'â³ Saving...';
            }
            
            try {
                // Calculate total
                const total = lineItems.reduce((sum, item) => sum + (item.quantity * item.unitCost), 0);
            
            // AUTO-GENERATE PO NUMBER
            // Format: PO-MMDDYY-XXX (e.g., PO-120725-001)
            const dateObj = poDate ? new Date(poDate) : new Date();
            
            // Format date as MMDDYY
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const year = String(dateObj.getFullYear()).slice(-2); // Last 2 digits
            const dateStr = `${month}${day}${year}`;
            
            // Get all existing POs to find the next number for this date
            const existingPOs = await apiCall('getPurchaseOrders');
            let nextNumber = 1;
            
            if (existingPOs && existingPOs.data && existingPOs.data.length > 0) {
                // Find highest PO number for this date
                const prefix = `PO-${dateStr}-`;
                const todayPOs = existingPOs.data
                    .filter(po => po.Invoice_Number && po.Invoice_Number.startsWith(prefix))
                    .map(po => {
                        const parts = po.Invoice_Number.split('-');
                        return parseInt(parts[2]) || 0;
                    });
                
                if (todayPOs.length > 0) {
                    nextNumber = Math.max(...todayPOs) + 1;
                }
            }
            
            // Generate PO number: PO-120725-001
            const poNumber = `PO-${dateStr}-${String(nextNumber).padStart(3, '0')}`;
            
            // Create OUTGOING PO
            const data = {
                supplierId: supplierId,
                invoiceNumber: poNumber,
                purchaseDate: poDate,
                dueDate: null,
                paymentTerms: 'Net 30',
                status: 'Ordered', // OUTGOING status
                totalAmount: total,
                amountPaid: 0,
                notes: notes || '',
                lineItems: lineItems,  // Fixed: was 'lines', backend expects 'lineItems'
                poType: 'OUTGOING' // New field to distinguish
            };
            
            const result = await apiCall('createPurchaseOrder', data);
            
            if (result && result.status === 'success') {
                alert(`âœ… OUTGOING PO created successfully!\n\nPO Number: ${poNumber}\n\nItems marked as "On Order".`);
                clearCreatePOForm();
                
                // Refresh items to update Qty_On_Order
                await loadItems();
                
                // Ask if they want to print
                if (confirm('Would you like to print this PO?')) {
                    // Need to reload the PO we just created to print it
                    // For now, just tell them to go to Purchases tab
                    alert('Go to Purchases tab to view and print your OUTGOING PO');
                }
            } else {
                alert('âŒ Error creating OUTGOING PO: ' + (result?.message || 'Unknown error'));
            }
            } finally {
                // UNLOCK - Always reset even if error
                isSavingOutgoingPO = false;
                
                // Re-enable button
                const saveBtn = document.querySelector('button[onclick="saveOutgoingPO()"]');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'ğŸ’¾ Save as OUTGOING PO';
                }
            }
        }
        
        function generatePrintablePO() {
            const supplierId = document.getElementById('createPOSupplier').value;
            const poDate = document.getElementById('createPODate').value;
            
            if (!supplierId || !poDate) {
                alert('Please select supplier and date');
                return;
            }
            
            // Get line items
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            const lineItems = [];
            
            rows.forEach(row => {
                const itemId = row.querySelector('.createpo-item').value;
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                const costDiv = row.querySelector('.createpo-cost');
                const unitsDiv = row.querySelector('.createpo-units');
                const totalUnitsDiv = row.querySelector('.createpo-totalunits');
                
                // Parse cost from text
                const costText = costDiv.textContent.replace('$', '');
                const cost = costText === '-' ? 0 : parseFloat(costText);
                
                // Parse units from text
                const unitsText = unitsDiv.textContent;
                const unitsPerCase = unitsText === '-' ? 0 : parseFloat(unitsText);
                
                // Parse total units from text
                const totalUnitsText = totalUnitsDiv.textContent;
                const totalUnits = totalUnitsText === '-' ? 0 : parseFloat(totalUnitsText);
                
                if (itemId && qty > 0) {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    if (item) {
                        lineItems.push({
                            sku: item.SKU || item.Item_ID,
                            description: item.Item_Description,
                            qty: qty,
                            unitsPerCase: unitsPerCase,
                            totalUnits: totalUnits,
                            cost: cost,
                            total: qty * cost
                        });
                    }
                }
            });
            
            if (lineItems.length === 0) {
                alert('Please add at least one line item');
                return;
            }
            
            // Get supplier info
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            if (!supplier) {
                alert('Supplier not found');
                return;
            }
            
            // Get invoice settings - USE THE SAME METHOD AS SALES INVOICES
            const settings = getInvoiceSettings();
            const companyName = settings.companyName;
            const companyContactName = settings.contactName;
            const companyPhone = settings.phone;
            const companyEmail = settings.email;
            const companyAddress1 = settings.address1;
            const companyAddress2 = settings.address2;
            const companyCityStateZip = settings.cityStateZip;
            
            const total = lineItems.reduce((sum, item) => sum + item.total, 0);
            
            // Generate printable HTML
            let html = `
                <style>
                    @media print {
                        body * { visibility: hidden; }
                        #printablePO, #printablePO * { visibility: visible; }
                        #printablePO { position: absolute; left: 0; top: 0; width: 100%; }
                        button { display: none !important; }
                    }
                    .po-header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #667eea; padding-bottom: 20px; }
                    .po-info { display: flex; justify-content: space-between; margin-bottom: 30px; }
                    .po-box { flex: 1; }
                    .po-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    .po-table th { background: #667eea; color: white; padding: 12px; text-align: left; }
                    .po-table td { border: 1px solid #ddd; padding: 10px; }
                    .po-total { text-align: right; font-size: 20px; font-weight: bold; margin-top: 20px; }
                </style>
                
                <div class="po-header">
                    <h1 style="color: #667eea; margin: 0;">PURCHASE ORDER</h1>
                    <p style="font-size: 16pt; margin: 5px 0;">${companyName}</p>
                    <p style="margin: 5px 0;">Date: ${new Date(poDate).toLocaleDateString()}</p>
                </div>
                
                <div class="po-info">
                    <div class="po-box">
                        <h3>From:</h3>
                        <p><strong>${companyName}</strong></p>
                        ${companyContactName ? `<p>${companyContactName}</p>` : ''}
                        <p>${companyAddress1}</p>
                        ${companyAddress2 ? `<p>${companyAddress2}</p>` : ''}
                        <p>${companyCityStateZip}</p>
                        <p>Phone: ${companyPhone}</p>
                        <p>Email: ${companyEmail}</p>
                    </div>
                    <div class="po-box">
                        <h3>To:</h3>
                        <p><strong>${supplier.Supplier_Name}</strong></p>
                        ${supplier.Address ? `<p>${supplier.Address}</p>` : ''}
                        ${supplier.City || supplier.State || supplier.ZIP ? `<p>${supplier.City || ''}${supplier.City && supplier.State ? ', ' : ''}${supplier.State || ''} ${supplier.ZIP || ''}</p>` : ''}
                        ${supplier.Phone ? `<p>Phone: ${supplier.Phone}</p>` : ''}
                        ${supplier.Email ? `<p>Email: ${supplier.Email}</p>` : ''}
                    </div>
                </div>
                
                <table class="po-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Description</th>
                            <th style="text-align: center;">Cases</th>
                            <th style="text-align: center;">Units/Case</th>
                            <th style="text-align: center;">Total Units</th>
                            <th style="text-align: right;">Cost/Case</th>
                            <th style="text-align: right;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            lineItems.forEach(item => {
                html += `
                    <tr>
                        <td>${item.sku}</td>
                        <td>${item.description}</td>
                        <td style="text-align: center;">${item.qty}</td>
                        <td style="text-align: center;">${item.unitsPerCase}</td>
                        <td style="text-align: center;"><strong>${item.totalUnits}</strong></td>
                        <td style="text-align: right;">$${item.cost.toFixed(2)}</td>
                        <td style="text-align: right;">$${item.total.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <div class="po-total">
                    <p>TOTAL: $${total.toFixed(2)}</p>
                </div>
                
                <div style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <p style="color: #666; font-size: 14px;">
                        Please confirm receipt of this purchase order and provide expected delivery date.
                    </p>
                </div>
            `;
            
            // Display printable PO
            document.getElementById('printablePO').innerHTML = html;
            document.getElementById('printablePOContainer').style.display = 'block';
            document.getElementById('createPOForm').style.display = 'none';
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
        
        function closePrintablePO() {
            document.getElementById('printablePOContainer').style.display = 'none';
            document.getElementById('createPOForm').style.display = 'block';
        }
        
        function downloadPOAsPDF() {
            // Get PO details
            const supplierId = document.getElementById('createPOSupplier').value;
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            const poDate = document.getElementById('createPODate').value;
            
            if (!supplier) {
                alert('Supplier not found');
                return;
            }
            
            // Create a clean filename
            const fileName = `PO_${supplier.Supplier_Name.replace(/[^a-z0-9]/gi, '_')}_${poDate}.pdf`;
            
            // For now, trigger print dialog with instruction
            alert('PDF Download:\n\n1. Click OK\n2. In the print dialog, select "Save as PDF"\n3. Click Save\n\nNote: Full automated PDF generation requires a backend service.');
            window.print();
        }
        
        function emailPO() {
            // Get supplier email
            const supplierId = document.getElementById('createPOSupplier').value;
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            const poDate = document.getElementById('createPODate').value;
            
            if (!supplier) {
                alert('Supplier not found');
                return;
            }
            
            const supplierEmail = supplier.Email || '';
            
            if (!supplierEmail) {
                alert('No email address found for ' + supplier.Supplier_Name + '. Please add an email address to the supplier record first.');
                return;
            }
            
            // Get company info - USE THE SAME METHOD AS SALES INVOICES
            const settings = getInvoiceSettings();
            const companyName = settings.companyName;
            
            // Get line items for email body
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            let itemsList = '';
            rows.forEach(row => {
                const itemId = row.querySelector('.createpo-item').value;
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                if (itemId && qty > 0) {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    if (item) {
                        itemsList += `â€¢ ${item.Item_Description} - ${qty} cases\n`;
                    }
                }
            });
            
            const totalCases = document.getElementById('createPOTotalCases').textContent;
            const totalCost = document.getElementById('createPOTotal').textContent;
            
            // Create email subject and body
            const subject = `Purchase Order from ${companyName} - ${poDate}`;
            const body = `Dear ${supplier.Supplier_Name},

Please find our purchase order for ${poDate}:

${itemsList}
---
Total Cases: ${totalCases}
Total: ${totalCost}

Please confirm receipt and expected delivery date.

Best regards,
${companyName}

---
NOTE: Please print the attached PO document for full details.`;
            
            // Create mailto link
            const mailtoLink = `mailto:${supplierEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Inform user to attach the PO
            alert('Email Instructions:\n\n1. Your email client will open with the supplier\'s email pre-filled\n2. IMPORTANT: Print or save this PO as PDF first (use Print button)\n3. Attach the PDF to the email before sending\n\nClick OK to open your email client.');
            
            // Open email client
            window.location.href = mailtoLink;
        }
        
        function clearCreatePOForm() {
            document.getElementById('createPOSupplier').value = '';
            document.getElementById('createPODate').value = new Date().toISOString().split('T')[0];
            
            // Clear all line items except the first one
            const container = document.getElementById('createPOLineItems');
            const rows = container.querySelectorAll('.line-item-row');
            rows.forEach((row, index) => {
                if (index === 0) {
                    row.querySelector('.createpo-item').value = '';
                    row.querySelector('.createpo-qty').value = '';
                    row.querySelector('.createpo-units').textContent = '-';
                    row.querySelector('.createpo-totalunits').textContent = '-';
                    row.querySelector('.createpo-cost').textContent = '-';
                    row.querySelector('.createpo-linetotal').textContent = '$0.00';
                } else {
                    row.remove();
                }
            });
            
            calculateCreatePOTotal();
        }
        
        // ===== ITEM PICKER FUNCTIONS (must be here so inline handlers work) =====
        window.itemPickerItems = window.itemPickerItems || [];
        window.itemPickerIsFilter = false;
        window.itemPickerCallback = null;
        window.itemPickerSupplierContext = ''; // Stores supplier context for PO mode
        
        // Define globally immediately so inline handlers can find it
        window.filterItemPicker = function() {
            window.renderItemPickerList();
        };
        
        window.renderItemPickerList = function() {
            const searchEl = document.getElementById('itemPickerSearch');
            const supplierEl = document.getElementById('itemPickerSupplier');
            const listContainer = document.getElementById('itemPickerList');
            
            if (!listContainer) return;
            
            const search = searchEl ? searchEl.value.toLowerCase().trim() : '';
            // Use global context if select is empty (for PO mode where select is hidden)
            const supplier = (supplierEl && supplierEl.value) ? supplierEl.value : (window.itemPickerSupplierContext || '');
            
            const isFilterInput = window.itemPickerIsFilter;
            
            let filtered = (window.itemPickerItems || []).filter(item => {
                // Search filter - check SKU and Description (convert to string first!)
                const sku = String(item.SKU || '').toLowerCase();
                const desc = String(item.Item_Description || '').toLowerCase();
                const matchesSearch = !search || sku.includes(search) || desc.includes(search);
                
                // Supplier filter (convert both to string for comparison)
                const matchesSupplier = !supplier || String(item.Supplier_ID) === String(supplier);
                
                // Hide archived items UNLESS this is a filter input
                const isArchived = item.Status === 'Archived';
                const matchesActive = isFilterInput || !isArchived;
                
                return matchesSearch && matchesSupplier && matchesActive;
            });
            
            let html = '';
            
            // Add "Clear Filter" option for filter text inputs
            if (isFilterInput && !search && !supplier) {
                html += `
                    <div class="item-picker-card" onclick="clearItemFilter()" style="border-left: 4px solid #6c757d; background: #f8f9fa;">
                        <div class="item-picker-desc" style="font-weight: bold; color: #495057;">
                            <span style="font-size: 18px; margin-right: 8px;">ğŸ“‹</span> Clear Filter
                        </div>
                        <div style="font-size: 12px; color: #6c757d;">Remove item filter and show all items</div>
                    </div>
                `;
            }
            
            if (filtered.length === 0) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon">ğŸ“¦</div>
                        <div>No items found</div>
                        <div style="font-size: 14px; margin-top: 5px;">Try a different search term</div>
                    </div>
                `;
                return;
            }
            
            filtered.forEach(item => {
                const qty = parseInt(item.Qty_On_Hand) || 0;
                const reorder = parseInt(item.Reorder_Point) || 0;
                const sellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const pkgCost = parseFloat(item.Package_Cost) || 0;
                const unitsPer = parseInt(item.Units_Per_Package) || 1;
                const unitCost = pkgCost / unitsPer;
                
                let stockClass = 'in-stock';
                let stockText = `${qty} in stock`;
                if (qty <= 0) {
                    stockClass = 'out-of-stock';
                    stockText = 'Out of stock';
                } else if (qty <= reorder) {
                    stockClass = 'low-stock';
                    stockText = `Low: ${qty}`;
                }
                
                const supplierName = (cachedSuppliers || []).find(s => s.Supplier_ID === item.Supplier_ID)?.Supplier_Name || 'Unknown';
                
                html += `
                    <div class="item-picker-card" onclick="selectItemFromPicker('${item.Item_ID}')">
                        <div class="item-picker-header-row">
                            <span class="item-picker-sku">${item.SKU || ''}</span>
                            <span class="item-picker-stock ${stockClass}">${stockText}</span>
                        </div>
                        <div class="item-picker-desc">${item.Item_Description || ''}</div>
                        <div class="item-picker-details">
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Unit Cost</span>
                                <span class="item-picker-detail-value">$${unitCost.toFixed(2)}</span>
                            </div>
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Sell Price</span>
                                <span class="item-picker-detail-value item-picker-price">$${sellPrice.toFixed(2)}</span>
                            </div>
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Pkg</span>
                                <span class="item-picker-detail-value">${unitsPer}/${item.Purchase_UOM || 'Case'}</span>
                            </div>
                        </div>
                        <div class="item-picker-supplier">ğŸ“¦ ${supplierName}</div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        };
    </script>
    
    <!-- Order View/Edit Modal -->
    <div id="orderModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto; padding: 20px 0;">
        <div style="background: white; margin: 0 auto; max-width: 900px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: calc(100vh - 40px); display: flex; flex-direction: column;">
            <div id="orderModalHeader" style="background: var(--primary, #667eea); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <h2 id="modalTitle" style="margin: 0;">Order Details</h2>
                <button onclick="closeOrderModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <div id="modalContent" style="padding: 30px; overflow-y: auto; flex: 1;">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div id="modalFooter" style="padding: 20px 30px; border-top: 1px solid #ddd; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeOrderModal()">Close</button>
                <button id="modalPrintBtn" class="btn" onclick="printInvoice()" style="display: none;">ğŸ–¨ï¸ Print Invoice</button>
                <button id="modalEditBtn" class="btn" onclick="enableEditMode()" style="display: none;">âœï¸ Edit Order</button>
                <button id="modalSaveBtn" class="btn" onclick="if(event && debounceButton(event.currentTarget)) saveOrderChanges()" style="display: none;">ğŸ’¾ Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Report Setup Modal -->
    <div id="reportSetupModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto; padding: 20px 0;">
        <div style="background: white; margin: 0 auto; max-width: 95%; width: 900px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: calc(100vh - 40px); display: flex; flex-direction: column; position: relative;">
            <div id="reportSetupHeader" style="background: var(--primary, #667eea); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <h2 id="reportSetupTitle" style="margin: 0;">ğŸ“Š Report Setup</h2>
                <button onclick="closeReportSetup()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <div id="reportSetupFilters" style="padding: 20px; background: #f8f9fa; border-bottom: 1px solid #ddd; flex-shrink: 0;">
                <!-- Filters will be populated by JavaScript -->
            </div>
            <div id="reportSetupContent" style="padding: 20px; flex: 1; overflow-y: auto;">
                <div style="text-align: center; padding: 40px; color: #888;">
                    <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“‹</div>
                    <p>Configure filters above and click <strong>Run Report</strong></p>
                </div>
            </div>
            <div style="padding: 15px 20px; border-top: 1px solid #ddd; display: flex; gap: 10px; justify-content: space-between; flex-shrink: 0; background: #f8f9fa; border-radius: 0 0 12px 12px; flex-wrap: wrap;">
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="printReport()" title="Print Report (or Save as PDF)">ğŸ–¨ï¸ Print</button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="closeReportSetup()">Cancel</button>
                    <button class="btn" onclick="executeReport()" id="runReportBtn">â–¶ï¸ Run Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile-Friendly Item Picker Modal -->
    <div id="itemPickerModal" class="item-picker-overlay">
        <div class="item-picker-container">
            <div class="item-picker-header">
                <h3>ğŸ“¦ Select Item</h3>
                <button class="item-picker-close" onclick="closeItemPicker()">&times;</button>
            </div>
            <div class="item-picker-search">
                <input type="text" id="itemPickerSearch" placeholder="ğŸ” Search by SKU or description..." oninput="window.filterItemPicker()" onkeyup="window.filterItemPicker()">
            </div>
            <div id="itemPickerSupplierFilter" class="item-picker-filter">
                <select id="itemPickerSupplier" onchange="window.filterItemPicker()">
                    <option value="">All Suppliers</option>
                </select>
            </div>
            <div id="itemPickerList" class="item-picker-list">
                <!-- Items will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- SUPPLIER PICKER MODAL -->
    <div id="supplierPickerModal" class="item-picker-overlay">
        <div class="item-picker-container">
            <div class="item-picker-header">
                <h3>ğŸ­ Select Supplier</h3>
                <button class="item-picker-close" onclick="closeSupplierPicker()">&times;</button>
            </div>
            <div class="item-picker-search">
                <input type="text" id="supplierPickerSearch" placeholder="ğŸ” Search suppliers..." oninput="filterSupplierPicker()" onkeyup="filterSupplierPicker()">
            </div>
            <div id="supplierPickerList" class="item-picker-list">
                <!-- Suppliers will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- CUSTOMER PICKER MODAL -->
    <div id="customerPickerModal" class="item-picker-overlay">
        <div class="item-picker-container">
            <div class="item-picker-header">
                <h3>ğŸ‘¤ Select Customer</h3>
                <button class="item-picker-close" onclick="closeCustomerPicker()">&times;</button>
            </div>
            <div class="item-picker-search">
                <input type="text" id="customerPickerSearch" placeholder="ğŸ” Search customers..." oninput="filterCustomerPicker()" onkeyup="filterCustomerPicker()">
            </div>
            <div id="customerPickerList" class="item-picker-list">
                <!-- Customers will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- REASON PICKER MODAL -->
    <div id="reasonPickerModal" class="item-picker-overlay">
        <div class="item-picker-container" style="max-width: 500px; height: auto; max-height: 80vh; margin: 10vh auto; border-radius: 16px;">
            <div class="item-picker-header" style="border-radius: 16px 16px 0 0;">
                <h3>ğŸ“ Select Reason</h3>
                <button class="item-picker-close" onclick="closeReasonPicker()">&times;</button>
            </div>
            <div id="reasonPickerList" class="item-picker-list" style="padding: 15px;">
                <!-- Reason options will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- UOM PICKER MODAL -->
    <div id="uomPickerModal" class="item-picker-overlay">
        <div class="item-picker-container" style="max-width: 500px; height: auto; max-height: 80vh; margin: 10vh auto; border-radius: 16px;">
            <div class="item-picker-header" style="border-radius: 16px 16px 0 0;">
                <h3>ğŸ“¦ Select Unit of Measure</h3>
                <button class="item-picker-close" onclick="closeUOMPicker()">&times;</button>
            </div>
            <div id="uomPickerList" class="item-picker-list" style="padding: 15px;">
                <!-- UOM options will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- THEME PICKER MODAL -->
    <div id="themePickerModal" class="item-picker-overlay">
        <div class="item-picker-container" style="max-width: 700px; height: 85vh; margin: 5vh auto; border-radius: 16px;">
            <div class="item-picker-header" style="border-radius: 16px 16px 0 0; background: var(--primary, #667eea);">
                <h3>ğŸ¨ Choose Your Theme</h3>
                <button class="item-picker-close" onclick="closeThemePicker()">&times;</button>
            </div>
            <div class="item-picker-search" style="padding: 15px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">
                <input type="text" id="themePickerSearch" placeholder="ğŸ” Search themes... (e.g. 'packers', 'blue', 'nfl')" oninput="filterThemePicker()" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px;">
            </div>
            <div id="themePickerList" class="item-picker-list" style="padding: 15px; height: calc(85vh - 140px); overflow-y: auto;">
                <!-- Theme options will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- STATUS PICKER MODAL -->
    <div id="statusPickerModal" class="item-picker-overlay">
        <div class="item-picker-container" style="max-width: 500px; height: auto; max-height: 80vh; margin: 10vh auto; border-radius: 16px;">
            <div class="item-picker-header" id="statusPickerHeader" style="border-radius: 16px 16px 0 0;">
                <h3 id="statusPickerTitle">ğŸ“‹ Select Status</h3>
                <button class="item-picker-close" onclick="closeStatusPicker()">&times;</button>
            </div>
            <div id="statusPickerList" class="item-picker-list" style="padding: 15px;">
                <!-- Status options will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- PO PICKER MODAL -->
    <div id="poPickerModal" class="item-picker-overlay">
        <div class="item-picker-container">
            <div class="item-picker-header">
                <h3>ğŸ“‹ Select Purchase Order</h3>
                <button class="item-picker-close" onclick="closePOPicker()">&times;</button>
            </div>
            <div class="item-picker-search">
                <input type="text" id="poPickerSearch" placeholder="ğŸ” Search by PO number..." oninput="filterPOPicker()" onkeyup="filterPOPicker()">
            </div>
            <div id="poPickerList" class="item-picker-list">
                <!-- POs will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- INVOICE PICKER MODAL -->
    <div id="invoicePickerModal" class="item-picker-overlay">
        <div class="item-picker-container">
            <div class="item-picker-header">
                <h3>ğŸ§¾ Select Invoice</h3>
                <button class="item-picker-close" onclick="closeInvoicePicker()">&times;</button>
            </div>
            <div class="item-picker-search">
                <input type="text" id="invoicePickerSearch" placeholder="ğŸ” Search by invoice number..." oninput="filterInvoicePicker()" onkeyup="filterInvoicePicker()">
            </div>
            <div id="invoicePickerList" class="item-picker-list">
                <!-- Invoices will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- ITEM PICKER MODAL (for reports) -->
    <!-- PO TYPE PICKER MODAL -->
    <div id="poTypePickerModal" class="item-picker-overlay">
        <div class="item-picker-container" style="max-width: 400px;">
            <div class="item-picker-header">
                <h3>ğŸ“¦ Select PO Type</h3>
                <button class="item-picker-close" onclick="closePOTypePicker()">&times;</button>
            </div>
            <div id="poTypePickerList" class="item-picker-list" style="padding: 15px;">
                <div class="item-picker-card" onclick="selectPOType('', 'All Types')" style="border-left: 4px solid #6c757d; background: #f8f9fa; margin-bottom: 10px;">
                    <div class="item-picker-desc" style="font-weight: bold; color: #495057;">
                        <span style="font-size: 24px; margin-right: 12px;">ğŸ“‹</span> All Types
                    </div>
                    <div style="font-size: 13px; color: #6c757d; margin-top: 5px;">Show both inbound and outbound POs</div>
                </div>
                <div class="item-picker-card" onclick="selectPOType('INCOMING', 'Incoming (Purchases)')" style="border-left: 4px solid #28a745; background: #e8f5e9; margin-bottom: 10px;">
                    <div class="item-picker-desc" style="font-weight: bold; color: #2e7d32;">
                        <span style="font-size: 24px; margin-right: 12px;">ğŸ“¥</span> Incoming (Purchases)
                    </div>
                    <div style="font-size: 13px; color: #388e3c; margin-top: 5px;">Products received from suppliers</div>
                </div>
                <div class="item-picker-card" onclick="selectPOType('OUTGOING', 'Outgoing (Returns/Transfers)')" style="border-left: 4px solid #1976d2; background: #e3f2fd; margin-bottom: 10px;">
                    <div class="item-picker-desc" style="font-weight: bold; color: #1565c0;">
                        <span style="font-size: 24px; margin-right: 12px;">ğŸ“¤</span> Outgoing (Returns/Transfers)
                    </div>
                    <div style="font-size: 13px; color: #1976d2; margin-top: 5px;">Products sent back to suppliers or transferred out</div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Mobile-Friendly Item Picker Styles */
        .item-picker-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 20000;
            padding: 0;
        }
        
        .item-picker-container {
            background: #f5f5f5;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            max-width: 600px;
            margin: 0 auto;
        }
        
        @media (min-width: 768px) {
            .item-picker-container {
                margin: 40px auto;
                height: calc(100% - 80px);
                border-radius: 16px;
                overflow: hidden;
            }
        }
        
        .item-picker-header {
            background: var(--primary, #667eea);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .item-picker-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .item-picker-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 28px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .item-picker-search {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
        }
        
        .item-picker-search input {
            width: 100%;
            padding: 15px 20px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 12px;
            outline: none;
        }
        
        .item-picker-search input:focus {
            border-color: var(--primary, #667eea);
        }
        
        .item-picker-filter {
            padding: 10px 15px;
            background: white;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
        }
        
        .item-picker-filter select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        
        .item-picker-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            -webkit-overflow-scrolling: touch;
        }
        
        .item-picker-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            border: 2px solid transparent;
            border-left: 4px solid #c0c0c0;
        }
        
        .item-picker-card:hover,
        .item-picker-card:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            border-color: #999;
        }
        
        .item-picker-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .item-picker-sku {
            background: #f0f0f0;
            color: #555;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
        }
        
        .item-picker-stock {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
        }
        
        .item-picker-stock.in-stock {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .item-picker-stock.low-stock {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .item-picker-stock.out-stock {
            background: #ffebee;
            color: #c62828;
        }
        
        .item-picker-desc {
            font-size: 17px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .item-picker-details {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .item-picker-detail {
            display: flex;
            flex-direction: column;
        }
        
        .item-picker-detail-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
        }
        
        .item-picker-detail-value {
            font-weight: bold;
            color: #333;
        }
        
        .item-picker-price {
            color: #2e7d32 !important;
            font-size: 18px !important;
        }
        
        .item-picker-supplier {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }
        
        .item-picker-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .item-picker-empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        /* Supplier card specific styling */
        .supplier-card:hover,
        .supplier-card:active {
            border-color: #999 !important;
        }
        
        /* Customer card specific styling */
        .customer-card:hover,
        .customer-card:active {
            border-color: #999 !important;
        }
        
        /* Make ALL select elements more tappable on mobile */
        @media (max-width: 768px) {
            select {
                min-height: 48px;
                font-size: 16px !important;
                padding: 12px !important;
            }
            
            #poSupplier, #soCustomer, #editPOSupplier, #editSOCustomer {
                background: linear-gradient(to right, #f8f9fa, #ffffff);
                border: 2px solid #ddd;
                border-radius: 8px;
                cursor: pointer;
            }
        }
        
        /* Make select elements more tappable on mobile */
        .po-item, .so-item, .createpo-item, .edit-item {
            min-height: 44px;
            font-size: 16px !important;
        }
        
        /* ========== MOBILE MODAL FIXES ========== */
        
        /* When any modal is open, prevent body scrolling */
        body.modal-open {
            overflow: hidden !important;
            position: fixed !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Base modal overlay styles - lock in place */
        #reportSetupModal,
        #orderModal,
        #itemPickerModal,
        #supplierPickerModal,
        #customerPickerModal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100% !important;
            height: 100% !important;
            overflow: hidden !important; /* Don't scroll the overlay itself */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Z-index hierarchy - detail modals above report modals */
        #reportSetupModal { z-index: 10000 !important; }
        #orderModal { z-index: 10500 !important; } /* Higher so it appears above reports */
        #itemPickerModal,
        #supplierPickerModal,
        #customerPickerModal { z-index: 11000 !important; } /* Picker modals highest */
        
        /* Modal content container - this is what scrolls */
        #reportSetupModal > div,
        #orderModal > div {
            position: relative;
            max-height: 100vh !important;
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Mobile-specific modal fixes */
        @media (max-width: 768px) {
            #reportSetupModal > div,
            #orderModal > div {
                margin: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                border-radius: 0 !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            /* Headers don't shrink */
            #orderModalHeader,
            #reportSetupModal > div > div:first-child {
                flex-shrink: 0 !important;
            }
            
            /* Footers don't shrink */
            #modalFooter,
            #reportSetupModal > div > div:last-child {
                flex-shrink: 0 !important;
            }
            
            /* Filters don't shrink */
            #reportSetupFilters {
                flex-shrink: 0 !important;
            }
            
            /* Report content area - scrollable */
            #reportSetupContent {
                flex: 1 !important;
                overflow-y: auto !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
                min-height: 0 !important; /* Important for flex scrolling */
            }
            
            /* Order modal content */
            #modalContent {
                flex: 1 !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch;
                min-height: 0 !important;
                max-height: none !important; /* Override inline style */
            }
        }
        
        /* Landscape mode specific fixes */
        @media (max-height: 500px) and (orientation: landscape) {
            /* Make modal overlay fill screen */
            #reportSetupModal,
            #orderModal {
                padding: 0 !important;
                overflow: hidden !important;
            }
            
            /* Make inner container fullscreen */
            #reportSetupModal > div,
            #orderModal > div {
                margin: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
                height: 100vh !important;
                height: 100dvh !important; /* Dynamic viewport height for mobile */
                max-height: 100vh !important;
                max-height: 100dvh !important;
                border-radius: 0 !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            /* Compact header in landscape - DEBUG: red background */
            #reportSetupModal > div > div:first-child,
            #orderModal > div > div:first-child,
            #orderModalHeader {
                padding: 5px 10px !important;
                flex-shrink: 0 !important;
                min-height: 30px !important;
                max-height: 40px !important;
            }
            
            #reportSetupModal > div > div:first-child h2,
            #orderModal > div > div:first-child h2 {
                font-size: 14px !important;
            }
            
            /* HIDE filters in landscape to save space */
            #reportSetupFilters {
                display: none !important;
            }
            
            /* Content area takes remaining space */
            #reportSetupContent {
                flex: 1 1 auto !important;
                min-height: 100px !important; /* Force minimum height */
                padding: 5px !important;
                overflow: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            #modalContent {
                flex: 1 1 auto !important;
                min-height: 100px !important;
                padding: 5px !important;
                overflow: auto !important;
                -webkit-overflow-scrolling: touch !important;
                max-height: none !important;
            }
            
            /* Compact footer - DEBUG: blue background */
            #reportSetupModal > div > div:last-child {
                padding: 5px 10px !important;
                flex-shrink: 0 !important;
                min-height: 35px !important;
                max-height: 45px !important;
            }
            
            #reportSetupModal > div > div:last-child .btn {
                padding: 4px 10px !important;
                font-size: 12px !important;
            }
            
            /* Order modal footer */
            #modalFooter {
                padding: 5px 10px !important;
                flex-shrink: 0 !important;
                min-height: 35px !important;
                max-height: 45px !important;
            }
            
            #modalFooter .btn {
                padding: 4px 10px !important;
                font-size: 12px !important;
            }
        }
        
        /* Table horizontal scroll fix for reports */
        #reportSetupContent table {
            min-width: 500px; /* Force horizontal scroll on narrow screens */
        }
        
        #reportSetupContent .data-table {
            font-size: 13px;
        }
        
        /* Wrapper for horizontal table scrolling */
        #reportSetupContent > div[style*="overflow-x"] {
            max-width: 100%;
            overflow-x: auto !important;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (max-width: 768px) {
            #reportSetupContent .data-table {
                font-size: 12px;
            }
            
            #reportSetupContent .data-table th,
            #reportSetupContent .data-table td {
                padding: 8px 6px;
                white-space: nowrap;
            }
        }
        
        @media (max-height: 500px) and (orientation: landscape) {
            #reportSetupContent .data-table {
                font-size: 11px;
            }
            
            #reportSetupContent .data-table th,
            #reportSetupContent .data-table td {
                padding: 5px 4px;
            }
            
            #reportSetupContent h3 {
                font-size: 14px !important;
                margin: 0 0 5px 0 !important;
            }
            
            #reportSetupContent p {
                font-size: 11px !important;
                margin-bottom: 8px !important;
            }
        }
    </style>

    <script>
        // ==================== MOBILE ITEM PICKER ====================
        
        // itemPickerCallback declared in earlier script block
        let itemPickerSupplierFilter = '';
        
        // Bind search event properly when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Item picker - use window. since function is in different script block
            const searchInput = document.getElementById('itemPickerSearch');
            if (searchInput) {
                searchInput.addEventListener('input', window.filterItemPicker);
                searchInput.addEventListener('keyup', window.filterItemPicker);
            }
            const supplierFilter = document.getElementById('itemPickerSupplier');
            if (supplierFilter) {
                supplierFilter.addEventListener('change', window.filterItemPicker);
            }
            
            // Supplier picker
            const supplierSearchInput = document.getElementById('supplierPickerSearch');
            if (supplierSearchInput) {
                supplierSearchInput.addEventListener('input', filterSupplierPicker);
                supplierSearchInput.addEventListener('keyup', filterSupplierPicker);
            }
            
            // Customer picker
            const customerSearchInput = document.getElementById('customerPickerSearch');
            if (customerSearchInput) {
                customerSearchInput.addEventListener('input', filterCustomerPicker);
                customerSearchInput.addEventListener('keyup', filterCustomerPicker);
            }
        });
        
        function openItemPicker(selectElement, preSelectedSupplierId = null) {
            // Store callback to set value when item is selected
            window.itemPickerCallback = selectElement;
            
            // Reset filter mode flag
            window.itemPickerIsFilter = false;
            
            // Check if we're in a context where supplier is already selected (PO forms)
            let supplierContext = preSelectedSupplierId;
            let isSalesContext = false;
            
            if (!supplierContext) {
                // Try to detect from Create PO form
                const createPOSupplier = document.getElementById('createPOSupplier');
                if (createPOSupplier && createPOSupplier.value) {
                    supplierContext = createPOSupplier.value;
                }
                // Try to detect from Purchase form 
                const purchaseSupplier = document.getElementById('newPurchaseSupplier');
                if (purchaseSupplier && purchaseSupplier.value) {
                    supplierContext = purchaseSupplier.value;
                }
            }
            
            // Only check for Sales context if we DON'T have a supplier context
            // This prevents false detection when both forms might exist in DOM
            if (!supplierContext) {
                const saleCustomer = document.getElementById('newSaleCustomer');
                const editSOCustomer = document.getElementById('editSOCustomer');
                if ((saleCustomer && saleCustomer.value) || (editSOCustomer && editSOCustomer.value)) {
                    isSalesContext = true;
                }
            }
            
            const supplierFilterDiv = document.getElementById('itemPickerSupplierFilter');
            const supplierSelect = document.getElementById('itemPickerSupplier');
            
            if (isSalesContext) {
                // SALES MODE: Hide supplier filter - show ALL items from all suppliers
                supplierFilterDiv.style.display = 'none';
                supplierSelect.value = ''; // No supplier filter
                window.itemPickerSupplierContext = ''; // Store globally
            } else if (supplierContext) {
                // PO MODE with supplier selected: Hide filter, only show that supplier's items
                supplierFilterDiv.style.display = 'none';
                supplierSelect.value = supplierContext;
                window.itemPickerSupplierContext = supplierContext; // Store globally
            } else {
                // OTHER MODE: Show supplier filter dropdown
                supplierFilterDiv.style.display = 'block';
                supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
                if (cachedSuppliers && cachedSuppliers.length > 0) {
                    cachedSuppliers.forEach(s => {
                        supplierSelect.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                    });
                }
                supplierSelect.value = '';
                window.itemPickerSupplierContext = ''; // No preset context
            }
            
            // Get items from cache
            window.itemPickerItems = [];
            if (cachedItems && cachedItems.length > 0) {
                window.itemPickerItems = cachedItems;
            }
            
            // Clear search
            document.getElementById('itemPickerSearch').value = '';
            
            // Render items
            renderItemPickerList();
            
            // Show modal
            document.getElementById('itemPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Focus search after a moment
            setTimeout(() => {
                document.getElementById('itemPickerSearch').focus();
            }, 100);
        }
        
        function closeItemPicker() {
            document.getElementById('itemPickerModal').style.display = 'none';
            window.itemPickerCallback = null;
            
            // Only remove modal-open if no other modals are open
            const reportModal = document.getElementById('reportSetupModal');
            const orderModal = document.getElementById('orderModal');
            const hasOpenModal = (reportModal && reportModal.style.display !== 'none') || 
                                 (orderModal && orderModal.style.display !== 'none');
            if (!hasOpenModal) {
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
            }
        }
        
        function selectItemFromPicker(itemId) {
            if (window.itemPickerCallback) {
                // Check if this is for inventory adjustment form
                if (window.itemPickerCallback.tagName === 'ADJUSTMENT_FORM') {
                    document.getElementById('adjustItem').value = itemId;
                    const item = (cachedItems || []).find(i => i.Item_ID === itemId);
                    if (item) {
                        document.getElementById('adjustItemDisplay').value = `${item.SKU} - ${item.Item_Description}`;
                        document.getElementById('adjustCurrentQty').value = parseInt(item.Qty_On_Hand) || 0;
                        updateAdjustNewQty();
                    }
                    window.adjustmentPickerActive = false;
                    closeItemPicker();
                    return;
                }
                
                // Check if this is a filter text input or a select element
                const isTextInput = window.itemPickerCallback.tagName === 'INPUT' && window.itemPickerCallback.type === 'text';
                
                if (isTextInput && window.itemPickerIsFilter) {
                    // For filter inputs, set the item description/SKU as value
                    const item = (cachedItems || []).find(i => i.Item_ID === itemId);
                    if (item) {
                        window.itemPickerCallback.value = item.SKU || item.Item_Description || itemId;
                    }
                    // Trigger the appropriate filter function based on input ID
                    const id = window.itemPickerCallback.id;
                    if (id === 'filterItemSearch') {
                        if (typeof filterItems === 'function') filterItems();
                    } else if (id === 'filterInventorySearch') {
                        if (typeof filterInventory === 'function') filterInventory();
                    } else if (id === 'pricesimSearch') {
                        if (typeof filterPriceSimItems === 'function') filterPriceSimItems();
                    }
                } else {
                    // Set the select value
                    window.itemPickerCallback.value = itemId;
                    
                    // Trigger change event to update any dependent fields
                    window.itemPickerCallback.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // Explicitly call update functions for mobile compatibility
                    if (window.itemPickerCallback.classList.contains('createpo-item')) {
                        updateCreatePOItemCost(window.itemPickerCallback);
                    } else if (window.itemPickerCallback.classList.contains('po-item')) {
                        updatePOItemInfo(window.itemPickerCallback);
                    } else if (window.itemPickerCallback.classList.contains('so-item')) {
                        if (typeof updateSOItemInfo === 'function') updateSOItemInfo(window.itemPickerCallback);
                    }
                    
                    // Recalculate totals after a brief delay to ensure DOM updates
                    setTimeout(() => {
                        if (typeof calculateCreatePOTotal === 'function') calculateCreatePOTotal();
                        if (typeof calculatePOTotal === 'function') calculatePOTotal();
                        if (typeof calculateSOTotal === 'function') calculateSOTotal();
                    }, 50);
                }
            }
            window.itemPickerIsFilter = false;
            closeItemPicker();
        }
        
        // Clear item filter and close picker
        function clearItemFilter() {
            if (window.itemPickerCallback) {
                window.itemPickerCallback.value = '';
                // Trigger the appropriate filter function
                const id = window.itemPickerCallback.id;
                if (id === 'filterItemSearch') {
                    if (typeof filterItems === 'function') filterItems();
                } else if (id === 'filterInventorySearch') {
                    if (typeof filterInventory === 'function') filterInventory();
                } else if (id === 'pricesimSearch') {
                    if (typeof filterPriceSimItems === 'function') filterPriceSimItems();
                }
            }
            window.itemPickerIsFilter = false;
            closeItemPicker();
        }
        
        // Auto-attach to item selects on ALL devices (not just mobile)
        function attachItemPickerToSelects() {
            // Attach to ALL item selects (forms + reports)
            document.querySelectorAll('.po-item, .so-item, .createpo-item, .edit-item, #filter_item').forEach(select => {
                if (!select.dataset.pickerAttached) {
                    select.dataset.pickerAttached = 'true';
                    // Use mousedown to intercept BEFORE the dropdown opens
                    select.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openItemPicker(this);
                    });
                    select.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openItemPicker(this);
                    });
                }
            });
        }
        
        // Re-attach when new rows are added
        const originalAddPORow = typeof addPurchaseLineItem === 'function' ? addPurchaseLineItem : null;
        const originalAddSORow = typeof addSaleLineItem === 'function' ? addSaleLineItem : null;
        const originalAddCreatePORow = typeof addCreatePOLine === 'function' ? addCreatePOLine : null;
        
        // Also attach when switching tabs
        const originalSwitchTab = typeof switchTab === 'function' ? switchTab : null;
        if (originalSwitchTab) {
            window.switchTabOriginal = switchTab;
            window.switchTab = function(tab) {
                switchTabOriginal(tab);
                setTimeout(attachItemPickerToSelects, 100);
                setTimeout(attachSupplierPickerToSelects, 100);
                setTimeout(attachCustomerPickerToSelects, 100);
                setTimeout(attachStatusPickerToSelects, 100);
            };
        }
        
        // ==================== SUPPLIER PICKER ====================
        
        let supplierPickerCallback = null;
        let supplierPickerIsFilter = false;  // Track if this is for a filter input
        
        // Open supplier picker for filter text inputs
        function openSupplierPickerForFilter(inputElement) {
            supplierPickerCallback = inputElement;
            supplierPickerIsFilter = true;
            document.getElementById('supplierPickerSearch').value = '';
            renderSupplierPickerList();
            document.getElementById('supplierPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                document.getElementById('supplierPickerSearch').focus();
            }, 100);
        }
        
        // Open item picker for filter text inputs
        function openItemPickerForFilter(inputElement) {
            window.itemPickerCallback = inputElement;
            window.itemPickerIsFilter = true;
            window.itemPickerSupplierContext = ''; // No supplier context for filters
            
            // Show supplier filter for filter context
            const supplierFilterDiv = document.getElementById('itemPickerSupplierFilter');
            if (supplierFilterDiv) {
                supplierFilterDiv.style.display = 'block';
            }
            
            // Populate supplier filter
            const supplierSelect = document.getElementById('itemPickerSupplier');
            supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
            if (cachedSuppliers && cachedSuppliers.length > 0) {
                cachedSuppliers.forEach(s => {
                    supplierSelect.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                });
            }
            
            // Get items from cache
            window.itemPickerItems = cachedItems || [];
            
            // Clear search
            document.getElementById('itemPickerSearch').value = '';
            document.getElementById('itemPickerSupplier').value = '';
            
            // Render items
            renderItemPickerList();
            
            // Show modal
            document.getElementById('itemPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Focus search after a moment
            setTimeout(() => {
                document.getElementById('itemPickerSearch').focus();
            }, 100);
        }
        
        // Open customer picker for filter text inputs
        function openCustomerPickerForFilter(inputElement) {
            customerPickerCallback = inputElement;
            window.customerPickerIsFilter = true;
            document.getElementById('customerPickerSearch').value = '';
            renderCustomerPickerList();
            document.getElementById('customerPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                document.getElementById('customerPickerSearch').focus();
            }, 100);
        }
        
        // Customer picker for report filters
        function openCustomerPickerForReport() {
            window.reportPickerType = 'customer';
            window.customerPickerIsFilter = true; // Allow "All Customers" option
            customerPickerCallback = {
                tagName: 'REPORT_FILTER',
                value: document.getElementById('rptFilter_customer').value
            };
            document.getElementById('customerPickerSearch').value = '';
            renderCustomerPickerList();
            document.getElementById('customerPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                document.getElementById('customerPickerSearch').focus();
            }, 100);
        }
        
        // Supplier picker for report filters
        function openSupplierPickerForReport() {
            window.reportPickerType = 'supplier';
            window.supplierPickerIsFilter = true; // Allow "All Suppliers" option
            supplierPickerCallback = {
                tagName: 'REPORT_FILTER',
                value: document.getElementById('rptFilter_supplier').value
            };
            document.getElementById('supplierPickerSearch').value = '';
            renderSupplierPickerList();
            document.getElementById('supplierPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                document.getElementById('supplierPickerSearch').focus();
            }, 100);
        }
        
        function openSupplierPicker(selectElement) {
            supplierPickerCallback = selectElement;
            document.getElementById('supplierPickerSearch').value = '';
            renderSupplierPickerList();
            document.getElementById('supplierPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                document.getElementById('supplierPickerSearch').focus();
            }, 100);
        }
        
        function closeSupplierPicker() {
            document.getElementById('supplierPickerModal').style.display = 'none';
            document.body.style.overflow = '';
            supplierPickerCallback = null;
        }
        
        function filterSupplierPicker() {
            renderSupplierPickerList();
        }
        
        function renderSupplierPickerList() {
            const search = document.getElementById('supplierPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('supplierPickerList');
            
            let suppliers = cachedSuppliers || [];
            
            let filtered = suppliers.filter(s => {
                return !search || 
                    (s.Supplier_Name && s.Supplier_Name.toLowerCase().includes(search)) ||
                    (s.Supplier_ID && s.Supplier_ID.toLowerCase().includes(search)) ||
                    (s.Contact_Name && s.Contact_Name.toLowerCase().includes(search));
            });
            
            // Check if this is a filter dropdown, filter text input, or report filter (needs "All/Clear" option)
            const isFilter = supplierPickerIsFilter || window.supplierPickerIsFilter || 
                (supplierPickerCallback && supplierPickerCallback.tagName === 'REPORT_FILTER') ||
                (supplierPickerCallback && (supplierPickerCallback.id.startsWith('filter') || supplierPickerCallback.id === 'pricesimSupplier'));
            
            let html = '';
            
            // Add "All Suppliers" or "Clear Filter" option for filters
            if (isFilter && !search) {
                const clearText = supplierPickerIsFilter ? 'Clear Filter' : 'All Suppliers';
                const clearDesc = supplierPickerIsFilter ? 'Remove supplier filter' : 'Show items from all suppliers';
                html += `
                    <div class="item-picker-card" onclick="selectSupplierFromPicker('')" style="border-left: 4px solid #6c757d; background: #f8f9fa;">
                        <div class="item-picker-desc" style="font-weight: bold; color: #495057;">
                            <span style="font-size: 18px; margin-right: 8px;">ğŸ“‹</span> ${clearText}
                        </div>
                        <div style="font-size: 12px; color: #6c757d;">${clearDesc}</div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && !isFilter) {
                listContainer.innerHTML = `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon">ğŸ­</div>
                        <div>No suppliers found</div>
                    </div>
                `;
                return;
            }
            
            filtered.forEach(s => {
                html += `
                    <div class="item-picker-card supplier-card" onclick="selectSupplierFromPicker('${s.Supplier_ID}')" style="border-left: 4px solid #c0c0c0;">
                        <div class="item-picker-card-header">
                            <span class="item-picker-sku">${s.Supplier_ID}</span>
                        </div>
                        <div class="item-picker-desc">${s.Supplier_Name || 'Unnamed Supplier'}</div>
                        <div class="item-picker-details" style="flex-wrap: wrap;">
                            ${s.Contact_Name ? `<div class="item-picker-detail"><span class="item-picker-detail-label">Contact</span><span class="item-picker-detail-value">${s.Contact_Name}</span></div>` : ''}
                            ${s.Phone ? `<div class="item-picker-detail"><span class="item-picker-detail-label">Phone</span><span class="item-picker-detail-value">${s.Phone}</span></div>` : ''}
                            ${s.Email ? `<div class="item-picker-detail"><span class="item-picker-detail-label">Email</span><span class="item-picker-detail-value" style="font-size: 12px;">${s.Email}</span></div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function selectSupplierFromPicker(supplierId) {
            if (supplierPickerCallback) {
                // Check if this is a report filter
                if (supplierPickerCallback.tagName === 'REPORT_FILTER') {
                    const displayInput = document.getElementById('rptFilter_supplier_display');
                    const hiddenInput = document.getElementById('rptFilter_supplier');
                    if (supplierId === '') {
                        displayInput.value = '';
                        hiddenInput.value = '';
                    } else {
                        const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === supplierId);
                        displayInput.value = supplier ? supplier.Supplier_Name : supplierId;
                        hiddenInput.value = supplierId;
                    }
                    window.supplierPickerIsFilter = false;
                    closeSupplierPicker();
                    return;
                }
                
                // Check if this is a filter text input or a select element
                const isTextInput = supplierPickerCallback.tagName === 'INPUT' && supplierPickerCallback.type === 'text';
                
                if (isTextInput && supplierPickerIsFilter) {
                    // For filter inputs, set the supplier name as value
                    if (supplierId === '') {
                        supplierPickerCallback.value = '';
                    } else {
                        const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === supplierId);
                        supplierPickerCallback.value = supplier ? supplier.Supplier_Name : supplierId;
                    }
                    // Trigger the filter function
                    if (typeof filterSuppliers === 'function') filterSuppliers();
                } else {
                    // For select elements, set the ID
                    supplierPickerCallback.value = supplierId;
                    supplierPickerCallback.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // Explicitly call update functions for specific selects
                    const id = supplierPickerCallback.id;
                    if (id === 'createPOSupplier') {
                        if (typeof filterItemsBySupplier === 'function') filterItemsBySupplier();
                    } else if (id === 'poSupplier') {
                        if (typeof loadSupplierItems === 'function') loadSupplierItems();
                    } else if (id === 'filterItemSupplier') {
                        if (typeof filterItems === 'function') filterItems();
                    } else if (id === 'filterPurchaseSupplier') {
                        if (typeof filterPurchases === 'function') filterPurchases();
                    } else if (id === 'filterInventorySupplier') {
                        if (typeof filterInventory === 'function') filterInventory();
                    } else if (id === 'pricesimSupplier') {
                        if (typeof filterPriceSimItems === 'function') filterPriceSimItems();
                    }
                }
            }
            supplierPickerIsFilter = false;
            closeSupplierPicker();
        }
        
        function attachSupplierPickerToSelects() {
            // Attach to ALL supplier selects on ALL devices (forms + filters + reports)
            const supplierSelects = [
                // Form selects
                '#poSupplier', '#editPOSupplier', '#createPOSupplier', 
                '#newItemSupplier', '#editItemSupplier', '#newSimSupplier',
                // Filter selects
                '#filterItemSupplier', '#filterPurchaseSupplier', 
                '#filterInventorySupplier', '#pricesimSupplier',
                // Report filters
                '#filter_supplier',
                // Class-based
                '.supplier-select'
            ].join(', ');
            
            document.querySelectorAll(supplierSelects).forEach(select => {
                if (!select.dataset.supplierPickerAttached) {
                    select.dataset.supplierPickerAttached = 'true';
                    select.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openSupplierPicker(this);
                    });
                    select.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openSupplierPicker(this);
                    });
                }
            });
        }
        
        // ==================== CUSTOMER PICKER ====================
        
        let customerPickerCallback = null;
        
        function openCustomerPicker(selectElement) {
            customerPickerCallback = selectElement;
            document.getElementById('customerPickerSearch').value = '';
            renderCustomerPickerList();
            document.getElementById('customerPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                document.getElementById('customerPickerSearch').focus();
            }, 100);
        }
        
        function closeCustomerPicker() {
            document.getElementById('customerPickerModal').style.display = 'none';
            document.body.style.overflow = '';
            customerPickerCallback = null;
        }
        
        // ==================== REASON PICKER ====================
        const adjustmentReasons = [
            { value: 'Physical Count', icon: 'ğŸ“Š', desc: 'Adjust to match physical inventory count' },
            { value: 'Damaged Goods', icon: 'ğŸ’”', desc: 'Items damaged and cannot be sold' },
            { value: 'Expired Products', icon: 'ğŸ“…', desc: 'Products past expiration date' },
            { value: 'Shrinkage/Theft', icon: 'ğŸ”', desc: 'Missing inventory, possible theft' },
            { value: 'Found Inventory', icon: 'âœ¨', desc: 'Located misplaced items' },
            { value: 'Data Correction', icon: 'âœï¸', desc: 'Fix data entry error' },
            { value: 'Returned Goods', icon: 'â†©ï¸', desc: 'Customer returned products' },
            { value: 'Sample/Promo', icon: 'ğŸ', desc: 'Given as sample or promotion' },
            { value: 'Transfer Out', icon: 'ğŸ“¤', desc: 'Moved to another location' },
            { value: 'Transfer In', icon: 'ğŸ“¥', desc: 'Received from another location' },
            { value: 'Other', icon: 'ğŸ“', desc: 'Other reason (add notes)' }
        ];
        
        function openReasonPicker() {
            const listContainer = document.getElementById('reasonPickerList');
            
            let html = '';
            adjustmentReasons.forEach(reason => {
                html += `
                    <div class="item-picker-card" onclick="selectReason('${reason.value}')" 
                         style="border-left: 4px solid #c0c0c0; margin-bottom: 10px; padding: 15px; cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.background='#f0f4ff'; this.style.borderLeftColor='var(--primary, #667eea)'"
                         onmouseout="this.style.background='white'; this.style.borderLeftColor='#c0c0c0'">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">${reason.icon}</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">${reason.value}</div>
                                <div style="font-size: 12px; color: #666;">${reason.desc}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
            
            document.getElementById('reasonPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function selectReason(reason) {
            document.getElementById('adjustReason').value = reason;
            document.getElementById('adjustReasonDisplay').value = reason;
            closeReasonPicker();
        }
        
        function closeReasonPicker() {
            document.getElementById('reasonPickerModal').style.display = 'none';
            document.body.style.overflow = '';
        }
        
        // ==================== UOM PICKER ====================
        let uomPickerTargetId = null;
        
        const purchaseUOMs = [
            { value: 'Case', icon: 'ğŸ“¦', desc: 'Standard case/carton of products' },
            { value: 'Box', icon: 'ğŸ—ƒï¸', desc: 'Smaller box packaging' },
            { value: 'Pack', icon: 'ğŸ“‹', desc: 'Multi-pack bundle' },
            { value: 'Each', icon: '1ï¸âƒ£', desc: 'Individual unit' },
            { value: 'Pallet', icon: 'ğŸ—ï¸', desc: 'Full pallet load' },
            { value: 'Bag', icon: 'ğŸ‘œ', desc: 'Bag packaging' },
            { value: 'Tray', icon: 'ğŸ½ï¸', desc: 'Tray packaging' },
            { value: 'Dozen', icon: 'ğŸ”¢', desc: '12 units' }
        ];
        
        function openUOMPicker(targetId) {
            uomPickerTargetId = targetId;
            const listContainer = document.getElementById('uomPickerList');
            
            let html = '';
            purchaseUOMs.forEach(uom => {
                html += `
                    <div class="item-picker-card" onclick="selectUOM('${uom.value}')" 
                         style="border-left: 4px solid #c0c0c0; margin-bottom: 10px; padding: 15px; cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.background='#f0f4ff'; this.style.borderLeftColor='var(--primary, #667eea)'"
                         onmouseout="this.style.background='white'; this.style.borderLeftColor='#c0c0c0'">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">${uom.icon}</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">${uom.value}</div>
                                <div style="font-size: 12px; color: #666;">${uom.desc}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
            
            document.getElementById('uomPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function selectUOM(uom) {
            if (uomPickerTargetId) {
                document.getElementById(uomPickerTargetId).value = uom;
                document.getElementById(uomPickerTargetId + 'Display').value = uom;
            }
            closeUOMPicker();
        }
        
        function closeUOMPicker() {
            document.getElementById('uomPickerModal').style.display = 'none';
            document.body.style.overflow = '';
            uomPickerTargetId = null;
        }
        
        // ==================== THEME PICKER ====================
        const themeCategories = [
            {
                name: 'ğŸ¨ Classic Themes',
                themes: [
                    { value: 'purple', name: 'ğŸŸ£ Royal Purple', primary: '#667eea', secondary: '#764ba2' },
                    { value: 'ocean', name: 'ğŸŒŠ Ocean Blue', primary: '#0077b6', secondary: '#00b4d8' },
                    { value: 'forest', name: 'ğŸŒ² Forest Green', primary: '#2d6a4f', secondary: '#40916c' },
                    { value: 'sunset', name: 'ğŸŒ… Sunset Orange', primary: '#f77f00', secondary: '#fcbf49' },
                    { value: 'crimson', name: 'â¤ï¸ Crimson Red', primary: '#9d0208', secondary: '#dc2f02' },
                    { value: 'slate', name: 'ğŸ”˜ Slate Gray', primary: '#475569', secondary: '#64748b' },
                    { value: 'teal', name: 'ğŸ’ Teal', primary: '#0d9488', secondary: '#14b8a6' },
                    { value: 'dark', name: 'ğŸŒ™ Professional Dark', primary: '#1e293b', secondary: '#334155' }
                ]
            },
            {
                name: 'ğŸˆ NFL - AFC',
                themes: [
                    { value: 'bills', name: 'ğŸ¦¬ Buffalo Bills', primary: '#00338D', secondary: '#C60C30' },
                    { value: 'dolphins', name: 'ğŸ¬ Miami Dolphins', primary: '#008E97', secondary: '#FC4C02' },
                    { value: 'patriots', name: 'ğŸ‡ºğŸ‡¸ New England Patriots', primary: '#002244', secondary: '#C60C30' },
                    { value: 'jets', name: 'âœˆï¸ New York Jets', primary: '#125740', secondary: '#000000' },
                    { value: 'ravens', name: 'ğŸ¦â€â¬› Baltimore Ravens', primary: '#241773', secondary: '#9E7C0C' },
                    { value: 'bengals', name: 'ğŸ… Cincinnati Bengals', primary: '#FB4F14', secondary: '#000000' },
                    { value: 'browns', name: 'ğŸ¶ Cleveland Browns', primary: '#311D00', secondary: '#FF3C00' },
                    { value: 'steelers', name: 'âš™ï¸ Pittsburgh Steelers', primary: '#FFB612', secondary: '#101820' },
                    { value: 'texans', name: 'ğŸ¤  Houston Texans', primary: '#03202F', secondary: '#A71930' },
                    { value: 'colts', name: 'ğŸ´ Indianapolis Colts', primary: '#002C5F', secondary: '#A2AAAD' },
                    { value: 'jaguars', name: 'ğŸ† Jacksonville Jaguars', primary: '#006778', secondary: '#D7A22A' },
                    { value: 'titans', name: 'âš”ï¸ Tennessee Titans', primary: '#0C2340', secondary: '#4B92DB' },
                    { value: 'broncos', name: 'ğŸ´ Denver Broncos', primary: '#FB4F14', secondary: '#002244' },
                    { value: 'chiefs', name: 'ğŸª¶ Kansas City Chiefs', primary: '#E31837', secondary: '#FFB81C' },
                    { value: 'raiders', name: 'â˜ ï¸ Las Vegas Raiders', primary: '#000000', secondary: '#A5ACAF' },
                    { value: 'chargers', name: 'âš¡ Los Angeles Chargers', primary: '#0080C6', secondary: '#FFC20E' }
                ]
            },
            {
                name: 'ğŸˆ NFL - NFC',
                themes: [
                    { value: 'cowboys', name: 'â­ Dallas Cowboys', primary: '#003594', secondary: '#869397' },
                    { value: 'giants', name: 'ğŸ—½ New York Giants', primary: '#0B2265', secondary: '#A71930' },
                    { value: 'eagles', name: 'ğŸ¦… Philadelphia Eagles', primary: '#004C54', secondary: '#A5ACAF' },
                    { value: 'commanders', name: 'ğŸ–ï¸ Washington Commanders', primary: '#5A1414', secondary: '#FFB612' },
                    { value: 'bears', name: 'ğŸ» Chicago Bears', primary: '#0B162A', secondary: '#C83803' },
                    { value: 'lions', name: 'ğŸ¦ Detroit Lions', primary: '#0076B6', secondary: '#B0B7BC' },
                    { value: 'packers', name: 'ğŸ§€ Green Bay Packers', primary: '#203731', secondary: '#FFB612' },
                    { value: 'vikings', name: 'â›µ Minnesota Vikings', primary: '#4F2683', secondary: '#FFC62F' },
                    { value: 'falcons', name: 'ğŸ¦… Atlanta Falcons', primary: '#A71930', secondary: '#000000' },
                    { value: 'panthers', name: 'ğŸˆâ€â¬› Carolina Panthers', primary: '#0085CA', secondary: '#101820' },
                    { value: 'saints', name: 'âšœï¸ New Orleans Saints', primary: '#D3BC8D', secondary: '#101820' },
                    { value: 'bucs', name: 'ğŸ´â€â˜ ï¸ Tampa Bay Buccaneers', primary: '#D50A0A', secondary: '#FF7900' },
                    { value: 'azcardinals', name: 'ğŸ”´ Arizona Cardinals', primary: '#97233F', secondary: '#000000' },
                    { value: 'rams', name: 'ğŸ Los Angeles Rams', primary: '#003594', secondary: '#FFA300' },
                    { value: 'niners', name: 'â›ï¸ San Francisco 49ers', primary: '#AA0000', secondary: '#B3995D' },
                    { value: 'seahawks', name: 'ğŸ¦… Seattle Seahawks', primary: '#002244', secondary: '#69BE28' }
                ]
            },
            {
                name: 'ğŸˆ NFL Throwbacks',
                themes: [
                    { value: 'bucscreamsicle', name: 'ğŸŠ Bucs Creamsicle', primary: '#FF8200', secondary: '#B71234' },
                    { value: 'steelersbee', name: 'ğŸ Steelers Bumblebee', primary: '#FFB612', secondary: '#000000' },
                    { value: 'oilersthrow', name: 'ğŸ›¢ï¸ Oilers Columbia Blue', primary: '#8CBED6', secondary: '#C41E3A' },
                    { value: 'patpatriot', name: 'ğŸ© Patriots Pat Patriot', primary: '#C8102E', secondary: '#002244' },
                    { value: 'chargerspowder', name: 'âš¡ Chargers Powder Blue', primary: '#0080C6', secondary: '#FFC20E' },
                    { value: 'orangecrush', name: 'ğŸ§¡ Broncos Orange Crush', primary: '#FB4F14', secondary: '#002244' },
                    { value: 'kellygreen', name: 'ğŸŸ¢ Eagles Kelly Green', primary: '#004C54', secondary: '#A5ACAF' },
                    { value: 'niners94', name: 'ğŸ† 49ers 94 Gold', primary: '#AA0000', secondary: '#B3995D' },
                    { value: 'rams99', name: 'ğŸ† Rams 99 Blue', primary: '#003594', secondary: '#FFA300' },
                    { value: 'seahawkslime', name: 'ğŸ’š Seahawks Original', primary: '#002244', secondary: '#69BE28' },
                    { value: 'falcons66', name: 'ğŸ¦ Falcons 66', primary: '#A71930', secondary: '#000000' },
                    { value: 'jets98', name: 'âœˆï¸ Jets 98 Green', primary: '#125740', secondary: '#000000' },
                    { value: 'bears36', name: 'ğŸ» Bears 36 Orange', primary: '#0B162A', secondary: '#C83803' },
                    { value: 'acme', name: 'ğŸ“¦ Packers Acme', primary: '#203731', secondary: '#FFB612' },
                    { value: 'cards47', name: 'ğŸ¦ Cardinals 47', primary: '#97233F', secondary: '#000000' }
                ]
            },
            {
                name: 'ğŸˆ NFL Alternates',
                themes: [
                    { value: 'billsred', name: 'ğŸ”´ Bills Red Helmet', primary: '#C60C30', secondary: '#00338D' },
                    { value: 'chiefsred', name: 'ğŸ”´ Chiefs Red on Red', primary: '#E31837', secondary: '#FFB81C' },
                    { value: 'raidersblack', name: 'â¬› Raiders Color Rush', primary: '#000000', secondary: '#A5ACAF' },
                    { value: 'whitetiger', name: 'ğŸ… Bengals White Tiger', primary: '#FB4F14', secondary: '#000000' },
                    { value: 'brownsrush', name: 'ğŸŸ¤ Browns Color Rush', primary: '#311D00', secondary: '#FF3C00' },
                    { value: 'eaglesblack', name: 'â¬› Eagles Black Alt', primary: '#004C54', secondary: '#000000' },
                    { value: 'titansoilers', name: 'ğŸ›¢ï¸ Titans Oilers 23', primary: '#8CBED6', secondary: '#C41E3A' },
                    { value: 'actiongreen', name: 'ğŸ’š Seahawks Action Green', primary: '#69BE28', secondary: '#002244' },
                    { value: 'jagsteal', name: 'ğŸ† Jaguars Teal', primary: '#006778', secondary: '#D7A22A' },
                    { value: 'purplepeople', name: 'ğŸ’œ Vikings Purple Eaters', primary: '#4F2683', secondary: '#FFC62F' }
                ]
            },
            {
                name: 'âš¾ MLB - American League',
                themes: [
                    { value: 'orioles', name: 'ğŸ¦œ Baltimore Orioles', primary: '#DF4601', secondary: '#000000' },
                    { value: 'redsox', name: 'ğŸ§¦ Boston Red Sox', primary: '#BD3039', secondary: '#0C2340' },
                    { value: 'yankees', name: 'âš¾ New York Yankees', primary: '#003087', secondary: '#E4002C' },
                    { value: 'rays', name: 'â˜€ï¸ Tampa Bay Rays', primary: '#092C5C', secondary: '#8FBCE6' },
                    { value: 'bluejays', name: 'ğŸ¦ Toronto Blue Jays', primary: '#134A8E', secondary: '#E8291C' },
                    { value: 'whitesox', name: 'ğŸ§¦ Chicago White Sox', primary: '#27251F', secondary: '#C4CED4' },
                    { value: 'guardians', name: 'âš¾ Cleveland Guardians', primary: '#00385D', secondary: '#E50022' },
                    { value: 'tigers', name: 'ğŸ¯ Detroit Tigers', primary: '#0C2340', secondary: '#FA4616' },
                    { value: 'royals', name: 'ğŸ‘‘ Kansas City Royals', primary: '#004687', secondary: '#BD9B60' },
                    { value: 'twins', name: 'âš¾ Minnesota Twins', primary: '#002B5C', secondary: '#D31145' },
                    { value: 'astros', name: 'ğŸš€ Houston Astros', primary: '#002D62', secondary: '#EB6E1F' },
                    { value: 'angels', name: 'ğŸ˜‡ Los Angeles Angels', primary: '#BA0021', secondary: '#003263' },
                    { value: 'athletics', name: 'ğŸ˜ Oakland Athletics', primary: '#003831', secondary: '#EFB21E' },
                    { value: 'mariners', name: 'ğŸ§­ Seattle Mariners', primary: '#0C2C56', secondary: '#005C5C' },
                    { value: 'rangers', name: 'âš¾ Texas Rangers', primary: '#003278', secondary: '#C0111F' }
                ]
            },
            {
                name: 'âš¾ MLB - National League',
                themes: [
                    { value: 'braves', name: 'ğŸª“ Atlanta Braves', primary: '#CE1141', secondary: '#13274F' },
                    { value: 'marlins', name: 'ğŸŸ Miami Marlins', primary: '#00A3E0', secondary: '#EF3340' },
                    { value: 'mets', name: 'ğŸ New York Mets', primary: '#002D72', secondary: '#FF5910' },
                    { value: 'phillies', name: 'ğŸ”” Philadelphia Phillies', primary: '#E81828', secondary: '#002D72' },
                    { value: 'nationals', name: 'ğŸ‡ºğŸ‡¸ Washington Nationals', primary: '#AB0003', secondary: '#14225A' },
                    { value: 'cubs', name: 'âš¾ Chicago Cubs', primary: '#0E3386', secondary: '#CC3433' },
                    { value: 'reds', name: 'ğŸ”´ Cincinnati Reds', primary: '#C6011F', secondary: '#000000' },
                    { value: 'brewers', name: 'ğŸº Milwaukee Brewers', primary: '#12284B', secondary: '#B6922E' },
                    { value: 'pirates', name: 'ğŸ´â€â˜ ï¸ Pittsburgh Pirates', primary: '#27251F', secondary: '#FDB827' },
                    { value: 'stlcardinals', name: 'ğŸ¦ St. Louis Cardinals', primary: '#C41E3A', secondary: '#0C2340' },
                    { value: 'dbacks', name: 'ğŸ Arizona Diamondbacks', primary: '#A71930', secondary: '#E3D4AD' },
                    { value: 'rockies', name: 'â›°ï¸ Colorado Rockies', primary: '#33006F', secondary: '#C4CED4' },
                    { value: 'dodgers', name: 'âš¾ Los Angeles Dodgers', primary: '#005A9C', secondary: '#EF3E42' },
                    { value: 'padres', name: 'ğŸ¤ San Diego Padres', primary: '#2F241D', secondary: '#FFC425' },
                    { value: 'sfgiants', name: 'ğŸ§¡ San Francisco Giants', primary: '#FD5A1E', secondary: '#27251F' }
                ]
            },
            {
                name: 'ğŸ€ NBA Teams',
                themes: [
                    { value: 'bulls', name: 'ğŸ€ Chicago Bulls', primary: '#CE1141', secondary: '#000000' },
                    { value: 'celtics', name: 'â˜˜ï¸ Boston Celtics', primary: '#007A33', secondary: '#BA9653' },
                    { value: 'nets', name: 'ğŸ€ Brooklyn Nets', primary: '#000000', secondary: '#FFFFFF' },
                    { value: 'knicks', name: 'ğŸ€ New York Knicks', primary: '#006BB6', secondary: '#F58426' },
                    { value: 'sixers', name: 'ğŸ”” Philadelphia 76ers', primary: '#006BB6', secondary: '#ED174C' },
                    { value: 'raptors', name: 'ğŸ¦– Toronto Raptors', primary: '#CE1141', secondary: '#000000' },
                    { value: 'cavs', name: 'âš”ï¸ Cleveland Cavaliers', primary: '#860038', secondary: '#041E42' },
                    { value: 'pistons', name: 'ğŸ€ Detroit Pistons', primary: '#C8102E', secondary: '#1D42BA' },
                    { value: 'pacers', name: 'ğŸï¸ Indiana Pacers', primary: '#002D62', secondary: '#FDBB30' },
                    { value: 'bucks', name: 'ğŸ¦Œ Milwaukee Bucks', primary: '#00471B', secondary: '#EEE1C6' },
                    { value: 'hawks', name: 'ğŸ¦… Atlanta Hawks', primary: '#E03A3E', secondary: '#C1D32F' },
                    { value: 'hornets', name: 'ğŸ Charlotte Hornets', primary: '#1D1160', secondary: '#00788C' },
                    { value: 'heat', name: 'ğŸ”¥ Miami Heat', primary: '#98002E', secondary: '#F9A01B' },
                    { value: 'magic', name: 'âœ¨ Orlando Magic', primary: '#0077C0', secondary: '#C4CED4' },
                    { value: 'wizards', name: 'ğŸ§™ Washington Wizards', primary: '#002B5C', secondary: '#E31837' },
                    { value: 'nuggets', name: 'â›ï¸ Denver Nuggets', primary: '#0E2240', secondary: '#FEC524' },
                    { value: 'twolves', name: 'ğŸº Minnesota Timberwolves', primary: '#0C2340', secondary: '#236192' },
                    { value: 'thunder', name: 'âš¡ Oklahoma City Thunder', primary: '#007AC1', secondary: '#EF3B24' },
                    { value: 'blazers', name: 'ğŸ”¥ Portland Trail Blazers', primary: '#E03A3E', secondary: '#000000' },
                    { value: 'jazz', name: 'ğŸ· Utah Jazz', primary: '#002B5C', secondary: '#00471B' },
                    { value: 'warriors', name: 'ğŸŒ‰ Golden State Warriors', primary: '#1D428A', secondary: '#FFC72C' },
                    { value: 'clippers', name: 'â›µ LA Clippers', primary: '#C8102E', secondary: '#1D428A' },
                    { value: 'lakers', name: 'ğŸ’œ Los Angeles Lakers', primary: '#552583', secondary: '#FDB927' },
                    { value: 'suns', name: 'â˜€ï¸ Phoenix Suns', primary: '#1D1160', secondary: '#E56020' },
                    { value: 'nbakings', name: 'ğŸ‘‘ Sacramento Kings', primary: '#5A2D81', secondary: '#63727A' },
                    { value: 'mavs', name: 'ğŸ´ Dallas Mavericks', primary: '#00538C', secondary: '#002B5E' },
                    { value: 'rockets', name: 'ğŸš€ Houston Rockets', primary: '#CE1141', secondary: '#000000' },
                    { value: 'grizzlies', name: 'ğŸ» Memphis Grizzlies', primary: '#5D76A9', secondary: '#12173F' },
                    { value: 'pelicans', name: 'ğŸ¦… New Orleans Pelicans', primary: '#0C2340', secondary: '#C8102E' },
                    { value: 'spurs', name: 'ğŸ¤  San Antonio Spurs', primary: '#C4CED4', secondary: '#000000' }
                ]
            },
            {
                name: 'ğŸ’ NHL Teams',
                themes: [
                    { value: 'blackhawks', name: 'ğŸ’ Chicago Blackhawks', primary: '#CF0A2C', secondary: '#000000' },
                    { value: 'bruins', name: 'ğŸ» Boston Bruins', primary: '#FFB81C', secondary: '#000000' },
                    { value: 'sabres', name: 'âš”ï¸ Buffalo Sabres', primary: '#002654', secondary: '#FCB514' },
                    { value: 'redwings', name: 'ğŸ™ Detroit Red Wings', primary: '#CE1126', secondary: '#FFFFFF' },
                    { value: 'flapanthers', name: 'ğŸ† Florida Panthers', primary: '#041E42', secondary: '#C8102E' },
                    { value: 'canadiens', name: 'ğŸ”´ Montreal Canadiens', primary: '#AF1E2D', secondary: '#192168' },
                    { value: 'senators', name: 'âš”ï¸ Ottawa Senators', primary: '#C52032', secondary: '#C2912C' },
                    { value: 'lightning', name: 'âš¡ Tampa Bay Lightning', primary: '#002868', secondary: '#FFFFFF' },
                    { value: 'mapleleafs', name: 'ğŸ Toronto Maple Leafs', primary: '#00205B', secondary: '#FFFFFF' },
                    { value: 'hurricanes', name: 'ğŸŒ€ Carolina Hurricanes', primary: '#CC0000', secondary: '#000000' },
                    { value: 'bluejackets', name: 'ğŸ”µ Columbus Blue Jackets', primary: '#002654', secondary: '#CE1126' },
                    { value: 'devils', name: 'ğŸ˜ˆ New Jersey Devils', primary: '#CE1126', secondary: '#000000' },
                    { value: 'islanders', name: 'ğŸï¸ New York Islanders', primary: '#00539B', secondary: '#F47D30' },
                    { value: 'nhlrangers', name: 'ğŸ—½ New York Rangers', primary: '#0038A8', secondary: '#CE1126' },
                    { value: 'flyers', name: 'ğŸŸ  Philadelphia Flyers', primary: '#F74902', secondary: '#000000' },
                    { value: 'penguins', name: 'ğŸ§ Pittsburgh Penguins', primary: '#000000', secondary: '#FCB514' },
                    { value: 'capitals', name: 'ğŸ¦… Washington Capitals', primary: '#041E42', secondary: '#C8102E' },
                    { value: 'coyotes', name: 'ğŸº Arizona Coyotes', primary: '#8C2633', secondary: '#E2D6B5' },
                    { value: 'avalanche', name: 'â›°ï¸ Colorado Avalanche', primary: '#6F263D', secondary: '#236192' },
                    { value: 'stars', name: 'â­ Dallas Stars', primary: '#006847', secondary: '#8F8F8C' },
                    { value: 'wild', name: 'ğŸŒ² Minnesota Wild', primary: '#154734', secondary: '#A6192E' },
                    { value: 'predators', name: 'ğŸ† Nashville Predators', primary: '#FFB81C', secondary: '#041E42' },
                    { value: 'stlblues', name: 'ğŸµ St. Louis Blues', primary: '#002F87', secondary: '#FCB514' },
                    { value: 'nhljets', name: 'âœˆï¸ Winnipeg Jets', primary: '#041E42', secondary: '#004C97' },
                    { value: 'ducks', name: 'ğŸ¦† Anaheim Ducks', primary: '#F47A38', secondary: '#B9975B' },
                    { value: 'flames', name: 'ğŸ”¥ Calgary Flames', primary: '#C8102E', secondary: '#F1BE48' },
                    { value: 'oilers', name: 'ğŸ›¢ï¸ Edmonton Oilers', primary: '#041E42', secondary: '#FF4C00' },
                    { value: 'kings', name: 'ğŸ‘‘ Los Angeles Kings', primary: '#111111', secondary: '#A2AAAD' },
                    { value: 'sharks', name: 'ğŸ¦ˆ San Jose Sharks', primary: '#006D75', secondary: '#EA7200' },
                    { value: 'kraken', name: 'ğŸ¦‘ Seattle Kraken', primary: '#001628', secondary: '#99D9D9' },
                    { value: 'canucks', name: 'ğŸ‹ Vancouver Canucks', primary: '#00205B', secondary: '#00843D' },
                    { value: 'goldenknights', name: 'âš”ï¸ Vegas Golden Knights', primary: '#B4975A', secondary: '#333F42' }
                ]
            },
            {
                name: 'ğŸˆ College Football',
                themes: [
                    { value: 'alabama', name: 'ğŸ˜ Alabama Crimson Tide', primary: '#9E1B32', secondary: '#828A8F' },
                    { value: 'arkansas', name: 'ğŸ— Arkansas Razorbacks', primary: '#9D2235', secondary: '#000000' },
                    { value: 'auburn', name: 'ğŸ… Auburn Tigers', primary: '#0C2340', secondary: '#E87722' },
                    { value: 'florida', name: 'ğŸŠ Florida Gators', primary: '#0021A5', secondary: '#FA4616' },
                    { value: 'georgia', name: 'ğŸ¶ Georgia Bulldogs', primary: '#BA0C2F', secondary: '#000000' },
                    { value: 'lsu', name: 'ğŸ¯ LSU Tigers', primary: '#461D7C', secondary: '#FDD023' },
                    { value: 'tennessee', name: 'ğŸŸ  Tennessee Volunteers', primary: '#FF8200', secondary: '#58595B' },
                    { value: 'texasam', name: 'ğŸ‘ Texas A&M Aggies', primary: '#500000', secondary: '#FFFFFF' },
                    { value: 'michigan', name: 'ã€½ï¸ Michigan Wolverines', primary: '#00274C', secondary: '#FFCB05' },
                    { value: 'michiganst', name: 'ğŸ’š Michigan State Spartans', primary: '#18453B', secondary: '#FFFFFF' },
                    { value: 'ohiostate', name: 'ğŸŒ° Ohio State Buckeyes', primary: '#BB0000', secondary: '#666666' },
                    { value: 'pennstate', name: 'ğŸ¦ Penn State Nittany Lions', primary: '#041E42', secondary: '#FFFFFF' },
                    { value: 'wisconsin', name: 'ğŸ¦¡ Wisconsin Badgers', primary: '#C5050C', secondary: '#FFFFFF' },
                    { value: 'nebraska', name: 'ğŸŒ½ Nebraska Cornhuskers', primary: '#E41C38', secondary: '#F5F1E7' },
                    { value: 'clemson', name: 'ğŸ… Clemson Tigers', primary: '#F56600', secondary: '#522D80' },
                    { value: 'fsu', name: 'ğŸ¹ Florida State Seminoles', primary: '#782F40', secondary: '#CEB888' },
                    { value: 'miami', name: 'ğŸ™Œ Miami Hurricanes', primary: '#F47321', secondary: '#005030' },
                    { value: 'oklahoma', name: 'ğŸ Oklahoma Sooners', primary: '#841617', secondary: '#FDF9D8' },
                    { value: 'okstate', name: 'ğŸ¤  Oklahoma State Cowboys', primary: '#FF7300', secondary: '#000000' },
                    { value: 'texas', name: 'ğŸ¤˜ Texas Longhorns', primary: '#BF5700', secondary: '#333F48' },
                    { value: 'oregon', name: 'ğŸ¦† Oregon Ducks', primary: '#154733', secondary: '#FEE123' },
                    { value: 'oregonst', name: 'ğŸ¦« Oregon State Beavers', primary: '#DC4405', secondary: '#000000' },
                    { value: 'usc', name: 'âœŒï¸ USC Trojans', primary: '#990000', secondary: '#FFC72C' },
                    { value: 'ucla', name: 'ğŸ» UCLA Bruins', primary: '#2D68C4', secondary: '#F2A900' },
                    { value: 'byu', name: 'ğŸ”ï¸ BYU Cougars', primary: '#002E5D', secondary: '#FFFFFF' },
                    { value: 'notredame', name: 'â˜˜ï¸ Notre Dame Fighting Irish', primary: '#0C2340', secondary: '#C99700' }
                ]
            },
            {
                name: 'ğŸ” Fast Food',
                themes: [
                    { value: 'mcdonalds', name: "ğŸŸ McDonald's", primary: '#FFC72C', secondary: '#DA291C' },
                    { value: 'burgerking', name: 'ğŸ” Burger King', primary: '#FF8732', secondary: '#502314' },
                    { value: 'wendys', name: "ğŸŸ¥ Wendy's", primary: '#E2203D', secondary: '#199FDA' },
                    { value: 'tacobell', name: 'ğŸŒ® Taco Bell', primary: '#702082', secondary: '#FF5BA3' },
                    { value: 'kfc', name: 'ğŸ— KFC', primary: '#F40027', secondary: '#FFFFFF' },
                    { value: 'subway', name: 'ğŸ¥– Subway', primary: '#008C15', secondary: '#FFC600' },
                    { value: 'pizzahut', name: 'ğŸ• Pizza Hut', primary: '#EE3124', secondary: '#00A160' },
                    { value: 'chickfila', name: 'ğŸ” Chick-fil-A', primary: '#E51636', secondary: '#004F71' },
                    { value: 'dunkin', name: "ğŸ© Dunkin'", primary: '#FF671F', secondary: '#DA1884' },
                    { value: 'dominos', name: "ğŸ• Domino's", primary: '#006491', secondary: '#E31837' },
                    { value: 'sonic', name: 'ğŸ¥¤ Sonic', primary: '#0066A1', secondary: '#EF3E42' },
                    { value: 'arbys', name: "ğŸ¥© Arby's", primary: '#D22630', secondary: '#64502F' },
                    { value: 'dairyqueen', name: 'ğŸ¦ Dairy Queen', primary: '#ED1C24', secondary: '#0066B2' },
                    { value: 'jackinthebox', name: 'ğŸ“¦ Jack in the Box', primary: '#E31837', secondary: '#FFD100' },
                    { value: 'popeyes', name: 'ğŸ— Popeyes', primary: '#F15A22', secondary: '#008578' },
                    { value: 'chipotle', name: 'ğŸŒ¯ Chipotle', primary: '#441500', secondary: '#A81612' },
                    { value: 'fiveguys', name: 'ğŸ” Five Guys', primary: '#D32323', secondary: '#FFFFFF' },
                    { value: 'innout', name: 'ğŸŒ´ In-N-Out', primary: '#E4002B', secondary: '#FFD700' },
                    { value: 'culvers', name: "ğŸ§ˆ Culver's", primary: '#0033A0', secondary: '#FFC72C' },
                    { value: 'timhortons', name: 'â˜• Tim Hortons', primary: '#DD0031', secondary: '#683B29' }
                ]
            },
            {
                name: 'ğŸ§€ Wisconsin & Midwest',
                themes: [
                    { value: 'kwiktrip', name: 'â›½ Kwik Trip', primary: '#D21034', secondary: '#231F20' },
                    { value: 'rutters', name: "â›½ Rutter's", primary: '#D40029', secondary: '#000000' },
                    { value: 'cenex', name: 'â›½ Cenex', primary: '#004B87', secondary: '#ED1C24' },
                    { value: 'cenexcoop', name: 'â›½ Cenex Co-op', primary: '#004B87', secondary: '#ED1C24' },
                    { value: 'fleetfarm', name: 'ğŸšœ Fleet Farm', primary: '#00703C', secondary: '#231F20' },
                    { value: 'woodmans', name: "ğŸ›’ Woodman's Markets", primary: '#2E3092', secondary: '#ED1C24' },
                    { value: 'picknsave', name: "ğŸ›’ Pick 'n Save", primary: '#004990', secondary: '#E4002B' },
                    { value: 'sentry', name: 'ğŸ›’ Sentry Foods', primary: '#004990', secondary: '#E4002B' },
                    { value: 'festival', name: 'ğŸ›’ Festival Foods', primary: '#00A651', secondary: '#ED1C24' },
                    { value: 'pigglywiggly', name: 'ğŸ· Piggly Wiggly', primary: '#E31837', secondary: '#231F20' },
                    { value: 'holiday', name: 'â›½ Holiday Stationstores', primary: '#00703C', secondary: '#ED1C24' },
                    { value: 'bp', name: 'â›½ BP Wisconsin', primary: '#009639', secondary: '#F7E600' },
                    { value: 'caseys', name: "â›½ Casey's", primary: '#E21A22', secondary: '#000000' },
                    { value: 'shell', name: 'â›½ Shell', primary: '#FFD500', secondary: '#DD1D21' },
                    { value: 'mobil', name: 'â›½ Mobil / Exxon', primary: '#0033A0', secondary: '#ED1C24' }
                ]
            },
            {
                name: 'ğŸ® Retro Gaming',
                themes: [
                    { value: 'nes', name: 'ğŸ•¹ï¸ NES Classic', primary: '#E60012', secondary: '#484848' },
                    { value: 'snes', name: 'ğŸ® SNES Classic', primary: '#5F249F', secondary: '#009DC4' },
                    { value: 'genesis', name: 'ğŸ® Sega Genesis', primary: '#0060A8', secondary: '#C8102E' },
                    { value: 'gameboy', name: 'ğŸ® Game Boy Color', primary: '#306230', secondary: '#8BAC0F' },
                    { value: 'n64', name: 'ğŸ® N64 Funtastic', primary: '#009E60', secondary: '#A020F0' },
                    { value: 'ps1', name: 'ğŸ® PlayStation 1', primary: '#003087', secondary: '#00A4E8' },
                    { value: 'windows95', name: 'ğŸ’» Windows 95', primary: '#008080', secondary: '#000080' },
                    { value: 'windowsxp', name: 'ğŸŒ„ Windows XP Bliss', primary: '#3A6EA5', secondary: '#6EA04B' },
                    { value: 'macos9', name: 'ğŸ Mac OS 9', primary: '#666666', secondary: '#999999' },
                    { value: 'amiga', name: 'ğŸ’» Amiga Workbench', primary: '#FF8800', secondary: '#0055AA' },
                    { value: 'c64', name: 'ğŸ’¾ Commodore 64', primary: '#A5A5FF', secondary: '#0000AA' }
                ]
            },
            {
                name: 'ğŸš— Cars & Sneakers',
                themes: [
                    { value: 'camaro', name: "ğŸš— '69 Camaro Z28", primary: '#FF6600', secondary: '#1C1C1C' },
                    { value: 'challenger', name: "ğŸš— '70 Challenger", primary: '#7B1FA2', secondary: '#1A1A1A' },
                    { value: 'bullitt', name: "ğŸš— '68 Mustang Bullitt", primary: '#355E3B', secondary: '#1A1A1A' },
                    { value: 'supra', name: "ğŸš— '94 Toyota Supra", primary: '#FF4500', secondary: '#1A1A1A' },
                    { value: 'skyline', name: "ğŸš— '99 Nissan Skyline", primary: '#0033CC', secondary: '#C0C0C0' },
                    { value: 'typer', name: "ğŸš— '97 Civic Type R", primary: '#CC0000', secondary: '#FFFFFF' },
                    { value: 'jordan1', name: 'ğŸ‘Ÿ Jordan 1 Chicago', primary: '#CE1126', secondary: '#000000' },
                    { value: 'yeezy', name: 'ğŸ‘Ÿ Yeezy 350', primary: '#B8B8B8', secondary: '#3D3D3D' },
                    { value: 'pigeon', name: 'ğŸ‘Ÿ Nike SB Dunk Pigeon', primary: '#808080', secondary: '#FF6B00' },
                    { value: 'wotherspoon', name: 'ğŸ‘Ÿ Air Max 97 Wotherspoon', primary: '#87CEEB', secondary: '#FFD700' }
                ]
            },
            {
                name: 'ğŸ¦¸ Superheroes',
                themes: [
                    { value: 'spiderman', name: 'ğŸ•·ï¸ Spider-Man Classic', primary: '#E62429', secondary: '#003DA5' },
                    { value: 'symbiote', name: 'ğŸ•¸ï¸ Spider-Man Symbiote', primary: '#1A1A1A', secondary: '#FFFFFF' },
                    { value: 'batman', name: 'ğŸ¦‡ Batman Arkham', primary: '#1A1A1A', secondary: '#2B3A4A' },
                    { value: 'superman', name: 'ğŸ¦¸ Superman', primary: '#0099F7', secondary: '#ED1D24' },
                    { value: 'wonderwoman', name: 'ğŸ‘¸ Wonder Woman', primary: '#C9A227', secondary: '#B22234' },
                    { value: 'ironman', name: 'ğŸ¤– Iron Man', primary: '#B71C1C', secondary: '#FFD700' },
                    { value: 'captainamerica', name: 'ğŸ›¡ï¸ Captain America', primary: '#002868', secondary: '#BF0A30' },
                    { value: 'hulk', name: 'ğŸ’ª Hulk', primary: '#4CAF50', secondary: '#1B5E20' },
                    { value: 'thor', name: 'âš¡ Thor', primary: '#0D47A1', secondary: '#FFD700' },
                    { value: 'harleyquinn', name: 'ğŸƒ Harley Quinn', primary: '#E91E63', secondary: '#00BCD4' },
                    { value: 'starlord', name: 'ğŸ§ Star-Lord', primary: '#8B0000', secondary: '#FFD700' },
                    { value: 'groot', name: 'ğŸŒ³ Groot', primary: '#8B4513', secondary: '#228B22' },
                    { value: 'marvelrivals', name: 'ğŸ® Marvel Rivals', primary: '#E62429', secondary: '#003DA5' },
                    { value: 'flash', name: 'âš¡ The Flash', primary: '#E62429', secondary: '#FFD700' },
                    { value: 'greenlantern', name: 'ğŸ’š Green Lantern', primary: '#00A651', secondary: '#1A1A1A' },
                    { value: 'reaper', name: 'ğŸ’€ Overwatch Reaper', primary: '#1A1A1A', secondary: '#8B0000' }
                ]
            },
            {
                name: 'ğŸ¤– Cyberpunk 2077',
                themes: [
                    { value: 'nightcity', name: 'ğŸŒƒ Night City Neon', primary: '#FF003C', secondary: '#00F0FF' },
                    { value: 'arasaka', name: 'ğŸ¢ Arasaka Corpo', primary: '#E21B1B', secondary: '#1A1A1A' },
                    { value: 'militech', name: 'ğŸ–ï¸ Militech Military', primary: '#3D5C5C', secondary: '#8B8B00' },
                    { value: 'moxes', name: 'ğŸ’œ Moxes Gang', primary: '#9B2D9B', secondary: '#00BFFF' },
                    { value: 'valentinos', name: 'ğŸ’— Valentinos Gang', primary: '#DC143C', secondary: '#FFD700' },
                    { value: 'vjacket', name: "ğŸ§¥ V's Jacket", primary: '#FFD700', secondary: '#000000' },
                    { value: 'silverhand', name: 'ğŸ¸ Johnny Silverhand', primary: '#FF6B35', secondary: '#1A1A1A' },
                    { value: 'cyberpunkui', name: 'ğŸ“º Cyberpunk UI', primary: '#00F0FF', secondary: '#FF003C' },
                    { value: 'phantomliberty', name: 'ğŸ¦… Phantom Liberty', primary: '#B8860B', secondary: '#191970' },
                    { value: 'cyberpunklogo', name: 'ğŸ’› Cyberpunk Logo', primary: '#FCE94F', secondary: '#00D4FF' }
                ]
            },
            {
                name: 'ğŸµ Lo-Fi / Vaporwave',
                themes: [
                    { value: 'lofi', name: 'ğŸ“» Lo-Fi ChilledCow', primary: '#E67E22', secondary: '#5B3A29' },
                    { value: 'chillhop', name: 'ğŸ¦ Chillhop Raccoon', primary: '#4A90A4', secondary: '#E8D5B7' },
                    { value: 'vaporwave', name: 'ğŸŒ´ Vaporwave Classic', primary: '#FF71CE', secondary: '#01CDFE' },
                    { value: 'mallsoft', name: 'ğŸ¬ Mallsoft Sunset', primary: '#FF6B9D', secondary: '#C9EEFF' },
                    { value: 'miamivice', name: 'ğŸŒ† Miami Vice', primary: '#FF6B9D', secondary: '#00D4FF' },
                    { value: 'outrun', name: 'ğŸŒƒ Outrun Grid', primary: '#FF2975', secondary: '#00BFFF' }
                ]
            },
            {
                name: 'âœˆï¸ Airlines',
                themes: [
                    { value: 'panam', name: 'âœˆï¸ Pan Am Classic', primary: '#0033A0', secondary: '#FFFFFF' },
                    { value: 'braniff', name: 'âœˆï¸ Braniff International', primary: '#FF6600', secondary: '#00A86B' },
                    { value: 'southwest', name: 'â¤ï¸ Southwest Heart', primary: '#304CB2', secondary: '#FFBF27' },
                    { value: 'pokemon', name: 'âš¡ ANA PokÃ©mon Jet', primary: '#FFCB05', secondary: '#3D7DCA' }
                ]
            },
            {
                name: 'ğŸï¸ National Parks',
                themes: [
                    { value: 'yellowstone', name: 'ğŸ¦¬ Yellowstone', primary: '#8B4513', secondary: '#228B22' },
                    { value: 'grandcanyon', name: 'ğŸœï¸ Grand Canyon', primary: '#CD5C5C', secondary: '#DAA520' },
                    { value: 'yosemite', name: 'â›°ï¸ Yosemite', primary: '#2E8B57', secondary: '#4682B4' }
                ]
            },
            {
                name: 'ğŸ” Retro Search Engines',
                themes: [
                    { value: 'yahoo1996', name: 'ğŸŸ£ Yahoo! 1996', primary: '#6001A8', secondary: '#FF9900' },
                    { value: 'yahoo2000s', name: 'ğŸ”´ Yahoo! 2000s', primary: '#7B0099', secondary: '#FF0000' },
                    { value: 'aol1995', name: 'ğŸ’› AOL 1995', primary: '#00C8FF', secondary: '#FFCC00' },
                    { value: 'aol2000s', name: 'ğŸ”µ AOL 2000s Teal', primary: '#00A0D8', secondary: '#FFFFFF' },
                    { value: 'excite1997', name: 'â— Excite 1997', primary: '#E4002B', secondary: '#000000' },
                    { value: 'lycos', name: 'ğŸ• Lycos', primary: '#FF0000', secondary: '#000000' },
                    { value: 'altavista', name: 'ğŸ” AltaVista 1998', primary: '#0066CC', secondary: '#FF9900' },
                    { value: 'askjeeves', name: 'ğŸ© Ask Jeeves', primary: '#00A99D', secondary: '#FF6600' },
                    { value: 'webcrawler', name: 'ğŸ•·ï¸ WebCrawler', primary: '#009900', secondary: '#FFFF00' },
                    { value: 'infoseek', name: 'ğŸ”® Infoseek 1997', primary: '#660099', secondary: '#FFCC00' },
                    { value: 'msn1998', name: 'ğŸ¦‹ MSN 1998 Butterfly', primary: '#00ADEF', secondary: '#FFB900' },
                    { value: 'netscape', name: 'ğŸŒ Netscape Navigator', primary: '#0033CC', secondary: '#FFCC00' },
                    { value: 'dogpile', name: 'ğŸ• Dogpile', primary: '#FF6600', secondary: '#6600CC' },
                    { value: 'geocities', name: 'ğŸ—ï¸ GeoCities Classic', primary: '#FF0099', secondary: '#00FF00' }
                ]
            },
            {
                name: 'ğŸ•¹ï¸ MAME Arcade Classics',
                themes: [
                    { value: 'mamepacman', name: 'ğŸ‘» Pac-Man', primary: '#FFFF00', secondary: '#FF0000' },
                    { value: 'mamemspacman', name: 'ğŸ€ Ms. Pac-Man', primary: '#FF21AE', secondary: '#00FFFF' },
                    { value: 'mamedonkeykong', name: 'ğŸ¦ Donkey Kong', primary: '#E80709', secondary: '#EE7511' },
                    { value: 'mamespaceinvaders', name: 'ğŸ‘¾ Space Invaders', primary: '#62DE6D', secondary: '#F83B3A' },
                    { value: 'mamegalaga', name: 'ğŸš€ Galaga', primary: '#00FF00', secondary: '#EC4705' },
                    { value: 'mamefrogger', name: 'ğŸ¸ Frogger', primary: '#66A400', secondary: '#EB1C2D' },
                    { value: 'mamestreetfighter', name: 'ğŸ¥‹ Street Fighter II', primary: '#FFFFFF', secondary: '#E70000' },
                    { value: 'mamemortalkombat', name: 'ğŸ‰ Mortal Kombat', primary: '#EED911', secondary: '#F53929' },
                    { value: 'mamedefender', name: 'ğŸ›¸ Defender', primary: '#00A651', secondary: '#FF4500' },
                    { value: 'mamecentipede', name: 'ğŸ› Centipede', primary: '#228B22', secondary: '#8B4513' },
                    { value: 'mamedigdug', name: 'â›ï¸ Dig Dug', primary: '#4169E1', secondary: '#FF0000' },
                    { value: 'mameqbert', name: 'ğŸ”¶ Q*bert', primary: '#9370DB', secondary: '#FF8C00' },
                    { value: 'mametempest', name: 'ğŸŒ€ Tempest', primary: '#8A2BE2', secondary: '#00BFFF' },
                    { value: 'mameasteroids', name: 'â˜„ï¸ Asteroids', primary: '#FFFFFF', secondary: '#00FFFF' },
                    { value: 'mamebubble', name: 'ğŸ«§ Bubble Bobble', primary: '#FFB6C1', secondary: '#87CEEB' },
                    { value: 'mamegauntlet', name: 'âš”ï¸ Gauntlet', primary: '#40FF40', secondary: '#FF4040' },
                    { value: 'mamerampage', name: 'ğŸ¦ Rampage', primary: '#00A000', secondary: '#FF69B4' },
                    { value: 'mamerobotron', name: 'ğŸ¤– Robotron', primary: '#00FFFF', secondary: '#FF00FF' },
                    { value: 'mamejoust', name: 'ğŸ¦… Joust', primary: '#FFD700', secondary: '#FF0000' },
                    { value: 'mametron', name: 'ğŸ’  Tron', primary: '#00FFFF', secondary: '#FF0000' },
                    { value: 'mamenbajam', name: 'ğŸ€ NBA Jam', primary: '#C8102E', secondary: '#002244' },
                    { value: 'mamecontra', name: 'ğŸ”« Contra', primary: '#0000FF', secondary: '#FF0000' },
                    { value: 'mamemetalslug', name: 'ğŸª– Metal Slug', primary: '#FFD700', secondary: '#4169E1' },
                    { value: 'mametmnt', name: 'ğŸ¢ TMNT Arcade', primary: '#008000', secondary: '#FF0000' },
                    { value: 'mamedoubledragon', name: 'ğŸ² Double Dragon', primary: '#0000FF', secondary: '#FF0000' },
                    { value: 'mamefinalfight', name: 'ğŸ‘Š Final Fight', primary: '#FFFF00', secondary: '#FF0000' },
                    { value: 'mamegradius', name: 'ğŸš€ Gradius', primary: '#00FFFF', secondary: '#FF4500' },
                    { value: 'mamegoldenaxe', name: 'ğŸª“ Golden Axe', primary: '#8B0000', secondary: '#FF4500' },
                    { value: 'mamestrider', name: 'âš”ï¸ Strider', primary: '#00FF00', secondary: '#FF00FF' },
                    { value: 'mamertype', name: 'ğŸ›©ï¸ R-Type', primary: '#4169E1', secondary: '#FF0000' }
                ]
            },
            {
                name: 'ğŸ¥¤ Monster Energy',
                themes: [
                    { value: 'monstergreen', name: 'ğŸ’š Monster Original', primary: '#8DC63F', secondary: '#000000' },
                    { value: 'monsterblack', name: 'â¬› Ultra Black', primary: '#000000', secondary: '#C0C0C0' },
                    { value: 'monstersunrise', name: 'ğŸŒ… Ultra Sunrise', primary: '#FF6B00', secondary: '#FFD700' },
                    { value: 'monsterparadise', name: 'ğŸ¥ Ultra Paradise', primary: '#00FF7F', secondary: '#FFFFFF' },
                    { value: 'monsterviolet', name: 'ğŸ‡ Ultra Violet', primary: '#9932CC', secondary: '#E0B0FF' },
                    { value: 'monsterpipeline', name: 'ğŸ¹ Pipeline Punch', primary: '#FF69B4', secondary: '#FFD700' },
                    { value: 'monsterrehab', name: 'ğŸ‹ Rehab Tea+Lemonade', primary: '#FFD700', secondary: '#8B4513' },
                    { value: 'monsterred', name: 'ğŸ’ Ultra Red', primary: '#C8102E', secondary: '#FFFFFF' }
                ]
            },
            {
                name: 'ğŸ”ï¸ Mountain Dew',
                themes: [
                    { value: 'mtndewgreen', name: 'ğŸ’š Original Dew', primary: '#99CC00', secondary: '#006633' },
                    { value: 'mtndewcodered', name: 'ğŸ’ Code Red', primary: '#C8102E', secondary: '#000000' },
                    { value: 'mtndewvoltage', name: 'âš¡ Voltage', primary: '#00B7EB', secondary: '#000000' },
                    { value: 'mtndewbaja', name: 'ğŸŒ´ Baja Blast', primary: '#66CCCC', secondary: '#FFFFFF' },
                    { value: 'mtndewlivewire', name: 'ğŸŠ Live Wire', primary: '#FF6B00', secondary: '#000000' },
                    { value: 'mtndewwhiteout', name: 'ğŸ¤ White Out', primary: '#FFFFFF', secondary: '#00BFFF' }
                ]
            },
            {
                name: 'ğŸº Root Beer & Soda',
                themes: [
                    { value: 'awrootbeer', name: 'ğŸº A&W Root Beer', primary: '#8B4513', secondary: '#FFD700' },
                    { value: 'barqs', name: 'ğŸ”´ Barqs Red CrÃ¨me', primary: '#C8102E', secondary: '#FFFFFF' },
                    { value: 'mugcream', name: 'ğŸ¦ Mug Cream Soda', primary: '#FFF8DC', secondary: '#8B4513' },
                    { value: 'ibccherry', name: 'ğŸ’ IBC Black Cherry', primary: '#4B0082', secondary: '#C71585' },
                    { value: 'cocacola', name: 'ğŸ¥¤ Coca-Cola', primary: '#C8102E', secondary: '#FFFFFF' },
                    { value: 'drpepper', name: 'ğŸ¥¤ Dr Pepper', primary: '#8B0000', secondary: '#DAA520' },
                    { value: 'pepsi', name: 'ğŸ¥¤ Pepsi', primary: '#004B8D', secondary: '#E4002B' },
                    { value: 'sprite', name: 'ğŸ¥¤ Sprite', primary: '#00A550', secondary: '#FFFFFF' },
                    { value: 'fanta', name: 'ğŸŠ Fanta Orange', primary: '#FF6600', secondary: '#003DA5' }
                ]
            },
            {
                name: 'âš¡ Energy Drinks',
                themes: [
                    { value: 'redbull', name: 'ğŸ‚ Red Bull', primary: '#0050A4', secondary: '#C0C0C0' },
                    { value: 'rockstar', name: 'â­ Rockstar', primary: '#800080', secondary: '#FFD700' },
                    { value: 'nos', name: 'ğŸ”¥ NOS Nitrous', primary: '#000000', secondary: '#FF0000' },
                    { value: 'bang', name: 'ğŸ’¥ Bang Neon', primary: '#FF6B00', secondary: '#FFD700' },
                    { value: 'c4energy', name: 'ğŸ’ª C4 Electric Blue', primary: '#00BFFF', secondary: '#FFFFFF' },
                    { value: 'alaninu', name: 'ğŸ’— Alani Nu Pink', primary: '#FF69B4', secondary: '#E0B0FF' },
                    { value: 'ghostenergy', name: 'ğŸ‘» Ghost Neon', primary: '#39FF14', secondary: '#000000' },
                    { value: 'celsius', name: 'ğŸŒ¡ï¸ Celsius Orange', primary: '#FF4500', secondary: '#FFD700' },
                    { value: 'prime', name: 'ğŸ† Prime Tropical', primary: '#00AEEF', secondary: '#FF6B00' },
                    { value: 'reign', name: 'ğŸ‘‘ Reign Matte Black', primary: '#000000', secondary: '#C0C0C0' },
                    { value: 'gamerfuel', name: 'ğŸ® Gamer Neon Grid', primary: '#00FFFF', secondary: '#FF00FF' }
                ]
            }
        ];

        function openThemePicker() {
            renderThemePickerList();
            document.getElementById('themePickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                document.getElementById('themePickerSearch').focus();
            }, 100);
        }
        
        function closeThemePicker() {
            document.getElementById('themePickerModal').style.display = 'none';
            document.body.style.overflow = '';
        }
        
        function filterThemePicker() {
            renderThemePickerList();
        }
        
        function renderThemePickerList() {
            const search = document.getElementById('themePickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('themePickerList');
            const currentTheme = document.getElementById('themeSelector').value;
            
            let html = '';
            
            themeCategories.forEach(category => {
                // Filter themes in this category
                const filteredThemes = category.themes.filter(t => {
                    return !search || 
                        t.name.toLowerCase().includes(search) || 
                        t.value.toLowerCase().includes(search) ||
                        category.name.toLowerCase().includes(search);
                });
                
                if (filteredThemes.length === 0) return;
                
                // Category header
                html += `<div style="font-weight: 600; font-size: 16px; color: #333; margin: 15px 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #e0e0e0;">${category.name}</div>`;
                
                // Theme grid
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">';
                
                filteredThemes.forEach(theme => {
                    const isSelected = theme.value === currentTheme;
                    html += `
                        <div onclick="selectTheme('${theme.value}', '${theme.name.replace(/'/g, "\\'")}')" 
                             style="cursor: pointer; padding: 12px; border: 2px solid ${isSelected ? theme.primary : '#e0e0e0'}; border-radius: 12px; background: ${isSelected ? '#f8f9fa' : 'white'}; transition: all 0.2s; display: flex; align-items: center; gap: 10px;"
                             onmouseover="this.style.borderColor='${theme.primary}'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                             onmouseout="this.style.borderColor='${isSelected ? theme.primary : '#e0e0e0'}'; this.style.transform='none'; this.style.boxShadow='none'">
                            <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary} 100%); box-shadow: 0 2px 6px rgba(0,0,0,0.2); flex-shrink: 0;"></div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 500; font-size: 13px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${theme.name}</div>
                                ${isSelected ? '<div style="font-size: 11px; color: #4CAF50; font-weight: 600;">âœ“ Active</div>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            if (!html) {
                html = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ”</div>
                        <div>No themes found for "${search}"</div>
                    </div>
                `;
            }
            
            listContainer.innerHTML = html;
        }
        
        function selectTheme(themeValue, themeName) {
            document.getElementById('themeSelector').value = themeValue;
            document.getElementById('themePreviewName').textContent = themeName;
            
            // Call the existing changeTheme function
            changeTheme();
            
            // Update the preview swatch with new colors
            setTimeout(() => {
                const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
                const secondary = getComputedStyle(document.documentElement).getPropertyValue('--secondary').trim();
                document.getElementById('themePreviewSwatch').style.background = `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`;
            }, 50);
            
            closeThemePicker();
        }
        
        // Update theme preview on page load
        function updateThemePreview() {
            const savedTheme = localStorage.getItem('theme') || 'purple';
            document.getElementById('themeSelector').value = savedTheme;
            
            // Find the theme name
            let themeName = 'ğŸŸ£ Royal Purple';
            themeCategories.forEach(cat => {
                const found = cat.themes.find(t => t.value === savedTheme);
                if (found) themeName = found.name;
            });
            
            document.getElementById('themePreviewName').textContent = themeName;
            
            // Update swatch
            setTimeout(() => {
                const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
                const secondary = getComputedStyle(document.documentElement).getPropertyValue('--secondary').trim();
                if (primary && secondary) {
                    document.getElementById('themePreviewSwatch').style.background = `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`;
                }
            }, 100);
        }
        
        function filterCustomerPicker() {
            renderCustomerPickerList();
        }
        
        function renderCustomerPickerList() {
            const search = document.getElementById('customerPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('customerPickerList');
            
            let customers = cachedCustomers || [];
            
            let filtered = customers.filter(c => {
                return !search || 
                    (c.Customer_Name && c.Customer_Name.toLowerCase().includes(search)) ||
                    (c.Customer_ID && c.Customer_ID.toLowerCase().includes(search)) ||
                    (c.Contact_Name && c.Contact_Name.toLowerCase().includes(search)) ||
                    (c.Route && c.Route.toLowerCase().includes(search));
            });
            
            // Check if this is a filter dropdown, filter text input, or report filter (needs "All/Clear" option)
            const isFilter = window.customerPickerIsFilter || 
                (customerPickerCallback && customerPickerCallback.tagName === 'REPORT_FILTER') ||
                (customerPickerCallback && customerPickerCallback.id && customerPickerCallback.id.startsWith('filter'));
            
            let html = '';
            
            // Add "All Customers" or "Clear Filter" option for filters
            if (isFilter && !search) {
                const clearText = window.customerPickerIsFilter ? 'Clear Filter' : 'All Customers';
                const clearDesc = window.customerPickerIsFilter ? 'Remove customer filter' : 'Show sales from all customers';
                html += `
                    <div class="item-picker-card" onclick="selectCustomerFromPicker('')" style="border-left: 4px solid #6c757d; background: #f8f9fa;">
                        <div class="item-picker-desc" style="font-weight: bold; color: #495057;">
                            <span style="font-size: 18px; margin-right: 8px;">ğŸ“‹</span> ${clearText}
                        </div>
                        <div style="font-size: 12px; color: #6c757d;">${clearDesc}</div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && !isFilter) {
                listContainer.innerHTML = `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon">ğŸ‘¤</div>
                        <div>No customers found</div>
                    </div>
                `;
                return;
            }
            
            filtered.forEach(c => {
                html += `
                    <div class="item-picker-card customer-card" onclick="selectCustomerFromPicker('${c.Customer_ID}')" style="border-left: 4px solid #c0c0c0;">
                        <div class="item-picker-card-header">
                            <span class="item-picker-sku">${c.Customer_ID}</span>
                            ${c.Route ? `<span class="item-picker-stock" style="background: #f0f0f0; color: #555;">Route: ${c.Route}</span>` : ''}
                        </div>
                        <div class="item-picker-desc">${c.Customer_Name || 'Unnamed Customer'}</div>
                        <div class="item-picker-details" style="flex-wrap: wrap;">
                            ${c.Contact_Name ? `<div class="item-picker-detail"><span class="item-picker-detail-label">Contact</span><span class="item-picker-detail-value">${c.Contact_Name}</span></div>` : ''}
                            ${c.Phone ? `<div class="item-picker-detail"><span class="item-picker-detail-label">Phone</span><span class="item-picker-detail-value">${c.Phone}</span></div>` : ''}
                            ${c.Address ? `<div class="item-picker-detail" style="flex: 1 1 100%;"><span class="item-picker-detail-label">Address</span><span class="item-picker-detail-value" style="font-size: 13px;">${c.Address}</span></div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function selectCustomerFromPicker(customerId) {
            if (customerPickerCallback) {
                // Check if this is a report filter
                if (customerPickerCallback.tagName === 'REPORT_FILTER') {
                    const displayInput = document.getElementById('rptFilter_customer_display');
                    const hiddenInput = document.getElementById('rptFilter_customer');
                    if (customerId === '') {
                        displayInput.value = '';
                        hiddenInput.value = '';
                    } else {
                        const customer = (cachedCustomers || []).find(c => c.Customer_ID === customerId);
                        displayInput.value = customer ? customer.Customer_Name : customerId;
                        hiddenInput.value = customerId;
                    }
                    window.customerPickerIsFilter = false;
                    closeCustomerPicker();
                    return;
                }
                
                // Check if this is a filter text input or a select element
                const isTextInput = customerPickerCallback.tagName === 'INPUT' && customerPickerCallback.type === 'text';
                
                if (isTextInput && window.customerPickerIsFilter) {
                    // For filter inputs, set the customer name as value
                    if (customerId === '') {
                        customerPickerCallback.value = '';
                    } else {
                        const customer = (cachedCustomers || []).find(c => c.Customer_ID === customerId);
                        customerPickerCallback.value = customer ? customer.Customer_Name : customerId;
                    }
                    // Trigger the filter function
                    if (typeof filterCustomers === 'function') filterCustomers();
                } else {
                    customerPickerCallback.value = customerId;
                    customerPickerCallback.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // Explicitly call filter function if it's a filter select
                    const id = customerPickerCallback.id;
                    if (id === 'filterSaleCustomer') {
                        if (typeof filterSales === 'function') filterSales();
                    }
                }
            }
            window.customerPickerIsFilter = false;
            closeCustomerPicker();
        }
        
        function attachCustomerPickerToSelects() {
            // Attach to ALL customer selects on ALL devices (forms + filters + reports)
            const customerSelects = [
                // Form selects
                '#soCustomer', '#editSOCustomer',
                // Filter selects
                '#filterSaleCustomer',
                // Report filters
                '#filter_customer',
                // Class-based
                '.customer-select'
            ].join(', ');
            
            document.querySelectorAll(customerSelects).forEach(select => {
                if (!select.dataset.customerPickerAttached) {
                    select.dataset.customerPickerAttached = 'true';
                    select.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openCustomerPicker(this);
                    });
                    select.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openCustomerPicker(this);
                    });
                }
            });
        }
        
        // ==================== STATUS PICKER ====================
        
        let statusPickerCallback = null;
        let statusPickerOptions = [];
        
        function openStatusPicker(selectElement, title, color) {
            statusPickerCallback = selectElement;
            
            // Get options from the select element
            statusPickerOptions = [];
            Array.from(selectElement.options).forEach(opt => {
                statusPickerOptions.push({
                    value: opt.value,
                    text: opt.textContent,
                    selected: opt.selected
                });
            });
            
            // Set title
            document.getElementById('statusPickerTitle').textContent = title || 'ğŸ“‹ Select Status';
            
            // Render options
            renderStatusPickerList();
            
            // Show modal
            document.getElementById('statusPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closeStatusPicker() {
            document.getElementById('statusPickerModal').style.display = 'none';
            document.body.style.overflow = '';
            statusPickerCallback = null;
        }
        
        function renderStatusPickerList() {
            const listContainer = document.getElementById('statusPickerList');
            
            let html = '';
            statusPickerOptions.forEach((opt, index) => {
                const isAll = opt.value === '';
                const icon = isAll ? 'ğŸ“‹' : (opt.text.match(/^[^\w\s]/) ? opt.text.charAt(0) : 'â€¢');
                const text = opt.text.replace(/^[^\w\s]\s*/, '');
                
                html += `
                    <div class="item-picker-card" onclick="selectStatusFromPicker('${opt.value}')" 
                         style="border-left: 4px solid #c0c0c0; 
                                ${isAll ? 'background: #f8f9fa;' : ''}
                                ${opt.selected ? 'background: #e8e8e8; border-left-color: #888;' : ''}">
                        <div class="item-picker-desc" style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">${icon}</span>
                            <span style="font-weight: ${opt.selected ? 'bold' : 'normal'};">${text}</span>
                            ${opt.selected ? '<span style="margin-left: auto; color: #555;">âœ“</span>' : ''}
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function selectStatusFromPicker(value) {
            if (statusPickerCallback) {
                statusPickerCallback.value = value;
                statusPickerCallback.dispatchEvent(new Event('change', { bubbles: true }));
            }
            closeStatusPicker();
        }
        
        // ==================== PO PICKER ====================
        
        let poPickerCallback = null;
        
        function openPOPicker(inputElement) {
            poPickerCallback = inputElement;
            document.getElementById('poPickerSearch').value = '';
            renderPOPickerList();
            document.getElementById('poPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                document.getElementById('poPickerSearch').focus();
            }, 100);
        }
        
        function closePOPicker() {
            document.getElementById('poPickerModal').style.display = 'none';
            document.body.style.overflow = '';
            poPickerCallback = null;
        }
        
        function filterPOPicker() {
            renderPOPickerList();
        }
        
        function renderPOPickerList() {
            const search = document.getElementById('poPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('poPickerList');
            
            // Get POs from cache
            let pos = cachedPurchases || [];
            
            let filtered = pos.filter(po => {
                return !search || 
                    (po.PO_ID && po.PO_ID.toLowerCase().includes(search)) ||
                    (po.Invoice_Number && po.Invoice_Number.toLowerCase().includes(search));
            });
            
            let html = '';
            
            // Add "Clear Filter" option
            if (!search) {
                html += `
                    <div class="item-picker-card" onclick="selectPOFromPicker('')" style="border-left: 4px solid #6c757d; background: #f8f9fa;">
                        <div class="item-picker-desc" style="font-weight: bold; color: #495057;">
                            <span style="font-size: 18px; margin-right: 8px;">ğŸ“‹</span> Clear Filter
                        </div>
                        <div style="font-size: 12px; color: #6c757d;">Show all purchase orders</div>
                    </div>
                `;
            }
            
            if (filtered.length === 0) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon">ğŸ“‹</div>
                        <div>No purchase orders found</div>
                    </div>
                `;
                return;
            }
            
            // Sort by date descending
            filtered.sort((a, b) => new Date(b.PO_Date || 0) - new Date(a.PO_Date || 0));
            
            // Limit to 50
            filtered.slice(0, 50).forEach(po => {
                const status = po.Status || 'Ordered';
                const statusColor = status === 'Received' ? '#4caf50' : '#ff9800';
                const supplierName = getSupplierName(po.Supplier_ID);
                const total = parseFloat(po.Total_Amount) || 0;
                const date = po.PO_Date ? new Date(po.PO_Date).toLocaleDateString() : '';
                const displayNum = po.Invoice_Number || po.PO_ID;
                
                html += `
                    <div class="item-picker-card" onclick="selectPOFromPicker('${displayNum}')" style="border-left: 4px solid #c0c0c0;">
                        <div class="item-picker-card-header">
                            <span class="item-picker-sku">${displayNum}</span>
                            <span class="item-picker-stock" style="background: ${status === 'Received' ? '#e8f5e9' : '#fff3e0'}; color: ${statusColor};">${status}</span>
                        </div>
                        <div class="item-picker-desc">${supplierName}</div>
                        <div class="item-picker-details">
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Date</span>
                                <span class="item-picker-detail-value">${date}</span>
                            </div>
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Total</span>
                                <span class="item-picker-detail-value item-picker-price">$${total.toFixed(2)}</span>
                            </div>
                            ${po.PO_ID !== displayNum ? `<div class="item-picker-detail"><span class="item-picker-detail-label">PO ID</span><span class="item-picker-detail-value">${po.PO_ID}</span></div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function selectPOFromPicker(poNumber) {
            if (poPickerCallback) {
                poPickerCallback.value = poNumber;
                if (typeof filterPurchases === 'function') filterPurchases();
            }
            closePOPicker();
        }
        
        // ==================== INVOICE PICKER ====================
        
        let invoicePickerCallback = null;
        
        function openInvoicePicker(inputElement) {
            invoicePickerCallback = inputElement;
            document.getElementById('invoicePickerSearch').value = '';
            renderInvoicePickerList();
            document.getElementById('invoicePickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                document.getElementById('invoicePickerSearch').focus();
            }, 100);
        }
        
        function closeInvoicePicker() {
            document.getElementById('invoicePickerModal').style.display = 'none';
            document.body.style.overflow = '';
            invoicePickerCallback = null;
        }
        
        function filterInvoicePicker() {
            renderInvoicePickerList();
        }
        
        function renderInvoicePickerList() {
            const search = document.getElementById('invoicePickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('invoicePickerList');
            
            // Get Sales from cache
            let sales = cachedSales || [];
            
            let filtered = sales.filter(sale => {
                return !search || 
                    (sale.Invoice_Number && sale.Invoice_Number.toLowerCase().includes(search)) ||
                    (sale.SO_Number && sale.SO_Number.toLowerCase().includes(search));
            });
            
            let html = '';
            
            // Add "Clear Filter" option
            if (!search) {
                html += `
                    <div class="item-picker-card" onclick="selectInvoiceFromPicker('')" style="border-left: 4px solid #6c757d; background: #f8f9fa;">
                        <div class="item-picker-desc" style="font-weight: bold; color: #495057;">
                            <span style="font-size: 18px; margin-right: 8px;">ğŸ“‹</span> Clear Filter
                        </div>
                        <div style="font-size: 12px; color: #6c757d;">Show all invoices</div>
                    </div>
                `;
            }
            
            if (filtered.length === 0) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon">ğŸ§¾</div>
                        <div>No invoices found</div>
                    </div>
                `;
                return;
            }
            
            // Sort by date descending
            filtered.sort((a, b) => new Date(b.Sale_Date || 0) - new Date(a.Sale_Date || 0));
            
            // Limit to 50
            filtered.slice(0, 50).forEach(sale => {
                const customerName = getCustomerName(sale.Customer_ID);
                const total = parseFloat(sale.Total_Amount) || 0;
                const date = sale.Sale_Date ? new Date(sale.Sale_Date).toLocaleDateString() : '';
                const invoiceNum = sale.Invoice_Number || sale.SO_Number || 'No Invoice#';
                
                html += `
                    <div class="item-picker-card" onclick="selectInvoiceFromPicker('${invoiceNum}')" style="border-left: 4px solid #c0c0c0;">
                        <div class="item-picker-card-header">
                            <span class="item-picker-sku">${invoiceNum}</span>
                        </div>
                        <div class="item-picker-desc">${customerName}</div>
                        <div class="item-picker-details">
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Date</span>
                                <span class="item-picker-detail-value">${date}</span>
                            </div>
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Total</span>
                                <span class="item-picker-detail-value item-picker-price">$${total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function selectInvoiceFromPicker(invoiceNumber) {
            if (invoicePickerCallback) {
                invoicePickerCallback.value = invoiceNumber;
                if (typeof filterSales === 'function') filterSales();
            }
            closeInvoicePicker();
        }
        
        // ==================== ITEM PICKER (for reports) ====================
        
        function openItemPickerForReport() {
            document.getElementById('itemPickerSearch').value = '';
            renderItemPickerListForReport();
            document.getElementById('itemPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                document.getElementById('itemPickerSearch').focus();
            }, 100);
        }
        
        function closeItemPickerForReport() {
            document.getElementById('itemPickerModal').style.display = 'none';
            document.body.style.overflow = '';
        }
        
        function filterItemPickerForReport() {
            renderItemPickerListForReport();
        }
        
        function renderItemPickerListForReport() {
            const search = document.getElementById('itemPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('itemPickerList');
            
            let items = cachedItems || [];
            
            let filtered = items.filter(item => {
                return !search || 
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(search)) ||
                    (item.SKU && item.SKU.toLowerCase().includes(search));
            });
            
            let html = '';
            
            // Add "All Items" option at top
            html += `
                <div class="item-picker-card" onclick="selectItemForReport('', 'All Items')" style="border-left: 4px solid #28a745; background: #e8f5e9;">
                    <div class="item-picker-desc" style="font-weight: bold; color: #2e7d32;">
                        <span style="font-size: 18px; margin-right: 8px;">ğŸ“Š</span> All Items
                    </div>
                    <div style="font-size: 12px; color: #388e3c;">Show report for all products</div>
                </div>
            `;
            
            if (filtered.length === 0 && search) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon">ğŸ“¦</div>
                        <div>No items found matching "${search}"</div>
                    </div>
                `;
                return;
            }
            
            // Sort alphabetically by description
            filtered.sort((a, b) => (a.Item_Description || '').localeCompare(b.Item_Description || ''));
            
            // Show items
            filtered.forEach(item => {
                const supplierName = getSupplierName(item.Supplier_ID);
                const sellPrice = parseFloat(item.Sell_Price) || 0;
                const costPrice = parseFloat(item.Cost) || 0;
                const qty = parseInt(item.Qty_On_Hand) || 0;
                
                // Stock status color
                let stockColor = '#28a745';
                let stockBg = '#e8f5e9';
                if (qty <= 0) {
                    stockColor = '#dc3545';
                    stockBg = '#ffebee';
                } else if (qty <= (parseInt(item.Reorder_Point) || 10)) {
                    stockColor = '#ff9800';
                    stockBg = '#fff3e0';
                }
                
                html += `
                    <div class="item-picker-card" onclick="selectItemForReport('${item.Item_ID}', '${(item.Item_Description || '').replace(/'/g, "\\'")}')" style="border-left: 4px solid ${stockColor};">
                        <div class="item-picker-card-header">
                            <span class="item-picker-sku">${item.SKU || 'No SKU'}</span>
                            <span style="background: ${stockBg}; color: ${stockColor}; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold;">${qty} in stock</span>
                        </div>
                        <div class="item-picker-desc">${item.Item_Description || 'No Description'}</div>
                        <div class="item-picker-details">
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Supplier</span>
                                <span class="item-picker-detail-value">${supplierName}</span>
                            </div>
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Sell</span>
                                <span class="item-picker-detail-value item-picker-price">$${sellPrice.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function selectItemForReport(itemId, itemName) {
            document.getElementById('rptFilter_item').value = itemId;
            document.getElementById('rptFilter_item_display').value = itemId ? itemName : 'All Items (click to filter)';
            closeItemPickerForReport();
        }
        
        // ==================== PO TYPE PICKER (for reports) ====================
        
        function openPOTypePicker() {
            document.getElementById('poTypePickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closePOTypePicker() {
            document.getElementById('poTypePickerModal').style.display = 'none';
            document.body.style.overflow = '';
        }
        
        function selectPOType(typeValue, typeName) {
            document.getElementById('rptFilter_poType').value = typeValue;
            document.getElementById('rptFilter_poType_display').value = typeValue ? typeName : 'All Types (click to select)';
            closePOTypePicker();
        }
        
        function attachStatusPickerToSelects() {
            // Stock Status selects
            document.querySelectorAll('#filterItemStock, #filterInventoryStock, #pricesimStock').forEach(select => {
                if (!select.dataset.statusPickerAttached) {
                    select.dataset.statusPickerAttached = 'true';
                    select.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openStatusPicker(this, 'ğŸ“¦ Stock Status', 'stock');
                    });
                    select.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openStatusPicker(this, 'ğŸ“¦ Stock Status', 'stock');
                    });
                }
            });
            
            // Order Status selects
            document.querySelectorAll('#filterPurchaseStatus').forEach(select => {
                if (!select.dataset.statusPickerAttached) {
                    select.dataset.statusPickerAttached = 'true';
                    select.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openStatusPicker(this, 'ğŸ“¤ Order Status', 'order');
                    });
                    select.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openStatusPicker(this, 'ğŸ“¤ Order Status', 'order');
                    });
                }
            });
            
            // Payment Status selects
            document.querySelectorAll('#filterPurchasePaymentStatus').forEach(select => {
                if (!select.dataset.statusPickerAttached) {
                    select.dataset.statusPickerAttached = 'true';
                    select.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openStatusPicker(this, 'ğŸ’µ Payment Status', 'payment');
                    });
                    select.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openStatusPicker(this, 'ğŸ’µ Payment Status', 'payment');
                    });
                }
            });
        }
        
        // Attach all pickers on page load
        document.addEventListener('DOMContentLoaded', function() {
            attachItemPickerToSelects();
            attachSupplierPickerToSelects();
            attachCustomerPickerToSelects();
            attachStatusPickerToSelects();
            setInterval(() => {
                attachItemPickerToSelects();
                attachSupplierPickerToSelects();
                attachCustomerPickerToSelects();
                attachStatusPickerToSelects();
            }, 1000);
        });
        
        // ==================== HOW-TO GUIDE FUNCTIONS ====================
        
        function openHowToGuide() {
            document.getElementById('howToGuideModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            showGuideSection('getting-started'); // Show first section by default
        }
        
        function closeHowToGuide() {
            document.getElementById('howToGuideModal').style.display = 'none';
            document.body.style.overflow = '';
        }
        
        function showGuideSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.guide-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            const targetSection = document.getElementById('guide-' + sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // Update tab styles
            document.querySelectorAll('.guide-tab').forEach(tab => {
                tab.style.color = '#666';
                tab.style.borderBottom = '3px solid transparent';
                tab.style.background = 'none';
            });
            
            // Highlight active tab (find by checking onclick)
            document.querySelectorAll('.guide-tab').forEach(tab => {
                if (tab.onclick && tab.onclick.toString().includes(`'${sectionId}'`)) {
                    tab.style.color = '#667eea';
                    tab.style.borderBottom = '3px solid #667eea';
                    tab.style.background = 'white';
                }
            });
        }
        
        // Close guide modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('howToGuideModal');
            if (event.target === modal) {
                closeHowToGuide();
            }
        });
        
        // ==================== BULK IMPORT/EXPORT FUNCTIONS ====================
        
        // Store parsed items temporarily for commit
        let pendingItemsUpload = null;
        let pendingUploadMode = null;

        async function downloadItemsReport() {
            if (!cachedItems || cachedItems.length === 0) {
                alert('No items to download. Please load items first.');
                return;
            }

            // Create printable HTML report
            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Items Report - Nowak Distributing</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { text-align: center; color: #333; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11px; }
                        th { background: #667eea; color: white; padding: 8px; text-align: left; border: 1px solid #ddd; }
                        td { padding: 6px; border: 1px solid #ddd; }
                        tr:nth-child(even) { background: #f9f9f9; }
                        .footer { margin-top: 30px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; }
                        .action-buttons { 
                            position: fixed; 
                            top: 10px; 
                            right: 10px; 
                            z-index: 1000; 
                            display: flex; 
                            gap: 10px; 
                        }
                        .action-btn { 
                            padding: 10px 20px; 
                            border: none; 
                            border-radius: 8px; 
                            cursor: pointer; 
                            font-size: 14px; 
                            font-weight: 600; 
                            transition: all 0.2s; 
                            box-shadow: 0 2px 8px rgba(0,0,0,0.15); 
                        }
                        .print-btn { 
                            background: #28a745; 
                            color: white; 
                        }
                        .print-btn:hover { 
                            background: #218838; 
                            transform: translateY(-2px); 
                            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
                        }
                        .close-btn { 
                            background: #f44336; 
                            color: white; 
                        }
                        .close-btn:hover { 
                            background: #d32f2f; 
                            transform: translateY(-2px); 
                            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
                        }
                        @media print {
                            .action-buttons { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <!-- Action Buttons at Top -->
                    <div class="action-buttons">
                        <button class="action-btn print-btn" onclick="window.print()">ğŸ–¨ï¸ Print</button>
                        <button class="action-btn close-btn" onclick="window.close()">âœ–ï¸ Close</button>
                    </div>

                    <h1>Nowak Distributing - Items Report</h1>
                    <p style="text-align: center; color: #666;">Generated: ${new Date().toLocaleString()} | Total Items: ${cachedItems.length}</p>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Item_ID</th>
                                <th>SKU</th>
                                <th>Description</th>
                                <th>Supplier_ID</th>
                                <th>Cost</th>
                                <th>Sell_Price</th>
                                <th>Qty_On_Hand</th>
                                <th>Reorder_Point</th>
                                <th>Package_Cost</th>
                                <th>Units_Per_Package</th>
                                <th>Qty_On_Order</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cachedItems.map(item => `
                                <tr>
                                    <td>${item.Item_ID || ''}</td>
                                    <td>${item.SKU || ''}</td>
                                    <td>${item.Item_Description || ''}</td>
                                    <td>${item.Supplier_ID || ''}</td>
                                    <td>${parseFloat(item.Cost || 0).toFixed(2)}</td>
                                    <td>${parseFloat(item.Sell_Price || 0).toFixed(2)}</td>
                                    <td>${parseInt(item.Qty_On_Hand || 0)}</td>
                                    <td>${parseInt(item.Reorder_Point || 0)}</td>
                                    <td>${parseFloat(item.Package_Cost || 0).toFixed(2)}</td>
                                    <td>${parseInt(item.Units_Per_Package || 0)}</td>
                                    <td>${parseInt(item.Qty_On_Order || 0)}</td>
                                    <td>${item.Status || 'Active'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <h3>How to Use This Report:</h3>
                        <ol>
                            <li>Click <strong>ğŸ–¨ï¸ Print</strong> button above and save as PDF</li>
                            <li>Upload PDF to <strong>ilovepdf.com/pdf_to_excel</strong></li>
                            <li>Download the Excel file</li>
                            <li>Edit prices, quantities, or other fields</li>
                            <li><strong>DO NOT modify Item_ID column!</strong></li>
                            <li>Upload back via the "Upload Items" button</li>
                        </ol>
                        <p><strong>âš ï¸ Important:</strong> Always backup before uploading!</p>
                    </div>
                </body>
                </html>
            `;

            // Open in new window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            printWindow.focus();
        }

        function openUploadItemsModal() {
            document.getElementById('uploadItemsModal').style.display = 'block';
            document.getElementById('uploadItemsFile').value = '';
            document.getElementById('uploadItemsPreview').style.display = 'none';
            document.body.style.overflow = 'hidden';
        }

        function closeUploadItemsModal() {
            document.getElementById('uploadItemsModal').style.display = 'none';
            document.body.style.overflow = '';
            pendingItemsUpload = null;
            pendingUploadMode = null;
        }

        async function previewItemsUpload() {
            const fileInput = document.getElementById('uploadItemsFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to upload');
                return;
            }

            const uploadMode = document.querySelector('input[name="uploadMode"]:checked').value;
            
            try {
                showStatus('itemsStatus', 'â³ Processing file and generating preview...', 'info');

                // Read and parse the file
                const uploadedItems = await parseUploadedFile(file);
                
                if (!uploadedItems || uploadedItems.length === 0) {
                    alert('No valid items found in file');
                    return;
                }

                // Store for later commit
                pendingItemsUpload = uploadedItems;
                pendingUploadMode = uploadMode;

                // Generate comparison report
                const comparison = compareItemsForPreview(uploadedItems, uploadMode);
                
                // Display preview
                displayPreviewReport(comparison);
                
                // Show the preview section
                document.getElementById('uploadItemsPreview').style.display = 'block';
                
                // Scroll to preview
                document.getElementById('uploadItemsPreview').scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                showStatus('itemsStatus', 'âœ… Preview generated - Review changes below', 'success');

            } catch (error) {
                showStatus('itemsStatus', 'âŒ Error processing file: ' + error.message, 'error');
            }
        }

        function compareItemsForPreview(uploadedItems, mode) {
            const existing = cachedItems || [];
            const comparison = {
                toAdd: [],
                toUpdate: [],
                noChange: [],
                notInUpload: []
            };

            // Create map of existing items by Item_ID
            const existingMap = {};
            existing.forEach(item => {
                if (item.Item_ID) {
                    existingMap[item.Item_ID] = item;
                }
            });

            // Compare uploaded items
            uploadedItems.forEach(uploadItem => {
                const itemId = uploadItem.Item_ID;
                
                // Check if this is a new item
                if (!itemId || itemId === 'NEW' || itemId === '' || !existingMap[itemId]) {
                    comparison.toAdd.push({
                        item: uploadItem,
                        isNew: true
                    });
                } else {
                    // Existing item - check for changes
                    const existingItem = existingMap[itemId];
                    const changes = detectChanges(existingItem, uploadItem);
                    
                    if (changes.length > 0) {
                        comparison.toUpdate.push({
                            itemId: itemId,
                            before: existingItem,
                            after: uploadItem,
                            changes: changes
                        });
                    } else {
                        comparison.noChange.push({
                            itemId: itemId,
                            item: existingItem
                        });
                    }
                    
                    // Mark as seen
                    existingMap[itemId].seen = true;
                }
            });

            // Find items not in upload (only matters for Full Refresh)
            if (mode === 'full-refresh') {
                existing.forEach(item => {
                    if (item.Item_ID && !item.seen) {
                        comparison.notInUpload.push(item);
                    }
                });
            }

            return comparison;
        }

        function detectChanges(before, after) {
            const changes = [];
            const fieldsToCheck = [
                { key: 'SKU', label: 'SKU' },
                { key: 'Item_Description', label: 'Description' },
                { key: 'Supplier_ID', label: 'Supplier' },
                { key: 'Cost', label: 'Cost', isNumber: true },
                { key: 'Sell_Price', label: 'Sell Price', isNumber: true },
                { key: 'Qty_On_Hand', label: 'Qty On Hand', isNumber: true },
                { key: 'Reorder_Point', label: 'Reorder Point', isNumber: true },
                { key: 'Package_Cost', label: 'Package Cost', isNumber: true },
                { key: 'Units_Per_Package', label: 'Units/Package', isNumber: true },
                { key: 'Qty_On_Order', label: 'Qty On Order', isNumber: true },
                { key: 'Status', label: 'Status' }
            ];

            fieldsToCheck.forEach(field => {
                let beforeVal = before[field.key];
                let afterVal = after[field.key];

                // Normalize for comparison
                if (field.isNumber) {
                    beforeVal = parseFloat(beforeVal) || 0;
                    afterVal = parseFloat(afterVal) || 0;
                } else {
                    beforeVal = String(beforeVal || '').trim();
                    afterVal = String(afterVal || '').trim();
                }

                if (beforeVal !== afterVal) {
                    changes.push({
                        field: field.label,
                        before: beforeVal,
                        after: afterVal
                    });
                }
            });

            return changes;
        }

        function displayPreviewReport(comparison) {
            // Summary stats
            const summaryHtml = `
                <div style="padding: 12px; background: #e8f5e9; border-radius: 6px; text-align: center; border-left: 4px solid #4caf50;">
                    <div style="font-size: 20px; font-weight: bold; color: #2e7d32;">${comparison.toAdd.length}</div>
                    <div style="font-size: 11px; color: #666;">To Add</div>
                </div>
                <div style="padding: 12px; background: #fff3e0; border-radius: 6px; text-align: center; border-left: 4px solid #ff9800;">
                    <div style="font-size: 20px; font-weight: bold; color: #e65100;">${comparison.toUpdate.length}</div>
                    <div style="font-size: 11px; color: #666;">To Update</div>
                </div>
                ${pendingUploadMode === 'full-refresh' ? `
                <div style="padding: 12px; background: #ffebee; border-radius: 6px; text-align: center; border-left: 4px solid #f44336;">
                    <div style="font-size: 20px; font-weight: bold; color: #c62828;">${comparison.notInUpload.length}</div>
                    <div style="font-size: 11px; color: #666;">To Delete</div>
                </div>
                ` : ''}
                <div style="padding: 12px; background: #f5f5f5; border-radius: 6px; text-align: center; border-left: 4px solid #9e9e9e;">
                    <div style="font-size: 20px; font-weight: bold; color: #616161;">${comparison.noChange.length}</div>
                    <div style="font-size: 11px; color: #666;">No Change</div>
                </div>
            `;
            document.getElementById('uploadItemsSummary').innerHTML = summaryHtml;

            // Detailed changes
            let detailHtml = '';

            // Items to ADD
            if (comparison.toAdd.length > 0) {
                detailHtml += `<div style="margin-bottom: 15px;"><h4 style="background: #4caf50; color: white; padding: 8px; border-radius: 6px 6px 0 0; margin: 0;">â• ${comparison.toAdd.length} Items to ADD</h4><div style="background: white; padding: 12px; border: 2px solid #4caf50; border-radius: 0 0 6px 6px;">`;
                
                comparison.toAdd.slice(0, 10).forEach(entry => {
                    const item = entry.item;
                    detailHtml += `<div style="padding: 8px; margin-bottom: 8px; background: #e8f5e9; border-radius: 4px; border-left: 4px solid #4caf50; font-size: 12px;"><strong>${item.SKU || 'No SKU'}</strong> - ${item.Item_Description || 'No Description'} | Cost: $${parseFloat(item.Cost || 0).toFixed(2)} | Sell: $${parseFloat(item.Sell_Price || 0).toFixed(2)}</div>`;
                });
                
                if (comparison.toAdd.length > 10) {
                    detailHtml += `<div style="padding: 8px; color: #666; font-size: 12px;">...and ${comparison.toAdd.length - 10} more</div>`;
                }
                
                detailHtml += `</div></div>`;
            }

            // Items to UPDATE
            if (comparison.toUpdate.length > 0) {
                detailHtml += `<div style="margin-bottom: 15px;"><h4 style="background: #ff9800; color: white; padding: 8px; border-radius: 6px 6px 0 0; margin: 0;">âœï¸ ${comparison.toUpdate.length} Items to UPDATE</h4><div style="background: white; padding: 12px; border: 2px solid #ff9800; border-radius: 0 0 6px 6px;">`;
                
                comparison.toUpdate.slice(0, 10).forEach(entry => {
                    detailHtml += `<div style="padding: 8px; margin-bottom: 10px; background: #fff3e0; border-radius: 4px; border-left: 4px solid #ff9800; font-size: 12px;"><strong>${entry.before.SKU || entry.itemId}</strong> - ${entry.before.Item_Description || 'No Description'}<br>${entry.changes.map(c => `<span style="color: #e65100;">${c.field}:</span> <span style="text-decoration: line-through;">${c.before}</span> â†’ <strong>${c.after}</strong>`).join(' | ')}</div>`;
                });
                
                if (comparison.toUpdate.length > 10) {
                    detailHtml += `<div style="padding: 8px; color: #666; font-size: 12px;">...and ${comparison.toUpdate.length - 10} more</div>`;
                }
                
                detailHtml += `</div></div>`;
            }

            // Items to DELETE (Full Refresh only)
            if (pendingUploadMode === 'full-refresh' && comparison.notInUpload.length > 0) {
                detailHtml += `<div style="margin-bottom: 15px;"><h4 style="background: #f44336; color: white; padding: 8px; border-radius: 6px 6px 0 0; margin: 0;">â›” ${comparison.notInUpload.length} Items to DELETE</h4><div style="background: white; padding: 12px; border: 2px solid #f44336; border-radius: 0 0 6px 6px;">`;
                
                comparison.notInUpload.slice(0, 20).forEach(item => {
                    detailHtml += `<div style="padding: 6px; margin-bottom: 6px; background: #ffebee; border-radius: 4px; border-left: 4px solid #f44336; font-size: 12px;"><strong>${item.SKU || item.Item_ID}</strong> - ${item.Item_Description || 'No Description'}</div>`;
                });
                
                if (comparison.notInUpload.length > 20) {
                    detailHtml += `<div style="padding: 8px; color: #666; font-size: 12px;">...and ${comparison.notInUpload.length - 20} more</div>`;
                }
                
                detailHtml += `</div></div>`;
            }

            document.getElementById('uploadItemsPreviewContent').innerHTML = detailHtml || '<p>No changes detected</p>';
        }

        async function commitItemsUpload() {
            if (!pendingItemsUpload) {
                alert('No upload pending');
                return;
            }

            // Final confirmation for Full Refresh
            if (pendingUploadMode === 'full-refresh') {
                if (!confirm('âš ï¸ FINAL CONFIRMATION: This will DELETE ALL existing items and replace with the uploaded file.\n\nAre you ABSOLUTELY SURE?')) {
                    return;
                }
                const finalConfirm = prompt('Type YES (in capital letters) to proceed with FULL REFRESH:');
                if (finalConfirm !== 'YES') {
                    alert('Upload cancelled');
                    return;
                }
            }

            try {
                showStatus('itemsStatus', 'â³ Committing changes to database...', 'info');

                // Send to backend
                const result = await apiCall('bulkUpdateItems', {
                    items: pendingItemsUpload,
                    mode: pendingUploadMode
                });

                if (result && result.status === 'success') {
                    showStatus('itemsStatus', `âœ… Upload complete! ${result.added || 0} added, ${result.updated || 0} updated, ${result.deleted || 0} deleted`, 'success');
                    
                    // Clear pending upload
                    pendingItemsUpload = null;
                    pendingUploadMode = null;
                    
                    closeUploadItemsModal();
                    await loadItems();
                } else {
                    showStatus('itemsStatus', 'âŒ Upload failed: ' + (result?.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                showStatus('itemsStatus', 'âŒ Error committing changes: ' + error.message, 'error');
            }
        }

        function cancelPreview() {
            // Clear pending upload
            pendingItemsUpload = null;
            pendingUploadMode = null;
            
            // Hide preview
            document.getElementById('uploadItemsPreview').style.display = 'none';
            
            // Reset file input
            document.getElementById('uploadItemsFile').value = '';
            
            showStatus('itemsStatus', 'Upload cancelled', 'info');
        }

        async function parseUploadedFile(file) {
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.csv')) {
                // Parse CSV
                const text = await file.text();
                return parseCSV(text);
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                // Parse Excel
                await loadSheetJS();
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                // Normalize column names
                return jsonData.map(row => ({
                    Item_ID: row.Item_ID || row.item_id || '',
                    SKU: row.SKU || row.sku || '',
                    Item_Description: row.Item_Description || row.Description || row.description || '',
                    Supplier_ID: row.Supplier_ID || row.supplier_id || '',
                    Cost: parseFloat(row.Cost || row.cost || 0),
                    Sell_Price: parseFloat(row.Sell_Price || row.Unit_Sell_Price || row.sell_price || 0),
                    Qty_On_Hand: parseInt(row.Qty_On_Hand || row.qty_on_hand || 0),
                    Reorder_Point: parseInt(row.Reorder_Point || row.reorder_point || 0),
                    Package_Cost: parseFloat(row.Package_Cost || row.package_cost || 0),
                    Units_Per_Package: parseInt(row.Units_Per_Package || row.units_per_package || 0),
                    Qty_On_Order: parseInt(row.Qty_On_Order || row.qty_on_order || 0),
                    Status: row.Status || row.status || 'Active'
                }));
            } else {
                throw new Error('Unsupported file type. Please use .xlsx, .xls, or .csv');
            }
        }

        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const items = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const item = {};
                
                headers.forEach((header, index) => {
                    item[header] = values[index] || '';
                });
                
                // Normalize column names
                items.push({
                    Item_ID: item.Item_ID || item.item_id || '',
                    SKU: item.SKU || item.sku || '',
                    Item_Description: item.Item_Description || item.Description || '',
                    Supplier_ID: item.Supplier_ID || item.supplier_id || '',
                    Cost: parseFloat(item.Cost || item.cost || 0),
                    Sell_Price: parseFloat(item.Sell_Price || item.Unit_Sell_Price || 0),
                    Qty_On_Hand: parseInt(item.Qty_On_Hand || 0),
                    Reorder_Point: parseInt(item.Reorder_Point || 0),
                    Package_Cost: parseFloat(item.Package_Cost || 0),
                    Units_Per_Package: parseInt(item.Units_Per_Package || 0),
                    Qty_On_Order: parseInt(item.Qty_On_Order || 0),
                    Status: item.Status || 'Active'
                });
            }
            
            return items;
        }

        function loadSheetJS() {
            return new Promise((resolve, reject) => {
                if (window.XLSX) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // ==================== DESKTOP MODAL DRAG & RESIZE ====================
        // Make modals draggable and resizable on desktop only
        
        function initDesktopModalFeatures() {
            // Only enable on desktop (screen width > 768px)
            if (window.innerWidth <= 768) return;
            
            // Find all modals with inner containers
            const modals = [
                { overlay: document.getElementById('orderModal'), container: document.querySelector('#orderModal > div') },
                { overlay: document.getElementById('reportSetupModal'), container: document.querySelector('#reportSetupModal > div') },
                { overlay: document.getElementById('howToGuideModal'), container: document.querySelector('#howToGuideModal > div') },
                { overlay: document.getElementById('uploadItemsModal'), container: document.querySelector('#uploadItemsModal > div') },
                { overlay: document.getElementById('itemPickerModal'), container: document.querySelector('#itemPickerModal .item-picker-container') }
            ];
            
            modals.forEach(modal => {
                if (!modal.overlay || !modal.container) return;
                
                // Make container resizable
                if (!modal.container.classList.contains('resizable-added')) {
                    modal.container.style.resize = 'both';
                    modal.container.style.minWidth = '400px';
                    modal.container.style.minHeight = '300px';
                    modal.container.style.maxWidth = '95vw';
                    modal.container.style.maxHeight = '95vh';
                    modal.container.classList.add('resizable-added');
                }
                
                // Find header for dragging
                const header = modal.container.querySelector('[id*="Header"], .item-picker-header, h2');
                if (!header || header.classList.contains('draggable-added')) return;
                
                header.style.cursor = 'move';
                header.style.userSelect = 'none';
                header.classList.add('draggable-added');
                
                let isDragging = false;
                let currentX;
                let currentY;
                let initialX;
                let initialY;
                let xOffset = 0;
                let yOffset = 0;
                
                header.addEventListener('mousedown', dragStart);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', dragEnd);
                
                function dragStart(e) {
                    // Don't drag if clicking on a button or input
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                    
                    if (e.target === header || header.contains(e.target)) {
                        isDragging = true;
                        
                        // Get current position
                        const rect = modal.container.getBoundingClientRect();
                        
                        // If not already fixed, convert to fixed positioning
                        if (modal.container.style.position !== 'fixed') {
                            modal.container.style.position = 'fixed';
                            modal.container.style.margin = '0';
                            
                            // Preserve the current size
                            modal.container.style.width = rect.width + 'px';
                            modal.container.style.height = rect.height + 'px';
                            
                            modal.container.style.left = rect.left + 'px';
                            modal.container.style.top = rect.top + 'px';
                            
                            // Reset transform-based offsets
                            xOffset = parseInt(modal.container.style.left) || rect.left;
                            yOffset = parseInt(modal.container.style.top) || rect.top;
                        } else {
                            // Already fixed, get current offsets from left/top
                            xOffset = parseInt(modal.container.style.left) || rect.left;
                            yOffset = parseInt(modal.container.style.top) || rect.top;
                        }
                        
                        initialX = e.clientX;
                        initialY = e.clientY;
                    }
                }
                
                function drag(e) {
                    if (isDragging) {
                        e.preventDefault();
                        
                        // Calculate new position
                        const deltaX = e.clientX - initialX;
                        const deltaY = e.clientY - initialY;
                        
                        let newLeft = xOffset + deltaX;
                        let newTop = yOffset + deltaY;
                        
                        // Keep modal within viewport (with some padding)
                        const rect = modal.container.getBoundingClientRect();
                        const padding = 10;
                        const maxX = window.innerWidth - rect.width - padding;
                        const maxY = window.innerHeight - rect.height - padding;
                        
                        newLeft = Math.max(padding, Math.min(newLeft, maxX));
                        newTop = Math.max(padding, Math.min(newTop, maxY));
                        
                        // Apply position
                        modal.container.style.left = newLeft + 'px';
                        modal.container.style.top = newTop + 'px';
                    }
                }
                
                function dragEnd(e) {
                    if (isDragging) {
                        // Update offsets for next drag
                        xOffset = parseInt(modal.container.style.left) || 0;
                        yOffset = parseInt(modal.container.style.top) || 0;
                    }
                    isDragging = false;
                }
            });
        }
        
        // Initialize on page load
        window.addEventListener('load', initDesktopModalFeatures);
        
        // Re-initialize when modals are opened
        const originalDisplaySetters = {};
        ['orderModal', 'reportSetupModal', 'howToGuideModal', 'uploadItemsModal', 'itemPickerModal'].forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal) {
                // Watch for display changes
                const observer = new MutationObserver(() => {
                    if (modal.style.display !== 'none') {
                        setTimeout(initDesktopModalFeatures, 100);
                    }
                });
                observer.observe(modal, { attributes: true, attributeFilter: ['style'] });
            }
        });
    </script>
</body>
</html>
