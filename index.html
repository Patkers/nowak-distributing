<!DOCTYPE html>
<html lang="en">
<head>
    <!-- =====================================================
         NOWAK DISTRIBUTING ERP SYSTEM - FRONTEND
         =====================================================
         LAST UPDATED: Saturday, December 14, 2025 @ 3:50 AM CST
         VERSION: V10Z-20251214-0350
         =====================================================
         CHANGES IN THIS VERSION:
         - FIXED: Reduced mobile touch sensitivity on dropdowns
         - Added 300ms debounce between select taps
         - Added touch-action: manipulation to all buttons/selects
         - Min 44px touch targets on mobile
         - Environment buttons work on mobile
         - All dropdowns refresh on environment switch
         ===================================================== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Nowak Distributing - Inventory Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary, #667eea);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            margin: 0;
            /* Allow normal scrolling */
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        html {
            /* Standard scrolling setup */
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
            /* Prevent pull-to-refresh but allow scroll */
            overscroll-behavior-y: contain;
        }
        
        /* MOBILE TOUCH SENSITIVITY FIX */
        /* Reduce accidental taps and double-firing */
        select, 
        button, 
        .btn, 
        .report-btn,
        input[type="button"],
        input[type="submit"] {
            touch-action: manipulation; /* Disables double-tap zoom */
            -webkit-tap-highlight-color: rgba(0,0,0,0.1); /* Subtle tap feedback */
            -webkit-touch-callout: none; /* Disable callout on long press */
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* Larger touch targets on mobile */
        @media (max-width: 768px) {
            select, 
            button:not(.btn-small), 
            .btn:not(.btn-small) {
                min-height: 44px; /* Apple's recommended touch target */
                padding: 12px 16px;
            }
            
            /* Add small delay before select opens to prevent accidental taps */
            select {
                -webkit-appearance: none;
                appearance: none;
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-left: 4px solid rgba(255, 255, 255, 0.4);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.3);
            border-left-color: rgba(255, 255, 255, 0.6);
        }

        .tab.active {
            background: white;
            color: #667eea;
            font-weight: 600;
            border-left: 4px solid #c0c0c0;
        }

        .card {
            background: var(--card-bg, #f3f0ff); /* Use CSS variable with fallback */
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
            /* Contain content in landscape mode */
            overflow-x: auto;
            overflow-y: visible; /* Let page scroll handle vertical */
            max-width: 100%;
            border-left: 5px solid #c0c0c0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        .card.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
        }
        
        /* Section cards within main cards - consistent grey shadow edge */
        
        /* Sales page specific cards */
        .sales-filter-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .sales-data-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #e0e0e0;
        }
        
        /* Universal content cards for all tabs */
        .content-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .filter-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .data-display-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #e0e0e0;
        }
        .section-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #c0c0c0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }
        
        /* All accent colors now use consistent grey */
        .section-card.accent-blue,
        .section-card.accent-green,
        .section-card.accent-orange,
        .section-card.accent-purple,
        .section-card.accent-red,
        .section-card.accent-teal,
        .section-card.accent-pink,
        .section-card.accent-indigo,
        .section-card.accent-cyan,
        .section-card.accent-amber,
        .section-card.accent-theme,
        .section-card.accent-secondary { 
            border-left-color: #c0c0c0; 
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Table wrapper for horizontal scroll on mobile landscape */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 20px 0;
        }

        .btn {
            background: var(--primary, #667eea);
            color: white;
            border: none;
            border-left: 4px solid rgba(255, 255, 255, 0.4);
            padding: 12px 28px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            border-left-color: rgba(255, 255, 255, 0.6);
        }

        .btn-success {
            background: var(--primary, #667eea);
        }

        .btn-secondary {
            background: var(--secondary, #764ba2) !important;
            color: white !important;
            border-left: 4px solid rgba(255, 255, 255, 0.4) !important;
            opacity: 0.85;
        }
        
        .btn-secondary:hover {
            opacity: 1;
        }
        
        /* Oval filter button styles */
        .oval-filter-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 1 !important;
        }
        
        .oval-filter-btn:active {
            transform: translateY(0) scale(1);
        }
        
        .btn-small {
            background: var(--primary, #667eea);
            color: white;
            border: none;
            border-left: 3px solid rgba(255, 255, 255, 0.4);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            margin-right: 5px;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .btn-small:hover {
            filter: brightness(0.9);
            transform: translateY(-1px);
            border-left-color: rgba(255, 255, 255, 0.6);
        }
        
        .btn-danger {
            background: transparent;
            color: #dc3545;
            border: 1px solid #dc3545;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .btn-danger:hover {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete-icon {
            background: transparent;
            color: #999;
            border: none;
            padding: 4px 8px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .btn-delete-icon:hover {
            background: #ffebee;
            color: #dc3545;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        /* Report Grid Layout */
        .report-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .report-category {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-left: 5px solid #c0c0c0;
        }
        
        .report-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 12px;
        }
        
        .report-category-header:hover {
            opacity: 0.8;
        }
        
        .report-category h4 {
            margin: 0;
            color: #555;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .report-toggle {
            color: #888;
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .report-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .report-buttons.collapsed {
            display: none;
        }
        
        .report-category.collapsed .report-category-header {
            margin-bottom: 0;
        }
        
        .report-btn {
            width: 100%;
            text-align: left;
            padding: 12px 15px !important;
            font-size: 14px !important;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-radius: 8px !important;
            border-left: 4px solid rgba(255,255,255,0.4) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .report-btn:hover {
            transform: translateX(3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .report-btn-green {
            background: linear-gradient(135deg, #28a745, #218838) !important;
            color: white !important;
        }
        
        .report-btn-green:hover {
            background: linear-gradient(135deg, #218838, #1e7e34) !important;
        }
        
        .report-btn-red {
            background: linear-gradient(135deg, #dc3545, #c82333) !important;
            color: white !important;
        }
        
        .report-btn-red:hover {
            background: linear-gradient(135deg, #c82333, #bd2130) !important;
        }
        
        /* Mobile: Stack categories vertically */
        @media (max-width: 600px) {
            .report-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Landscape phone: 2x2 grid */
        @media (min-width: 601px) and (max-width: 900px) {
            .report-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Desktop: 4 columns */
        @media (min-width: 901px) {
            .report-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background: #f8f9ff;
            font-weight: 600;
            color: #667eea;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-table tr:hover {
            background: #f8f9ff;
        }
        
        /* Scrollable table wrapper */
        .table-scroll-wrapper {
            max-height: 60vh;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 15px;
            -webkit-overflow-scrolling: touch;
        }
        
        /* On mobile, don't restrict table height - let page scroll naturally */
        @media (max-width: 768px) {
            .table-scroll-wrapper {
                max-height: none !important;
                overflow-y: visible !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Mobile navigation buttons - slightly smaller */
            #backBtn,
            #backToTopBtn {
                width: 50px !important;
                height: 50px !important;
                font-size: 20px !important;
                left: 15px !important;
            }
            
            #backBtn {
                bottom: 20px !important;
            }
            
            #backToTopBtn {
                bottom: 80px !important;
            }
        }
        
        .table-scroll-wrapper .data-table {
            margin-top: 0;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .line-items-container {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .line-item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 50px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        
        /* Make line item selects and inputs MUCH larger and more visible */
        .line-item-row select,
        .line-item-row input[type="number"],
        .line-items-container select,
        .line-items-container input[type="number"],
        #createPOLineItems select,
        #createPOLineItems input[type="number"],
        #poLineItems select,
        #poLineItems input[type="number"],
        #soLineItems select,
        #soLineItems input[type="number"],
        .edit-line-item select,
        .edit-line-item input[type="number"] {
            padding: 14px 12px !important;
            font-size: 16px !important;
            min-height: 52px;
            border: 2px solid #667eea !important;
            border-radius: 8px !important;
            background: white !important;
        }
        
        /* Item dropdown - make extra wide and prominent */
        .line-item-row select,
        .line-items-container select,
        #createPOLineItems select,
        #poLineItems select,
        #soLineItems select,
        .edit-line-item select {
            font-size: 15px !important;
            font-weight: 500 !important;
            color: #333 !important;
            cursor: pointer;
        }
        
        /* Cases/Qty input - make VERY prominent */
        .line-item-row input[type="number"],
        .line-items-container input[type="number"],
        #createPOLineItems input[type="number"],
        #poLineItems input[type="number"],
        #soLineItems input[type="number"],
        .edit-line-item input[type="number"] {
            font-size: 18px !important;
            font-weight: bold !important;
            text-align: center !important;
            background: #fffde7 !important;
            border: 2px solid #f9a825 !important;
            min-width: 80px;
        }
        
        .line-item-row select:focus,
        .line-items-container select:focus,
        #createPOLineItems select:focus,
        #poLineItems select:focus,
        #soLineItems select:focus,
        .edit-line-item select:focus,
        .line-item-row input:focus,
        .line-items-container input:focus,
        #createPOLineItems input:focus,
        #poLineItems input:focus,
        #soLineItems input:focus,
        .edit-line-item input:focus {
            border-color: var(--primary, #667eea) !important;
            outline: none;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.25);
        }
        
        /* Item dropdown should be wider */
        .createpo-item,
        .so-item,
        .po-item,
        .edit-item {
            min-width: 250px;
        }
        
        /* Quantity/Cases input highlight on focus */
        .createpo-qty:focus,
        .so-qty:focus,
        .po-qty:focus,
        .edit-qty:focus {
            background: #fff59d !important;
            border-color: #f57f17 !important;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .config-box {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        /* ==================== MOBILE RESPONSIVE STYLES ==================== */
        
        /* Tablets and smaller (768px and below) */
        @media (max-width: 768px) {
            /* Ensure body can scroll properly on mobile */
            html, body {
                overflow-x: hidden !important;
                overflow-y: auto !important;
                height: auto !important;
                position: static !important;
            }
            
            body {
                padding: 10px;
            }
            
            /* Override stuck modal states on mobile */
            body.modal-open {
                position: static !important;
                overflow-y: auto !important;
                height: auto !important;
                overscroll-behavior: none !important;
            }
            
            /* Prevent scroll chaining on modals */
            #reportSetupModal,
            #orderModal {
                overscroll-behavior: contain !important;
            }
            
            /* Floating Settings Gear - smaller on mobile */
            div[onclick="switchTab('config')"][style*="position: fixed"][style*="top: 20px"] {
                width: 45px !important;
                height: 45px !important;
                top: 15px !important;
                right: 15px !important;
            }
            
            div[onclick="switchTab('config')"][style*="position: fixed"] span {
                font-size: 20px !important;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .tabs {
                gap: 5px;
            }
            
            .tab {
                padding: 10px 16px;
                font-size: 14px;
                flex: 1 1 auto;
            }
            
            .card {
                padding: 15px;
                border-radius: 12px;
                overflow-x: hidden; /* Prevent horizontal issues on mobile */
                overflow-y: visible; /* Let page scroll */
            }
            
            /* Stack form fields vertically on mobile */
            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 15px;
            }
            
            /* Make line items stack vertically */
            .line-item-row {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }
            
            .line-item-row select,
            .line-item-row input {
                width: 100%;
            }
            
            .remove-btn {
                width: 100%;
                padding: 12px;
            }
            
            /* Make tables scrollable horizontally */
            .data-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px;
                font-size: 14px;
            }
            
            /* Stack buttons vertically */
            .btn {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .btn-small {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            /* ========== CREATE PO LINE ITEMS MOBILE RESPONSIVE ========== */
            
            /* Remove horizontal scroll wrapper on mobile */
            #createPOLineItemsWrapper {
                overflow-x: visible !important;
                overflow-y: visible !important;
            }
            
            #createPOLineItemsInner {
                overflow: visible !important;
                min-width: 100% !important;
                width: 100% !important;
            }
            
            /* Hide the grid header on mobile (too many columns) */
            #createPOLineItemsHeader {
                display: none !important;
            }
            
            /* Make line items container not use grid */
            #createPOLineItems {
                border: none !important;
                border-radius: 0 !important;
                padding: 0 !important;
                background: transparent !important;
            }
            
            /* Make each line item a vertical card on mobile */
            #createPOLineItems .line-item-row {
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
                padding: 15px !important;
                background: white !important;
                border: 2px solid var(--primary, #667eea) !important;
                border-radius: 12px !important;
                margin-bottom: 15px !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            }
            
            /* Each field container gets full width */
            #createPOLineItems .line-item-row > div {
                width: 100% !important;
                margin-top: 0 !important;
            }
            
            /* Show labels on mobile (they're already there) */
            #createPOLineItems .line-item-row label {
                display: block !important;
                font-weight: 600 !important;
                margin-bottom: 5px !important;
                font-size: 14px !important;
                color: #555 !important;
            }
            
            /* Make selects and inputs full width with better touch targets */
            #createPOLineItems .line-item-row select,
            #createPOLineItems .line-item-row input[type="number"] {
                width: 100% !important;
                min-height: 52px !important;
                font-size: 16px !important;
                padding: 14px 12px !important;
            }
            
            /* Delete button full width at bottom */
            #createPOLineItems .line-item-row button {
                width: 100% !important;
                margin-top: 0 !important;
                padding: 14px !important;
                font-size: 16px !important;
            }
            
            /* Computed values - add labels and make prominent */
            #createPOLineItems .createpo-units,
            #createPOLineItems .createpo-totalunits,
            #createPOLineItems .createpo-cost,
            #createPOLineItems .createpo-linetotal {
                font-size: 18px !important;
                padding: 12px !important;
                font-weight: bold !important;
                border-radius: 8px !important;
            }
            
            /* Add visual labels for computed values on mobile */
            #createPOLineItems .createpo-units::before {
                content: "Units/Case: ";
                font-weight: 600;
                font-size: 14px;
                color: #555;
                display: block;
                margin-bottom: 4px;
            }
            
            #createPOLineItems .createpo-totalunits::before {
                content: "Total Units: ";
                font-weight: 600;
                font-size: 14px;
                color: #555;
                display: block;
                margin-bottom: 4px;
            }
            
            #createPOLineItems .createpo-cost::before {
                content: "Catalog Cost: ";
                font-weight: 600;
                font-size: 14px;
                color: #555;
                display: block;
                margin-bottom: 4px;
            }
            
            #createPOLineItems .createpo-linetotal::before {
                content: "Line Total: ";
                font-weight: 600;
                font-size: 14px;
                color: #555;
                display: block;
                margin-bottom: 4px;
            }
            
            /* Make the Order Summary sticky work better on mobile */
            #createPOForm .content-card[style*="position: sticky"] {
                position: sticky !important;
                top: 60px !important;
                z-index: 9 !important;
                margin-bottom: 20px !important;
            }
            
            /* Make Order Summary cards stack on mobile */
            #createPOForm .content-card[style*="position: sticky"] > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            /* ========== SALES ORDER LINE ITEMS MOBILE RESPONSIVE ========== */
            
            /* Make SO line items container not use grid border */
            #soLineItems {
                border: none !important;
                padding: 0 !important;
                background: transparent !important;
            }
            
            /* Make each SO line item a vertical card on mobile */
            #soLineItems .line-item-row {
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
                padding: 15px !important;
                background: white !important;
                border: 2px solid var(--primary, #667eea) !important;
                border-radius: 12px !important;
                margin-bottom: 15px !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            }
            
            /* Each field container gets full width */
            #soLineItems .line-item-row > div {
                width: 100% !important;
            }
            
            /* Show labels on mobile */
            #soLineItems .line-item-row label {
                display: block !important;
                font-weight: 600 !important;
                margin-bottom: 5px !important;
                font-size: 14px !important;
                color: #555 !important;
                text-align: left !important;
            }
            
            /* Make selects and inputs full width with better touch targets */
            #soLineItems .line-item-row select,
            #soLineItems .line-item-row input[type="number"] {
                width: 100% !important;
                min-height: 52px !important;
                font-size: 16px !important;
                padding: 14px 12px !important;
            }
            
            /* Stock info full width */
            #soLineItems .so-stock-info {
                grid-column: 1 !important;
            }
            
            /* Remove button full width */
            #soLineItems .line-item-row .remove-btn {
                width: 100% !important;
                margin-top: 0 !important;
                padding: 14px !important;
                font-size: 16px !important;
            }
            
            /* Make Add Sale Form summary cards stack */
            #addSaleForm .content-card > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            /* ========== ORDER MODAL LINE ITEMS MOBILE RESPONSIVE ========== */
            
            /* Make modal line items stack vertically */
            #orderModal .line-items-container {
                border: none !important;
                padding: 0 !important;
                background: transparent !important;
            }
            
            #orderModal .line-item-row,
            #orderModal .edit-line-item {
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
                padding: 15px !important;
                background: white !important;
                border: 2px solid var(--primary, #667eea) !important;
                border-radius: 12px !important;
                margin-bottom: 15px !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            }
            
            #orderModal .line-item-row > div,
            #orderModal .edit-line-item > div {
                width: 100% !important;
            }
            
            #orderModal .line-item-row label,
            #orderModal .edit-line-item label {
                display: block !important;
                font-weight: 600 !important;
                margin-bottom: 5px !important;
                font-size: 14px !important;
                color: #555 !important;
                text-align: left !important;
            }
            
            #orderModal .line-item-row select,
            #orderModal .line-item-row input,
            #orderModal .edit-line-item select,
            #orderModal .edit-line-item input {
                width: 100% !important;
                min-height: 52px !important;
                font-size: 16px !important;
            }
            
            #orderModal .line-item-row button,
            #orderModal .edit-line-item button {
                width: 100% !important;
                margin-top: 0 !important;
                padding: 14px !important;
                font-size: 16px !important;
            }
            
            /* Make order modal responsive */
            #orderModal > div {
                max-width: 100% !important;
                margin: 0 !important;
                border-radius: 0 !important;
                max-height: 100% !important;
                height: 100% !important;
            }
            
            #orderModalHeader {
                border-radius: 0 !important;
            }
        }
        
        /* Phones (480px and below) */
        @media (max-width: 480px) {
            /* Floating Settings Gear - even smaller on small phones */
            div[onclick="switchTab('config')"][style*="position: fixed"][style*="top: 20px"] {
                width: 40px !important;
                height: 40px !important;
                top: 10px !important;
                right: 10px !important;
            }
            
            div[onclick="switchTab('config')"][style*="position: fixed"] span {
                font-size: 18px !important;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .card {
                padding: 10px;
            }
            
            .form-group label {
                font-size: 14px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 10px;
            }
            
            /* Make table text smaller on very small screens */
            .data-table th,
            .data-table td {
                padding: 6px;
                font-size: 12px;
            }
            
            /* Smaller buttons on very small screens */
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            /* Responsive inventory summary numbers - smaller on mobile to prevent wrapping */
            .inv-summary-number {
                font-size: 18px !important; /* Much smaller on mobile */
            }
            
            /* Oval filter buttons - better mobile layout */
            .oval-filter-btn {
                font-size: 11px !important;
                padding: 6px 12px !important;
            }
            
            /* Sales page cards - reduce padding on mobile for better fit */
            .sales-filter-card {
                padding: 10px !important;
                margin-bottom: 15px !important;
            }
            
            .sales-data-card {
                padding: 12px !important;
            }
            
            /* Universal content cards - reduce padding on mobile */
            .content-card,
            .data-display-card {
                padding: 12px !important;
                margin-bottom: 15px !important;
            }
            
            .filter-card {
                padding: 10px !important;
                margin-bottom: 15px !important;
            }
            
            /* Report Modal - Mobile Optimizations */
            #reportSetupModal {
                padding: 0 !important;
            }
            
            /* Modal container - fixed, flex layout, no scroll */
            #reportSetupModal > div {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                margin: 0 !important;
                border-radius: 0 !important;
                overflow: hidden !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            #reportSetupHeader {
                position: relative !important;
                top: auto !important;
                z-index: 10 !important;
                padding: 12px 15px !important;
                flex-wrap: nowrap !important;
                flex-shrink: 0 !important;
            }
            
            #reportSetupHeader h2 {
                font-size: 16px !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                max-width: calc(100% - 50px) !important;
            }
            
            #reportSetupFilters {
                padding: 12px !important;
                margin-top: 0 !important;
                flex-shrink: 0 !important;
            }
            
            /* Content area - THIS SCROLLS */
            #reportSetupContent {
                flex: 1 !important;
                min-height: 0 !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                padding: 12px !important;
                padding-bottom: 80px !important;
            }
            
            /* Report Modal Footer - Ensure buttons are visible */
            #reportSetupFooter {
                position: relative !important;
                bottom: auto !important;
                left: auto !important;
                right: auto !important;
                width: 100% !important;
                padding: 10px 12px !important;
                gap: 8px !important;
                z-index: 10 !important;
                flex-shrink: 0 !important;
            }
        }
        
        /* Portrait orientation on mobile - standard scroll behavior */
        @media (max-width: 768px) and (orientation: portrait) {
            html, body {
                overflow-x: hidden;
                overflow-y: auto !important;
                height: auto !important;
                min-height: 100vh;
                position: static !important;
                width: 100% !important;
            }
            
            /* Override any stuck modal-open state on mobile */
            body.modal-open {
                position: static !important;
                overflow-y: auto !important;
            }
            
            #reportSetupModal {
                padding: 0 !important;
            }
            
            /* Modal container - fixed, no scroll */
            #reportSetupModal > div,
            #reportSetupModalInner {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                max-width: 100% !important;
                min-width: 0 !important; /* Override inline min-width: 500px */
                min-height: 0 !important; /* Override inline min-height */
                margin: 0 !important;
                border-radius: 0 !important;
                overflow: hidden !important; /* DON'T scroll here */
                display: flex !important;
                flex-direction: column !important;
                resize: none !important; /* Disable resize on mobile */
            }
            
            /* Header - fixed at top */
            #reportSetupHeader {
                position: relative !important;
                top: auto !important;
                flex-shrink: 0 !important;
                z-index: 10 !important;
                background: var(--primary, #667eea) !important;
                border-radius: 0 !important;
            }
            
            /* Filters area - below header */
            #reportSetupFilters {
                margin-top: 0 !important;
                flex-shrink: 0 !important;
            }
            
            /* CONTENT AREA - THIS IS WHAT SCROLLS */
            #reportSetupContent {
                flex: 1 !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                padding: 12px !important;
                padding-bottom: 80px !important;
                min-height: 0 !important; /* Important for flex scrolling */
                touch-action: pan-y !important; /* Allow vertical scrolling */
                overscroll-behavior: contain !important; /* Prevent scroll chaining */
                contain: layout style !important; /* Contain layout to prevent escape */
            }
            
            /* Action Dashboard specific containment */
            #reportSetupContent .action-dashboard-container {
                width: 100% !important;
                max-width: 100% !important;
                overflow: visible !important;
            }
            
            #reportSetupContent .action-section {
                max-width: 100% !important;
                overflow-x: auto !important;
            }
            
            #reportSetupContent table {
                max-width: 100% !important;
                display: block !important;
                overflow-x: auto !important;
            }
            
            /* Prevent touch issues on modal */
            #reportSetupModalInner,
            #reportSetupModal > div {
                touch-action: auto !important;
                overscroll-behavior: contain !important;
            }
            
            /* Ensure canvases don't capture touch events */
            #reportSetupContent canvas {
                touch-action: none !important;
                pointer-events: none !important;
            }
            
            /* Chart grid on mobile - single column */
            #reportSetupContent div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Constrain chart containers on mobile */
            #reportSetupContent canvas {
                max-width: 100% !important;
                max-height: 180px !important;
                width: 100% !important;
            }
            
            #reportSetupContent canvas.print-chart {
                max-width: 100% !important;
                height: auto !important;
                max-height: 180px !important;
                width: 100% !important;
            }
            
            /* Chart container divs - force overflow clip */
            #reportSetupContent div[style*="height: 200px"],
            #reportSetupContent div[style*="height: 200px; overflow: hidden"] {
                height: 180px !important;
                max-height: 180px !important;
                overflow: hidden !important;
                position: relative !important;
            }
            
            /* Chart card containers */
            #reportSetupContent div[style*="box-shadow"] {
                max-width: 100% !important;
                overflow: hidden !important;
            }
            
            /* Footer - fixed at bottom */
            #reportSetupFooter {
                position: relative !important;
                bottom: auto !important;
                left: auto !important;
                right: auto !important;
                width: 100% !important;
                border-radius: 0 !important;
                z-index: 10 !important;
                flex-shrink: 0 !important;
            }
        }
        
        /* Landscape orientation on mobile devices */
        @media (max-height: 600px) and (orientation: landscape) {
            /* Report Modal in Landscape - proper scrolling */
            #reportSetupModal > div,
            #reportSetupModalInner {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                max-width: 100% !important;
                min-width: 0 !important;
                min-height: 0 !important;
                margin: 0 !important;
                border-radius: 0 !important;
                overflow: hidden !important;
                display: flex !important;
                flex-direction: column !important;
                resize: none !important;
            }
            
            #reportSetupHeader {
                position: relative !important;
                flex-shrink: 0 !important;
                padding: 8px 12px !important;
            }
            
            #reportSetupHeader h2 {
                font-size: 14px !important;
            }
            
            #reportSetupFilters {
                margin-top: 0 !important;
                flex-shrink: 0 !important;
                padding: 8px !important;
            }
            
            #reportSetupContent {
                flex: 1 !important;
                min-height: 0 !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                padding: 8px !important;
                padding-bottom: 60px !important;
                touch-action: pan-y !important;
                overscroll-behavior: contain !important;
            }
            
            #reportSetupFooter {
                position: relative !important;
                flex-shrink: 0 !important;
                padding: 6px 10px !important;
            }
            
            html, body {
                overflow-x: auto;
                overflow-y: auto;
                height: auto;
                min-height: 100vh;
            }
            
            body {
                padding: 5px;
                min-height: 100vh;
                height: auto;
            }
            
            /* Floating Settings Gear - compact in landscape */
            div[onclick="switchTab('config')"][style*="position: fixed"][style*="top: 20px"] {
                width: 35px !important;
                height: 35px !important;
                top: 8px !important;
                right: 8px !important;
            }
            
            div[onclick="switchTab('config')"][style*="position: fixed"] span {
                font-size: 16px !important;
            }
            
            .container {
                max-width: 100%;
                padding: 0 5px;
                height: auto;
            }
            
            .header {
                margin-bottom: 5px;
            }
            
            .header h1 {
                font-size: 1.1em;
                margin-bottom: 3px;
            }
            
            .header p {
                font-size: 0.75em;
                margin: 0;
            }
            
            /* CRITICAL: Make navigation single-row horizontal scroll in landscape */
            /* Outer wrapper - reduce padding dramatically */
            body > .container > div[style*="position: static"][style*="border: 3px solid"] {
                padding: 2px !important;
                margin: 0px 2px 5px 2px !important;
                border-width: 2px !important;
            }
            
            /* Inner grid container - make it horizontal scroll with ALL cards in ONE row */
            body > .container > div[style*="position: static"] > div[style*="grid-template-columns"] {
                display: flex !important;
                flex-direction: row !important;
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                gap: 4px !important;
                padding: 4px 6px !important;
                scrollbar-width: thin !important;
            }
            
            /* Navigation cards - compact size for landscape */
            .landing-nav-card {
                flex: 0 0 auto !important;
                min-width: 60px !important;
                max-width: 60px !important;
                padding: 4px 3px !important;
                margin: 0 !important;
            }
            
            .landing-nav-card div[style*="font-size: 24px"] {
                font-size: 18px !important;
                margin-bottom: 2px !important;
            }
            
            .landing-nav-card h3 {
                font-size: 8px !important;
                line-height: 1.2 !important;
                margin: 0 !important;
            }
            
            .tabs {
                margin-bottom: 5px;
                gap: 3px;
            }
            
            .tab {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .card {
                padding: 8px;
                height: auto;
                max-height: none !important;
                overflow-y: visible !important;
            }
            
            /* Make tables scroll horizontally in landscape */
            .data-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
                max-width: 100%;
            }
            
            .data-table th,
            .data-table td {
                padding: 6px 8px;
                font-size: 11px;
            }
            
            /* Compact form fields in landscape */
            .form-group {
                margin-bottom: 8px;
            }
            
            .form-group label {
                font-size: 12px;
                margin-bottom: 3px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 6px;
                font-size: 14px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .btn-small {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            /* Reduce spacing in landscape */
            .form-grid {
                gap: 8px;
            }
        }
        
        /* ==================== COMPLETE THEME SYSTEM ==================== */
        
        /* Ocean Blue Theme */
        body.theme-ocean {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
        }
        body.theme-ocean .btn,
        body.theme-ocean .btn-small {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
        }
        body.theme-ocean .btn-success {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%) !important;
        }
        body.theme-ocean .btn-danger {
            background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%) !important;
        }
        body.theme-ocean .tab.active {
            color: #1e3c72 !important;
        }
        body.theme-ocean .tab:hover {
            background: rgba(30, 60, 114, 0.3) !important;
        }
        
        /* Forest Green Theme */
        body.theme-forest {
            background: linear-gradient(135deg, #134e4a 0%, #059669 100%) !important;
        }
        body.theme-forest .btn,
        body.theme-forest .btn-small {
            background: linear-gradient(135deg, #134e4a 0%, #059669 100%) !important;
        }
        body.theme-forest .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%) !important;
        }
        body.theme-forest .btn-danger {
            background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%) !important;
        }
        body.theme-forest .tab.active {
            color: #134e4a !important;
        }
        body.theme-forest .tab:hover {
            background: rgba(19, 78, 74, 0.3) !important;
        }
        
        /* Sunset Orange Theme */
        body.theme-sunset {
            background: linear-gradient(135deg, #c2410c 0%, #ea580c 100%) !important;
        }
        body.theme-sunset .btn,
        body.theme-sunset .btn-small {
            background: linear-gradient(135deg, #c2410c 0%, #ea580c 100%) !important;
        }
        body.theme-sunset .btn-success {
            background: linear-gradient(135deg, #ea580c 0%, #f97316 100%) !important;
        }
        body.theme-sunset .btn-danger {
            background: linear-gradient(135deg, #991b1b 0%, #b91c1c 100%) !important;
        }
        body.theme-sunset .tab.active {
            color: #c2410c !important;
        }
        body.theme-sunset .tab:hover {
            background: rgba(194, 65, 12, 0.3) !important;
        }
        
        /* Professional Dark Theme */
        body.theme-dark {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%) !important;
        }
        body.theme-dark .btn,
        body.theme-dark .btn-small {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%) !important;
        }
        body.theme-dark .btn-success {
            background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%) !important;
        }
        body.theme-dark .btn-danger {
            background: linear-gradient(135deg, #991b1b 0%, #b91c1c 100%) !important;
        }
        body.theme-dark .tab {
            background: rgba(255, 255, 255, 0.15) !important;
        }
        body.theme-dark .tab.active {
            background: white !important;
            color: #1f2937 !important;
            border-left: 4px solid #c0c0c0 !important;
        }
        body.theme-dark .tab:hover {
            background: rgba(255, 255, 255, 0.25) !important;
        }
        body.theme-dark .card {
            background: #f9fafb !important;
        }
        
        /* Crimson Red Theme */
        body.theme-crimson {
            background: linear-gradient(135deg, #be123c 0%, #e11d48 100%) !important;
        }
        body.theme-crimson .btn,
        body.theme-crimson .btn-small {
            background: linear-gradient(135deg, #be123c 0%, #e11d48 100%) !important;
        }
        body.theme-crimson .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%) !important;
        }
        body.theme-crimson .tab.active {
            color: #be123c !important;
        }
        body.theme-crimson .tab:hover {
            background: rgba(190, 18, 60, 0.3) !important;
        }
        
        /* Slate Gray Theme */
        body.theme-slate {
            background: linear-gradient(135deg, #475569 0%, #64748b 100%) !important;
        }
        body.theme-slate .btn,
        body.theme-slate .btn-small {
            background: linear-gradient(135deg, #475569 0%, #64748b 100%) !important;
        }
        body.theme-slate .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%) !important;
        }
        body.theme-slate .tab.active {
            color: #475569 !important;
        }
        body.theme-slate .tab:hover {
            background: rgba(71, 85, 105, 0.3) !important;
        }
        
        /* Teal Theme */
        body.theme-teal {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%) !important;
        }
        body.theme-teal .btn,
        body.theme-teal .btn-small {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%) !important;
        }
        body.theme-teal .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%) !important;
        }
        body.theme-teal .tab.active {
            color: #0d9488 !important;
        }
        body.theme-teal .tab:hover {
            background: rgba(13, 148, 136, 0.3) !important;
        }
        
        /* Royal Purple Theme (Default) */
        body.theme-purple {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        body.theme-purple .btn,
        body.theme-purple .btn-small {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        body.theme-purple .btn-success {
            background: linear-gradient(135deg, #764ba2 0%, #9333ea 100%) !important;
        }
        body.theme-purple .btn-danger {
            background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%) !important;
        }
        body.theme-purple .tab.active {
            color: #667eea !important;
        }
        body.theme-purple .tab:hover {
            background: rgba(102, 126, 234, 0.3) !important;
        }
        
        
        /* Landing Page Navigation Cards */
        .landing-nav-card {
            transform: translateY(0) scale(1);
        }
        
        .landing-nav-card:hover {
            transform: translateY(-8px) scale(1.02) !important;
            box-shadow: 0 12px 30px rgba(0,0,0,0.2) !important;
        }
        
        .landing-nav-card:active {
            transform: translateY(-4px) scale(1.01) !important;
        }
        
        /* Navigation Container - Uses dynamic CSS variable to match card theme */
        .nav-container {
            background: transparent !important; /* Transparent to show body background */
            border-radius: 0;
            margin: 0 -20px; /* Extend to edges to blend with body */
            padding: 10px 40px 20px 40px;
        }
        
        /* Desktop Modal Features - Draggable & Resizable */
        @media (min-width: 769px) {
            /* Add resize handle indicator to modals on desktop */
            .resizable-added::after {
                content: '';
                position: absolute;
                bottom: 5px;
                right: 5px;
                font-size: 20px;
                color: #999;
                pointer-events: none;
                line-height: 1;
            }
            
            /* Center modals initially */
            #orderModal > div,
            #orderModalInner,
            #reportSetupModal > div,
            #reportSetupModalInner,
            .item-picker-container {
                position: relative;
                margin: 50px auto !important;
            }
        }
        
        /* Mobile - keep modals full screen friendly */
        @media (max-width: 768px) {
            /* Modal containers - allow inner content to scroll */
            #orderModal,
            #reportSetupModal,
            #howToGuideModal,
            #uploadItemsModal,
            #itemPickerModal,
            #customerPickerModal,
            #supplierPickerModal {
                padding: 0 !important;
                z-index: 99999 !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
            }
            
            /* Inner modal content - scrollable */
            #orderModal > div,
            #orderModalInner,
            #reportSetupModal > div,
            #reportSetupModalInner,
            #howToGuideModal > div,
            #uploadItemsModal > div,
            .item-picker-container {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
                max-height: 100% !important;
                min-width: 0 !important;
                min-height: 0 !important;
                width: 100% !important;
                height: 100% !important;
                transform: none !important;
                border-radius: 0 !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
                z-index: 100000 !important;
                resize: none !important; /* Disable resize on mobile */
            }
        }
        
        /* Modal resize handle styles */
        #orderModalInner,
        #reportSetupModalInner {
            position: relative;
        }
        
        #orderModalInner::after,
        #reportSetupModalInner::after {
            content: '';
            position: absolute;
            bottom: 5px;
            right: 8px;
            font-size: 14px;
            color: #aaa;
            pointer-events: none;
        }
        
        #orderModalInner:hover::after,
        #reportSetupModalInner:hover::after {
            color: #667eea;
        }
        
        /* ==================== IN-PLACE PRINT STYLES ==================== */
        @media print {
            /* Reset everything for print */
            * {
                position: static !important;
                float: none !important;
                overflow: visible !important;
                visibility: visible !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }
            
            /* Hide everything except report content */
            body > *:not(#reportSetupModal) {
                display: none !important;
            }
            
            /* Hide these elements from main page */
            .container, .header, .nav-container, #settingsBtn, #envBadge,
            .tab-content:not(#reports), #orderModal, #itemPickerModal,
            #supplierPickerModal, #customerPickerModal, #uomPickerModal {
                display: none !important;
            }
            
            /* Reset body for printing */
            body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                overflow: visible !important;
                height: auto !important;
                width: 100% !important;
            }
            
            html {
                overflow: visible !important;
                height: auto !important;
            }
            
            /* Show and reset the report modal */
            #reportSetupModal {
                display: block !important;
                position: static !important;
                left: auto !important;
                top: auto !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
                z-index: auto !important;
            }
            
            #reportSetupModalInner {
                position: static !important;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                max-height: none !important;
                min-height: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                overflow: visible !important;
                display: block !important;
            }
            
            /* Hide modal header, filters, and footer when printing */
            #reportSetupHeader,
            #reportSetupFilters,
            #reportSetupFooter {
                display: none !important;
            }
            
            /* Report content flows naturally */
            #reportSetupContent {
                padding: 0.25in !important;
                overflow: visible !important;
                height: auto !important;
                max-height: none !important;
                min-height: 0 !important;
                display: block !important;
                position: static !important;
            }
            
            /* Show chart images, hide canvases */
            .print-chart-image {
                display: block !important;
                max-width: 100% !important;
                height: auto !important;
            }
            
            canvas.print-chart,
            canvas {
                display: none !important;
            }
            
            /* Table styling for print */
            table {
                width: 100% !important;
                border-collapse: collapse !important;
                font-size: 9pt !important;
                page-break-inside: auto !important;
            }
            
            thead {
                display: table-header-group !important;
            }
            
            tbody {
                display: table-row-group !important;
            }
            
            tr {
                page-break-inside: avoid !important;
            }
            
            th {
                background: #333 !important;
                color: white !important;
                padding: 6px !important;
                font-size: 9pt !important;
                border: 1px solid #333 !important;
            }
            
            td {
                border: 1px solid #ccc !important;
                padding: 4px 6px !important;
                font-size: 9pt !important;
            }
            
            /* Headers and sections */
            h1, h2, h3, h4 {
                page-break-after: avoid !important;
            }
            
            /* Prevent orphaned content */
            p, li, .content-card, .biz-section, .backorder-section, .action-section {
                page-break-inside: avoid !important;
            }
            
            /* KPI grids - simpler for print */
            .biz-kpi-grid, .backorder-kpi-grid, .pl-summary {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 10px !important;
            }
            
            .biz-kpi, .backorder-kpi, .pl-stat {
                flex: 1 1 100px !important;
                padding: 8px !important;
                border: 1px solid #ccc !important;
                background: white !important;
            }
            
            /* Hide buttons and interactive elements */
            button, .btn, .create-po-btn, .oval-action-btn, input[type="number"],
            input[type="checkbox"], .pl-print-btn {
                display: none !important;
            }
            
            /* Simplify gradients for print */
            [style*="linear-gradient"] {
                background: #f0f0f0 !important;
            }
            
            /* Action dashboard sections */
            .action-section, .backorder-section, .customer-card {
                border: 1px solid #ccc !important;
                margin-bottom: 10px !important;
                page-break-inside: avoid !important;
            }
            
            /* Links should be plain text */
            a {
                color: #333 !important;
                text-decoration: none !important;
            }
            
            /* Page setup */
            @page {
                margin: 0.5in;
                size: auto;
            }
        }
    </style>
    <link rel="stylesheet" href="sports-themes.css">
    <!-- Chart.js for report visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        // Disable ALL Chart.js animations globally to prevent looping
        Chart.defaults.animation = false;
        Chart.defaults.animations = {};
        Chart.defaults.transitions = {};
        Chart.defaults.responsive = false;
        Chart.defaults.maintainAspectRatio = false;
    </script>
</head>
<body class="theme-purple">
    <!-- Immediate theme application -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'purple';
            document.body.className = 'theme-' + savedTheme;
        })();
    </script>
    <div class="container">
        <div class="header" onclick="showSplashScreen(true)" style="cursor: pointer;" title="Click to lock screen">
            <h1> Nowak Distributing <span style="transform: scaleX(-1); display: inline-block;"></span></h1>
            <p>Professional Inventory & Order Management System</p>
        </div>

        <!-- Environment Indicator Circle - Top Left Corner (matches Settings icon style) -->
        <div id="envBadge" onclick="switchTab('config')" style="position: fixed; top: 20px; left: 20px; z-index: 1001; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: opacity 0.3s ease, transform 0.3s ease; background: var(--primary, #667eea); font-weight: 800; font-size: 22px; color: white;" title="Production Environment - Click to change" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
            P
        </div>

        <!-- Floating Settings Gear Icon - Top Right Corner -->
        <div id="settingsBtn" onclick="switchTab('config')" style="position: fixed; top: 20px; right: 20px; z-index: 1001; background: var(--primary, #667eea); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: opacity 0.3s ease, transform 0.3s ease;" onmouseover="this.style.transform='rotate(90deg) scale(1.1)'" onmouseout="this.style.transform='rotate(0deg) scale(1)'" title="Settings">
            <span style="font-size: 24px;"></span>
        </div>

        <!-- Navigation Cards - Always Visible at Top -->
        <!-- Navigation Cards - Seamless with body background - V9j -->
        <div class="nav-container">
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px;">
                
                <!-- Reports Card - FIRST -->
                <div class="landing-nav-card active-nav-card" onclick="switchTab('reports')" style="background: rgba(255,255,255,0.95); color: #4c1d95; padding: 8px 6px; border: 2px solid #4c1d95; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Reports</h3>
                </div>

                <!-- Suppliers Card -->
                <div class="landing-nav-card" onclick="switchTab('suppliers')" style="background: rgba(255,255,255,0.95); color: #1e3a8a; padding: 8px 6px; border: 2px solid #1e3a8a; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Suppliers</h3>
                </div>

                <!-- Items Card -->
                <div class="landing-nav-card" onclick="switchTab('items')" style="background: rgba(255,255,255,0.95); color: #475569; padding: 8px 6px; border: 2px solid #475569; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Items</h3>
                </div>

                <!-- Customers Card -->
                <div class="landing-nav-card" onclick="switchTab('customers')" style="background: rgba(255,255,255,0.95); color: #0369a1; padding: 8px 6px; border: 2px solid #0369a1; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Customers</h3>
                </div>

                <!-- Create PO Card -->
                <div class="landing-nav-card" onclick="switchTab('createpo')" style="background: rgba(255,255,255,0.95); color: #0f766e; padding: 8px 6px; border: 2px solid #0f766e; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Create PO</h3>
                </div>

                <!-- Purchases Card -->
                <div class="landing-nav-card" onclick="switchTab('purchases')" style="background: rgba(255,255,255,0.95); color: #4338ca; padding: 8px 6px; border: 2px solid #4338ca; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Purchases</h3>
                </div>

                <!-- Sales Card -->
                <div class="landing-nav-card" onclick="switchTab('sales')" style="background: rgba(255,255,255,0.95); color: #065f46; padding: 8px 6px; border: 2px solid #065f46; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Sales</h3>
                </div>

                <!-- Inventory Card -->
                <div class="landing-nav-card" onclick="switchTab('inventory')" style="background: rgba(255,255,255,0.95); color: #374151; padding: 8px 6px; border: 2px solid #374151; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Inventory</h3>
                </div>

                <!-- Price Simulator Card -->
                <div class="landing-nav-card" onclick="switchTab('pricesim')" style="background: rgba(255,255,255,0.95); color: #1e40af; padding: 8px 6px; border: 2px solid #1e40af; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Price Sim</h3>
                </div>

                <!-- Help & Guides Card -->
                <div class="landing-nav-card" onclick="switchTab('guides')" style="background: rgba(255,255,255,0.95); color: #059669; padding: 8px 6px; border: 2px solid #059669; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 2px;"></div>
                    <h3 style="margin: 0; font-size: 11px; font-weight: 600;">Help</h3>
                </div>
            </div>
        </div>
        
        <!-- Floating Navigation Buttons - Bottom Left Corner -->
        <!-- Back to Top Button - Top -->
        <button id="backToTopBtn" onclick="scrollToTop()" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" style="display: none; position: fixed; bottom: 100px; left: 30px; z-index: 1000; background: var(--primary, #667eea); color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.3s ease;" title="Back to top">
            
        </button>
        
        <!-- Back Button - Bottom -->
        <button id="backBtn" onclick="goBack()" style="display: none; position: fixed; bottom: 30px; left: 30px; z-index: 1000; background: var(--primary, #667eea); color: white; border: none; border-left: 4px solid rgba(255,255,255,0.4); border-radius: 50%; width: 60px; height: 60px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="Go back to previous tab">
            
        </button>

        <!-- Settings Tab -->
        <div id="config" class="card">
            <h2>System Configuration</h2>
            <div class="status" id="configStatus"></div>
            
            <!-- Theme Selection - First and prominent -->
            <div style="margin-bottom: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;"> Theme</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('themeSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="themeSection-toggle"> Hide</span>
                    </button>
                </div>
                <div id="themeSection">
                    <p style="margin-bottom: 10px; color: #666;">
                        Choose your color scheme (280+ options!)
                    </p>
                    <div onclick="openThemePicker()" style="cursor: pointer; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; background: white; display: flex; align-items: center; gap: 15px; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary, #667eea)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                        <div id="themePreviewSwatch" style="width: 50px; height: 50px; border-radius: 10px; background: var(--primary, #667eea); box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>
                        <div style="flex: 1;">
                            <div id="themePreviewName" style="font-weight: 600; font-size: 16px; color: #333;"> Royal Purple</div>
                            <div style="font-size: 13px; color: #888;">Click to browse 280+ themes</div>
                        </div>
                        <div style="font-size: 24px; color: #999;"></div>
                    </div>
                    <input type="hidden" id="themeSelector" value="purple">
                    
                    <!-- Splash Screen Settings -->
                    <div style="margin-top: 15px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; background: #f8f9fa;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 600; font-size: 16px; color: #333;"> Splash Screen</div>
                                <div style="font-size: 12px; color: #888;">Show landing page when app opens</div>
                            </div>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="splashScreenEnabled" onchange="saveSplashSettings()" style="width: 20px; height: 20px; cursor: pointer;">
                                <span style="margin-left: 8px; font-size: 14px;">Enabled</span>
                            </label>
                        </div>
                        <div id="splashBackgroundOptions" style="margin-top: 10px;">
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Background:</label>
                            <select id="splashBackground" onchange="saveSplashSettings()" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                                <optgroup label=" Chicago Cubs">
                                    <option value="cubs1">Cubs 1</option>
                                    <option value="cubs2">Cubs 2</option>
                                    <option value="cubs3">Cubs 3</option>
                                    <option value="cubs4">Cubs 4</option>
                                    <option value="cubs5">Cubs 5</option>
                                </optgroup>
                                <optgroup label=" Chicago Bears">
                                    <option value="bears1">Bears 1</option>
                                    <option value="bears2">Bears 2</option>
                                    <option value="bears3">Bears 3</option>
                                    <option value="bears4">Bears 4</option>
                                    <option value="bears5">Bears 5</option>
                                </optgroup>
                                <optgroup label=" Gradients">
                                    <option value="gradient-blue">Blue Gradient</option>
                                    <option value="gradient-purple">Purple Gradient</option>
                                    <option value="gradient-green">Green Gradient</option>
                                    <option value="gradient-sunset">Sunset Gradient</option>
                                    <option value="gradient-dark">Dark Gradient</option>
                                </optgroup>
                                <optgroup label=" Custom">
                                    <option value="custom">Custom URL...</option>
                                </optgroup>
                            </select>
                            <input type="text" id="splashCustomUrl" placeholder="Enter image URL..." style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd; margin-top: 8px; display: none;" onchange="saveSplashSettings()">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Backup Data Section -->
            <div style="margin-bottom: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;"> Backup Data</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('backupSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="backupSection-toggle"> Hide</span>
                    </button>
                </div>
                <div id="backupSection">
                    <p style="margin-bottom: 10px; color: #666;">
                        Access your Google Sheet database directly
                    </p>
                    <button class="btn btn-secondary" onclick="openBackup()"> Open Google Sheet</button>
                </div>
            </div>
            
            <!-- Invoice Settings Section -->
            <div style="margin-bottom: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;"> Invoice Settings</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('invoiceSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="invoiceSection-toggle"> Hide</span>
                    </button>
                </div>
                <div id="invoiceSection">
                    <p style="margin-bottom: 15px; color: #666;">
                        Customize your printed invoices
                    </p>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Company Name *</label>
                            <input type="text" id="invoiceCompanyName" placeholder="Nowak Distributing">
                        </div>
                        
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="invoiceContactName" placeholder="Joe Nowak">
                        </div>
                        
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="text" id="invoicePhone" placeholder="(920)634-4351">
                        </div>
                        
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="invoiceEmail" placeholder="jnowaksnfoodistributors@gmail.com">
                        </div>
                        
                        <div class="form-group">
                            <label>Address Line 1</label>
                            <input type="text" id="invoiceAddress1" placeholder="123 Business Street">
                        </div>
                        
                        <div class="form-group">
                            <label>Address Line 2</label>
                            <input type="text" id="invoiceAddress2" placeholder="Suite 100 (optional)">
                        </div>
                        
                        <div class="form-group">
                            <label>City, State, ZIP</label>
                            <input type="text" id="invoiceCityStateZip" placeholder="Milwaukee, WI 53201">
                        </div>
                        
                        <div class="form-group">
                            <label>Footer Message</label>
                            <textarea id="invoiceFooter" rows="2" placeholder="Thank you for doing business with us!"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 10px;">
                        <label>
                            <input type="checkbox" id="invoiceSignatureLine" checked>
                            Include signature line on invoices
                        </label>
                    </div>
                    
                    <button class="btn" onclick="if(event && debounceButton(event.currentTarget)) saveInvoiceSettings()"> Save Invoice Settings</button>
                </div>
            </div>
            
            <!-- Current Status Section -->
            <div style="margin-bottom: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;"> Current Status</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('statusSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="statusSection-toggle"> Hide</span>
                    </button>
                </div>
                <div id="statusSection">
                    <p id="configStatusText"> Not configured</p>
                </div>
            </div>
            
            <!-- Diagnostics Section -->
            <div style="margin-bottom: 20px; background: #fff3cd; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #ffc107;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;"> Diagnostics & Troubleshooting</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('diagnosticsSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="diagnosticsSection-toggle"> Show</span>
                    </button>
                </div>
                <div id="diagnosticsSection" style="display: none; margin-top: 15px;">
                    <p style="margin-bottom: 15px; color: #856404; font-size: 14px;">
                         Run diagnostics to troubleshoot issues with loading data, especially on mobile devices. This tool will test your API connection, data fetching, and identify exactly where problems occur.
                    </p>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: #666;">When to use diagnostics:</h4>
                        <ul style="margin: 10px 0; padding-left: 20px; color: #666;">
                            <li>Sales Orders or Purchase Orders won't load</li>
                            <li>Error messages appear when creating orders</li>
                            <li>Data loads on desktop but not on mobile</li>
                            <li>API connection issues</li>
                        </ul>
                    </div>
                    
                    <button class="btn" onclick="window.open('mobile-diagnostic.html', '_blank')" style="background: #ffc107; color: #000; font-weight: bold;">
                         Open Diagnostic Tool
                    </button>
                    
                    <p style="margin-top: 15px; color: #856404; font-size: 13px;">
                         <strong>Tip:</strong> After running diagnostics, use the "Print/Save as PDF" button to save results and share them for support.
                    </p>
                </div>
            </div>
            
            <!-- Backend API URL - At bottom, collapsed by default -->
            <div style="margin-bottom: 20px; background: #f8f9fa; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #999;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; color: #666;"> Database Environment</h3>
                    <button class="btn-small" onclick="toggleSettingsSection('apiSection')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="apiSection-toggle"> Show</span>
                    </button>
                </div>
                <div id="apiSection" style="display: none; margin-top: 15px;">
                    
                    <!-- Environment Switcher Buttons -->
                    <div style="margin-bottom: 20px;">
                        <p style="margin: 0 0 10px 0; color: #666; font-size: 13px; font-weight: 600;"> Quick Switch Environment:</p>
                        <div id="envButtonsContainer" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="button" id="envBtn-production" onclick="switchEnvironment('production')" class="env-btn" style="padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: 3px solid #059669; background: #d1fae5; color: #065f46; -webkit-tap-highlight-color: transparent; touch-action: manipulation; min-height: 44px;">
                                 Production
                            </button>
                            <button type="button" id="envBtn-training" onclick="switchEnvironment('training')" class="env-btn" style="padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: 3px solid #0284c7; background: white; color: #0284c7; -webkit-tap-highlight-color: transparent; touch-action: manipulation; min-height: 44px;">
                                 Training
                            </button>
                            <button type="button" id="envBtn-test" onclick="switchEnvironment('test')" class="env-btn" style="padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: 3px solid #dc2626; background: white; color: #dc2626; -webkit-tap-highlight-color: transparent; touch-action: manipulation; min-height: 44px;">
                                 Development
                            </button>
                        </div>
                        <p id="currentEnvDisplay" style="margin: 10px 0 0 0; padding: 8px 12px; background: #d1fae5; border-radius: 6px; color: #065f46; font-weight: 600; display: inline-block;">
                             Currently using: Production
                        </p>
                    </div>
                    
                    <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;">
                    
                    <!-- Environment URL Configuration -->
                    <p style="margin: 0 0 15px 0; color: #888; font-size: 13px;">
                         Configure your Google Apps Script URLs for each environment:
                    </p>
                    
                    <!-- Production URL -->
                    <div style="margin-bottom: 15px; padding: 15px; background: #ecfdf5; border-radius: 8px; border-left: 4px solid #059669;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #065f46;"> Production URL</label>
                        <input type="text" id="envUrl-production" class="form-group" style="width: 100%; padding: 10px; border: 2px solid #a7f3d0; border-radius: 6px;" 
                               placeholder="https://script.google.com/macros/s/.../exec"
                               onchange="saveEnvironmentUrl('production')">
                        <p style="margin: 5px 0 0 0; font-size: 11px; color: #059669;">Your live business data</p>
                    </div>
                    
                    <!-- Training URL -->
                    <div style="margin-bottom: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0284c7;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #0369a1;"> Training URL</label>
                        <input type="text" id="envUrl-training" class="form-group" style="width: 100%; padding: 10px; border: 2px solid #bae6fd; border-radius: 6px;" 
                               placeholder="https://script.google.com/macros/s/.../exec"
                               onchange="saveEnvironmentUrl('training')">
                        <p style="margin: 5px 0 0 0; font-size: 11px; color: #0284c7;">Sample data for learning the system</p>
                    </div>
                    
                    <!-- Development URL -->
                    <div style="margin-bottom: 15px; padding: 15px; background: #fef2f2; border-radius: 8px; border-left: 4px solid #dc2626;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #991b1b;"> Development URL</label>
                        <input type="text" id="envUrl-test" class="form-group" style="width: 100%; padding: 10px; border: 2px solid #fecaca; border-radius: 6px;" 
                               placeholder="https://script.google.com/macros/s/.../exec"
                               onchange="saveEnvironmentUrl('test')">
                        <p style="margin: 5px 0 0 0; font-size: 11px; color: #dc2626;">For testing new features and changes</p>
                    </div>
                    
                    <!-- Legacy single URL input (hidden but functional for backward compatibility) -->
                    <input type="hidden" id="apiUrl">
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                        <button class="btn" onclick="if(event && debounceButton(event.currentTarget)) saveConfig()" style="background: #059669;"> Save All Settings</button>
                        <button class="btn btn-secondary" onclick="refreshAfterEnvSwitch()"> Refresh Data</button>
                        <button class="btn" onclick="restoreDefaultUrls()" style="background: #7c3aed;"> Restore Default URLs</button>
                    </div>
                    
                    <p style="margin: 15px 0 0 0; padding: 10px; background: #fef3c7; border-radius: 6px; color: #92400e; font-size: 12px;">
                         <strong>Tip:</strong> If URLs are blank after clearing site data, click "Restore Default URLs" to repopulate them!</p>
                </div>
            </div>
        </div>

        <!-- HOME / LANDING PAGE -->
        <!-- Suppliers Tab -->
        <div id="suppliers" class="card">
            <h2>Suppliers</h2>
            <div class="status" id="suppliersStatus"></div>
            
            <!-- Button Group Card -->
            <div class="filter-card">
                <button class="btn" onclick="loadSuppliers()"> Refresh</button>
                <button class="btn" onclick="showAddSupplierForm()"> Add Supplier</button>
            </div>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;"> Filter Suppliers</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-suppliers')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-suppliers-toggle"> Show</span>
                    </button>
                </div>
                <div id="filter-panel-suppliers" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Search Name</label>
                        <input type="text" id="filterSupplierName" placeholder=" Click to search..." onkeyup="filterSuppliers()" onclick="openSupplierPickerForFilter(this)" readonly style="cursor: pointer; background: #fff;">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="filterSupplierCity" placeholder="Filter by city..." onkeyup="filterSuppliers()">
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <input type="text" id="filterSupplierState" placeholder="Filter by state..." onkeyup="filterSuppliers()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearSupplierFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addSupplierForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <h3>Add New Supplier</h3>
                <form onsubmit="addSupplier(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier Name *</label>
                            <input type="text" id="newSupplierName" required>
                        </div>
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="newContactName">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="newPhone" placeholder="(999) 999-9999" oninput="formatPhone(this)">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="newEmail">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="newAddress">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="newCity">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" id="newState" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" id="newZip">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Payment Terms</label>
                        <select id="newPaymentTerms">
                            <option value="Net 30">Net 30</option>
                            <option value="Net 45">Net 45</option>
                            <option value="Net 60">Net 60</option>
                            <option value="COD">COD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="newNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn"> Save Supplier</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddSupplierForm()">Cancel</button>
                </form>
            </div>
            
            <!-- Edit Supplier Form -->
            <div id="editSupplierForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #f39c12;">
                <h3> Edit Supplier</h3>
                <form onsubmit="updateSupplier(event)">
                    <input type="hidden" id="editSupplierId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier Name *</label>
                            <input type="text" id="editSupplierName" required>
                        </div>
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="editContactName">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="editPhone">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="editEmail">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="editAddress">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="editCity">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" id="editState" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" id="editZip">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Payment Terms</label>
                        <select id="editPaymentTerms">
                            <option value="Net 30">Net 30</option>
                            <option value="Net 45">Net 45</option>
                            <option value="Net 60">Net 60</option>
                            <option value="COD">COD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn"> Update Supplier</button>
                    <button type="button" class="btn btn-secondary" onclick="hideEditSupplierForm()">Cancel</button>
                </form>
            </div>
            
            <div class="data-display-card">
                <div id="suppliersTable"></div>
            </div>
        </div>

        <!-- Items Tab -->
        <div id="items" class="card">
            <h2>Items</h2>
            <div class="status" id="itemsStatus"></div>
            
            <!-- Button Group Card -->
            <div class="filter-card">
                <button class="btn" onclick="loadItems()"> Refresh</button>
                <button class="btn" onclick="showAddItemForm()"> Add Item</button>
                <button class="btn" onclick="downloadItemsReport()" style="background: #17a2b8;"> Download Items</button>
                <button class="btn" onclick="openUploadItemsModal()" style="background: #28a745;"> Upload Items</button>
            </div>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;"> Filter Items</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-items')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-items-toggle"> Show</span>
                    </button>
                </div>
                <div id="filter-panel-items" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Search SKU/Description</label>
                        <input type="text" id="filterItemSearch" placeholder=" Click to search..." onkeyup="filterItems()" onclick="openItemPickerForFilter(this)" readonly style="cursor: pointer; background: #fff;">
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <select id="filterItemSupplier" onchange="filterItems()">
                            <option value="">All Suppliers</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stock Status</label>
                        <select id="filterItemStock" onchange="filterItems()">
                            <option value="">All Items</option>
                            <option value="negative"> Negative Inventory</option>
                            <option value="low"> Low Stock (Below Reorder)</option>
                            <option value="onorder"> On Order (Pending Delivery)</option>
                            <option value="reorder"> Needs Reorder (Low + No Order)</option>
                            <option value="ok"> Normal Stock</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Item Status</label>
                        <select id="filterItemActive" onchange="filterItems()">
                            <option value="active"> Active Items Only</option>
                            <option value="archived"> Archived Items Only</option>
                            <option value="">All Items</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearItemFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addItemForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <h3>Add New Item</h3>
                <form onsubmit="addItem(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="newItemSupplier" required>
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Item Description *</label>
                            <input type="text" id="newItemDescription" required>
                        </div>
                        <div class="form-group">
                            <label>SKU *</label>
                            <input type="text" id="newItemSKU" required placeholder="e.g. BM-BBQ-001">
                        </div>
                        <div class="form-group">
                            <label>Purchase UOM (What you buy)</label>
                            <input type="text" id="newItemPurchaseUOMDisplay" value="Case" 
                                   onclick="openUOMPicker('newItemPurchaseUOM')" readonly
                                   style="cursor: pointer; background: #fff;">
                            <input type="hidden" id="newItemPurchaseUOM" value="Case">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Units Per Package * <span style="font-size: 12px; color: #666;">(How many individual units in one box/case)</span></label>
                            <input type="number" id="newUnitsPerPackage" step="1" min="1" required placeholder="e.g. 27">
                        </div>
                        <div class="form-group">
                            <label>Package Cost * <span style="font-size: 12px; color: #666;">(Cost per box/case)</span></label>
                            <input type="number" id="newPackageCost" step="0.01" required placeholder="e.g. 20.00" oninput="calculateUnitCost()">
                        </div>
                        <div class="form-group">
                            <label>Unit Cost (Calculated)</label>
                            <input type="text" id="calculatedUnitCost" readonly style="background: #f0f0f0; font-weight: bold;" value="$0.00">
                        </div>
                        <div class="form-group">
                            <label>Unit Sell Price * <span style="font-size: 12px; color: #666;">(Price per individual unit)</span></label>
                            <input type="number" id="newUnitSellPrice" step="0.01" required placeholder="e.g. 3.00">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Initial Quantity <span style="font-size: 12px; color: #666;">(In individual units)</span></label>
                            <input type="number" id="newQtyOnHand" value="0">
                        </div>
                        <div class="form-group">
                            <label>Reorder Point <span style="font-size: 12px; color: #666;">(In individual units)</span></label>
                            <input type="number" id="newReorderPoint" value="10">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="newItemNotes" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn"> Save Item</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddItemForm()">Cancel</button>
                </form>
            </div>
            
            <!-- Edit Item Form -->
            <div id="editItemForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #f39c12;">
                <h3> Edit Item</h3>
                <form onsubmit="updateItem(event)">
                    <input type="hidden" id="editItemId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="editItemSupplier" required>
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Item Description *</label>
                            <input type="text" id="editItemDescription" required>
                        </div>
                        <div class="form-group">
                            <label>SKU *</label>
                            <input type="text" id="editItemSKU" required>
                        </div>
                        <div class="form-group">
                            <label>Purchase UOM</label>
                            <input type="text" id="editItemPurchaseUOMDisplay" 
                                   onclick="openUOMPicker('editItemPurchaseUOM')" readonly
                                   style="cursor: pointer; background: #fff;">
                            <input type="hidden" id="editItemPurchaseUOM">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Units Per Package *</label>
                            <input type="number" id="editUnitsPerPackage" step="1" min="1" required oninput="calculateEditUnitCost()">
                        </div>
                        <div class="form-group">
                            <label>Package Cost *</label>
                            <input type="number" id="editPackageCost" step="0.01" required oninput="calculateEditUnitCost()">
                        </div>
                        <div class="form-group">
                            <label>Unit Cost (Calculated)</label>
                            <input type="text" id="calculatedEditUnitCost" readonly style="background: #f0f0f0; font-weight: bold;" value="$0.00">
                        </div>
                        <div class="form-group">
                            <label>Unit Sell Price *</label>
                            <input type="number" id="editUnitSellPrice" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Current Quantity <span style="font-size: 12px; color: #666;">(In individual units)</span></label>
                            <input type="number" id="editQtyOnHand" readonly style="background: #f0f0f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                                <small style="color: #666;">Use Purchases/Sales to adjust quantity</small>
                                <a href="#" onclick="goToAdjustInventory(); return false;" style="font-size: 12px; color: #3b82f6; text-decoration: none; font-weight: 600;"> Adjust Inventory </a>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Reorder Point <span style="font-size: 12px; color: #666;">(In individual units)</span></label>
                            <input type="number" id="editReorderPoint">
                        </div>
                        <div class="form-group">
                            <label>Item Status</label>
                            <select id="editItemStatus">
                                <option value="Active"> Active</option>
                                <option value="Archived"> Archived</option>
                            </select>
                            <small style="color: #666;">Archived items won't appear in new PO/SO dropdowns</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editItemNotes" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn"> Update Item</button>
                    <button type="button" class="btn btn-secondary" onclick="hideEditItemForm()">Cancel</button>
                </form>
            </div>
            
            <div class="data-display-card">
                <div id="itemsTable"></div>
            </div>
        </div>

        <!-- Customers Tab -->
        <div id="customers" class="card">
            <h2>Customers</h2>
            <div class="status" id="customersStatus"></div>
            
            <!-- Button Group Card -->
            <div class="filter-card">
                <button class="btn" onclick="loadCustomers()"> Refresh</button>
                <button class="btn" onclick="showAddCustomerForm()"> Add Customer</button>
            </div>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;"> Filter Customers</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-customers')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-customers-toggle"> Show</span>
                    </button>
                </div>
                <div id="filter-panel-customers" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Search Name</label>
                        <input type="text" id="filterCustomerName" placeholder=" Click to search..." onkeyup="filterCustomers()" onclick="openCustomerPickerForFilter(this)" readonly style="cursor: pointer; background: #fff;">
                    </div>
                    <div class="form-group">
                        <label>Contact Name</label>
                        <input type="text" id="filterCustomerContact" placeholder="Contact name..." onkeyup="filterCustomers()">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="filterCustomerCity" placeholder="Filter by city..." onkeyup="filterCustomers()">
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <input type="text" id="filterCustomerState" placeholder="Filter by state..." onkeyup="filterCustomers()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearCustomerFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addCustomerForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <h3>Add New Customer</h3>
                <form onsubmit="addCustomer(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Customer Name *</label>
                            <input type="text" id="newCustomerName" required>
                        </div>
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="newCustomerContact">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="newCustomerPhone">
                        </div>
                        <div class="form-group">
                            <label>Mobile</label>
                            <input type="tel" id="newCustomerMobile">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="newCustomerEmail">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="newCustomerAddress">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="newCustomerCity">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" id="newCustomerState" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" id="newCustomerZip">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Credit Limit</label>
                            <input type="number" id="newCreditLimit" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Payment Terms</label>
                            <select id="newCustomerPaymentTerms">
                                <option value="Net 30">Net 30</option>
                                <option value="Net 15">Net 15</option>
                                <option value="Net 45">Net 45</option>
                                <option value="COD">COD</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="newCustomerNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn"> Save Customer</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddCustomerForm()">Cancel</button>
                </form>
            </div>
            
            <!-- Edit Customer Form -->
            <div id="editCustomerForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #f39c12;">
                <h3> Edit Customer</h3>
                <form onsubmit="updateCustomer(event)">
                    <input type="hidden" id="editCustomerId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Customer Name *</label>
                            <input type="text" id="editCustomerName" required>
                        </div>
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="editCustomerContact">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="editCustomerPhone">
                        </div>
                        <div class="form-group">
                            <label>Mobile</label>
                            <input type="tel" id="editCustomerMobile">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="editCustomerEmail">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="editCustomerAddress">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="editCustomerCity">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" id="editCustomerState" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" id="editCustomerZip">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Credit Limit</label>
                            <input type="number" id="editCreditLimit" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Payment Terms</label>
                            <select id="editCustomerPaymentTerms">
                                <option value="Net 30">Net 30</option>
                                <option value="Net 15">Net 15</option>
                                <option value="Net 45">Net 45</option>
                                <option value="COD">COD</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editCustomerNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn"> Update Customer</button>
                    <button type="button" class="btn btn-secondary" onclick="hideEditCustomerForm()">Cancel</button>
                </form>
            </div>
            
            <div class="data-display-card">
                <div id="customersTable"></div>
            </div>
        </div>

        <!-- Create PO Tab (Generate Only - No Database Save) -->
        <div id="createpo" class="card">
            <div style="max-width: 100%; overflow: hidden;">
                <h2> Create Purchase Order</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Create a purchase order to track items on order from suppliers. Use <strong>"Save PO"</strong> to save to database and mark items as "On Order", or use <strong>"Print PO (No Save)"</strong> to just generate a printable document.
                </p>
                
                <div id="createPOForm">
                    <!-- Card 1: Basic Information -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary, #667eea);"> Order Information</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Supplier *</label>
                                <select id="createPOSupplier" required onchange="filterItemsBySupplier()">
                                    <option value="">Select Supplier...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>PO Date *</label>
                                <input type="date" id="createPODate" required>
                            </div>
                            <div class="form-group">
                                <label>Expected Delivery Date *</label>
                                <input type="date" id="createPOExpectedDate" required>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Notes</label>
                                <textarea id="createPONotes" rows="2" placeholder="Special instructions, delivery notes, etc."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 2: Line Items -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 8px;">
                            <h4 style="margin: 0; color: var(--primary, #667eea);"> Line Items</h4>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn-small" onclick="openMultiItemPickerForPO()" style="background: #28a745; color: white;"> Select Multiple Items</button>
                                <button class="btn-small" onclick="addCreatePOLineItem()" style="background: var(--primary, #667eea); color: white;"> Add Single Item</button>
                            </div>
                        </div>
                        
                        <!-- Wrapper for horizontal scroll on mobile -->
                        <div id="createPOLineItemsWrapper" style="overflow-x: auto; -webkit-overflow-scrolling: touch; width: 100%; position: relative;">
                            <div id="createPOLineItemsInner" style="min-width: 700px; width: 100%; max-width: 100%;">
                                <!-- Header Row -->
                                <div id="createPOLineItemsHeader" style="display: grid; grid-template-columns: 2.5fr 1fr 0.6fr 0.8fr 0.8fr 0.8fr 50px; gap: 6px; padding: 12px; background: var(--primary, #667eea); color: white; font-weight: bold; border-radius: 8px 8px 0 0; font-size: 16px;">
                                    <div>Item</div>
                                    <div style="text-align: center;">Cases</div>
                                    <div style="text-align: center;">Units/Case</div>
                                    <div style="text-align: center;">Total Units</div>
                                    <div style="text-align: center;">Catalog Cost</div>
                                    <div style="text-align: right;">Line Total</div>
                                    <div style="text-align: center;">Del</div>
                                </div>
                                
                                <!-- Line Items Container -->
                                <div id="createPOLineItems" style="border: 2px solid #667eea; border-top: none; border-radius: 0 0 8px 8px; padding: 10px; background: #fafafa;">
                                    <div class="line-item-row" style="display: grid; grid-template-columns: 2.5fr 1fr 0.6fr 0.8fr 0.8fr 0.8fr 50px; gap: 8px; margin-bottom: 10px; align-items: end;">
                                        <div>
                                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                                            <select class="createpo-item" style="width: 100%; padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white;" onchange="updateCreatePOItemCost(this)">
                                                <option value="">Select item...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Cases</label>
                                            <input type="number" class="createpo-qty" placeholder="0" min="1" style="width: 100%; padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px;">
                                        </div>
                                        <div style="margin-top: 26px;">
                                            <div class="createpo-units" style="text-align: center; font-size: 14px; color: #666; padding: 6px;">-</div>
                                        </div>
                                        <div style="margin-top: 26px;">
                                            <div class="createpo-totalunits" style="text-align: center; font-size: 16px; font-weight: bold; color: var(--primary, #667eea); padding: 6px;">-</div>
                                        </div>
                                        <div style="margin-top: 26px;">
                                            <div class="createpo-cost" style="text-align: center; font-size: 14px; font-weight: bold; color: #28a745; background: #e8f5e9; padding: 10px; border-radius: 6px;">-</div>
                                        </div>
                                        <div style="margin-top: 26px;">
                                            <div class="createpo-linetotal" style="text-align: right; font-size: 14px; font-weight: bold; color: var(--primary, #667eea); background: var(--primary-light, #E3F2FD); padding: 10px; border-radius: 6px;">$0.00</div>
                                        </div>
                                        <button type="button" class="btn-danger" onclick="removeLineItem(this)" style="width: 100%; padding: 10px; font-size: 14px; margin-top: 26px;"></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 3: Order Summary - STICKY -->
                    <div class="content-card" style="margin-bottom: 20px; position: sticky; top: 80px; z-index: 10; background: white;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary, #667eea);"> Order Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 12px; border: 2px solid var(--primary, #667eea);">
                                <div style="font-size: 14px; color: #1565c0; margin-bottom: 8px; font-weight: 600;">Total Cases</div>
                                <div style="font-size: 32px; font-weight: bold; color: var(--primary, #667eea);" id="createPOTotalCases">0</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 12px; border: 2px solid #f9a825;">
                                <div style="font-size: 14px; color: #ef6c00; margin-bottom: 8px; font-weight: 600;">Total Units</div>
                                <div style="font-size: 32px; font-weight: bold; color: #f9a825;" id="createPOTotalUnits">0</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 12px; border: 2px solid #28a745;">
                                <div style="font-size: 14px; color: #2e7d32; margin-bottom: 8px; font-weight: 600;">Total Cost</div>
                                <div style="font-size: 32px; font-weight: bold; color: #28a745;" id="createPOTotal">$0.00</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="filter-card">
                        <button class="btn" onclick="if(event && debounceButton(event.currentTarget)) saveOutgoingPO()" style="flex: 1; min-width: 200px;"> Save PO</button>
                        <button class="btn" onclick="generatePrintablePO()" style="flex: 1; min-width: 200px;"> Print PO (No Save)</button>
                        <button class="btn btn-secondary" onclick="clearCreatePOForm()" style="flex: 1; min-width: 200px;"> Clear Form</button>
                    </div>
                </div>
            </div>
            
            <!-- Printable PO Document (Hidden initially) -->
            <div id="printablePOContainer" style="display: none; margin-top: 30px;">
                <div style="text-align: right; margin-bottom: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn" onclick="window.print()"> Print</button>
                    <button class="btn" onclick="downloadPOAsPDF()"> Download PDF</button>
                    <button class="btn" onclick="emailPO()"> Email PO</button>
                    <button class="btn btn-secondary" onclick="closePrintablePO()"> Close</button>
                </div>
                <div id="printablePO" style="background: white; padding: 40px; border: 1px solid #ddd; max-width: 800px; margin: 0 auto;">
                    <!-- Printable PO will be generated here -->
                </div>
            </div>
        </div>

        <!-- Purchases Tab -->
        <div id="purchases" class="card">
            <h2>Purchase Orders</h2>
            <div class="status" id="purchasesStatus"></div>
            
            <!-- Button Group Card -->
            <div class="filter-card">
                <button class="btn" onclick="loadPurchases()"> Refresh</button>
                <button class="btn" onclick="showAddPurchaseForm()"> Record Purchase</button>
            </div>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;"> Filter Purchases</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-purchases')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-purchases-toggle"> Show</span>
                    </button>
                </div>
                <div id="filter-panel-purchases" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Invoice # / PO</label>
                        <input type="text" id="filterPurchasePO_display" placeholder=" Click to select POs..." onclick="openPOPickerForPurchases()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="filterPurchasePO" value="">
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <input type="text" id="filterPurchaseSupplier_display" placeholder=" Click to select suppliers..." onclick="openSupplierPickerForPurchases()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="filterPurchaseSupplier" value="">
                    </div>
                    <div class="form-group">
                        <label>Order Status</label>
                        <select id="filterPurchaseStatus" onchange="filterPurchases()">
                            <option value="">All</option>
                            <option value="Ordered"> Ordered (Pending)</option>
                            <option value="Received"> Received</option>
                            <option value="Voided"> Voided</option>
                            <option value="exclude-voided"> Exclude Voided</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label> Payment Status</label>
                        <select id="filterPurchasePaymentStatus" onchange="filterPurchases()">
                            <option value="">All</option>
                            <option value="Paid"> Paid</option>
                            <option value="Partial"> Partial</option>
                            <option value="Unpaid"> Unpaid</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label> PO Date From</label>
                        <input type="date" id="filterPurchaseDateFrom" onchange="filterPurchases()">
                    </div>
                    <div class="form-group">
                        <label> PO Date To</label>
                        <input type="date" id="filterPurchaseDateTo" onchange="filterPurchases()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearPurchaseFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addPurchaseForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <h3>Record New Purchase</h3>
                <form onsubmit="addPurchase(event)">
                    <!-- Card 1: Basic Information -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Supplier *</label>
                                <select id="poSupplier" required onchange="loadSupplierItems()">
                                    <option value="">Select Supplier</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Invoice Number *</label>
                                <input type="text" id="poInvoiceNumber" required>
                            </div>
                            <div class="form-group">
                                <label>Purchase Date *</label>
                                <input type="date" id="poDate" required>
                            </div>
                            <div class="form-group">
                                <label>Expected Delivery Date *</label>
                                <input type="date" id="poDueDate" required>
                                <small style="color: #666;">When do you expect to receive this order?</small>
                            </div>
                            <div class="form-group">
                                <label>Payment Terms</label>
                                <select id="poPaymentTerms">
                                    <option value="Net 30">Net 30</option>
                                    <option value="Net 60">Net 60</option>
                                    <option value="COD">COD (Cash on Delivery)</option>
                                    <option value="Prepaid">Prepaid</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Status *</label>
                                <select id="poStatus" required>
                                    <option value="" disabled selected>-- Select Status --</option>
                                    <option value="Ordered"> Ordered - Sent to supplier</option>
                                    <option value="In Transit"> In Transit - Shipped, on the way</option>
                                    <option value="Partial"> Partial - Some items received</option>
                                    <option value="Received"> Received - All items received</option>
                                    <option value="Voided"> Voided - Cancelled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Invoice Total *</label>
                                <input type="number" id="poTotal" step="0.01" min="0" required readonly style="background: #f0f0f0;">
                                <small style="color: #666;">Auto-calculated from line items</small>
                            </div>
                            <div class="form-group">
                                <label>Amount Paid</label>
                                <input type="number" id="poAmountPaid" step="0.01" min="0" value="0" placeholder="0.00">
                                <small style="color: #666;">Enter amount if paid at time of purchase</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 2: Line Items -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <h4 style="margin-top: 0; margin-bottom: 15px;">Line Items</h4>
                        <div class="line-items-container" id="poLineItems">
                            <div class="line-item-row">
                                <select class="po-item" required>
                                    <option value="">Select Item</option>
                                </select>
                                <input type="number" class="po-qty" placeholder="Quantity" min="1" required>
                                <input type="number" class="po-cost" placeholder="Unit Cost" step="0.01" min="0" required>
                                <button type="button" class="remove-btn"></button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                            <button type="button" class="btn btn-secondary" onclick="addPOLineItem()">+ Add Line Item</button>
                            <button type="button" class="btn" onclick="addNewItemFromPO()" style="background: #9c27b0;"> Add New Item to Catalog</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="poNotes" rows="2"></textarea>
                    </div>
                    
                    <button type="submit" class="btn"> Save Purchase Order</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddPurchaseForm()">Cancel</button>
                </form>
            </div>
            
            <div class="data-display-card" style="margin-top: 30px;">
                <div id="purchasesTable"></div>
            </div>
        </div>

        <!-- Sales Tab -->
        <div id="sales" class="card">
            <h2>Sales Orders</h2>
            <div class="status" id="salesStatus"></div>
            
            <!-- Button Group Card -->
            <div class="filter-card">
                <button class="btn" onclick="loadSales()"> Refresh</button>
                <button class="btn" onclick="showAddSaleForm()"> Record Sale</button>
            </div>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;"> Filter Sales</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-sales')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-sales-toggle"> Show</span>
                    </button>
                </div>
                <div id="filter-panel-sales" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Customer</label>
                        <input type="text" id="filterSaleCustomer_display" placeholder=" Click to select customers..." onclick="openCustomerPickerForSales()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="filterSaleCustomer" value="">
                    </div>
                    <div class="form-group">
                        <label>Invoice #</label>
                        <input type="text" id="filterInvoiceNumber_display" placeholder=" Click to select invoices..." onclick="openInvoicePickerForSales()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="filterInvoiceNumber" value="">
                    </div>
                    <div class="form-group">
                        <label>Order Status</label>
                        <select id="filterSaleStatus" onchange="filterSales()">
                            <option value="">All</option>
                            <option value="Completed"> Completed</option>
                            <option value="Pending"> Pending</option>
                            <option value="Cancelled"> Cancelled</option>
                            <option value="Voided"> Voided</option>
                            <option value="exclude-voided"> Exclude Voided</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date From</label>
                        <input type="date" id="filterSaleDateFrom" onchange="filterSales()">
                    </div>
                    <div class="form-group">
                        <label>Date To</label>
                        <input type="date" id="filterSaleDateTo" onchange="filterSales()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearSaleFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div id="addSaleForm" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <h3>Record New Sale</h3>
                <form onsubmit="addSale(event)">
                    <!-- Card 1: Basic Information -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Customer *</label>
                                <select id="soCustomer" required>
                                    <option value="">Select Customer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Sale Date *</label>
                                <input type="date" id="soDate" required>
                            </div>
                            <div class="form-group">
                                <label>Payment Method</label>
                                <select id="soPayment">
                                    <option value="Cash">Cash</option>
                                    <option value="Credit Card">Credit Card</option>
                                    <option value="Check">Check</option>
                                    <option value="Invoice">Invoice</option>
                                    <option value="Terms (Net 30)">Terms (Net 30)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Due Date *</label>
                                <input type="date" id="soDueDate" required>
                                <small style="color: #666;">Defaults to today for same-day sales</small>
                            </div>
                            <div class="form-group">
                                <label>Order Total *</label>
                                <input type="number" id="soTotal" step="0.01" min="0" required readonly style="background: #f0f0f0;">
                                <small style="color: #666;">Auto-calculated from line items</small>
                            </div>
                            <div class="form-group">
                                <label>Amount Paid</label>
                                <input type="number" id="soAmountPaid" step="0.01" min="0" value="0" placeholder="0.00">
                                <small style="color: #666;">Enter amount if paid at time of sale</small>
                            </div>
                            <div class="form-group">
                                <label>Status *</label>
                                <select id="soStatus" required>
                                    <option value="" disabled selected>-- Select Status --</option>
                                    <option value="Pending"> Pending - Order placed</option>
                                    <option value="Ready"> Ready for Pickup - Picked & ready to load</option>
                                    <option value="Out for Delivery"> Out for Delivery - On the truck</option>
                                    <option value="Delivered"> Delivered - Product delivered</option>
                                    <option value="Completed"> Completed - Delivered & Paid</option>
                                    <option value="Voided"> Voided - Cancelled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 2: Items Sold -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 8px;">
                            <h4 style="margin: 0;">Items Sold</h4>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button type="button" class="btn-small" onclick="openMultiItemPickerForSO()" style="background: #28a745; color: white;"> Select Multiple Items</button>
                            </div>
                        </div>
                        <div class="line-items-container" id="soLineItems" style="background: #fafafa; padding: 15px; border-radius: 8px; border: 2px solid #667eea;">
                            <div class="line-item-row" style="display: grid; grid-template-columns: 2.5fr 1fr 1fr 50px; gap: 10px; margin-bottom: 10px; align-items: end;">
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                                    <select class="so-item" required style="padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white; width: 100%;">
                                        <option value="">Select Item</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Quantity</label>
                                    <input type="number" class="so-qty" placeholder="0" min="1" required style="padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px; width: 100%;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Price</label>
                                    <input type="number" class="so-price" placeholder="0.00" step="0.01" min="0" required style="padding: 14px 10px; border: 2px solid #667eea; border-radius: 8px; text-align: center; font-size: 16px; min-height: 52px; background: white; width: 100%;">
                                </div>
                                <button type="button" class="remove-btn" style="min-height: 52px; font-size: 18px; margin-top: 26px;"></button>
                                <div class="so-stock-info" style="grid-column: 1 / -1; font-size: 13px; padding: 8px 12px; margin-top: -5px; display: none; border-radius: 6px; border: 2px solid #e0e0e0; background: white;"></div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addSOLineItem()" style="margin-top: 10px;">+ Add Line Item</button>
                    </div>
                    
                    <!-- Card 3: Order Summary -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #667eea; text-align: center;"> Order Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;">
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <h3 style="margin: 0 0 10px 0; color: #666; font-size: 14px;"> Total Items</h3>
                                <p style="font-size: 32px; font-weight: bold; color: #667eea; margin: 0;" id="soTotalQty">0</p>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <h3 style="margin: 0 0 10px 0; color: #666; font-size: 14px;"> Total Amount</h3>
                                <p style="font-size: 32px; font-weight: bold; color: #2e7d32; margin: 0;" id="soTotalAmount">$0.00</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="soNotes" rows="2"></textarea>
                    </div>
                    
                    <button type="submit" class="btn"> Save Sale</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddSaleForm()">Cancel</button>
                </form>
            </div>
            
            <div id="salesTable" style="margin-top: 30px;"></div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="card">
            <h2>Inventory Report</h2>
            <div class="status" id="inventoryStatus"></div>
            
            <!-- Button Group Card -->
            <div class="filter-card">
                <button class="btn" onclick="loadInventory()"> Refresh</button>
                <button class="btn" onclick="showAdjustInventoryForm()" style="background: #f39c12;"> Adjust Inventory</button>
                <button class="btn" onclick="goToAddItem()" style="background: #9c27b0;"> Add New Item</button>
            </div>
            
            <!-- Quick Guide Card -->
            <div class="content-card" style="background: #e3f2fd;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleSection('inventoryGuide')">
                    <strong> Quick Guide</strong>
                    <span id="inventoryGuide-toggle" style="color: var(--primary, #667eea);"> Hide</span>
                </div>
                <div id="inventoryGuide" style="margin-top: 10px;">
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><strong> Add New Item</strong> - Add items you already have in stock (no purchase order needed)</li>
                        <li><strong> Adjust Inventory</strong> - Fix counts, record damage, shrinkage, or physical inventory counts</li>
                        <li><strong> Purchases tab</strong> - Record new inventory from suppliers (creates purchase orders)</li>
                    </ul>
                </div>
            </div>
            
            <!-- Manual Adjustment Form -->
            <div id="adjustInventoryForm" style="display: none; margin-top: 20px; background: #fff8e1; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #f39c12;">
                <h3> Manual Inventory Adjustment</h3>
                <p style="color: #666; margin-bottom: 15px;">Use this for physical counts, damaged goods, shrinkage, etc.</p>
                <form onsubmit="submitInventoryAdjustment(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Item * <small style="color: #888;">(click to search)</small></label>
                            <input type="text" id="adjustItemDisplay" placeholder=" Click to select item..." 
                                   onclick="openItemPickerForAdjustment()" readonly
                                   style="cursor: pointer; background: #fff;">
                            <input type="hidden" id="adjustItem" required>
                        </div>
                        <div class="form-group">
                            <label>Current Quantity</label>
                            <input type="number" id="adjustCurrentQty" readonly style="background: #f0f0f0;">
                        </div>
                        <div class="form-group">
                            <label>Adjustment (+/-) *</label>
                            <input type="number" id="adjustQuantity" placeholder="e.g., -5 or +10" required oninput="updateAdjustNewQty()">
                            <small style="color: #666;">Use negative for decrease, positive for increase</small>
                        </div>
                        <div class="form-group">
                            <label>New Quantity</label>
                            <input type="number" id="adjustNewQty" readonly style="background: #e8f5e9;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Reason * <span style="color: #dc2626; font-size: 11px;">(required)</span></label>
                        <input type="text" id="adjustReasonDisplay" placeholder=" Click to select reason..." 
                               onclick="openReasonPicker()" readonly
                               style="cursor: pointer; background: #fff; border: 2px solid #f39c12;">
                        <input type="hidden" id="adjustReason" required>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="adjustNotes" rows="2" placeholder="Additional details..."></textarea>
                    </div>
                    <button type="submit" class="btn"> Save Adjustment</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAdjustInventoryForm()">Cancel</button>
                </form>
            </div>
            
            <!-- Filter Controls -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;"> Filter Inventory</h4>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-inventory')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-inventory-toggle"> Show</span>
                    </button>
                </div>
                <div id="filter-panel-inventory" class="form-grid" style="display: none;">
                    <div class="form-group">
                        <label>Search SKU/Description</label>
                        <input type="text" id="filterInventorySearch_display" placeholder=" Click to select items..." onclick="openItemPickerForInventory()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="filterInventorySearch" value="">
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <input type="text" id="filterInventorySupplier_display" placeholder=" Click to select suppliers..." onclick="openSupplierPickerForInventory()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="filterInventorySupplier" value="">
                    </div>
                    <div class="form-group">
                        <label>Stock Status</label>
                        <select id="filterInventoryStock" onchange="filterInventory()">
                            <option value="">All Items</option>
                            <option value="negative"> Negative</option>
                            <option value="out"> Out of Stock</option>
                            <option value="low"> Low Stock</option>
                            <option value="ok"> In Stock</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearInventoryFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <div class="data-display-card">
                <div id="inventoryTable"></div>
            </div>
        </div>
        
        <!-- PRICE SIMULATOR TAB -->
        <div id="pricesim" class="card">
            <h2> Pricing Workbench</h2>
            <div class="status" id="pricesimStatus"></div>
            
            <!-- Revenue Impact Calculator - MOVED TO TOP -->
            <div class="section-card accent-theme" style="background: var(--primary-light, #e3f2fd);">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleSection('revenueCalcContent')">
                    <h3 style="margin: 0; color: var(--primary, #667eea);"> Revenue Impact Calculator</h3>
                    <span id="revenueCalcContent-toggle" style="font-size: 14px; color: #666;"> Hide</span>
                </div>
                <div id="revenueCalcContent" style="margin-top: 15px;">
                    <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">See how a price increase affects your profit on a sample sale amount.</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="form-group" style="margin: 0;">
                            <label> Sample Sale Amount</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span style="font-size: 18px; font-weight: bold;">$</span>
                                <input type="number" id="revCalcSaleAmount" value="100" min="1" step="1" style="width: 100px;" oninput="updateRevenueCalc()">
                            </div>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label> Price Increase %</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="revCalcPercent" min="0" max="25" value="10" step="0.5" style="flex: 1;" oninput="updateRevenueCalc()">
                                <span id="revCalcPercentLabel" style="font-weight: bold; color: var(--primary, #667eea); min-width: 45px;">10%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="background: #fff; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #e0e0e0;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">BEFORE Increase</div>
                            <div id="revCalcBefore" style="font-size: 32px; font-weight: bold; color: #666;">$100.00</div>
                            <div style="font-size: 12px; color: #999;">Your Sale</div>
                        </div>
                        <div style="background: #fff; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #e0e0e0;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">AFTER Increase</div>
                            <div id="revCalcAfter" style="font-size: 32px; font-weight: bold; color: #2e7d32;">$110.00</div>
                            <div style="font-size: 12px; color: #999;">New Sale Value</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4caf50, #2e7d32); padding: 20px; border-radius: 12px; text-align: center; color: white;">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">EXTRA PROFIT</div>
                            <div id="revCalcProfit" style="font-size: 32px; font-weight: bold;">+$10.00</div>
                            <div style="font-size: 12px; opacity: 0.9;">Per Sale</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #c0c0c0;">
                        <h4 style="margin: 0 0 10px 0; color: var(--primary, #667eea);"> Projected Impact</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                            <div>
                                <div style="color: #666; font-size: 13px;">10 Sales/Week</div>
                                <div id="revCalc10Sales" style="font-size: 20px; font-weight: bold; color: #2e7d32;">+$100/week</div>
                            </div>
                            <div>
                                <div style="color: #666; font-size: 13px;">Monthly (40 sales)</div>
                                <div id="revCalcMonthly" style="font-size: 20px; font-weight: bold; color: #2e7d32;">+$400/month</div>
                            </div>
                            <div>
                                <div style="color: #666; font-size: 13px;">Yearly (520 sales)</div>
                                <div id="revCalcYearly" style="font-size: 20px; font-weight: bold; color: #2e7d32;">+$5,200/year</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section-card accent-theme" style="background: linear-gradient(135deg, #667eea15, #764ba215);">
                <h3 style="margin: 0 0 10px 0; color: #667eea;"> What You Can Do Here</h3>
                <p style="margin: 0; color: #555;">
                    <strong> Existing Items:</strong> Adjust sell prices by % or flat amount, preview impact, then apply<br>
                    <strong> New Items:</strong> Add items from supplier catalog, enter cost, simulate different markups to find the right sell price
                </p>
            </div>
            
            <!-- ADD NEW ITEM SECTION -->
            <div class="section-card accent-theme" style="background: #fff3e0;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleSection('addNewItemContent')">
                    <h3 style="margin: 0; color: #e65100;"> Add New Item from Supplier Catalog</h3>
                    <span id="addNewItemContent-toggle" style="font-size: 14px; color: #666;"> Hide</span>
                </div>
                <div id="addNewItemContent" style="margin-top: 15px;">
                <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">Enter item details from your supplier's catalog. Set the markup % to calculate a sell price, then add to simulation to compare.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Supplier *</label>
                        <select id="newSimSupplier" required>
                            <option value="">Select Supplier</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>SKU / UPC</label>
                        <input type="text" id="newSimSKU" placeholder="e.g., 41633009999">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Description *</label>
                        <input type="text" id="newSimDescription" placeholder="e.g., Cheese Puffs, 12ct" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Package Cost *</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span>$</span>
                            <input type="number" id="newSimPackageCost" step="0.01" min="0" placeholder="18.50" oninput="calcNewSimUnitCost()">
                        </div>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Units/Package *</label>
                        <input type="number" id="newSimUnitsPerPkg" step="1" min="1" value="1" placeholder="12" oninput="calcNewSimUnitCost()">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Unit Cost</label>
                        <input type="text" id="newSimUnitCost" readonly style="background: #e0e0e0; font-weight: bold;" value="$0.00">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Markup %</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number" id="newSimMarkup" value="30" min="0" max="500" step="1" style="width: 70px;" oninput="calcNewSimSellPrice()">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Sell Price</label>
                        <input type="text" id="newSimSellPrice" readonly style="background: #c8e6c9; font-weight: bold; color: #2e7d32;" value="$0.00">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" class="btn" onclick="addNewItemToSimulation()" style="background: #ff9800;">
                         Add to Simulation
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearNewSimForm()">
                         Clear Form
                    </button>
                </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="section-card accent-theme" style="background: #f8f9fa;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0;"> Filter Existing Items</h3>
                    <button class="btn-small" onclick="toggleFilters('filter-panel-pricesim')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="filter-panel-pricesim-toggle"> Show</span>
                    </button>
                </div>
                <div id="filter-panel-pricesim" class="form-grid" style="display: none;">
                    <div class="form-group" style="margin: 0;">
                        <label>Search SKU/Description</label>
                        <input type="text" id="pricesimSearch_display" placeholder=" Click to select items..." onclick="openItemPickerForPricing()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="pricesimSearch" value="">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Supplier</label>
                        <input type="text" id="pricesimSupplier_display" placeholder=" Click to select suppliers..." onclick="openSupplierPickerForPricing()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="pricesimSupplier" value="">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Stock Status</label>
                        <select id="pricesimStock" onchange="filterPriceSimItems()">
                            <option value="">All Items</option>
                            <option value="instock">In Stock Only</option>
                            <option value="low">Low Stock</option>
                            <option value="out">Out of Stock</option>
                            <option value="new"> New (Simulated Only)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Price Adjustment Controls -->
            <div class="section-card accent-theme" style="background: #e8f5e9;">
                <h3 style="margin: 0 0 15px 0; color: #2e7d32;"> Bulk Price Adjustment (Existing Items)</h3>
                <div style="display: flex; gap: 20px; align-items: end; flex-wrap: wrap;">
                    <div class="form-group" style="margin: 0; min-width: 200px;">
                        <label>Increase by Percentage</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="pricesimPercent" value="10" min="0" max="50" step="0.5" style="flex: 1;" oninput="updatePercentLabel(); clearFlatAmount()">
                            <span id="pricesimPercentLabel" style="font-weight: bold; color: #2e7d32; min-width: 50px; text-align: right;">10%</span>
                        </div>
                    </div>
                    <div style="color: #666; font-size: 14px; padding-bottom: 8px;"> OR </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Increase by Flat Amount</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="font-size: 18px; font-weight: bold;">$</span>
                            <input type="number" id="pricesimFlat" value="0" min="0" step="0.01" style="width: 80px;" oninput="clearPercentAmount()">
                        </div>
                    </div>
                    <button class="btn" onclick="previewPriceChanges()" style="height: 42px;">
                         Preview Changes
                    </button>
                </div>
            </div>
            
            <!-- Impact Summary Cards -->
            <div id="pricesimSummary" style="display: none; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                    <div style="background: #667eea; color: white; padding: 15px; border-radius: 12px; text-align: center; overflow: hidden;">
                        <div style="font-size: 12px; opacity: 0.9;">Selected Items</div>
                        <div id="simSelectedCount" style="font-size: 28px; font-weight: bold;">0</div>
                    </div>
                    <div style="background: #6c757d; color: white; padding: 15px; border-radius: 12px; text-align: center; overflow: hidden;">
                        <div style="font-size: 12px; opacity: 0.9;">Current Revenue</div>
                        <div id="simCurrentRevenue" style="font-size: 20px; font-weight: bold; word-break: break-all;">$0.00</div>
                    </div>
                    <div style="background: #28a745; color: white; padding: 15px; border-radius: 12px; text-align: center; overflow: hidden;">
                        <div style="font-size: 12px; opacity: 0.9;">New Revenue</div>
                        <div id="simNewRevenue" style="font-size: 20px; font-weight: bold; word-break: break-all;">$0.00</div>
                    </div>
                    <div style="background: #17a2b8; color: white; padding: 15px; border-radius: 12px; text-align: center; overflow: hidden;">
                        <div style="font-size: 12px; opacity: 0.9;">Revenue Increase</div>
                        <div id="simIncrease" style="font-size: 20px; font-weight: bold; word-break: break-all;">+$0.00</div>
                    </div>
                </div>
            </div>
            
            <!-- INVENTORY IMPACT - Simple info strip style -->
            <div id="pricesimInventoryImpact" style="display: none; margin-bottom: 20px; padding: 15px 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px;"></span>
                        <span style="font-weight: 600; color: #495057;">Inventory Impact:</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: #6c757d; text-transform: uppercase;">Current Value</div>
                            <div id="simCurrentInvValue" style="font-size: 16px; font-weight: bold; color: #495057;">$0.00</div>
                        </div>
                        <div style="font-size: 20px; color: #adb5bd;"></div>
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: #6c757d; text-transform: uppercase;">New Value</div>
                            <div id="simNewInvValue" style="font-size: 16px; font-weight: bold; color: #495057;">$0.00</div>
                        </div>
                        <div style="font-size: 20px; color: #adb5bd;">=</div>
                        <div style="text-align: center; background: #d4edda; padding: 8px 15px; border-radius: 6px;">
                            <div style="font-size: 11px; color: #155724; text-transform: uppercase;">Extra Profit</div>
                            <div id="simInvProfit" style="font-size: 18px; font-weight: bold; color: #155724;">+$0.00</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Apply Button - MOVED BEFORE TABLE (#5) -->
            <div id="pricesimApplySection" class="section-card accent-theme" style="display: none; background: #fff3cd;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <strong style="font-size: 18px;"> Ready to Apply Changes?</strong>
                        <p style="margin: 5px 0 0 0; color: #666;">This will update the Unit Sell Price for all selected items in your database.</p>
                    </div>
                    <button class="btn" onclick="applyPriceChanges()" style="font-size: 16px; padding: 15px 30px;">
                         APPLY CHANGES TO <span id="applyCount">0</span> ITEMS
                    </button>
                </div>
            </div>
            
            <!-- Items Table -->
            <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
                        <input type="checkbox" id="pricesimSelectAll" onchange="toggleAllPriceSimItems()" style="width: 18px; height: 18px;">
                        <strong>Select All Visible Items</strong>
                    </label>
                    <div style="background: #e3f2fd; padding: 8px 12px; border-radius: 6px; border-left: 3px solid #1976d2;">
                        <p style="margin: 0; font-size: 13px; color: #1565c0;">
                            <strong> Tip:</strong> Check the items you want to update, then click Preview Changes
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="data-display-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 2px solid #e0e0e0;">
                    <h3 style="margin: 0; color: #667eea;"> Items in Simulation</h3>
                    <button class="btn" onclick="loadPriceSimItems()" style="background: var(--primary, #667eea); color: white;"> Refresh Items</button>
                </div>
                <div id="pricesimTable" style="overflow-x: auto;"></div>
            </div>
        </div>
        
        <!-- INVENTORY FLOW DASHBOARD TAB -->
        <div id="invflow" class="card">
            <h2> Inventory Flow Dashboard</h2>
            <p style="color: #666; margin-bottom: 20px;">Real-time visibility into inventory movement: what's coming in, what's going out, and what needs attention</p>
            
            <!-- Critical Alerts Section -->
            <div class="content-card" style="margin-bottom: 20px; border-left: 4px solid #dc2626;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #dc2626;"> Critical Alerts</h3>
                    <button class="btn-small" onclick="refreshInventoryFlowWithTimeout()" style="background: #dc2626; color: white;"> Refresh</button>
                </div>
                <div id="invflowAlerts">
                    <!-- Alerts populated by JavaScript -->
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <div style="font-size: 32px; margin-bottom: 10px;"></div>
                        <div>Loading alerts...</div>
                    </div>
                </div>
            </div>
            
            <!-- Summary Metrics -->
            <div class="content-card" style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; color: #667eea;"> Summary Metrics</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <!-- Total On Order -->
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 12px; border: 2px solid #1976d2;">
                        <div style="font-size: 36px; margin-bottom: 8px;"></div>
                        <div style="font-size: 32px; font-weight: bold; color: #0d47a1;" id="invflowTotalOnOrder">0</div>
                        <div style="font-size: 14px; color: #1565c0; margin-top: 4px;">Total On Order</div>
                    </div>
                    
                    <!-- Total Backorder -->
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 12px; border: 2px solid #f57c00;">
                        <div style="font-size: 36px; margin-bottom: 8px;"></div>
                        <div style="font-size: 32px; font-weight: bold; color: #e65100;" id="invflowTotalBackorder">0</div>
                        <div style="font-size: 14px; color: #ef6c00; margin-top: 4px;">Total Backorder</div>
                    </div>
                    
                    <!-- Expected This Week -->
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 12px; border: 2px solid #388e3c;">
                        <div style="font-size: 36px; margin-bottom: 8px;"></div>
                        <div style="font-size: 32px; font-weight: bold; color: #1b5e20;" id="invflowPOsThisWeek">0</div>
                        <div style="font-size: 14px; color: #2e7d32; margin-top: 4px;">POs This Week</div>
                    </div>
                    
                    <!-- Total Value Pending -->
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-radius: 12px; border: 2px solid #7b1fa2;">
                        <div style="font-size: 36px; margin-bottom: 8px;"></div>
                        <div style="font-size: 32px; font-weight: bold; color: #4a148c;" id="invflowTotalValue">$0</div>
                        <div style="font-size: 14px; color: #6a1b9a; margin-top: 4px;">Value Pending</div>
                    </div>
                </div>
            </div>
            
            <!-- Items On Backorder Section -->
            <div class="content-card" style="margin-bottom: 20px; border-left: 4px solid #f57c00;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #f57c00;"> Items On Backorder <span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 12px; font-size: 14px; margin-left: 8px;" id="invflowBackorderCount">0</span></h3>
                    <button class="btn-small" onclick="switchTab('createpo')" style="background: #f57c00; color: white;">+ Create PO</button>
                </div>
                <div id="invflowBackorderItems">
                    <!-- Backorder items populated by JavaScript -->
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                        <div style="font-size: 16px; color: #666;">No items on backorder</div>
                        <div style="font-size: 14px; color: #999; margin-top: 8px;">All customer orders can be fulfilled!</div>
                    </div>
                </div>
            </div>
            
            <!-- Pending Arrivals Section -->
            <div class="content-card" style="margin-bottom: 20px; border-left: 4px solid #1976d2;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #1976d2;"> Pending Arrivals <span style="background: #2196f3; color: white; padding: 2px 8px; border-radius: 12px; font-size: 14px; margin-left: 8px;" id="invflowPendingCount">0</span></h3>
                    <button class="btn-small" onclick="switchTab('purchases')" style="background: #1976d2; color: white;">View All POs</button>
                </div>
                <div id="invflowPendingPOs">
                    <!-- Pending POs populated by JavaScript -->
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                        <div style="font-size: 16px; color: #666;">No pending arrivals</div>
                        <div style="font-size: 14px; color: #999; margin-top: 8px;">No purchase orders expected</div>
                    </div>
                </div>
            </div>
            
            <!-- Critical Items Section -->
            <div class="content-card" style="border-left: 4px solid #dc2626;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #dc2626;"> Critical Items <span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 12px; font-size: 14px; margin-left: 8px;" id="invflowCriticalCount">0</span></h3>
                    <button class="btn-small" onclick="viewCriticalItemsReport()" style="background: #dc2626; color: white;"> View Report</button>
                </div>
                <div id="invflowCriticalItems">
                    <!-- Critical items populated by JavaScript -->
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                        <div style="font-size: 16px; color: #666;">No critical items</div>
                        <div style="font-size: 14px; color: #999; margin-top: 8px;">All items have adequate stock levels</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- REPORTS TAB -->
        <div id="reports" class="card active">
            <h2> Business Reports</h2>
            <div class="status" id="reportsStatus"></div>
            
            <p style="color: #666; margin-bottom: 20px;">Generate professional reports to analyze your business performance</p>
            
            <!-- Report Selection Buttons - Organized Grid -->
            <div class="report-grid">
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('dashboardReports')">
                        <h4> Dashboards</h4>
                        <span id="dashboardReports-toggle" class="report-toggle"></span>
                    </div>
                    <div id="dashboardReports" class="report-buttons">
                        <button class="btn report-btn" onclick="showReport('action-dashboard')" style="background: linear-gradient(135deg, #dc2626, #ef4444) !important; color: white !important; font-weight: 700; border-left: 4px solid #b91c1c !important;"> Action Dashboard</button>
                        <button class="btn report-btn" onclick="showReport('business-overview')"> Business Overview</button>
                        <button class="btn report-btn" onclick="showReport('daily-dashboard')"> Sales Dashboard</button>
                        <button class="btn report-btn" onclick="showReport('product-dashboard')"> Product Dashboard</button>
                        <button class="btn report-btn" onclick="showReport('customer-dashboard')"> Customer Dashboard</button>
                        <button class="btn report-btn" onclick="showReport('supplier-dashboard')"> Supplier Dashboard</button>
                    </div>
                </div>
                
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('salesReports')">
                        <h4> Sales Reports</h4>
                        <span id="salesReports-toggle" class="report-toggle"></span>
                    </div>
                    <div id="salesReports" class="report-buttons">
                        <button class="btn report-btn" onclick="showReport('sales-by-customer')"> Sales by Customer</button>
                        <button class="btn report-btn" onclick="showReport('sales-order-detail')"> Sales Order Detail</button>
                        <button class="btn report-btn" onclick="showReport('sales-by-product')"> Sales by Item</button>
                        <button class="btn report-btn" onclick="showReport('customer-backorders')"> Customer Backorders</button>
                        <button class="btn report-btn" onclick="showReport('pick-list')"> Pick List</button>
                        <button class="btn report-btn" onclick="showReport('dormant-customers')"> Dormant Customers</button>
                    </div>
                </div>
                
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('purchaseReports')">
                        <h4> Purchase Reports</h4>
                        <span id="purchaseReports-toggle" class="report-toggle"></span>
                    </div>
                    <div id="purchaseReports" class="report-buttons">
                        <button class="btn report-btn" onclick="showReport('purchase-by-supplier')"> Purchase by Supplier</button>
                        <button class="btn report-btn" onclick="showReport('purchase-order-detail')"> Purchase Order Detail</button>
                        <button class="btn report-btn" onclick="showReport('supplier-performance')"> Supplier Performance</button>
                    </div>
                </div>
                
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('inventoryReports')">
                        <h4> Inventory Reports</h4>
                        <span id="inventoryReports-toggle" class="report-toggle"></span>
                    </div>
                    <div id="inventoryReports" class="report-buttons">
                        <button class="btn report-btn" onclick="switchTab('invflow')"> Inventory Flow Dashboard</button>
                        <button class="btn report-btn" onclick="showReport('simple-inventory')"> Inventory List</button>
                        <button class="btn report-btn" onclick="showReport('inventory-turnover')"> Inventory Turnover</button>
                        <button class="btn report-btn" onclick="showReport('gross-margin')"> Gross Margin</button>
                        <button class="btn report-btn" onclick="showReport('inventory-adjustments')"> Adjustment History</button>
                    </div>
                </div>
                
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('financialReports')">
                        <h4> Financial Reports</h4>
                        <span id="financialReports-toggle" class="report-toggle"></span>
                    </div>
                    <div id="financialReports" class="report-buttons">
                        <button class="btn report-btn report-btn-green" onclick="showReport('accounts-receivable')"> Accounts Receivable</button>
                        <button class="btn report-btn report-btn-red" onclick="showReport('accounts-payable')"> Accounts Payable</button>
                    </div>
                </div>
                
                <div class="report-category">
                    <div class="report-category-header" onclick="toggleReportSection('taxReports')">
                        <h4> Tax & Annual Reports</h4>
                        <span id="taxReports-toggle" class="report-toggle"></span>
                    </div>
                    <div id="taxReports" class="report-buttons">
                        <button class="btn report-btn" onclick="showReport('profit-loss')"> Profit & Loss Statement</button>
                        <button class="btn report-btn" onclick="showReport('annual-sales-summary')"> Annual Sales Summary</button>
                        <button class="btn report-btn" onclick="showReport('annual-purchase-summary')"> Annual Purchase Summary</button>
                        <button class="btn report-btn" onclick="showReport('inventory-valuation')"> Inventory Valuation</button>
                        <button class="btn report-btn" onclick="showReport('cash-flow-summary')"> Cash Flow Summary</button>
                    </div>
                </div>
            </div>
            
            <!-- Report Container -->
            <div class="data-display-card">
                <div id="reportContainer"></div>
            </div>
        </div>
        
        <!-- HELP & GUIDES TAB -->
        <div id="guides" class="card">
            <!-- Premium Header -->
            <div style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; padding: 35px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(5, 150, 105, 0.3), 0 4px 12px rgba(0,0,0,0.1); border: 2px solid rgba(255, 255, 255, 0.1);">
                <h2 style="margin: 0 0 10px 0; font-size: 32px; display: flex; align-items: center; gap: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                     Help Center & User Guides
                </h2>
                <p style="margin: 0; font-size: 16px; opacity: 0.95;">
                    Everything you need to master the Nowak Distributing ERP system
                </p>
            </div>
            
            <!-- Quick Start Banner -->
            <div onclick="scrollToGuideSection('quick-start')" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 16px; padding: 25px; margin-bottom: 30px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(245, 158, 11, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(245, 158, 11, 0.3)';">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="font-size: 48px;"></div>
                    <div>
                        <h3 style="margin: 0 0 8px 0; color: #1f2937; font-size: 22px;">New Here? Start with the 5-Minute Quick Start Guide</h3>
                        <p style="margin: 0; color: #374151; font-size: 15px;">Get up and running in minutes with our streamlined setup guide</p>
                    </div>
                    <div style="margin-left: auto; font-size: 24px; color: #1f2937;"></div>
                </div>
            </div>
            
            <!-- Guide Navigation Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px;">
                
                <!-- Quick Start Card -->
                <div onclick="scrollToGuideSection('quick-start')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#059669'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Quick Start Guide</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">5-minute setup to get running</p>
                    <div style="margin-top: 12px; color: #059669; font-weight: 600; font-size: 13px;">START HERE </div>
                </div>
                
                <!-- Getting Started Card -->
                <div onclick="scrollToGuideSection('getting-started')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#3b82f6'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Getting Started Tutorial</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Complete 30-minute walkthrough</p>
                    <div style="margin-top: 12px; color: #3b82f6; font-weight: 600; font-size: 13px;">READ GUIDE </div>
                </div>
                
                <!-- Feature Overview Card -->
                <div onclick="scrollToGuideSection('features')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#8b5cf6'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Feature Overview</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">What's new & all features</p>
                    <div style="margin-top: 12px; color: #8b5cf6; font-weight: 600; font-size: 13px;">EXPLORE </div>
                </div>
                
                <!-- FAQ Card -->
                <div onclick="scrollToGuideSection('faq')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#f59e0b'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">FAQ</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Most asked questions answered</p>
                    <div style="margin-top: 12px; color: #f59e0b; font-weight: 600; font-size: 13px;">GET ANSWERS </div>
                </div>
                
                <!-- How-To Guides Card -->
                <div onclick="scrollToGuideSection('how-to')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#10b981'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">How-To Guides</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Step-by-step task instructions</p>
                    <div style="margin-top: 12px; color: #10b981; font-weight: 600; font-size: 13px;">VIEW ALL </div>
                </div>
                
                <!-- Mobile App Guide Card -->
                <div onclick="scrollToGuideSection('mobile')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#ec4899'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Mobile Access Guide</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Android, iPhone & tablet setup</p>
                    <div style="margin-top: 12px; color: #ec4899; font-weight: 600; font-size: 13px;">SETUP MOBILE </div>
                </div>
                
                <!-- Keyboard Shortcuts Card -->
                <div onclick="scrollToGuideSection('shortcuts')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#6366f1'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Keyboard Shortcuts</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Work faster with shortcuts</p>
                    <div style="margin-top: 12px; color: #6366f1; font-weight: 600; font-size: 13px;">LEARN SHORTCUTS </div>
                </div>
                
                <!-- Troubleshooting Card -->
                <div onclick="scrollToGuideSection('troubleshooting')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#ef4444'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Troubleshooting</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Fix common issues quickly</p>
                    <div style="margin-top: 12px; color: #ef4444; font-weight: 600; font-size: 13px;">GET HELP </div>
                </div>
                
                <!-- Best Practices Card -->
                <div onclick="scrollToGuideSection('best-practices')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#14b8a6'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Best Practices</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Tips from power users</p>
                    <div style="margin-top: 12px; color: #14b8a6; font-weight: 600; font-size: 13px;">LEARN TIPS </div>
                </div>
                
                <!-- Data Import/Export Card -->
                <div onclick="scrollToGuideSection('import-export')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#0891b2'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Data Import/Export</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Move data in and out</p>
                    <div style="margin-top: 12px; color: #0891b2; font-weight: 600; font-size: 13px;">VIEW GUIDE </div>
                </div>
                
                <!-- Backup & Recovery Card -->
                <div onclick="scrollToGuideSection('backup')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#7c3aed'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Backup & Recovery</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Protect your data</p>
                    <div style="margin-top: 12px; color: #7c3aed; font-weight: 600; font-size: 13px;">LEARN MORE </div>
                </div>
                
                <!-- Quick Reference Card -->
                <div onclick="scrollToGuideSection('cheatsheet')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#ea580c'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Quick Reference Card</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Printable cheat sheet</p>
                    <div style="margin-top: 12px; color: #ea580c; font-weight: 600; font-size: 13px;">PRINT IT </div>
                </div>
                
                <!-- Error Messages Card -->
                <div onclick="scrollToGuideSection('errors')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#dc2626'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Error Messages</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">What they mean & fixes</p>
                    <div style="margin-top: 12px; color: #dc2626; font-weight: 600; font-size: 13px;">DECODE ERRORS </div>
                </div>
                
                <!-- Browser Compatibility Card -->
                <div onclick="scrollToGuideSection('browsers')" class="guide-nav-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#2563eb'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 12px;"></div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Browser Compatibility</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">Supported browsers & devices</p>
                    <div style="margin-top: 12px; color: #2563eb; font-weight: 600; font-size: 13px;">CHECK COMPATIBILITY </div>
                </div>
                
            </div>
            
            <!-- GUIDE CONTENT SECTIONS -->
            <div id="guide-content-container" style="background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden;">
            
                <!-- ==================== QUICK START GUIDE ==================== -->
                <div id="guide-quick-start" class="guide-content-section" style="padding: 40px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #059669;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Quick Start Guide</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Get up and running in 5 minutes</p>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 12px; padding: 25px; margin-bottom: 30px; border-left: 5px solid #059669;">
                        <h4 style="margin: 0 0 10px 0; color: #065f46;"> Welcome to Nowak Distributing ERP!</h4>
                        <p style="margin: 0; color: #047857;">This quick start guide will have you managing your snack distribution business like a pro in just 5 minutes. Follow these simple steps to get started.</p>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- Step 1 -->
                        <div style="display: flex; gap: 20px; align-items: flex-start; padding: 25px; background: #f8fafc; border-radius: 12px; border-left: 5px solid #3b82f6;">
                            <div style="background: #3b82f6; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; flex-shrink: 0;">1</div>
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #1e40af;">Add Your Suppliers</h4>
                                <p style="margin: 0; color: #475569;">Click <strong>Suppliers</strong> in the navigation  Click <strong>+ Add Supplier</strong>  Enter supplier info (Better Made, Brimhall, Kim's Processing)  Save</p>
                                <div style="margin-top: 10px; padding: 10px; background: #dbeafe; border-radius: 6px; font-size: 13px; color: #1e40af;">
                                     <strong>Pro Tip:</strong> Add phone numbers and emails so you can quickly contact suppliers when placing orders.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 2 -->
                        <div style="display: flex; gap: 20px; align-items: flex-start; padding: 25px; background: #f8fafc; border-radius: 12px; border-left: 5px solid #8b5cf6;">
                            <div style="background: #8b5cf6; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; flex-shrink: 0;">2</div>
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #6d28d9;">Add Your Products (Items)</h4>
                                <p style="margin: 0; color: #475569;">Click <strong>Items</strong>  Click <strong>+ Add Item</strong>  Select supplier, enter SKU, description, package cost, sell price, and units per package  Save</p>
                                <div style="margin-top: 10px; padding: 10px; background: #ede9fe; border-radius: 6px; font-size: 13px; color: #6d28d9;">
                                     <strong>Pro Tip:</strong> The unit cost calculates automatically from package cost  units per package.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 3 -->
                        <div style="display: flex; gap: 20px; align-items: flex-start; padding: 25px; background: #f8fafc; border-radius: 12px; border-left: 5px solid #10b981;">
                            <div style="background: #10b981; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; flex-shrink: 0;">3</div>
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #047857;">Add Your Customers</h4>
                                <p style="margin: 0; color: #475569;">Click <strong>Customers</strong>  Click <strong>+ Add Customer</strong>  Enter business name, contact info, and payment terms  Save</p>
                                <div style="margin-top: 10px; padding: 10px; background: #d1fae5; border-radius: 6px; font-size: 13px; color: #047857;">
                                     <strong>Pro Tip:</strong> Set payment terms (Net 30, COD, etc.) to track when payments are due.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 4 -->
                        <div style="display: flex; gap: 20px; align-items: flex-start; padding: 25px; background: #f8fafc; border-radius: 12px; border-left: 5px solid #f59e0b;">
                            <div style="background: #f59e0b; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; flex-shrink: 0;">4</div>
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #b45309;">Create Your First Purchase Order</h4>
                                <p style="margin: 0; color: #475569;">Click <strong>Create PO</strong>  Select supplier  Add items and quantities  Set dates  Click <strong>Submit PO</strong></p>
                                <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 13px; color: #b45309;">
                                     <strong>Pro Tip:</strong> Use the "Add All Items" button to quickly add every item from that supplier.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 5 -->
                        <div style="display: flex; gap: 20px; align-items: flex-start; padding: 25px; background: #f8fafc; border-radius: 12px; border-left: 5px solid #ec4899;">
                            <div style="background: #ec4899; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; flex-shrink: 0;">5</div>
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #be185d;">Create Your First Sales Order</h4>
                                <p style="margin: 0; color: #475569;">Click <strong>Sales</strong>  Click <strong>+ Create Invoice</strong>  Select customer  Add items  Save & Print invoice</p>
                                <div style="margin-top: 10px; padding: 10px; background: #fce7f3; border-radius: 6px; font-size: 13px; color: #be185d;">
                                     <strong>Pro Tip:</strong> Use the Pick List report to see what items you need to gather for delivery.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #059669 0%, #10b981 100%); border-radius: 12px; color: white; text-align: center;">
                        <h3 style="margin: 0 0 10px 0;"> You're Ready to Go!</h3>
                        <p style="margin: 0; opacity: 0.95;">Now explore the Reports section to see your business analytics and dashboards.</p>
                        <button onclick="switchTab('reports')" style="margin-top: 15px; background: white; color: #059669; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 15px;">View Reports </button>
                    </div>
                </div>
                
                <!-- ==================== GETTING STARTED TUTORIAL ==================== -->
                <div id="guide-getting-started" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #3b82f6;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Complete Getting Started Tutorial</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">30-minute comprehensive walkthrough</p>
                        </div>
                    </div>
                    
                    <!-- Table of Contents -->
                    <div style="background: #f1f5f9; border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                        <h4 style="margin: 0 0 15px 0; color: #334155;"> Table of Contents</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <a href="#gs-overview" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">1. System Overview</a>
                            <a href="#gs-navigation" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">2. Navigation Guide</a>
                            <a href="#gs-suppliers" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">3. Managing Suppliers</a>
                            <a href="#gs-items" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">4. Managing Items</a>
                            <a href="#gs-customers" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">5. Managing Customers</a>
                            <a href="#gs-purchasing" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">6. Purchase Orders</a>
                            <a href="#gs-sales" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">7. Sales & Invoicing</a>
                            <a href="#gs-inventory" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">8. Inventory Management</a>
                            <a href="#gs-reports" style="color: #3b82f6; text-decoration: none; padding: 8px 12px; background: white; border-radius: 6px; font-size: 14px;">9. Reports & Analytics</a>
                        </div>
                    </div>
                    
                    <!-- Section 1: Overview -->
                    <div id="gs-overview" style="margin-bottom: 40px;">
                        <h3 style="color: #1e40af; border-bottom: 2px solid #dbeafe; padding-bottom: 10px;">1. System Overview</h3>
                        <p style="color: #475569; line-height: 1.7;">The Nowak Distributing ERP is a complete business management system designed specifically for snack food distribution. It handles everything from managing your supplier relationships and product catalog to processing purchase orders, creating customer invoices, tracking inventory, and generating business reports.</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div style="background: #eff6ff; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; margin-bottom: 8px;"></div>
                                <strong style="color: #1e40af;">Suppliers</strong>
                                <p style="margin: 5px 0 0 0; font-size: 13px; color: #64748b;">Better Made, Brimhall, Kim's</p>
                            </div>
                            <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; margin-bottom: 8px;"></div>
                                <strong style="color: #166534;">Items</strong>
                                <p style="margin: 5px 0 0 0; font-size: 13px; color: #64748b;">Your product catalog</p>
                            </div>
                            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; margin-bottom: 8px;"></div>
                                <strong style="color: #b45309;">Customers</strong>
                                <p style="margin: 5px 0 0 0; font-size: 13px; color: #64748b;">Stores, restaurants, etc.</p>
                            </div>
                            <div style="background: #fce7f3; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; margin-bottom: 8px;"></div>
                                <strong style="color: #be185d;">Reports</strong>
                                <p style="margin: 5px 0 0 0; font-size: 13px; color: #64748b;">Business analytics</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 2: Navigation -->
                    <div id="gs-navigation" style="margin-bottom: 40px;">
                        <h3 style="color: #1e40af; border-bottom: 2px solid #dbeafe; padding-bottom: 10px;">2. Navigation Guide</h3>
                        <p style="color: #475569; line-height: 1.7;">The navigation bar at the top of the screen provides quick access to all sections:</p>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                            <tr style="background: #f1f5f9;">
                                <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Tab</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Purpose</th>
                            </tr>
                            <tr><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Reports</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">View dashboards, sales reports, inventory reports, and business analytics</td></tr>
                            <tr style="background: #f8fafc;"><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Suppliers</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">Manage your vendor relationships (Better Made, Brimhall, Kim's)</td></tr>
                            <tr><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Items</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">Manage your product catalog with pricing</td></tr>
                            <tr style="background: #f8fafc;"><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Customers</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">Manage customer accounts and contact info</td></tr>
                            <tr><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Create PO</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">Create new purchase orders to suppliers</td></tr>
                            <tr style="background: #f8fafc;"><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Purchases</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">View and manage all purchase orders</td></tr>
                            <tr><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Sales</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">Create invoices and manage sales orders</td></tr>
                            <tr style="background: #f8fafc;"><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Inventory</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">Track stock levels and make adjustments</td></tr>
                            <tr><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Price Sim</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">Simulate price changes and see revenue impact</td></tr>
                            <tr style="background: #f8fafc;"><td style="padding: 12px; border: 1px solid #e2e8f0;"><strong> Help</strong></td><td style="padding: 12px; border: 1px solid #e2e8f0;">Access guides and documentation (you're here!)</td></tr>
                        </table>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <strong style="color: #b45309;"> Navigation Tips:</strong>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px; color: #92400e;">
                                <li>Use the  button (bottom-left) to scroll back to top</li>
                                <li>Use the  button to go back to the previous tab</li>
                                <li>Click the  gear icon (top-right) for settings and theme options</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Continue with more sections... -->
                    <div style="padding: 20px; background: #f1f5f9; border-radius: 12px; text-align: center;">
                        <p style="margin: 0; color: #64748b;">For detailed walkthroughs of each section, see the <strong>How-To Guides</strong> below.</p>
                    </div>
                </div>
                
                <!-- ==================== FEATURE OVERVIEW ==================== -->
                <div id="guide-features" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #8b5cf6;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Feature Overview & What's New</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">All features and recent updates</p>
                        </div>
                    </div>
                    
                    <!-- What's New Section -->
                    <div style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-radius: 12px; padding: 25px; margin-bottom: 30px; border: 2px solid #c4b5fd;">
                        <h4 style="margin: 0 0 15px 0; color: #7c3aed;"> Latest Updates (Version 10Y)</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #6d28d9;">
                            <li style="margin-bottom: 8px;"><strong>Number Formatting:</strong> All dollar amounts and quantities now display with commas for easier reading</li>
                            <li style="margin-bottom: 8px;"><strong>Inventory Flow Dashboard:</strong> Real-time visibility into inventory movement</li>
                            <li style="margin-bottom: 8px;"><strong>Partial PO Receiving:</strong> Receive partial shipments and track remaining quantities</li>
                            <li style="margin-bottom: 8px;"><strong>Enhanced Dashboards:</strong> Premium styling with gradient headers throughout</li>
                            <li style="margin-bottom: 8px;"><strong>Pick List Report:</strong> Efficiently gather items for delivery routes</li>
                            <li style="margin-bottom: 8px;"><strong>Dormant Customers Report:</strong> Identify and win back inactive customers with buying history</li>
                            <li><strong>13 Theme Options:</strong> Including Chicago sports teams and Green Bay Packers</li>
                        </ul>
                    </div>
                    
                    <!-- Feature Categories -->
                    <h3 style="color: #1f2937; margin-bottom: 20px;"> Complete Feature List</h3>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- Master Data -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #3b82f6;">
                            <h4 style="margin: 0 0 15px 0; color: #1e40af;"> Master Data Management</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Supplier Management</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Item/Product Catalog</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Customer Database</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Search & Filter</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Bulk Operations</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Archive/Restore</div>
                            </div>
                        </div>
                        
                        <!-- Purchasing -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #10b981;">
                            <h4 style="margin: 0 0 15px 0; color: #047857;"> Purchasing Features</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Create Purchase Orders</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Receive Full/Partial Shipments</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Track Payment Status</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Print PO Documents</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Edit Line Items</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Auto-Update Inventory</div>
                            </div>
                        </div>
                        
                        <!-- Sales -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #f59e0b;">
                            <h4 style="margin: 0 0 15px 0; color: #b45309;"> Sales & Invoicing</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Create Sales Orders</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Print Professional Invoices</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Payment Tracking</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Quick Item Picker</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Auto-Calculate Totals</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Pick List Generation</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Dormant Customer Tracking</div>
                            </div>
                        </div>
                        
                        <!-- Reporting -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #8b5cf6;">
                            <h4 style="margin: 0 0 15px 0; color: #6d28d9;"> Reports & Dashboards</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Action Dashboard</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Business Overview</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Sales Dashboard</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Inventory Flow Dashboard</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Customer & Product Analytics</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Dormant Customers Report</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Accounts Receivable/Payable</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Profit & Loss Statement</div>
                                <div style="padding: 10px; background: white; border-radius: 6px;"> Supplier Performance</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ==================== FAQ ==================== -->
                <div id="guide-faq" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #f59e0b;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Frequently Asked Questions</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Quick answers to common questions</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 15px;">
                        <!-- FAQ Item -->
                        <details style="background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <summary style="padding: 20px; cursor: pointer; font-weight: 600; color: #1f2937; background: #f8fafc;">How do I change the app's theme/colors?</summary>
                            <div style="padding: 20px; background: white; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; color: #475569;">Click the  gear icon in the top-right corner to open Settings. Under "Theme Selection," you'll find 13 different themes including Chicago sports teams (Bears, Bulls, Cubs, White Sox, Blackhawks, Fire) and the Green Bay Packers.</p>
                            </div>
                        </details>
                        
                        <details style="background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <summary style="padding: 20px; cursor: pointer; font-weight: 600; color: #1f2937; background: #f8fafc;">How does inventory tracking work?</summary>
                            <div style="padding: 20px; background: white; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; color: #475569;">Inventory is automatically updated when you:<br><br>
                                 <strong>Receive a PO:</strong> Inventory increases by the received quantity<br>
                                 <strong>Ship a Sales Order:</strong> Inventory decreases by the sold quantity<br>
                                 <strong>Manual Adjustment:</strong> Use the Inventory tab to manually adjust quantities with reason tracking</p>
                            </div>
                        </details>
                        
                        <details style="background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <summary style="padding: 20px; cursor: pointer; font-weight: 600; color: #1f2937; background: #f8fafc;">Can I receive a partial shipment on a PO?</summary>
                            <div style="padding: 20px; background: white; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; color: #475569;">Yes! When viewing a PO, click "Receive PO" and you can enter the actual quantities received for each line item. If you receive less than ordered, the PO will show status "Partially Received" and track the remaining quantity.</p>
                            </div>
                        </details>
                        
                        <details style="background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <summary style="padding: 20px; cursor: pointer; font-weight: 600; color: #1f2937; background: #f8fafc;">How do I print an invoice for a customer?</summary>
                            <div style="padding: 20px; background: white; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; color: #475569;">Go to <strong>Sales</strong>  Find the order  Click <strong>View</strong>  Click <strong> Print Invoice</strong>. The invoice will open in a print-friendly format with your business name and all order details.</p>
                            </div>
                        </details>
                        
                        <details style="background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <summary style="padding: 20px; cursor: pointer; font-weight: 600; color: #1f2937; background: #f8fafc;">What is the Action Dashboard?</summary>
                            <div style="padding: 20px; background: white; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; color: #475569;">The Action Dashboard shows items that need your immediate attention:<br><br>
                                 <strong>Past Due Payments:</strong> Customer invoices that haven't been paid<br>
                                 <strong>Late POs:</strong> Purchase orders past their expected date<br>
                                 <strong>Low Stock Items:</strong> Items below reorder point<br>
                                 <strong>Dead Stock:</strong> Items with no recent sales</p>
                            </div>
                        </details>
                        
                        <details style="background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <summary style="padding: 20px; cursor: pointer; font-weight: 600; color: #1f2937; background: #f8fafc;">How do I use the Price Simulator?</summary>
                            <div style="padding: 20px; background: white; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; color: #475569;">The Price Simulator lets you test "what if" scenarios:<br><br>
                                1. Go to <strong>Price Sim</strong> tab<br>
                                2. Select an item and enter a new sell price<br>
                                3. Click <strong>Calculate Impact</strong> to see how it affects your revenue<br>
                                4. If you like the result, click <strong>Apply Price</strong> to make it permanent</p>
                            </div>
                        </details>
                        
                        <details style="background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <summary style="padding: 20px; cursor: pointer; font-weight: 600; color: #1f2937; background: #f8fafc;">Where is my data stored?</summary>
                            <div style="padding: 20px; background: white; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; color: #475569;">All data is stored securely in Google Sheets connected to Google Apps Script. This means:<br><br>
                                 Your data is in your Google account<br>
                                 It's backed up automatically by Google<br>
                                 You can access it from any device<br>
                                 You can export to Excel anytime</p>
                            </div>
                        </details>
                        
                        <details style="background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <summary style="padding: 20px; cursor: pointer; font-weight: 600; color: #1f2937; background: #f8fafc;">Can I use this on my phone?</summary>
                            <div style="padding: 20px; background: white; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; color: #475569;">Yes! The ERP is fully responsive and works on any device. See the <strong>Mobile Access Guide</strong> section below for detailed instructions on adding it to your home screen for quick access.</p>
                            </div>
                        </details>
                    </div>
                </div>
                
                <!-- ==================== HOW-TO GUIDES ==================== -->
                <div id="guide-how-to" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #10b981;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">How-To Guides</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Click any task for step-by-step instructions</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        
                        <!-- Supplier Tasks -->
                        <div style="background: #eff6ff; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 15px 0; color: #1e40af;"> Supplier Tasks</h4>
                            <ul style="margin: 0; padding-left: 20px; line-height: 2.2; list-style: none;">
                                <li><a href="#" onclick="showTutorial('add-supplier'); return false;" style="color: #2563eb; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #3b82f6;"></span> How to add a new supplier</a></li>
                                <li><a href="#" onclick="showTutorial('edit-supplier'); return false;" style="color: #2563eb; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #3b82f6;"></span> How to edit supplier information</a></li>
                                <li><a href="#" onclick="showTutorial('supplier-history'); return false;" style="color: #2563eb; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #3b82f6;"></span> How to view supplier purchase history</a></li>
                                <li><a href="#" onclick="showTutorial('archive-supplier'); return false;" style="color: #2563eb; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #3b82f6;"></span> How to archive/restore a supplier</a></li>
                            </ul>
                        </div>
                        
                        <!-- Item Tasks -->
                        <div style="background: #f0fdf4; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 15px 0; color: #166534;"> Item/Product Tasks</h4>
                            <ul style="margin: 0; padding-left: 20px; line-height: 2.2; list-style: none;">
                                <li><a href="#" onclick="showTutorial('add-item'); return false;" style="color: #16a34a; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #22c55e;"></span> How to add a new item</a></li>
                                <li><a href="#" onclick="showTutorial('update-pricing'); return false;" style="color: #16a34a; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #22c55e;"></span> How to update item pricing</a></li>
                                <li><a href="#" onclick="showTutorial('set-reorder'); return false;" style="color: #16a34a; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #22c55e;"></span> How to set reorder points</a></li>
                                <li><a href="#" onclick="showTutorial('archive-item'); return false;" style="color: #16a34a; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #22c55e;"></span> How to archive discontinued items</a></li>
                            </ul>
                        </div>
                        
                        <!-- Customer Tasks -->
                        <div style="background: #fef3c7; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 15px 0; color: #b45309;"> Customer Tasks</h4>
                            <ul style="margin: 0; padding-left: 20px; line-height: 2.2; list-style: none;">
                                <li><a href="#" onclick="showTutorial('add-customer'); return false;" style="color: #d97706; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #f59e0b;"></span> How to add a new customer</a></li>
                                <li><a href="#" onclick="showTutorial('payment-terms'); return false;" style="color: #d97706; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #f59e0b;"></span> How to set payment terms</a></li>
                                <li><a href="#" onclick="showTutorial('customer-history'); return false;" style="color: #d97706; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #f59e0b;"></span> How to view customer order history</a></li>
                                <li><a href="#" onclick="showTutorial('track-balances'); return false;" style="color: #d97706; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #f59e0b;"></span> How to track outstanding balances</a></li>
                            </ul>
                        </div>
                        
                        <!-- Purchase Order Tasks -->
                        <div style="background: #ede9fe; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 15px 0; color: #6d28d9;"> Purchase Order Tasks</h4>
                            <ul style="margin: 0; padding-left: 20px; line-height: 2.2; list-style: none;">
                                <li><a href="#" onclick="showTutorial('create-po'); return false;" style="color: #7c3aed; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #8b5cf6;"></span> How to create a purchase order</a></li>
                                <li><a href="#" onclick="showTutorial('receive-shipment'); return false;" style="color: #7c3aed; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #8b5cf6;"></span> How to receive a shipment</a></li>
                                <li><a href="#" onclick="showTutorial('partial-receive'); return false;" style="color: #7c3aed; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #8b5cf6;"></span> How to receive partial shipments</a></li>
                                <li><a href="#" onclick="showTutorial('pay-supplier'); return false;" style="color: #7c3aed; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #8b5cf6;"></span> How to record payment to supplier</a></li>
                                <li><a href="#" onclick="showTutorial('print-po'); return false;" style="color: #7c3aed; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #8b5cf6;"></span> How to print/email a PO</a></li>
                            </ul>
                        </div>
                        
                        <!-- Sales Tasks -->
                        <div style="background: #fce7f3; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 15px 0; color: #be185d;"> Sales & Invoice Tasks</h4>
                            <ul style="margin: 0; padding-left: 20px; line-height: 2.2; list-style: none;">
                                <li><a href="#" onclick="showTutorial('create-invoice'); return false;" style="color: #db2777; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #ec4899;"></span> How to create a sales order/invoice</a></li>
                                <li><a href="#" onclick="showTutorial('item-picker'); return false;" style="color: #db2777; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #ec4899;"></span> How to use the quick item picker</a></li>
                                <li><a href="#" onclick="showTutorial('print-invoice'); return false;" style="color: #db2777; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #ec4899;"></span> How to print an invoice</a></li>
                                <li><a href="#" onclick="showTutorial('record-payment'); return false;" style="color: #db2777; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #ec4899;"></span> How to record customer payment</a></li>
                                <li><a href="#" onclick="showTutorial('pick-list'); return false;" style="color: #db2777; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #ec4899;"></span> How to generate a pick list</a></li>
                                <li><a href="#" onclick="showTutorial('dormant-customers'); return false;" style="color: #db2777; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #ec4899;"></span> How to win back dormant customers</a></li>
                            </ul>
                        </div>
                        
                        <!-- Inventory Tasks -->
                        <div style="background: #f1f5f9; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 15px 0; color: #475569;"> Inventory Tasks</h4>
                            <ul style="margin: 0; padding-left: 20px; line-height: 2.2; list-style: none;">
                                <li><a href="#" onclick="showTutorial('view-inventory'); return false;" style="color: #475569; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #64748b;"></span> How to view current inventory levels</a></li>
                                <li><a href="#" onclick="showTutorial('adjust-inventory'); return false;" style="color: #475569; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #64748b;"></span> How to make manual adjustments</a></li>
                                <li><a href="#" onclick="showTutorial('low-stock'); return false;" style="color: #475569; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #64748b;"></span> How to track low stock items</a></li>
                                <li><a href="#" onclick="showTutorial('inventory-flow'); return false;" style="color: #475569; text-decoration: none; display: flex; align-items: center; gap: 8px;"><span style="color: #64748b;"></span> How to use Inventory Flow Dashboard</a></li>
                            </ul>
                        </div>
                        
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f0f9ff; border-radius: 12px; border-left: 4px solid #0ea5e9;">
                        <p style="margin: 0; color: #0369a1;"><strong> Tip:</strong> Click any task above to see detailed step-by-step instructions. Each guide includes numbered steps and helpful tips!</p>
                    </div>
                </div>
                
                <!-- ==================== MOBILE ACCESS GUIDE ==================== -->
                <div id="guide-mobile" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #ec4899;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Mobile Access Guide</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Access the ERP from any phone or tablet</p>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%); border-radius: 12px; padding: 25px; margin-bottom: 30px; border: 2px solid #f9a8d4;">
                        <p style="margin: 0; color: #9d174d;"> The Nowak Distributing ERP works perfectly on mobile devices! For the best experience, add it to your home screen to launch it like a native app.</p>
                    </div>
                    
                    <!-- Android Instructions -->
                    <div style="background: #f0fdf4; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-left: 5px solid #22c55e;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                            <span style="font-size: 32px;"></span>
                            <h3 style="margin: 0; color: #166534;">Android Setup (Samsung, Google Pixel, etc.)</h3>
                        </div>
                        
                        <div style="display: grid; gap: 15px;">
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #22c55e; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</div>
                                <div>
                                    <strong>Open Chrome Browser</strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">Navigate to the ERP website in Google Chrome</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #22c55e; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</div>
                                <div>
                                    <strong>Tap the Menu ()</strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">Tap the three dots in the top-right corner of Chrome</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #22c55e; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">3</div>
                                <div>
                                    <strong>Tap "Add to Home screen"</strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">Scroll down in the menu and select this option</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #22c55e; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">4</div>
                                <div>
                                    <strong>Name it "Nowak ERP"</strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">Enter a short name and tap "Add"</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #22c55e; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">5</div>
                                <div>
                                    <strong>Done! </strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">Find the icon on your home screen and tap to launch</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- iPhone Instructions -->
                    <div style="background: #f1f5f9; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-left: 5px solid #6b7280;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                            <span style="font-size: 32px;"></span>
                            <h3 style="margin: 0; color: #374151;">iPhone & iPad Setup</h3>
                        </div>
                        
                        <div style="display: grid; gap: 15px;">
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #6b7280; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</div>
                                <div>
                                    <strong>Open Safari Browser</strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">Navigate to the ERP website in Safari (required for iOS)</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #6b7280; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</div>
                                <div>
                                    <strong>Tap the Share Button ()</strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">Tap the share icon at the bottom of Safari</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #6b7280; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">3</div>
                                <div>
                                    <strong>Tap "Add to Home Screen"</strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">Scroll down in the share menu to find this option</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="background: #6b7280; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">4</div>
                                <div>
                                    <strong>Name it "Nowak ERP" and tap Add</strong>
                                    <p style="margin: 5px 0 0 0; color: #475569;">The app icon will appear on your home screen</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Samsung Specific -->
                    <div style="background: #eff6ff; border-radius: 12px; padding: 25px; border-left: 5px solid #3b82f6;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                            <span style="font-size: 28px;"></span>
                            <h4 style="margin: 0; color: #1e40af;">Samsung Internet Browser (Alternative)</h4>
                        </div>
                        <p style="margin: 0; color: #475569;">If using Samsung Internet: Tap the menu ()  "Add page to"  "Home screen"</p>
                    </div>
                    
                    <!-- Mobile Tips -->
                    <div style="margin-top: 30px; padding: 20px; background: #fef3c7; border-radius: 12px; border-left: 4px solid #f59e0b;">
                        <h4 style="margin: 0 0 10px 0; color: #b45309;"> Mobile Tips</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #92400e;">
                            <li>Turn your phone sideways (landscape) for better table viewing</li>
                            <li>Use pinch-to-zoom on reports and invoices</li>
                            <li>The navigation grid works great with one-handed scrolling</li>
                            <li>All printing works through your phone's print system</li>
                        </ul>
                    </div>
                </div>
                
                <!-- ==================== KEYBOARD SHORTCUTS ==================== -->
                <div id="guide-shortcuts" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #6366f1;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Keyboard Shortcuts & Tips</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Work faster with these shortcuts</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        
                        <!-- General Shortcuts -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 20px 0; color: #475569;"> General Navigation</h4>
                            <table style="width: 100%; font-size: 14px;">
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Tab</kbd></td><td>Move to next field</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Shift + Tab</kbd></td><td>Move to previous field</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Enter</kbd></td><td>Submit form / Confirm</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Esc</kbd></td><td>Close modal / Cancel</td></tr>
                            </table>
                        </div>
                        
                        <!-- Browser Shortcuts -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 20px 0; color: #475569;"> Browser Shortcuts</h4>
                            <table style="width: 100%; font-size: 14px;">
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Ctrl + P</kbd></td><td>Print current page</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Ctrl + F</kbd></td><td>Find on page</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Ctrl + R</kbd></td><td>Refresh page</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">F11</kbd></td><td>Full screen mode</td></tr>
                            </table>
                        </div>
                        
                        <!-- Form Tips -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px;">
                            <h4 style="margin: 0 0 20px 0; color: #475569;"> Form Tips</h4>
                            <table style="width: 100%; font-size: 14px;">
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;"></kbd></td><td>Open dropdown list</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Type</kbd></td><td>Search in dropdown</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Ctrl + A</kbd></td><td>Select all text in field</td></tr>
                                <tr><td style="padding: 8px 0;"><kbd style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">Ctrl + Z</kbd></td><td>Undo typing</td></tr>
                            </table>
                        </div>
                        
                    </div>
                    
                    <div style="padding: 20px; background: #ede9fe; border-radius: 12px; border-left: 4px solid #8b5cf6;">
                        <h4 style="margin: 0 0 10px 0; color: #6d28d9;"> Pro Tips</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #5b21b6;">
                            <li>In dropdowns, start typing to jump to matching options</li>
                            <li>Click column headers in tables to sort data</li>
                            <li>Use the search/filter boxes to quickly find records</li>
                            <li>Double-click a row in many tables to view details</li>
                        </ul>
                    </div>
                </div>
                
                <!-- ==================== TROUBLESHOOTING ==================== -->
                <div id="guide-troubleshooting" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #ef4444;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Troubleshooting Guide</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Fix common issues quickly</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        
                        <!-- Issue 1 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 25px; border-left: 5px solid #ef4444;">
                            <h4 style="margin: 0 0 15px 0; color: #b91c1c;"> Data Not Loading / "Loading..." Stuck</h4>
                            <p style="margin: 0 0 15px 0; color: #7f1d1d;"><strong>Cause:</strong> Connection to Google Sheets backend may have timed out.</p>
                            <p style="margin: 0; color: #7f1d1d;"><strong>Solution:</strong></p>
                            <ol style="margin: 10px 0 0 0; padding-left: 20px; color: #991b1b;">
                                <li>Refresh the page (Ctrl+R or +R)</li>
                                <li>Wait 10-15 seconds for data to load</li>
                                <li>If still stuck, check your internet connection</li>
                                <li>Clear browser cache: Settings  Privacy  Clear browsing data</li>
                            </ol>
                        </div>
                        
                        <!-- Issue 2 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 25px; border-left: 5px solid #ef4444;">
                            <h4 style="margin: 0 0 15px 0; color: #b91c1c;"> Changes Not Saving</h4>
                            <p style="margin: 0 0 15px 0; color: #7f1d1d;"><strong>Cause:</strong> Form validation failed or network issue.</p>
                            <p style="margin: 0; color: #7f1d1d;"><strong>Solution:</strong></p>
                            <ol style="margin: 10px 0 0 0; padding-left: 20px; color: #991b1b;">
                                <li>Check for red error messages on the form</li>
                                <li>Make sure all required fields (marked with *) are filled</li>
                                <li>Look for the green "Success" message after saving</li>
                                <li>If no message appears, refresh and try again</li>
                            </ol>
                        </div>
                        
                        <!-- Issue 3 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 25px; border-left: 5px solid #ef4444;">
                            <h4 style="margin: 0 0 15px 0; color: #b91c1c;"> Print Not Working</h4>
                            <p style="margin: 0 0 15px 0; color: #7f1d1d;"><strong>Cause:</strong> Browser popup blocker or print dialog issue.</p>
                            <p style="margin: 0; color: #7f1d1d;"><strong>Solution:</strong></p>
                            <ol style="margin: 10px 0 0 0; padding-left: 20px; color: #991b1b;">
                                <li>Allow popups for this site if prompted</li>
                                <li>Try Ctrl+P (or +P on Mac) after clicking Print</li>
                                <li>Make sure you have a printer selected</li>
                                <li>For PDF: Select "Save as PDF" in the print dialog</li>
                            </ol>
                        </div>
                        
                        <!-- Issue 4 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 25px; border-left: 5px solid #ef4444;">
                            <h4 style="margin: 0 0 15px 0; color: #b91c1c;"> Inventory Numbers Wrong</h4>
                            <p style="margin: 0 0 15px 0; color: #7f1d1d;"><strong>Cause:</strong> Orders may not have been marked as received/shipped.</p>
                            <p style="margin: 0; color: #7f1d1d;"><strong>Solution:</strong></p>
                            <ol style="margin: 10px 0 0 0; padding-left: 20px; color: #991b1b;">
                                <li>Check that POs are marked "Received" (not just "Submitted")</li>
                                <li>Verify Sales Orders are "Shipped" status</li>
                                <li>Use Inventory  Manual Adjustment to correct quantities</li>
                                <li>Check the Adjustment History report to see all changes</li>
                            </ol>
                        </div>
                        
                        <!-- Issue 5 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 25px; border-left: 5px solid #ef4444;">
                            <h4 style="margin: 0 0 15px 0; color: #b91c1c;"> Page Looks Wrong / Broken Layout</h4>
                            <p style="margin: 0 0 15px 0; color: #7f1d1d;"><strong>Cause:</strong> Cached old version of the page.</p>
                            <p style="margin: 0; color: #7f1d1d;"><strong>Solution:</strong></p>
                            <ol style="margin: 10px 0 0 0; padding-left: 20px; color: #991b1b;">
                                <li>Hard refresh: Ctrl+Shift+R (or +Shift+R on Mac)</li>
                                <li>Clear cache: Ctrl+Shift+Delete  Clear cached images/files</li>
                                <li>Try a different browser (Chrome, Firefox, Edge)</li>
                            </ol>
                        </div>
                        
                    </div>
                    
                    <div style="margin-top: 30px; padding: 25px; background: #f0f9ff; border-radius: 12px; text-align: center;">
                        <h4 style="margin: 0 0 10px 0; color: #0369a1;">Still Having Issues?</h4>
                        <p style="margin: 0; color: #0c4a6e;">Contact your system administrator or check the browser console (F12) for error messages.</p>
                    </div>
                </div>
                
                <!-- ==================== BEST PRACTICES GUIDE ==================== -->
                <div id="guide-best-practices" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #14b8a6;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Best Practices Guide</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Tips and tricks from power users</p>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%); border-radius: 12px; padding: 25px; margin-bottom: 30px; border: 2px solid #5eead4;">
                        <p style="margin: 0; color: #0f766e;"> These best practices will help you get the most out of the Nowak Distributing ERP and keep your business running smoothly.</p>
                    </div>
                    
                    <div style="display: grid; gap: 25px;">
                        
                        <!-- Daily Habits -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #14b8a6;">
                            <h4 style="margin: 0 0 15px 0; color: #0f766e;"> Daily Habits</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                                <li><strong>Start with the Action Dashboard</strong> - Check it first thing every morning to see what needs immediate attention</li>
                                <li><strong>Record sales same-day</strong> - Enter invoices the day they happen to keep inventory accurate</li>
                                <li><strong>Mark payments promptly</strong> - Record payments as soon as received to track cash flow</li>
                                <li><strong>Check low stock alerts</strong> - Review items below reorder point before the weekly order</li>
                            </ul>
                        </div>
                        
                        <!-- Weekly Tasks -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #3b82f6;">
                            <h4 style="margin: 0 0 15px 0; color: #1e40af;"> Weekly Tasks</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                                <li><strong>Review Accounts Receivable</strong> - Follow up on past-due invoices every week</li>
                                <li><strong>Check supplier PO status</strong> - Make sure expected deliveries are on track</li>
                                <li><strong>Run the Business Overview report</strong> - Track your weekly performance trends</li>
                                <li><strong>Backup your data</strong> - Export key reports to Excel for safekeeping</li>
                            </ul>
                        </div>
                        
                        <!-- Data Entry Tips -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #8b5cf6;">
                            <h4 style="margin: 0 0 15px 0; color: #6d28d9;"> Data Entry Tips</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                                <li><strong>Use consistent naming</strong> - "Better Made" not "BetterMade" or "Better made"</li>
                                <li><strong>Include SKUs</strong> - Makes searching and matching items much easier</li>
                                <li><strong>Set reorder points</strong> - Prevents stockouts by alerting you early</li>
                                <li><strong>Use notes fields</strong> - Add details that help you remember special arrangements</li>
                                <li><strong>Double-check quantities</strong> - Verify numbers before saving orders</li>
                            </ul>
                        </div>
                        
                        <!-- Inventory Management -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #f59e0b;">
                            <h4 style="margin: 0 0 15px 0; color: #b45309;"> Inventory Best Practices</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                                <li><strong>Receive POs promptly</strong> - Mark shipments received same day they arrive</li>
                                <li><strong>Do physical counts monthly</strong> - Verify system matches actual stock</li>
                                <li><strong>Use adjustment reasons</strong> - Document why quantities changed (damage, shrinkage, etc.)</li>
                                <li><strong>Watch for dead stock</strong> - Items with no sales in 90+ days may need promotion or removal</li>
                            </ul>
                        </div>
                        
                        <!-- Reporting Tips -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #ec4899;">
                            <h4 style="margin: 0 0 15px 0; color: #be185d;"> Reporting Tips</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                                <li><strong>Use date filters</strong> - Compare periods (this month vs last month)</li>
                                <li><strong>Export to Excel</strong> - For further analysis or sharing with accountant</li>
                                <li><strong>Check margins regularly</strong> - Use Gross Margin report to spot pricing issues</li>
                                <li><strong>Track customer trends</strong> - Customer Dashboard shows who's buying more or less</li>
                            </ul>
                        </div>
                        
                    </div>
                </div>
                
                <!-- ==================== DATA IMPORT/EXPORT GUIDE ==================== -->
                <div id="guide-import-export" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #0891b2;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Data Import/Export Guide</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Move data in and out of the system</p>
                        </div>
                    </div>
                    
                    <!-- Export Section -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="color: #0e7490; border-bottom: 2px solid #cffafe; padding-bottom: 10px;"> Exporting Data</h3>
                        
                        <div style="background: #ecfeff; border-radius: 12px; padding: 25px; margin: 20px 0; border-left: 5px solid #06b6d4;">
                            <h4 style="margin: 0 0 15px 0; color: #0e7490;">Method 1: Export Reports to Excel</h4>
                            <ol style="margin: 0; padding-left: 20px; color: #164e63; line-height: 1.8;">
                                <li>Go to <strong>Reports</strong> and run any report</li>
                                <li>Click the <strong> Email</strong> button on the report</li>
                                <li>Copy the report data from the email preview</li>
                                <li>Paste into Excel or Google Sheets</li>
                            </ol>
                        </div>
                        
                        <div style="background: #ecfeff; border-radius: 12px; padding: 25px; margin: 20px 0; border-left: 5px solid #06b6d4;">
                            <h4 style="margin: 0 0 15px 0; color: #0e7490;">Method 2: Direct Google Sheets Access</h4>
                            <ol style="margin: 0; padding-left: 20px; color: #164e63; line-height: 1.8;">
                                <li>Open your Google Sheets database directly</li>
                                <li>Select the tab you want (Suppliers, Items, Customers, etc.)</li>
                                <li>Go to <strong>File  Download  Microsoft Excel (.xlsx)</strong></li>
                                <li>Or <strong>File  Download  Comma-separated values (.csv)</strong></li>
                            </ol>
                        </div>
                        
                        <div style="background: #fef3c7; border-radius: 8px; padding: 15px; margin-top: 15px;">
                            <strong style="color: #b45309;"> Pro Tip:</strong>
                            <span style="color: #92400e;">For tax season, export the Profit & Loss and Annual Sales Summary reports for your accountant.</span>
                        </div>
                    </div>
                    
                    <!-- Import Section -->
                    <div>
                        <h3 style="color: #0e7490; border-bottom: 2px solid #cffafe; padding-bottom: 10px;"> Importing Data</h3>
                        
                        <div style="background: #fef2f2; border-radius: 12px; padding: 25px; margin: 20px 0; border-left: 5px solid #ef4444;">
                            <h4 style="margin: 0 0 10px 0; color: #b91c1c;"> Important Warning</h4>
                            <p style="margin: 0; color: #7f1d1d;">Importing data directly into Google Sheets requires caution. Always make a backup first, and ensure your data matches the exact column format.</p>
                        </div>
                        
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; margin: 20px 0;">
                            <h4 style="margin: 0 0 15px 0; color: #334155;">Steps to Import Items from Excel:</h4>
                            <ol style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                                <li>First, <strong>backup your database</strong> (File  Make a copy)</li>
                                <li>Format your Excel file to match the Items sheet columns exactly</li>
                                <li>Required columns: Item_ID, SKU, Item_Description, Supplier_ID, Package_Cost, Units_Per_Package, Unit_Sell_Price, Qty_On_Hand, Reorder_Point, Status</li>
                                <li>Copy the data rows (without headers) from Excel</li>
                                <li>Paste into the Items sheet below existing data</li>
                                <li>Make sure Item_IDs are unique (I001, I002, etc.)</li>
                            </ol>
                        </div>
                        
                        <div style="padding: 20px; background: #f0fdf4; border-radius: 12px; text-align: center;">
                            <p style="margin: 0; color: #166534;"><strong>Need help importing large datasets?</strong> Contact your system administrator for assistance with bulk data migration.</p>
                        </div>
                    </div>
                </div>
                
                <!-- ==================== BACKUP & RECOVERY GUIDE ==================== -->
                <div id="guide-backup" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #7c3aed;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Backup & Data Recovery Guide</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Protect your business data</p>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-radius: 12px; padding: 25px; margin-bottom: 30px; border: 2px solid #c4b5fd;">
                        <p style="margin: 0; color: #6d28d9;"> Your data is stored in Google Sheets, which provides automatic cloud backup. However, it's still important to create your own backups for extra protection.</p>
                    </div>
                    
                    <!-- Automatic Backups -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-left: 5px solid #22c55e;">
                        <h4 style="margin: 0 0 15px 0; color: #166534;"> Automatic Protection (Built-in)</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                            <li><strong>Google's cloud backup</strong> - Your Sheets are automatically saved and backed up</li>
                            <li><strong>Version history</strong> - Google keeps a history of all changes (File  Version history)</li>
                            <li><strong>Recover deleted files</strong> - Check Google Drive Trash for accidentally deleted files</li>
                            <li><strong>Sync across devices</strong> - Access from any device with your Google account</li>
                        </ul>
                    </div>
                    
                    <!-- Manual Backups -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-left: 5px solid #3b82f6;">
                        <h4 style="margin: 0 0 15px 0; color: #1e40af;"> Manual Backup (Recommended Weekly)</h4>
                        <ol style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                            <li>Open your Google Sheets database</li>
                            <li>Go to <strong>File  Make a copy</strong></li>
                            <li>Name it with the date: "Nowak ERP Backup - 2024-12-12"</li>
                            <li>Save to a "Backups" folder in Google Drive</li>
                            <li>Optionally download as Excel: <strong>File  Download  Microsoft Excel</strong></li>
                        </ol>
                    </div>
                    
                    <!-- Recovery Steps -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-left: 5px solid #f59e0b;">
                        <h4 style="margin: 0 0 15px 0; color: #b45309;"> How to Recover Data</h4>
                        
                        <div style="margin-bottom: 20px;">
                            <strong style="color: #1f2937;">Option 1: Use Version History</strong>
                            <ol style="margin: 10px 0 0 0; padding-left: 20px; color: #475569;">
                                <li>Open Google Sheets  <strong>File  Version history  See version history</strong></li>
                                <li>Click on a previous version to preview it</li>
                                <li>Click <strong>Restore this version</strong> to roll back</li>
                            </ol>
                        </div>
                        
                        <div>
                            <strong style="color: #1f2937;">Option 2: Restore from Backup Copy</strong>
                            <ol style="margin: 10px 0 0 0; padding-left: 20px; color: #475569;">
                                <li>Open your backup copy from Google Drive</li>
                                <li>Copy the data you need from the backup</li>
                                <li>Paste into your main database file</li>
                            </ol>
                        </div>
                    </div>
                    
                    <!-- Backup Schedule -->
                    <div style="padding: 25px; background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); border-radius: 12px; color: white;">
                        <h4 style="margin: 0 0 15px 0;"> Recommended Backup Schedule</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;"></div>
                                <strong>Weekly</strong><br>
                                <span style="font-size: 13px; opacity: 0.9;">Make a copy</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;"></div>
                                <strong>Monthly</strong><br>
                                <span style="font-size: 13px; opacity: 0.9;">Download Excel</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;"></div>
                                <strong>Quarterly</strong><br>
                                <span style="font-size: 13px; opacity: 0.9;">Archive to USB</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ==================== QUICK REFERENCE CARD / CHEAT SHEET ==================== -->
                <div id="guide-cheatsheet" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #ea580c;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Quick Reference Card</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Printable cheat sheet for common tasks</p>
                        </div>
                        <button onclick="window.print()" style="margin-left: auto; background: #ea580c; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                             Print This Page
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        
                        <!-- Column 1: Navigation -->
                        <div style="background: #fff7ed; border-radius: 12px; padding: 20px; border: 2px solid #fed7aa;">
                            <h4 style="margin: 0 0 15px 0; color: #c2410c; border-bottom: 2px solid #fdba74; padding-bottom: 8px;"> Navigation</h4>
                            <table style="width: 100%; font-size: 13px;">
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Reports</strong></td><td>Dashboards & analytics</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Suppliers</strong></td><td>Manage vendors</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Items</strong></td><td>Product catalog</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Customers</strong></td><td>Customer database</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Create PO</strong></td><td>New purchase order</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Purchases</strong></td><td>View/manage POs</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Sales</strong></td><td>Create invoices</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Inventory</strong></td><td>Stock levels</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong>Price Sim</strong></td><td>Test price changes</td></tr>
                                <tr><td style="padding: 6px 0; color: #9a3412;"><strong> (gear)</strong></td><td>Settings & themes</td></tr>
                            </table>
                        </div>
                        
                        <!-- Column 2: Common Tasks -->
                        <div style="background: #f0fdf4; border-radius: 12px; padding: 20px; border: 2px solid #bbf7d0;">
                            <h4 style="margin: 0 0 15px 0; color: #166534; border-bottom: 2px solid #86efac; padding-bottom: 8px;"> Quick Tasks</h4>
                            <div style="font-size: 13px; color: #14532d;">
                                <p style="margin: 0 0 10px 0;"><strong>Create Invoice:</strong><br>Sales  + Create Invoice  Select customer  Add items  Save</p>
                                <p style="margin: 0 0 10px 0;"><strong>Create PO:</strong><br>Create PO  Select supplier  Add items  Submit</p>
                                <p style="margin: 0 0 10px 0;"><strong>Receive Shipment:</strong><br>Purchases  Find PO  View  Receive PO</p>
                                <p style="margin: 0 0 10px 0;"><strong>Record Payment:</strong><br>Sales/Purchases  View order  Record Payment</p>
                                <p style="margin: 0;"><strong>Adjust Inventory:</strong><br>Inventory  Find item  Adjust  Enter qty & reason</p>
                            </div>
                        </div>
                        
                        <!-- Column 3: Key Reports -->
                        <div style="background: #eff6ff; border-radius: 12px; padding: 20px; border: 2px solid #bfdbfe;">
                            <h4 style="margin: 0 0 15px 0; color: #1e40af; border-bottom: 2px solid #93c5fd; padding-bottom: 8px;"> Key Reports</h4>
                            <div style="font-size: 13px; color: #1e3a8a;">
                                <p style="margin: 0 0 8px 0;"> <strong>Action Dashboard</strong> - What needs attention NOW</p>
                                <p style="margin: 0 0 8px 0;"> <strong>Business Overview</strong> - Sales, costs, profit summary</p>
                                <p style="margin: 0 0 8px 0;"> <strong>Inventory Flow</strong> - Stock movement</p>
                                <p style="margin: 0 0 8px 0;"> <strong>Accounts Receivable</strong> - Who owes you</p>
                                <p style="margin: 0 0 8px 0;"> <strong>Accounts Payable</strong> - What you owe</p>
                                <p style="margin: 0 0 8px 0;"> <strong>Pick List</strong> - Items to gather for delivery</p>
                                <p style="margin: 0;"> <strong>Profit & Loss</strong> - Financial statement</p>
                            </div>
                        </div>
                        
                        <!-- Column 4: Status Colors -->
                        <div style="background: #fdf4ff; border-radius: 12px; padding: 20px; border: 2px solid #f5d0fe;">
                            <h4 style="margin: 0 0 15px 0; color: #86198f; border-bottom: 2px solid #e879f9; padding-bottom: 8px;"> Status Colors</h4>
                            <div style="font-size: 13px;">
                                <p style="margin: 0 0 8px 0;"><span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px;">Green</span> Paid / Received / Good</p>
                                <p style="margin: 0 0 8px 0;"><span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px;">Yellow</span> Pending / Partial</p>
                                <p style="margin: 0 0 8px 0;"><span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px;">Red</span> Overdue / Low Stock</p>
                                <p style="margin: 0 0 8px 0;"><span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px;">Blue</span> Info / In Progress</p>
                                <p style="margin: 0;"><span style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 4px;">Gray</span> Draft / Archived</p>
                            </div>
                        </div>
                        
                        <!-- Column 5: Keyboard Shortcuts -->
                        <div style="background: #f1f5f9; border-radius: 12px; padding: 20px; border: 2px solid #cbd5e1;">
                            <h4 style="margin: 0 0 15px 0; color: #334155; border-bottom: 2px solid #94a3b8; padding-bottom: 8px;"> Shortcuts</h4>
                            <table style="width: 100%; font-size: 13px;">
                                <tr><td style="padding: 4px 0;"><kbd style="background: #e2e8f0; padding: 2px 6px; border-radius: 3px; font-size: 11px;">Tab</kbd></td><td>Next field</td></tr>
                                <tr><td style="padding: 4px 0;"><kbd style="background: #e2e8f0; padding: 2px 6px; border-radius: 3px; font-size: 11px;">Enter</kbd></td><td>Submit/Confirm</td></tr>
                                <tr><td style="padding: 4px 0;"><kbd style="background: #e2e8f0; padding: 2px 6px; border-radius: 3px; font-size: 11px;">Esc</kbd></td><td>Close/Cancel</td></tr>
                                <tr><td style="padding: 4px 0;"><kbd style="background: #e2e8f0; padding: 2px 6px; border-radius: 3px; font-size: 11px;">Ctrl+P</kbd></td><td>Print</td></tr>
                                <tr><td style="padding: 4px 0;"><kbd style="background: #e2e8f0; padding: 2px 6px; border-radius: 3px; font-size: 11px;">Ctrl+F</kbd></td><td>Find on page</td></tr>
                                <tr><td style="padding: 4px 0;"><kbd style="background: #e2e8f0; padding: 2px 6px; border-radius: 3px; font-size: 11px;">F11</kbd></td><td>Full screen</td></tr>
                            </table>
                        </div>
                        
                        <!-- Column 6: Glossary -->
                        <div style="background: #fefce8; border-radius: 12px; padding: 20px; border: 2px solid #fef08a;">
                            <h4 style="margin: 0 0 15px 0; color: #a16207; border-bottom: 2px solid #fde047; padding-bottom: 8px;"> Terms</h4>
                            <div style="font-size: 13px; color: #713f12;">
                                <p style="margin: 0 0 6px 0;"><strong>PO</strong> = Purchase Order</p>
                                <p style="margin: 0 0 6px 0;"><strong>SO</strong> = Sales Order</p>
                                <p style="margin: 0 0 6px 0;"><strong>SKU</strong> = Product Code</p>
                                <p style="margin: 0 0 6px 0;"><strong>AR</strong> = Money owed TO you</p>
                                <p style="margin: 0 0 6px 0;"><strong>AP</strong> = Money you OWE</p>
                                <p style="margin: 0 0 6px 0;"><strong>COGS</strong> = Cost of Goods Sold</p>
                                <p style="margin: 0 0 6px 0;"><strong>Net 30</strong> = Due in 30 days</p>
                                <p style="margin: 0;"><strong>COD</strong> = Cash on Delivery</p>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <!-- ==================== ERROR MESSAGES EXPLAINED ==================== -->
                <div id="guide-errors" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #dc2626;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Error Messages Explained</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">What they mean and how to fix them</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        
                        <!-- Error 1 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 20px; border-left: 5px solid #ef4444;">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="background: #ef4444; color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 13px; white-space: nowrap;">Error loading data</div>
                                <div>
                                    <p style="margin: 0 0 10px 0; color: #7f1d1d;"><strong>What it means:</strong> The app couldn't connect to the Google Sheets database.</p>
                                    <p style="margin: 0; color: #991b1b;"><strong>Fix:</strong> Check your internet connection, then refresh the page. If it persists, verify the API URL in Settings is correct.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error 2 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 20px; border-left: 5px solid #ef4444;">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="background: #ef4444; color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 13px; white-space: nowrap;">Please select a supplier</div>
                                <div>
                                    <p style="margin: 0 0 10px 0; color: #7f1d1d;"><strong>What it means:</strong> A required field was left empty.</p>
                                    <p style="margin: 0; color: #991b1b;"><strong>Fix:</strong> Look for required fields (usually marked with *) and make sure they're filled in.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error 3 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 20px; border-left: 5px solid #ef4444;">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="background: #ef4444; color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 13px; white-space: nowrap;">Invalid quantity</div>
                                <div>
                                    <p style="margin: 0 0 10px 0; color: #7f1d1d;"><strong>What it means:</strong> You entered a non-numeric value or negative number in a quantity field.</p>
                                    <p style="margin: 0; color: #991b1b;"><strong>Fix:</strong> Enter a positive whole number (no letters, symbols, or decimals for quantities).</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error 4 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 20px; border-left: 5px solid #ef4444;">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="background: #ef4444; color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 13px; white-space: nowrap;">Duplicate entry</div>
                                <div>
                                    <p style="margin: 0 0 10px 0; color: #7f1d1d;"><strong>What it means:</strong> You're trying to add something that already exists (same SKU, customer name, etc.).</p>
                                    <p style="margin: 0; color: #991b1b;"><strong>Fix:</strong> Use a unique identifier. Search existing records to avoid duplicates.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error 5 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 20px; border-left: 5px solid #ef4444;">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="background: #ef4444; color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 13px; white-space: nowrap;">Network error</div>
                                <div>
                                    <p style="margin: 0 0 10px 0; color: #7f1d1d;"><strong>What it means:</strong> The request couldn't reach the server.</p>
                                    <p style="margin: 0; color: #991b1b;"><strong>Fix:</strong> Check your Wi-Fi/internet connection. Try again in a few seconds. If on mobile, try switching between Wi-Fi and cellular data.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error 6 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 20px; border-left: 5px solid #ef4444;">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="background: #ef4444; color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 13px; white-space: nowrap;">Timeout</div>
                                <div>
                                    <p style="margin: 0 0 10px 0; color: #7f1d1d;"><strong>What it means:</strong> The request took too long (Google Apps Script has execution limits).</p>
                                    <p style="margin: 0; color: #991b1b;"><strong>Fix:</strong> Wait a moment and try again. For large reports, try using date filters to reduce data size.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error 7 -->
                        <div style="background: #fef2f2; border-radius: 12px; padding: 20px; border-left: 5px solid #ef4444;">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="background: #ef4444; color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 13px; white-space: nowrap;">Insufficient inventory</div>
                                <div>
                                    <p style="margin: 0 0 10px 0; color: #7f1d1d;"><strong>What it means:</strong> You're trying to sell more than you have in stock.</p>
                                    <p style="margin: 0; color: #991b1b;"><strong>Fix:</strong> Check current inventory levels. Either reduce the quantity or create a PO to restock first.</p>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #fef3c7; border-radius: 12px;">
                        <h4 style="margin: 0 0 10px 0; color: #b45309;"> Debugging Tip</h4>
                        <p style="margin: 0; color: #92400e;">Press <kbd style="background: #fde68a; padding: 2px 6px; border-radius: 3px;">F12</kbd> to open browser Developer Tools, then click the <strong>Console</strong> tab to see detailed error messages that can help diagnose issues.</p>
                    </div>
                </div>
                
                <!-- ==================== BROWSER COMPATIBILITY GUIDE ==================== -->
                <div id="guide-browsers" class="guide-content-section" style="padding: 40px; display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #2563eb;">
                        <span style="font-size: 48px;"></span>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 28px;">Browser Compatibility Guide</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280;">Supported browsers and devices</p>
                        </div>
                    </div>
                    
                    <!-- Supported Browsers -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="color: #1e40af; margin-bottom: 20px;"> Fully Supported Browsers</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            
                            <div style="background: #f0fdf4; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #86efac;">
                                <div style="font-size: 40px; margin-bottom: 10px;"></div>
                                <h4 style="margin: 0 0 5px 0; color: #166534;">Google Chrome</h4>
                                <p style="margin: 0; font-size: 13px; color: #15803d;">Version 90+  Recommended</p>
                            </div>
                            
                            <div style="background: #f0fdf4; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #86efac;">
                                <div style="font-size: 40px; margin-bottom: 10px;"></div>
                                <h4 style="margin: 0 0 5px 0; color: #166534;">Microsoft Edge</h4>
                                <p style="margin: 0; font-size: 13px; color: #15803d;">Version 90+</p>
                            </div>
                            
                            <div style="background: #f0fdf4; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #86efac;">
                                <div style="font-size: 40px; margin-bottom: 10px;"></div>
                                <h4 style="margin: 0 0 5px 0; color: #166534;">Mozilla Firefox</h4>
                                <p style="margin: 0; font-size: 13px; color: #15803d;">Version 88+</p>
                            </div>
                            
                            <div style="background: #f0fdf4; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #86efac;">
                                <div style="font-size: 40px; margin-bottom: 10px;"></div>
                                <h4 style="margin: 0 0 5px 0; color: #166534;">Safari</h4>
                                <p style="margin: 0; font-size: 13px; color: #15803d;">Version 14+ (macOS/iOS)</p>
                            </div>
                            
                            <div style="background: #f0fdf4; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #86efac;">
                                <div style="font-size: 40px; margin-bottom: 10px;"></div>
                                <h4 style="margin: 0 0 5px 0; color: #166534;">Samsung Internet</h4>
                                <p style="margin: 0; font-size: 13px; color: #15803d;">Version 14+</p>
                            </div>
                            
                            <div style="background: #fef3c7; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #fcd34d;">
                                <div style="font-size: 40px; margin-bottom: 10px;"></div>
                                <h4 style="margin: 0 0 5px 0; color: #a16207;">Opera</h4>
                                <p style="margin: 0; font-size: 13px; color: #a16207;">Works but less tested</p>
                            </div>
                            
                        </div>
                    </div>
                    
                    <!-- Not Supported -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="color: #b91c1c; margin-bottom: 20px;"> Not Supported</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            
                            <div style="background: #fef2f2; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #fca5a5;">
                                <div style="font-size: 40px; margin-bottom: 10px;"></div>
                                <h4 style="margin: 0 0 5px 0; color: #b91c1c;">Internet Explorer</h4>
                                <p style="margin: 0; font-size: 13px; color: #dc2626;">Discontinued - Please upgrade</p>
                            </div>
                            
                            <div style="background: #fef2f2; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #fca5a5;">
                                <div style="font-size: 40px; margin-bottom: 10px;"></div>
                                <h4 style="margin: 0 0 5px 0; color: #b91c1c;">Very Old Browsers</h4>
                                <p style="margin: 0; font-size: 13px; color: #dc2626;">Pre-2020 versions</p>
                            </div>
                            
                        </div>
                    </div>
                    
                    <!-- Device Support -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="color: #1f2937; margin-bottom: 20px;"> Device Support</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            
                            <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #3b82f6;">
                                <h4 style="margin: 0 0 15px 0; color: #1e40af;"> Desktop / Laptop</h4>
                                <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.7;">
                                    <li>Windows 10/11</li>
                                    <li>macOS 10.15+</li>
                                    <li>Linux (Chrome/Firefox)</li>
                                    <li>Chromebook</li>
                                </ul>
                            </div>
                            
                            <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #22c55e;">
                                <h4 style="margin: 0 0 15px 0; color: #166534;"> Mobile Phones</h4>
                                <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.7;">
                                    <li>iPhone (iOS 14+)</li>
                                    <li>Android phones (Android 10+)</li>
                                    <li>Samsung Galaxy</li>
                                    <li>Google Pixel</li>
                                </ul>
                            </div>
                            
                            <div style="background: #f8fafc; border-radius: 12px; padding: 25px; border-left: 5px solid #8b5cf6;">
                                <h4 style="margin: 0 0 15px 0; color: #6d28d9;"> Tablets</h4>
                                <ul style="margin: 0; padding-left: 20px; color: #475569; line-height: 1.7;">
                                    <li>iPad (iPadOS 14+)</li>
                                    <li>Android tablets</li>
                                    <li>Samsung Galaxy Tab</li>
                                    <li>Microsoft Surface</li>
                                </ul>
                            </div>
                            
                        </div>
                    </div>
                    
                    <!-- Performance Tips -->
                    <div style="padding: 25px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px;">
                        <h4 style="margin: 0 0 15px 0; color: #1e40af;"> Performance Tips</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #1e3a8a; line-height: 1.8;">
                            <li><strong>Keep browser updated</strong> - Latest versions have best performance and security</li>
                            <li><strong>Clear cache occasionally</strong> - Settings  Clear browsing data  Cached images/files</li>
                            <li><strong>Close unused tabs</strong> - Frees up memory for better performance</li>
                            <li><strong>Use stable internet</strong> - Wi-Fi or strong cellular signal recommended</li>
                            <li><strong>Disable ad blockers</strong> - Some may interfere with the app (add to whitelist)</li>
                        </ul>
                    </div>
                </div>
                
            </div>
            
            <!-- Glossary Quick Reference -->
            <div style="margin-top: 40px; background: #f8fafc; border-radius: 16px; padding: 30px;">
                <h3 style="margin: 0 0 20px 0; color: #1f2937;"> Quick Glossary</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div style="padding: 12px; background: white; border-radius: 8px;"><strong>PO</strong> - Purchase Order (order to supplier)</div>
                    <div style="padding: 12px; background: white; border-radius: 8px;"><strong>SO</strong> - Sales Order (invoice to customer)</div>
                    <div style="padding: 12px; background: white; border-radius: 8px;"><strong>SKU</strong> - Stock Keeping Unit (product code)</div>
                    <div style="padding: 12px; background: white; border-radius: 8px;"><strong>COGS</strong> - Cost of Goods Sold</div>
                    <div style="padding: 12px; background: white; border-radius: 8px;"><strong>AR</strong> - Accounts Receivable (money owed to you)</div>
                    <div style="padding: 12px; background: white; border-radius: 8px;"><strong>AP</strong> - Accounts Payable (money you owe)</div>
                    <div style="padding: 12px; background: white; border-radius: 8px;"><strong>Net 30</strong> - Payment due in 30 days</div>
                    <div style="padding: 12px; background: white; border-radius: 8px;"><strong>COD</strong> - Cash On Delivery</div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- How-To Guide Modal -->
    <div id="howToGuideModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto; padding: 20px 0;">
        <div style="max-width: 900px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); position: relative; max-height: calc(100vh - 40px); display: flex; flex-direction: column;">
            <!-- Header -->
            <div id="howToGuideHeader" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0 0 5px 0; font-size: 28px;"> Nowak Distributing ERP - How-To Guide</h2>
                    <p style="margin: 0; opacity: 0.95; font-size: 14px;">Complete instructions for using the system</p>
                </div>
                <button onclick="closeHowToGuide()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'"></button>
            </div>

            <!-- Tab Navigation -->
            <div style="display: flex; gap: 0; border-bottom: 2px solid #e0e0e0; background: #f8f9fa; padding: 0 20px; overflow-x: auto;">
                <button class="guide-tab active" onclick="showGuideSection('getting-started')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                     Getting Started
                </button>
                <button class="guide-tab" onclick="showGuideSection('suppliers')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                     Suppliers
                </button>
                <button class="guide-tab" onclick="showGuideSection('items')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                     Items
                </button>
                <button class="guide-tab" onclick="showGuideSection('customers')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                     Customers
                </button>
                <button class="guide-tab" onclick="showGuideSection('orders')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                     Orders
                </button>
                <button class="guide-tab" onclick="showGuideSection('advanced')" style="background: none; border: none; padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                     Advanced
                </button>
            </div>

            <!-- Content -->
            <div style="padding: 30px; max-height: 600px; overflow-y: auto;">
                
                <!-- Getting Started Section -->
                <div id="guide-getting-started" class="guide-section">
                    <h3 style="color: #667eea; margin-top: 0;"> Getting Started</h3>
                    
                    <div style="background: #f0f7ff; border-left: 4px solid #667eea; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <strong>Welcome to Nowak Distributing ERP!</strong><br>
                        This system helps you manage suppliers, inventory, customers, and orders all in one place.
                    </div>

                    <h4> Home / Landing Page</h4>
                    <ul style="line-height: 1.8;">
                        <li>The <strong>Home tab</strong> is your dashboard - click any card to navigate to that section</li>
                        <li>Each card shows a different area of the system</li>
                        <li>Perfect for showing to customers (no data visible)</li>
                    </ul>

                    <h4> Choosing a Theme</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Settings</strong> tab</li>
                        <li>Click the <strong>Theme</strong> box</li>
                        <li>Browse 280+ themes (sports teams, colors, etc.)</li>
                        <li>Click any theme to apply it instantly</li>
                    </ol>

                    <h4> Navigation Tips</h4>
                    <ul style="line-height: 1.8;">
                        <li>Use the <strong>tabs at the top</strong> to switch between sections</li>
                        <li>Click <strong> Back button</strong> (bottom-left) to return to previous page</li>
                        <li>The active tab is highlighted</li>
                    </ul>
                </div>

                <!-- Suppliers Section -->
                <div id="guide-suppliers" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;"> Managing Suppliers</h3>

                    <h4> Adding a New Supplier</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Suppliers</strong> tab</li>
                        <li>Click <strong> Add Supplier</strong></li>
                        <li>Fill in:
                            <ul>
                                <li><strong>Supplier Name</strong> (required)</li>
                                <li><strong>Contact Name</strong></li>
                                <li><strong>Email & Phone</strong></li>
                                <li><strong>Address</strong></li>
                                <li><strong>Payment Terms</strong> (Net 30, Net 60, etc.)</li>
                            </ul>
                        </li>
                        <li>Click <strong> Save</strong></li>
                    </ol>

                    <h4> Editing a Supplier</h4>
                    <ol style="line-height: 1.8;">
                        <li>Find the supplier in the list</li>
                        <li>Click the <strong> Edit</strong> button</li>
                        <li>Update any information</li>
                        <li>Click <strong> Save Changes</strong></li>
                    </ol>

                    <h4> Deleting a Supplier</h4>
                    <ol style="line-height: 1.8;">
                        <li>Click <strong> Delete</strong> on the supplier</li>
                        <li>Confirm deletion</li>
                        <li><strong>Warning:</strong> You cannot delete suppliers with existing items or orders</li>
                    </ol>

                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-top: 20px; border-radius: 4px;">
                        <strong> Tip:</strong> Keep supplier information up-to-date for accurate purchase orders and invoicing.
                    </div>
                </div>

                <!-- Items Section -->
                <div id="guide-items" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;"> Managing Items</h3>

                    <h4> Adding a New Item</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Items</strong> tab</li>
                        <li>Click <strong> Add Item</strong></li>
                        <li>Fill in:
                            <ul>
                                <li><strong>SKU</strong> - Your product code</li>
                                <li><strong>Description</strong> - What is it?</li>
                                <li><strong>Supplier</strong> - Who do you buy from?</li>
                                <li><strong>Cost</strong> - What you pay</li>
                                <li><strong>Sell Price</strong> - What you charge</li>
                                <li><strong>Qty On Hand</strong> - Current stock</li>
                                <li><strong>Reorder Point</strong> - When to reorder</li>
                            </ul>
                        </li>
                        <li>Click <strong> Save</strong></li>
                    </ol>

                    <h4> Bulk Import Items (from Excel)</h4>
                    <ol style="line-height: 1.8;">
                        <li>Click <strong> Download Items</strong> button</li>
                        <li>Save the PDF, then convert to Excel (use ilovepdf.com)</li>
                        <li>Edit prices, quantities, etc. in Excel</li>
                        <li>Click <strong> Upload Items</strong></li>
                        <li>Select your Excel file</li>
                        <li>Choose mode: <strong>Update Existing + Add New</strong> OR <strong>Full Refresh</strong></li>
                        <li>Click <strong> Preview Changes</strong></li>
                        <li>Review what will change</li>
                        <li>Click <strong> Commit Changes</strong> or <strong> Cancel</strong></li>
                    </ol>

                    <h4> Filtering Items</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Search:</strong> Type SKU or description</li>
                        <li><strong>Supplier:</strong> Filter by supplier</li>
                        <li><strong>Stock Status:</strong> Low Stock, Negative, On Order, Needs Reorder</li>
                        <li><strong>Active/Archived:</strong> Show only active items</li>
                    </ul>

                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-top: 20px; border-radius: 4px;">
                        <strong> Tip:</strong> Use the bulk import feature for price updates or inventory counts!
                    </div>
                </div>

                <!-- Customers Section -->
                <div id="guide-customers" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;"> Managing Customers</h3>

                    <h4> Adding a New Customer</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Customers</strong> tab</li>
                        <li>Click <strong> Add Customer</strong></li>
                        <li>Fill in:
                            <ul>
                                <li><strong>Customer Name</strong></li>
                                <li><strong>Contact Name</strong></li>
                                <li><strong>Email & Phone</strong></li>
                                <li><strong>Billing Address</strong></li>
                                <li><strong>Shipping Address</strong> (if different)</li>
                                <li><strong>Payment Terms</strong></li>
                            </ul>
                        </li>
                        <li>Click <strong> Save</strong></li>
                    </ol>

                    <h4> Editing a Customer</h4>
                    <ol style="line-height: 1.8;">
                        <li>Find customer in the list</li>
                        <li>Click <strong> Edit</strong></li>
                        <li>Update information</li>
                        <li>Click <strong> Save Changes</strong></li>
                    </ol>

                    <div style="background: #f0f7ff; border-left: 4px solid #667eea; padding: 15px; margin-top: 20px; border-radius: 4px;">
                        <strong> Note:</strong> Customer information is used for sales orders and invoices.
                    </div>
                </div>

                <!-- Orders Section -->
                <div id="guide-orders" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;"> Managing Orders</h3>

                    <h4> Creating a Purchase Order</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Create PO</strong> tab</li>
                        <li>Select <strong>Supplier</strong></li>
                        <li>Click <strong> Add Line Item</strong></li>
                        <li>Select <strong>Item</strong> and enter <strong>Quantity</strong></li>
                        <li>Add more line items as needed</li>
                        <li>Review <strong>Total Amount</strong></li>
                        <li>Click <strong> Save Purchase Order</strong></li>
                    </ol>

                    <h4> Creating a Sales Order</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Sales</strong> tab</li>
                        <li>Click <strong> Create Sales Order</strong></li>
                        <li>Select <strong>Customer</strong></li>
                        <li>Add line items (items and quantities)</li>
                        <li>Review total</li>
                        <li>Click <strong> Save</strong></li>
                    </ol>

                    <h4> Receiving a Purchase Order</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Purchases</strong> tab</li>
                        <li>Find the PO</li>
                        <li>Click <strong> View</strong></li>
                        <li>Change status to <strong>Received</strong></li>
                        <li>Inventory automatically updates!</li>
                    </ol>

                    <h4> Voiding an Order</h4>
                    <ol style="line-height: 1.8;">
                        <li>Open the order</li>
                        <li>Change status to <strong>Voided</strong></li>
                        <li>Inventory reverses automatically</li>
                    </ol>

                    <h4> Printing Orders</h4>
                    <ul style="line-height: 1.8;">
                        <li>Open any order</li>
                        <li>Click <strong> Print</strong></li>
                        <li>Print matches your selected theme!</li>
                    </ul>

                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-top: 20px; border-radius: 4px;">
                        <strong> Tip:</strong> Status changes automatically update inventory counts.
                    </div>
                </div>

                <!-- Advanced Section -->
                <div id="guide-advanced" class="guide-section" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 0;"> Advanced Features</h3>

                    <h4> Inventory Management</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Manual Adjustments:</strong> Add/remove inventory manually</li>
                        <li><strong>Audit Trail:</strong> See all inventory changes with dates</li>
                        <li><strong>Low Stock Alerts:</strong> Filter by items below reorder point</li>
                    </ul>

                    <h4> Price Simulator</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Price Sim</strong> tab</li>
                        <li>Select an item</li>
                        <li>Try different sell prices</li>
                        <li>See profit margin and revenue impact</li>
                        <li>Apply new price if desired</li>
                    </ol>

                    <h4> Reports</h4>
                    <p><strong>Available Reports:</strong></p>
                    <ul style="line-height: 1.8;">
                        <li><strong>Action Dashboard:</strong> Items needing immediate attention</li>
                        <li><strong>Sales Dashboard:</strong> Revenue, orders, and payment tracking</li>
                        <li><strong>Pick List:</strong> Items to gather for delivery routes</li>
                        <li><strong>Dormant Customers:</strong> Win back customers who haven't ordered recently</li>
                        <li><strong>Accounts Receivable:</strong> Outstanding customer balances</li>
                        <li><strong>Inventory Reports:</strong> Stock levels, turnover, valuation</li>
                    </ul>

                    <h4> Backup & Data Access</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Settings</strong> tab</li>
                        <li>Click <strong> Open Google Sheet</strong></li>
                        <li>Access raw data directly</li>
                        <li>Make backups as needed</li>
                    </ol>

                    <h4> Customization</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>280+ Themes:</strong> NFL, NHL, MLB teams + colors</li>
                        <li><strong>Print Templates:</strong> Auto-match theme colors</li>
                        <li><strong>Landing Page:</strong> Customer-safe first screen</li>
                    </ul>

                    <div style="background: #d1f2eb; border-left: 4px solid #28a745; padding: 15px; margin-top: 20px; border-radius: 4px;">
                        <strong> Pro Tip:</strong> Regularly backup your Google Sheet and use the bulk import for major updates!
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <div style="background: #f8f9fa; padding: 20px 30px; border-radius: 0 0 16px 16px; border-top: 1px solid #e0e0e0; text-align: center; color: #666;">
                <p style="margin: 0; font-size: 14px;">Need more help? Contact support or refer to the Google Sheet for raw data access.</p>
            </div>
        </div>
    </div>

    <!-- Upload Items Modal -->
    <div id="uploadItemsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto; padding: 20px 0;">
        <div style="max-width: 700px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); padding: 30px; max-height: calc(100vh - 40px); overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; color: #667eea;"> Upload Items - Bulk Import</h2>
                <button onclick="closeUploadItemsModal()" style="background: #f44336; border: none; color: white; font-size: 24px; width: 35px; height: 35px; border-radius: 6px; cursor: pointer;"></button>
            </div>

            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                <strong> Important Instructions:</strong>
                <ul style="margin: 10px 0 0 0; padding-left: 20px; line-height: 1.7;">
                    <li><strong>DO NOT modify the Item_ID column</strong> - This is your primary key</li>
                    <li>You can edit SKU, Description, Supplier_ID, Cost, Sell_Price, quantities, Status</li>
                    <li>To add new items, leave Item_ID blank or type "NEW"</li>
                    <li><strong>BACKUP RECOMMENDED:</strong> Download a copy before uploading</li>
                    <li>Accepted formats: Excel (.xlsx, .xls) or CSV (.csv)</li>
                </ul>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Select File:</label>
                <input type="file" id="uploadItemsFile" accept=".xlsx,.xls,.csv" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
            </div>

            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 12px; font-weight: 600;">Upload Mode:</label>
                
                <label style="display: block; padding: 15px; border: 2px solid #28a745; border-radius: 8px; margin-bottom: 10px; cursor: pointer; background: #f0f7ff;">
                    <input type="radio" name="uploadMode" value="update-add" checked style="margin-right: 10px;">
                    <strong style="color: #28a745;"> Update Existing + Add New (Recommended)</strong>
                    <div style="margin-left: 28px; margin-top: 5px; font-size: 13px; color: #666;">
                         Matches on Item_ID<br>
                         Updates existing items<br>
                         Adds new items if Item_ID is blank or "NEW"<br>
                         Safe - does not delete anything
                    </div>
                </label>

                <label style="display: block; padding: 15px; border: 2px solid #f44336; border-radius: 8px; cursor: pointer; background: #ffebee;">
                    <input type="radio" name="uploadMode" value="full-refresh" style="margin-right: 10px;">
                    <strong style="color: #f44336;"> Full Refresh (DANGER)</strong>
                    <div style="margin-left: 28px; margin-top: 5px; font-size: 13px; color: #666;">
                         <strong>DELETES ALL existing items</strong><br>
                         Replaces with uploaded file<br>
                         Requires 3 confirmations<br>
                         Use with extreme caution!
                    </div>
                </label>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn" onclick="previewItemsUpload()" style="background: #17a2b8; width: 100%; padding: 15px; font-size: 16px;">
                     Preview Changes
                </button>
                <button class="btn btn-secondary" onclick="closeUploadItemsModal()" style="width: 100%; margin-top: 10px;">
                    Cancel
                </button>
            </div>

            <div id="uploadItemsPreview" style="margin-top: 20px; display: none;">
                <h3 style="color: #667eea; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0;"> Preview Changes</h3>
                <div id="uploadItemsSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin: 15px 0;"></div>
                <div id="uploadItemsPreviewContent" style="max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 12px; border-radius: 8px; border: 2px solid #667eea; font-size: 13px;"></div>
                
                <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <strong> Review carefully before committing!</strong> Once you click "Commit Changes", the database will be updated.
                </div>
                
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn" onclick="commitItemsUpload()" style="background: #28a745; flex: 1; padding: 12px; font-size: 15px;">
                         Commit Changes
                    </button>
                    <button class="btn btn-secondary" onclick="cancelPreview()" style="flex: 1; padding: 12px; font-size: 15px;">
                         Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== ENVIRONMENT MANAGEMENT ====================
        // Default URLs for each environment
        const DEFAULT_PRODUCTION_URL = 'https://script.google.com/macros/s/AKfycbyCcX93pMAfO3hOsrQjDuSnMMMmL0l9EnLFHnn0BBQ_RjGelL-Jp-0OcSRTgf72rIAITA/exec';
        const DEFAULT_TRAINING_URL = 'https://script.google.com/macros/s/AKfycbxfYLcOjk04p2MMSzAkiUT26MXx0zrzCmBdCqJ1oPfgcvIEBNtIfTzOsStuV-Nlibc7/exec';
        const DEFAULT_TEST_URL = 'https://script.google.com/macros/s/AKfycbyNVzERe6ZKvSiTX0yNF3IU9gT2V2cK8hzXoqsSmU5hE9fVXokO0zV2XXbiWxyrB-DF/exec';
        
        // Environment configuration (loaded from localStorage)
        let environments = {
            production: localStorage.getItem('envUrl-production') || DEFAULT_PRODUCTION_URL,
            training: localStorage.getItem('envUrl-training') || DEFAULT_TRAINING_URL,
            test: localStorage.getItem('envUrl-test') || DEFAULT_TEST_URL
        };
        
        // Current active environment
        let currentEnvironment = localStorage.getItem('currentEnvironment') || 'production';
        
        // Get the active API URL based on current environment
        function getActiveApiUrl() {
            return environments[currentEnvironment] || environments.production || DEFAULT_PRODUCTION_URL;
        }
        
        // API_URL - now dynamically set from environment
        let API_URL = getActiveApiUrl();
        
        // Also support legacy apiUrl for backward compatibility
        if (localStorage.getItem('apiUrl') && !localStorage.getItem('envUrl-production')) {
            environments.production = localStorage.getItem('apiUrl');
            localStorage.setItem('envUrl-production', environments.production);
        }
        
        // ==================== HIDE FIXED ELEMENTS ON SCROLL ====================
        // Hide badge and settings when scrolling down, show at top
        (function() {
            let ticking = false;
            
            function updateFixedElements() {
                const scrollY = window.scrollY || window.pageYOffset || 0;
                const envBadge = document.getElementById('envBadge');
                const settingsBtn = document.getElementById('settingsBtn');
                
                // Hide if scrolled down more than 50px, show if at top
                if (scrollY > 50) {
                    if (envBadge) envBadge.style.opacity = '0';
                    if (settingsBtn) settingsBtn.style.opacity = '0';
                } else {
                    if (envBadge) envBadge.style.opacity = '1';
                    if (settingsBtn) settingsBtn.style.opacity = '1';
                }
                
                ticking = false;
            }
            
            window.addEventListener('scroll', function() {
                if (!ticking) {
                    window.requestAnimationFrame(updateFixedElements);
                    ticking = true;
                }
            }, { passive: true });
            
            // Initial state
            updateFixedElements();
        })();
        
        // Switch to a different environment
        function switchEnvironment(env) {
            if (!environments[env]) {
                alert(`No URL configured for ${env} environment. Please enter a URL first.`);
                return;
            }
            
            currentEnvironment = env;
            localStorage.setItem('currentEnvironment', env);
            API_URL = getActiveApiUrl();
            
            // Also update legacy apiUrl for compatibility
            localStorage.setItem('apiUrl', API_URL);
            
            // Update UI
            updateEnvironmentUI();
            
            // Show confirmation
            const envNames = { production: ' Production', training: ' Training', test: ' Development' };
            showStatus('configStatus', ` Switched to ${envNames[env]} environment`, 'success');
            
            // Refresh all data
            refreshAfterEnvSwitch();
        }
        
        // Save an environment URL
        function saveEnvironmentUrl(env) {
            const input = document.getElementById(`envUrl-${env}`);
            if (input) {
                const url = input.value.trim();
                environments[env] = url;
                localStorage.setItem(`envUrl-${env}`, url);
                
                // If this is the current environment, update API_URL
                if (env === currentEnvironment) {
                    API_URL = url;
                    localStorage.setItem('apiUrl', url);
                }
                
                console.log(`Saved ${env} URL:`, url);
            }
        }
        
        // Restore default URLs (useful after clearing site data)
        function restoreDefaultUrls() {
            // Set the input fields to default values
            document.getElementById('envUrl-production').value = DEFAULT_PRODUCTION_URL;
            document.getElementById('envUrl-training').value = DEFAULT_TRAINING_URL;
            document.getElementById('envUrl-test').value = DEFAULT_TEST_URL;
            
            // Save to localStorage
            environments.production = DEFAULT_PRODUCTION_URL;
            environments.training = DEFAULT_TRAINING_URL;
            environments.test = DEFAULT_TEST_URL;
            
            localStorage.setItem('envUrl-production', DEFAULT_PRODUCTION_URL);
            localStorage.setItem('envUrl-training', DEFAULT_TRAINING_URL);
            localStorage.setItem('envUrl-test', DEFAULT_TEST_URL);
            
            // Update current API_URL
            API_URL = environments[currentEnvironment] || DEFAULT_PRODUCTION_URL;
            localStorage.setItem('apiUrl', API_URL);
            
            alert(' Default URLs restored!\n\nProduction, Training, and Development URLs have been repopulated.');
            console.log('Default URLs restored:', environments);
        }
        
        // Update UI to reflect current environment
        function updateEnvironmentUI() {
            // Letter colors only (background stays theme color)
            const envLetterColors = {
                production: 'white',    // White like settings gear
                training: '#93c5fd',    // Light blue  
                test: '#fca5a5'         // Light red
            };
            const envButtonColors = {
                production: { bg: '#d1fae5', border: '#059669', text: '#065f46', activeBg: '#d1fae5' },
                training: { bg: '#dbeafe', border: '#0284c7', text: '#0369a1', activeBg: '#dbeafe' },
                test: { bg: '#fee2e2', border: '#dc2626', text: '#991b1b', activeBg: '#fee2e2' }
            };
            const envNames = { production: ' Production', training: ' Training', test: ' Development' };
            const envLetters = { production: 'P', training: 'T', test: 'D' };
            const envTitles = { 
                production: 'Production Environment - Click to change', 
                training: 'Training Environment - Click to change', 
                test: 'Development Environment - Click to change' 
            };
            
            // Update buttons in settings
            ['production', 'training', 'test'].forEach(env => {
                const btn = document.getElementById(`envBtn-${env}`);
                if (btn) {
                    const colors = envButtonColors[env];
                    if (env === currentEnvironment) {
                        btn.style.background = colors.activeBg;
                        btn.style.borderWidth = '3px';
                        btn.style.transform = 'scale(1.05)';
                        btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    } else {
                        btn.style.background = 'white';
                        btn.style.borderWidth = '3px';
                        btn.style.transform = 'scale(1)';
                        btn.style.boxShadow = 'none';
                    }
                }
            });
            
            // Update status display in settings
            const display = document.getElementById('currentEnvDisplay');
            if (display) {
                const colors = envButtonColors[currentEnvironment];
                display.style.background = colors.activeBg;
                display.style.color = colors.text;
                display.innerHTML = ` Currently using: <strong>${envNames[currentEnvironment]}</strong>`;
            }
            
            // Update the small circle badge in top left - only change letter color
            const badge = document.getElementById('envBadge');
            if (badge) {
                badge.style.color = envLetterColors[currentEnvironment];
                badge.textContent = envLetters[currentEnvironment];
                badge.title = envTitles[currentEnvironment];
            }
            
            // Update page title to show environment
            if (currentEnvironment === 'test') {
                document.title = 'ERP System [DEVELOPMENT]';
            } else if (currentEnvironment === 'training') {
                document.title = 'ERP System [TRAINING]';
            } else {
                document.title = 'Nowak Distributing - ERP System';
            }
        }
        
        // Refresh all cached data after environment switch
        async function refreshAfterEnvSwitch() {
            // Show loading indicator
            const envNames = { production: ' Production', training: ' Training', test: ' Development' };
            showStatus('configStatus', ` Loading all data from ${envNames[currentEnvironment]}...`, 'info');
            
            // Clear all caches
            cachedSuppliers = [];
            cachedItems = [];
            cachedCustomers = [];
            
            try {
                // Load ALL data in parallel for speed
                console.log(' Refreshing all data for environment:', currentEnvironment);
                
                await Promise.all([
                    loadSuppliers(),
                    loadItems(),
                    loadCustomers(),
                    loadPurchases(),
                    loadSales(),
                    loadInventory()
                ]);
                
                // IMPORTANT: Repopulate ALL dropdowns with new data
                repopulateAllDropdowns();
                
                // Show success message
                showStatus('configStatus', ` All data loaded from ${envNames[currentEnvironment]}!`, 'success');
                console.log(' All data refreshed successfully');
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                showStatus('configStatus', ` Some data may not have loaded. Try refreshing individual tabs.`, 'error');
            }
        }
        
        // Repopulate ALL dropdowns after environment switch
        function repopulateAllDropdowns() {
            console.log(' Repopulating all dropdowns with new environment data...');
            
            // Customer dropdowns
            const customerSelects = document.querySelectorAll('#soCustomer, #filter_customer, #custDash_customer');
            customerSelects.forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Customer</option>';
                    if (select.id === 'filter_customer' || select.id === 'custDash_customer') {
                        select.innerHTML = '<option value="">All Customers</option>';
                    }
                    cachedCustomers.forEach(c => {
                        select.innerHTML += `<option value="${c.Customer_ID}">${c.Customer_Name}</option>`;
                    });
                    // Restore selection if still valid
                    if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                        select.value = currentValue;
                    }
                }
            });
            
            // Supplier dropdowns
            const supplierSelects = document.querySelectorAll('#poSupplier, #filterSupplier, #filterItemSupplier, #createPOSupplier, #suppDash_supplier');
            supplierSelects.forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    const isFilter = select.id.includes('filter') || select.id.includes('Dash');
                    select.innerHTML = isFilter ? '<option value="">All Suppliers</option>' : '<option value="">Select Supplier</option>';
                    cachedSuppliers.forEach(s => {
                        select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                    });
                    if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                        select.value = currentValue;
                    }
                }
            });
            
            // Item dropdowns (Sales Order line items)
            document.querySelectorAll('.so-item').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Item</option>';
                cachedItems.forEach(item => {
                    select.innerHTML += `<option value="${item.Item_ID}" data-price="${item.Unit_Sell_Price}" data-stock="${item.Qty_On_Hand || 0}">${item.Item_Description}</option>`;
                });
                if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                    select.value = currentValue;
                }
            });
            
            // Item dropdowns (Purchase Order line items)
            document.querySelectorAll('.po-item').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Item</option>';
                cachedItems.forEach(item => {
                    const packageCost = parseFloat(item.Package_Cost) || 0;
                    const unitsPerPackage = parseInt(item.Units_Per_Package) || 1;
                    select.innerHTML += `<option value="${item.Item_ID}" data-cost="${packageCost.toFixed(2)}" data-units="${unitsPerPackage}">${item.Item_Description}</option>`;
                });
                if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                    select.value = currentValue;
                }
            });
            
            // Create PO item dropdowns
            document.querySelectorAll('.createpo-item').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select item...</option>';
                cachedItems.forEach(item => {
                    const packageCost = parseFloat(item.Package_Cost) || 0;
                    const unitsPerPackage = parseInt(item.Units_Per_Package) || 1;
                    select.innerHTML += `<option value="${item.Item_ID}" data-cost="${packageCost.toFixed(2)}" data-units="${unitsPerPackage}">${item.Item_Description}</option>`;
                });
                if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                    select.value = currentValue;
                }
            });
            
            // Filter item dropdown
            const filterItem = document.getElementById('filter_item');
            if (filterItem) {
                const currentValue = filterItem.value;
                filterItem.innerHTML = '<option value="">All Items</option>';
                cachedItems.forEach(item => {
                    filterItem.innerHTML += `<option value="${item.Item_ID}">${item.Item_Description}</option>`;
                });
                if (currentValue && filterItem.querySelector(`option[value="${currentValue}"]`)) {
                    filterItem.value = currentValue;
                }
            }
            
            console.log(' All dropdowns repopulated');
        }
        
        // Initialize environment URLs in the form on page load
        function initializeEnvironmentForm() {
            // Load URLs into form fields
            ['production', 'training', 'test'].forEach(env => {
                const input = document.getElementById(`envUrl-${env}`);
                if (input && environments[env]) {
                    input.value = environments[env];
                }
            });
            
            // Update UI to show current environment
            updateEnvironmentUI();
            
            // MOBILE FIX: Add touch-friendly event listeners to environment buttons
            ['production', 'training', 'test'].forEach(env => {
                const btn = document.getElementById(`envBtn-${env}`);
                if (btn) {
                    // Remove inline onclick to avoid double-firing
                    btn.removeAttribute('onclick');
                    
                    // Add both click and touchend for mobile compatibility
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Environment button clicked:', env);
                        switchEnvironment(env);
                    });
                    
                    // Make touch more responsive
                    btn.style.touchAction = 'manipulation';
                    btn.style.webkitTapHighlightColor = 'transparent';
                }
            });
        }
        
        let cachedSuppliers = [];
        let cachedItems = [];
        let cachedCustomers = [];
        
        // Multi-select support for report filters
        let selectedCustomersForReport = [];
        let selectedSuppliersForReport = [];
        let selectedItemsForReport = [];
        let selectedInvoicesForSales = [];
        let selectedPOsForPurchases = [];
        let selectedItemsForInventory = [];
        let selectedItemsForPricing = [];
        let selectedSuppliersForPricing = [];
        
        // ==================== TOUCH-AWARE PICKER SELECTION ====================
        // Prevents accidental selections when scrolling through picker lists
        // A selection only fires if the finger didn't move more than the threshold
        
        const pickerTouchState = {
            startX: 0,
            startY: 0,
            moved: false,
            threshold: 10  // pixels - if finger moves more than this, it's a scroll not a tap
        };
        
        // Call this on touchstart for picker cards
        function pickerTouchStart(e) {
            const touch = e.touches[0];
            pickerTouchState.startX = touch.clientX;
            pickerTouchState.startY = touch.clientY;
            pickerTouchState.moved = false;
        }
        
        // Call this on touchmove for picker cards
        function pickerTouchMove(e) {
            if (pickerTouchState.moved) return; // Already marked as moved
            const touch = e.touches[0];
            const deltaX = Math.abs(touch.clientX - pickerTouchState.startX);
            const deltaY = Math.abs(touch.clientY - pickerTouchState.startY);
            if (deltaX > pickerTouchState.threshold || deltaY > pickerTouchState.threshold) {
                pickerTouchState.moved = true;
            }
        }
        
        // Call this on touchend - returns true if it was a clean tap (not a scroll)
        function pickerTouchEnd() {
            return !pickerTouchState.moved;
        }
        
        // Wrapper for picker card selection - only fires callback if it was a clean tap
        function handlePickerTap(callback, ...args) {
            if (pickerTouchEnd()) {
                callback(...args);
            }
        }
        
        // ==================== DATE PARSING HELPER ====================
        /**
         * Parse a YYYY-MM-DD date string as LOCAL time (not UTC)
         * This fixes timezone issues where new Date("2025-12-12") is parsed as UTC midnight
         * which then becomes the previous day in local time zones
         * @param {string} dateStr - Date string in YYYY-MM-DD format
         * @returns {Date} - Date object in local time
         */
        function parseLocalDate(dateStr) {
            if (!dateStr) return null;
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }
        
        /**
         * Format a Date object as YYYY-MM-DD in LOCAL time (not UTC)
         * @param {Date} d - Date object
         * @returns {string} - Date string in YYYY-MM-DD format
         */
        function formatLocalDate(d) {
            if (!d) return '';
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        /**
         * Format a number with commas (e.g., 1234567 -> "1,234,567")
         * @param {number} num - Number to format
         * @param {number} decimals - Optional decimal places (default 0)
         * @returns {string} - Formatted number string
         */
        function formatNum(num, decimals = 0) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return Number(num).toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }
        
        /**
         * Format a number as currency with $ and commas (e.g., 1234.56 -> "$1,234.56")
         * @param {number} num - Number to format
         * @returns {string} - Formatted currency string
         */
        function formatMoney(num) {
            if (num === null || num === undefined || isNaN(num)) return '$0.00';
            return '$' + Number(num).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // ==================== MULTI-SELECT FILTER HELPER ====================
        /**
         * Focus an element only on desktop (not touch devices)
         * Prevents keyboard from popping up on mobile when opening pickers
         */
        function focusOnDesktop(elementId) {
            if (!('ontouchstart' in window)) {
                setTimeout(() => {
                    const el = document.getElementById(elementId);
                    if (el) el.focus();
                }, 100);
            }
        }
        
        /**
         * Check if a value matches a filter that might contain comma-separated values
         * @param {string} value - The value to check (e.g., "C001")
         * @param {string} filter - The filter (might be "C001" or "C001,C002,C003")
         * @returns {boolean} - True if value matches filter
         */
        function matchesFilter(value, filter) {
            if (!filter || filter === '') return true;
            
            // Convert to string for consistent comparison
            const strValue = String(value);
            const strFilter = String(filter);
            
            // Check if filter contains multiple values (comma-separated)
            if (strFilter.includes(',')) {
                const allowedValues = strFilter.split(',').map(v => v.trim());
                return allowedValues.includes(strValue);
            }
            
            // Single value comparison
            return strValue === strFilter;
        }
        
        // ==================== BUTTON DEBOUNCE SYSTEM ====================
        // Prevents double-clicks/taps from submitting forms twice
        let buttonDebounceMap = new Map();
        
        // Get today's date in YYYY-MM-DD format using LOCAL time (not UTC)
        function getTodayLocalDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }
        
        function debounceButton(buttonElement, duration = 2000) {
            if (!buttonElement) return false;
            
            const buttonId = buttonElement.id || buttonElement.outerHTML.substring(0, 100);
            const now = Date.now();
            const lastClick = buttonDebounceMap.get(buttonId) || 0;
            
            if (now - lastClick < duration) {
                console.log(' Button debounced - click ignored');
                return false; // Too soon, ignore click
            }
            
            buttonDebounceMap.set(buttonId, now);
            
            // Visually disable button
            buttonElement.disabled = true;
            buttonElement.style.opacity = '0.6';
            buttonElement.style.cursor = 'not-allowed';
            
            // Re-enable after duration
            setTimeout(() => {
                buttonElement.disabled = false;
                buttonElement.style.opacity = '';
                buttonElement.style.cursor = '';
            }, duration);
            
            return true; // Allow click
        }
        
        // Helper functions to lookup names from IDs
        function getCustomerName(customerId) {
            if (!cachedCustomers || cachedCustomers.length === 0) return customerId;
            const customer = cachedCustomers.find(c => c.Customer_ID === customerId);
            return customer ? customer.Customer_Name : customerId;
        }
        
        function getSupplierName(supplierId) {
            if (!cachedSuppliers || cachedSuppliers.length === 0) return supplierId;
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            return supplier ? supplier.Supplier_Name : supplierId;
        }
        
        function getItemDescription(itemId) {
            const item = cachedItems.find(i => i.Item_ID === itemId);
            return item ? item.Item_Description : itemId;
        }

        window.addEventListener('DOMContentLoaded', () => {
            // SAFETY: Remove any stuck modal-open class and reset body styles
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
            document.body.style.height = '';
            
            // SAFETY: Ensure back button is hidden on load
            const backBtn = document.getElementById('backBtn');
            const backToTopBtn = document.getElementById('backToTopBtn');
            if (backBtn) backBtn.style.display = 'none';
            if (backToTopBtn) backToTopBtn.style.display = 'none';
            
            // MOBILE TOUCH DEBOUNCE - Prevent rapid multiple taps on selects
            let lastSelectTap = 0;
            const SELECT_DEBOUNCE_MS = 300; // Minimum ms between select taps
            
            document.addEventListener('touchstart', function(e) {
                if (e.target.tagName === 'SELECT' || e.target.closest('select')) {
                    const now = Date.now();
                    if (now - lastSelectTap < SELECT_DEBOUNCE_MS) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log(' Select tap debounced');
                        return false;
                    }
                    lastSelectTap = now;
                }
            }, { passive: false });
            
            // Apply gradient for current theme
            applyThemeGradient();
            
            // Initialize environment switcher
            initializeEnvironmentForm();
            
            updateConfigStatus();
            loadInvoiceSettings();
            const today = getTodayLocalDate();
            if (document.getElementById('poDate')) document.getElementById('poDate').value = today;
            if (document.getElementById('soDate')) document.getElementById('soDate').value = today;
            if (document.getElementById('soDueDate')) document.getElementById('soDueDate').value = today;
            if (document.getElementById('createPODate')) document.getElementById('createPODate').value = today;
            // Expected delivery date left blank - user must select
            
            // Restore report section visibility preferences
            restoreReportSections();
            
            // Restore settings section visibility preferences
            restoreSettingsSections();
            
            // AUTO-LOAD ALL DATA ON PAGE LOAD
            console.log(' Auto-loading all data from Google Sheets...');
            loadSuppliers();
            loadItems();
            loadCustomers();
            loadPurchases();
            loadSales();
            loadInventory();
            
            // Attach event listeners to the first Create PO line item
            const firstCreatePORow = document.querySelector('#createPOLineItems div.line-item-row');
            if (firstCreatePORow) {
                const itemSelect = firstCreatePORow.querySelector('.createpo-item');
                const qtyInput = firstCreatePORow.querySelector('.createpo-qty');
                
                if (itemSelect) {
                    itemSelect.addEventListener('change', function() {
                        updateCreatePOItemCost(this);
                    });
                }
                
                if (qtyInput) {
                    qtyInput.addEventListener('input', function() {
                        calculateCreatePOTotal();
                    });
                }
            }
            
            // Attach event listeners to the first hardcoded Sales Order line item
            const firstSORow = document.querySelector('#soLineItems .line-item-row');
            if (firstSORow) {
                console.log('Attaching listeners to first SO line item'); // DEBUG
                const itemSelect = firstSORow.querySelector('.so-item');
                const qtyInput = firstSORow.querySelector('.so-qty');
                const priceInput = firstSORow.querySelector('.so-price');
                const removeBtn = firstSORow.querySelector('.remove-btn');
                
                if (itemSelect) {
                    itemSelect.addEventListener('change', function() {
                        console.log('First row CHANGE EVENT FIRED!'); // DEBUG
                        updateSOItemInfo(this);
                    });
                }
                
                if (qtyInput) {
                    qtyInput.addEventListener('input', function() {
                        // Update stock info when quantity changes
                        const row = this.closest('.line-item-row');
                        const itemSelect = row.querySelector('.so-item');
                        if (itemSelect.value) {
                            updateSOItemInfo(itemSelect);
                        }
                        calculateSOTotal();
                    });
                }
                
                if (priceInput) {
                    priceInput.addEventListener('input', function() {
                        calculateSOTotal();
                    });
                }
                
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        removeLineItem(this);
                        calculateSOTotal();
                    });
                }
                console.log('First SO row listeners attached!'); // DEBUG
            }
            
            // Attach event listeners to the first hardcoded Purchase Order line item
            const firstPORow = document.querySelector('#poLineItems .line-item-row');
            if (firstPORow) {
                console.log('Attaching listeners to first PO line item'); // DEBUG
                const itemSelect = firstPORow.querySelector('.po-item');
                const qtyInput = firstPORow.querySelector('.po-qty');
                const costInput = firstPORow.querySelector('.po-cost');
                const removeBtn = firstPORow.querySelector('.remove-btn');
                
                if (itemSelect) {
                    itemSelect.addEventListener('change', function() {
                        console.log('First PO row CHANGE EVENT FIRED!'); // DEBUG
                        updatePOItemInfo(this);
                    });
                }
                
                if (qtyInput) {
                    qtyInput.addEventListener('input', function() {
                        calculatePOTotal();
                    });
                }
                
                if (costInput) {
                    costInput.addEventListener('input', function() {
                        calculatePOTotal();
                    });
                }
                
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        removeLineItem(this);
                        calculatePOTotal();
                    });
                }
                console.log('First PO row listeners attached!'); // DEBUG
            }
            
            // Minimal pull-to-refresh prevention (only at very top)
            let lastTouchY = 0;
            
            document.body.addEventListener('touchstart', function(e) {
                if (e.touches.length !== 1) return;
                lastTouchY = e.touches[0].clientY;
            }, { passive: true });
            
            document.body.addEventListener('touchmove', function(e) {
                const touchY = e.touches[0].clientY;
                const touchYDelta = touchY - lastTouchY;
                lastTouchY = touchY;
                
                // Only prevent if at absolute top AND pulling down
                if (window.pageYOffset === 0 && touchYDelta > 0) {
                    e.preventDefault();
                }
            }, { passive: false });
        });

        // Navigation history for back button
        let navigationHistory = ['reports'];
        
        // ========== CHART MANAGEMENT ==========
        // Global registry to track all chart instances
        const chartRegistry = {};
        
        // Safely create a chart, destroying any existing one on the same canvas
        function createSafeChart(canvasId, config) {
            // Destroy existing chart if it exists
            if (chartRegistry[canvasId]) {
                try {
                    chartRegistry[canvasId].destroy();
                } catch (e) {
                    console.log('Chart destroy error (non-critical):', e);
                }
                delete chartRegistry[canvasId];
            }
            
            // Also check Chart.js internal registry
            const existingChart = Chart.getChart(canvasId);
            if (existingChart) {
                try {
                    existingChart.destroy();
                } catch (e) {
                    console.log('Existing chart destroy error (non-critical):', e);
                }
            }
            
            // Get canvas element
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.warn('Canvas not found:', canvasId);
                return null;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.warn('Could not get canvas context:', canvasId);
                return null;
            }
            
            // Create new chart
            try {
                const chart = new Chart(ctx, config);
                chartRegistry[canvasId] = chart;
                return chart;
            } catch (e) {
                console.error('Error creating chart:', e);
                return null;
            }
        }
        
        // Destroy all charts (useful when switching reports)
        function destroyAllCharts() {
            // First destroy all charts in our registry
            Object.keys(chartRegistry).forEach(canvasId => {
                try {
                    if (chartRegistry[canvasId]) {
                        chartRegistry[canvasId].destroy();
                    }
                } catch (e) {
                    // Ignore errors during cleanup
                }
            });
            // Clear registry
            Object.keys(chartRegistry).forEach(key => delete chartRegistry[key]);
            
            // Also destroy any Chart.js instances that might not be in our registry
            // by finding all canvases and checking if they have charts
            document.querySelectorAll('canvas').forEach(canvas => {
                try {
                    const chart = Chart.getChart(canvas);
                    if (chart) {
                        chart.destroy();
                    }
                } catch (e) {
                    // Ignore errors
                }
            });
        }
        
        function switchTab(tabName) {
            // Remove active class from all navigation cards
            document.querySelectorAll('.landing-nav-card').forEach(card => {
                card.classList.remove('active-nav-card');
                // Reset styling
                card.style.transform = 'scale(1)';
                card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
            });
            
            // Find and highlight the clicked navigation card
            document.querySelectorAll('.landing-nav-card').forEach(card => {
                if (card.onclick && card.onclick.toString().includes(`'${tabName}'`)) {
                    card.classList.add('active-nav-card');
                    card.style.transform = 'scale(1.05)';
                    card.style.boxShadow = '0 4px 16px rgba(0,0,0,0.3)';
                }
            });
            
            // Hide all content sections and show the selected one
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            const targetCard = document.getElementById(tabName);
            if (targetCard) {
                targetCard.classList.add('active');
            }
            
            // Add to history (avoid duplicates of current tab)
            if (navigationHistory[navigationHistory.length - 1] !== tabName) {
                navigationHistory.push(tabName);
                // Keep only last 20 tabs in history
                if (navigationHistory.length > 20) {
                    navigationHistory.shift();
                }
            }
            
            // Show/hide Back button based on history length AND current tab
            const backBtn = document.getElementById('backBtn');
            // Hide on home tab, only show on other tabs when there's history
            if (navigationHistory.length > 1 && tabName !== 'home') {
                backBtn.style.display = 'block';
            } else {
                backBtn.style.display = 'none';
            }
            
            // Check if we need to restore PO form when switching to purchases
            if (tabName === 'purchases') {
                checkAndRestorePOForm();
            }
            
            // Load price sim items when switching to that tab
            if (tabName === 'pricesim') {
                loadPriceSimItems();
            }
            
            // Refresh Inventory Flow Dashboard when switching to that tab
            if (tabName === 'invflow') {
                refreshInventoryFlowWithTimeout();
            }
            
            // Clear Create PO form when switching to that tab (fresh start)
            // But only if not coming from a pre-fill action
            if (tabName === 'createpo' && !window.skipCreatePOClear) {
                if (typeof clearCreatePOForm === 'function') {
                    clearCreatePOForm();
                }
            }
            window.skipCreatePOClear = false; // Reset flag
            
            // Scroll to top when switching tabs
            window.scrollTo(0, 0);
        }
        
        function goBack() {
            // Remove current tab from history
            if (navigationHistory.length > 1) {
                navigationHistory.pop();
                const previousTab = navigationHistory[navigationHistory.length - 1];
                
                // Switch to previous tab
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                
                document.getElementById(previousTab).classList.add('active');
                
                // Highlight the correct tab button
                const tabButtons = document.querySelectorAll('.tabs .tab');
                tabButtons.forEach(btn => {
                    if (btn.textContent.toLowerCase().includes(previousTab.substring(0, 4))) {
                        btn.classList.add('active');
                    }
                });
                
                window.scrollTo(0, 0);
                
                // Check if we need to restore PO form state
                checkAndRestorePOForm();
            }
            
            // Hide Back button if only one tab in history
            const backBtn = document.getElementById('backBtn');
            if (navigationHistory.length <= 1) {
                backBtn.style.display = 'none';
            }
        }
        
        // ==================== HELP/GUIDES NAVIGATION ====================
        /**
         * Scroll to a specific guide section in the Help tab
         */
        function scrollToGuideSection(sectionId) {
            // First, make sure we're on the guides tab
            switchTab('guides');
            
            // Hide all guide content sections
            document.querySelectorAll('.guide-content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show the requested section
            const targetSection = document.getElementById('guide-' + sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';
                
                // Smooth scroll to the guide content container
                setTimeout(() => {
                    const container = document.getElementById('guide-content-container');
                    if (container) {
                        container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
        }
        
        function checkAndRestorePOForm() {
            const savedState = localStorage.getItem('poFormState');
            if (savedState) {
                const state = JSON.parse(savedState);
                if (state.returnToPO) {
                    // Show a notification
                    const currentTab = document.querySelector('.card.active');
                    if (currentTab && currentTab.id === 'purchases') {
                        setTimeout(() => {
                            if (confirm('Resume your purchase order entry?')) {
                                showAddPurchaseForm();
                                
                                // Restore form fields
                                setTimeout(() => {
                                    if (state.supplier) document.getElementById('poSupplier').value = state.supplier;
                                    if (state.invoiceNumber) document.getElementById('poInvoiceNumber').value = state.invoiceNumber;
                                    if (state.purchaseDate) document.getElementById('poPurchaseDate').value = state.purchaseDate;
                                    if (state.dueDate) document.getElementById('poDueDate').value = state.dueDate;
                                    if (state.paymentTerms) document.getElementById('poPaymentTerms').value = state.paymentTerms;
                                    if (state.status) document.getElementById('poStatus').value = state.status;
                                    if (state.amountPaid) document.getElementById('poAmountPaid').value = state.amountPaid;
                                    if (state.notes) document.getElementById('poNotes').value = state.notes;
                                    
                                    // Reload supplier items
                                    if (state.supplier) {
                                        loadSupplierItems();
                                    }
                                    
                                    showStatus('purchaseStatus', ' Purchase order form restored! The new item should now be available in the dropdown.', 'success');
                                }, 200);
                            }
                            
                            // Clear saved state
                            localStorage.removeItem('poFormState');
                        }, 500);
                    }
                }
            }
        }
        
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // Toggle collapsible sections (Quick Guides, Entry Forms)
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId + '-toggle');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                if (toggle) toggle.textContent = ' Hide';
            } else {
                section.style.display = 'none';
                if (toggle) toggle.textContent = ' Show';
            }
        }
        
        // Toggle report category sections with localStorage persistence
        function toggleReportSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId + '-toggle');
            const category = section.parentElement;
            
            if (section.classList.contains('collapsed')) {
                // Show
                section.classList.remove('collapsed');
                category.classList.remove('collapsed');
                if (toggle) toggle.textContent = '';
                localStorage.setItem('report_' + sectionId, 'visible');
            } else {
                // Hide
                section.classList.add('collapsed');
                category.classList.add('collapsed');
                if (toggle) toggle.textContent = '';
                localStorage.setItem('report_' + sectionId, 'hidden');
            }
        }
        
        // Restore report section visibility on page load
        function restoreReportSections() {
            const sections = ['salesReports', 'purchaseReports', 'inventoryReports', 'financialReports'];
            sections.forEach(sectionId => {
                const state = localStorage.getItem('report_' + sectionId);
                if (state === 'hidden') {
                    const section = document.getElementById(sectionId);
                    const toggle = document.getElementById(sectionId + '-toggle');
                    const category = section?.parentElement;
                    if (section) {
                        section.classList.add('collapsed');
                        if (category) category.classList.add('collapsed');
                        if (toggle) toggle.textContent = '';
                    }
                }
            });
        }
        
        // Toggle settings page sections with localStorage persistence
        function toggleSettingsSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId + '-toggle');
            
            if (section.style.display === 'none') {
                // Show
                section.style.display = 'block';
                if (toggle) toggle.textContent = ' Hide';
                localStorage.setItem('settings_' + sectionId, 'visible');
            } else {
                // Hide
                section.style.display = 'none';
                if (toggle) toggle.textContent = ' Show';
                localStorage.setItem('settings_' + sectionId, 'hidden');
            }
        }
        
        // Restore settings section visibility on page load
        function restoreSettingsSections() {
            const sections = ['themeSection', 'backupSection', 'invoiceSection', 'statusSection', 'apiSection'];
            sections.forEach(sectionId => {
                const state = localStorage.getItem('settings_' + sectionId);
                const section = document.getElementById(sectionId);
                const toggle = document.getElementById(sectionId + '-toggle');
                
                if (sectionId === 'apiSection') {
                    // API section hidden by default unless explicitly shown
                    if (state === 'visible') {
                        if (section) section.style.display = 'block';
                        if (toggle) toggle.textContent = ' Hide';
                    }
                } else {
                    // Other sections shown by default unless explicitly hidden
                    if (state === 'hidden') {
                        if (section) section.style.display = 'none';
                        if (toggle) toggle.textContent = ' Show';
                    }
                }
            });
        }
        
        // Show/hide back to top button based on scroll position
        window.addEventListener('scroll', function() {
            const backToTopBtn = document.getElementById('backToTopBtn');
            if (window.pageYOffset > 300) {
                backToTopBtn.style.display = 'block';
            } else {
                backToTopBtn.style.display = 'none';
            }
        });
        
        function goToAddItem() {
            // Switch to Items tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent.includes('Items')) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            document.getElementById('items').classList.add('active');
            
            // Open the Add Item form
            showAddItemForm();
            
            // Scroll to top of page
            window.scrollTo(0, 0);
        }
        
        function addNewItemFromPO() {
            // Get current supplier from PO form
            const currentSupplier = document.getElementById('poSupplier')?.value;
            
            if (!currentSupplier) {
                alert('Please select a supplier first before adding items');
                return;
            }
            
            // Save PO form state to localStorage for later restoration
            const poFormState = {
                supplier: currentSupplier,
                invoiceNumber: document.getElementById('poInvoiceNumber')?.value,
                purchaseDate: document.getElementById('poPurchaseDate')?.value,
                dueDate: document.getElementById('poDueDate')?.value,
                paymentTerms: document.getElementById('poPaymentTerms')?.value,
                status: document.getElementById('poStatus')?.value,
                amountPaid: document.getElementById('poAmountPaid')?.value,
                notes: document.getElementById('poNotes')?.value,
                returnToPO: true
            };
            localStorage.setItem('poFormState', JSON.stringify(poFormState));
            
            // Switch to Items tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent.includes('Items')) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            document.getElementById('items').classList.add('active');
            
            // Open Add Item form
            showAddItemForm();
            
            // Pre-select supplier if one was selected in PO
            setTimeout(() => {
                const supplierSelect = document.getElementById('itemSupplier');
                if (supplierSelect) {
                    supplierSelect.value = currentSupplier;
                }
            }, 100);
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            // Show helper message
            setTimeout(() => {
                showStatus('itemStatus', ' After saving the item, click " Back" to return to your purchase order', 'info');
            }, 200);
        }

        function updateConfigStatus() {
            const statusEl = document.getElementById('configStatusText');
            const apiInput = document.getElementById('apiUrl');
            
            const envNames = { production: ' Production', training: ' Training', test: ' Development' };
            const envColors = { production: '#059669', training: '#0284c7', test: '#dc2626' };
            
            if (API_URL) {
                if (apiInput) apiInput.value = API_URL;
                statusEl.innerHTML = ` Connected to <strong>${envNames[currentEnvironment]}</strong>`;
                statusEl.style.color = envColors[currentEnvironment];
            } else {
                statusEl.innerHTML = ' Not configured - enter API URL in settings';
                statusEl.style.color = '#f57c00';
            }
        }

        
        // Apply gradient for current theme (called on page load)
        function applyThemeGradient() {
            const themeColors = getThemeColors();
            const gradient = `linear-gradient(135deg, ${themeColors.primary} 0%, ${themeColors.accent} 100%)`;
            document.documentElement.style.setProperty('--theme-gradient', gradient);
            document.body.style.background = gradient;
            
            //  NEW: Also set the card background color
            const cardBg = generateLightBackground(themeColors.accent);
            document.documentElement.style.setProperty('--card-bg', cardBg);
        }
        
        function changeTheme() {
            const theme = document.getElementById('themeSelector').value;
            const body = document.body;
            
            // Remove all existing theme classes (ALL themes)
            body.classList.remove(
                // Classic themes
                'theme-purple', 'theme-ocean', 'theme-forest', 'theme-sunset', 'theme-dark', 'theme-crimson', 'theme-slate', 'theme-teal',
                // NFL Teams
                'theme-bills', 'theme-dolphins', 'theme-patriots', 'theme-jets',
                'theme-ravens', 'theme-bengals', 'theme-browns', 'theme-steelers',
                'theme-texans', 'theme-colts', 'theme-jaguars', 'theme-titans',
                'theme-broncos', 'theme-chiefs', 'theme-raiders', 'theme-chargers',
                'theme-cowboys', 'theme-giants', 'theme-eagles', 'theme-commanders',
                'theme-bears', 'theme-lions', 'theme-packers', 'theme-vikings',
                'theme-falcons', 'theme-panthers', 'theme-saints', 'theme-bucs',
                'theme-azcardinals', 'theme-rams', 'theme-niners', 'theme-seahawks',
                // MLB Teams
                'theme-orioles', 'theme-redsox', 'theme-yankees', 'theme-rays', 'theme-bluejays',
                'theme-whitesox', 'theme-guardians', 'theme-tigers', 'theme-royals', 'theme-twins',
                'theme-astros', 'theme-angels', 'theme-athletics', 'theme-mariners', 'theme-rangers',
                'theme-braves', 'theme-marlins', 'theme-mets', 'theme-phillies', 'theme-nationals',
                'theme-cubs', 'theme-reds', 'theme-brewers', 'theme-pirates', 'theme-stlcardinals',
                'theme-dbacks', 'theme-rockies', 'theme-dodgers', 'theme-padres', 'theme-sfgiants',
                // Chicago extras
                'theme-bulls', 'theme-blackhawks',
                // NHL Teams
                'theme-ducks', 'theme-coyotes', 'theme-bruins', 'theme-sabres', 'theme-flames',
                'theme-hurricanes', 'theme-avalanche', 'theme-bluejackets', 'theme-stars', 'theme-redwings',
                'theme-oilers', 'theme-flapanthers', 'theme-kings', 'theme-wild', 'theme-canadiens',
                'theme-predators', 'theme-devils', 'theme-islanders', 'theme-nhlrangers', 'theme-senators',
                'theme-flyers', 'theme-penguins', 'theme-sharks', 'theme-kraken', 'theme-stlblues',
                'theme-lightning', 'theme-mapleleafs', 'theme-canucks', 'theme-goldenknights',
                'theme-capitals', 'theme-nhljets',
                // NBA Teams
                'theme-hawks', 'theme-celtics', 'theme-nets', 'theme-hornets', 'theme-cavs',
                'theme-mavs', 'theme-nuggets', 'theme-pistons', 'theme-warriors', 'theme-rockets',
                'theme-pacers', 'theme-clippers', 'theme-lakers', 'theme-grizzlies', 'theme-heat',
                'theme-bucks', 'theme-twolves', 'theme-pelicans', 'theme-knicks', 'theme-thunder',
                'theme-magic', 'theme-sixers', 'theme-suns', 'theme-blazers', 'theme-nbakings',
                'theme-spurs', 'theme-raptors', 'theme-jazz', 'theme-wizards',
                // College Teams
                'theme-alabama', 'theme-arkansas', 'theme-auburn', 'theme-clemson', 'theme-florida',
                'theme-fsu', 'theme-georgia', 'theme-lsu', 'theme-michigan', 'theme-michiganst',
                'theme-ohiostate', 'theme-oklahoma', 'theme-okstate', 'theme-oregon', 'theme-oregonst',
                'theme-pennstate', 'theme-tennessee', 'theme-texas', 'theme-texasam', 'theme-usc',
                'theme-ucla', 'theme-notredame', 'theme-wisconsin', 'theme-nebraska', 'theme-miami', 'theme-byu',
                // Fast Food
                'theme-mcdonalds', 'theme-burgerking', 'theme-wendys', 'theme-tacobell', 'theme-kfc',
                'theme-subway', 'theme-pizzahut', 'theme-chickfila', 'theme-dunkin', 'theme-dominos',
                'theme-sonic', 'theme-arbys', 'theme-dairyqueen', 'theme-jackinthebox', 'theme-popeyes',
                'theme-chipotle', 'theme-fiveguys', 'theme-innout', 'theme-culvers', 'theme-timhortons',
                // Wisconsin Local
                'theme-kwiktrip', 'theme-rutters', 'theme-cenex', 'theme-cenexcoop', 'theme-fleetfarm',
                'theme-woodmans', 'theme-picknsave', 'theme-sentry', 'theme-festival', 'theme-pigglywiggly',
                'theme-holiday', 'theme-bp', 'theme-caseys', 'theme-shell', 'theme-mobil',
                // Retro Gaming
                'theme-nes', 'theme-snes', 'theme-genesis', 'theme-gameboy', 'theme-n64',
                'theme-ps1', 'theme-windows95', 'theme-windowsxp', 'theme-macos9', 'theme-amiga', 'theme-c64',
                // Cars
                'theme-camaro', 'theme-challenger', 'theme-bullitt', 'theme-supra', 'theme-skyline', 'theme-typer',
                // Sneakers
                'theme-jordan1', 'theme-yeezy', 'theme-pigeon', 'theme-wotherspoon',
                // National Parks
                'theme-yellowstone', 'theme-grandcanyon', 'theme-yosemite',
                // Lo-Fi / Vaporwave / Synthwave
                'theme-lofi', 'theme-chillhop', 'theme-vaporwave', 'theme-mallsoft', 'theme-miamivice', 'theme-outrun',
                // Airlines
                'theme-panam', 'theme-braniff', 'theme-southwest', 'theme-pokemon',
                // NFL Throwbacks
                'theme-bucscreamsicle', 'theme-steelersbee', 'theme-oilersthrow', 'theme-patpatriot',
                'theme-chargerspowder', 'theme-orangecrush', 'theme-kellygreen', 'theme-niners94',
                'theme-rams99', 'theme-seahawkslime', 'theme-falcons66', 'theme-jets98',
                'theme-bears36', 'theme-acme', 'theme-cards47',
                // NFL Alternates
                'theme-billsred', 'theme-chiefsred', 'theme-raidersblack', 'theme-whitetiger',
                'theme-brownsrush', 'theme-eaglesblack', 'theme-titansoilers', 'theme-actiongreen',
                'theme-jagsteal', 'theme-purplepeople',
                // Superheroes
                'theme-reaper', 'theme-spiderman', 'theme-symbiote', 'theme-batman', 'theme-superman',
                'theme-wonderwoman', 'theme-ironman', 'theme-captainamerica', 'theme-hulk', 'theme-thor',
                'theme-harleyquinn', 'theme-starlord', 'theme-groot', 'theme-marvelrivals',
                'theme-flash', 'theme-greenlantern',
                // Cyberpunk
                'theme-nightcity', 'theme-arasaka', 'theme-militech', 'theme-moxes', 'theme-valentinos',
                'theme-vjacket', 'theme-silverhand', 'theme-cyberpunkui', 'theme-phantomliberty', 'theme-cyberpunklogo',
                // Retro Search Engines
                'theme-yahoo1996', 'theme-yahoo2000s', 'theme-aol1995', 'theme-aol2000s', 'theme-excite1997',
                'theme-lycos', 'theme-altavista', 'theme-askjeeves', 'theme-webcrawler', 'theme-infoseek',
                'theme-msn1998', 'theme-netscape', 'theme-dogpile', 'theme-geocities',
                // MAME Arcade
                'theme-mamepacman', 'theme-mamemspacman', 'theme-mamedonkeykong', 'theme-mamespaceinvaders',
                'theme-mamegalaga', 'theme-mamefrogger', 'theme-mamestreetfighter', 'theme-mamemortalkombat',
                'theme-mamedefender', 'theme-mamecentipede', 'theme-mamedigdug', 'theme-mameqbert',
                'theme-mametempest', 'theme-mameasteroids', 'theme-mamebubble', 'theme-mamegauntlet',
                'theme-mamerampage', 'theme-mamerobotron', 'theme-mamejoust', 'theme-mametron',
                'theme-mamenbajam', 'theme-mamecontra', 'theme-mamemetalslug', 'theme-mametmnt',
                'theme-mamedoubledragon', 'theme-mamefinalfight', 'theme-mamegradius', 'theme-mamegoldenaxe',
                'theme-mamestrider', 'theme-mamertype',
                // Monster Energy
                'theme-monstergreen', 'theme-monsterblack', 'theme-monstersunrise', 'theme-monsterparadise',
                'theme-monsterviolet', 'theme-monsterpipeline', 'theme-monsterrehab', 'theme-monsterred',
                // Mountain Dew
                'theme-mtndewgreen', 'theme-mtndewcodered', 'theme-mtndewvoltage', 'theme-mtndewbaja',
                'theme-mtndewlivewire', 'theme-mtndewwhiteout',
                // Root Beer & Soda
                'theme-awrootbeer', 'theme-barqs', 'theme-mugcream', 'theme-ibccherry',
                'theme-cocacola', 'theme-drpepper', 'theme-pepsi', 'theme-sprite', 'theme-fanta',
                // Energy Drinks
                'theme-redbull', 'theme-rockstar', 'theme-nos', 'theme-bang', 'theme-c4energy',
                'theme-alaninu', 'theme-ghostenergy', 'theme-celsius', 'theme-prime', 'theme-reign', 'theme-gamerfuel'
            );
            
            // Add new theme class
            body.classList.add('theme-' + theme);
            
            // Save preference FIRST (so getThemeColors reads the correct theme)
            localStorage.setItem('theme', theme);
            
            // Set --primary CSS variable based on theme
            const themeColors = getThemeColors();
            document.documentElement.style.setProperty('--primary', themeColors.primary);
            document.documentElement.style.setProperty('--secondary', themeColors.accent);
            document.documentElement.style.setProperty('--primary-light', hexToRgbaLight(themeColors.primary));
            
            //  NEW: Generate light background color for cards and navigation
            const cardBg = generateLightBackground(themeColors.accent);
            document.documentElement.style.setProperty('--card-bg', cardBg);
            
            //  NEW: Apply dynamic gradient to ALL themes
            const gradient = `linear-gradient(135deg, ${themeColors.primary} 0%, ${themeColors.accent} 100%)`;
            document.documentElement.style.setProperty('--theme-gradient', gradient);
            
            // Apply gradient to body background
            document.body.style.background = gradient;
            
            showStatus('configStatus', ` Theme changed to ${theme}!`, 'success');
        }
        
        // NEW: Generate a light pastel background color from hex
        function generateLightBackground(hexColor) {
            // Convert hex to RGB
            const r = parseInt(hexColor.slice(1, 3), 16);
            const g = parseInt(hexColor.slice(3, 5), 16);
            const b = parseInt(hexColor.slice(5, 7), 16);
            
            // Create a very light tint (mix with white at ~92%)
            const lightR = Math.round(r * 0.08 + 255 * 0.92);
            const lightG = Math.round(g * 0.08 + 255 * 0.92);
            const lightB = Math.round(b * 0.08 + 255 * 0.92);
            
            return `rgb(${lightR}, ${lightG}, ${lightB})`;
        }
        
        // Convert hex to light background color
        function hexToRgbaLight(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, 0.1)`;
        }
        
        // Get theme colors for print templates
        function getThemeColors() {
            const theme = localStorage.getItem('theme') || 'purple';
            const themes = {
                // Classic themes
                purple: { primary: '#667eea', accent: '#764ba2', text: '#667eea' },
                ocean: { primary: '#0077b6', accent: '#00b4d8', text: '#0077b6' },
                forest: { primary: '#2d6a4f', accent: '#40916c', text: '#2d6a4f' },
                sunset: { primary: '#e85d04', accent: '#f48c06', text: '#e85d04' },
                dark: { primary: '#1e293b', accent: '#334155', text: '#1e293b' },
                crimson: { primary: '#be123c', accent: '#e11d48', text: '#be123c' },
                slate: { primary: '#475569', accent: '#64748b', text: '#475569' },
                teal: { primary: '#0d9488', accent: '#14b8a6', text: '#0d9488' },
                // NFL AFC East
                bills: { primary: '#00338D', accent: '#C60C30', text: '#C60C30' },
                dolphins: { primary: '#008E97', accent: '#FC4C02', text: '#FC4C02' },
                patriots: { primary: '#002244', accent: '#C60C30', text: '#C60C30' },
                jets: { primary: '#125740', accent: '#000000', text: '#FFFFFF' },
                // NFL AFC North
                ravens: { primary: '#241773', accent: '#9E7C0C', text: '#9E7C0C' },
                bengals: { primary: '#FB4F14', accent: '#000000', text: '#FFFFFF' },
                browns: { primary: '#311D00', accent: '#FF3C00', text: '#FF3C00' },
                steelers: { primary: '#FFB612', accent: '#000000', text: '#000000' },
                // NFL AFC South
                texans: { primary: '#03202F', accent: '#A71930', text: '#A71930' },
                colts: { primary: '#002C5F', accent: '#A2AAAD', text: '#FFFFFF' },
                jaguars: { primary: '#006778', accent: '#D7A22A', text: '#D7A22A' },
                titans: { primary: '#0C2340', accent: '#4B92DB', text: '#4B92DB' },
                // NFL AFC West
                broncos: { primary: '#FB4F14', accent: '#002244', text: '#002244' },
                chiefs: { primary: '#E31937', accent: '#FFB612', text: '#FFB612' },
                raiders: { primary: '#000000', accent: '#A5ACAF', text: '#A5ACAF' },
                chargers: { primary: '#0080C6', accent: '#FFC20E', text: '#FFC20E' },
                // NFL NFC East
                cowboys: { primary: '#003594', accent: '#869397', text: '#FFFFFF' },
                giants: { primary: '#0B2265', accent: '#A71930', text: '#A71930' },
                eagles: { primary: '#004C54', accent: '#A5ACAF', text: '#A5ACAF' },
                commanders: { primary: '#5A1414', accent: '#FFB612', text: '#FFB612' },
                // NFL NFC North
                bears: { primary: '#0B162A', accent: '#C83803', text: '#C83803' },
                lions: { primary: '#0076B6', accent: '#B0B7BC', text: '#FFFFFF' },
                packers: { primary: '#203731', accent: '#FFB612', text: '#FFB612' },
                vikings: { primary: '#4F2683', accent: '#FFC62F', text: '#FFC62F' },
                // NFL NFC South
                falcons: { primary: '#A71930', accent: '#000000', text: '#FFFFFF' },
                panthers: { primary: '#0085CA', accent: '#BFC0BF', text: '#FFFFFF' },
                saints: { primary: '#D3BC8D', accent: '#101820', text: '#101820' },
                bucs: { primary: '#D50A0A', accent: '#34302B', text: '#FFFFFF' },
                // NFL NFC West
                azcardinals: { primary: '#97233F', accent: '#000000', text: '#FFFFFF' },
                rams: { primary: '#003594', accent: '#FFA300', text: '#FFA300' },
                niners: { primary: '#AA0000', accent: '#B3995D', text: '#B3995D' },
                seahawks: { primary: '#002244', accent: '#69BE28', text: '#69BE28' },
                // MLB AL East
                orioles: { primary: '#DF4601', accent: '#000000', text: '#FFFFFF' },
                redsox: { primary: '#BD3039', accent: '#0C2340', text: '#0C2340' },
                yankees: { primary: '#0C2340', accent: '#C4CED4', text: '#FFFFFF' },
                rays: { primary: '#092C5C', accent: '#8FBCE6', text: '#F5D130' },
                bluejays: { primary: '#134A8E', accent: '#E8291C', text: '#E8291C' },
                // MLB AL Central
                whitesox: { primary: '#000000', accent: '#C4CED4', text: '#C4CED4' },
                guardians: { primary: '#E31937', accent: '#003087', text: '#003087' },
                tigers: { primary: '#0C2340', accent: '#FA4616', text: '#FA4616' },
                royals: { primary: '#004687', accent: '#BD9B60', text: '#BD9B60' },
                twins: { primary: '#002B5C', accent: '#D31145', text: '#D31145' },
                // MLB AL West
                astros: { primary: '#002D62', accent: '#EB6E1F', text: '#EB6E1F' },
                angels: { primary: '#BA0021', accent: '#003263', text: '#FFFFFF' },
                athletics: { primary: '#003831', accent: '#EFB21E', text: '#EFB21E' },
                mariners: { primary: '#0C2C56', accent: '#005C5C', text: '#00A3E0' },
                rangers: { primary: '#003278', accent: '#C0111F', text: '#C0111F' },
                // MLB NL East
                braves: { primary: '#CE1141', accent: '#13274F', text: '#13274F' },
                marlins: { primary: '#00A3E0', accent: '#FF6600', text: '#FF6600' },
                mets: { primary: '#002D72', accent: '#FF5910', text: '#FF5910' },
                phillies: { primary: '#E81838', accent: '#002D72', text: '#002D72' },
                nationals: { primary: '#AB0003', accent: '#14225A', text: '#14225A' },
                // MLB NL Central
                cubs: { primary: '#0E3386', accent: '#CC3433', text: '#CC3433' },
                reds: { primary: '#C6011F', accent: '#000000', text: '#FFFFFF' },
                brewers: { primary: '#12284B', accent: '#FFB81C', text: '#FFB81C' },
                pirates: { primary: '#FDB827', accent: '#000000', text: '#000000' },
                stlcardinals: { primary: '#C41E3A', accent: '#0C2340', text: '#FEDB00' },
                // MLB NL West
                dbacks: { primary: '#A71930', accent: '#E3D4AD', text: '#E3D4AD' },
                rockies: { primary: '#33006B', accent: '#C4CED4', text: '#C4CED4' },
                dodgers: { primary: '#005A9C', accent: '#EF3E42', text: '#FFFFFF' },
                padres: { primary: '#2F241D', accent: '#FFC425', text: '#FFC425' },
                sfgiants: { primary: '#FD5A1E', accent: '#000000', text: '#000000' },
                // Chicago extras
                bulls: { primary: '#121212', accent: '#CE1141', text: '#CE1141' },
                blackhawks: { primary: '#002F6C', accent: '#CF0A2C', text: '#CF0A2C' },
                // Retro Search Engines
                yahoo1996: { primary: '#6001A8', accent: '#FF9900', text: '#FF9900' },
                yahoo2000s: { primary: '#7B0099', accent: '#FF0000', text: '#FF0000' },
                aol1995: { primary: '#00C8FF', accent: '#FFCC00', text: '#FFCC00' },
                aol2000s: { primary: '#00A0D8', accent: '#FFFFFF', text: '#FFFFFF' },
                excite1997: { primary: '#E4002B', accent: '#000000', text: '#FFFFFF' },
                lycos: { primary: '#FF0000', accent: '#000000', text: '#FFFFFF' },
                altavista: { primary: '#0066CC', accent: '#FF9900', text: '#FF9900' },
                askjeeves: { primary: '#00A99D', accent: '#FF6600', text: '#FF6600' },
                webcrawler: { primary: '#009900', accent: '#FFFF00', text: '#FFFF00' },
                infoseek: { primary: '#660099', accent: '#FFCC00', text: '#FFCC00' },
                msn1998: { primary: '#00ADEF', accent: '#FFB900', text: '#FFB900' },
                netscape: { primary: '#0033CC', accent: '#FFCC00', text: '#FFCC00' },
                dogpile: { primary: '#FF6600', accent: '#6600CC', text: '#6600CC' },
                geocities: { primary: '#FF0099', accent: '#00FF00', text: '#00FF00' },
                // MAME Arcade
                mamepacman: { primary: '#FFFF00', accent: '#FF0000', text: '#FFFF00' },
                mamemspacman: { primary: '#FF21AE', accent: '#00FFFF', text: '#00FFFF' },
                mamedonkeykong: { primary: '#E80709', accent: '#EE7511', text: '#EE7511' },
                mamespaceinvaders: { primary: '#62DE6D', accent: '#F83B3A', text: '#62DE6D' },
                mamegalaga: { primary: '#00FF00', accent: '#EC4705', text: '#00FF00' },
                mamefrogger: { primary: '#66A400', accent: '#EB1C2D', text: '#66A400' },
                mamestreetfighter: { primary: '#FFFFFF', accent: '#E70000', text: '#E70000' },
                mamemortalkombat: { primary: '#EED911', accent: '#F53929', text: '#EED911' },
                mamedefender: { primary: '#00A651', accent: '#FF4500', text: '#00A651' },
                mamecentipede: { primary: '#228B22', accent: '#8B4513', text: '#FFFFFF' },
                mamedigdug: { primary: '#4169E1', accent: '#FF0000', text: '#4169E1' },
                mameqbert: { primary: '#9370DB', accent: '#FF8C00', text: '#9370DB' },
                mametempest: { primary: '#8A2BE2', accent: '#00BFFF', text: '#00BFFF' },
                mameasteroids: { primary: '#FFFFFF', accent: '#00FFFF', text: '#00FFFF' },
                mamebubble: { primary: '#FFB6C1', accent: '#87CEEB', text: '#FFB6C1' },
                mamegauntlet: { primary: '#40FF40', accent: '#FF4040', text: '#40FF40' },
                mamerampage: { primary: '#00A000', accent: '#FF69B4', text: '#00A000' },
                mamerobotron: { primary: '#00FFFF', accent: '#FF00FF', text: '#00FFFF' },
                mamejoust: { primary: '#FFD700', accent: '#FF0000', text: '#FFD700' },
                mametron: { primary: '#00FFFF', accent: '#FF0000', text: '#00FFFF' },
                mamenbajam: { primary: '#C8102E', accent: '#002244', text: '#FFFFFF' },
                mamecontra: { primary: '#0000FF', accent: '#FF0000', text: '#FF0000' },
                mamemetalslug: { primary: '#FFD700', accent: '#4169E1', text: '#FFD700' },
                mametmnt: { primary: '#008000', accent: '#FF0000', text: '#008000' },
                mamedoubledragon: { primary: '#0000FF', accent: '#FF0000', text: '#0000FF' },
                mamefinalfight: { primary: '#FFFF00', accent: '#FF0000', text: '#FFFF00' },
                mamegradius: { primary: '#00FFFF', accent: '#FF4500', text: '#00FFFF' },
                mamegoldenaxe: { primary: '#8B0000', accent: '#FF4500', text: '#FF4500' },
                mamestrider: { primary: '#00FF00', accent: '#FF00FF', text: '#00FF00' },
                mamertype: { primary: '#4169E1', accent: '#FF0000', text: '#4169E1' },
                // Monster Energy
                monstergreen: { primary: '#8DC63F', accent: '#000000', text: '#8DC63F' },
                monsterblack: { primary: '#000000', accent: '#C0C0C0', text: '#C0C0C0' },
                monstersunrise: { primary: '#FF6B00', accent: '#FFD700', text: '#FFD700' },
                monsterparadise: { primary: '#00FF7F', accent: '#FFFFFF', text: '#00FF7F' },
                monsterviolet: { primary: '#9932CC', accent: '#E0B0FF', text: '#E0B0FF' },
                monsterpipeline: { primary: '#FF69B4', accent: '#FFD700', text: '#FFD700' },
                monsterrehab: { primary: '#FFD700', accent: '#8B4513', text: '#FFD700' },
                monsterred: { primary: '#C8102E', accent: '#FFFFFF', text: '#FFFFFF' },
                // Mountain Dew
                mtndewgreen: { primary: '#99CC00', accent: '#006633', text: '#99CC00' },
                mtndewcodered: { primary: '#C8102E', accent: '#000000', text: '#C8102E' },
                mtndewvoltage: { primary: '#00B7EB', accent: '#000000', text: '#00B7EB' },
                mtndewbaja: { primary: '#66CCCC', accent: '#FFFFFF', text: '#FFFFFF' },
                mtndewlivewire: { primary: '#FF6B00', accent: '#000000', text: '#FF6B00' },
                mtndewwhiteout: { primary: '#FFFFFF', accent: '#00BFFF', text: '#00BFFF' },
                // Root Beer & Soda
                awrootbeer: { primary: '#8B4513', accent: '#FFD700', text: '#FFD700' },
                barqs: { primary: '#C8102E', accent: '#FFFFFF', text: '#FFFFFF' },
                mugcream: { primary: '#FFF8DC', accent: '#8B4513', text: '#8B4513' },
                ibccherry: { primary: '#4B0082', accent: '#C71585', text: '#C71585' },
                cocacola: { primary: '#C8102E', accent: '#FFFFFF', text: '#FFFFFF' },
                drpepper: { primary: '#8B0000', accent: '#DAA520', text: '#DAA520' },
                pepsi: { primary: '#004B8D', accent: '#E4002B', text: '#FFFFFF' },
                sprite: { primary: '#00A550', accent: '#FFFFFF', text: '#FFFFFF' },
                fanta: { primary: '#FF6600', accent: '#003DA5', text: '#FF6600' },
                // Energy Drinks
                redbull: { primary: '#0050A4', accent: '#C0C0C0', text: '#C0C0C0' },
                rockstar: { primary: '#800080', accent: '#FFD700', text: '#FFD700' },
                nos: { primary: '#000000', accent: '#FF0000', text: '#FF0000' },
                bang: { primary: '#FF6B00', accent: '#FFD700', text: '#FFD700' },
                c4energy: { primary: '#00BFFF', accent: '#FFFFFF', text: '#FFFFFF' },
                alaninu: { primary: '#FF69B4', accent: '#E0B0FF', text: '#E0B0FF' },
                ghostenergy: { primary: '#39FF14', accent: '#000000', text: '#39FF14' },
                celsius: { primary: '#FF4500', accent: '#FFD700', text: '#FFD700' },
                prime: { primary: '#00AEEF', accent: '#FF6B00', text: '#FF6B00' },
                reign: { primary: '#000000', accent: '#C0C0C0', text: '#C0C0C0' },
                gamerfuel: { primary: '#00FFFF', accent: '#FF00FF', text: '#00FFFF' },
                // Cyberpunk / Neon
                neon: { primary: '#00FFFF', accent: '#FF00FF', text: '#00FFFF' },
                neoncyan: { primary: '#00FFFF', accent: '#0088AA', text: '#00FFFF' },
                neonpink: { primary: '#FF00FF', accent: '#FF0080', text: '#FF00FF' },
                neonyellow: { primary: '#FFFF00', accent: '#FFD700', text: '#FFFF00' },
                neongreen: { primary: '#39FF14', accent: '#00FF00', text: '#39FF14' },
                cyberpunk: { primary: '#FF00FF', accent: '#00FFFF', text: '#FF00FF' },
                synthwave: { primary: '#FF6EC7', accent: '#7B68EE', text: '#FF6EC7' },
                vaporwave: { primary: '#FF71CE', accent: '#01CDFE', text: '#FF71CE' },
                retrowave: { primary: '#F9C80E', accent: '#FF6B6B', text: '#F9C80E' },
                outrun: { primary: '#FF2A6D', accent: '#05D9E8', text: '#FF2A6D' }
            };
            return themes[theme] || themes.purple;
        }
        
        // ========== SPLASH SCREEN FUNCTIONS ==========
        const SPLASH_BACKGROUNDS = {
            // Cubs options
            'cubs1': './cubs1.jpg',
            'cubs2': './cubs2.jpg',
            'cubs3': './cubs3.jpg',
            'cubs4': './cubs4.jpg',
            'cubs5': './cubs5.jpg',
            // Bears options
            'bears1': './bears1.jpg',
            'bears2': './bears2.jpg',
            'bears3': './bears3.jpg',
            'bears4': './bears4.jpg',
            'bears5': './bears5.jpg',
            // Gradient fallbacks
            'gradient-blue': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'gradient-purple': 'linear-gradient(135deg, #7c3aed 0%, #c026d3 100%)',
            'gradient-green': 'linear-gradient(135deg, #059669 0%, #10b981 100%)',
            'gradient-sunset': 'linear-gradient(135deg, #f59e0b 0%, #ef4444 100%)',
            'gradient-dark': 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)'
        };
        
        function getSplashBackground(key) {
            if (key === 'custom') {
                return localStorage.getItem('splashCustomUrl') || SPLASH_BACKGROUNDS['gradient-blue'];
            }
            return SPLASH_BACKGROUNDS[key] || SPLASH_BACKGROUNDS['gradient-blue'];
        }
        
        function saveSplashSettings() {
            const enabled = document.getElementById('splashScreenEnabled')?.checked || false;
            const background = document.getElementById('splashBackground')?.value || 'gradient-blue';
            const customUrl = document.getElementById('splashCustomUrl')?.value || '';
            
            localStorage.setItem('splashEnabled', enabled ? 'true' : 'false');
            localStorage.setItem('splashBackground', background);
            localStorage.setItem('splashCustomUrl', customUrl);
            
            // Show/hide custom URL input
            const customInput = document.getElementById('splashCustomUrl');
            if (customInput) {
                customInput.style.display = background === 'custom' ? 'block' : 'none';
            }
        }
        
        function loadSplashSettings() {
            const enabled = localStorage.getItem('splashEnabled') === 'true';
            const background = localStorage.getItem('splashBackground') || 'gradient-blue';
            const customUrl = localStorage.getItem('splashCustomUrl') || '';
            
            const enabledEl = document.getElementById('splashScreenEnabled');
            const backgroundEl = document.getElementById('splashBackground');
            const customUrlEl = document.getElementById('splashCustomUrl');
            
            if (enabledEl) enabledEl.checked = enabled;
            if (backgroundEl) backgroundEl.value = background;
            if (customUrlEl) {
                customUrlEl.value = customUrl;
                customUrlEl.style.display = background === 'custom' ? 'block' : 'none';
            }
        }
        
        function showSplashScreen(force = false) {
            const enabled = localStorage.getItem('splashEnabled') === 'true';
            if (!enabled && !force) return;
            
            const background = localStorage.getItem('splashBackground') || 'gradient-blue';
            const bgValue = getSplashBackground(background);
            const isGradient = bgValue.startsWith('linear-gradient');
            
            const splash = document.createElement('div');
            splash.id = 'splashScreen';
            splash.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 999999;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                overflow: hidden;
                ${isGradient ? `background: ${bgValue};` : `background: url('${bgValue}') center center / cover no-repeat; background-color: #1a1a2e;`}
            `;
            
            // Hide body scrollbar while splash is showing
            document.body.style.overflow = 'hidden';
            document.documentElement.style.overflow = 'hidden';
            document.body.classList.add('splash-active');
            
            splash.innerHTML = `
                <style>
                    body.splash-active, html {
                        overflow: hidden !important;
                        -ms-overflow-style: none !important;
                        scrollbar-width: none !important;
                    }
                    body.splash-active::-webkit-scrollbar, 
                    html::-webkit-scrollbar,
                    #splashScreen::-webkit-scrollbar {
                        display: none !important;
                        width: 0 !important;
                    }
                    @keyframes pulse {
                        0%, 100% { opacity: 0.7; transform: translateX(-50%) scale(1); }
                        50% { opacity: 1; transform: translateX(-50%) scale(1.05); }
                    }
                </style>
                <div style="text-align: center; padding: 40px; position: absolute; top: 4%; left: 50%; transform: translateX(-50%);">
                    <h1 style="color: white; font-size: 2.5rem; margin-bottom: 10px; text-shadow: 3px 3px 6px rgba(0,0,0,0.8), 0 0 20px rgba(0,0,0,0.5);">Nowak Distributing</h1>
                    <p style="color: white; font-size: 1.2rem; margin-bottom: 30px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">ERP System</p>
                </div>
                <div style="position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.9); font-size: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); animation: pulse 2s ease-in-out infinite;">
                     Tap anywhere to continue
                </div>
            `;
            
            splash.addEventListener('click', () => {
                splash.style.transition = 'opacity 0.3s ease';
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.remove();
                    document.body.style.overflow = '';
                    document.documentElement.style.overflow = '';
                    document.body.classList.remove('splash-active');
                }, 300);
            });
            
            document.body.appendChild(splash);
        }
        
        function openBackup() {
            if (!API_URL) {
                alert('Please configure your API URL first!');
                return;
            }
            // Extract the Google Sheets URL from API URL pattern
            alert('To backup your data:\n\n1. Go to your Google Sheets database\n2. File  Make a copy\n3. Download as Excel or CSV\n\nYour Google Sheet contains all your data!');
        }
        
        // Load theme on startup
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'purple';
            document.getElementById('themeSelector').value = savedTheme;
            document.body.classList.remove(
                'theme-purple', 'theme-ocean', 'theme-forest', 'theme-sunset', 'theme-dark', 'theme-crimson', 'theme-slate', 'theme-teal',
                'theme-bills', 'theme-dolphins', 'theme-patriots', 'theme-jets',
                'theme-ravens', 'theme-bengals', 'theme-browns', 'theme-steelers',
                'theme-texans', 'theme-colts', 'theme-jaguars', 'theme-titans',
                'theme-broncos', 'theme-chiefs', 'theme-raiders', 'theme-chargers',
                'theme-cowboys', 'theme-giants', 'theme-eagles', 'theme-commanders',
                'theme-bears', 'theme-lions', 'theme-packers', 'theme-vikings',
                'theme-falcons', 'theme-panthers', 'theme-saints', 'theme-bucs',
                'theme-azcardinals', 'theme-rams', 'theme-niners', 'theme-seahawks',
                'theme-orioles', 'theme-redsox', 'theme-yankees', 'theme-rays', 'theme-bluejays',
                'theme-whitesox', 'theme-guardians', 'theme-tigers', 'theme-royals', 'theme-twins',
                'theme-astros', 'theme-angels', 'theme-athletics', 'theme-mariners', 'theme-rangers',
                'theme-braves', 'theme-marlins', 'theme-mets', 'theme-phillies', 'theme-nationals',
                'theme-cubs', 'theme-reds', 'theme-brewers', 'theme-pirates', 'theme-stlcardinals',
                'theme-dbacks', 'theme-rockies', 'theme-dodgers', 'theme-padres', 'theme-sfgiants',
                'theme-bulls', 'theme-blackhawks'
            );
            document.body.classList.add('theme-' + savedTheme);
            
            // Show splash screen if enabled
            showSplashScreen();
            
            // Load splash settings for settings page
            setTimeout(() => loadSplashSettings(), 500);
            
            // Set --primary CSS variable based on saved theme
            setTimeout(() => {
                const themeColors = getThemeColors();
                document.documentElement.style.setProperty('--primary', themeColors.primary);
                document.documentElement.style.setProperty('--secondary', themeColors.accent);
                document.documentElement.style.setProperty('--primary-light', hexToRgbaLight(themeColors.primary));
                
                // Update theme preview in settings
                if (typeof updateThemePreview === 'function') {
                    updateThemePreview();
                }
            }, 100);
        });
        
        function saveConfig() {
            // Save all environment URLs
            ['production', 'training', 'test'].forEach(env => {
                const input = document.getElementById(`envUrl-${env}`);
                if (input) {
                    const url = input.value.trim();
                    environments[env] = url;
                    localStorage.setItem(`envUrl-${env}`, url);
                }
            });
            
            // Update the active API_URL
            API_URL = getActiveApiUrl();
            localStorage.setItem('apiUrl', API_URL);
            
            // Also update the hidden legacy input for compatibility
            const apiUrlInput = document.getElementById('apiUrl');
            if (apiUrlInput) {
                apiUrlInput.value = API_URL;
            }
            
            updateConfigStatus();
            updateEnvironmentUI();
            
            showStatus('configStatus', ' All environment settings saved!', 'success');
        }
        
        // Save Invoice Settings
        function saveInvoiceSettings() {
            const settings = {
                companyName: document.getElementById('invoiceCompanyName').value,
                contactName: document.getElementById('invoiceContactName').value,
                phone: document.getElementById('invoicePhone').value,
                email: document.getElementById('invoiceEmail').value,
                address1: document.getElementById('invoiceAddress1').value,
                address2: document.getElementById('invoiceAddress2').value,
                cityStateZip: document.getElementById('invoiceCityStateZip').value,
                footer: document.getElementById('invoiceFooter').value,
                signatureLine: document.getElementById('invoiceSignatureLine').checked
            };
            
            localStorage.setItem('invoiceSettings', JSON.stringify(settings));
            showStatus('configStatus', ' Invoice settings saved!', 'success');
        }
        
        // Load Invoice Settings
        function loadInvoiceSettings() {
            const saved = localStorage.getItem('invoiceSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('invoiceCompanyName').value = settings.companyName || '';
                document.getElementById('invoiceContactName').value = settings.contactName || '';
                document.getElementById('invoicePhone').value = settings.phone || '';
                document.getElementById('invoiceEmail').value = settings.email || '';
                document.getElementById('invoiceAddress1').value = settings.address1 || '';
                document.getElementById('invoiceAddress2').value = settings.address2 || '';
                document.getElementById('invoiceCityStateZip').value = settings.cityStateZip || '';
                document.getElementById('invoiceFooter').value = settings.footer || '';
                document.getElementById('invoiceSignatureLine').checked = settings.signatureLine !== false;
            }
        }
        
        // Get Invoice Settings
        function getInvoiceSettings() {
            const saved = localStorage.getItem('invoiceSettings');
            if (saved) {
                return JSON.parse(saved);
            }
            return {
                companyName: 'Nowak Distributing',
                contactName: '',
                phone: '(920)634-4351',
                email: 'jnowaksnfoodistributors@gmail.com',
                address1: '',
                address2: '',
                cityStateZip: '',
                footer: 'Thank you for doing business with us!',
                signatureLine: true
            };
        }

        // Format phone number as (999) 999-9999
        function formatPhone(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            if (value.length > 10) value = value.slice(0, 10);
            
            if (value.length >= 6) {
                input.value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6)}`;
            } else if (value.length >= 3) {
                input.value = `(${value.slice(0,3)}) ${value.slice(3)}`;
            } else if (value.length > 0) {
                input.value = `(${value}`;
            }
        }
        
        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        async function apiCall(action, data = {}) {
            if (!API_URL) {
                console.error('API_URL not configured!');
                alert('Please configure your API URL in Settings first!');
                switchTab('config');
                return null;
            }

            try {
                // Use GET with query parameters to avoid CORS preflight
                const params = new URLSearchParams({
                    action: action,
                    data: JSON.stringify(data)
                });
                
                const url = `${API_URL}?${params.toString()}`;
                console.log(`API Call: ${action}`, { url: url.substring(0, 100) + '...' });
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                });

                console.log(`API Response status: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    console.error('API HTTP Error:', response.status, response.statusText);
                    return { status: 'error', message: `HTTP ${response.status}: ${response.statusText}` };
                }

                const text = await response.text();
                console.log('API Response text (first 200 chars):', text.substring(0, 200));
                
                try {
                    const result = JSON.parse(text);
                    return result;
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError, 'Response was:', text.substring(0, 500));
                    return { status: 'error', message: 'Invalid JSON response from server' };
                }
            } catch (error) {
                console.error('API Fetch Error:', error);
                return { status: 'error', message: error.toString() };
            }
        }

        // ==================== SUPPLIERS ====================

        function showAddSupplierForm() {
            document.getElementById('addSupplierForm').style.display = 'block';
        }

        function hideAddSupplierForm() {
            document.getElementById('addSupplierForm').style.display = 'none';
            document.querySelector('#addSupplierForm form').reset();
        }

        async function addSupplier(e) {
            e.preventDefault();
            
            const data = {
                supplierName: document.getElementById('newSupplierName').value,
                contactName: document.getElementById('newContactName').value,
                phone: document.getElementById('newPhone').value,
                email: document.getElementById('newEmail').value,
                address: document.getElementById('newAddress').value,
                city: document.getElementById('newCity').value,
                state: document.getElementById('newState').value,
                zip: document.getElementById('newZip').value,
                paymentTerms: document.getElementById('newPaymentTerms').value,
                notes: document.getElementById('newNotes').value
            };

            const result = await apiCall('addSupplier', data);
            
            if (result && result.status === 'success') {
                showStatus('suppliersStatus', ' Supplier added successfully!', 'success');
                hideAddSupplierForm();
                loadSuppliers();
            } else {
                showStatus('suppliersStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        async function loadSuppliers() {
            document.getElementById('suppliersTable').innerHTML = '<div class="loading">Loading suppliers...</div>';
            
            const result = await apiCall('getSuppliers');
            
            if (result && result.status === 'success') {
                cachedSuppliers = result.data;
                displaySuppliers(result.data);
                
                // Populate Create PO supplier dropdown
                const createPOSupplierSelect = document.getElementById('createPOSupplier');
                if (createPOSupplierSelect) {
                    createPOSupplierSelect.innerHTML = '<option value="">Select Supplier...</option>';
                    result.data.forEach(supplier => {
                        const option = document.createElement('option');
                        option.value = supplier.Supplier_ID;
                        option.textContent = supplier.Supplier_Name;
                        createPOSupplierSelect.appendChild(option);
                    });
                }
            } else {
                document.getElementById('suppliersTable').innerHTML = '<div class="loading">Error loading suppliers</div>';
            }
        }

        function displaySuppliers(suppliers) {
            if (!suppliers || suppliers.length === 0) {
                document.getElementById('suppliersTable').innerHTML = '<p>No suppliers yet. Add your first supplier!</p>';
                return;
            }

            let html = '<table class="data-table" id="suppliersDataTable"><thead><tr>';
            html += '<th>Name</th><th>Contact</th><th>Phone</th><th>Email</th><th>City</th><th>Payment Terms</th>';
            html += '</tr></thead><tbody>';

            suppliers.forEach(s => {
                html += `<tr style="cursor: pointer;" onclick='editSupplier(${JSON.stringify(s).replace(/'/g, "&#39;")})' onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                    <td><strong>${s.Supplier_Name}</strong></td>
                    <td>${s.Contact_Name || '-'}</td>
                    <td>${s.Phone || '-'}</td>
                    <td>${s.Email || '-'}</td>
                    <td>${s.City || '-'}, ${s.State || '-'}</td>
                    <td>${s.Payment_Terms || '-'}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('suppliersTable').innerHTML = html;
            
            // Make table sortable
            setTimeout(() => makeSortable('suppliersDataTable'), 0);
        }
        
        // Filter suppliers
        function filterSuppliers() {
            const nameFilter = document.getElementById('filterSupplierName').value.toLowerCase();
            const cityFilter = document.getElementById('filterSupplierCity').value.toLowerCase();
            const stateFilter = document.getElementById('filterSupplierState').value.toLowerCase();
            
            const filtered = cachedSuppliers.filter(s => {
                const matchesName = !nameFilter || (s.Supplier_Name && s.Supplier_Name.toLowerCase().includes(nameFilter));
                const matchesCity = !cityFilter || (s.City && s.City.toLowerCase().includes(cityFilter));
                const matchesState = !stateFilter || (s.State && s.State.toLowerCase().includes(stateFilter));
                return matchesName && matchesCity && matchesState;
            });
            
            displaySuppliers(filtered);
        }
        
        function clearSupplierFilters() {
            document.getElementById('filterSupplierName').value = '';
            document.getElementById('filterSupplierCity').value = '';
            document.getElementById('filterSupplierState').value = '';
            displaySuppliers(cachedSuppliers);
        }
        
        // Edit supplier
        function editSupplier(supplier) {
            document.getElementById('editSupplierId').value = supplier.Supplier_ID;
            document.getElementById('editSupplierName').value = supplier.Supplier_Name || '';
            document.getElementById('editContactName').value = supplier.Contact_Name || '';
            document.getElementById('editPhone').value = supplier.Phone || '';
            document.getElementById('editEmail').value = supplier.Email || '';
            document.getElementById('editAddress').value = supplier.Address || '';
            document.getElementById('editCity').value = supplier.City || '';
            document.getElementById('editState').value = supplier.State || '';
            document.getElementById('editZip').value = supplier.ZIP || '';
            document.getElementById('editPaymentTerms').value = supplier.Payment_Terms || 'Net 30';
            document.getElementById('editNotes').value = supplier.Notes || '';
            
            document.getElementById('editSupplierForm').style.display = 'block';
            document.getElementById('addSupplierForm').style.display = 'none';
        }
        
        function hideEditSupplierForm() {
            document.getElementById('editSupplierForm').style.display = 'none';
            document.querySelector('#editSupplierForm form').reset();
            
            // Return to previous tab if we came from Reports
            if (returnToTab === 'reports') {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="reports"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('reports').classList.add('active');
                returnToTab = null;
            }
        }
        
        async function updateSupplier(e) {
            e.preventDefault();
            
            const data = {
                supplierId: document.getElementById('editSupplierId').value,
                name: document.getElementById('editSupplierName').value,
                address: document.getElementById('editAddress').value,
                city: document.getElementById('editCity').value,
                state: document.getElementById('editState').value,
                zip: document.getElementById('editZip').value,
                contactName: document.getElementById('editContactName').value,
                phone: document.getElementById('editPhone').value,
                fax: '',
                email: document.getElementById('editEmail').value,
                paymentTerms: document.getElementById('editPaymentTerms').value,
                notes: document.getElementById('editNotes').value
            };
            
            const result = await apiCall('updateSupplier', data);
            
            if (result && result.status === 'success') {
                showStatus('suppliersStatus', ' Supplier updated successfully!', 'success');
                hideEditSupplierForm();
                loadSuppliers();
            } else {
                showStatus('suppliersStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        async function deleteSupplier(supplierId, supplierName) {
            if (!confirm(`Are you sure you want to delete supplier "${supplierName}"?\n\nThis cannot be undone!`)) {
                return;
            }
            
            const result = await apiCall('deleteSupplier', { supplierId });
            
            if (result && result.status === 'success') {
                showStatus('suppliersStatus', ' Supplier deleted successfully!', 'success');
                loadSuppliers();
            } else {
                showStatus('suppliersStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        // ==================== ITEMS ====================

        function showAddItemForm() {
            loadSuppliersList();
            document.getElementById('addItemForm').style.display = 'block';
        }

        function hideAddItemForm() {
            document.getElementById('addItemForm').style.display = 'none';
            document.querySelector('#addItemForm form').reset();
        }

        async function loadSuppliersList() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }

            const select = document.getElementById('newItemSupplier');
            select.innerHTML = '<option value="">Select Supplier</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }

        // Calculate unit cost in Add Item form
        function calculateUnitCost() {
            const packageCost = parseFloat(document.getElementById('newPackageCost').value) || 0;
            const unitsPerPackage = parseFloat(document.getElementById('newUnitsPerPackage').value) || 1;
            const unitCost = packageCost / unitsPerPackage;
            document.getElementById('calculatedUnitCost').value = '$' + unitCost.toFixed(2);
        }
        
        // Calculate unit cost in Edit Item form
        function calculateEditUnitCost() {
            const packageCost = parseFloat(document.getElementById('editPackageCost').value) || 0;
            const unitsPerPackage = parseFloat(document.getElementById('editUnitsPerPackage').value) || 1;
            const unitCost = packageCost / unitsPerPackage;
            document.getElementById('calculatedEditUnitCost').value = '$' + unitCost.toFixed(2);
        }
        
        async function addItem(e) {
            e.preventDefault();
            
            const data = {
                supplierId: document.getElementById('newItemSupplier').value,
                description: document.getElementById('newItemDescription').value,
                purchaseUOM: document.getElementById('newItemPurchaseUOM').value,
                unitsPerPackage: document.getElementById('newUnitsPerPackage').value,
                packageCost: document.getElementById('newPackageCost').value,
                unitSellPrice: document.getElementById('newUnitSellPrice').value,
                qtyOnHand: document.getElementById('newQtyOnHand').value,
                reorderPoint: document.getElementById('newReorderPoint').value,
                sku: document.getElementById('newItemSKU').value,
                notes: document.getElementById('newItemNotes').value
            };

            const result = await apiCall('addItem', data);
            
            if (result && result.status === 'success') {
                showStatus('itemsStatus', ' Item added successfully!', 'success');
                hideAddItemForm();
                loadItems();
            } else {
                showStatus('itemsStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        async function loadItems() {
            const itemsTable = document.getElementById('itemsTable');
            if (itemsTable) {
                itemsTable.innerHTML = '<div class="loading">Loading items...</div>';
            }
            
            // Ensure suppliers are loaded first so getSupplierName works
            if (cachedSuppliers.length === 0) {
                const suppResult = await apiCall('getSuppliers');
                if (suppResult && suppResult.status === 'success') {
                    cachedSuppliers = suppResult.data;
                }
            }
            
            const result = await apiCall('getItems');
            
            if (result && result.status === 'success') {
                cachedItems = result.data;
                
                // DEBUG: Log the first item to see what properties it actually has
                if (cachedItems.length > 0) {
                    console.log('=== ITEM DATA STRUCTURE DEBUG ===');
                    console.log('First item keys:', Object.keys(cachedItems[0]));
                    console.log('First item full data:', cachedItems[0]);
                    console.log('Unit_Sell_Price:', cachedItems[0].Unit_Sell_Price);
                    console.log('Sell_Price:', cachedItems[0].Sell_Price);
                    console.log('=================================');
                }
                
                // Apply active filter by default (show only active items)
                if (itemsTable) {
                    const activeFilter = document.getElementById('filterItemActive')?.value || 'active';
                    let itemsToDisplay = result.data;
                    if (activeFilter === 'active') {
                        itemsToDisplay = result.data.filter(item => item.Status !== 'Archived');
                    } else if (activeFilter === 'archived') {
                        itemsToDisplay = result.data.filter(item => item.Status === 'Archived');
                    }
                    
                    displayItems(itemsToDisplay);
                    loadItemFilterSuppliers();
                }
            } else {
                if (itemsTable) {
                    itemsTable.innerHTML = '<div class="loading">Error loading items</div>';
                }
            }
        }

        function displayItems(items) {
            if (!items || items.length === 0) {
                document.getElementById('itemsTable').innerHTML = '<p>No items yet. Add your first item!</p>';
                return;
            }

            // Calculate totals
            let totalQty = 0;
            
            let html = '<div class="table-scroll-wrapper"><table class="data-table" id="itemsDataTable"><thead><tr>';
            html += '<th>SKU</th><th>Description</th><th>Supplier</th><th>UOM</th><th>Units/Pkg</th><th>Pkg Cost</th><th>Unit Cost</th><th>Sell Price</th><th>Qty</th><th>On Order</th><th>Reorder</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            items.forEach(item => {
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const qtyOnOrder = parseFloat(item.Qty_On_Order) || 0;
                const unitsPerPkg = parseFloat(item.Units_Per_Package) || 1;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitCost = packageCost / unitsPerPkg;
                const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                const packages = (qty / unitsPerPkg).toFixed(1);
                const packagesOnOrder = (qtyOnOrder / unitsPerPkg).toFixed(1);
                const isArchived = item.Status === 'Archived';
                
                // Determine row styling based on stock status
                let rowBg = '';
                let qtyStyle = '';
                if (isArchived) {
                    rowBg = 'background:#f0f0f0; opacity: 0.7;';  // Grey for archived
                } else if (qty < 0) {
                    rowBg = 'background:#ffcdd2;';  // Red for negative
                    qtyStyle = 'color: #b71c1c; font-weight: bold;';
                } else if (qty <= reorderPoint) {
                    rowBg = 'background:#fff3cd;';  // Yellow for low stock
                }
                
                totalQty += qty;
                
                html += `<tr style="${rowBg} cursor: pointer;" onclick="editItemById('${item.Item_ID}')" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
                    <td><strong>${item.SKU || '-'}</strong>${isArchived ? ' <span style="background: #9e9e9e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">ARCHIVED</span>' : ''}</td>
                    <td>${item.Item_Description}</td>
                    <td>${getSupplierName(item.Supplier_ID)}</td>
                    <td>${item.Purchase_UOM}</td>
                    <td>${unitsPerPkg}</td>
                    <td>${formatMoney(packageCost)}</td>
                    <td>${formatMoney(unitCost)}</td>
                    <td style="color: #28a745; font-weight: bold;">${formatMoney(unitSellPrice)}</td>
                    <td style="${qtyStyle}">${formatNum(qty)}</td>
                    <td><span style="background: ${qtyOnOrder > 0 ? '#ffc107' : '#e0e0e0'}; padding: 3px 8px; border-radius: 4px; font-weight: bold;">${qtyOnOrder > 0 ? qtyOnOrder : '-'}</span></td>
                    <td>${item.Reorder_Point || 0}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="btn-delete-icon" onclick="toggleArchiveItem('${item.Item_ID}', '${item.Item_Description.replace(/'/g, "\\'")}', ${isArchived})" title="${isArchived ? 'Reactivate Item' : 'Archive Item'}">${isArchived ? '' : ''}</button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table></div>'; // Close table and scroll wrapper
            document.getElementById('itemsTable').innerHTML = html;
            setTimeout(() => makeSortable('itemsDataTable'), 0);
        }
        
        // Filter items
        async function filterItems() {
            const searchFilter = document.getElementById('filterItemSearch').value.toLowerCase().trim();
            const supplierFilter = document.getElementById('filterItemSupplier').value;
            const stockFilter = document.getElementById('filterItemStock').value;
            const activeFilter = document.getElementById('filterItemActive')?.value || 'active';
            
            // Ensure items are loaded
            if (cachedItems.length === 0) {
                await loadItems();
                return;
            }
            
            const filtered = cachedItems.filter(item => {
                const matchesSearch = !searchFilter || 
                    (item.SKU && item.SKU.toString().toLowerCase().includes(searchFilter)) ||
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(searchFilter));
                // Use matchesFilter for multi-select support
                const matchesSupplier = matchesFilter(item.Supplier_ID, supplierFilter);
                
                // Active/Archived status filter
                const isArchived = item.Status === 'Archived';
                let matchesActive = true;
                if (activeFilter === 'active') {
                    matchesActive = !isArchived;
                } else if (activeFilter === 'archived') {
                    matchesActive = isArchived;
                }
                
                // Stock status calculations
                const qtyOnHand = parseFloat(item.Qty_On_Hand) || 0;
                const qtyOnOrder = parseFloat(item.Qty_On_Order) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                const negativeStock = qtyOnHand < 0;
                const lowStock = qtyOnHand <= reorderPoint && qtyOnHand >= 0;
                const hasOnOrder = qtyOnOrder > 0;
                const needsReorder = (lowStock || negativeStock) && !hasOnOrder;
                
                let matchesStock = true;
                if (stockFilter === 'negative') {
                    matchesStock = negativeStock;
                } else if (stockFilter === 'low') {
                    matchesStock = lowStock || negativeStock;
                } else if (stockFilter === 'onorder') {
                    matchesStock = hasOnOrder;
                } else if (stockFilter === 'reorder') {
                    matchesStock = needsReorder;
                } else if (stockFilter === 'ok') {
                    matchesStock = qtyOnHand > reorderPoint;
                }
                
                return matchesSearch && matchesSupplier && matchesStock && matchesActive;
            });
            
            displayItems(filtered);
        }
        
        async function clearItemFilters() {
            document.getElementById('filterItemSearch').value = '';
            document.getElementById('filterItemSupplier').value = '';
            document.getElementById('filterItemStock').value = '';
            document.getElementById('filterItemActive').value = 'active';
            // Show only active items by default after clearing
            filterItems();
        }
        
        async function loadItemFilterSuppliers() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }
            
            const select = document.getElementById('filterItemSupplier');
            select.innerHTML = '<option value="">All Suppliers</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }
        
        // Helper function to edit by ID
        function editItemById(itemId) {
            const item = cachedItems.find(i => i.Item_ID === itemId);
            if (item) {
                editItem(item);
            }
        }
        
        // Edit item
        async function editItem(item) {
            // Hide add form first
            document.getElementById('addItemForm').style.display = 'none';
            
            // Load suppliers for dropdown
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }
            
            const select = document.getElementById('editItemSupplier');
            select.innerHTML = '<option value="">Select Supplier</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
            
            document.getElementById('editItemId').value = item.Item_ID;
            document.getElementById('editItemSupplier').value = item.Supplier_ID || '';
            document.getElementById('editItemDescription').value = item.Item_Description || '';
            document.getElementById('editItemSKU').value = item.SKU || '';
            const uomValue = item.Purchase_UOM || 'Case';
            document.getElementById('editItemPurchaseUOM').value = uomValue;
            document.getElementById('editItemPurchaseUOMDisplay').value = uomValue;
            document.getElementById('editUnitsPerPackage').value = item.Units_Per_Package || 1;
            document.getElementById('editPackageCost').value = item.Package_Cost || '';
            document.getElementById('editUnitSellPrice').value = item.Unit_Sell_Price || '';
            document.getElementById('editQtyOnHand').value = item.Qty_On_Hand || '';
            document.getElementById('editReorderPoint').value = item.Reorder_Point || '';
            document.getElementById('editItemStatus').value = item.Status || 'Active';
            document.getElementById('editItemNotes').value = item.Notes || '';
            
            // Calculate unit cost for display
            calculateEditUnitCost();
            
            document.getElementById('editItemForm').style.display = 'block';
            
            // Scroll to the edit form
            document.getElementById('editItemForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function goToAdjustInventory() {
            // Get the current item ID from the edit form
            const itemId = document.getElementById('editItemId').value;
            
            // Hide the edit form
            hideEditItemForm();
            
            // Switch to inventory tab
            switchTab('inventory');
            
            // Wait for tab to load, then pre-select the item
            setTimeout(() => {
                const itemSelect = document.getElementById('adjustItem');
                if (itemSelect && itemId) {
                    itemSelect.value = itemId;
                    // Trigger change event to load current quantity
                    itemSelect.dispatchEvent(new Event('change'));
                }
                
                // Scroll to the adjustment form
                const adjustForm = document.getElementById('inventory');
                if (adjustForm) {
                    adjustForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 300);
        }
        
        function hideEditItemForm() {
            document.getElementById('editItemForm').style.display = 'none';
            document.querySelector('#editItemForm form').reset();
            
            // Return to previous tab if we came from Reports
            if (returnToTab === 'reports') {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="reports"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('reports').classList.add('active');
                returnToTab = null;
            }
        }
        
        async function updateItem(e) {
            e.preventDefault();
            
            const data = {
                itemId: document.getElementById('editItemId').value,
                supplierId: document.getElementById('editItemSupplier').value,
                description: document.getElementById('editItemDescription').value,
                purchaseUOM: document.getElementById('editItemPurchaseUOM').value,
                unitsPerPackage: document.getElementById('editUnitsPerPackage').value,
                packageCost: document.getElementById('editPackageCost').value,
                unitSellPrice: document.getElementById('editUnitSellPrice').value,
                reorderPoint: document.getElementById('editReorderPoint').value,
                sku: document.getElementById('editItemSKU').value,
                status: document.getElementById('editItemStatus').value,
                notes: document.getElementById('editItemNotes').value
            };
            
            const result = await apiCall('updateItem', data);
            
            if (result && result.status === 'success') {
                showStatus('itemsStatus', ' Item updated successfully!', 'success');
                hideEditItemForm();
                loadItems();
            } else {
                showStatus('itemsStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        async function toggleArchiveItem(itemId, itemDesc, isCurrentlyArchived) {
            const action = isCurrentlyArchived ? 'reactivate' : 'archive';
            const actionLabel = isCurrentlyArchived ? 'Reactivate' : 'Archive';
            const confirmMsg = isCurrentlyArchived 
                ? `Reactivate item "${itemDesc}"?\n\nThis will make it available in dropdowns again.`
                : `Archive item "${itemDesc}"?\n\nThis will hide it from new PO/SO dropdowns but preserve all history.\n\nYou can reactivate it later if needed.`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            const newStatus = isCurrentlyArchived ? 'Active' : 'Archived';
            const result = await apiCall('updateItem', { 
                itemId: itemId,
                status: newStatus
            });
            
            if (result && result.status === 'success') {
                showStatus('itemsStatus', ` Item ${action}d successfully!`, 'success');
                loadItems();
            } else {
                showStatus('itemsStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        // ==================== CUSTOMERS ====================

        function showAddCustomerForm() {
            document.getElementById('addCustomerForm').style.display = 'block';
        }

        function hideAddCustomerForm() {
            document.getElementById('addCustomerForm').style.display = 'none';
            document.querySelector('#addCustomerForm form').reset();
        }

        async function addCustomer(e) {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('newCustomerName').value,
                contactName: document.getElementById('newCustomerContact').value,
                phone: document.getElementById('newCustomerPhone').value,
                mobile: document.getElementById('newCustomerMobile').value,
                email: document.getElementById('newCustomerEmail').value,
                address: document.getElementById('newCustomerAddress').value,
                city: document.getElementById('newCustomerCity').value,
                state: document.getElementById('newCustomerState').value,
                zip: document.getElementById('newCustomerZip').value,
                creditLimit: document.getElementById('newCreditLimit').value,
                paymentTerms: document.getElementById('newCustomerPaymentTerms').value,
                notes: document.getElementById('newCustomerNotes').value
            };

            const result = await apiCall('addCustomer', data);
            
            if (result && result.status === 'success') {
                showStatus('customersStatus', ' Customer added successfully!', 'success');
                hideAddCustomerForm();
                loadCustomers();
            } else {
                showStatus('customersStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        async function loadCustomers() {
            document.getElementById('customersTable').innerHTML = '<div class="loading">Loading customers...</div>';
            
            const result = await apiCall('getCustomers');
            
            if (result && result.status === 'success') {
                cachedCustomers = result.data;
                displayCustomers(result.data);
            } else {
                document.getElementById('customersTable').innerHTML = '<div class="loading">Error loading customers</div>';
            }
        }

        function displayCustomers(customers) {
            if (!customers || customers.length === 0) {
                document.getElementById('customersTable').innerHTML = '<p>No customers yet. Add your first customer!</p>';
                return;
            }

            let html = '<table class="data-table" id="customersDataTable"><thead><tr>';
            html += '<th>Name</th><th>Contact</th><th>Phone</th><th>Email</th><th>City</th><th>Credit Limit</th>';
            html += '</tr></thead><tbody>';

            customers.forEach(c => {
                html += `<tr style="cursor: pointer;" onclick='editCustomer(${JSON.stringify(c).replace(/'/g, "&#39;")})' onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                    <td><strong>${c.Customer_Name}</strong></td>
                    <td>${c.Contact_Name || '-'}</td>
                    <td>${c.Phone || '-'}</td>
                    <td>${c.Email || '-'}</td>
                    <td>${c.City || '-'}, ${c.State || '-'}</td>
                    <td>${formatMoney(parseFloat(c.Credit_Limit || 0))}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('customersTable').innerHTML = html;
            setTimeout(() => makeSortable('customersDataTable'), 0);
        }
        
        // Filter customers
        function filterCustomers() {
            const nameFilter = document.getElementById('filterCustomerName').value.toLowerCase();
            const contactFilter = document.getElementById('filterCustomerContact').value.toLowerCase();
            const cityFilter = document.getElementById('filterCustomerCity').value.toLowerCase();
            const stateFilter = document.getElementById('filterCustomerState').value.toLowerCase();
            
            const filtered = cachedCustomers.filter(c => {
                const matchesName = !nameFilter || (c.Customer_Name && c.Customer_Name.toLowerCase().includes(nameFilter));
                const matchesContact = !contactFilter || (c.Contact_Name && c.Contact_Name.toLowerCase().includes(contactFilter));
                const matchesCity = !cityFilter || (c.City && c.City.toLowerCase().includes(cityFilter));
                const matchesState = !stateFilter || (c.State && c.State.toLowerCase().includes(stateFilter));
                return matchesName && matchesContact && matchesCity && matchesState;
            });
            
            displayCustomers(filtered);
        }
        
        function clearCustomerFilters() {
            document.getElementById('filterCustomerName').value = '';
            document.getElementById('filterCustomerContact').value = '';
            document.getElementById('filterCustomerCity').value = '';
            document.getElementById('filterCustomerState').value = '';
            displayCustomers(cachedCustomers);
        }
        
        // Edit customer
        function editCustomer(customer) {
            document.getElementById('editCustomerId').value = customer.Customer_ID;
            document.getElementById('editCustomerName').value = customer.Customer_Name || '';
            document.getElementById('editCustomerContact').value = customer.Contact_Name || '';
            document.getElementById('editCustomerPhone').value = customer.Phone || '';
            document.getElementById('editCustomerMobile').value = customer.Mobile || '';
            document.getElementById('editCustomerEmail').value = customer.Email || '';
            document.getElementById('editCustomerAddress').value = customer.Address || '';
            document.getElementById('editCustomerCity').value = customer.City || '';
            document.getElementById('editCustomerState').value = customer.State || '';
            document.getElementById('editCustomerZip').value = customer.ZIP || '';
            document.getElementById('editCreditLimit').value = customer.Credit_Limit || '';
            document.getElementById('editCustomerPaymentTerms').value = customer.Payment_Terms || 'Net 30';
            document.getElementById('editCustomerNotes').value = customer.Notes || '';
            
            document.getElementById('editCustomerForm').style.display = 'block';
            document.getElementById('addCustomerForm').style.display = 'none';
        }
        
        function hideEditCustomerForm() {
            document.getElementById('editCustomerForm').style.display = 'none';
            document.querySelector('#editCustomerForm form').reset();
            
            // Return to previous tab if we came from Reports
            if (returnToTab === 'reports') {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="reports"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('reports').classList.add('active');
                returnToTab = null;
            }
        }
        
        async function updateCustomer(e) {
            e.preventDefault();
            
            const data = {
                customerId: document.getElementById('editCustomerId').value,
                name: document.getElementById('editCustomerName').value,
                address: document.getElementById('editCustomerAddress').value,
                city: document.getElementById('editCustomerCity').value,
                state: document.getElementById('editCustomerState').value,
                zip: document.getElementById('editCustomerZip').value,
                contactName: document.getElementById('editCustomerContact').value,
                phone: document.getElementById('editCustomerPhone').value,
                mobile: document.getElementById('editCustomerMobile').value,
                email: document.getElementById('editCustomerEmail').value,
                creditLimit: document.getElementById('editCreditLimit').value,
                paymentTerms: document.getElementById('editCustomerPaymentTerms').value,
                notes: document.getElementById('editCustomerNotes').value
            };
            
            const result = await apiCall('updateCustomer', data);
            
            if (result && result.status === 'success') {
                showStatus('customersStatus', ' Customer updated successfully!', 'success');
                hideEditCustomerForm();
                loadCustomers();
            } else {
                showStatus('customersStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        async function deleteCustomer(customerId, customerName) {
            if (!confirm(`Are you sure you want to delete customer "${customerName}"?\n\nThis cannot be undone!`)) {
                return;
            }
            
            const result = await apiCall('deleteCustomer', { customerId });
            
            if (result && result.status === 'success') {
                showStatus('customersStatus', ' Customer deleted successfully!', 'success');
                loadCustomers();
            } else {
                showStatus('customersStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        // ==================== PURCHASES ====================

        function showAddPurchaseForm() {
            loadPurchaseDropdowns();
            document.getElementById('addPurchaseForm').style.display = 'block';
        }

        function hideAddPurchaseForm() {
            document.getElementById('addPurchaseForm').style.display = 'none';
            document.querySelector('#addPurchaseForm form').reset();
        }

        async function loadPurchaseDropdowns() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }

            const select = document.getElementById('poSupplier');
            select.innerHTML = '<option value="">Select Supplier</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }

        async function loadSupplierItems() {
            const supplierId = document.getElementById('poSupplier').value;
            
            if (cachedItems.length === 0) {
                const result = await apiCall('getItems');
                if (result && result.status === 'success') {
                    cachedItems = result.data;
                }
            }

            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
            
            document.querySelectorAll('.po-item').forEach(select => {
                select.innerHTML = '<option value="">Select Item</option>';
                supplierItems.forEach(item => {
                    const packageCost = parseFloat(item.Package_Cost) || 0;
                    const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                    select.innerHTML += `<option value="${item.Item_ID}" data-cost="${packageCost.toFixed(2)}" data-units="${unitsPerPackage}">${item.Item_Description}</option>`;
                });
            });
        }

        function addPOLineItem() {
            const container = document.getElementById('poLineItems');
            const supplierId = document.getElementById('poSupplier').value;
            
            if (!supplierId) {
                alert('Please select a supplier first');
                return;
            }
            
            // Get supplier items once
            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
            
            const newRow = document.createElement('div');
            newRow.className = 'line-item-row';
            newRow.innerHTML = `
                <select class="po-item" required>
                    <option value="">Select Item</option>
                    ${supplierItems.map(item => `<option value="${item.Item_ID}" data-units="${item.Units_Per_Package}" data-cost="${item.Package_Cost}" data-uom="${item.Purchase_UOM}">${item.Item_Description}</option>`).join('')}
                </select>
                <input type="number" class="po-qty" placeholder="# of Packages" min="1" required>
                <input type="number" class="po-cost" placeholder="Cost per Package" step="0.01" min="0" required>
                <button type="button" class="remove-btn"></button>
            `;
            container.appendChild(newRow);
            
            // Attach event listeners programmatically (CSP-safe)
            const itemSelect = newRow.querySelector('.po-item');
            const qtyInput = newRow.querySelector('.po-qty');
            const costInput = newRow.querySelector('.po-cost');
            const removeBtn = newRow.querySelector('.remove-btn');
            
            itemSelect.addEventListener('change', function() {
                updatePOItemInfo(this);
            });
            
            qtyInput.addEventListener('input', function() {
                calculatePOTotal();
            });
            
            costInput.addEventListener('input', function() {
                calculatePOTotal();
            });
            
            removeBtn.addEventListener('click', function() {
                removeLineItem(this);
                calculatePOTotal();
            });
        }
        
        function updatePOItemInfo(selectElement) {
            const option = selectElement.options[selectElement.selectedIndex];
            const cost = option.getAttribute('data-cost');
            
            const row = selectElement.parentElement;
            const costInput = row.querySelector('.po-cost');
            
            if (cost) {
                costInput.value = cost;
            }
            
            calculatePOTotal();
        }
        
        function calculatePOTotal() {
            let total = 0;
            document.querySelectorAll('#poLineItems .line-item-row').forEach(row => {
                const qty = parseInt(row.querySelector('.po-qty')?.value) || 0;
                const cost = parseFloat(row.querySelector('.po-cost')?.value) || 0;
                total += qty * cost;
            });
            const totalField = document.getElementById('poTotal');
            if (totalField) {
                totalField.value = total.toFixed(2);
            }
        }
        
        function calculatePOLine(qtyInput) {
            const row = qtyInput.parentElement;
            const selectElement = row.querySelector('.po-item');
            const option = selectElement.options[selectElement.selectedIndex];
            const units = parseFloat(option.getAttribute('data-units')) || 1;
            const qty = parseFloat(qtyInput.value) || 0;
            const infoSpan = row.querySelector('.po-info');
            const totalUnits = qty * units;
            const uom = option.getAttribute('data-uom');
            
            infoSpan.textContent = `(${units} units/${uom} = ${totalUnits} total units)`;
        }

        function removeLineItem(btn) {
            btn.parentElement.remove();
        }

        async function addPurchase(e) {
            e.preventDefault();
            
            const lineItems = [];
            let calculatedTotal = 0;
            
            document.querySelectorAll('#poLineItems .line-item-row').forEach(row => {
                const itemId = row.querySelector('.po-item').value;
                const qty = parseInt(row.querySelector('.po-qty').value) || 0;
                const cost = parseFloat(row.querySelector('.po-cost').value) || 0;
                const lineTotal = qty * cost;
                
                // Only add valid line items (has item selected, qty > 0)
                if (itemId && qty > 0) {
                    lineItems.push({
                        itemId: itemId,
                        quantity: qty,
                        unitCost: cost
                    });
                    calculatedTotal += lineTotal;
                }
            });

            // Validate at least one line item
            if (lineItems.length === 0) {
                alert(' Please add at least one item to the purchase order.\n\nSelect an item and enter a quantity before saving.');
                return;
            }

            // ===== VALIDATION #0: Check Required Fields =====
            const poStatus = document.getElementById('poStatus').value;
            const poDueDate = document.getElementById('poDueDate').value;
            
            if (!poStatus) {
                showStatus('purchasesStatus', ' Please select a Status', 'error');
                document.getElementById('poStatus').focus();
                return;
            }
            
            if (!poDueDate) {
                showStatus('purchasesStatus', ' Please select an Expected Delivery Date', 'error');
                document.getElementById('poDueDate').focus();
                return;
            }

            // ===== VALIDATION #1: Check for Duplicate Items =====
            const itemCounts = {};
            lineItems.forEach(line => {
                itemCounts[line.itemId] = (itemCounts[line.itemId] || 0) + 1;
            });
            
            const duplicates = Object.entries(itemCounts).filter(([id, count]) => count > 1);
            if (duplicates.length > 0) {
                // Find item names for the warning message
                const duplicateNames = duplicates.map(([itemId]) => {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    return item ? item.Item_Description : itemId;
                }).join(', ');
                
                const continueWithDupes = confirm(
                    ' DUPLICATE ITEMS DETECTED\n\n' +
                    'The following items appear on multiple lines:\n' +
                    duplicateNames + '\n\n' +
                    'This may be intentional (different costs), but could also be a mistake.\n\n' +
                    ' Click OK to continue saving\n' +
                    ' Click Cancel to review the order'
                );
                
                if (!continueWithDupes) return;
            }
            
            // ===== VALIDATION #2: Check for Overpayment =====
            const amountPaid = parseFloat(document.getElementById('poAmountPaid').value) || 0;
            if (amountPaid > calculatedTotal + 0.01) { // Allow 1 cent rounding
                const overpayment = amountPaid - calculatedTotal;
                const continueWithOverpay = confirm(
                    ' OVERPAYMENT WARNING\n\n' +
                    `Order Total: ${formatMoney(calculatedTotal)}\n` +
                    `Amount Paid: ${formatMoney(amountPaid)}\n` +
                    `Overpayment: ${formatMoney(overpayment)}\n\n` +
                    'You are entering MORE payment than the order total.\n\n' +
                    ' Click OK to continue (will show overpaid)\n' +
                    ' Click Cancel to correct the amount'
                );
                
                if (!continueWithOverpay) return;
            }

            // Get the selected date and add current time
            const selectedPODate = document.getElementById('poDate').value;
            const nowPO = new Date();
            const poDateWithTime = selectedPODate === getTodayLocalDate() 
                ? nowPO.toISOString()  // Today - use actual current time
                : `${selectedPODate}T${nowPO.toTimeString().split(' ')[0]}`; // Other date - add current time

            const data = {
                supplierId: document.getElementById('poSupplier').value,
                invoiceNumber: document.getElementById('poInvoiceNumber').value,
                poDate: poDateWithTime,
                dueDate: document.getElementById('poDueDate').value || null,
                paymentTerms: document.getElementById('poPaymentTerms').value,
                totalAmount: calculatedTotal,
                amountPaid: parseFloat(document.getElementById('poAmountPaid').value) || 0,
                status: document.getElementById('poStatus').value,
                notes: document.getElementById('poNotes').value,
                lineItems: lineItems,
                poType: 'INCOMING'
            };

            const result = await apiCall('createPurchaseOrder', data);
            
            if (result && result.status === 'success') {
                showStatus('purchasesStatus', ' Purchase order created! Inventory updated.', 'success');
                hideAddPurchaseForm();
                loadPurchases();
            } else {
                showStatus('purchasesStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }

        let purchasesData = []; // Cache for filtering
        
        async function loadPurchases() {
            const purchasesTable = document.getElementById('purchasesTable');
            if (purchasesTable) {
                purchasesTable.innerHTML = '<div class="loading">Loading purchases...</div>';
            }
            
            // Load suppliers FIRST if not cached
            if (cachedSuppliers.length === 0) {
                const suppResult = await apiCall('getSuppliers');
                if (suppResult && suppResult.status === 'success') {
                    cachedSuppliers = suppResult.data;
                } else {
                    console.error('Failed to load suppliers:', suppResult);
                }
            }
            
            // Now load and display purchases
            console.log('Calling getPurchaseOrders...');
            const result = await apiCall('getPurchaseOrders');
            console.log('getPurchaseOrders result:', result);
            
            if (result && result.status === 'success') {
                purchasesData = result.data;
                if (purchasesTable) {
                    displayPurchases(result.data);
                    loadPurchaseFilterSuppliers(); // Populate filter dropdown
                }
            } else {
                console.error('getPurchaseOrders failed:', result);
                const errorMsg = result?.message || 'Unknown error - check console';
                if (purchasesTable) {
                    purchasesTable.innerHTML = `<div class="loading">Error loading purchases: ${errorMsg}</div>`;
                }
            }
        }
        
        async function loadPurchaseFilterSuppliers() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }
            
            const select = document.getElementById('filterPurchaseSupplier');
            select.innerHTML = '<option value="">All Suppliers</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }
        
        function filterPurchases() {
            const poFilter = document.getElementById('filterPurchasePO').value.toLowerCase();
            const supplierFilter = document.getElementById('filterPurchaseSupplier').value;
            const statusFilter = document.getElementById('filterPurchaseStatus').value;
            const dateFrom = document.getElementById('filterPurchaseDateFrom').value;
            const dateTo = document.getElementById('filterPurchaseDateTo').value;
            const paymentStatusFilter = document.getElementById('filterPurchasePaymentStatus').value;
            
            const filtered = purchasesData.filter(po => {
                const matchesPO = !poFilter || 
                    (po.PO_ID && po.PO_ID.toLowerCase().includes(poFilter)) ||
                    (po.Invoice_Number && po.Invoice_Number.toLowerCase().includes(poFilter));
                // Use matchesFilter for multi-select support
                const matchesSupplier = matchesFilter(po.Supplier_ID, supplierFilter);
                
                // Handle exclude-voided option
                let matchesStatus = true;
                if (statusFilter === 'exclude-voided') {
                    matchesStatus = po.Status !== 'Voided';
                } else if (statusFilter) {
                    matchesStatus = po.Status === statusFilter;
                }
                
                const poDate = new Date(po.PO_Date);
                
                // Date FROM comparison (start of day) - use global parseLocalDate helper
                let matchesDateFrom = true;
                if (dateFrom) {
                    const fromDateObj = parseLocalDate(dateFrom);
                    fromDateObj.setHours(0, 0, 0, 0);
                    matchesDateFrom = poDate >= fromDateObj;
                }
                
                // Date TO comparison (end of day - 23:59:59)
                let matchesDateTo = true;
                if (dateTo) {
                    const toDateObj = parseLocalDate(dateTo);
                    toDateObj.setHours(23, 59, 59, 999);
                    matchesDateTo = poDate <= toDateObj;
                }
                
                const matchesPaymentStatus = !paymentStatusFilter || (po.Payment_Status === paymentStatusFilter);
                return matchesPO && matchesSupplier && matchesStatus && matchesDateFrom && matchesDateTo && matchesPaymentStatus;
            });
            
            displayPurchases(filtered);
        }
        
        function clearPurchaseFilters() {
            document.getElementById('filterPurchasePO').value = '';
            document.getElementById('filterPurchaseSupplier').value = '';
            document.getElementById('filterPurchaseStatus').value = '';
            document.getElementById('filterPurchaseDateFrom').value = '';
            document.getElementById('filterPurchaseDateTo').value = '';
            document.getElementById('filterPurchasePaymentStatus').value = '';
            displayPurchases(purchasesData);
        }
        
        function applyPurchasesDateFilter(period, evt) {
            console.log('Purchase date filter clicked:', period);
            
            const now = new Date();
            let fromDate = null;
            let toDate = null;
            
            switch(period) {
                case 'today':
                    fromDate = new Date(now);
                    toDate = new Date(now);
                    break;
                case 'week':
                    fromDate = new Date(now);
                    fromDate.setDate(now.getDate() - 7);
                    break;
                case '3months':
                    fromDate = new Date(now);
                    fromDate.setMonth(now.getMonth() - 3);
                    break;
                case '6months':
                    fromDate = new Date(now);
                    fromDate.setMonth(now.getMonth() - 6);
                    break;
                case '9months':
                    fromDate = new Date(now);
                    fromDate.setMonth(now.getMonth() - 9);
                    break;
                case 'ytd':
                    fromDate = new Date(now.getFullYear(), 0, 1);
                    break;
                case '1year':
                    fromDate = new Date(now);
                    fromDate.setFullYear(now.getFullYear() - 1);
                    break;
                case '3years':
                    fromDate = new Date(now);
                    fromDate.setFullYear(now.getFullYear() - 3);
                    break;
                case '5years':
                    fromDate = new Date(now);
                    fromDate.setFullYear(now.getFullYear() - 5);
                    break;
                case 'all':
                    document.getElementById('filterPurchaseDateFrom').value = '';
                    document.getElementById('filterPurchaseDateTo').value = '';
                    filterPurchases();
                    
                    if (evt) {
                        document.querySelectorAll('.oval-filter-btn-po').forEach(btn => {
                            btn.style.opacity = '0.6';
                            btn.style.transform = 'scale(1)';
                        });
                        evt.target.style.opacity = '1';
                        evt.target.style.transform = 'scale(1.05)';
                    }
                    return;
            }
            
            const fromDateStr = fromDate ? formatLocalDate(fromDate) : '';
            const toDateStr = toDate ? formatLocalDate(toDate) : '';
            
            document.getElementById('filterPurchaseDateFrom').value = fromDateStr;
            document.getElementById('filterPurchaseDateTo').value = toDateStr;
            
            filterPurchases();
            
            if (evt) {
                document.querySelectorAll('.oval-filter-btn-po').forEach(btn => {
                    btn.style.opacity = '0.6';
                    btn.style.transform = 'scale(1)';
                });
                evt.target.style.opacity = '1';
                evt.target.style.transform = 'scale(1.05)';
            }
        }

        function displayPurchases(orders) {
            if (!orders || orders.length === 0) {
                document.getElementById('purchasesTable').innerHTML = '<p>No purchase orders yet. Record your first purchase!</p>';
                return;
            }

            // Calculate totals first
            let totalAmount = 0;
            let totalPaid = 0;
            
            orders.forEach(po => {
                totalAmount += parseFloat(po.Total_Amount || po.Invoice_Total) || 0;
                totalPaid += parseFloat(po.Amount_Paid) || 0;
            });
            const balance = totalAmount - totalPaid;
            
            // Date filter buttons (matching Sales page style)
            let html = `
                <div class="purchases-data-card">
                    <!-- Oval Buttons - Date filters -->
                    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 20px;">
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; padding-bottom: 10px;">
                            <button onclick="applyPurchasesDateFilter('today', event)" class="oval-filter-btn-po" style="background: #e3f2fd; color: #1565c0; border: 3px solid #1565c0; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 Last Day
                            </button>
                            <button onclick="applyPurchasesDateFilter('week', event)" class="oval-filter-btn-po" style="background: #fff3e0; color: #ef6c00; border: 3px solid #ef6c00; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 Last Week
                            </button>
                            <button onclick="applyPurchasesDateFilter('3months', event)" class="oval-filter-btn-po" style="background: #fff9c4; color: #f57f17; border: 3px solid #f57f17; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 Last 3 Months
                            </button>
                            <button onclick="applyPurchasesDateFilter('6months', event)" class="oval-filter-btn-po" style="background: #e8f5e9; color: #2e7d32; border: 3px solid #2e7d32; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 6 Months
                            </button>
                            <button onclick="applyPurchasesDateFilter('9months', event)" class="oval-filter-btn-po" style="background: #e1f5fe; color: #0277bd; border: 3px solid #0277bd; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 9 Months
                            </button>
                            <button onclick="applyPurchasesDateFilter('ytd', event)" class="oval-filter-btn-po" style="background: #f3e5f5; color: #6a1b9a; border: 3px solid #6a1b9a; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 YTD
                            </button>
                            <button onclick="applyPurchasesDateFilter('1year', event)" class="oval-filter-btn-po" style="background: #fce4ec; color: #c2185b; border: 3px solid #c2185b; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 1 Year
                            </button>
                            <button onclick="applyPurchasesDateFilter('3years', event)" class="oval-filter-btn-po" style="background: #ede7f6; color: #512da8; border: 3px solid #512da8; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 3 Years
                            </button>
                            <button onclick="applyPurchasesDateFilter('5years', event)" class="oval-filter-btn-po" style="background: #e0f2f1; color: #00695c; border: 3px solid #00695c; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 5 Years
                            </button>
                            <button onclick="applyPurchasesDateFilter('all', event)" class="oval-filter-btn-po active" style="background: #424242; color: white; border: 3px solid #424242; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 All Time
                            </button>
                        </div>
                    </div>
            `;
            
            // Summary boxes
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #f57c00;">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Total Purchases</div>
                        <div style="font-size: 28px; font-weight: bold; color: #f57c00;">$${totalAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 12px; color: #888;">${orders.length} orders</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #388e3c;">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Paid</div>
                        <div style="font-size: 28px; font-weight: bold; color: #388e3c;">$${totalPaid.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 12px; color: #888;">${((totalPaid/totalAmount)*100 || 0).toFixed(0)}% paid</div>
                    </div>
                    <div style="background: linear-gradient(135deg, ${balance > 0 ? '#ffebee, #ffcdd2' : '#e8f5e9, #c8e6c9'}); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid ${balance > 0 ? '#c62828' : '#388e3c'};">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Outstanding</div>
                        <div style="font-size: 28px; font-weight: bold; color: ${balance > 0 ? '#c62828' : '#388e3c'};">$${balance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 12px; color: #888;">${balance > 0 ? 'to pay' : 'all paid!'}</div>
                    </div>
                </div>
            </div>
            `;
            
            html += '<div class="table-scroll-wrapper"><table class="data-table" id="purchasesDataTable"><thead><tr>';
            html += '<th>Invoice #</th><th>Supplier</th><th>Date</th><th>Status</th><th>Total</th><th>Paid</th><th>Due Date</th><th>Payment</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            orders.forEach(po => {
                const dueDate = formatDateSafe(po.Due_Date);
                const amountPaid = parseFloat(po.Amount_Paid) || 0;
                const total = parseFloat(po.Total_Amount || po.Invoice_Total) || 0;
                const poDateObj = parseDate(po.PO_Date);
                const sortableDate = poDateObj ? poDateObj.toISOString().split('T')[0] : '';
                const dueDateObj = parseDate(po.Due_Date);
                const sortableDueDate = dueDateObj ? dueDateObj.toISOString().split('T')[0] : '';
                
                // Calculate payment status from actual amounts (not stored status)
                let paymentBadge = '';
                if (amountPaid >= total - 0.01 && total > 0) {
                    paymentBadge = '<span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Paid</span>';
                } else if (amountPaid > 0) {
                    paymentBadge = '<span style="background: #ffc107; color: black; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Partial</span>';
                } else {
                    paymentBadge = '<span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Unpaid</span>';
                }
                
                html += `<tr style="cursor: pointer;" onclick="viewPurchaseOrder('${po.PO_ID}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                    <td><strong>${po.Invoice_Number || po.PO_ID}</strong></td>
                    <td>${getSupplierName(po.Supplier_ID)}</td>
                    <td data-sort="${sortableDate}">${formatDateSafe(po.PO_Date)}</td>
                    <td><span style="background: ${po.Status === 'Ordered' ? '#ffc107' : po.Status === 'In Transit' ? '#17a2b8' : po.Status === 'Void' || po.Status === 'Cancelled' || po.Status === 'Voided' ? '#dc3545' : po.Status === 'Partial' ? '#fd7e14' : '#28a745'}; color: ${po.Status === 'Ordered' ? 'black' : 'white'}; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${po.Status === 'Void' || po.Status === 'Voided' ? ' VOID' : po.Status === 'Cancelled' ? ' CANCELLED' : po.Status === 'Ordered' ? ' Ordered' : po.Status === 'In Transit' ? ' In Transit' : po.Status === 'Partial' ? ' Partial' : po.Status === 'Received' ? ' Received' : po.Status || 'Received'}</span></td>
                    <td>${formatMoney(total)}</td>
                    <td>${formatMoney(amountPaid)}</td>
                    <td data-sort="${sortableDueDate}">${dueDate}</td>
                    <td>${paymentBadge}</td>
                    <td onclick="event.stopPropagation();">
                        ${po.Status === 'Ordered' || po.Status === 'Partial' || po.Status === 'In Transit' ? `<button class="btn-small" onclick="receiveOutgoingPO('${po.PO_ID}')" style="background: #28a745; color: white;"> Receive</button>` : ''}
                        ${po.Status === 'Void' || po.Status === 'Cancelled' || po.Status === 'Voided' ? `<button class="btn-small" onclick="duplicatePO('${po.PO_ID}')" style="background: #17a2b8; color: white;"> Copy to New PO</button>` : ''}
                    </td>
                </tr>`;
            });

            html += '</tbody></table></div>'; // Close table and scroll wrapper
            document.getElementById('purchasesTable').innerHTML = html;
            setTimeout(() => makeSortable('purchasesDataTable'), 0);
        }
        
        // Edit Purchase Order
        let currentEditingOrder = null;
        let currentEditingType = null; // 'purchase' or 'sales'
        let returnToTab = null; // Track which tab to return to after closing modal
        
        // View Purchase Order (from row click or button)
        function viewPurchaseOrder(poId) {
            const po = purchasesData.find(p => p.PO_ID === poId);
            if (po) {
                showPurchaseOrderDetails(po);
            }
        }
        
        async function editPurchaseOrder(poId) {
            // Find the PO in cached data or fetch it
            const result = await apiCall('getPurchaseOrders');
            if (result && result.status === 'success') {
                const po = result.data.find(p => p.PO_ID === poId);
                if (po) {
                    showPurchaseOrderDetails(po);
                }
            }
        }
        
        async function showPurchaseOrderDetails(po) {
            currentEditingOrder = po;
            currentEditingType = 'purchase';
            
            // Load items if not cached
            if (cachedItems.length === 0) {
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
            }
            
            // Get line items
            const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
            const lines = linesResult?.data || [];
            
            const supplierName = getSupplierName(po.Supplier_ID);
            const dueDate = po.Due_Date ? new Date(po.Due_Date).toLocaleDateString() : '-';
            const receiveDate = po.Receive_Date ? new Date(po.Receive_Date).toLocaleDateString() : '-';
            
            // Status color logic
            const statusColor = po.Status === 'Void' || po.Status === 'Cancelled' || po.Status === 'Voided' ? '#dc3545' : 
                               po.Status === 'Ordered' ? '#ffc107' : 
                               po.Status === 'In Transit' ? '#17a2b8' :
                               po.Status === 'Partial' ? '#fd7e14' : '#28a745';
            const statusTextColor = po.Status === 'Ordered' ? '#000' : '#fff';
            const statusText = po.Status === 'Void' || po.Status === 'Voided' ? ' VOID' : 
                              po.Status === 'Cancelled' ? ' CANCELLED' : 
                              po.Status === 'Ordered' ? ' Ordered' :
                              po.Status === 'In Transit' ? ' In Transit' :
                              po.Status === 'Partial' ? ' Partial' :
                              po.Status === 'Received' ? ' Received' : po.Status;
            
            document.getElementById('modalTitle').textContent = `Purchase Order: ${po.PO_ID}`;
            
            let html = `
                <!-- Card 1: Order & Payment Information -->
                <div class="content-card" style="margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3 style="margin-top: 0; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 8px;"> Order Information</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 8px 0; font-weight: bold; width: 140px;">Supplier:</td><td>${supplierName}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Invoice #:</td><td>${po.Invoice_Number || '-'}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">PO Date:</td><td>${new Date(po.PO_Date).toLocaleDateString()}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Receive Date:</td><td>${receiveDate}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Due Date:</td><td>${dueDate}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Status:</td><td><span style="background: ${statusColor}; color: ${statusTextColor}; padding: 4px 12px; border-radius: 12px; font-size: 12px; border: 2px solid ${statusColor === '#28a745' ? '#c3e6cb' : '#dee2e6'};">${statusText}</span></td></tr>
                            </table>
                            ${po.Status === 'Ordered' || po.Status === 'In Transit' ? `
                            <div class="content-card" style="margin-top: 15px; background: #fff3cd;">
                                <strong> Need to Cancel?</strong>
                                <p style="margin: 5px 0 10px 0; font-size: 13px; color: #666;">If this order needs to be cancelled or prices have changed, void this PO.</p>
                                <button class="btn" onclick="voidPurchaseOrder('${po.PO_ID}')" style="background: #dc3545; padding: 6px 12px; font-size: 13px;">
                                     Void This PO
                                </button>
                            </div>
                            ` : ''}
                            ${po.Status === 'Void' || po.Status === 'Cancelled' || po.Status === 'Voided' ? `
                            <div class="content-card" style="margin-top: 15px; background: #e3f2fd;">
                                <strong> Need to Reorder?</strong>
                                <p style="margin: 5px 0 10px 0; font-size: 13px; color: #666;">Copy this PO's items to create a new order with current prices.</p>
                                <button class="btn" onclick="duplicatePO('${po.PO_ID}'); closeModal();" style="background: #17a2b8; padding: 6px 12px; font-size: 13px;">
                                     Copy to New PO
                                </button>
                            </div>
                            ` : ''}
                        </div>
                        <div>
                            <h3 style="margin-top: 0; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 8px;"> Payment Information</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 8px 0; font-weight: bold; width: 140px;">Total Amount:</td><td style="font-size: 18px; color: #2c3e50;">${formatMoney(parseFloat(po.Total_Amount || 0))}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Amount Paid:</td><td style="color: #27ae60;">${formatMoney(parseFloat(po.Amount_Paid || 0))}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Balance Due:</td><td style="color: #e74c3c; font-size: 16px; font-weight: bold;">$${(() => {
                                    const balance = parseFloat(po.Total_Amount || 0) - parseFloat(po.Amount_Paid || 0);
                                    return (Math.abs(balance) < 0.01 ? 0 : balance).toFixed(2);
                                })()}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Payment Status:</td><td><span style="background: ${po.Payment_Status === 'Paid' ? '#d4edda' : '#fff3cd'}; color: ${po.Payment_Status === 'Paid' ? '#155724' : '#856404'}; padding: 4px 12px; border-radius: 12px; font-size: 12px; border: 2px solid ${po.Payment_Status === 'Paid' ? '#c3e6cb' : '#ffeaa7'};">${po.Payment_Status}</span></td></tr>
                            </table>
                            ${po.Payment_Status !== 'Paid' && po.Status !== 'Void' && po.Status !== 'Cancelled' && po.Status !== 'Voided' ? `
                            <div class="content-card" style="margin-top: 15px; background: #e8f5e9;">
                                <div style="margin-bottom: 10px;"><strong> Quick Payment</strong></div>
                                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                    <input type="number" id="quickPaymentAmount" step="0.01" min="0" 
                                           value="${(() => {
                                               const balance = parseFloat(po.Total_Amount || 0) - parseFloat(po.Amount_Paid || 0);
                                               return (Math.abs(balance) < 0.01 ? 0 : balance).toFixed(2);
                                           })()}"
                                           style="width: 120px; padding: 8px; border: 2px solid #c3e6cb; border-radius: 4px;">
                                    <input type="date" id="quickPaymentDate" value="${getTodayLocalDate()}" 
                                           style="padding: 8px; border: 2px solid #c3e6cb; border-radius: 4px;">
                                    <button class="btn" onclick="if(event && debounceButton(event.currentTarget)) recordQuickPOPayment('${po.PO_ID}')" 
                                            style="background: #28a745; padding: 8px 15px;">
                                         Record Payment
                                    </button>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            if (lines.length > 0) {
                // Calculate receiving progress
                let totalOrdered = 0;
                let totalReceived = 0;
                lines.forEach(line => {
                    totalOrdered += parseFloat(line.Quantity) || 0;
                    totalReceived += parseFloat(line.Qty_Received) || 0;
                });
                const receivingProgress = totalOrdered > 0 ? Math.round((totalReceived / totalOrdered) * 100) : 0;
                const canReceive = po.Status === 'Ordered' || po.Status === 'Partial' || po.Status === 'In Transit';
                
                html += `
                    <!-- Card 2: Line Items -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
                            <h3 style="color: #667eea; margin: 0; font-size: 18px;"> Line Items</h3>
                            ${canReceive ? `
                            <button class="btn" onclick="receiveOutgoingPO('${po.PO_ID}')" style="background: #28a745; padding: 8px 16px;">
                                 Receive Items
                            </button>
                            ` : ''}
                        </div>
                        
                        ${totalReceived > 0 || po.Status === 'Partial' || po.Status === 'Received' ? `
                        <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #2196f3;">
                            <strong> Receiving Progress:</strong> ${totalReceived} of ${totalOrdered} items received (${receivingProgress}%)
                            <div style="background: #ddd; border-radius: 4px; height: 8px; margin-top: 8px; overflow: hidden;">
                                <div style="background: ${receivingProgress >= 100 ? '#28a745' : '#2196f3'}; height: 100%; width: ${Math.min(receivingProgress, 100)}%;"></div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="overflow-x: auto;">
                        <table class="data-table" style="margin-bottom: 0; font-size: 14px;">
                            <thead>
                                <tr style="background: #667eea; color: white;">
                                    <th style="padding: 12px 15px;">Item</th>
                                    <th style="padding: 12px 15px;">Description</th>
                                    <th style="padding: 12px 15px; text-align: center;">Ordered</th>
                                    <th style="padding: 12px 15px; text-align: center;">Received</th>
                                    <th style="padding: 12px 15px; text-align: center;">Status</th>
                                    <th style="padding: 12px 15px; text-align: right;">Unit Cost</th>
                                    <th style="padding: 12px 15px; text-align: right;">Line Total</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                lines.forEach(line => {
                    const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                    const lineTotal = (parseFloat(line.Quantity) || 0) * (parseFloat(line.Unit_Cost) || 0);
                    const qtyOrdered = parseFloat(line.Quantity) || 0;
                    const qtyReceived = parseFloat(line.Qty_Received) || 0;
                    
                    // Line status
                    let lineStatus, lineStatusBg;
                    if (qtyReceived >= qtyOrdered) {
                        lineStatus = ' Complete';
                        lineStatusBg = '#d4edda';
                    } else if (qtyReceived > 0) {
                        lineStatus = ' Partial';
                        lineStatusBg = '#fff3cd';
                    } else {
                        lineStatus = ' Pending';
                        lineStatusBg = '#f8f9fa';
                    }
                    
                    html += `
                        <tr style="border-bottom: 1px solid #eee; background: ${lineStatusBg};">
                            <td style="padding: 12px 15px;"><strong>${item?.SKU || line.Item_ID}</strong></td>
                            <td style="padding: 12px 15px;">${item ? item.Item_Description : '-'}</td>
                            <td style="padding: 12px 15px; text-align: center; font-weight: bold;">${qtyOrdered}</td>
                            <td style="padding: 12px 15px; text-align: center; font-weight: bold; color: ${qtyReceived > 0 ? '#28a745' : '#999'};">${qtyReceived > 0 ? qtyReceived : '-'}</td>
                            <td style="padding: 12px 15px; text-align: center; font-size: 12px;">${lineStatus}</td>
                            <td style="padding: 12px 15px; text-align: right;">${formatMoney(parseFloat(line.Unit_Cost || 0))}</td>
                            <td style="padding: 12px 15px; text-align: right; font-weight: bold;">${formatMoney(lineTotal)}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                    </div>
                    </div>
                `;
            }
            
            if (po.Notes) {
                html += `
                    <!-- Card 3: Notes -->
                    <div class="content-card">
                        <h3 style="color: var(--primary, #667eea); margin-top: 0; margin-bottom: 10px; border-bottom: 2px solid #667eea; padding-bottom: 8px;"> Notes</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #e0e0e0;">
                            ${po.Notes}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalEditBtn').style.display = 'inline-block';
            document.getElementById('modalPrintBtn').style.display = 'inline-block';
            document.getElementById('modalPrintBtn').textContent = ' Print PO';
            document.getElementById('modalPrintBtn').onclick = () => printPurchaseOrder();
            document.getElementById('modalSaveBtn').style.display = 'none';
            document.getElementById('orderModal').style.display = 'block'; document.body.classList.add('modal-open');
        }
        
        async function recordQuickPOPayment(poId) {
            const paymentInput = document.getElementById('quickPaymentAmount');
            const paymentDateInput = document.getElementById('quickPaymentDate');
            const paymentAmount = parseFloat(paymentInput.value) || 0;
            const paymentDate = paymentDateInput?.value || getTodayLocalDate();
            
            if (paymentAmount <= 0) {
                alert('Please enter a payment amount greater than 0');
                return;
            }
            
            // Get current amount paid from the editing order
            const currentPaid = parseFloat(currentEditingOrder?.Amount_Paid) || 0;
            const newTotalPaid = currentPaid + paymentAmount;
            
            const result = await apiCall('recordPurchasePayment', {
                poId: poId,
                amountPaid: newTotalPaid,
                paymentDate: paymentDate
            });
            
            if (result && result.status === 'success') {
                const total = parseFloat(currentEditingOrder?.Total_Amount) || 0;
                const payStatus = newTotalPaid >= total - 0.01 ? 'Paid' : (newTotalPaid > 0 ? 'Partial' : 'Unpaid');
                alert(` Payment recorded!\n\nTotal Paid: ${formatMoney(newTotalPaid)}\nStatus: ${payStatus}`);
                document.getElementById('orderModal').style.display = 'none'; document.body.classList.remove('modal-open');
                loadPurchases();
            } else {
                alert(' Error: ' + (result?.message || 'Unknown error'));
            }
        }
        
        // PRINT PURCHASE ORDER FUNCTION
        async function printPurchaseOrder() {
            if (!currentEditingOrder || currentEditingType !== 'purchase') {
                alert('Please select a purchase order first');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('Please allow popups for this site');
                return;
            }
            printWindow.document.write('<html><body><h2>Loading PO...</h2></body></html>');
            
            const po = currentEditingOrder;
            const settings = getInvoiceSettings();
            
            // Get supplier details
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === po.Supplier_ID);
            
            // Get line items
            const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
            const lines = linesResult?.data || [];
            
            // Calculate totals
            let subtotal = 0;
            lines.forEach(line => {
                subtotal += (parseFloat(line.Quantity) || 0) * (parseFloat(line.Unit_Cost) || 0);
            });
            
            const total = parseFloat(po.Total_Amount || subtotal);
            const paid = parseFloat(po.Amount_Paid || 0);
            const balance = total - paid;
            
            // Get theme colors for print
            const themeColors = getThemeColors();
            
            let poHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Purchase Order ${po.Invoice_Number || po.PO_ID}</title>
    <style>
        @media print {
            @page { margin: 0.5in; }
            body { margin: 0; }
            .no-print { display: none; }
        }
        body {
            font-family: Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.4;
            max-width: 8in;
            margin: 0 auto;
            padding: 0.5in;
        }
        .po-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid ${themeColors.primary};
            padding-bottom: 20px;
        }
        .po-header h1 {
            color: ${themeColors.text};
            margin: 0 0 10px 0;
            font-size: 28pt;
        }
        .po-number {
            font-size: 14pt;
            font-weight: bold;
            margin: 5px 0;
        }
        .po-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .info-box {
            width: 45%;
        }
        .info-box h3 {
            color: ${themeColors.text};
            border-bottom: 2px solid ${themeColors.primary};
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .info-box p {
            margin: 5px 0;
        }
        table.items {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        table.items th {
            background: ${themeColors.primary};
            color: white;
            padding: 12px 10px;
            text-align: left;
        }
        table.items td {
            border: 1px solid #ddd;
            padding: 10px;
        }
        .totals {
            margin-top: 30px;
            float: right;
            width: 40%;
        }
        .totals table { width: 100%; }
        .totals td { padding: 8px 10px; border-bottom: 1px solid #eee; }
        .totals .label { text-align: right; font-weight: bold; }
        .totals .value { text-align: right; width: 40%; }
        .total-line { border-top: 2px solid ${themeColors.primary} !important; font-size: 14pt; font-weight: bold; }
        .footer {
            clear: both;
            margin-top: 60px;
            padding-top: 20px;
            border-top: 2px solid ${themeColors.primary};
            text-align: center;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="po-header">
        <h1>${settings.companyName}</h1>
        <p>${settings.address1}</p>
        ${settings.address2 ? `<p>${settings.address2}</p>` : ''}
        <p>${settings.cityStateZip}</p>
        <p>Phone: ${settings.phone} | Email: ${settings.email}</p>
    </div>

    <div class="po-number">PURCHASE ORDER: ${po.Invoice_Number || po.PO_ID}</div>
    <p><strong>PO Date:</strong> ${new Date(po.PO_Date).toLocaleDateString()} | <strong>Status:</strong> ${po.Status || 'Received'}</p>

    <div class="po-info">
        <div class="info-box">
            <h3>Supplier:</h3>
            <p><strong>${supplier?.Supplier_Name || 'Unknown Supplier'}</strong></p>
            ${supplier?.Contact_Name ? `<p>Attn: ${supplier.Contact_Name}</p>` : ''}
            ${supplier?.Address ? `<p>${supplier.Address}</p>` : ''}
            ${supplier?.City || supplier?.State ? `<p>${supplier.City || ''}, ${supplier.State || ''} ${supplier.ZIP || ''}</p>` : ''}
            ${supplier?.Phone ? `<p>Phone: ${supplier.Phone}</p>` : ''}
        </div>
        <div class="info-box">
            <h3>Payment Info:</h3>
            <p><strong>Terms:</strong> ${supplier?.Payment_Terms || 'Net 30'}</p>
            <p><strong>Due Date:</strong> ${po.Due_Date ? new Date(po.Due_Date).toLocaleDateString() : '-'}</p>
            <p><strong>Status:</strong> ${po.Payment_Status || 'Unpaid'}</p>
        </div>
    </div>

    <table class="items">
        <thead>
            <tr>
                <th style="width: 10%;">QTY</th>
                <th style="width: 50%;">DESCRIPTION</th>
                <th style="width: 20%; text-align: right;">UNIT COST</th>
                <th style="width: 20%; text-align: right;">AMOUNT</th>
            </tr>
        </thead>
        <tbody>`;
            
            lines.forEach(line => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                const lineTotal = (parseFloat(line.Quantity) || 0) * (parseFloat(line.Unit_Cost) || 0);
                
                poHTML += `
            <tr>
                <td style="text-align: center;">${line.Quantity}</td>
                <td>${item?.Item_Description || line.Item_ID}</td>
                <td style="text-align: right;">${formatMoney(parseFloat(line.Unit_Cost || 0))}</td>
                <td style="text-align: right;">${formatMoney(lineTotal)}</td>
            </tr>`;
            });
            
            poHTML += `
        </tbody>
    </table>

    <div class="totals">
        <table>
            <tr>
                <td class="label">SUBTOTAL:</td>
                <td class="value">${formatMoney(subtotal)}</td>
            </tr>
            <tr class="total-line">
                <td class="label">TOTAL:</td>
                <td class="value">${formatMoney(total)}</td>
            </tr>
            ${paid > 0 ? `
            <tr>
                <td class="label">PAID:</td>
                <td class="value">${formatMoney(paid)}</td>
            </tr>` : ''}
            ${balance > 0 ? `
            <tr>
                <td class="label" style="color: #c62828;">BALANCE DUE:</td>
                <td class="value" style="color: #c62828; font-weight: bold;">${formatMoney(balance)}</td>
            </tr>` : ''}
        </table>
    </div>

    <div class="footer">
        ${po.Notes ? `<p><strong>Notes:</strong> ${po.Notes}</p>` : ''}
    </div>

    <div class="no-print" style="position: fixed; top: 20px; right: 20px;">
        <button onclick="window.print()" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: ${themeColors.primary}; color: white; border: none; border-radius: 5px; margin-right: 10px;"> Print</button>
        <button onclick="window.close()" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: var(--primary, #667eea); color: white; border: none; border-left: 4px solid rgba(255,255,255,0.4); border-radius: 5px;"> Close</button>
    </div>

</body>
</html>`;
            
            printWindow.document.open();
            printWindow.document.write(poHTML);
            printWindow.document.close();
        }
        
        // PRINT INVOICE FUNCTION
        async function printInvoice() {
            if (!currentEditingOrder || currentEditingType !== 'sales') {
                alert('Please select a sales order first');
                return;
            }
            
            // CRITICAL: Open window BEFORE any async calls to avoid iPhone popup blocker
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('Please allow popups for this site');
                return;
            }
            printWindow.document.write('<html><body><h2>Loading invoice...</h2></body></html>');
            
            const so = currentEditingOrder;
            const settings = getInvoiceSettings();
            
            // Get customer details
            const customersResult = await apiCall('getCustomers');
            const customer = customersResult.data.find(c => c.Customer_ID === so.Customer_ID);
            
            // Get line items
            const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
            const lines = linesResult?.data || [];
            
            // Calculate totals
            let subtotal = 0;
            lines.forEach(line => {
                subtotal += parseFloat(line.Line_Total || 0);
            });
            
            const total = parseFloat(so.Total_Amount || 0);
            const paid = parseFloat(so.Amount_Paid || 0);
            const balance = total - paid;
            
            // Get theme colors for print
            const themeColors = getThemeColors();
            
            // Build invoice HTML with PO-style layout
            let invoiceHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice ${so.Invoice_Number || so.SO_ID}</title>
    <style>
        @media print {
            @page { margin: 0.5in; }
            body { margin: 0; }
            .no-print { display: none; }
        }
        /* Mobile responsive styles for invoice */
        @media screen and (max-width: 600px) {
            body {
                padding: 10px !important;
                font-size: 10pt !important;
            }
            .invoice-header h1 {
                font-size: 20pt !important;
            }
            .invoice-info {
                flex-direction: column !important;
            }
            .info-box {
                margin-bottom: 15px !important;
                width: 100% !important;
            }
            .info-box p {
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
            }
            table.items th, table.items td {
                padding: 6px 4px !important;
                font-size: 9pt !important;
            }
            table.items .desc { 
                word-wrap: break-word !important;
                max-width: 120px !important;
            }
            .totals {
                width: 60% !important;
            }
            .signature-line {
                flex: 0 0 150px !important;
            }
        }
        body {
            font-family: Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.4;
            max-width: 8in;
            margin: 0 auto;
            padding: 0.5in;
        }
        .invoice-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid ${themeColors.primary};
            padding-bottom: 20px;
        }
        .invoice-header h1 {
            color: ${themeColors.text};
            margin: 0 0 10px 0;
            font-size: 28pt;
        }
        .invoice-number {
            font-size: 14pt;
            font-weight: bold;
            margin: 5px 0;
        }
        .invoice-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .info-box {
            flex: 1;
        }
        .info-box h3 {
            margin: 0 0 10px 0;
            color: ${themeColors.text};
        }
        .info-box p {
            margin: 2px 0;
        }
        table.items {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        table.items th {
            background: ${themeColors.primary};
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        table.items td {
            border: 1px solid #ddd;
            padding: 10px;
        }
        table.items .qty { text-align: center; width: 10%; }
        table.items .desc { width: 50%; }
        table.items .price { text-align: right; width: 20%; }
        table.items .amount { text-align: right; width: 20%; }
        .totals {
            margin-top: 30px;
            float: right;
            width: 40%;
        }
        .totals table {
            width: 100%;
        }
        .totals td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
        }
        .totals .label {
            text-align: right;
            font-weight: bold;
        }
        .totals .value {
            text-align: right;
            width: 40%;
        }
        .total-line {
            border-top: 2px solid ${themeColors.primary} !important;
            border-bottom: 3px double ${themeColors.primary} !important;
            font-size: 14pt;
            font-weight: bold;
        }
        .footer {
            clear: both;
            margin-top: 60px;
            padding-top: 20px;
            border-top: 2px solid ${themeColors.primary};
            text-align: center;
            font-style: italic;
            color: #666;
        }
        .signature {
            margin-top: 40px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        .signature-label {
            white-space: nowrap;
        }
        .signature-line {
            flex: 0 0 250px;
            border-bottom: 1px solid #000;
            height: 20px;
        }
    </style>
</head>
<body>

    <div class="invoice-header">
        <h1>SALES INVOICE</h1>
        <p style="font-size: 16pt; margin: 5px 0;">${settings.companyName}</p>
        <div class="invoice-number">#${so.Invoice_Number || so.SO_ID}</div>
        <p>Date: ${so.Sale_Date ? new Date(so.Sale_Date).toLocaleDateString() : new Date(so.SO_Date).toLocaleDateString()}</p>
    </div>

    <div class="invoice-info">
        <div class="info-box">
            <h3>From:</h3>
            <p><strong>${settings.companyName}</strong></p>
            ${settings.contactName ? `<p>${settings.contactName}</p>` : ''}
            <p>${settings.address1}</p>
            ${settings.address2 ? `<p>${settings.address2}</p>` : ''}
            <p>${settings.cityStateZip}</p>
            <p>Phone: ${settings.phone}</p>
            <p>Email: ${settings.email}</p>
        </div>
        <div class="info-box">
            <h3>Bill To:</h3>
            <p><strong>${customer?.Customer_Name || 'Unknown Customer'}</strong></p>
            ${customer?.Contact_Name ? `<p>Attn: ${customer.Contact_Name}</p>` : ''}
            ${customer?.Address ? `<p>${customer.Address}</p>` : ''}
            ${customer?.City || customer?.State || customer?.ZIP ? `<p>${customer.City || ''}${customer.City && customer.State ? ', ' : ''}${customer.State || ''} ${customer.ZIP || ''}</p>` : ''}
            ${customer?.Phone ? `<p>Phone: ${customer.Phone}</p>` : ''}
        </div>
    </div>

    <table class="items">
        <thead>
            <tr>
                <th class="qty">QTY</th>
                <th class="desc">DESCRIPTION</th>
                <th class="price">PRICE</th>
                <th class="amount">AMOUNT</th>
            </tr>
        </thead>
        <tbody>`;
            
            // Add line items
            lines.forEach(line => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                const lineTotal = parseFloat(line.Line_Total || 0);
                
                invoiceHTML += `
            <tr>
                <td class="qty">${line.Quantity}</td>
                <td class="desc">${item?.Item_Description || line.Item_ID}</td>
                <td class="price">${formatMoney(parseFloat(line.Unit_Price || 0))}</td>
                <td class="amount">${formatMoney(lineTotal)}</td>
            </tr>`;
            });
            
            invoiceHTML += `
        </tbody>
    </table>

    <div class="totals">
        <table>
            <tr>
                <td class="label">SUBTOTAL:</td>
                <td class="value">${formatMoney(subtotal)}</td>
            </tr>
            <tr class="total-line">
                <td class="label">TOTAL:</td>
                <td class="value">${formatMoney(total)}</td>
            </tr>
            ${paid > 0 ? `
            <tr>
                <td class="label">PAID:</td>
                <td class="value">${formatMoney(paid)}</td>
            </tr>` : ''}
            ${balance > 0 ? `
            <tr style="background: #fff3cd;">
                <td class="label">BALANCE DUE:</td>
                <td class="value" style="color: #e74c3c; font-weight: bold;">${formatMoney(balance)}</td>
            </tr>` : ''}
        </table>
    </div>

    <div class="footer">
        Thank you for doing Business with ${settings.companyName}
    </div>

    <div class="signature">
        <span class="signature-label">Signature:</span>
        <div class="signature-line"></div>
    </div>

    <p style="clear: both; text-align: center; margin-top: 40px; font-size: 9pt; color: #999;">
        KEEP THIS SLIP FOR REFERENCE
    </p>

    <div class="no-print" style="position: fixed; top: 20px; right: 20px;">
        <button onclick="window.print()" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: ${themeColors.primary}; color: white; border: none; border-radius: 5px; margin-right: 10px;"> Print</button>
        <button onclick="window.close()" style="padding: 12px 24px; font-size: 14pt; cursor: pointer; background: var(--primary, #667eea); color: white; border: none; border-left: 4px solid rgba(255,255,255,0.4); border-radius: 5px;"> Close</button>
    </div>

</body>
</html>`;
            
            // Clear the loading message and write the final invoice
            printWindow.document.open();
            printWindow.document.write(invoiceHTML);
            printWindow.document.close();
        }
        
        // ==================== MODAL SIZE PERSISTENCE ====================
        // Save and restore modal sizes from localStorage
        
        function saveModalSize(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                const size = {
                    width: modal.offsetWidth,
                    height: modal.offsetHeight
                };
                localStorage.setItem('modalSize_' + modalId, JSON.stringify(size));
            }
        }
        
        function restoreModalSize(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                try {
                    const saved = localStorage.getItem('modalSize_' + modalId);
                    if (saved) {
                        const size = JSON.parse(saved);
                        if (size.width && size.height) {
                            modal.style.width = size.width + 'px';
                            modal.style.height = size.height + 'px';
                            modal.style.maxWidth = 'none'; // Override max-width to allow custom size
                        }
                    }
                } catch (e) {
                    console.log('Error restoring modal size:', e);
                }
            }
        }
        
        // Set up resize observers for modals
        document.addEventListener('DOMContentLoaded', function() {
            // Order Modal size observer
            const orderModalInner = document.getElementById('orderModalInner');
            if (orderModalInner) {
                let resizeTimeout;
                new ResizeObserver(() => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        if (document.getElementById('orderModal').style.display !== 'none') {
                            saveModalSize('orderModalInner');
                        }
                    }, 200);
                }).observe(orderModalInner);
            }
            
            // Report Setup Modal size observer
            const reportModalInner = document.getElementById('reportSetupModalInner');
            if (reportModalInner) {
                let resizeTimeout;
                new ResizeObserver(() => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        if (document.getElementById('reportSetupModal').style.display !== 'none') {
                            saveModalSize('reportSetupModalInner');
                        }
                    }, 200);
                }).observe(reportModalInner);
            }
            
            // Watch for modal open events to restore size
            const orderModal = document.getElementById('orderModal');
            if (orderModal) {
                new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === 'style' && orderModal.style.display === 'block') {
                            restoreModalSize('orderModalInner');
                        }
                    });
                }).observe(orderModal, { attributes: true, attributeFilter: ['style'] });
            }
            
            const reportModal = document.getElementById('reportSetupModal');
            if (reportModal) {
                new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === 'style' && 
                            (reportModal.style.display === 'block' || reportModal.style.display === 'flex')) {
                            restoreModalSize('reportSetupModalInner');
                        }
                    });
                }).observe(reportModal, { attributes: true, attributeFilter: ['style'] });
            }
        });
        
        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
            currentEditingOrder = null;
            currentEditingType = null;
            
            // Only remove modal-open if no other modals are open
            const reportModal = document.getElementById('reportSetupModal');
            if (!reportModal || reportModal.style.display === 'none') {
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
            }
            
            // Return to previous tab if we came from Reports
            if (returnToTab === 'reports') {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="reports"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('reports').classList.add('active');
                returnToTab = null;
            }
        }
        
        function enableEditMode() {
            if (currentEditingType === 'purchase') {
                enablePurchaseOrderEdit();
            } else if (currentEditingType === 'sales') {
                enableSalesOrderEdit();
            }
        }
        
        async function enablePurchaseOrderEdit() {
            const po = currentEditingOrder;
            
            // Load items and suppliers if not cached
            if (cachedItems.length === 0) {
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
            }
            if (cachedSuppliers.length === 0) {
                const suppResult = await apiCall('getSuppliers');
                if (suppResult && suppResult.status === 'success') {
                    cachedSuppliers = suppResult.data;
                }
            }
            
            // Get line items
            const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
            const lines = linesResult?.data || [];
            
            const supplierName = getSupplierName(po.Supplier_ID);
            
            document.getElementById('modalTitle').textContent = `Edit Purchase Order: ${po.PO_ID}`;
            
            // Build supplier dropdown
            let supplierOptions = '<option value="">Select Supplier</option>';
            cachedSuppliers.forEach(s => {
                supplierOptions += `<option value="${s.Supplier_ID}" ${s.Supplier_ID === po.Supplier_ID ? 'selected' : ''}>${s.Supplier_Name}</option>`;
            });
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Order Information</h3>
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="editPOSupplier" required>${supplierOptions}</select>
                        </div>
                        <div class="form-group">
                            <label>Invoice Number</label>
                            <input type="text" id="editPOInvoiceNumber" value="${po.Invoice_Number || ''}">
                        </div>
                        <div class="form-group">
                            <label>PO Date</label>
                            <input type="date" id="editPODate" value="${po.PO_Date ? new Date(po.PO_Date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="editPODueDate" value="${po.Due_Date ? new Date(po.Due_Date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="editPOStatus">
                                <option value="Ordered" ${po.Status === 'Ordered' ? 'selected' : ''}> Ordered - Sent to supplier</option>
                                <option value="In Transit" ${po.Status === 'In Transit' ? 'selected' : ''}> In Transit - Shipped, on the way</option>
                                <option value="Partial" ${po.Status === 'Partial' ? 'selected' : ''}> Partial - Some items received</option>
                                <option value="Received" ${po.Status === 'Received' ? 'selected' : ''}> Received - All items received</option>
                                <option value="Voided" ${po.Status === 'Voided' || po.Status === 'Void' || po.Status === 'Cancelled' ? 'selected' : ''}> Voided - Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Payment Information</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="margin-bottom: 10px;">
                                <strong>Current Total:</strong> ${formatMoney(parseFloat(po.Total_Amount || 0))}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Previously Paid:</strong> ${formatMoney(parseFloat(po.Amount_Paid || 0))}
                            </div>
                            <div>
                                <strong>Balance Due:</strong> <span style="color: #e74c3c;">$${(() => {
                                    const balance = parseFloat(po.Total_Amount || 0) - parseFloat(po.Amount_Paid || 0);
                                    return (Math.abs(balance) < 0.01 ? 0 : balance).toFixed(2);
                                })()}</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label> Amount Paid</label>
                            <div style="position: relative; display: flex; align-items: center;">
                                <span style="position: absolute; left: 12px; font-size: 16px; font-weight: bold; color: #666;">$</span>
                                <input type="number" id="editPOAmountPaid" step="0.01" min="0" placeholder="0.00" value="${parseFloat(po.Amount_Paid || 0).toFixed(2)}" style="padding-left: 28px; font-size: 16px; font-weight: 600;">
                            </div>
                            <small style="color: #666;"> Enter numbers only (e.g., 115.46 for $115.46)</small>
                        </div>
                        <div style="color: #666; font-size: 13px; background: #fff3cd; padding: 10px; border-radius: 6px;">
                             Total will recalculate based on line items below
                        </div>
                    </div>
                </div>
                
                <h3 style="color: #667eea; margin-bottom: 15px;">Line Items</h3>
                <div id="editPOLineItems">
            `;
            
            // Add existing line items as editable rows
            lines.forEach((line, index) => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                html += createEditableLineItem('PO', line, index, item);
            });
            
            html += `
                </div>
                <button type="button" class="btn btn-secondary" onclick="addEditLineItem('PO')" style="margin-top: 10px;">+ Add Line Item</button>
                
                <div class="form-group" style="margin-top: 30px;">
                    <label>Notes</label>
                    <textarea id="editPONotes" rows="3" style="width: 100%;">${po.Notes || ''}</textarea>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            
            // Attach event listeners to all PO line items in the edit modal
            console.log('Attaching listeners to PO edit modal line items'); // DEBUG
            document.querySelectorAll('#editPOLineItems .edit-line-item').forEach(row => {
                attachEditLineItemListeners(row);
            });
            
            document.getElementById('modalEditBtn').style.display = 'none';
            document.getElementById('modalSaveBtn').style.display = 'inline-block';
        }
        
        function createEditableLineItem(type, line, index, item) {
            // Make sure items are loaded
            if (cachedItems.length === 0) {
                console.error('cachedItems is empty!');
            }
            
            const itemOptions = cachedItems
                .filter(i => type === 'PO' ? i.Supplier_ID === currentEditingOrder.Supplier_ID : true)
                .map(i => {
                    const priceAttr = type === 'PO' ? `data-cost="${i.Package_Cost}"` : `data-price="${i.Unit_Sell_Price}"`;
                    return `<option value="${i.Item_ID}" ${priceAttr} ${i.Item_ID === line.Item_ID ? 'selected' : ''}>${i.Item_Description}</option>`;
                })
                .join('');
            
            console.log('Items for dropdown:', cachedItems.length, 'Filtered:', itemOptions.length);
            
            const qtyField = type === 'PO' ? 'Quantity' : 'Quantity';
            const priceField = type === 'PO' ? 'Unit_Cost' : 'Unit_Price';
            const originalQty = parseFloat(line[qtyField]) || 0;
            const originalPrice = parseFloat(line[priceField]) || 0;
            
            return `
                <div class="edit-line-item" data-type="${type}" data-original-item="${line.Item_ID}" data-original-qty="${originalQty}" data-line-id="${line.Line_ID || ''}" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 50px; gap: 10px; margin-bottom: 10px; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <select class="edit-item" required>
                        <option value="">Select Item</option>
                        ${itemOptions}
                    </select>
                    <input type="number" class="edit-qty" placeholder="Qty" min="1" required value="${originalQty}">
                    <input type="number" class="edit-price" placeholder="${type === 'PO' ? 'Cost' : 'Price'}" step="0.01" min="0" required value="${originalPrice}">
                    <input type="text" class="edit-total" readonly style="background: #e9ecef; font-weight: bold;" value="${formatMoney(originalQty * originalPrice)}">
                    <button type="button" class="remove-btn" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px; cursor: pointer;"></button>
                </div>
            `;
        }
        
        function calculateEditLineTotal(input) {
            const row = input.closest('.edit-line-item');
            const qty = parseFloat(row.querySelector('.edit-qty').value) || 0;
            const price = parseFloat(row.querySelector('.edit-price').value) || 0;
            const total = qty * price;
            row.querySelector('.edit-total').value = '$' + total.toFixed(2);
            
            // Update payment info if this is a sales order
            if (row.getAttribute('data-type') === 'SO') {
                updateEditPaymentInfo();
            }
        }
        
        function updateEditPaymentInfo() {
            // Calculate new total from all line items
            let newTotal = 0;
            document.querySelectorAll('#editSOLineItems .edit-line-item').forEach(row => {
                const qty = parseFloat(row.querySelector('.edit-qty').value) || 0;
                const price = parseFloat(row.querySelector('.edit-price').value) || 0;
                newTotal += qty * price;
            });
            
            // Get previously paid amount
            const previouslyPaid = parseFloat(document.getElementById('editSOAmountPaid')?.value) || 0;
            
            // Calculate balance due and fix rounding errors
            let balanceDue = newTotal - previouslyPaid;
            if (Math.abs(balanceDue) < 0.01) balanceDue = 0;
            
            // Update the display fields using IDs
            const currentTotalDiv = document.getElementById('editSOCurrentTotal');
            const balanceDueDiv = document.getElementById('editSOBalanceDue');
            
            if (currentTotalDiv) {
                currentTotalDiv.innerHTML = `<strong>Current Total:</strong> ${formatMoney(newTotal)}`;
            }
            
            if (balanceDueDiv) {
                balanceDueDiv.innerHTML = `<strong>Balance Due:</strong> <span style="color: #e74c3c;">${formatMoney(balanceDue)}</span>`;
            }
        }
        
        function attachEditLineItemListeners(row) {
            const type = row.getAttribute('data-type');
            const itemSelect = row.querySelector('.edit-item');
            const qtyInput = row.querySelector('.edit-qty');
            const priceInput = row.querySelector('.edit-price');
            const removeBtn = row.querySelector('.remove-btn');
            
            console.log('Attaching edit modal listeners, type:', type); // DEBUG
            
            // Auto-fill price when item selected
            itemSelect.addEventListener('change', function() {
                console.log('Edit modal item changed!'); // DEBUG
                const option = this.options[this.selectedIndex];
                const priceAttr = type === 'PO' ? 'data-cost' : 'data-price';
                const price = option.getAttribute(priceAttr);
                console.log('Price from data attribute:', price); // DEBUG
                
                if (price) {
                    priceInput.value = price;
                    calculateEditLineTotal(qtyInput);
                }
            });
            
            // Recalculate when qty or price changes
            qtyInput.addEventListener('input', function() {
                calculateEditLineTotal(this);
            });
            
            priceInput.addEventListener('input', function() {
                calculateEditLineTotal(this);
            });
            
            // Remove button
            removeBtn.addEventListener('click', function() {
                if (confirm('Remove this line item?')) {
                    row.remove();
                    // Update payment info if this is a sales order
                    if (type === 'SO') {
                        updateEditPaymentInfo();
                    }
                }
            });
            
            console.log('Edit modal listeners attached!'); // DEBUG
        }
        
        function addEditLineItem(type) {
            const container = document.getElementById(type === 'PO' ? 'editPOLineItems' : 'editSOLineItems');
            const newLine = {
                Item_ID: '',
                Quantity: 0,
                [type === 'PO' ? 'Unit_Cost' : 'Unit_Price']: 0
            };
            const newItem = createEditableLineItem(type, newLine, -1, null);
            container.insertAdjacentHTML('beforeend', newItem);
            
            // Attach listeners to the newly added item
            const newRow = container.lastElementChild;
            attachEditLineItemListeners(newRow);
        }
        
        function removeEditLineItem(btn) {
            if (confirm('Remove this line item?')) {
                btn.closest('.edit-line-item').remove();
            }
        }
        
        async function saveOrderChanges() {
            if (currentEditingType === 'purchase') {
                await savePurchaseOrderChanges();
            } else if (currentEditingType === 'sales') {
                await saveSalesOrderChanges();
            }
        }
        
        async function savePurchaseOrderChanges() {
            const po = currentEditingOrder;
            
            // Collect line items
            const newLines = [];
            let totalAmount = 0;
            
            document.querySelectorAll('#editPOLineItems .edit-line-item').forEach(row => {
                const itemId = row.querySelector('.edit-item').value;
                const qty = parseInt(row.querySelector('.edit-qty').value) || 0;
                const cost = parseFloat(row.querySelector('.edit-price').value) || 0;
                
                if (itemId && qty > 0) {
                    newLines.push({
                        itemId: itemId,
                        quantity: qty,
                        unitCost: cost,
                        originalItem: row.dataset.originalItem,
                        originalQty: parseInt(row.dataset.originalQty) || 0,
                        lineId: row.dataset.lineId
                    });
                    totalAmount += qty * cost;
                }
            });
            
            console.log('Total lines collected:', newLines.length);
            
            if (newLines.length === 0) {
                const rowCount = document.querySelectorAll('#editPOLineItems .edit-line-item').length;
                alert(`No valid line items found!\n\nRows found: ${rowCount}\n\nPlease make sure each line has:\n- An item selected\n- A quantity > 0`);
                return;
            }
            
            // ===== VALIDATION #1: Check for Duplicate Items =====
            const itemCounts = {};
            newLines.forEach(line => {
                itemCounts[line.itemId] = (itemCounts[line.itemId] || 0) + 1;
            });
            
            const duplicates = Object.entries(itemCounts).filter(([id, count]) => count > 1);
            if (duplicates.length > 0) {
                // Find item names for the warning message
                const duplicateNames = duplicates.map(([itemId]) => {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    return item ? item.Item_Description : itemId;
                }).join(', ');
                
                const continueWithDupes = confirm(
                    ' DUPLICATE ITEMS DETECTED\n\n' +
                    'The following items appear on multiple lines:\n' +
                    duplicateNames + '\n\n' +
                    'This may be intentional (different costs), but could also be a mistake.\n\n' +
                    ' Click OK to continue saving\n' +
                    ' Click Cancel to review the order'
                );
                
                if (!continueWithDupes) return;
            }
            
            // ===== VALIDATION #2: Check for Overpayment =====
            const amountPaid = parseFloat(document.getElementById('editPOAmountPaid').value) || 0;
            if (amountPaid > totalAmount + 0.01) { // Allow 1 cent rounding
                const overpayment = amountPaid - totalAmount;
                const continueWithOverpay = confirm(
                    ' OVERPAYMENT WARNING\n\n' +
                    `Order Total: ${formatMoney(totalAmount)}\n` +
                    `Amount Paid: ${formatMoney(amountPaid)}\n` +
                    `Overpayment: ${formatMoney(overpayment)}\n\n` +
                    'You are entering MORE payment than the order total.\n\n' +
                    ' Click OK to continue (will show overpaid)\n' +
                    ' Click Cancel to correct the amount'
                );
                
                if (!continueWithOverpay) return;
            }
            
            const data = {
                poId: po.PO_ID,
                supplierId: document.getElementById('editPOSupplier').value,
                invoiceNumber: document.getElementById('editPOInvoiceNumber').value,
                poDate: document.getElementById('editPODate').value,
                dueDate: document.getElementById('editPODueDate').value,
                status: document.getElementById('editPOStatus').value,
                notes: document.getElementById('editPONotes').value,
                totalAmount: totalAmount,
                amountPaid: parseFloat(document.getElementById('editPOAmountPaid').value) || 0,
                lineItems: newLines,  // FIXED: was 'lines', backend expects 'lineItems'
                oldLines: currentEditingOrder._originalLines || []
            };
            
            // Check if voiding - show confirmation
            const newStatus = document.getElementById('editPOStatus').value;
            const oldStatus = po.Status;
            if (newStatus === 'Voided' && oldStatus !== 'Voided') {
                let message = ' VOID PURCHASE ORDER?\n\n' +
                    'This will:\n' +
                    ' Mark the order as VOIDED\n';
                
                if (oldStatus === 'Received') {
                    message += ' REMOVE inventory for all line items\n';
                }
                message += ' Create adjustment log entries\n' +
                    ' Exclude from tax reports\n\n' +
                    'This action cannot be easily undone.\n\n' +
                    'Continue with voiding ' + (po.Invoice_Number || po.PO_ID) + '?';
                
                const confirmVoid = confirm(message);
                if (!confirmVoid) return;
            }
            
            showStatus('purchasesStatus', ' Saving changes...', 'info');
            
            const result = await apiCall('updatePurchaseOrder', data);
            
            if (result && result.status === 'success') {
                showStatus('purchasesStatus', ' Purchase order updated successfully!', 'success');
                closeOrderModal();
                loadPurchases();
            } else {
                showStatus('purchasesStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        function enableEditMode() {
            if (currentEditingType === 'purchase') {
                enablePurchaseOrderEdit();
            } else if (currentEditingType === 'sales') {
                enableSalesOrderEdit();
            }
        }
        
        async function enableSalesOrderEdit() {
            const so = currentEditingOrder;
            
            // Load items and customers if not cached
            if (cachedItems.length === 0) {
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
            }
            if (cachedCustomers.length === 0) {
                const custResult = await apiCall('getCustomers');
                if (custResult && custResult.status === 'success') {
                    cachedCustomers = custResult.data;
                }
            }
            
            // Get line items
            const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
            const lines = linesResult?.data || [];
            
            document.getElementById('modalTitle').textContent = `Edit Sales Order: ${so.Invoice_Number || so.SO_ID}`;
            
            // Build customer dropdown
            let customerOptions = '<option value="">Select Customer</option>';
            cachedCustomers.forEach(c => {
                customerOptions += `<option value="${c.Customer_ID}" ${c.Customer_ID === so.Customer_ID ? 'selected' : ''}>${c.Customer_Name}</option>`;
            });
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Order Information</h3>
                        <div class="form-group">
                            <label>Customer *</label>
                            <select id="editSOCustomer" required>${customerOptions}</select>
                        </div>
                        <div class="form-group">
                            <label>Invoice Number</label>
                            <input type="text" id="editSOInvoiceNumber" value="${so.Invoice_Number || ''}">
                        </div>
                        <div class="form-group">
                            <label>Sale Date</label>
                            <input type="date" id="editSODate" value="${so.Sale_Date ? new Date(so.Sale_Date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="editSODueDate" value="${so.Due_Date ? new Date(so.Due_Date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="editSOPaymentMethod">
                                <option value="Cash" ${so.Payment_Method === 'Cash' ? 'selected' : ''}>Cash</option>
                                <option value="Check" ${so.Payment_Method === 'Check' ? 'selected' : ''}>Check</option>
                                <option value="Credit Card" ${so.Payment_Method === 'Credit Card' ? 'selected' : ''}>Credit Card</option>
                                <option value="Invoice" ${so.Payment_Method === 'Invoice' ? 'selected' : ''}>Invoice</option>
                                <option value="Terms (Net 30)" ${so.Payment_Method === 'Terms (Net 30)' ? 'selected' : ''}>Terms (Net 30)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="editSOStatus">
                                <option value="Pending" ${so.Status === 'Pending' ? 'selected' : ''}> Pending</option>
                                <option value="Ready" ${so.Status === 'Ready' ? 'selected' : ''}> Ready for Pickup</option>
                                <option value="Out for Delivery" ${so.Status === 'Out for Delivery' ? 'selected' : ''}> Out for Delivery</option>
                                <option value="Delivered" ${so.Status === 'Delivered' ? 'selected' : ''}> Delivered</option>
                                <option value="Completed" ${so.Status === 'Completed' ? 'selected' : ''}> Completed</option>
                                <option value="Voided" ${so.Status === 'Voided' ? 'selected' : ''}> Voided</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-top: 0; color: #667eea;">Payment Information</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div id="editSOCurrentTotal" style="margin-bottom: 10px;">
                                <strong>Current Total:</strong> ${formatMoney(parseFloat(so.Total_Amount || 0))}
                            </div>
                            <div id="editSOPreviouslyPaid" style="margin-bottom: 10px;">
                                <strong>Previously Paid:</strong> ${formatMoney(parseFloat(so.Amount_Paid || 0))}
                            </div>
                            <div id="editSOBalanceDue">
                                <strong>Balance Due:</strong> <span style="color: #e74c3c;">$${(() => {
                                    const balance = parseFloat(so.Total_Amount || 0) - parseFloat(so.Amount_Paid || 0);
                                    return (Math.abs(balance) < 0.01 ? 0 : balance).toFixed(2);
                                })()}</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label> Amount Paid</label>
                            <div style="position: relative; display: flex; align-items: center;">
                                <span style="position: absolute; left: 12px; font-size: 16px; font-weight: bold; color: #666;">$</span>
                                <input type="number" id="editSOAmountPaid" step="0.01" min="0" placeholder="0.00" value="${parseFloat(so.Amount_Paid || 0).toFixed(2)}" style="padding-left: 28px; font-size: 16px; font-weight: 600;">
                            </div>
                            <small style="color: #666;"> Enter numbers only (e.g., 115.46 for $115.46)</small>
                        </div>
                        <div style="color: #666; font-size: 13px; background: #fff3cd; padding: 10px; border-radius: 6px;">
                             Total will recalculate based on line items below
                        </div>
                    </div>
                </div>
                
                <h3 style="color: #667eea; margin-bottom: 15px;">Line Items</h3>
                <div id="editSOLineItems">
            `;
            
            // Add existing line items as editable rows
            lines.forEach((line, index) => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                html += createEditableLineItem('SO', line, index, item);
            });
            
            html += `
                </div>
                <button type="button" class="btn btn-secondary" onclick="addEditLineItem('SO')" style="margin-top: 10px;">+ Add Line Item</button>
                
                <div class="form-group" style="margin-top: 30px;">
                    <label>Notes</label>
                    <textarea id="editSONotes" rows="3" style="width: 100%;">${so.Notes || ''}</textarea>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            
            // Attach event listeners to all SO line items in the edit modal
            console.log('Attaching listeners to SO edit modal line items'); // DEBUG
            document.querySelectorAll('#editSOLineItems .edit-line-item').forEach(row => {
                attachEditLineItemListeners(row);
            });
            
            document.getElementById('modalEditBtn').style.display = 'none';
            document.getElementById('modalSaveBtn').style.display = 'inline-block';
        }
        
        async function saveSalesOrderChanges() {
            const so = currentEditingOrder;
            
            // Collect line items
            const newLines = [];
            let totalAmount = 0;
            
            document.querySelectorAll('#editSOLineItems .edit-line-item').forEach(row => {
                const itemId = row.querySelector('.edit-item').value;
                const qty = parseInt(row.querySelector('.edit-qty').value) || 0;
                const price = parseFloat(row.querySelector('.edit-price').value) || 0;
                
                if (itemId && qty > 0) {
                    newLines.push({
                        itemId: itemId,
                        quantity: qty,
                        unitPrice: price,
                        originalItem: row.dataset.originalItem,
                        originalQty: parseInt(row.dataset.originalQty) || 0,
                        lineId: row.dataset.lineId
                    });
                    totalAmount += qty * price;
                }
            });
            
            if (newLines.length === 0) {
                alert('Please add at least one line item');
                return;
            }
            
            // ===== VALIDATION #1: Check for Duplicate Items =====
            const itemCounts = {};
            newLines.forEach(line => {
                itemCounts[line.itemId] = (itemCounts[line.itemId] || 0) + 1;
            });
            
            const duplicates = Object.entries(itemCounts).filter(([id, count]) => count > 1);
            if (duplicates.length > 0) {
                // Find item names for the warning message
                const duplicateNames = duplicates.map(([itemId]) => {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    return item ? item.Item_Description : itemId;
                }).join(', ');
                
                const continueWithDupes = confirm(
                    ' DUPLICATE ITEMS DETECTED\n\n' +
                    'The following items appear on multiple lines:\n' +
                    duplicateNames + '\n\n' +
                    'This may be intentional (different prices), but could also be a mistake.\n\n' +
                    ' Click OK to continue saving\n' +
                    ' Click Cancel to review the order'
                );
                
                if (!continueWithDupes) return;
            }
            
            // ===== VALIDATION #2: Check for Overpayment =====
            const amountPaid = parseFloat(document.getElementById('editSOAmountPaid').value) || 0;
            if (amountPaid > totalAmount + 0.01) { // Allow 1 cent rounding
                const overpayment = amountPaid - totalAmount;
                const continueWithOverpay = confirm(
                    ' OVERPAYMENT WARNING\n\n' +
                    `Order Total: ${formatMoney(totalAmount)}\n` +
                    `Amount Paid: ${formatMoney(amountPaid)}\n` +
                    `Overpayment: ${formatMoney(overpayment)}\n\n` +
                    'You are entering MORE payment than the order total.\n\n' +
                    ' Click OK to continue (will show overpaid)\n' +
                    ' Click Cancel to correct the amount'
                );
                
                if (!continueWithOverpay) return;
            }
            
            const data = {
                soId: so.SO_ID,
                customerId: document.getElementById('editSOCustomer').value,
                invoiceNumber: document.getElementById('editSOInvoiceNumber').value,
                saleDate: document.getElementById('editSODate').value,
                dueDate: document.getElementById('editSODueDate').value,
                paymentMethod: document.getElementById('editSOPaymentMethod').value,
                status: document.getElementById('editSOStatus').value,
                notes: document.getElementById('editSONotes').value,
                totalAmount: totalAmount,
                amountPaid: parseFloat(document.getElementById('editSOAmountPaid').value) || 0,
                lineItems: newLines  // FIXED: was 'lines', backend expects 'lineItems'
            };
            
            // Check if voiding - show confirmation
            const newStatus = document.getElementById('editSOStatus').value;
            const oldStatus = so.Status;
            if (newStatus === 'Voided' && oldStatus !== 'Voided') {
                const confirmVoid = confirm(
                    ' VOID SALES ORDER?\n\n' +
                    'This will:\n' +
                    ' Mark the order as VOIDED\n' +
                    ' ADD inventory back for all line items\n' +
                    ' Create adjustment log entries\n' +
                    ' Exclude from tax reports\n\n' +
                    'This action cannot be easily undone.\n\n' +
                    'Continue with voiding ' + (so.Invoice_Number || so.SO_ID) + '?'
                );
                if (!confirmVoid) return;
            }
            
            showStatus('salesStatus', ' Saving changes...', 'info');
            
            const result = await apiCall('updateSalesOrder', data);
            
            if (result && result.status === 'success') {
                showStatus('salesStatus', ' Sales order updated successfully!', 'success');
                closeOrderModal();
                loadSales();
            } else {
                showStatus('salesStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
            }
        }
        
        function recordPurchasePayment(poId, total, amountPaid) {
            let remaining = total - amountPaid;
            if (Math.abs(remaining) < 0.01) remaining = 0;
            
            // Create better formatted prompt
            let message = ` Record Payment for ${poId}\n\n`;
            message += `Invoice Total:    ${formatMoney(total)}\n`;
            message += `Already Paid:     ${formatMoney(amountPaid)}\n`;
            message += `\n`;
            message += `Balance Due:      ${formatMoney(remaining)}\n\n`;
            
            // Suggest full payment if unpaid
            if (amountPaid === 0) {
                message += `Tip: Enter ${remaining.toFixed(2)} to pay in full\n\n`;
            }
            
            message += `Enter payment amount:`;
            
            const payment = prompt(message);
            
            if (payment === null) return; // Cancelled
            
            const paymentAmount = parseFloat(payment);
            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                alert('Please enter a valid payment amount');
                return;
            }
            
            if (paymentAmount > remaining + 0.01) { // Allow 1 cent rounding
                if (!confirm(`Payment (${formatMoney(paymentAmount)}) is more than balance due (${formatMoney(remaining)}).\n\nContinue anyway?`)) {
                    return;
                }
            }
            
            // Call backend - send TOTAL amount paid (existing + new payment)
            const newTotalPaid = amountPaid + paymentAmount;
            const paymentDate = getTodayLocalDate(); // Default to today
            apiCall('recordPurchasePayment', { poId: poId, amountPaid: newTotalPaid, paymentDate: paymentDate })
                .then(result => {
                    if (result && result.status === 'success') {
                        const statusMsg = result.paymentStatus === 'Paid' ? ' PAID IN FULL!' : `Status: ${result.paymentStatus}`;
                        showStatus('purchasesStatus', ` Payment recorded! ${formatMoney(newTotalPaid)} total paid. ${statusMsg}`, 'success');
                        loadPurchases();
                    } else {
                        showStatus('purchasesStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                    }
                })
                .catch(err => {
                    showStatus('purchasesStatus', ' Error recording payment: ' + err.message, 'error');
                });
        }

        // ==================== SALES ====================

        function showAddSaleForm() {
            // MOBILE FIX: Always reset the save lock when opening form
            isSavingSale = false;
            
            loadSaleDropdowns();
            
            // FIX #1: Clear any previous line items and errors before showing
            const lineItemsContainer = document.getElementById('soLineItems');
            if (lineItemsContainer) {
                lineItemsContainer.innerHTML = '';
            }
            
            document.getElementById('addSaleForm').style.display = 'block';
            
            // Add fresh line item
            addSOLineItem();
            
            // Setup event listeners for the initial line item
            setTimeout(() => {
                const firstRow = document.querySelector('#soLineItems .line-item-row');
                if (firstRow) {
                    const itemSelect = firstRow.querySelector('.so-item');
                    const qtyInput = firstRow.querySelector('.so-qty');
                    const priceInput = firstRow.querySelector('.so-price');
                    const removeBtn = firstRow.querySelector('.remove-btn');
                    
                    if (itemSelect) {
                        itemSelect.addEventListener('change', function() {
                            updateSOItemInfo(this);
                        });
                    }
                    
                    if (qtyInput) {
                        qtyInput.addEventListener('input', function() {
                            const row = this.closest('.line-item-row');
                            const itemSelect = row.querySelector('.so-item');
                            if (itemSelect.value) {
                                updateSOItemInfo(itemSelect);
                            }
                            calculateSOTotal();
                        });
                    }
                    
                    if (priceInput) {
                        priceInput.addEventListener('input', function() {
                            calculateSOTotal();
                        });
                    }
                    
                    if (removeBtn) {
                        removeBtn.addEventListener('click', function() {
                            removeLineItem(this);
                            calculateSOTotal();
                        });
                    }
                }
                
                // Initialize summary boxes
                calculateSOTotal();
            }, 100);
        }

        function hideAddSaleForm() {
            document.getElementById('addSaleForm').style.display = 'none';
            document.querySelector('#addSaleForm form').reset();
            
            // MOBILE FIX: Always reset save lock and button state
            isSavingSale = false;
            const submitBtn = document.querySelector('#addSaleForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = ' Save Sale';
            }
            
            // Reset summary boxes
            const qtyBox = document.getElementById('soTotalQty');
            const amountBox = document.getElementById('soTotalAmount');
            if (qtyBox) qtyBox.textContent = '0';
            if (amountBox) amountBox.textContent = '$0.00';
            
            // FIX #1: Clear all error messages and line items
            const lineItemsContainer = document.getElementById('soLineItems');
            if (lineItemsContainer) {
                // Remove all line items completely
                lineItemsContainer.innerHTML = '';
                // Add back one fresh line item
                addSOLineItem();
            }
        }

        async function loadSaleDropdowns() {
            if (cachedCustomers.length === 0) {
                const result = await apiCall('getCustomers');
                if (result && result.status === 'success') {
                    cachedCustomers = result.data;
                }
            }

            const select = document.getElementById('soCustomer');
            select.innerHTML = '<option value="">Select Customer</option>';
            cachedCustomers.forEach(c => {
                select.innerHTML += `<option value="${c.Customer_ID}">${c.Customer_Name}</option>`;
            });

            if (cachedItems.length === 0) {
                const result = await apiCall('getItems');
                if (result && result.status === 'success') {
                    cachedItems = result.data;
                    console.log('loadSaleDropdowns: Loaded items, first item Unit_Sell_Price:', cachedItems[0]?.Unit_Sell_Price); // DEBUG
                }
            }

            console.log('loadSaleDropdowns: Populating dropdowns with', cachedItems.length, 'items'); // DEBUG
            console.log('loadSaleDropdowns: First item Unit_Sell_Price:', cachedItems[0]?.Unit_Sell_Price); // DEBUG
            
            document.querySelectorAll('.so-item').forEach(select => {
                select.innerHTML = '<option value="">Select Item</option>';
                cachedItems.forEach(item => {
                    console.log(`Adding option: ${item.Item_Description}, Unit_Sell_Price: ${item.Unit_Sell_Price}`); // DEBUG
                    select.innerHTML += `<option value="${item.Item_ID}" data-price="${item.Unit_Sell_Price}" data-stock="${item.Qty_On_Hand || 0}">${item.Item_Description}</option>`;
                });
            });
            
            console.log('loadSaleDropdowns: Dropdown populated!'); // DEBUG
        }

        function addSOLineItem() {
            const container = document.getElementById('soLineItems');
            
            // Get all items once
            if (cachedItems.length === 0) {
                alert('Please wait for items to load');
                return;
            }
            
            const newRow = document.createElement('div');
            newRow.className = 'line-item-row';
            newRow.style.cssText = 'display: grid; grid-template-columns: 2.5fr 1fr 1fr 50px; gap: 10px; margin-bottom: 10px; align-items: end;';
            newRow.innerHTML = `
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                    <select class="so-item" required style="padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white; width: 100%;">
                        <option value="">Select Item</option>
                        ${cachedItems.map(item => {
                            console.log('Item:', item.Item_Description, 'Unit_Sell_Price:', item.Unit_Sell_Price); // DEBUG
                            return `<option value="${item.Item_ID}" data-price="${item.Unit_Sell_Price}" data-stock="${item.Qty_On_Hand || 0}">${item.Item_Description}</option>`;
                        }).join('')}
                    </select>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Quantity</label>
                    <input type="number" class="so-qty" placeholder="0" min="1" required style="padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px; width: 100%;">
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Price</label>
                    <input type="number" class="so-price" placeholder="0.00" step="0.01" min="0" required style="padding: 14px 10px; border: 2px solid #667eea; border-radius: 8px; text-align: center; font-size: 16px; min-height: 52px; background: white; width: 100%;">
                </div>
                <button type="button" class="remove-btn" style="min-height: 52px; font-size: 18px; margin-top: 26px;"></button>
                <div class="so-stock-info" style="grid-column: 1 / -1; font-size: 13px; padding: 5px 10px; margin-top: -5px; display: none;"></div>
            `;
            container.appendChild(newRow);
            
            // Attach event listeners programmatically (CSP-safe)
            const itemSelect = newRow.querySelector('.so-item');
            const qtyInput = newRow.querySelector('.so-qty');
            const priceInput = newRow.querySelector('.so-price');
            const removeBtn = newRow.querySelector('.remove-btn');
            
            console.log('Attaching listeners to:', itemSelect); // DEBUG
            
            itemSelect.addEventListener('change', function() {
                console.log('CHANGE EVENT FIRED!'); // DEBUG
                updateSOItemInfo(this);
            });
            
            qtyInput.addEventListener('input', function() {
                // Update stock info when quantity changes
                const row = this.closest('.line-item-row');
                const itemSelect = row.querySelector('.so-item');
                if (itemSelect.value) {
                    updateSOItemInfo(itemSelect);
                }
                calculateSOTotal();
            });
            
            priceInput.addEventListener('input', function() {
                calculateSOTotal();
            });
            
            removeBtn.addEventListener('click', function() {
                removeLineItem(this);
                calculateSOTotal();
            });
            
            console.log('Event listeners attached successfully!'); // DEBUG
        }
        
        function updateSOItemInfo(selectElement) {
            console.log('updateSOItemInfo called!'); // DEBUG
            const option = selectElement.options[selectElement.selectedIndex];
            console.log('Selected option:', option); // DEBUG
            console.log('Option text:', option.text); // DEBUG
            console.log('data-price attribute:', option.getAttribute('data-price')); // DEBUG
            console.log('data-stock attribute:', option.getAttribute('data-stock')); // DEBUG
            
            const price = option.getAttribute('data-price');
            const stock = parseFloat(option.getAttribute('data-stock')) || 0;
            
            const row = selectElement.closest('.line-item-row');
            const priceInput = row.querySelector('.so-price');
            const qtyInput = row.querySelector('.so-qty');
            const stockInfoDiv = row.querySelector('.so-stock-info');
            
            if (price) {
                console.log('Setting price to:', price); // DEBUG
                priceInput.value = price;
            } else {
                console.log('NO PRICE FOUND!'); // DEBUG
            }
            
            // Show stock info
            if (stockInfoDiv && option.value) {
                stockInfoDiv.style.display = 'block';
                
                const qty = parseFloat(qtyInput.value) || 0;
                const remaining = stock - qty;
                
                let message = ` Current Stock: ${stock} units`;
                let bgColor = '#e3f2fd';
                let textColor = '#1565c0';
                
                if (qty > 0) {
                    message += `  After sale: ${remaining} units`;
                    
                    if (remaining < 0) {
                        bgColor = '#ffebee';
                        textColor = '#c62828';
                        message += '  INSUFFICIENT STOCK - This will create a negative inventory!';
                    } else if (remaining === 0) {
                        bgColor = '#fff3e0';
                        textColor = '#ef6c00';
                        message += '  This will deplete stock to zero';
                    } else if (remaining < 10) {
                        bgColor = '#fff3e0';
                        textColor = '#ef6c00';
                        message += '  Low stock warning';
                    }
                }
                
                stockInfoDiv.textContent = message;
                stockInfoDiv.style.background = bgColor;
                stockInfoDiv.style.color = textColor;
                stockInfoDiv.style.border = `1px solid ${textColor}`;
                stockInfoDiv.style.borderRadius = '4px';
            }
            
            calculateSOTotal();
        }
        
        function calculateSOTotal() {
            let total = 0;
            let totalQty = 0;
            
            document.querySelectorAll('#soLineItems .line-item-row').forEach(row => {
                const qty = parseInt(row.querySelector('.so-qty')?.value) || 0;
                const price = parseFloat(row.querySelector('.so-price')?.value) || 0;
                const lineTotal = qty * price;
                total += lineTotal;
                totalQty += qty;
            });
            
            // Update hidden total field (if exists)
            const totalField = document.getElementById('soTotal');
            if (totalField) {
                totalField.value = total.toFixed(2);
            }
            
            // Update summary boxes
            const qtyBox = document.getElementById('soTotalQty');
            const amountBox = document.getElementById('soTotalAmount');
            
            if (qtyBox) qtyBox.textContent = totalQty;
            if (amountBox) amountBox.textContent = '$' + total.toFixed(2);
        }

        let isSavingSale = false; // Prevent double-click
        
        async function addSale(e) {
            e.preventDefault();
            
            // Prevent double-click
            if (isSavingSale) {
                console.log('Already saving sale, ignoring duplicate click');
                return;
            }
            
            const lineItems = [];
            let calculatedTotal = 0;
            
            document.querySelectorAll('#soLineItems .line-item-row').forEach(row => {
                const itemId = row.querySelector('.so-item').value;
                const qty = parseInt(row.querySelector('.so-qty').value) || 0;
                const price = parseFloat(row.querySelector('.so-price').value) || 0;
                const lineTotal = qty * price;
                
                // Only add valid line items (has item selected, qty > 0)
                if (itemId && qty > 0) {
                    lineItems.push({
                        itemId: itemId,
                        quantity: qty,
                        unitPrice: price
                    });
                    calculatedTotal += lineTotal;
                }
            });

            // Validate at least one line item
            if (lineItems.length === 0) {
                alert(' Please add at least one item to the sale.\n\nSelect an item and enter a quantity before saving.');
                return;
            }

            // ===== VALIDATION #1: Check for Duplicate Items =====
            const itemCounts = {};
            lineItems.forEach(line => {
                itemCounts[line.itemId] = (itemCounts[line.itemId] || 0) + 1;
            });
            
            const duplicates = Object.entries(itemCounts).filter(([id, count]) => count > 1);
            if (duplicates.length > 0) {
                // Find item names for the warning message
                const duplicateNames = duplicates.map(([itemId]) => {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    return item ? item.Item_Description : itemId;
                }).join(', ');
                
                const continueWithDupes = confirm(
                    ' DUPLICATE ITEMS DETECTED\n\n' +
                    'The following items appear on multiple lines:\n' +
                    duplicateNames + '\n\n' +
                    'This may be intentional (different prices), but could also be a mistake.\n\n' +
                    ' Click OK to continue saving\n' +
                    ' Click Cancel to review the order'
                );
                
                if (!continueWithDupes) return;
            }
            
            // ===== VALIDATION #2: Check for Overpayment =====
            const amountPaid = parseFloat(document.getElementById('soAmountPaid').value) || 0;
            if (amountPaid > calculatedTotal + 0.01) { // Allow 1 cent rounding
                const overpayment = amountPaid - calculatedTotal;
                const continueWithOverpay = confirm(
                    ' OVERPAYMENT WARNING\n\n' +
                    `Order Total: ${formatMoney(calculatedTotal)}\n` +
                    `Amount Paid: ${formatMoney(amountPaid)}\n` +
                    `Overpayment: ${formatMoney(overpayment)}\n\n` +
                    'You are entering MORE payment than the order total.\n\n' +
                    ' Click OK to continue (will show overpaid)\n' +
                    ' Click Cancel to correct the amount'
                );
                
                if (!continueWithOverpay) return;
            }

            // LOCK - Prevent double submit
            isSavingSale = true;
            
            // Find and disable submit button
            const submitBtn = document.querySelector('#addSaleForm button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : '';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = ' Saving...';
            }
            
            try {
                // Validate required fields
                const status = document.getElementById('soStatus').value;
                const dueDate = document.getElementById('soDueDate').value;
                
                if (!status) {
                    showStatus('salesStatus', ' Please select a Status', 'error');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                    document.getElementById('soStatus').focus();
                    return;
                }
                
                if (!dueDate) {
                    showStatus('salesStatus', ' Please select a Due Date', 'error');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                    document.getElementById('soDueDate').focus();
                    return;
                }
                
                // AUTO-GENERATE INVOICE NUMBER
                // Format: INV-MMDDYY-XXX (e.g., INV-120725-001)
                const saleDate = document.getElementById('soDate').value;
                const dateObj = saleDate ? new Date(saleDate) : new Date();
                
                // Format date as MMDDYY
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                const year = String(dateObj.getFullYear()).slice(-2); // Last 2 digits
                const dateStr = `${month}${day}${year}`;
                
                // Get all existing sales orders to find the next number for this date
                const existingSales = await apiCall('getSalesOrders');
                let nextNumber = 1;
                
                if (existingSales && existingSales.data && existingSales.data.length > 0) {
                    // Find highest invoice number for this date
                    const prefix = `INV-${dateStr}-`;
                    const todayInvoices = existingSales.data
                        .filter(so => so.Invoice_Number && so.Invoice_Number.startsWith(prefix))
                        .map(so => {
                            const parts = so.Invoice_Number.split('-');
                            return parseInt(parts[2]) || 0;
                        });
                    
                    if (todayInvoices.length > 0) {
                        nextNumber = Math.max(...todayInvoices) + 1;
                    }
                }
                
                // Generate invoice number: INV-120725-001
                const invoiceNumber = `INV-${dateStr}-${String(nextNumber).padStart(3, '0')}`;

                // Get the selected date and add current time
                const selectedDate = document.getElementById('soDate').value;
                const now = new Date();
                const saleDateWithTime = selectedDate === getTodayLocalDate() 
                    ? now.toISOString()  // Today - use actual current time
                    : `${selectedDate}T${now.toTimeString().split(' ')[0]}`; // Other date - add current time

                const data = {
                    customerId: document.getElementById('soCustomer').value,
                    saleDate: saleDateWithTime,
                    invoiceNumber: invoiceNumber,
                    paymentMethod: document.getElementById('soPayment').value,
                    dueDate: document.getElementById('soDueDate').value || null,
                    totalAmount: calculatedTotal,
                    amountPaid: parseFloat(document.getElementById('soAmountPaid').value) || 0,
                    status: document.getElementById('soStatus').value,
                    notes: document.getElementById('soNotes').value,
                    lineItems: lineItems  // FIXED: was "lines", backend expects "lineItems"
                };

                const result = await apiCall('createSalesOrder', data);
                
                if (result && result.status === 'success') {
                    showStatus('salesStatus', ` Sale recorded! Invoice #: ${invoiceNumber}`, 'success');
                    hideAddSaleForm();
                    loadSales();
                } else {
                    showStatus('salesStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                }
            } finally {
                // UNLOCK
                isSavingSale = false;
                
                // Re-enable button
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText || ' Save Sale';
                }
            }
        }

        let salesData = []; // Cache for filtering
        
        // Helper function for mobile-safe date formatting
        function formatDateSafe(dateValue) {
            if (!dateValue) return '-';
            try {
                const date = new Date(dateValue);
                if (isNaN(date.getTime())) return '-';
                // Use manual formatting instead of toLocaleDateString for mobile compatibility
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const year = date.getFullYear();
                return `${month}/${day}/${year}`;
            } catch (e) {
                return '-';
            }
        }
        
        function formatTimeSafe(dateValue) {
            if (!dateValue) return '-';
            try {
                const date = new Date(dateValue);
                if (isNaN(date.getTime())) return '-';
                // Format time in 12-hour format
                let hours = date.getHours();
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // 0 becomes 12
                return `${hours}:${minutes} ${ampm}`;
            } catch (e) {
                return '-';
            }
        }
        
        // Get sortable date string (YYYY-MM-DD) for proper sorting
        function getSortableDate(dateValue) {
            if (!dateValue) return '';
            try {
                const date = new Date(dateValue);
                if (isNaN(date.getTime())) return '';
                return date.toISOString();
            } catch (e) {
                return '';
            }
        }
        
        async function loadSales() {
            const salesTable = document.getElementById('salesTable');
            if (salesTable) {
                salesTable.innerHTML = '<div class="loading">Loading sales...</div>';
            }
            
            // Load customers FIRST if not cached
            if (cachedCustomers.length === 0) {
                const custResult = await apiCall('getCustomers');
                if (custResult && custResult.status === 'success') {
                    cachedCustomers = custResult.data;
                } else {
                    console.error('Failed to load customers:', custResult);
                }
            }
            
            // Now load and display sales
            console.log('Calling getSalesOrders...');
            const result = await apiCall('getSalesOrders');
            console.log('getSalesOrders result:', result);
            
            if (result && result.status === 'success') {
                salesData = result.data;
                if (salesTable) {
                    displaySales(result.data);
                    loadSaleFilterCustomers(); // Populate filter dropdown
                }
            } else {
                console.error('getSalesOrders failed:', result);
                const errorMsg = result?.message || 'Unknown error - check console';
                if (salesTable) {
                    salesTable.innerHTML = `<div class="loading">Error loading sales: ${errorMsg}</div>`;
                }
            }
        }
        
        async function loadSaleFilterCustomers() {
            if (cachedCustomers.length === 0) {
                const result = await apiCall('getCustomers');
                if (result && result.status === 'success') {
                    cachedCustomers = result.data;
                }
            }
            
            const select = document.getElementById('filterSaleCustomer');
            select.innerHTML = '<option value="">All Customers</option>';
            cachedCustomers.forEach(c => {
                select.innerHTML += `<option value="${c.Customer_ID}">${c.Customer_Name}</option>`;
            });
        }
        
        function filterSales() {
            const customerFilter = document.getElementById('filterSaleCustomer').value;
            const invoiceNumberFilter = document.getElementById('filterInvoiceNumber').value.trim().toLowerCase();
            const dateFrom = document.getElementById('filterSaleDateFrom').value;
            const dateTo = document.getElementById('filterSaleDateTo').value;
            const statusFilter = document.getElementById('filterSaleStatus')?.value || '';
            
            console.log('Filtering sales with dates:', dateFrom, 'to', dateTo); // Debug
            
            const filtered = salesData.filter(so => {
                // Use matchesFilter for multi-select support
                const matchesCustomer = matchesFilter(so.Customer_ID, customerFilter);
                const matchesInvoice = !invoiceNumberFilter || (so.Invoice_Number && so.Invoice_Number.toLowerCase().includes(invoiceNumberFilter));
                
                // FIX: Check both Sale_Date and SO_Date (like displaySales does)
                const soDate = new Date(so.Sale_Date || so.SO_Date);
                
                // Date FROM comparison (start of day) - use global parseLocalDate helper
                let matchesDateFrom = true;
                if (dateFrom) {
                    const fromDateObj = parseLocalDate(dateFrom);
                    fromDateObj.setHours(0, 0, 0, 0);
                    matchesDateFrom = soDate >= fromDateObj;
                }
                
                // Date TO comparison (end of day - 23:59:59)
                let matchesDateTo = true;
                if (dateTo) {
                    const toDateObj = parseLocalDate(dateTo);
                    toDateObj.setHours(23, 59, 59, 999);
                    matchesDateTo = soDate <= toDateObj;
                }
                
                // Status filter
                let matchesStatus = true;
                if (statusFilter === 'exclude-voided') {
                    matchesStatus = so.Status !== 'Voided';
                } else if (statusFilter) {
                    matchesStatus = so.Status === statusFilter;
                }
                
                return matchesCustomer && matchesInvoice && matchesDateFrom && matchesDateTo && matchesStatus;
            });
            
            console.log('Filtered results:', filtered.length, 'orders'); // Debug
            displaySales(filtered);
        }
        
        function clearSaleFilters() {
            document.getElementById('filterSaleCustomer').value = '';
            document.getElementById('filterInvoiceNumber').value = '';
            document.getElementById('filterSaleDateFrom').value = '';
            document.getElementById('filterSaleDateTo').value = '';
            if (document.getElementById('filterSaleStatus')) {
                document.getElementById('filterSaleStatus').value = '';
            }
            displaySales(salesData);
        }
        
        // Apply date filter from oval buttons
        function applySalesDateFilter(period, evt) {
            console.log('Date filter clicked:', period); // Debug
            
            const now = new Date();
            let fromDate = null;
            let toDate = null; // Leave null to include future-dated orders
            
            // Calculate date ranges - only set fromDate, leave toDate open
            switch(period) {
                case 'today':
                    fromDate = new Date(now);
                    toDate = new Date(now); // Today only - both dates same
                    break;
                case 'week':
                    fromDate = new Date(now);
                    fromDate.setDate(now.getDate() - 7);
                    // No toDate - include future orders
                    break;
                case '3months':
                    fromDate = new Date(now);
                    fromDate.setMonth(now.getMonth() - 3);
                    break;
                case '6months':
                    fromDate = new Date(now);
                    fromDate.setMonth(now.getMonth() - 6);
                    break;
                case '9months':
                    fromDate = new Date(now);
                    fromDate.setMonth(now.getMonth() - 9);
                    break;
                case 'ytd':
                    fromDate = new Date(now.getFullYear(), 0, 1); // Jan 1st this year
                    break;
                case '1year':
                    fromDate = new Date(now);
                    fromDate.setFullYear(now.getFullYear() - 1);
                    break;
                case '3years':
                    fromDate = new Date(now);
                    fromDate.setFullYear(now.getFullYear() - 3);
                    break;
                case '5years':
                    fromDate = new Date(now);
                    fromDate.setFullYear(now.getFullYear() - 5);
                    break;
                case 'all':
                    // Show everything - set date range fields to empty
                    console.log('Clearing date filters'); // Debug
                    document.getElementById('filterSaleDateFrom').value = '';
                    document.getElementById('filterSaleDateTo').value = '';
                    filterSales();
                    
                    // Update button active state
                    if (evt) {
                        document.querySelectorAll('.oval-filter-btn').forEach(btn => {
                            btn.style.opacity = '0.6';
                            btn.style.transform = 'scale(1)';
                        });
                        evt.target.style.opacity = '1';
                        evt.target.style.transform = 'scale(1.05)';
                    }
                    return;
            }
            
            // Format dates for input fields using LOCAL time (global helper)
            const fromDateStr = fromDate ? formatLocalDate(fromDate) : '';
            const toDateStr = toDate ? formatLocalDate(toDate) : '';
            
            console.log('Setting dates:', fromDateStr, 'to', toDateStr || '(open)'); // Debug
            
            // Set filter fields
            document.getElementById('filterSaleDateFrom').value = fromDateStr;
            document.getElementById('filterSaleDateTo').value = toDateStr;
            
            // Apply filter
            filterSales();
            
            console.log('Filter applied'); // Debug
            
            // Update button active state
            if (evt) {
                document.querySelectorAll('.oval-filter-btn').forEach(btn => {
                    btn.style.opacity = '0.6';
                    btn.style.transform = 'scale(1)';
                });
                evt.target.style.opacity = '1';
                evt.target.style.transform = 'scale(1.05)';
            }
        }

        function displaySales(orders) {
            if (!orders || orders.length === 0) {
                document.getElementById('salesTable').innerHTML = '<p>No sales yet. Record your first sale!</p>';
                return;
            }

            // Calculate totals
            let totalAmount = 0;
            let totalPaid = 0;
            
            // Cache sales for row click
            window.cachedSales = orders;
            
            // Calculate totals first
            orders.forEach(so => {
                totalAmount += parseFloat(so.Total_Amount || so.Order_Total) || 0;
                totalPaid += parseFloat(so.Amount_Paid) || 0;
            });
            const balance = totalAmount - totalPaid;
            
            // SINGLE CARD - Buttons directly above boxes (like Inventory)
            let html = `
                <div class="sales-data-card">
                    <!-- Oval Buttons - No wrapper, directly in card -->
                    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 20px;">
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; padding-bottom: 10px;">
                            <button onclick="applySalesDateFilter('today', event)" class="oval-filter-btn" style="background: #e3f2fd; color: #1565c0; border: 3px solid #1565c0; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 Last Day
                            </button>
                            <button onclick="applySalesDateFilter('week', event)" class="oval-filter-btn" style="background: #fff3e0; color: #ef6c00; border: 3px solid #ef6c00; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 Last Week
                            </button>
                            <button onclick="applySalesDateFilter('3months', event)" class="oval-filter-btn" style="background: #fff9c4; color: #f57f17; border: 3px solid #f57f17; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 Last 3 Months
                            </button>
                            <button onclick="applySalesDateFilter('6months', event)" class="oval-filter-btn" style="background: #e8f5e9; color: #2e7d32; border: 3px solid #2e7d32; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 6 Months
                            </button>
                            <button onclick="applySalesDateFilter('9months', event)" class="oval-filter-btn" style="background: #e1f5fe; color: #0277bd; border: 3px solid #0277bd; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 9 Months
                            </button>
                            <button onclick="applySalesDateFilter('ytd', event)" class="oval-filter-btn" style="background: #f3e5f5; color: #6a1b9a; border: 3px solid #6a1b9a; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 YTD
                            </button>
                            <button onclick="applySalesDateFilter('1year', event)" class="oval-filter-btn" style="background: #fce4ec; color: #c2185b; border: 3px solid #c2185b; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 1 Year
                            </button>
                            <button onclick="applySalesDateFilter('3years', event)" class="oval-filter-btn" style="background: #ede7f6; color: #512da8; border: 3px solid #512da8; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 3 Years
                            </button>
                            <button onclick="applySalesDateFilter('5years', event)" class="oval-filter-btn" style="background: #e0f2f1; color: #00695c; border: 3px solid #00695c; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 5 Years
                            </button>
                            <button onclick="applySalesDateFilter('all', event)" class="oval-filter-btn active" style="background: #424242; color: white; border: 3px solid #424242; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                 All Time
                            </button>
                        </div>
                    </div>
            `;
            
            // Summary boxes (directly below buttons)
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #1976d2;">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Total Sales</div>
                        <div style="font-size: 28px; font-weight: bold; color: #1976d2;">$${totalAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 12px; color: #888;">${orders.length} orders</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #388e3c;">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Collected</div>
                        <div style="font-size: 28px; font-weight: bold; color: #388e3c;">$${totalPaid.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 12px; color: #888;">${((totalPaid/totalAmount)*100 || 0).toFixed(0)}% collected</div>
                    </div>
                    <div style="background: linear-gradient(135deg, ${balance > 0 ? '#ffebee, #ffcdd2' : '#e8f5e9, #c8e6c9'}); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid ${balance > 0 ? '#c62828' : '#388e3c'};">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Outstanding</div>
                        <div style="font-size: 28px; font-weight: bold; color: ${balance > 0 ? '#c62828' : '#388e3c'};">$${balance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 12px; color: #888;">${balance > 0 ? 'to collect' : 'all paid!'}</div>
                    </div>
                </div>
            `;
            
            html += '<div class="table-scroll-wrapper"><table class="data-table" id="salesDataTable"><thead><tr>';
            html += '<th>Invoice #</th><th>Customer</th><th>Date</th><th>Total</th><th>Paid</th><th>Due Date</th><th>Payment</th>';
            html += '</tr></thead><tbody>';

            orders.forEach(so => {
                const dueDate = formatDateSafe(so.Due_Date);
                const amountPaid = parseFloat(so.Amount_Paid) || 0;
                const total = parseFloat(so.Total_Amount || so.Order_Total) || 0;
                const invoiceNum = so.Invoice_Number || so.SO_ID;
                const saleDateTime = so.Sale_Date || so.SO_Date;
                
                // Calculate payment status from actual amounts (don't rely on stored field)
                let paymentStatus;
                if (amountPaid >= total - 0.01 && total > 0) {
                    paymentStatus = 'Paid';
                } else if (amountPaid > 0) {
                    paymentStatus = 'Partial';
                } else {
                    paymentStatus = 'Unpaid';
                }
                
                // Color code payment status badge
                let paymentBadge = '';
                if (paymentStatus === 'Paid') paymentBadge = '<span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Paid</span>';
                else if (paymentStatus === 'Partial') paymentBadge = '<span style="background: #ffc107; color: black; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Partial</span>';
                else paymentBadge = '<span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Unpaid</span>';
                
                html += `<tr style="cursor: pointer;" onclick="viewSalesOrder('${so.SO_ID}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                    <td><strong>${invoiceNum}</strong></td>
                    <td>${getCustomerName(so.Customer_ID)}</td>
                    <td data-sort="${getSortableDate(saleDateTime)}">${formatDateSafe(saleDateTime)}</td>
                    <td>${formatMoney(total)}</td>
                    <td>${formatMoney(amountPaid)}</td>
                    <td data-sort="${getSortableDate(so.Due_Date)}">${dueDate}</td>
                    <td>${paymentBadge}</td>
                </tr>`;
            });

            html += '</tbody></table></div>'; // Close table and scroll wrapper
            html += '</div>'; // Close data card wrapper
            document.getElementById('salesTable').innerHTML = html;
            setTimeout(() => makeSortable('salesDataTable'), 0);
        }
        
        // View Sales Order (opens modal with print option)
        function viewSalesOrder(soId) {
            const so = window.cachedSales?.find(s => s.SO_ID === soId);
            if (so) {
                showSalesOrderDetails(so);
            }
        }
        
        // Edit Sales Order
        async function editSalesOrder(soId) {
            // Find the SO in cached data or fetch it
            const result = await apiCall('getSalesOrders');
            if (result && result.status === 'success') {
                const so = result.data.find(s => s.SO_ID === soId);
                if (so) {
                    showSalesOrderDetails(so);
                }
            }
        }
        
        async function showSalesOrderDetails(so) {
            currentEditingOrder = so;
            currentEditingType = 'sales';
            
            // Load items if not cached
            if (cachedItems.length === 0) {
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
            }
            
            // Get line items
            const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
            const lines = linesResult?.data || [];
            
            const customerName = getCustomerName(so.Customer_ID);
            const dueDate = so.Due_Date ? new Date(so.Due_Date).toLocaleDateString() : '-';
            const invoiceDate = so.Invoice_Date ? new Date(so.Invoice_Date).toLocaleDateString() : '-';
            
            document.getElementById('modalTitle').textContent = `Sales Order: ${so.Invoice_Number || so.SO_ID}`;
            
            let html = `
                <!-- Card 1: Order & Payment Information -->
                <div class="content-card" style="margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3 style="margin-top: 0; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 8px;"> Order Information</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 8px 0; font-weight: bold; width: 140px;">Customer:</td><td>${customerName}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Invoice #:</td><td>${so.Invoice_Number || '-'}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Sale Date:</td><td>${new Date(so.Sale_Date).toLocaleDateString()}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Invoice Date:</td><td>${invoiceDate}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Due Date:</td><td>${dueDate}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Payment Method:</td><td>${so.Payment_Method}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Status:</td><td><span style="background: #d4edda; color: #155724; padding: 4px 12px; border-radius: 12px; font-size: 12px; border: 2px solid #c3e6cb;">${so.Status}</span></td></tr>
                            </table>
                        </div>
                        <div>
                            <h3 style="margin-top: 0; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 8px;"> Payment Information</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 8px 0; font-weight: bold; width: 140px;">Total Amount:</td><td style="font-size: 18px; color: #2c3e50;">${formatMoney(parseFloat(so.Total_Amount || 0))}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Amount Paid:</td><td style="color: #27ae60;">${formatMoney(parseFloat(so.Amount_Paid || 0))}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Balance Due:</td><td style="color: #e74c3c; font-size: 16px; font-weight: bold;">$${(() => {
                                    const balance = parseFloat(so.Total_Amount || 0) - parseFloat(so.Amount_Paid || 0);
                                    return (Math.abs(balance) < 0.01 ? 0 : balance).toFixed(2);
                                })()}</td></tr>
                                <tr><td style="padding: 8px 0; font-weight: bold;">Payment Status:</td><td><span style="background: ${so.Payment_Status === 'Paid' ? '#d4edda' : '#fff3cd'}; color: ${so.Payment_Status === 'Paid' ? '#155724' : '#856404'}; padding: 4px 12px; border-radius: 12px; font-size: 12px; border: 2px solid ${so.Payment_Status === 'Paid' ? '#c3e6cb' : '#ffeaa7'};">${so.Payment_Status}</span></td></tr>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            if (lines.length > 0) {
                html += `
                    <!-- Card 2: Line Items -->
                    <div class="content-card" style="margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin-top: 0; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 8px;"> Line Items</h3>
                        <div style="overflow-x: auto;">
                        <table class="data-table" style="margin-bottom: 0; font-size: 14px;">
                            <thead>
                                <tr style="background: #667eea; color: white;">
                                    <th style="padding: 12px 15px;">Item</th>
                                    <th style="padding: 12px 15px;">Description</th>
                                    <th style="padding: 12px 15px;">Qty</th>
                                    <th style="padding: 12px 15px;">Unit Price</th>
                                    <th style="padding: 12px 15px;">Line Total</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                lines.forEach(line => {
                    const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                    const lineTotal = (parseFloat(line.Quantity) || 0) * (parseFloat(line.Unit_Price) || 0);
                    html += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px 15px;"><strong>${item?.SKU || line.Item_ID}</strong></td>
                            <td style="padding: 12px 15px;">${item ? item.Item_Description : '-'}</td>
                            <td style="padding: 12px 15px; text-align: center; font-weight: bold;">${line.Quantity}</td>
                            <td style="padding: 12px 15px; text-align: right;">${formatMoney(parseFloat(line.Unit_Price || 0))}</td>
                            <td style="padding: 12px 15px; text-align: right; font-weight: bold;">${formatMoney(lineTotal)}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                    </div>
                    </div>
                `;
            }
            
            if (so.Notes) {
                html += `
                    <!-- Card 3: Notes -->
                    <div class="content-card">
                        <h3 style="color: var(--primary, #667eea); margin-top: 0; margin-bottom: 10px; border-bottom: 2px solid #667eea; padding-bottom: 8px;"> Notes</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #e0e0e0;">
                            ${so.Notes}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalEditBtn').style.display = 'inline-block';
            document.getElementById('modalPrintBtn').style.display = 'inline-block';
            document.getElementById('modalPrintBtn').textContent = ' Print Invoice';
            document.getElementById('modalPrintBtn').onclick = () => printInvoice();
            document.getElementById('modalSaveBtn').style.display = 'none';
            document.getElementById('orderModal').style.display = 'block'; document.body.classList.add('modal-open');
        }
        
        function recordSalesPayment(soId, total, amountPaid) {
            let remaining = total - amountPaid;
            if (Math.abs(remaining) < 0.01) remaining = 0;
            
            // Create better formatted prompt
            let message = ` Record Payment for ${soId}\n\n`;
            message += `Invoice Total:    ${formatMoney(total)}\n`;
            message += `Already Paid:     ${formatMoney(amountPaid)}\n`;
            message += `\n`;
            message += `Balance Due:      ${formatMoney(remaining)}\n\n`;
            
            // Suggest full payment if unpaid
            if (amountPaid === 0) {
                message += `Tip: Enter ${remaining.toFixed(2)} to pay in full\n\n`;
            }
            
            message += `Enter payment amount:`;
            
            const payment = prompt(message);
            
            if (payment === null) return; // Cancelled
            
            const paymentAmount = parseFloat(payment);
            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                alert('Please enter a valid payment amount');
                return;
            }
            
            if (paymentAmount > remaining + 0.01) { // Allow 1 cent rounding
                if (!confirm(`Payment (${formatMoney(paymentAmount)}) is more than balance due (${formatMoney(remaining)}).\n\nContinue anyway?`)) {
                    return;
                }
            }
            
            // Call backend - send TOTAL amount paid (existing + new payment)
            const newTotalPaid = amountPaid + paymentAmount;
            apiCall('recordSalesPayment', { soId: soId, amountPaid: newTotalPaid })
                .then(result => {
                    if (result && result.status === 'success') {
                        const statusMsg = result.paymentStatus === 'Paid' ? ' PAID IN FULL!' : `Status: ${result.paymentStatus}`;
                        showStatus('salesStatus', ` Payment received! ${formatMoney(newTotalPaid)} total paid. ${statusMsg}`, 'success');
                        loadSales();
                    } else {
                        showStatus('salesStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                    }
                })
                .catch(err => {
                    showStatus('salesStatus', ' Error recording payment: ' + err.message, 'error');
                });
        }

        // ==================== INVENTORY ====================

        let inventoryData = []; // Cache for filtering
        
        async function loadInventory() {
            document.getElementById('inventoryTable').innerHTML = '<div class="loading">Loading inventory...</div>';
            
            // Load suppliers FIRST if not cached
            if (cachedSuppliers.length === 0) {
                const suppResult = await apiCall('getSuppliers');
                if (suppResult && suppResult.status === 'success') {
                    cachedSuppliers = suppResult.data;
                }
            }
            
            // Now load and display inventory
            const result = await apiCall('getInventoryReport');
            
            if (result && result.status === 'success') {
                inventoryData = result.data;
                // Filter out archived items by default
                const activeItems = result.data.filter(item => item.Status !== 'Archived');
                displayInventory(activeItems);
                loadInventoryFilterSuppliers(); // Populate filter dropdown
            } else {
                document.getElementById('inventoryTable').innerHTML = '<div class="loading">Error loading inventory</div>';
            }
        }
        
        async function loadInventoryFilterSuppliers() {
            if (cachedSuppliers.length === 0) {
                const result = await apiCall('getSuppliers');
                if (result && result.status === 'success') {
                    cachedSuppliers = result.data;
                }
            }
            
            const select = document.getElementById('filterInventorySupplier');
            select.innerHTML = '<option value="">All Suppliers</option>';
            cachedSuppliers.forEach(s => {
                select.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
            });
        }
        
        function filterInventory() {
            const searchFilter = document.getElementById('filterInventorySearch').value.toLowerCase();
            const supplierFilter = document.getElementById('filterInventorySupplier').value;
            const stockFilter = document.getElementById('filterInventoryStock').value;
            
            const filtered = inventoryData.filter(item => {
                // Hide archived items in inventory view
                if (item.Status === 'Archived') return false;
                
                // Search filter
                const matchesSearch = !searchFilter || 
                    (item.SKU && item.SKU.toString().toLowerCase().includes(searchFilter)) ||
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(searchFilter));
                
                // Supplier filter - use matchesFilter for multi-select support
                const matchesSupplier = matchesFilter(item.Supplier_ID, supplierFilter);
                
                // Stock status filter - calculate dynamically based on qty vs reorder point
                let matchesStock = true;
                if (stockFilter) {
                    const qty = parseFloat(item.Qty_On_Hand) || 0;
                    const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                    
                    if (stockFilter === 'negative') matchesStock = qty < 0;
                    else if (stockFilter === 'out') matchesStock = qty === 0;
                    else if (stockFilter === 'low') matchesStock = qty > 0 && qty <= reorderPoint;
                    else if (stockFilter === 'ok') matchesStock = qty > reorderPoint;
                }
                
                return matchesSearch && matchesSupplier && matchesStock;
            });
            
            displayInventory(filtered);
        }
        
        function clearInventoryFilters() {
            document.getElementById('filterInventorySearch').value = '';
            document.getElementById('filterInventorySupplier').value = '';
            document.getElementById('filterInventoryStock').value = '';
            // Filter out archived items by default
            displayInventory(inventoryData.filter(item => item.Status !== 'Archived'));
        }
        
        function filterInventoryByStatus(status, event) {
            // Prevent scroll jump
            if (event) event.preventDefault();
            
            // Save scroll position
            const scrollPos = window.scrollY;
            
            // Set the dropdown to match
            const stockDropdown = document.getElementById('filterInventoryStock');
            if (stockDropdown) stockDropdown.value = status;
            
            // Use the unified filter function that respects ALL filters
            filterInventory();
            
            // Restore scroll position after render
            setTimeout(() => window.scrollTo(0, scrollPos), 0);
        }

        function displayInventory(items) {
            if (!items || items.length === 0) {
                document.getElementById('inventoryTable').innerHTML = '<p>No inventory yet.</p>';
                return;
            }

            // Calculate totals FIRST for summary
            let totalQty = 0;
            let totalCostValue = 0;
            let totalSellValue = 0;
            let negativeCount = 0;
            let outOfStockCount = 0;
            let lowStockCount = 0;
            let inStockCount = 0;
            
            items.forEach(item => {
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPackage;
                const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                
                totalQty += qty;
                // Use absolute value - negative inventory still has positive value
                totalCostValue += Math.abs(qty) * unitCost;
                totalSellValue += Math.abs(qty) * unitSellPrice;
                
                if (qty < 0) negativeCount++;
                else if (qty === 0) outOfStockCount++;
                else if (qty <= reorderPoint) lowStockCount++;
                else inStockCount++;
            });
            
            // BUILD STATUS TAGS FIRST (clickable filters) - above summary boxes
            let html = `
                <div class="data-display-card">
                    <!-- Oval Filter Buttons -->
                    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 20px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${negativeCount > 0 ? `<span onclick="filterInventoryByStatus('negative', event)" class="oval-filter-btn" style="background: #b71c1c; color: white; padding: 8px 15px; border-radius: 20px; border: 3px solid #b71c1c; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"> ${negativeCount} Negative</span>` : ''}
                            ${outOfStockCount > 0 ? `<span onclick="filterInventoryByStatus('out', event)" class="oval-filter-btn" style="background: #c62828; color: white; padding: 8px 15px; border-radius: 20px; border: 3px solid #c62828; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"> ${outOfStockCount} Out of Stock</span>` : ''}
                            ${lowStockCount > 0 ? `<span onclick="filterInventoryByStatus('low', event)" class="oval-filter-btn" style="background: #ef6c00; color: white; padding: 8px 15px; border-radius: 20px; border: 3px solid #ef6c00; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"> ${lowStockCount} Low Stock</span>` : ''}
                            <span onclick="filterInventoryByStatus('ok', event)" class="oval-filter-btn" style="background: #2e7d32; color: white; padding: 8px 15px; border-radius: 20px; border: 3px solid #2e7d32; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"> ${inStockCount} In Stock</span>
                            <span onclick="filterInventoryByStatus('', event)" class="oval-filter-btn" style="background: #6c757d; color: white; padding: 8px 15px; border-radius: 20px; border: 3px solid #6c757d; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">Show All</span>
                        </div>
                    </div>
                    
                    <!-- Summary Boxes -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin: 20px 0;">
                        <div style="background: #f8f9fa; border: 2px solid #e0e0e0; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                            <div class="inv-summary-number" style="font-size: 28px; font-weight: bold; color: #212529; word-wrap: break-word; overflow-wrap: break-word;">${items.length}</div>
                            <div style="font-size: 13px; color: #6c757d;">Total Items</div>
                        </div>
                        <div style="background: #f8f9fa; border: 2px solid #e0e0e0; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                            <div class="inv-summary-number" style="font-size: 28px; font-weight: bold; color: #212529; word-wrap: break-word; overflow-wrap: break-word;">${totalQty.toLocaleString()}</div>
                            <div style="font-size: 13px; color: #6c757d;">Total Units</div>
                        </div>
                        <div style="background: #f8f9fa; border: 2px solid #e0e0e0; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                            <div class="inv-summary-number" style="font-size: 28px; font-weight: bold; color: #dc3545; word-wrap: break-word; overflow-wrap: break-word;">$${totalCostValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div style="font-size: 13px; color: #6c757d;">Cost Value</div>
                        </div>
                        <div style="background: #f8f9fa; border: 2px solid #e0e0e0; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                            <div class="inv-summary-number" style="font-size: 28px; font-weight: bold; color: #28a745; word-wrap: break-word; overflow-wrap: break-word;">$${totalSellValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div style="font-size: 13px; color: #6c757d;">Sell Value</div>
                        </div>
                        <div style="background: #f8f9fa; border: 2px solid #e0e0e0; color: #495057; padding: 20px; border-radius: 12px; text-align: center;">
                            <div class="inv-summary-number" style="font-size: 28px; font-weight: bold; color: ${(totalSellValue - totalCostValue) >= 0 ? '#1565c0' : '#c62828'}; word-wrap: break-word; overflow-wrap: break-word;">$${(totalSellValue - totalCostValue).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div style="font-size: 13px; color: #6c757d;">Net Profit</div>
                        </div>
                    </div>
            `;
            
            // BUILD TABLE
            html += '<table class="data-table" id="inventoryDataTable"><thead><tr>';
            html += '<th>SKU</th><th>Description</th><th>Supplier</th><th>Qty</th><th>Reorder</th><th>Cost</th><th>Sell</th><th>Cost Value</th><th>Sell Value</th><th>Net Profit</th><th>Updated</th><th>Status</th>';
            html += '</tr></thead><tbody>';

            items.forEach(item => {
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const reorderPoint = parseFloat(item.Reorder_Point) || 0;
                const lastUpdated = item.Last_Updated ? new Date(item.Last_Updated).toLocaleDateString() : '-';
                
                // Calculate values
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPackage;
                const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                // Use absolute value - negative inventory still has positive value
                const costValue = Math.abs(qty) * unitCost;
                const sellValue = Math.abs(qty) * unitSellPrice;
                const netProfit = sellValue - costValue;
                
                // Determine status with color coding
                let status = '';
                let statusStyle = '';
                let rowStyle = '';
                
                if (qty < 0) {
                    status = 'NEGATIVE';
                    statusStyle = 'background: #b71c1c; color: white;';
                    rowStyle = 'background: #ffcdd2;';
                } else if (qty === 0) {
                    status = 'OUT OF STOCK';
                    statusStyle = 'background: #c62828; color: white;';
                    rowStyle = 'background: #ffebee;';
                } else if (qty <= reorderPoint) {
                    status = 'LOW STOCK';
                    statusStyle = 'background: #ef6c00; color: white;';
                    rowStyle = 'background: #fff3e0;';
                } else {
                    status = 'IN STOCK';
                    statusStyle = 'background: #2e7d32; color: white;';
                }
                
                html += `<tr style="${rowStyle} cursor: pointer;" onclick="openItem('${item.Item_ID}')" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                    <td><strong>${item.SKU || '-'}</strong></td>
                    <td style="color: #667eea;"><strong>${item.Item_Description}</strong></td>
                    <td>${getSupplierName(item.Supplier_ID)}</td>
                    <td><strong style="${qty < 0 ? 'color: #b71c1c;' : ''}">${qty}</strong></td>
                    <td>${reorderPoint}</td>
                    <td>$${unitCost.toFixed(3)}</td>
                    <td>${formatMoney(unitSellPrice)}</td>
                    <td>${formatMoney(costValue)}</td>
                    <td style="color: #2e7d32; font-weight: bold;">${formatMoney(sellValue)}</td>
                    <td style="color: ${netProfit >= 0 ? '#1565c0' : '#c62828'}; font-weight: bold;">${formatMoney(netProfit)}</td>
                    <td style="font-size: 13px; color: #666;">${lastUpdated}</td>
                    <td><span style="${statusStyle} padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap;">${status}</span></td>
                </tr>`;
            });

            html += '</tbody></table>';
            html += '</div>'; // Close data-display-card
            document.getElementById('inventoryTable').innerHTML = html;
            setTimeout(() => makeSortable('inventoryDataTable'), 0);
        }
        
        // ==================== PRICE SIMULATOR ====================
        
        let pricesimItems = [];
        let pricesimFiltered = [];
        let simulatedNewItems = []; // Track new items added for simulation
        
        // New Item Simulation Functions
        function calcNewSimUnitCost() {
            const packageCost = parseFloat(document.getElementById('newSimPackageCost').value) || 0;
            const unitsPerPkg = parseFloat(document.getElementById('newSimUnitsPerPkg').value) || 1;
            const unitCost = packageCost / unitsPerPkg;
            document.getElementById('newSimUnitCost').value = '$' + unitCost.toFixed(2);
            calcNewSimSellPrice();
        }
        
        function calcNewSimSellPrice() {
            const packageCost = parseFloat(document.getElementById('newSimPackageCost').value) || 0;
            const unitsPerPkg = parseFloat(document.getElementById('newSimUnitsPerPkg').value) || 1;
            const markup = parseFloat(document.getElementById('newSimMarkup').value) || 0;
            const unitCost = packageCost / unitsPerPkg;
            const sellPrice = unitCost * (1 + markup / 100);
            document.getElementById('newSimSellPrice').value = '$' + sellPrice.toFixed(2);
        }
        
        function clearNewSimForm() {
            document.getElementById('newSimSupplier').value = '';
            document.getElementById('newSimSKU').value = '';
            document.getElementById('newSimDescription').value = '';
            document.getElementById('newSimPackageCost').value = '';
            document.getElementById('newSimUnitsPerPkg').value = '1';
            document.getElementById('newSimMarkup').value = '30';
            document.getElementById('newSimUnitCost').value = '$0.00';
            document.getElementById('newSimSellPrice').value = '$0.00';
        }
        
        function addNewItemToSimulation() {
            const supplierId = document.getElementById('newSimSupplier').value;
            const sku = document.getElementById('newSimSKU').value.trim();
            const description = document.getElementById('newSimDescription').value.trim();
            const packageCost = parseFloat(document.getElementById('newSimPackageCost').value) || 0;
            const unitsPerPkg = parseFloat(document.getElementById('newSimUnitsPerPkg').value) || 1;
            const markup = parseFloat(document.getElementById('newSimMarkup').value) || 0;
            
            // Validation with alerts
            if (!supplierId) {
                alert('Please select a supplier');
                return false;
            }
            if (!description) {
                alert('Please enter a description');
                return false;
            }
            if (packageCost <= 0) {
                alert('Please enter a package cost greater than 0');
                return false;
            }
            
            const unitCost = packageCost / unitsPerPkg;
            const sellPrice = unitCost * (1 + markup / 100);
            
            // Create a simulated item object
            const newItem = {
                Item_ID: 'NEW_' + Date.now(), // Temporary ID
                Supplier_ID: supplierId,
                SKU: sku || 'NEW',
                Item_Description: description,
                Package_Cost: packageCost,
                Units_Per_Package: unitsPerPkg,
                Unit_Sell_Price: sellPrice,
                Qty_On_Hand: 0,
                Reorder_Point: 0,
                isNew: true, // Flag to identify new items
                markup: markup
            };
            
            // Initialize arrays if needed
            if (!simulatedNewItems) simulatedNewItems = [];
            if (!pricesimItems) pricesimItems = [];
            if (!pricesimFiltered) pricesimFiltered = [];
            
            simulatedNewItems.push(newItem);
            pricesimItems.push(newItem);
            pricesimFiltered = [...pricesimItems];
            
            displayPriceSimItems();
            clearNewSimForm();
            
            showStatus('pricesimStatus', ` Added "${description}" to simulation. ${simulatedNewItems.length} new item(s) pending.`, 'success');
            
            // Scroll to show the table
            document.getElementById('pricesimTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            return false;
        }
        
        function removeSimulatedItem(tempId) {
            simulatedNewItems = simulatedNewItems.filter(item => item.Item_ID !== tempId);
            pricesimItems = pricesimItems.filter(item => item.Item_ID !== tempId);
            pricesimFiltered = pricesimFiltered.filter(item => item.Item_ID !== tempId);
            displayPriceSimItems();
            showStatus('pricesimStatus', `Removed item. ${simulatedNewItems.length} new item(s) pending.`, 'info');
        }
        
        async function saveNewItemsToDatabase() {
            if (simulatedNewItems.length === 0) {
                alert('No new items to save!');
                return;
            }
            
            if (!confirm(`Save ${simulatedNewItems.length} new item(s) to your database?`)) {
                return;
            }
            
            showStatus('pricesimStatus', ' Saving new items...', 'info');
            
            let savedCount = 0;
            for (const item of simulatedNewItems) {
                const result = await apiCall('addItem', {
                    supplierId: item.Supplier_ID,
                    sku: item.SKU,
                    description: item.Item_Description,
                    purchaseUOM: 'Each',
                    unitsPerPackage: item.Units_Per_Package,
                    packageCost: item.Package_Cost,
                    unitSellPrice: item.Unit_Sell_Price,
                    qtyOnHand: 0,
                    reorderPoint: 0
                });
                if (result?.status === 'success') savedCount++;
            }
            
            simulatedNewItems = [];
            showStatus('pricesimStatus', ` Saved ${savedCount} new items to database!`, 'success');
            
            // Reload to get fresh data with real IDs
            await loadPriceSimItems();
        }
        
        async function loadPriceSimItems() {
            showStatus('pricesimStatus', ' Loading items...', 'info');
            document.getElementById('pricesimTable').innerHTML = '<div class="loading">Loading items...</div>';
            
            try {
                // Load suppliers for filter
                if (cachedSuppliers.length === 0) {
                    const suppResult = await apiCall('getSuppliers');
                    if (suppResult?.status === 'success') cachedSuppliers = suppResult.data;
                }
                
                // Populate both supplier dropdowns
                const supplierSelect = document.getElementById('pricesimSupplier');
                const newSimSupplier = document.getElementById('newSimSupplier');
                
                if (supplierSelect) {
                    supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
                    cachedSuppliers.forEach(s => {
                        supplierSelect.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                    });
                }
                
                if (newSimSupplier) {
                    newSimSupplier.innerHTML = '<option value="">Select Supplier</option>';
                    cachedSuppliers.forEach(s => {
                        newSimSupplier.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                    });
                }
                
                // Load items
                const result = await apiCall('getItems');
                if (result?.status === 'success' && result.data && result.data.length > 0) {
                    pricesimItems = result.data;
                    // Add any simulated new items back
                    simulatedNewItems.forEach(item => {
                        pricesimItems.push(item);
                    });
                    pricesimFiltered = [...pricesimItems];
                    displayPriceSimItems();
                    showStatus('pricesimStatus', ` Loaded ${pricesimItems.length} items (${simulatedNewItems.length} new)`, 'success');
                } else {
                    document.getElementById('pricesimTable').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No items found. Add items in the Items tab first.</p>';
                    showStatus('pricesimStatus', ' No items found in database', 'info');
                }
            } catch (error) {
                console.error('Price Sim load error:', error);
                showStatus('pricesimStatus', ' Error loading items: ' + error.message, 'error');
            }
        }
        
        function filterPriceSimItems() {
            const search = document.getElementById('pricesimSearch').value.toLowerCase();
            const supplier = document.getElementById('pricesimSupplier').value;
            const stock = document.getElementById('pricesimStock').value;
            
            pricesimFiltered = pricesimItems.filter(item => {
                const matchSearch = !search || 
                    (item.SKU && item.SKU.toString().toLowerCase().includes(search)) ||
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(search));
                // Use matchesFilter for multi-select support
                const matchSupplier = matchesFilter(item.Supplier_ID, supplier);
                
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const reorder = parseFloat(item.Reorder_Point) || 0;
                let matchStock = true;
                if (stock === 'instock') matchStock = qty > 0 && !item.isNew;
                else if (stock === 'low') matchStock = qty > 0 && qty <= reorder && !item.isNew;
                else if (stock === 'out') matchStock = qty <= 0 && !item.isNew;
                else if (stock === 'new') matchStock = item.isNew === true;
                
                return matchSearch && matchSupplier && matchStock;
            });
            
            displayPriceSimItems();
        }
        
        function displayPriceSimItems() {
            const percent = parseFloat(document.getElementById('pricesimPercent').value) || 0;
            const flat = parseFloat(document.getElementById('pricesimFlat').value) || 0;
            
            // Debug info
            console.log('Price Sim Display - pricesimFiltered:', pricesimFiltered?.length, 'pricesimItems:', pricesimItems?.length);
            
            if (!pricesimFiltered || pricesimFiltered.length === 0) {
                if (!pricesimItems || pricesimItems.length === 0) {
                    document.getElementById('pricesimTable').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No items loaded yet. Click  Refresh to load items.</p>';
                } else {
                    document.getElementById('pricesimTable').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No items match your current filters. Try clearing the filters.</p>';
                }
                return;
            }
            
            // FIX #8: Show new items notification at TOP before table
            let html = '';
            if (simulatedNewItems.length > 0) {
                html += `
                    <div style="margin-bottom: 15px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 2px solid #ff9800;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <strong style="color: #e65100;"> ${simulatedNewItems.length} New Item(s) Ready to Save</strong>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">These items are only in simulation. Click to add them to your database.</p>
                            </div>
                            <button class="btn" onclick="if(event && debounceButton(event.currentTarget)) saveNewItemsToDatabase()" style="background: #ff9800;">
                                 Save ${simulatedNewItems.length} New Item(s) to Database
                            </button>
                        </div>
                    </div>
                `;
            }
            
            html += `
                <table class="data-table" id="pricesimDataTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;"></th>
                            <th>SKU</th>
                            <th>Description</th>
                            <th>Supplier</th>
                            <th>Unit Cost</th>
                            <th>Current Sell</th>
                            <th>NEW Sell</th>
                            <th>Change</th>
                            <th>Current Margin</th>
                            <th>NEW Margin</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            pricesimFiltered.forEach((item, idx) => {
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPkg = parseFloat(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPkg;
                const currentSell = parseFloat(item.Unit_Sell_Price) || 0;
                
                // Calculate new price
                let newSell = currentSell;
                if (!item.isNew) {
                    // Only apply bulk adjustment to existing items
                    if (percent > 0) {
                        newSell = currentSell * (1 + percent / 100);
                    } else if (flat > 0) {
                        newSell = currentSell + flat;
                    }
                }
                newSell = Math.round(newSell * 100) / 100; // Round to cents
                
                const change = newSell - currentSell;
                const currentMargin = currentSell > 0 ? ((currentSell - unitCost) / currentSell * 100) : 0;
                const newMargin = newSell > 0 ? ((newSell - unitCost) / newSell * 100) : 0;
                
                const hasChange = change > 0 || item.isNew;
                const isNew = item.isNew === true;
                const rowStyle = isNew ? 'background: #fff3e0;' : '';
                
                html += `
                    <tr style="${rowStyle}">
                        <td>
                            ${isNew ? 
                                `<button class="btn-delete-icon" onclick="removeSimulatedItem('${item.Item_ID}')" title="Remove"></button>` : 
                                `<input type="checkbox" class="pricesim-check" data-idx="${idx}" data-itemid="${item.Item_ID}" data-newprice="${newSell}" data-isnew="${isNew}" onchange="updatePriceSimSummary()" ${hasChange ? 'checked' : ''}>`
                            }
                        </td>
                        <td>
                            ${isNew ? '<span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 5px;">NEW</span>' : ''}
                            <strong>${item.SKU || '-'}</strong>
                        </td>
                        <td>${item.Item_Description}</td>
                        <td>${getSupplierName(item.Supplier_ID)}</td>
                        <td>${formatMoney(unitCost)}</td>
                        <td>${isNew ? '-' : '$' + currentSell.toFixed(2)}</td>
                        <td style="color: #28a745; font-weight: bold;">${formatMoney(newSell)}</td>
                        <td style="color: ${hasChange ? '#28a745' : '#666'};">${isNew ? `+${item.markup || 0}% markup` : (hasChange ? '+$' + change.toFixed(2) : '-')}</td>
                        <td>${isNew ? '-' : currentMargin.toFixed(1) + '%'}</td>
                        <td style="color: #28a745; font-weight: bold;">${newMargin.toFixed(1)}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            document.getElementById('pricesimTable').innerHTML = html;
            
            // Make table sortable
            setTimeout(() => makeSortable('pricesimDataTable'), 0);
            
            updatePriceSimSummary();
        }
        
        // Revenue Impact Calculator
        function updateRevenueCalc() {
            calculateRevenueImpact();
        }
        
        function calculateRevenueImpact() {
            const saleAmount = parseFloat(document.getElementById('revCalcSaleAmount').value) || 100;
            const percent = parseFloat(document.getElementById('revCalcPercent').value) || 0;
            
            // Update percent label
            document.getElementById('revCalcPercentLabel').textContent = percent + '%';
            
            // Calculate values
            const afterAmount = saleAmount * (1 + percent / 100);
            const extraProfit = afterAmount - saleAmount;
            
            // Update display
            document.getElementById('revCalcBefore').textContent = '$' + saleAmount.toFixed(2);
            document.getElementById('revCalcAfter').textContent = '$' + afterAmount.toFixed(2);
            document.getElementById('revCalcProfit').textContent = '+$' + extraProfit.toFixed(2);
            
            // Projected impact (assuming 10 sales per week)
            const weekly = extraProfit * 10;
            const monthly = extraProfit * 40;
            const yearly = extraProfit * 520;
            
            document.getElementById('revCalc10Sales').textContent = '+$' + weekly.toFixed(0) + '/week';
            document.getElementById('revCalcMonthly').textContent = '+$' + monthly.toFixed(0) + '/month';
            document.getElementById('revCalcYearly').textContent = '+$' + yearly.toLocaleString() + '/year';
        }
        
        // Initialize revenue calculator on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById('revCalcSaleAmount')) {
                calculateRevenueImpact();
            }
        });
        
        function previewPriceChanges() {
            displayPriceSimItems();
            document.getElementById('pricesimSummary').style.display = 'block';
        }
        
        // Helper functions to clear one when the other is used
        function clearFlatAmount() {
            document.getElementById('pricesimFlat').value = '0';
        }
        
        function clearPercentAmount() {
            document.getElementById('pricesimPercent').value = '0';
            updatePercentLabel();
        }
        
        function updatePercentLabel() {
            const value = document.getElementById('pricesimPercent').value;
            document.getElementById('pricesimPercentLabel').textContent = value + '%';
        }
        
        function toggleAllPriceSimItems() {
            const selectAll = document.getElementById('pricesimSelectAll').checked;
            document.querySelectorAll('.pricesim-check').forEach(cb => {
                cb.checked = selectAll;
            });
            updatePriceSimSummary();
        }
        
        function updatePriceSimSummary() {
            const checkboxes = document.querySelectorAll('.pricesim-check:checked');
            const percent = parseFloat(document.getElementById('pricesimPercent').value) || 0;
            const flat = parseFloat(document.getElementById('pricesimFlat').value) || 0;
            
            let selectedCount = 0;
            let currentRevenue = 0;
            let newRevenue = 0;
            
            // For inventory impact calculation
            let currentInvValue = 0;
            let newInvValue = 0;
            let itemsWithStock = 0;
            
            checkboxes.forEach(cb => {
                const idx = parseInt(cb.dataset.idx);
                const item = pricesimFiltered[idx];
                if (!item) return;
                
                const qty = parseFloat(item.Qty_On_Hand) || 0;
                const currentSell = parseFloat(item.Unit_Sell_Price) || 0;
                
                let newSell = currentSell;
                if (percent > 0) {
                    newSell = currentSell * (1 + percent / 100);
                } else if (flat > 0) {
                    newSell = currentSell + flat;
                }
                
                selectedCount++;
                // Use absolute value - negative inventory still represents positive revenue
                currentRevenue += Math.abs(qty) * currentSell;
                newRevenue += Math.abs(qty) * newSell;
                
                // Calculate inventory impact for items with stock
                if (qty > 0) {
                    itemsWithStock++;
                    currentInvValue += qty * currentSell;
                    newInvValue += qty * newSell;
                }
            });
            
            const increase = newRevenue - currentRevenue;
            const invProfit = newInvValue - currentInvValue;
            
            document.getElementById('simSelectedCount').textContent = selectedCount;
            document.getElementById('simCurrentRevenue').textContent = '$' + currentRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('simNewRevenue').textContent = '$' + newRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('simIncrease').textContent = '+$' + increase.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('applyCount').textContent = selectedCount;
            
            // Update inventory impact section
            document.getElementById('simCurrentInvValue').textContent = '$' + currentInvValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('simNewInvValue').textContent = '$' + newInvValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('simInvProfit').textContent = '+$' + invProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // Show/hide sections
            const applySection = document.getElementById('pricesimApplySection');
            const summarySection = document.getElementById('pricesimSummary');
            const invImpactSection = document.getElementById('pricesimInventoryImpact');
            
            if (selectedCount > 0 && (percent > 0 || flat > 0)) {
                applySection.style.display = 'block';
                summarySection.style.display = 'block';
                // Show inventory impact if there are items with stock
                invImpactSection.style.display = itemsWithStock > 0 ? 'block' : 'none';
            } else {
                applySection.style.display = 'none';
                invImpactSection.style.display = 'none';
            }
        }
        
        async function applyPriceChanges() {
            const checkboxes = document.querySelectorAll('.pricesim-check:checked');
            const count = checkboxes.length;
            
            if (count === 0) {
                alert('No items selected!');
                return;
            }
            
            if (!confirm(`Are you sure you want to update the sell price for ${count} items?\n\nThis will modify your database.`)) {
                return;
            }
            
            showStatus('pricesimStatus', ` Updating ${count} items...`, 'info');
            
            // Collect updates
            const updates = [];
            checkboxes.forEach(cb => {
                updates.push({
                    itemId: cb.dataset.itemid,
                    newPrice: parseFloat(cb.dataset.newprice)
                });
            });
            
            // Send to backend
            const result = await apiCall('bulkUpdateSellPrices', { updates });
            
            if (result?.status === 'success') {
                showStatus('pricesimStatus', ` Successfully updated ${count} items! Screen refreshed with new prices.`, 'success');
                
                // FIX #10: RESET ALL CONTROLS TO PREVENT DOUBLE-APPLY
                // Reset percentage slider
                document.getElementById('pricesimPercent').value = '0';
                updatePercentLabel();
                
                // Reset flat amount
                document.getElementById('pricesimFlat').value = '0';
                
                // Uncheck "Select All"
                document.getElementById('pricesimSelectAll').checked = false;
                
                // Uncheck all individual items
                document.querySelectorAll('.pricesim-check').forEach(cb => {
                    cb.checked = false;
                });
                
                // Hide apply section
                document.getElementById('pricesimApplySection').style.display = 'none';
                document.getElementById('pricesimSummary').style.display = 'none';
                document.getElementById('pricesimInventoryImpact').style.display = 'none';
                
                // Reload items to show new prices
                await loadPriceSimItems();
                
                // Show prominent warning message
                setTimeout(() => {
                    showStatus('pricesimStatus', ' Prices updated successfully! Controls have been reset. Adjust settings before applying again.', 'success');
                }, 100);
            } else {
                showStatus('pricesimStatus', ' Error: ' + (result?.message || 'Failed to update'), 'error');
            }
        }
        
        // ==================== MANUAL INVENTORY ADJUSTMENT ====================
        
        async function showAdjustInventoryForm() {
            // ALWAYS load fresh inventory data from database
            showStatus('inventoryStatus', 'Loading current inventory...', 'info');
            const result = await apiCall('getInventoryReport');
            
            if (result && result.status === 'success') {
                cachedItems = result.data;
                
                // Clear fields
                document.getElementById('adjustItemDisplay').value = '';
                document.getElementById('adjustItem').value = '';
                document.getElementById('adjustCurrentQty').value = '';
                document.getElementById('adjustNewQty').value = '';
                document.getElementById('adjustQuantity').value = '';
                
                document.getElementById('adjustInventoryForm').style.display = 'block';
                showStatus('inventoryStatus', '', '');
            } else {
                showStatus('inventoryStatus', ' Error loading inventory', 'error');
            }
        }
        
        // Open item picker for inventory adjustment
        function openItemPickerForAdjustment() {
            window.adjustmentPickerActive = true;
            window.itemPickerIsFilter = false; // Reset filter mode
            window.itemPickerSupplierContext = ''; // No supplier context for adjustments
            window.itemPickerCallback = {
                tagName: 'ADJUSTMENT_FORM',
                value: document.getElementById('adjustItem').value
            };
            
            // Show supplier filter
            const supplierFilterDiv = document.getElementById('itemPickerSupplierFilter');
            if (supplierFilterDiv) {
                supplierFilterDiv.style.display = 'block';
            }
            
            // Populate supplier filter
            const supplierSelect = document.getElementById('itemPickerSupplier');
            supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
            if (cachedSuppliers && cachedSuppliers.length > 0) {
                cachedSuppliers.forEach(s => {
                    supplierSelect.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                });
            }
            
            // Get items from cache
            window.itemPickerItems = cachedItems || [];
            
            // Clear search
            document.getElementById('itemPickerSearch').value = '';
            document.getElementById('itemPickerSupplier').value = '';
            
            // Render items
            renderItemPickerList();
            
            // Show modal
            document.getElementById('itemPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Focus search - only on desktop to prevent mobile keyboard popup
            document.activeElement?.blur();
            focusOnDesktop('itemPickerSearch');
        }
        
        function onAdjustItemSelected() {
            const itemId = document.getElementById('adjustItem').value;
            if (itemId) {
                const item = cachedItems.find(i => i.Item_ID === itemId);
                if (item) {
                    const currentQty = parseInt(item.Qty_On_Hand) || 0;
                    document.getElementById('adjustCurrentQty').value = currentQty;
                    document.getElementById('adjustItemDisplay').value = `${item.SKU} - ${item.Item_Description}`;
                    updateAdjustNewQty();
                }
            }
        }
        
        function updateAdjustNewQty() {
            const currentQty = parseInt(document.getElementById('adjustCurrentQty').value) || 0;
            const adjustment = parseInt(document.getElementById('adjustQuantity').value) || 0;
            const newQty = currentQty + adjustment;
            
            document.getElementById('adjustNewQty').value = newQty;
            
            // Color code the new quantity
            const newQtyInput = document.getElementById('adjustNewQty');
            if (newQty < 0) {
                newQtyInput.style.background = '#ffebee';
                newQtyInput.style.color = '#c62828';
            } else if (adjustment < 0) {
                newQtyInput.style.background = '#fff3e0';
                newQtyInput.style.color = '#ef6c00';
            } else {
                newQtyInput.style.background = '#e8f5e9';
                newQtyInput.style.color = '#2e7d32';
            }
        }
        
        // (Removed old adjustItemResults click handler - now uses card picker)
        
        function hideAdjustInventoryForm() {
            document.getElementById('adjustInventoryForm').style.display = 'none';
            document.querySelector('#adjustInventoryForm form').reset();
            document.getElementById('adjustCurrentQty').value = '';
            document.getElementById('adjustNewQty').value = '';
            document.getElementById('adjustItemDisplay').value = '';
            document.getElementById('adjustItem').value = '';
            document.getElementById('adjustReasonDisplay').value = '';
            document.getElementById('adjustReason').value = '';
            // Reset reason field styling
            document.getElementById('adjustReasonDisplay').style.borderColor = '#f39c12';
            document.getElementById('adjustReasonDisplay').style.background = '#fff';
            
            // Check if we should return to a report (e.g., Action Dashboard)
            if (returnToReport) {
                const reportToOpen = returnToReport;
                returnToReport = null; // Clear it so we don't loop
                // Delay to allow user to see any success/status messages
                setTimeout(() => {
                    showReport(reportToOpen);
                }, 800);
            }
        }
        
        function updateAdjustmentCalc() {
            const itemId = document.getElementById('adjustItem').value;
            
            if (itemId) {
                const item = cachedItems.find(i => i.Item_ID === itemId);
                const currentQty = item ? parseInt(item.Qty_On_Hand) : 0;
                const adjustment = parseInt(document.getElementById('adjustQuantity').value) || 0;
                const newQty = currentQty + adjustment;
                
                document.getElementById('adjustCurrentQty').value = currentQty;
                document.getElementById('adjustNewQty').value = newQty;
                
                // Color code the new quantity
                const newQtyInput = document.getElementById('adjustNewQty');
                if (newQty < 0) {
                    newQtyInput.style.background = '#ffebee';
                    newQtyInput.style.color = '#c62828';
                } else if (newQty < currentQty) {
                    newQtyInput.style.background = '#fff3e0';
                } else {
                    newQtyInput.style.background = '#e8f5e9';
                }
            }
        }
        
        async function submitInventoryAdjustment(e) {
            e.preventDefault();
            
            const itemId = document.getElementById('adjustItem').value;
            const adjustment = parseInt(document.getElementById('adjustQuantity').value);
            const currentQty = parseInt(document.getElementById('adjustCurrentQty').value);
            const newQty = parseInt(document.getElementById('adjustNewQty').value);
            const reason = document.getElementById('adjustReason').value;
            const notes = document.getElementById('adjustNotes').value;
            
            // Validation - Item is required
            if (!itemId) {
                alert(' Please select an item to adjust.');
                return;
            }
            
            // Validation - Reason is required
            if (!reason || reason.trim() === '') {
                alert(' Please select a reason for this adjustment.');
                document.getElementById('adjustReasonDisplay').focus();
                return;
            }
            
            // Validation - Adjustment amount is required
            if (isNaN(adjustment) || adjustment === 0) {
                alert(' Please enter an adjustment amount (positive or negative).');
                document.getElementById('adjustQuantity').focus();
                return;
            }
            
            if (newQty < 0) {
                if (!confirm(`Warning: This will set inventory to ${newQty} (NEGATIVE).\n\nAre you sure?`)) {
                    return;
                }
            }
            
            // Confirm the adjustment
            const item = cachedItems.find(i => i.Item_ID === itemId);
            const confirmMsg = `Adjust ${item.Item_Description}?\n\nCurrent: ${currentQty}\nAdjustment: ${adjustment > 0 ? '+' : ''}${adjustment}\nNew Total: ${newQty}\n\nReason: ${reason}`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            const data = {
                itemId: itemId,
                quantity: adjustment,  // Backend expects 'quantity' not 'adjustment'
                adjustmentType: 'Manual',
                reason: reason + (notes ? ' - ' + notes : ''),
                user: 'Manual'
            };
            
            console.log(' Submitting inventory adjustment:', data);
            
            const result = await apiCall('adjustInventory', data);
            
            console.log(' Adjustment result:', result);
            
            if (result && result.status === 'success') {
                showStatus('inventoryStatus', ` Inventory adjusted! ${item.Item_Description}: ${currentQty}  ${newQty}`, 'success');
                
                // Refresh cached items to get updated quantities
                const itemsResult = await apiCall('getItems');
                if (itemsResult && itemsResult.status === 'success') {
                    cachedItems = itemsResult.data;
                }
                
                // Note: hideAdjustInventoryForm will handle returning to report if returnToReport is set
                hideAdjustInventoryForm();
                loadInventory();
            } else {
                showStatus('inventoryStatus', ' Error: ' + (result?.message || 'Unknown error'), 'error');
                console.error('Adjustment failed:', result);
            }
        }
        
        // ==================== REPORTS ====================
        
        let currentReport = null;
        let reportData = {};
        let rawReportData = {}; // Store unfiltered data for re-filtering
        let reportFilters = {}; // Store current filter values
        let returnToReport = null; // Store report to return to after action (e.g., from Action Dashboard)
        
        // Helper: Build filter UI HTML
        function buildFilterUI(reportType, options = {}) {
            const filterId = `filter-panel-${reportType}`;
            let html = '<div style="background: #f0f0f0; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;"> Filters</h4>
                    <button class="btn-small" onclick="toggleFilters('${filterId}')" style="background: var(--primary, #667eea); color: white; border-left: 3px solid rgba(255,255,255,0.4); opacity: 0.85;">
                        <span id="${filterId}-toggle"> Hide</span>
                    </button>
                </div>`;
            html += `<div id="${filterId}" class="form-grid">`;
            
            // Date Range (common to most reports)
            if (options.dateRange) {
                const dateLabel = options.dateLabel || 'Date';
                html += `
                    <div class="form-group">
                        <label>${dateLabel} From</label>
                        <input type="date" id="filter_fromDate" value="${reportFilters.fromDate || ''}">
                    </div>
                    <div class="form-group">
                        <label>${dateLabel} To</label>
                        <input type="date" id="filter_toDate" value="${reportFilters.toDate || ''}">
                    </div>`;
            }
            
            // Customer dropdown
            if (options.customer) {
                html += `
                    <div class="form-group">
                        <label>Customer</label>
                        <select id="filter_customer">
                            <option value="">All Customers</option>
                            ${options.customerList.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>`;
            }
            
            // Supplier dropdown
            if (options.supplier) {
                html += `
                    <div class="form-group">
                        <label>Supplier</label>
                        <select id="filter_supplier">
                            <option value="">All Suppliers</option>
                            ${options.supplierList.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                        </select>
                    </div>`;
            }
            
            // Item dropdown
            if (options.item) {
                html += `
                    <div class="form-group">
                        <label>Product</label>
                        <select id="filter_item">
                            <option value="">All Products</option>
                            ${options.itemList.map(i => `<option value="${i.id}">${i.name}</option>`).join('')}
                        </select>
                    </div>`;
            }
            
            // Payment Status
            if (options.paymentStatus) {
                html += `
                    <div class="form-group">
                        <label>Payment Status</label>
                        <select id="filter_paymentStatus">
                            <option value="">All</option>
                            <option value="Paid">Paid</option>
                            <option value="Partial">Partial</option>
                            <option value="Unpaid">Unpaid</option>
                            <option value="Overdue">Overdue</option>
                        </select>
                    </div>`;
            }
            
            // Stock Status
            if (options.stockStatus) {
                html += `
                    <div class="form-group">
                        <label>Stock Status</label>
                        <select id="filter_stockStatus">
                            <option value="">All Items</option>
                            <option value="negative"> Negative Inventory</option>
                            <option value="out"> Out of Stock</option>
                            <option value="low"> Low Stock</option>
                            <option value="ok"> In Stock</option>
                        </select>
                    </div>`;
            }
            
            // Turnover Status
            if (options.turnoverStatus) {
                html += `
                    <div class="form-group">
                        <label>Movement</label>
                        <select id="filter_turnoverStatus">
                            <option value="">All</option>
                            <option value="Fast">Fast Movers</option>
                            <option value="Normal">Normal</option>
                            <option value="Slow">Slow Movers</option>
                        </select>
                    </div>`;
            }
            
            // Aging Filter (for AR/AP)
            if (options.aging) {
                html += `
                    <div class="form-group">
                        <label>Aging</label>
                        <select id="filter_aging">
                            <option value="">All</option>
                            <option value="Current">Current</option>
                            <option value="1-30">1-30 days</option>
                            <option value="31-60">31-60 days</option>
                            <option value="60+">60+ days</option>
                        </select>
                    </div>`;
            }
            
            // Minimum Amount
            if (options.minAmount) {
                html += `
                    <div class="form-group">
                        <label>Min Amount ($)</label>
                        <input type="number" id="filter_minAmount" step="0.01" placeholder="0.00">
                    </div>`;
            }
            
            html += `
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn" onclick="applyReportFilters('${reportType}')"> Apply Filters</button>
                    <button class="btn btn-secondary" onclick="clearReportFilters('${reportType}')"> Clear Filters</button>
                </div>
            </div>`;
            html += '</div>';
            
            return html;
        }
        
        // Apply filters to current report
        async function applyReportFilters(reportType) {
            // Capture filter values
            reportFilters = {
                fromDate: document.getElementById('filter_fromDate')?.value || '',
                toDate: document.getElementById('filter_toDate')?.value || '',
                customer: document.getElementById('filter_customer')?.value || '',
                supplier: document.getElementById('filter_supplier')?.value || '',
                item: document.getElementById('filter_item')?.value || '',
                paymentStatus: document.getElementById('filter_paymentStatus')?.value || '',
                stockStatus: document.getElementById('filter_stockStatus')?.value || '',
                turnoverStatus: document.getElementById('filter_turnoverStatus')?.value || '',
                aging: document.getElementById('filter_aging')?.value || '',
                minAmount: parseFloat(document.getElementById('filter_minAmount')?.value) || 0
            };
            
            // Re-render report with filters
            await showReport(reportType);
        }
        
        // Clear all filters
        function clearReportFilters(reportType) {
            reportFilters = {};
            showReport(reportType);
        }
        
        // Toggle filter panel visibility
        function toggleFilters(panelId) {
            const panel = document.getElementById(panelId);
            const toggle = document.getElementById(`${panelId}-toggle`);
            
            if (panel.style.display === 'none') {
                panel.style.display = 'grid';
                toggle.textContent = ' Hide';
            } else {
                panel.style.display = 'none';
                toggle.textContent = ' Show';
            }
        }
        
        // Universal table sorting function
        function sortTable(tableId, columnIndex) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determine sort direction
            const header = table.querySelectorAll('th')[columnIndex];
            const currentDir = header.dataset.sortDir || 'asc';
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';
            
            // Clear all header indicators
            table.querySelectorAll('th').forEach(th => {
                th.style.cursor = 'pointer';
                th.dataset.sortDir = '';
                th.innerHTML = th.innerHTML.replace(' ', '').replace(' ', '');
            });
            
            // Sort rows
            rows.sort((a, b) => {
                // Safety checks for undefined cells
                const aCell = a.cells[columnIndex];
                const bCell = b.cells[columnIndex];
                
                if (!aCell || !bCell) return 0;
                
                // Check for data-sort attribute first (for dates)
                const aSortVal = aCell.dataset.sort;
                const bSortVal = bCell.dataset.sort;
                
                if (aSortVal !== undefined && bSortVal !== undefined) {
                    // Use data-sort values for comparison
                    if (!aSortVal && !bSortVal) return 0;
                    if (!aSortVal) return 1;
                    if (!bSortVal) return -1;
                    return newDir === 'asc' 
                        ? aSortVal.localeCompare(bSortVal)
                        : bSortVal.localeCompare(aSortVal);
                }
                
                const aCellText = (aCell.textContent || '').trim();
                const bCellText = (bCell.textContent || '').trim();
                
                // Handle empty cells
                if (!aCellText && !bCellText) return 0;
                if (!aCellText) return 1;
                if (!bCellText) return -1;
                
                // Try numeric comparison first
                const aNum = parseFloat(aCellText.replace(/[$,]/g, ''));
                const bNum = parseFloat(bCellText.replace(/[$,]/g, ''));
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return newDir === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // Try date comparison
                const aDate = new Date(aCellText);
                const bDate = new Date(bCellText);
                if (!isNaN(aDate.getTime()) && !isNaN(bDate.getTime()) && aCellText.match(/\d/)) {
                    return newDir === 'asc' ? aDate - bDate : bDate - aDate;
                }
                
                // String comparison
                return newDir === 'asc' 
                    ? aCellText.localeCompare(bCellText)
                    : bCellText.localeCompare(aCellText);
            });
            
            // Update table
            rows.forEach(row => tbody.appendChild(row));
            
            // Update header
            header.dataset.sortDir = newDir;
            header.innerHTML += newDir === 'asc' ? ' ' : ' ';
        }
        
        // Make table sortable
        function makeSortable(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                header.style.cursor = 'pointer';
                header.style.userSelect = 'none';
                header.onclick = () => sortTable(tableId, index);
                header.title = 'Click to sort';
            });
        }
        
        async function showReport(reportType) {
            // Mobile debugging - show what's happening
            console.log(' showReport called with:', reportType);
            
            // Open the report setup modal instead of running immediately
            try {
                openReportSetup(reportType);
            } catch (e) {
                alert(' Error opening report setup: ' + e.message);
                console.error('Error in showReport:', e);
            }
        }
        
        // Report configuration for each report type
        const reportConfig = {
            'action-dashboard': {
                title: ' Action Dashboard',
                filters: [], // No filters needed - shows all critical actions
                noFilters: true, // Skip setup and go directly to report
                dateLabel: '',
                description: {
                    purpose: 'View all critical business issues that need immediate attention in one place.',
                    insights: [
                        'Past due customer payments that need follow-up',
                        'Pending deliveries that need to be scheduled or completed',
                        'Items that are running low and need to be reordered',
                        'Purchase orders waiting to be received'
                    ]
                }
            },
            'customer-backorders': {
                title: ' Customer Backorders',
                filters: ['customer', 'supplier'],
                noFilters: true, // Skip setup and go directly to report
                dateLabel: '',
                description: {
                    purpose: 'View items on backorder for customers and create POs to fulfill those orders.',
                    insights: [
                        'See which customers are waiting for products',
                        'Create POs for just the backorder quantity (not up to reorder point)',
                        'Ideal for discontinuing items - only order what\'s needed to fulfill existing orders',
                        'Consolidated view across all customers needing the same product'
                    ]
                }
            },
            'business-overview': {
                title: ' Business Overview',
                filters: ['dateRange', 'topN'],
                dateLabel: 'Date Range',
                description: {
                    purpose: 'Get a high-level snapshot of your business performance with key metrics and trends.',
                    insights: [
                        'Total sales, purchases, and profit for the period',
                        'Top selling products and best customers',
                        'Revenue trends and growth indicators',
                        'Quick health check of your business'
                    ]
                }
            },
            'sales-by-customer': {
                title: ' Sales by Customer',
                filters: ['quickDateOnly', 'customer', 'minAmount', 'transactionStatus'],
                dateLabel: 'Sale Date',
                description: {
                    purpose: 'Analyze sales performance grouped by customer to understand your revenue sources.',
                    insights: [
                        'Which customers generate the most revenue',
                        'Customer purchasing patterns and frequency',
                        'Identify your VIP customers for better service',
                        'Spot customers who may need attention or follow-up'
                    ]
                }
            },
            'sales-order-detail': {
                title: ' Sales Order Detail',
                filters: ['quickDateOnly', 'customer', 'paymentStatus', 'transactionStatus'],
                dateLabel: 'Sale Date',
                description: {
                    purpose: 'View detailed information on all sales orders with line items and payment status.',
                    insights: [
                        'Complete order history with all items sold',
                        'Payment status and amounts due per order',
                        'Delivery status tracking',
                        'Drill down into any order for full details'
                    ]
                }
            },
            'sales-by-product': {
                title: ' Sales by Item',
                filters: ['quickDateOnly', 'item', 'transactionStatus'],
                dateLabel: 'Sale Date',
                description: {
                    purpose: 'Analyze which products are selling best and their revenue contribution.',
                    insights: [
                        'Best and worst selling products',
                        'Revenue and quantity sold by product',
                        'Identify opportunities to promote slow movers',
                        'Track seasonal product trends'
                    ]
                }
            },
            'pick-list': {
                title: ' Inventory Pick List',
                filters: ['dateRange', 'customer', 'salesInvoice', 'deliveryStatus'],
                dateLabel: 'Date Range',
                description: {
                    purpose: 'Generate a consolidated list of items to pick from your warehouse for pending deliveries.',
                    insights: [
                        'See all items needed across multiple orders in one organized list',
                        'Group picks by customer or route for efficient warehouse picking',
                        'Track delivery status and prioritize urgent orders',
                        'Print pick sheets to take to the warehouse floor'
                    ]
                }
            },
            'dormant-customers': {
                title: ' Dormant Customers',
                filters: ['dormantDays'],
                dateLabel: 'Dormancy Threshold',
                description: {
                    purpose: 'Identify customers who haven\'t ordered recently so you can reach out and win back their business.',
                    insights: [
                        'See customers sorted by how long since their last order',
                        'View their last purchase details to personalize your outreach',
                        'Understand buying patterns and average order values',
                        'Get addresses and contact info for sales calls or visits'
                    ]
                }
            },
            'purchase-order-detail': {
                title: ' Purchase Order Detail',
                filters: ['quickDateOnly', 'supplier', 'poType', 'paymentStatus', 'transactionStatus'],
                dateLabel: 'PO Date',
                description: {
                    purpose: 'View all purchase orders with complete details including items, costs, and status.',
                    insights: [
                        'Track what you\'ve ordered from each supplier',
                        'See payment status and amounts owed',
                        'Monitor expected delivery dates',
                        'View line item details for each order'
                    ]
                }
            },
            'purchase-by-supplier': {
                title: ' Purchase by Supplier',
                filters: ['quickDateOnly', 'supplier', 'poType', 'transactionStatus'],
                dateLabel: 'PO Date',
                description: {
                    purpose: 'Analyze your purchasing patterns grouped by supplier.',
                    insights: [
                        'Total spend with each supplier',
                        'Compare supplier pricing and volume',
                        'Identify your key supplier relationships',
                        'Track ordering frequency by supplier'
                    ]
                }
            },
            'supplier-performance': {
                title: ' Supplier Performance',
                filters: ['dateRange', 'supplier'],
                dateLabel: 'Date Range',
                description: {
                    purpose: 'Evaluate supplier reliability based on delivery times and order fulfillment.',
                    insights: [
                        'On-time delivery rates by supplier',
                        'Average lead times and fulfillment rates',
                        'Identify reliable vs problematic suppliers',
                        'Data to support supplier negotiations'
                    ]
                }
            },
            'inventory-turnover': {
                title: ' Inventory Turnover',
                filters: ['dateRange', 'supplier'],
                dateLabel: 'Analysis Period',
                description: {
                    purpose: 'Measure how quickly your inventory sells and identify slow-moving items.',
                    insights: [
                        'Turnover rate for each product',
                        'Days of supply remaining',
                        'Fast movers vs dead stock',
                        'Optimize inventory investment'
                    ]
                }
            },
            'gross-margin': {
                title: ' Gross Margin',
                filters: ['supplier', 'stockStatus'],
                dateLabel: '',
                description: {
                    purpose: 'Analyze profitability by comparing your cost vs selling price for each item.',
                    insights: [
                        'Profit margin percentage by product',
                        'Most and least profitable items',
                        'Identify pricing opportunities',
                        'Compare margins across suppliers'
                    ]
                }
            },
            'accounts-receivable': {
                title: ' Accounts Receivable',
                filters: ['customer', 'aging'],
                dateLabel: '',
                description: {
                    purpose: 'Track money owed to you by customers and aging of outstanding invoices.',
                    insights: [
                        'Total outstanding receivables',
                        'Aging breakdown (current, 30, 60, 90+ days)',
                        'Which customers owe you money',
                        'Prioritize collection efforts'
                    ]
                }
            },
            'accounts-payable': {
                title: ' Accounts Payable',
                filters: ['supplier', 'aging'],
                dateLabel: '',
                description: {
                    purpose: 'Track money you owe to suppliers and when payments are due.',
                    insights: [
                        'Total outstanding payables',
                        'Aging breakdown by due date',
                        'Plan cash flow for upcoming payments',
                        'Avoid late payment penalties'
                    ]
                }
            },
            'simple-inventory': {
                title: ' Inventory List',
                filters: ['supplier', 'stockStatus'],
                dateLabel: '',
                description: {
                    purpose: 'View your current inventory levels with stock status for all products.',
                    insights: [
                        'Current quantity on hand for each item',
                        'Items below reorder point',
                        'Quantities on order from suppliers',
                        'Quick inventory snapshot'
                    ]
                }
            },
            'inventory-adjustments': {
                title: ' Inventory Adjustment History',
                filters: ['quickDateOnly', 'item', 'adjustmentType'],
                dateLabel: 'Adjustment Date',
                description: {
                    purpose: 'Review all inventory adjustments made for auditing and tracking purposes.',
                    insights: [
                        'History of all inventory changes',
                        'Reasons for each adjustment',
                        'Track shrinkage and corrections',
                        'Audit trail for inventory accuracy'
                    ]
                }
            },
            'profit-loss': {
                title: ' Profit & Loss Statement',
                filters: ['yearSelect', 'quarterSelect', 'cogsMethod'],
                dateLabel: '',
                description: {
                    purpose: 'View your profit and loss statement with revenue, costs, and net income.',
                    insights: [
                        'Total revenue and cost of goods sold',
                        'Gross profit and net income',
                        'Monthly or quarterly breakdown',
                        'Compare performance across periods'
                    ]
                }
            },
            'annual-sales-summary': {
                title: ' Annual Sales Summary',
                filters: ['yearSelect'],
                dateLabel: '',
                description: {
                    purpose: 'Review your annual sales performance with monthly breakdown.',
                    insights: [
                        'Total sales for the year',
                        'Month-by-month sales trends',
                        'Seasonal patterns in your business',
                        'Year-over-year comparison data'
                    ]
                }
            },
            'annual-purchase-summary': {
                title: ' Annual Purchase Summary',
                filters: ['yearSelect'],
                dateLabel: '',
                description: {
                    purpose: 'Review your annual purchasing with monthly breakdown by supplier.',
                    insights: [
                        'Total purchases for the year',
                        'Monthly purchasing patterns',
                        'Supplier spending breakdown',
                        'Plan future purchasing needs'
                    ]
                }
            },
            'inventory-valuation': {
                title: ' Inventory Valuation',
                filters: ['supplier'],
                dateLabel: '',
                description: {
                    purpose: 'Calculate the total value of your current inventory at cost.',
                    insights: [
                        'Total inventory value on hand',
                        'Value breakdown by supplier',
                        'Identify high-value stock items',
                        'Data for financial reporting'
                    ]
                }
            },
            'cash-flow-summary': {
                title: ' Cash Flow Summary',
                filters: ['yearSelect', 'quarterSelect'],
                dateLabel: '',
                description: {
                    purpose: 'Track cash coming in from sales and going out for purchases.',
                    insights: [
                        'Cash received from customers',
                        'Cash paid to suppliers',
                        'Net cash flow for the period',
                        'Plan for cash needs'
                    ]
                }
            },
            'daily-dashboard': {
                title: ' Sales Dashboard',
                filters: ['quickDateOnly', 'customer'],
                dateLabel: 'Date',
                description: {
                    purpose: 'View today\'s sales activity and key performance indicators.',
                    insights: [
                        'Today\'s sales and orders',
                        'Comparison to daily average',
                        'Top products sold today',
                        'Quick daily performance check'
                    ]
                }
            },
            'product-dashboard': {
                title: ' Product Dashboard',
                filters: ['dateRange', 'item', 'topN'],
                dateLabel: 'Date Range',
                description: {
                    purpose: 'Deep dive into individual product performance with sales and inventory metrics.',
                    insights: [
                        'Product sales history and trends',
                        'Current stock levels and turnover',
                        'Profit margin analysis',
                        'Reorder recommendations'
                    ]
                }
            },
            'customer-dashboard': {
                title: ' Customer Dashboard',
                filters: ['customer', 'dateRange'],
                dateLabel: 'Date Range',
                customerRequired: true,
                description: {
                    purpose: 'View a complete profile of a customer including purchase history and account status.',
                    insights: [
                        'Customer purchase history and patterns',
                        'Account balance and payment history',
                        'Most purchased products',
                        'Customer lifetime value'
                    ]
                }
            },
            'supplier-dashboard': {
                title: ' Supplier Dashboard',
                filters: ['supplier', 'dateRange'],
                dateLabel: 'Date Range',
                supplierRequired: true,
                description: {
                    purpose: 'View a complete profile of a supplier including orders and performance metrics.',
                    insights: [
                        'Purchase history with supplier',
                        'Items supplied and pricing',
                        'Delivery performance',
                        'Account balance and payment status'
                    ]
                }
            }
        };
        
        function openReportSetup(reportType) {
            console.log(' openReportSetup called with:', reportType);
            currentReport = reportType;
            reportFilters = {}; // Reset filters
            
            // CRITICAL: Clear any existing content first
            document.getElementById('reportSetupContent').innerHTML = '';
            document.getElementById('reportSetupFilters').innerHTML = '';
            
            const config = reportConfig[reportType] || { title: 'Report', filters: [] };
            console.log(' Report config:', config);
            
            // If report has noFilters flag, show modal then generate directly
            if (config.noFilters) {
                // Set title
                document.getElementById('reportSetupTitle').textContent = config.title;
                
                // Clear filters area
                document.getElementById('reportSetupFilters').innerHTML = '';
                
                // Reset content area with loading message
                document.getElementById('reportSetupContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #888;">
                        <div style="font-size: 48px; margin-bottom: 15px;"></div>
                        <p>Loading...</p>
                    </div>`;
                
                // Show modal FIRST
                const modalElement = document.getElementById('reportSetupModal');
                modalElement.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                document.body.classList.add('modal-open');
                
                // Then execute report
                executeReport();
                return;
            }
            
            // Set title
            document.getElementById('reportSetupTitle').textContent = config.title;
            
            // Build filter UI
            let filterHtml = '';
            
            // Add collapsible wrapper for entire setup section
            filterHtml += `
                <div id="reportSetupToggle" onclick="toggleReportSetup()" style="
                    background: linear-gradient(135deg, var(--primary, #667eea) 0%, var(--secondary, #764ba2) 100%);
                    color: white;
                    padding: 10px 15px;
                    border-radius: 8px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin-bottom: 15px;
                    user-select: none;
                ">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <span class="setup-toggle-icon"></span>
                        <strong> Report Setup & Filters</strong>
                    </span>
                    <span style="font-size: 11px; opacity: 0.8;">tap to hide/show</span>
                </div>
                <div id="reportSetupCollapsible" style="display: block;">
            `;
            
            // Add report description/help section if available (collapsed by default on mobile)
            if (config.description) {
                filterHtml += `
                    <div class="report-help-section" style="margin-bottom: 15px;">
                        <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.help-toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                             style="
                                background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%);
                                border: 1px solid #c5d5f7;
                                border-radius: 8px;
                                padding: 10px 14px;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                user-select: none;
                            ">
                            <span class="help-toggle-icon"></span>
                            <span style="font-size: 18px;"></span>
                            <span style="font-weight: 600; color: #1a365d; font-size: 13px;">What This Report Does</span>
                            <span style="color: #666; font-size: 11px; margin-left: auto;">tap for details</span>
                        </div>
                        <div style="display: none; background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%); border: 1px solid #c5d5f7; border-top: none; border-radius: 0 0 8px 8px; padding: 12px 14px;">
                            <div style="color: #4a5568; font-size: 13px; line-height: 1.5; margin-bottom: 10px;">
                                ${config.description.purpose}
                            </div>
                            ${config.description.insights ? `
                                <div style="background: white; border-radius: 8px; padding: 10px 12px; border: 1px solid #e2e8f0;">
                                    <div style="font-weight: 600; color: #2d3748; font-size: 11px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">
                                         What You'll Learn
                                    </div>
                                    <ul style="margin: 0; padding-left: 16px; color: #4a5568; font-size: 12px; line-height: 1.5;">
                                        ${config.description.insights.map(insight => `<li>${insight}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            filterHtml += '<div class="form-grid" style="gap: 15px;">';
            
            // Date Range
            if (config.filters.includes('dateRange')) {
                // Don't set default dates - show ALL records by default
                // User can add filters if they want to narrow it down
                
                filterHtml += `
                    <div class="form-group">
                        <label> ${config.dateLabel || 'Date'} From</label>
                        <input type="date" id="rptFilter_fromDate" value="" placeholder="All dates">
                    </div>
                    <div class="form-group">
                        <label> ${config.dateLabel || 'Date'} To</label>
                        <input type="date" id="rptFilter_toDate" value="" placeholder="All dates">
                    </div>`;
            }
            
            // Quick Date Only - just hidden fields for Sales Dashboard
            if (config.filters.includes('quickDateOnly')) {
                filterHtml += `
                    <input type="hidden" id="rptFilter_fromDate" value="">
                    <input type="hidden" id="rptFilter_toDate" value="">`;
            }
            
            // Customer dropdown - use card picker
            if (config.filters.includes('customer')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Customer</label>
                        <input type="text" id="rptFilter_customer_display" placeholder=" Click to select customer..." 
                            onclick="openCustomerPickerForReport()" readonly 
                            style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_customer" value="">
                    </div>`;
            }
            
            // Supplier dropdown - use card picker
            if (config.filters.includes('supplier')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Supplier</label>
                        <input type="text" id="rptFilter_supplier_display" placeholder=" Click to select supplier..." 
                            onclick="openSupplierPickerForReport()" readonly 
                            style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_supplier" value="">
                    </div>`;
            }
            
            // Item/Product picker (smart search)
            if (config.filters.includes('item')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Item</label>
                        <input type="text" id="rptFilter_item_display" placeholder=" All Items (click to filter)" onclick="openItemPickerForReport()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_item" value="">
                    </div>`;
            }
            
            // Payment Status
            if (config.filters.includes('paymentStatus')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Payment Status</label>
                        <select id="rptFilter_paymentStatus">
                            <option value="">All</option>
                            <option value="Paid"> Paid</option>
                            <option value="Partial"> Partial</option>
                            <option value="Unpaid"> Unpaid</option>
                        </select>
                    </div>`;
            }
            
            // PO Type (Incoming/Outgoing)
            if (config.filters.includes('poType')) {
                filterHtml += `
                    <div class="form-group">
                        <label> PO Type</label>
                        <input type="text" id="rptFilter_poType_display" placeholder=" All Types (click to select)" onclick="openPOTypePicker()" readonly style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_poType" value="">
                    </div>`;
            }
            
            // Stock Status
            if (config.filters.includes('stockStatus')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Stock Status</label>
                        <select id="rptFilter_stockStatus">
                            <option value="">All Items</option>
                            <option value="negative"> Negative Inventory</option>
                            <option value="out"> Out of Stock</option>
                            <option value="low"> Low Stock</option>
                            <option value="ok"> In Stock</option>
                        </select>
                    </div>`;
            }
            
            // Top N Products
            if (config.filters.includes('topN')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Show Top/Bottom</label>
                        <select id="rptFilter_topN">
                            <option value="5">Top 5</option>
                            <option value="10" selected>Top 10</option>
                            <option value="15">Top 15</option>
                            <option value="20">Top 20</option>
                            <option value="25">Top 25</option>
                            <option value="50">Top 50</option>
                        </select>
                    </div>`;
            }
            
            // Turnover Status
            if (config.filters.includes('turnoverStatus')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Turnover</label>
                        <select id="rptFilter_turnoverStatus">
                            <option value="">All</option>
                            <option value="dead"> Dead Stock (0 sold)</option>
                            <option value="slow"> Slow Moving</option>
                            <option value="fast"> Fast Moving</option>
                        </select>
                    </div>`;
            }
            
            // Aging
            if (config.filters.includes('aging')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Aging</label>
                        <select id="rptFilter_aging">
                            <option value="">All</option>
                            <option value="current">Current (0-30 days)</option>
                            <option value="30">31-60 days</option>
                            <option value="60">61-90 days</option>
                            <option value="90">90+ days</option>
                        </select>
                    </div>`;
            }
            
            // Min Amount
            if (config.filters.includes('minAmount')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Min Amount</label>
                        <input type="number" id="rptFilter_minAmount" placeholder="0.00" min="0" step="0.01">
                    </div>`;
            }
            
            // Transaction Status (for filtering voided transactions)
            if (config.filters.includes('transactionStatus')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Transaction Status</label>
                        <select id="rptFilter_transactionStatus">
                            <option value="exclude-voided" selected> Exclude Voided</option>
                            <option value="">All Transactions</option>
                            <option value="Completed"> Completed Only</option>
                            <option value="Pending"> Pending Only</option>
                            <option value="Voided"> Voided Only</option>
                        </select>
                    </div>`;
            }
            
            // Delivery Status (for pick list)
            if (config.filters.includes('deliveryStatus')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Delivery Status</label>
                        <select id="rptFilter_deliveryStatus">
                            <option value="needs-delivery" selected> Needs Delivery (Pending/Ready/Out)</option>
                            <option value="">All Orders</option>
                            <option value="pending"> Pending Only</option>
                            <option value="ready"> Ready for Pickup Only</option>
                            <option value="out"> Out for Delivery Only</option>
                            <option value="delivered"> Delivered/Completed</option>
                        </select>
                    </div>`;
            }
            
            // Sales Invoice Search (for pick list) - Smart Lookup
            if (config.filters.includes('salesInvoice')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Sales Invoice #</label>
                        <input type="text" id="rptFilter_salesInvoice_display" placeholder=" Click to select invoice..." 
                            onclick="openInvoicePickerForReport()" readonly 
                            style="cursor: pointer; background: #fff;">
                        <input type="hidden" id="rptFilter_salesInvoice" value="">
                    </div>`;
            }
            
            // Dormant Days threshold (for dormant customers report)
            if (config.filters.includes('dormantDays')) {
                filterHtml += `
                    <div class="form-group" style="grid-column: span 2;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 15px; border: 2px solid #f59e0b;">
                                <label style="display: block; font-weight: 600; color: #92400e; margin-bottom: 8px; font-size: 14px;"> No Orders In Last...</label>
                                <select id="rptFilter_dormantDays" style="width: 100%; padding: 12px; border: 2px solid #f59e0b; border-radius: 8px; font-size: 15px; font-weight: 500; background: white; cursor: pointer;">
                                    <option value="14"> 2 Weeks (14 days)</option>
                                    <option value="30" selected> 1 Month (30 days)</option>
                                    <option value="60"> 2 Months (60 days)</option>
                                    <option value="90"> 3 Months (90 days)</option>
                                    <option value="180"> 6 Months (180 days)</option>
                                    <option value="365"> 1 Year (365 days)</option>
                                </select>
                            </div>
                            <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-radius: 12px; padding: 15px; border: 2px solid #6366f1;">
                                <label style="display: block; font-weight: 600; color: #4338ca; margin-bottom: 8px; font-size: 14px;"> Sort Results By</label>
                                <select id="rptFilter_dormantSort" style="width: 100%; padding: 12px; border: 2px solid #6366f1; border-radius: 8px; font-size: 15px; font-weight: 500; background: white; cursor: pointer;">
                                    <option value="days-desc"> Most Dormant First</option>
                                    <option value="days-asc"> Least Dormant First</option>
                                    <option value="city"> City (A-Z)</option>
                                    <option value="value-desc"> Highest Value First</option>
                                    <option value="orders-desc"> Most Orders First</option>
                                </select>
                            </div>
                        </div>
                    </div>`;
            }
            
            // Adjustment Type (for inventory adjustments report)
            if (config.filters.includes('adjustmentType')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Adjustment Type</label>
                        <select id="rptFilter_adjustmentType">
                            <option value="">All Types</option>
                            <option value="VOID REVERSAL"> Void Reversals</option>
                            <option value="Manual"> Manual Adjustments</option>
                            <option value="Sale"> Sales (Out)</option>
                            <option value="Purchase"> Purchases (In)</option>
                            <option value="OUTGOING"> Outgoing/Returns</option>
                        </select>
                    </div>`;
            }
            
            // Year Select (for tax reports)
            if (config.filters.includes('yearSelect')) {
                const currentYear = new Date().getFullYear();
                const years = [];
                for (let y = currentYear; y >= currentYear - 5; y--) {
                    years.push(y);
                }
                filterHtml += `
                    <div class="form-group">
                        <label> Year</label>
                        <select id="rptFilter_year">
                            ${years.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('')}
                        </select>
                    </div>`;
            }
            
            // Quarter Select (for tax reports)
            if (config.filters.includes('quarterSelect')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Period</label>
                        <select id="rptFilter_quarter">
                            <option value="annual">Full Year</option>
                            <option value="Q1">Q1 (Jan-Mar)</option>
                            <option value="Q2">Q2 (Apr-Jun)</option>
                            <option value="Q3">Q3 (Jul-Sep)</option>
                            <option value="Q4">Q4 (Oct-Dec)</option>
                        </select>
                    </div>`;
            }
            
            // COGS Method (for P&L report)
            if (config.filters.includes('cogsMethod')) {
                filterHtml += `
                    <div class="form-group">
                        <label> Cost of Goods Method</label>
                        <select id="rptFilter_cogsMethod">
                            <option value="actual">Actual Purchase Costs (from POs)</option>
                            <option value="standard">Standard Costs (from Items table)</option>
                        </select>
                    </div>`;
            }
            
            filterHtml += '</div>';
            
            // Add quick date presets if dateRange or quickDateOnly filter exists
            if (config.filters.includes('dateRange') || config.filters.includes('quickDateOnly')) {
                filterHtml += `
                    <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                        <span style="color: #666; font-size: 13px;">Quick Select:</span>
                        <div style="position: relative; display: inline-block;">
                            <button type="button" class="btn" onclick="event.stopPropagation(); toggleDatePresetPicker()" 
                                    style="padding: 8px 16px; font-size: 13px; display: flex; align-items: center; gap: 8px;">
                                <span></span>
                                <span id="datePresetLabel">Choose Period</span>
                                <span style="opacity: 0.7;"></span>
                            </button>
                            <div id="datePresetDropdown" style="display: none; position: absolute; top: 100%; left: 0; z-index: 10001; margin-top: 5px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); min-width: 180px; overflow: hidden;">
                                <div onclick="event.stopPropagation(); selectDatePreset('today', ' Today')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span></span> Today
                                </div>
                                <div onclick="event.stopPropagation(); selectDatePreset('week', ' This Week')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span></span> This Week
                                </div>
                                <div onclick="event.stopPropagation(); selectDatePreset('month', ' This Month')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span></span> This Month
                                </div>
                                <div onclick="event.stopPropagation(); selectDatePreset('quarter', ' This Quarter')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span></span> This Quarter
                                </div>
                                <div onclick="event.stopPropagation(); selectDatePreset('year', ' This Year')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span></span> This Year
                                </div>
                                <div onclick="event.stopPropagation(); selectDatePreset('all', ' All Time')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #eee;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                                    <span></span> All Time
                                </div>
                                <div onclick="event.stopPropagation(); selectDatePreset('clear', ' Clear Dates')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; background: #f8f9fa;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                    <span></span> <strong>Clear Dates</strong>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
            
            // Close the collapsible wrapper
            filterHtml += `</div>`;
            
            document.getElementById('reportSetupFilters').innerHTML = filterHtml;
            
            // Reset content area
            document.getElementById('reportSetupContent').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #888;">
                    <div style="font-size: 48px; margin-bottom: 15px;"></div>
                    <p>Configure filters above and click <strong>Run Report</strong></p>
                </div>`;
            
            // Show modal
            console.log(' About to show report setup modal...');
            const modalElement = document.getElementById('reportSetupModal');
            console.log(' Modal element:', modalElement ? 'Found' : 'NOT FOUND');
            
            if (!modalElement) {
                alert(' ERROR: Report modal element not found in DOM!');
                return;
            }
            
            modalElement.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            console.log(' Modal should now be visible');
        }
        
        function setDatePreset(preset) {
            const today = new Date();
            let fromDate = new Date();
            let toDate = new Date();
            
            switch(preset) {
                case 'today':
                    fromDate = today;
                    toDate = today;
                    break;
                case 'week':
                    fromDate.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
                    toDate = today;
                    break;
                case 'month':
                    fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    toDate = today;
                    break;
                case 'quarter':
                    const quarter = Math.floor(today.getMonth() / 3);
                    fromDate = new Date(today.getFullYear(), quarter * 3, 1);
                    toDate = today;
                    break;
                case 'year':
                    fromDate = new Date(today.getFullYear(), 0, 1);
                    toDate = today;
                    break;
                case 'all':
                case 'clear':
                    // For "All Time" or "Clear Dates", CLEAR the date filters completely
                    // This shows ALL records without any date filtering
                    const fromEl = document.getElementById('rptFilter_fromDate');
                    const toEl = document.getElementById('rptFilter_toDate');
                    if (fromEl) fromEl.value = '';
                    if (toEl) toEl.value = '';
                    console.log(' Dates cleared - will show all records');
                    return; // Exit early, don't set dates below
            }
            
            const fromEl = document.getElementById('rptFilter_fromDate');
            const toEl = document.getElementById('rptFilter_toDate');
            if (fromEl) fromEl.value = fromDate.toISOString().split('T')[0];
            if (toEl) toEl.value = toDate.toISOString().split('T')[0];
            console.log(' Date preset applied:', preset, 'From:', fromDate.toISOString().split('T')[0], 'To:', toDate.toISOString().split('T')[0]);
        }
        
        function toggleDatePresetPicker() {
            const dropdown = document.getElementById('datePresetDropdown');
            console.log(' Toggle dropdown clicked, dropdown element:', dropdown);
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                console.log(' Dropdown opened');
                // Close when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', closeDatePresetOnClickOutside);
                }, 10);
            } else {
                dropdown.style.display = 'none';
                console.log(' Dropdown closed');
            }
        }
        
        function closeDatePresetOnClickOutside(e) {
            const dropdown = document.getElementById('datePresetDropdown');
            if (!e.target.closest('#datePresetDropdown') && !e.target.closest('[onclick*="toggleDatePresetPicker"]')) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeDatePresetOnClickOutside);
            }
        }
        
        function selectDatePreset(preset, label) {
            console.log(' Date preset selected:', preset, label);
            // Update the button label
            const labelEl = document.getElementById('datePresetLabel');
            if (labelEl) {
                labelEl.textContent = label;
                console.log(' Button label updated to:', label);
            }
            // Close dropdown
            const dropdown = document.getElementById('datePresetDropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
                console.log(' Dropdown closed');
            }
            document.removeEventListener('click', closeDatePresetOnClickOutside);
            // Apply the preset
            setDatePreset(preset);
        }
        
        function closeReportSetup() {
            document.getElementById('reportSetupModal').style.display = 'none';
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open');
        }
        
        // Sort report table by column
        function sortReportTable(headerEl, colIndex) {
            const table = headerEl.closest('table');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const tfoot = table.querySelector('tfoot');
            if (!tbody) return;
            
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determine sort direction
            const currentDir = headerEl.dataset.sortDir || 'none';
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';
            
            // Reset all headers
            table.querySelectorAll('th').forEach(th => {
                th.dataset.sortDir = 'none';
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Set new direction
            headerEl.dataset.sortDir = newDir;
            headerEl.classList.add(newDir === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // Sort rows
            rows.sort((a, b) => {
                const aCell = a.cells[colIndex];
                const bCell = b.cells[colIndex];
                if (!aCell || !bCell) return 0;
                
                let aVal = aCell.textContent.trim();
                let bVal = bCell.textContent.trim();
                
                // Remove $ and , for numeric comparison
                const aNum = parseFloat(aVal.replace(/[$,%]/g, '').replace(/,/g, ''));
                const bNum = parseFloat(bVal.replace(/[$,%]/g, '').replace(/,/g, ''));
                
                // Check if both are numbers
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return newDir === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // String comparison
                return newDir === 'asc' 
                    ? aVal.localeCompare(bVal) 
                    : bVal.localeCompare(aVal);
            });
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }
        
        // Add sort styles to document
        (function addSortStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .sortable-header {
                    cursor: pointer;
                    user-select: none;
                    position: relative;
                    padding-right: 20px !important;
                }
                .sortable-header:hover {
                    background: rgba(0,0,0,0.1) !important;
                }
                .sortable-header::after {
                    content: '';
                    position: absolute;
                    right: 5px;
                    opacity: 0.4;
                    font-size: 12px;
                }
                .sortable-header.sort-asc::after {
                    content: '';
                    opacity: 1;
                }
                .sortable-header.sort-desc::after {
                    content: '';
                    opacity: 1;
                }
            `;
            document.head.appendChild(style);
        })();
        
        // Make all tables in report content sortable
        function makeReportTablesSortable() {
            const content = document.getElementById('reportSetupContent');
            if (!content) return;
            
            content.querySelectorAll('table.data-table thead th').forEach((th, idx) => {
                // Skip if already sortable
                if (th.classList.contains('sortable-header')) return;
                
                th.classList.add('sortable-header');
                th.onclick = function() { sortReportTable(this, idx); };
            });
        }
        
        // Print report in-place (no new window)
        function printReport() {
            const content = document.getElementById('reportSetupContent');
            const title = document.getElementById('reportSetupTitle').textContent;
            
            if (!content.innerHTML || content.innerHTML.includes('Configure filters')) {
                alert('Please run the report first before printing.');
                return;
            }
            
            // Convert all canvas charts to images for printing
            const canvases = content.querySelectorAll('canvas');
            canvases.forEach((canvas) => {
                try {
                    // Check if already converted
                    if (canvas.dataset.printConverted) return;
                    
                    const imgData = canvas.toDataURL('image/png');
                    const img = document.createElement('img');
                    img.src = imgData;
                    img.className = 'print-chart-image';
                    img.style.maxWidth = '100%';
                    img.style.height = 'auto';
                    img.style.display = 'none'; // Hidden on screen, shown in print
                    
                    // Insert image after canvas
                    canvas.parentNode.insertBefore(img, canvas.nextSibling);
                    canvas.dataset.printConverted = 'true';
                } catch(e) {
                    console.warn('Could not convert chart to image:', e);
                }
            });
            
            // Add print class to body for CSS targeting
            document.body.classList.add('printing-report');
            
            // Store the title for print header
            document.body.dataset.printTitle = title.replace(/^[^\w]+/, '');
            
            // Trigger print
            window.print();
            
            // Remove print class after a delay
            setTimeout(() => {
                document.body.classList.remove('printing-report');
            }, 1000);
        }
        
        // Helper to get current theme colors for printing
        function getCurrentThemeColors() {
            const root = document.documentElement;
            const styles = getComputedStyle(root);
            return {
                primary: styles.getPropertyValue('--primary').trim() || '#667eea',
                secondary: styles.getPropertyValue('--secondary').trim() || '#764ba2',
                text: styles.getPropertyValue('--text-dark').trim() || '#333333'
            };
        }
        
        // Email report
        function emailReport() {
            const title = document.getElementById('reportSetupTitle').textContent;
            const content = document.getElementById('reportSetupContent');
            
            if (!content.innerHTML || content.innerHTML.includes('Configure filters')) {
                alert('Please run the report first before emailing.');
                return;
            }
            
            const companyName = document.getElementById('invoiceCompanyName')?.value || 'Nowak Distributing';
            
            // Extract text content for email body
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content.innerHTML;
            const textContent = tempDiv.innerText.substring(0, 1500) + '...';
            
            const subject = encodeURIComponent(`${title} - ${companyName} - ${new Date().toLocaleDateString()}`);
            const body = encodeURIComponent(`${title}\n${companyName}\nGenerated: ${new Date().toLocaleString()}\n\n${textContent}\n\n---\nFull report available in the ERP system.`);
            
            window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
        }
        
        // Text/SMS report
        function textReport() {
            const title = document.getElementById('reportSetupTitle').textContent;
            const content = document.getElementById('reportSetupContent');
            
            if (!content.innerHTML || content.innerHTML.includes('Configure filters')) {
                alert('Please run the report first before texting.');
                return;
            }
            
            const companyName = document.getElementById('invoiceCompanyName')?.value || 'Nowak Distributing';
            
            // Extract key numbers for SMS
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content.innerHTML;
            const textContent = tempDiv.innerText.substring(0, 250);
            
            const message = encodeURIComponent(`${companyName}\n${title}\n${new Date().toLocaleDateString()}\n\n${textContent}...`);
            
            // Try SMS on mobile, fallback to prompt
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                window.open(`sms:?body=${message}`, '_blank');
            } else {
                const phone = prompt('Enter phone number to text:');
                if (phone) {
                    window.open(`sms:${phone}?body=${message}`, '_blank');
                }
            }
        }
        
        // Save report as PDF (print to PDF)
        function saveReportPDF() {
            const content = document.getElementById('reportSetupContent');
            
            if (!content.innerHTML || content.innerHTML.includes('Configure filters')) {
                alert('Please run the report first before saving.');
                return;
            }
            
            alert(' Tip: Use the Print button and select "Save as PDF" as your printer to save this report.');
            printReport();
        }
        
        // Toggle report setup section visibility
        function toggleReportSetup() {
            const collapsible = document.getElementById('reportSetupCollapsible');
            const toggleIcon = document.querySelector('.setup-toggle-icon');
            if (collapsible) {
                const isHidden = collapsible.style.display === 'none';
                collapsible.style.display = isHidden ? 'block' : 'none';
                if (toggleIcon) toggleIcon.textContent = isHidden ? '' : '';
            }
        }
        
        async function executeReport() {
            console.log(' executeReport called for:', currentReport);
            
            // CRITICAL: Destroy all existing charts before generating new ones
            destroyAllCharts();
            
            // AUTO-COLLAPSE the setup section when running report (especially helpful on mobile)
            const collapsible = document.getElementById('reportSetupCollapsible');
            const toggleIcon = document.querySelector('.setup-toggle-icon');
            if (collapsible) {
                collapsible.style.display = 'none';
                if (toggleIcon) toggleIcon.textContent = '';
            }
            
            // Gather filter values
            reportFilters = {
                fromDate: document.getElementById('rptFilter_fromDate')?.value || '',
                toDate: document.getElementById('rptFilter_toDate')?.value || '',
                customer: document.getElementById('rptFilter_customer')?.value || '',
                supplier: document.getElementById('rptFilter_supplier')?.value || '',
                item: document.getElementById('rptFilter_item')?.value || '',
                paymentStatus: document.getElementById('rptFilter_paymentStatus')?.value || '',
                poType: document.getElementById('rptFilter_poType')?.value || '',
                stockStatus: document.getElementById('rptFilter_stockStatus')?.value || '',
                topN: parseInt(document.getElementById('rptFilter_topN')?.value) || 10,
                turnoverStatus: document.getElementById('rptFilter_turnoverStatus')?.value || '',
                aging: document.getElementById('rptFilter_aging')?.value || '',
                minAmount: parseFloat(document.getElementById('rptFilter_minAmount')?.value) || 0,
                year: document.getElementById('rptFilter_year')?.value || new Date().getFullYear(),
                quarter: document.getElementById('rptFilter_quarter')?.value || 'annual',
                cogsMethod: document.getElementById('rptFilter_cogsMethod')?.value || 'actual',
                transactionStatus: document.getElementById('rptFilter_transactionStatus')?.value || 'exclude-voided',
                adjustmentType: document.getElementById('rptFilter_adjustmentType')?.value || '',
                deliveryStatus: document.getElementById('rptFilter_deliveryStatus')?.value || 'needs-delivery',
                salesInvoice: document.getElementById('rptFilter_salesInvoice')?.value?.trim() || '',
                dormantDays: parseInt(document.getElementById('rptFilter_dormantDays')?.value) || 30,
                dormantSort: document.getElementById('rptFilter_dormantSort')?.value || 'days-desc'
            };
            
            console.log(' Report filters:', reportFilters);
            
            const container = document.getElementById('reportSetupContent');
            
            // CRITICAL: Clear any existing content completely
            container.innerHTML = '';
            
            // Show loading
            container.innerHTML = '<div style="padding: 40px; text-align: center;"><div style="font-size: 24px; margin-bottom: 10px;"></div>Generating report...</div>';
            
            // Scroll to top of content area on mobile
            container.scrollTop = 0;
            
            try {
                console.log(' About to generate report:', currentReport);
                let reportHtml = '';
                
                switch(currentReport) {
                    case 'sales-by-customer':
                        reportHtml = await generateSalesByCustomerModal();
                        break;
                    case 'sales-order-detail':
                        reportHtml = await generateSalesOrderDetailModal();
                        break;
                    case 'sales-by-product':
                        reportHtml = await generateSalesByProductModal();
                        break;
                    case 'pick-list':
                        reportHtml = await generatePickListModal();
                        break;
                    case 'dormant-customers':
                        reportHtml = await generateDormantCustomersModal();
                        break;
                    case 'purchase-order-detail':
                        reportHtml = await generatePurchaseOrderDetailModal();
                        break;
                    case 'purchase-by-supplier':
                        reportHtml = await generatePurchaseBySupplierModal();
                        break;
                    case 'supplier-performance':
                        reportHtml = await generateSupplierPerformanceModal();
                        break;
                    case 'inventory-turnover':
                        reportHtml = await generateInventoryTurnoverModal();
                        break;
                    case 'gross-margin':
                        reportHtml = await generateGrossMarginModal();
                        break;
                    case 'accounts-receivable':
                        reportHtml = await generateAccountsReceivableModal();
                        break;
                    case 'accounts-payable':
                        reportHtml = await generateAccountsPayableModal();
                        break;
                    case 'simple-inventory':
                        reportHtml = await generateSimpleInventoryModal();
                        break;
                    case 'inventory-adjustments':
                        reportHtml = await generateInventoryAdjustmentsModal();
                        break;
                    case 'profit-loss':
                        reportHtml = await generateProfitLossModal();
                        break;
                    case 'annual-sales-summary':
                        reportHtml = await generateAnnualSalesSummaryModal();
                        break;
                    case 'annual-purchase-summary':
                        reportHtml = await generateAnnualPurchaseSummaryModal();
                        break;
                    case 'inventory-valuation':
                        reportHtml = await generateInventoryValuationModal();
                        break;
                    case 'cash-flow-summary':
                        reportHtml = await generateCashFlowSummaryModal();
                        break;
                    case 'action-dashboard':
                        reportHtml = await generateActionDashboard();
                        break;
                    case 'customer-backorders':
                        reportHtml = await generateCustomerBackordersModal();
                        break;
                    case 'daily-dashboard':
                        reportHtml = await generateDailyDashboardModal();
                        break;
                    case 'business-overview':
                        reportHtml = await generateBusinessOverviewModal();
                        break;
                    case 'product-dashboard':
                        reportHtml = await generateProductDashboardModal();
                        break;
                    case 'customer-dashboard':
                        if (!reportFilters.customer) {
                            throw new Error('Please select a customer first');
                        }
                        reportHtml = await generateCustomerDashboardModal();
                        break;
                    case 'supplier-dashboard':
                        if (!reportFilters.supplier) {
                            throw new Error('Please select a supplier first');
                        }
                        reportHtml = await generateSupplierDashboardModal();
                        break;
                }
                
                // CRITICAL: Clear container completely first
                container.innerHTML = '';
                
                // Small delay to ensure DOM is clear
                await new Promise(resolve => setTimeout(resolve, 50));
                
                container.innerHTML = reportHtml;
                
                // Remove all script tags - we'll use a different approach
                const scripts = container.querySelectorAll('script');
                const scriptContents = [];
                scripts.forEach(script => {
                    scriptContents.push(script.textContent);
                    script.remove();
                });
                
                // Execute chart scripts ONCE with a single timeout
                // Clear any previous chart init timeout
                if (window.chartInitTimeout) {
                    clearTimeout(window.chartInitTimeout);
                }
                
                window.chartInitTimeout = setTimeout(() => {
                    scriptContents.forEach(content => {
                        try {
                            // Remove the setTimeout wrapper from the content if present
                            let cleanContent = content;
                            // Execute the content directly (the setTimeout inside will fire once)
                            const fn = new Function(cleanContent);
                            fn();
                        } catch(e) {
                            console.warn('Chart init error:', e);
                        }
                    });
                }, 200);
                
                // Make tables sortable
                makeReportTablesSortable();
                
            } catch (error) {
                container.innerHTML = `<div style="padding: 40px; text-align: center; color: red;"><div style="font-size: 24px; margin-bottom: 10px;"></div>Error: ${error.message}</div>`;
            }
        }
        
        // Modal versions of report generators that return HTML instead of writing to reportContainer
        async function generateSalesByCustomerModal() {
            const salesResult = await apiCall('getSalesOrders');
            const customersResult = await apiCall('getCustomers');
            const itemsResult = await apiCall('getItems');
            
            if (!salesResult?.data || !customersResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const customers = customersResult.data;
            const items = itemsResult.data;
            let sales = salesResult.data;
            
            // Apply transaction status filter to sales orders first
            const statusFilter = reportFilters.transactionStatus || 'exclude-voided';
            if (statusFilter === 'exclude-voided') {
                sales = sales.filter(s => s.Status !== 'Voided');
            } else if (statusFilter && statusFilter !== '') {
                sales = sales.filter(s => s.Status === statusFilter);
            }
            
            // Fetch ALL sales order lines
            const allDetails = [];
            for (const so of sales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const unitsPerPackage = parseFloat(item?.Units_Per_Package) || 1;
                        const packageCost = parseFloat(item?.Package_Cost) || 0;
                        const unitCost = packageCost / unitsPerPackage;
                        const quantity = parseInt(line.Quantity || 0);
                        // Calculate line total from qty * price (Line_Total may not exist)
                        const unitPrice = parseFloat(line.Unit_Price) || 0;
                        const lineTotal = quantity * unitPrice;
                        const lineCost = quantity * unitCost;
                        
                        allDetails.push({
                            soId: so.SO_ID,
                            soDate: so.Sale_Date || so.SO_Date,
                            customerId: so.Customer_ID,
                            customerName: getCustomerName(so.Customer_ID),
                            itemId: line.Item_ID,
                            itemDescription: item?.Item_Description || line.Item_ID,
                            quantity: quantity,
                            lineTotal: lineTotal,
                            lineCost: lineCost,
                            profit: lineTotal - lineCost
                        });
                    });
                }
            }
            
            // Helper function to parse dates in various formats
            function parseFlexibleDate(dateVal) {
                if (!dateVal) return null;
                
                // If already a Date object
                if (dateVal instanceof Date) return dateVal;
                
                // Convert to string
                const dateStr = String(dateVal).trim();
                if (!dateStr) return null;
                
                // Try ISO format first (2025-12-09)
                let parsed = new Date(dateStr);
                if (!isNaN(parsed.getTime())) return parsed;
                
                // Try parsing MM/DD/YYYY or M/D/YYYY format (with optional time)
                const usMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (usMatch) {
                    const month = parseInt(usMatch[1]) - 1;
                    const day = parseInt(usMatch[2]);
                    const year = parseInt(usMatch[3]);
                    return new Date(year, month, day);
                }
                
                return null;
            }
            
            // Apply filters with mobile-safe date parsing
            let filtered = allDetails;
            
            // Date filters
            if (reportFilters.fromDate && reportFilters.fromDate.trim() !== '') {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                if (!isNaN(fromDate.getTime())) {
                    fromDate.setHours(0, 0, 0, 0);
                    filtered = filtered.filter(d => {
                        const soDate = parseDateSafe(d.soDate);
                        return soDate && soDate >= fromDate;
                    });
                }
            }
            if (reportFilters.toDate && reportFilters.toDate.trim() !== '') {
                const toDate = parseLocalDate(reportFilters.toDate);
                if (!isNaN(toDate.getTime())) {
                    toDate.setHours(23, 59, 59, 999);
                    filtered = filtered.filter(d => {
                        const soDate = parseDateSafe(d.soDate);
                        return soDate && soDate <= toDate;
                    });
                }
            }
            if (reportFilters.customer) {
                filtered = filtered.filter(d => matchesFilter(d.customerId, reportFilters.customer));
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(d => d.lineTotal >= reportFilters.minAmount);
            }
            
            // Group by customer
            const byCustomer = {};
            filtered.forEach(d => {
                if (!byCustomer[d.customerId]) {
                    byCustomer[d.customerId] = { name: d.customerName, sales: 0, cost: 0, profit: 0, orders: new Set() };
                }
                byCustomer[d.customerId].sales += d.lineTotal;
                byCustomer[d.customerId].cost += d.lineCost;
                byCustomer[d.customerId].profit += d.profit;
                byCustomer[d.customerId].orders.add(d.soId);
            });
            
            // Calculate totals FIRST for KPI cards
            let totalSales = 0, totalCost = 0, totalProfit = 0, totalOrders = 0;
            Object.values(byCustomer).forEach(data => {
                totalSales += data.sales;
                totalCost += data.cost;
                totalProfit += data.profit;
                totalOrders += data.orders.size;
            });
            const totalMargin = totalSales > 0 ? (totalProfit / totalSales * 100) : 0;
            
            // Build filter summary
            const filterSummary = generateFilterSummary();
            
            // Sort customers by sales for chart
            const sortedCustomers = Object.entries(byCustomer)
                .sort((a, b) => b[1].sales - a[1].sales);
            const top10Customers = sortedCustomers.slice(0, 10);
            
            // Generate unique chart IDs
            const barChartId = 'salesCustBarChart_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const pieChartId = 'salesCustPieChart_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Build HTML with KPI cards
            let html = `<h3 style="margin-top: 0;">Sales by Customer Report</h3>`;
            html += filterSummary;
            html += `<p style="color: #666; margin-bottom: 20px;">${Object.keys(byCustomer).length} customers | ${totalOrders} orders | ${totalMargin.toFixed(1)}% avg margin</p>`;
            
            // KPI Summary Cards
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 12px; color: #1565c0; margin-bottom: 5px;"> Revenue</div>
                        <div style="font-size: 22px; font-weight: bold; color: #1976d2;">${formatMoney(totalSales)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px;"> Cost</div>
                        <div style="font-size: 22px; font-weight: bold; color: #388e3c;">${formatMoney(totalCost)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #a5d6a7 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #2e7d32;">
                        <div style="font-size: 12px; color: #1b5e20; margin-bottom: 5px;"> Profit</div>
                        <div style="font-size: 22px; font-weight: bold; color: #2e7d32;">${formatMoney(totalProfit)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <div style="font-size: 12px; color: #e65100; margin-bottom: 5px;"> Margin</div>
                        <div style="font-size: 22px; font-weight: bold; color: #f57c00;">${totalMargin.toFixed(1)}%</div>
                    </div>
                </div>
            `;
            
            // Charts Section (collapsible)
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'grid' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Top 10 Customers by Revenue</h4>
                            <canvas id="${barChartId}" height="250"></canvas>
                        </div>
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Revenue Distribution</h4>
                            <canvas id="${pieChartId}" height="250"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // Detail Table Section (collapsible)
            html += `
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Detail Table</strong>
                        <span style="color: #666; font-size: 12px;">(${Object.keys(byCustomer).length} customers - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>Customer</th>
                                <th style="text-align: right;">Orders</th>
                                <th style="text-align: right;">Sales</th>
                                <th style="text-align: right;">Cost</th>
                                <th style="text-align: right;">Profit</th>
                                <th style="text-align: right;">Margin</th>
                            </tr></thead><tbody>`;
            
            sortedCustomers.forEach(([id, data]) => {
                const margin = data.sales > 0 ? (data.profit / data.sales * 100) : 0;
                html += `<tr>
                    <td>${data.name}</td>
                    <td style="text-align: right;">${data.orders.size}</td>
                    <td style="text-align: right;">${formatMoney(data.sales)}</td>
                    <td style="text-align: right;">${formatMoney(data.cost)}</td>
                    <td style="text-align: right; color: ${data.profit >= 0 ? '#2e7d32' : '#c62828'};">${formatMoney(data.profit)}</td>
                    <td style="text-align: right;">${margin.toFixed(1)}%</td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td>TOTAL</td>
                <td style="text-align: right;">${totalOrders}</td>
                <td style="text-align: right;">${formatMoney(totalSales)}</td>
                <td style="text-align: right;">${formatMoney(totalCost)}</td>
                <td style="text-align: right; color: ${totalProfit >= 0 ? '#2e7d32' : '#c62828'};">${formatMoney(totalProfit)}</td>
                <td style="text-align: right;">${totalMargin.toFixed(1)}%</td>
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            
            // Chart.js initialization
            html += `
                <scr` + `ipt>
                    setTimeout(() => {
                        // Bar Chart - Top 10 Customers
                        const ctx1 = document.getElementById('${barChartId}');
                        if (ctx1) {
                            if(Chart.getChart(ctx1))Chart.getChart(ctx1).destroy(); new Chart(ctx1, {
                                type: 'bar',
                                data: {
                                    labels: [${top10Customers.map(([id, d]) => `'${d.name.replace(/'/g, "\\'").substring(0, 20)}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Revenue',
                                        data: [${top10Customers.map(([id, d]) => d.sales.toFixed(2)).join(', ')}],
                                        backgroundColor: ['#3b82f6', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#6366f1', '#14b8a6', '#84cc16'],
                                        borderRadius: 6
                                    }]
                                },
                                options: {
                                    indexAxis: 'y',
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        x: {
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Pie Chart - Revenue Distribution
                        const ctx2 = document.getElementById('${pieChartId}');
                        if (ctx2) {
                            const topData = [${top10Customers.slice(0, 5).map(([id, d]) => d.sales.toFixed(2)).join(', ')}];
                            const otherTotal = ${sortedCustomers.slice(5).reduce((sum, [id, d]) => sum + d.sales, 0).toFixed(2)};
                            if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                type: 'doughnut',
                                data: {
                                    labels: [${top10Customers.slice(0, 5).map(([id, d]) => `'${d.name.replace(/'/g, "\\'").substring(0, 15)}'`).join(', ')}, 'Others'],
                                    datasets: [{
                                        data: [...topData, otherTotal],
                                        backgroundColor: ['#3b82f6', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#9ca3af'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { position: 'right', labels: { padding: 10, usePointStyle: true, font: { size: 11 } } },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => ctx.label + ': $' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        // Simplified modal generators for other reports - they use the same data but return HTML
        async function generateSalesOrderDetailModal() {
            const salesResult = await apiCall('getSalesOrders');
            const itemsResult = await apiCall('getItems');
            if (!salesResult?.data) throw new Error('Failed to load sales data');
            
            let sales = salesResult.data;
            const items = itemsResult?.data || [];
            
            // Helper to get item name
            function getItemName(itemId) {
                const item = items.find(i => i.Item_ID == itemId);
                return item ? item.Item_Description : itemId;
            }
            
            // Helper function to parse dates in various formats
            function parseFlexibleDate(dateVal) {
                if (!dateVal) return null;
                if (dateVal instanceof Date) return dateVal;
                const dateStr = String(dateVal).trim();
                if (!dateStr) return null;
                let parsed = new Date(dateStr);
                if (!isNaN(parsed.getTime())) return parsed;
                const usMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (usMatch) {
                    return new Date(parseInt(usMatch[3]), parseInt(usMatch[1]) - 1, parseInt(usMatch[2]));
                }
                return null;
            }
            
            // Apply filters with mobile-safe date parsing
            if (reportFilters.fromDate && reportFilters.fromDate.trim() !== '') {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                if (!isNaN(fromDate.getTime())) {
                    fromDate.setHours(0, 0, 0, 0);
                    sales = sales.filter(s => {
                        const saleDate = parseDateSafe(s.Sale_Date || s.SO_Date);
                        return saleDate && saleDate >= fromDate;
                    });
                }
            }
            if (reportFilters.toDate && reportFilters.toDate.trim() !== '') {
                const toDate = parseLocalDate(reportFilters.toDate);
                if (!isNaN(toDate.getTime())) {
                    toDate.setHours(23, 59, 59, 999);
                    sales = sales.filter(s => {
                        const saleDate = parseDateSafe(s.Sale_Date || s.SO_Date);
                        return saleDate && saleDate <= toDate;
                    });
                }
            }
            if (reportFilters.customer) {
                sales = sales.filter(s => matchesFilter(s.Customer_ID, reportFilters.customer));
            }
            if (reportFilters.paymentStatus) {
                sales = sales.filter(s => s.Payment_Status === reportFilters.paymentStatus);
            }
            
            // Calculate totals FIRST for KPI cards
            let totalAmount = 0, totalPaid = 0, paidCount = 0, unpaidCount = 0;
            sales.forEach(s => {
                totalAmount += parseFloat(s.Total_Amount) || 0;
                totalPaid += parseFloat(s.Amount_Paid) || 0;
                if (s.Payment_Status === 'Paid') paidCount++;
                else unpaidCount++;
            });
            const totalOwed = totalAmount - totalPaid;
            
            let html = `<h3 style="margin-top: 0;">Sales Order Detail</h3>`;
            html += `<p style="color: #666; margin-bottom: 20px;">${sales.length} orders found</p>`;
            
            // KPI Summary Cards
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 12px; color: #1565c0; margin-bottom: 5px;"> Total Sales</div>
                        <div style="font-size: 22px; font-weight: bold; color: #1976d2;">${formatMoney(totalAmount)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px;"> Collected</div>
                        <div style="font-size: 22px; font-weight: bold; color: #388e3c;">${formatMoney(totalPaid)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <div style="font-size: 12px; color: #e65100; margin-bottom: 5px;"> Outstanding</div>
                        <div style="font-size: 22px; font-weight: bold; color: #f57c00;">${formatMoney(totalOwed)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                        <div style="font-size: 12px; color: #7b1fa2; margin-bottom: 5px;"> Paid/Unpaid</div>
                        <div style="font-size: 22px; font-weight: bold; color: #8e24aa;">${paidCount} / ${unpaidCount}</div>
                    </div>
                </div>
            `;
            
            // Group by payment status for chart (BEFORE table)
            const byStatus = {};
            sales.forEach(s => {
                const status = s.Payment_Status || 'Unpaid';
                if (!byStatus[status]) byStatus[status] = { count: 0, amount: 0 };
                byStatus[status].count++;
                byStatus[status].amount += parseFloat(s.Total_Amount) || 0;
            });
            
            const soChartId = 'soStatusChart_' + Date.now();
            const soLabels = Object.keys(byStatus);
            const soData = soLabels.map(s => byStatus[s].count);
            const soColors = {
                'Paid': '#4caf50',
                'Partial': '#03a9f4',
                'Unpaid': '#ff9800',
                'Overdue': '#f44336'
            };
            const chartColors = soLabels.map(s => soColors[s] || '#9c27b0');
            
            // Group by customer for bar chart
            const byCustomer = {};
            sales.forEach(s => {
                const custName = getCustomerName(s.Customer_ID);
                if (!byCustomer[custName]) byCustomer[custName] = 0;
                byCustomer[custName] += parseFloat(s.Total_Amount) || 0;
            });
            const sortedCustomers = Object.entries(byCustomer).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const customerChartId = 'soCustomerChart_' + Date.now();
            
            // Group by date for trend chart
            const byDate = {};
            sales.forEach(s => {
                const dateObj = parseDateSafe(s.Sale_Date || s.SO_Date);
                if (dateObj) {
                    const dateKey = dateObj.toISOString().split('T')[0];
                    if (!byDate[dateKey]) byDate[dateKey] = 0;
                    byDate[dateKey] += parseFloat(s.Total_Amount) || 0;
                }
            });
            const sortedDates = Object.entries(byDate).sort((a, b) => a[0].localeCompare(b[0]));
            const trendChartId = 'soTrendChart_' + Date.now();
            
            // Fetch sales order lines for Top Products chart
            const byProduct = {};
            for (const so of sales) {
                try {
                    const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID || so.SO_Number });
                    if (linesResult?.data) {
                        linesResult.data.forEach(line => {
                            const itemName = getItemName(line.Item_ID);
                            const qty = parseFloat(line.Quantity) || 0;
                            const amount = parseFloat(line.Line_Total) || (qty * (parseFloat(line.Unit_Price) || 0));
                            if (!byProduct[itemName]) byProduct[itemName] = { qty: 0, amount: 0 };
                            byProduct[itemName].qty += qty;
                            byProduct[itemName].amount += amount;
                        });
                    }
                } catch(e) {
                    // Skip if can't fetch lines
                }
            }
            const sortedProducts = Object.entries(byProduct).sort((a, b) => b[1].amount - a[1].amount).slice(0, 10);
            const productsChartId = 'soProductsChart_' + Date.now();
            
            // Charts Section - all 4 charts in a grid
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                            <!-- Payment Status Donut -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #555;"> Payment Status</h4>
                                <div style="height: 200px; overflow: hidden;">
                                    <canvas id="${soChartId}" class="print-chart"></canvas>
                                </div>
                            </div>
                            <!-- Top Customers Bar -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #555;"> Top Customers</h4>
                                <div style="height: 200px; overflow: hidden;">
                                    <canvas id="${customerChartId}" class="print-chart"></canvas>
                                </div>
                            </div>
                            <!-- Top Products Bar -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #555;"> Top Products</h4>
                                <div style="height: 200px; overflow: hidden;">
                                    <canvas id="${productsChartId}" class="print-chart"></canvas>
                                </div>
                            </div>
                            <!-- Sales Trend Line -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #555;"> Sales Trend</h4>
                                <div style="height: 200px; overflow: hidden;">
                                    <canvas id="${trendChartId}" class="print-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Detail Table Section (collapsible)
            html += `
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Detail Table</strong>
                        <span style="color: #666; font-size: 12px;">(${sales.length} orders - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
            `;
            
            html += `<div style="overflow-x: auto;"><table class="data-table">
                <thead><tr>
                    <th>Invoice #</th>
                    <th>Date</th>
                    <th>Customer</th>
                    <th style="text-align: right;">Total</th>
                    <th>Payment</th>
                </tr></thead><tbody>`;
            
            let total = 0;
            sales.sort((a, b) => new Date(b.Sale_Date || b.SO_Date) - new Date(a.Sale_Date || a.SO_Date))
                .forEach(s => {
                    const amt = parseFloat(s.Total_Amount) || 0;
                    total += amt;
                    const dateObj = parseDate(s.Sale_Date || s.SO_Date);
                    const sortableDate = dateObj ? dateObj.toISOString().split('T')[0] : '';
                    html += `<tr>
                        <td>${s.Invoice_Number || s.SO_Number || '-'}</td>
                        <td data-sort="${sortableDate}">${formatDateSafe(s.Sale_Date || s.SO_Date)}</td>
                        <td>${getCustomerName(s.Customer_ID)}</td>
                        <td style="text-align: right;">${formatMoney(amt)}</td>
                        <td>${s.Payment_Status || 'Unpaid'}</td>
                    </tr>`;
                });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="3">TOTAL</td>
                <td style="text-align: right;">${formatMoney(total)}</td>
                <td></td>
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            
            // Chart.js initialization for all 4 charts
            html += `
                <scr` + `ipt>
                    setTimeout(() => {
                        // Payment Status Donut
                        const ctx = document.getElementById('${soChartId}');
                        if (ctx) {
                            if(Chart.getChart(ctx))Chart.getChart(ctx).destroy(); new Chart(ctx, {
                                type: 'doughnut',
                                data: {
                                    labels: ['${soLabels.join("', '")}'],
                                    datasets: [{
                                        data: [${soData.join(', ')}],
                                        backgroundColor: ['${chartColors.join("', '")}'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 11 } } }
                                    }
                                }
                            });
                        }
                        
                        // Top Customers Bar Chart
                        const ctx2 = document.getElementById('${customerChartId}');
                        if (ctx2) {
                            if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                type: 'bar',
                                data: {
                                    labels: [${sortedCustomers.map(([name]) => `'${name.replace(/'/g, "\\'").substring(0, 15)}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Sales',
                                        data: [${sortedCustomers.map(([, amt]) => amt.toFixed(2)).join(', ')}],
                                        backgroundColor: '#3b82f6',
                                        borderRadius: 4
                                    }]
                                },
                                options: {
                                    indexAxis: 'y',
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        x: { 
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Top Products Bar Chart
                        const ctx4 = document.getElementById('${productsChartId}');
                        if (ctx4) {
                            if(Chart.getChart(ctx4))Chart.getChart(ctx4).destroy(); new Chart(ctx4, {
                                type: 'bar',
                                data: {
                                    labels: [${sortedProducts.map(([name]) => `'${name.replace(/'/g, "\\'").substring(0, 15)}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Sales',
                                        data: [${sortedProducts.map(([, data]) => data.amount.toFixed(2)).join(', ')}],
                                        backgroundColor: '#8b5cf6',
                                        borderRadius: 4
                                    }]
                                },
                                options: {
                                    indexAxis: 'y',
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        x: { 
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Sales Trend Line Chart
                        const ctx3 = document.getElementById('${trendChartId}');
                        if (ctx3) {
                            if(Chart.getChart(ctx3))Chart.getChart(ctx3).destroy(); new Chart(ctx3, {
                                type: 'line',
                                data: {
                                    labels: [${sortedDates.map(([date]) => `'${date.substring(5)}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Daily Sales',
                                        data: [${sortedDates.map(([, amt]) => amt.toFixed(2)).join(', ')}],
                                        borderColor: '#10b981',
                                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                        fill: true,
                                        tension: 0.3,
                                        pointRadius: 4,
                                        pointBackgroundColor: '#10b981'
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        y: { 
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        async function generateSalesByProductModal() {
            const itemsResult = await apiCall('getItems');
            const suppliersResult = await apiCall('getSuppliers');
            const salesResult = await apiCall('getSalesOrders');
            
            if (!itemsResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const suppliers = suppliersResult.data;
            let sales = salesResult?.data || [];
            
            // Apply transaction status filter to sales orders
            const statusFilter = reportFilters.transactionStatus || 'exclude-voided';
            if (statusFilter === 'exclude-voided') {
                sales = sales.filter(so => so.Status !== 'Voided');
            } else if (statusFilter && statusFilter !== '') {
                sales = sales.filter(so => so.Status === statusFilter);
            }
            
            // Fetch ALL sales order lines to get units sold
            const allLines = [];
            for (const so of sales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        line.SO_Date = so.Sale_Date || so.SO_Date;
                        // Calculate line total (Line_Total may not exist in API response)
                        const qty = parseInt(line.Quantity || 0);
                        const unitPrice = parseFloat(line.Unit_Price || 0);
                        line.Line_Total = qty * unitPrice;
                        allLines.push(line);
                    });
                }
            }
            
            // APPLY DATE FILTERS to sales lines using safe parsing
            let filteredLines = allLines;
            filteredLines = applyDateRangeFilter(filteredLines, 'SO_Date');
            
            // APPLY ITEM FILTER if specified
            if (reportFilters.item) {
                filteredLines = filteredLines.filter(line => matchesFilter(line.Item_ID, reportFilters.item));
            }
            
            // Calculate units sold per item
            const unitsSoldByItem = {};
            const revenueBYItem = {};
            filteredLines.forEach(line => {
                const itemId = line.Item_ID;
                const qty = parseInt(line.Quantity || 0);
                const lineTotal = parseFloat(line.Line_Total || 0);
                unitsSoldByItem[itemId] = (unitsSoldByItem[itemId] || 0) + qty;
                revenueBYItem[itemId] = (revenueBYItem[itemId] || 0) + lineTotal;
            });
            
            // Build product list with margins - ONLY items that were sold
            const productData = items
                .filter(item => unitsSoldByItem[item.Item_ID] > 0) // Only items with sales
                .map(item => {
                    const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                    const packageCost = parseFloat(item.Package_Cost) || 0;
                    const unitCost = packageCost / unitsPerPackage;
                    const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                    const margin = unitSellPrice - unitCost;
                    const marginPercent = unitSellPrice > 0 ? (margin / unitSellPrice) * 100 : 0;
                    const unitsSold = unitsSoldByItem[item.Item_ID] || 0;
                    const revenue = revenueBYItem[item.Item_ID] || 0;
                    const cost = unitsSold * unitCost;
                    const totalProfit = revenue - cost;
                    
                    return {
                        id: item.Item_ID,
                        description: item.Item_Description || '',
                        sku: item.SKU || '',
                        supplierId: item.Supplier_ID || '',
                        supplierName: suppliers.find(s => s.Supplier_ID === item.Supplier_ID)?.Supplier_Name || '',
                        unitCost: unitCost,
                        unitSellPrice: unitSellPrice,
                        margin: margin,
                        marginPercent: marginPercent,
                        unitsSold: unitsSold,
                        revenue: revenue,
                        cost: cost,
                        totalProfit: totalProfit,
                        qtyOnHand: parseInt(item.Qty_On_Hand) || 0,
                        reorderPoint: parseInt(item.Reorder_Point) || 0
                    };
                });
            
            // Sort by units sold (highest first)
            const sorted = productData.sort((a, b) => b.unitsSold - a.unitsSold);
            
            // Calculate totals
            const totalUnits = sorted.reduce((sum, p) => sum + p.unitsSold, 0);
            const totalRevenue = sorted.reduce((sum, p) => sum + p.revenue, 0);
            const totalCost = sorted.reduce((sum, p) => sum + p.cost, 0);
            const totalProfit = sorted.reduce((sum, p) => sum + p.totalProfit, 0);
            const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
            
            // Top 10 for charts
            const top10Items = sorted.slice(0, 10);
            const barChartId = 'salesItemBarChart_' + Date.now();
            const pieChartId = 'salesItemPieChart_' + Date.now();
            
            let html = `
                <h3 style="margin-top: 0;">Sales by Item</h3>
                <p style="color: #666; margin-bottom: 20px;">${sorted.length} items sold | ${totalUnits.toLocaleString()} units | ${avgMargin.toFixed(1)}% avg margin</p>
                
                <!-- KPI Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 12px; color: #1565c0; margin-bottom: 5px;"> Revenue</div>
                        <div style="font-size: 22px; font-weight: bold; color: #1976d2;">${formatMoney(totalRevenue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #f44336;">
                        <div style="font-size: 12px; color: #c62828; margin-bottom: 5px;"> Cost</div>
                        <div style="font-size: 22px; font-weight: bold; color: #d32f2f;">${formatMoney(totalCost)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px;"> Profit</div>
                        <div style="font-size: 22px; font-weight: bold; color: #388e3c;">${formatMoney(totalProfit)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <div style="font-size: 12px; color: #e65100; margin-bottom: 5px;"> Margin</div>
                        <div style="font-size: 22px; font-weight: bold; color: #f57c00;">${avgMargin.toFixed(1)}%</div>
                    </div>
                </div>
            `;
            
            if (sorted.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No sales found for the selected period</p>';
            } else {
                // Charts Section (collapsible)
                html += `
                    <div style="margin-bottom: 20px;">
                        <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'grid' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                             style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                            <span class="toggle-icon"></span>
                            <strong> Charts</strong>
                            <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 15px 0; color: #333;"> Top 10 Items by Revenue</h4>
                                <canvas id="${barChartId}" height="250"></canvas>
                            </div>
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 15px 0; color: #333;"> Revenue Distribution</h4>
                                <canvas id="${pieChartId}" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                
                // Detail Table Section (collapsible)
                html += `
                    <div>
                        <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                             style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                            <span class="toggle-icon"></span>
                            <strong> Detail Table</strong>
                            <span style="color: #666; font-size: 12px;">(${sorted.length} items - click to hide/show)</span>
                        </div>
                        <div style="margin-top: 15px;">
                            <div style="overflow-x: auto;"><table class="data-table">
                                <thead><tr>
                                    <th>SKU</th>
                                    <th>Item</th>
                                    <th>Supplier</th>
                                    <th style="text-align: right;">Units Sold</th>
                                    <th style="text-align: center;"> Stock</th>
                                    <th style="text-align: center;">Status</th>
                                    <th style="text-align: right;">Revenue</th>
                                    <th style="text-align: right;">Profit</th>
                                    <th style="text-align: right;">Margin %</th>
                                </tr></thead>
                                <tbody>`;
                
                sorted.forEach(item => {
                    let stockIcon = '';
                    if (item.qtyOnHand <= 0) {
                        stockIcon = '';
                    } else if (item.qtyOnHand <= item.reorderPoint) {
                        stockIcon = '';
                    } else {
                        stockIcon = '';
                    }
                    
                    html += `<tr>
                        <td><strong>${item.sku}</strong></td>
                        <td>${item.description}</td>
                        <td>${item.supplierName}</td>
                        <td style="text-align: right;"><strong>${item.unitsSold.toLocaleString()}</strong></td>
                        <td style="text-align: center;">${item.qtyOnHand}</td>
                        <td style="text-align: center; font-size: 16px;">${stockIcon}</td>
                        <td style="text-align: right;">${formatMoney(item.revenue)}</td>
                        <td style="text-align: right; color: ${item.totalProfit >= 0 ? '#2e7d32' : '#c62828'};">${formatMoney(item.totalProfit)}</td>
                        <td style="text-align: right; font-weight: bold;">${item.marginPercent.toFixed(1)}%</td>
                    </tr>`;
                });
                
                html += `</tbody></table></div>
                        </div>
                    </div>
                `;
                
                // Chart.js initialization
                html += `
                    <scr` + `ipt>
                        setTimeout(() => {
                            // Bar Chart - Top 10 Items
                            const ctx1 = document.getElementById('${barChartId}');
                            if (ctx1) {
                                if(Chart.getChart(ctx1))Chart.getChart(ctx1).destroy(); new Chart(ctx1, {
                                    type: 'bar',
                                    data: {
                                        labels: [${top10Items.map(i => `'${i.description.replace(/'/g, "\\'").substring(0, 20)}'`).join(', ')}],
                                        datasets: [{
                                            label: 'Revenue',
                                            data: [${top10Items.map(i => i.revenue.toFixed(2)).join(', ')}],
                                            backgroundColor: ['#3b82f6', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#6366f1', '#14b8a6', '#84cc16'],
                                            borderRadius: 6
                                        }]
                                    },
                                    options: {
                                        indexAxis: 'y',
                                        responsive: false, animation: false,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: { display: false },
                                            tooltip: {
                                                callbacks: {
                                                    label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                                }
                                            }
                                        },
                                        scales: {
                                            x: {
                                                beginAtZero: true,
                                                ticks: { callback: (val) => '$' + val.toLocaleString() }
                                            }
                                        }
                                    }
                                });
                            }
                            
                            // Pie Chart
                            const ctx2 = document.getElementById('${pieChartId}');
                            if (ctx2) {
                                const topData = [${top10Items.slice(0, 5).map(i => i.revenue.toFixed(2)).join(', ')}];
                                const otherTotal = ${sorted.slice(5).reduce((sum, i) => sum + i.revenue, 0).toFixed(2)};
                                if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                    type: 'doughnut',
                                    data: {
                                        labels: [${top10Items.slice(0, 5).map(i => `'${i.description.replace(/'/g, "\\'").substring(0, 15)}'`).join(', ')}, 'Others'],
                                        datasets: [{
                                            data: [...topData, otherTotal],
                                            backgroundColor: ['#3b82f6', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#9ca3af'],
                                            borderWidth: 0
                                        }]
                                    },
                                    options: {
                                        responsive: false, animation: false,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: { position: 'right', labels: { padding: 10, usePointStyle: true, font: { size: 11 } } }
                                        }
                                    }
                                });
                            }
                        }, 100);
                    <` + `/script>
                `;
            }
            
            return html;
        }
        
        async function generatePurchaseOrderDetailModal() {
            const poResult = await apiCall('getPurchaseOrders');
            const suppliersResult = await apiCall('getSuppliers');
            const itemsResult = await apiCall('getItems');
            if (!poResult?.data) throw new Error('Failed to load PO data');
            
            let purchases = poResult.data;
            const suppliers = suppliersResult?.data || [];
            const items = itemsResult?.data || [];
            
            // Helper to get supplier name
            function getSupplierName(supplierId) {
                const supplier = suppliers.find(s => s.Supplier_ID == supplierId);
                return supplier ? supplier.Supplier_Name : supplierId;
            }
            
            // Helper to get item name
            function getItemName(itemId) {
                const item = items.find(i => i.Item_ID == itemId);
                return item ? item.Item_Description : itemId;
            }
            
            // Helper function to parse dates in various formats
            function parseFlexibleDate(dateVal) {
                if (!dateVal) return null;
                if (dateVal instanceof Date) return dateVal;
                const dateStr = String(dateVal).trim();
                if (!dateStr) return null;
                let parsed = new Date(dateStr);
                if (!isNaN(parsed.getTime())) return parsed;
                const usMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (usMatch) {
                    return new Date(parseInt(usMatch[3]), parseInt(usMatch[1]) - 1, parseInt(usMatch[2]));
                }
                return null;
            }
            
            if (reportFilters.fromDate) {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                fromDate.setHours(0, 0, 0, 0);
                purchases = purchases.filter(p => {
                    const poDate = parseFlexibleDate(p.PO_Date);
                    return poDate && poDate >= fromDate;
                });
            }
            if (reportFilters.toDate) {
                const toDate = parseLocalDate(reportFilters.toDate);
                toDate.setHours(23, 59, 59, 999);
                purchases = purchases.filter(p => {
                    const poDate = parseFlexibleDate(p.PO_Date);
                    return poDate && poDate <= toDate;
                });
            }
            if (reportFilters.supplier) {
                purchases = purchases.filter(p => matchesFilter(p.Supplier_ID, reportFilters.supplier));
            }
            if (reportFilters.paymentStatus) {
                purchases = purchases.filter(p => p.Payment_Status === reportFilters.paymentStatus);
            }
            
            // Filter by PO Type
            if (reportFilters.poType) {
                purchases = purchases.filter(p => (p.PO_Type || 'INCOMING') === reportFilters.poType);
            }
            
            // Apply transaction status filter
            const statusFilter = reportFilters.transactionStatus || 'exclude-voided';
            if (statusFilter === 'exclude-voided') {
                purchases = purchases.filter(p => p.Status !== 'Voided');
            } else if (statusFilter && statusFilter !== '') {
                purchases = purchases.filter(p => p.Status === statusFilter);
            }
            
            // Show PO type filter in header
            const poTypeLabel = reportFilters.poType === 'INCOMING' ? ' Incoming Only' : 
                               reportFilters.poType === 'OUTGOING' ? ' Outgoing Only' : ' All Types';
            
            // Calculate totals FIRST for KPI cards
            let totalAmount = 0, totalPaid = 0, receivedCount = 0, pendingCount = 0;
            purchases.forEach(p => {
                totalAmount += parseFloat(p.Total_Amount) || 0;
                totalPaid += parseFloat(p.Amount_Paid) || 0;
                if (p.Status === 'Received') receivedCount++;
                else if (p.Status !== 'Voided') pendingCount++;
            });
            const totalOwed = totalAmount - totalPaid;
            
            let html = `<h3 style="margin-top: 0;">Purchase Order Detail</h3>`;
            html += `<p style="color: #666; margin-bottom: 20px;">${purchases.length} orders found | ${poTypeLabel}</p>`;
            
            // KPI Summary Cards
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 12px; color: #1565c0; margin-bottom: 5px;"> Total Amount</div>
                        <div style="font-size: 22px; font-weight: bold; color: #1976d2;">${formatMoney(totalAmount)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px;"> Paid</div>
                        <div style="font-size: 22px; font-weight: bold; color: #388e3c;">${formatMoney(totalPaid)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <div style="font-size: 12px; color: #e65100; margin-bottom: 5px;"> Owed</div>
                        <div style="font-size: 22px; font-weight: bold; color: #f57c00;">${formatMoney(totalOwed)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                        <div style="font-size: 12px; color: #7b1fa2; margin-bottom: 5px;"> Pending/Received</div>
                        <div style="font-size: 22px; font-weight: bold; color: #8e24aa;">${pendingCount} / ${receivedCount}</div>
                    </div>
                </div>
            `;
            
            // Group by status for chart (BEFORE table)
            const byStatus = {};
            purchases.forEach(p => {
                const status = p.Status || 'Pending';
                if (!byStatus[status]) byStatus[status] = { count: 0, amount: 0 };
                byStatus[status].count++;
                byStatus[status].amount += parseFloat(p.Total_Amount) || 0;
            });
            
            const statusChartId = 'poStatusChart_' + Date.now();
            const statusLabels = Object.keys(byStatus);
            const statusData = statusLabels.map(s => byStatus[s].count);
            const statusColors = {
                'Received': '#4caf50',
                'Pending': '#ff9800',
                'Voided': '#9e9e9e',
                'Partial': '#03a9f4'
            };
            const chartColors = statusLabels.map(s => statusColors[s] || '#9c27b0');
            
            // Group by supplier for bar chart
            const bySupplier = {};
            purchases.forEach(p => {
                const suppName = getSupplierName(p.Supplier_ID);
                if (!bySupplier[suppName]) bySupplier[suppName] = 0;
                bySupplier[suppName] += parseFloat(p.Total_Amount) || 0;
            });
            const sortedSuppliers = Object.entries(bySupplier).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const supplierChartId = 'poSupplierChart_' + Date.now();
            
            // Fetch PO lines for Top Products chart
            const byProduct = {};
            for (const po of purchases) {
                try {
                    const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
                    if (linesResult?.data) {
                        linesResult.data.forEach(line => {
                            const itemName = getItemName(line.Item_ID);
                            const qty = parseFloat(line.Quantity) || 0;
                            const amount = parseFloat(line.Line_Total) || (qty * (parseFloat(line.Unit_Cost) || 0));
                            if (!byProduct[itemName]) byProduct[itemName] = { qty: 0, amount: 0 };
                            byProduct[itemName].qty += qty;
                            byProduct[itemName].amount += amount;
                        });
                    }
                } catch(e) {
                    // Skip if can't fetch lines
                }
            }
            const sortedProducts = Object.entries(byProduct).sort((a, b) => b[1].amount - a[1].amount).slice(0, 10);
            const productsChartId = 'poProductsChart_' + Date.now();
            
            // Charts Section - all 4 charts in a grid
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                            <!-- Status Breakdown Donut -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #555;"> Status Breakdown</h4>
                                <div style="height: 200px; overflow: hidden;">
                                    <canvas id="${statusChartId}" class="print-chart"></canvas>
                                </div>
                            </div>
                            <!-- Top Suppliers Bar -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #555;"> Top Suppliers</h4>
                                <div style="height: 200px; overflow: hidden;">
                                    <canvas id="${supplierChartId}" class="print-chart"></canvas>
                                </div>
                            </div>
                            <!-- Top Products Bar -->
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #555;"> Top Products</h4>
                                <div style="height: 200px; overflow: hidden;">
                                    <canvas id="${productsChartId}" class="print-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Detail Table Section (collapsible)
            html += `
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Detail Table</strong>
                        <span style="color: #666; font-size: 12px;">(${purchases.length} orders - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
            `;
            
            html += `<div style="overflow-x: auto;"><table class="data-table">
                <thead><tr>
                    <th>PO #</th>
                    <th>Date</th>
                    <th>Supplier</th>
                    <th>Type</th>
                    <th style="text-align: right;">Total</th>
                    <th>Status</th>
                </tr></thead><tbody>`;
            
            let total = 0;
            purchases.sort((a, b) => new Date(b.PO_Date) - new Date(a.PO_Date))
                .forEach(p => {
                    const amt = parseFloat(p.Total_Amount) || 0;
                    total += amt;
                    const poType = p.PO_Type || 'INCOMING';
                    const typeStyle = poType === 'OUTGOING' 
                        ? 'background: #e3f2fd; color: #1565c0;' 
                        : 'background: #e8f5e9; color: #2e7d32;';
                    
                    // Format date and time nicely (mobile-safe)
                    const formattedDate = formatDateSafe(p.PO_Date) + ' ' + formatTimeSafe(p.PO_Date);
                    
                    html += `<tr>
                        <td>${p.PO_Number || p.Invoice_Number || '-'}</td>
                        <td>${formattedDate}</td>
                        <td>${getSupplierName(p.Supplier_ID)}</td>
                        <td><span style="${typeStyle} padding: 3px 8px; border-radius: 4px; font-size: 11px;">${poType === 'OUTGOING' ? ' Out' : ' In'}</span></td>
                        <td style="text-align: right;">${formatMoney(amt)}</td>
                        <td>${p.Status || '-'}</td>
                    </tr>`;
                });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="4">TOTAL</td>
                <td style="text-align: right;">${formatMoney(total)}</td>
                <td></td>
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            
            // Chart.js initialization for all 4 charts
            html += `
                <scr` + `ipt>
                    setTimeout(() => {
                        // Status Breakdown Donut
                        const ctx = document.getElementById('${statusChartId}');
                        if (ctx) {
                            if(Chart.getChart(ctx))Chart.getChart(ctx).destroy(); new Chart(ctx, {
                                type: 'doughnut',
                                data: {
                                    labels: ['${statusLabels.join("', '")}'],
                                    datasets: [{
                                        data: [${statusData.join(', ')}],
                                        backgroundColor: ['${chartColors.join("', '")}'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 11 } } }
                                    }
                                }
                            });
                        }
                        
                        // Top Suppliers Bar Chart
                        const ctx2 = document.getElementById('${supplierChartId}');
                        if (ctx2) {
                            if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                type: 'bar',
                                data: {
                                    labels: [${sortedSuppliers.map(([name]) => `'${name.replace(/'/g, "\\'").substring(0, 15)}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Spending',
                                        data: [${sortedSuppliers.map(([, amt]) => amt.toFixed(2)).join(', ')}],
                                        backgroundColor: '#3b82f6',
                                        borderRadius: 4
                                    }]
                                },
                                options: {
                                    indexAxis: 'y',
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        x: { 
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Top Products Bar Chart
                        const ctx4 = document.getElementById('${productsChartId}');
                        if (ctx4) {
                            if(Chart.getChart(ctx4))Chart.getChart(ctx4).destroy(); new Chart(ctx4, {
                                type: 'bar',
                                data: {
                                    labels: [${sortedProducts.map(([name]) => `'${name.replace(/'/g, "\\'").substring(0, 15)}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Purchases',
                                        data: [${sortedProducts.map(([, data]) => data.amount.toFixed(2)).join(', ')}],
                                        backgroundColor: '#8b5cf6',
                                        borderRadius: 4
                                    }]
                                },
                                options: {
                                    indexAxis: 'y',
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        x: { 
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        async function generatePurchaseBySupplierModal() {
            const poResult = await apiCall('getPurchaseOrders');
            if (!poResult?.data) throw new Error('Failed to load PO data');
            
            let purchases = poResult.data;
            
            // Helper function to parse dates in various formats
            function parseFlexibleDate(dateVal) {
                if (!dateVal) return null;
                if (dateVal instanceof Date) return dateVal;
                const dateStr = String(dateVal).trim();
                if (!dateStr) return null;
                let parsed = new Date(dateStr);
                if (!isNaN(parsed.getTime())) return parsed;
                const usMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (usMatch) {
                    return new Date(parseInt(usMatch[3]), parseInt(usMatch[1]) - 1, parseInt(usMatch[2]));
                }
                return null;
            }
            
            if (reportFilters.fromDate) {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                fromDate.setHours(0, 0, 0, 0);
                purchases = purchases.filter(p => {
                    const poDate = parseFlexibleDate(p.PO_Date);
                    return poDate && poDate >= fromDate;
                });
            }
            if (reportFilters.toDate) {
                const toDate = parseLocalDate(reportFilters.toDate);
                toDate.setHours(23, 59, 59, 999);
                purchases = purchases.filter(p => {
                    const poDate = parseFlexibleDate(p.PO_Date);
                    return poDate && poDate <= toDate;
                });
            }
            if (reportFilters.supplier) {
                purchases = purchases.filter(p => matchesFilter(p.Supplier_ID, reportFilters.supplier));
            }
            
            // Filter by PO Type
            if (reportFilters.poType) {
                purchases = purchases.filter(p => (p.PO_Type || 'INCOMING') === reportFilters.poType);
            }
            
            // Apply transaction status filter
            const statusFilter = reportFilters.transactionStatus || 'exclude-voided';
            if (statusFilter === 'exclude-voided') {
                purchases = purchases.filter(p => p.Status !== 'Voided');
            } else if (statusFilter && statusFilter !== '') {
                purchases = purchases.filter(p => p.Status === statusFilter);
            }
            
            // Group by supplier
            const bySupplier = {};
            purchases.forEach(p => {
                const suppId = p.Supplier_ID;
                if (!bySupplier[suppId]) {
                    bySupplier[suppId] = { name: getSupplierName(suppId), total: 0, count: 0, paid: 0 };
                }
                bySupplier[suppId].total += parseFloat(p.Total_Amount) || 0;
                bySupplier[suppId].paid += parseFloat(p.Amount_Paid) || 0;
                bySupplier[suppId].count++;
            });
            
            // Calculate totals FIRST for KPI cards
            let grandTotal = 0, totalOrderCount = 0, totalPaid = 0;
            Object.values(bySupplier).forEach(data => {
                grandTotal += data.total;
                totalPaid += data.paid;
                totalOrderCount += data.count;
            });
            const totalOwed = grandTotal - totalPaid;
            const avgPerOrder = totalOrderCount > 0 ? grandTotal / totalOrderCount : 0;
            
            // Show PO type filter in header
            const poTypeLabel = reportFilters.poType === 'INCOMING' ? ' Incoming Only' : 
                               reportFilters.poType === 'OUTGOING' ? ' Outgoing Only' : ' All Types';
            
            // Build filter summary
            const filterSummary = generateFilterSummary();
            
            let html = `<h3 style="margin-top: 0;">Purchase by Supplier</h3>`;
            html += filterSummary;
            html += `<p style="color: #666; margin-bottom: 20px;">${Object.keys(bySupplier).length} suppliers | ${purchases.length} orders | ${poTypeLabel}</p>`;
            
            // KPI Summary Cards
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 12px; color: #1565c0; margin-bottom: 5px;"> Total Purchases</div>
                        <div style="font-size: 22px; font-weight: bold; color: #1976d2;">${formatMoney(grandTotal)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px;"> Amount Paid</div>
                        <div style="font-size: 22px; font-weight: bold; color: #388e3c;">${formatMoney(totalPaid)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <div style="font-size: 12px; color: #e65100; margin-bottom: 5px;"> Amount Owed</div>
                        <div style="font-size: 22px; font-weight: bold; color: #f57c00;">${formatMoney(totalOwed)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                        <div style="font-size: 12px; color: #7b1fa2; margin-bottom: 5px;"> Avg/Order</div>
                        <div style="font-size: 22px; font-weight: bold; color: #8e24aa;">${formatMoney(avgPerOrder)}</div>
                    </div>
                </div>
            `;
            
            // Prepare chart data
            const sortedSuppliers = Object.entries(bySupplier).sort((a, b) => b[1].total - a[1].total);
            const topSuppliers = sortedSuppliers.slice(0, 5);
            const othersTotal = sortedSuppliers.slice(5).reduce((sum, [id, d]) => sum + d.total, 0);
            const barChartId = 'purchBySuppBarChart_' + Date.now();
            const pieChartId = 'purchBySuppPieChart_' + Date.now();
            
            // Charts Section
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'grid' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Top 5 Suppliers</h4>
                            <canvas id="${barChartId}" height="200"></canvas>
                        </div>
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Spend Distribution</h4>
                            <canvas id="${pieChartId}" height="200"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // Detail Table Section
            html += `
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Detail Table</strong>
                        <span style="color: #666; font-size: 12px;">(${Object.keys(bySupplier).length} suppliers - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>Supplier</th>
                                <th style="text-align: right;">Orders</th>
                                <th style="text-align: right;">Total</th>
                                <th style="text-align: right;">Paid</th>
                                <th style="text-align: right;">Balance</th>
                            </tr></thead><tbody>`;
            
            Object.entries(bySupplier)
                .sort((a, b) => b[1].total - a[1].total)
                .forEach(([id, data]) => {
                    const balance = data.total - data.paid;
                    html += `<tr>
                        <td>${data.name}</td>
                        <td style="text-align: right;">${data.count}</td>
                        <td style="text-align: right;">${formatMoney(data.total)}</td>
                        <td style="text-align: right;">${formatMoney(data.paid)}</td>
                        <td style="text-align: right; color: ${balance > 0 ? '#c62828' : '#2e7d32'};">${formatMoney(balance)}</td>
                    </tr>`;
                });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td>TOTAL</td>
                <td style="text-align: right;">${totalOrderCount}</td>
                <td style="text-align: right;">${formatMoney(grandTotal)}</td>
                <td style="text-align: right;">${formatMoney(totalPaid)}</td>
                <td style="text-align: right; color: ${totalOwed > 0 ? '#c62828' : '#2e7d32'};">${formatMoney(totalOwed)}</td>
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            
            // Chart.js initialization
            const suppLabels = topSuppliers.map(([id, d]) => d.name.replace(/'/g, "\\'").substring(0, 15));
            const suppData = topSuppliers.map(([id, d]) => d.total);
            
            html += `
                <scr` + `ipt>
                    setTimeout(() => {
                        const ctx1 = document.getElementById('${barChartId}');
                        if (ctx1) {
                            if(Chart.getChart(ctx1))Chart.getChart(ctx1).destroy(); new Chart(ctx1, {
                                type: 'bar',
                                data: {
                                    labels: ['${suppLabels.join("', '")}'],
                                    datasets: [{
                                        label: 'Purchases',
                                        data: [${suppData.join(', ')}],
                                        backgroundColor: ['#3b82f6', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b'],
                                        borderRadius: 6
                                    }]
                                },
                                options: {
                                    indexAxis: 'y',
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: false } },
                                    scales: { x: { beginAtZero: true, ticks: { callback: (val) => '$' + val.toLocaleString() } } }
                                }
                            });
                        }
                        const ctx2 = document.getElementById('${pieChartId}');
                        if (ctx2) {
                            if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                type: 'doughnut',
                                data: {
                                    labels: ['${suppLabels.join("', '")}' ${othersTotal > 0 ? ", 'Others'" : ''}],
                                    datasets: [{
                                        data: [${suppData.join(', ')}${othersTotal > 0 ? ', ' + othersTotal.toFixed(2) : ''}],
                                        backgroundColor: ['#3b82f6', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#9ca3af'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { position: 'right', labels: { padding: 8, usePointStyle: true, font: { size: 10 } } } }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        async function generateInventoryTurnoverModal() {
            // Get items, sales orders, and sales lines to calculate REAL turnover
            const [itemsResult, salesResult, suppliersResult] = await Promise.all([
                apiCall('getItems'),
                apiCall('getSalesOrders'),
                apiCall('getSuppliers')
            ]);
            
            if (!itemsResult?.data || !salesResult?.data) {
                throw new Error('Failed to load data');
            }
            
            let items = itemsResult.data;
            const suppliers = suppliersResult?.data || [];
            let sales = salesResult.data.filter(s => s.Status !== 'Voided');
            
            // Apply supplier filter
            if (reportFilters.supplier) {
                items = items.filter(i => matchesFilter(i.Supplier_ID, reportFilters.supplier));
            }
            
            // Get date range for turnover calculation (default last 90 days)
            const now = new Date();
            const fromDate = reportFilters.fromDate ? parseLocalDate(reportFilters.fromDate) : new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
            let toDate = reportFilters.toDate ? parseLocalDate(reportFilters.toDate) : now;
            fromDate.setHours(0, 0, 0, 0);
            toDate.setHours(23, 59, 59, 999);
            
            const daysPeriod = Math.max(1, Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24)));
            
            // Filter sales by date range
            sales = sales.filter(s => {
                const d = parseDate(s.Sale_Date || s.SO_Date);
                return d && d >= fromDate && d <= toDate;
            });
            
            // Calculate units sold per item in the period
            const unitsSoldByItem = {};
            const lastSaleDate = {};
            
            for (const so of sales) {
                const soDate = parseDate(so.Sale_Date || so.SO_Date);
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const itemId = line.Item_ID;
                        const qty = parseInt(line.Quantity) || 0;
                        unitsSoldByItem[itemId] = (unitsSoldByItem[itemId] || 0) + qty;
                        
                        // Track last sale date
                        if (!lastSaleDate[itemId] || soDate > lastSaleDate[itemId]) {
                            lastSaleDate[itemId] = soDate;
                        }
                    });
                }
            }
            
            // Build turnover data for each item
            const turnoverData = items.map(item => {
                const itemId = item.Item_ID;
                const qtyOnHand = parseInt(item.Qty_On_Hand) || 0;
                const qtyOnBackorder = parseInt(item.Qty_On_Backorder) || 0;
                const unitsSold = unitsSoldByItem[itemId] || 0;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPkg = parseInt(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPkg;
                const inventoryValue = Math.abs(qtyOnHand) * unitCost;
                const supplier = suppliers.find(s => s.Supplier_ID === item.Supplier_ID);
                
                // Calculate daily sales rate
                const dailySalesRate = unitsSold / daysPeriod;
                
                // Days of supply (how long current inventory will last)
                const daysOfSupply = dailySalesRate > 0 ? Math.round(qtyOnHand / dailySalesRate) : (qtyOnHand > 0 ? 999 : 0);
                
                // Annualized turnover rate (times per year inventory sells)
                const annualizedSales = dailySalesRate * 365;
                const avgInventory = Math.max(qtyOnHand, 1); // Use current as proxy
                const turnoverRate = annualizedSales / avgInventory;
                
                // Days since last sale
                const daysSinceLastSale = lastSaleDate[itemId] 
                    ? Math.floor((now - lastSaleDate[itemId]) / (1000 * 60 * 60 * 24))
                    : 999;
                
                // Velocity classification
                let velocity = 'dead';
                let velocityColor = '#ef4444';
                let velocityIcon = '';
                if (unitsSold === 0 && qtyOnHand === 0) {
                    velocity = 'none';
                    velocityColor = '#9ca3af';
                    velocityIcon = '';
                } else if (dailySalesRate >= 2) {
                    velocity = 'fast';
                    velocityColor = '#22c55e';
                    velocityIcon = '';
                } else if (dailySalesRate >= 0.5) {
                    velocity = 'medium';
                    velocityColor = '#3b82f6';
                    velocityIcon = '';
                } else if (dailySalesRate >= 0.1) {
                    velocity = 'slow';
                    velocityColor = '#f59e0b';
                    velocityIcon = '';
                } else if (unitsSold > 0) {
                    velocity = 'slow';
                    velocityColor = '#f59e0b';
                    velocityIcon = '';
                }
                
                return {
                    itemId,
                    sku: item.SKU || '-',
                    description: item.Item_Description || itemId,
                    supplier: supplier?.Supplier_Name || 'Unknown',
                    qtyOnHand,
                    qtyOnBackorder,
                    unitsSold,
                    dailySalesRate,
                    daysOfSupply,
                    turnoverRate,
                    daysSinceLastSale,
                    velocity,
                    velocityColor,
                    velocityIcon,
                    inventoryValue,
                    unitCost
                };
            });
            
            // Sort by velocity priority then by value
            const velocityOrder = { fast: 0, medium: 1, slow: 2, dead: 3, none: 4 };
            turnoverData.sort((a, b) => {
                if (velocityOrder[a.velocity] !== velocityOrder[b.velocity]) {
                    return velocityOrder[a.velocity] - velocityOrder[b.velocity];
                }
                return b.inventoryValue - a.inventoryValue;
            });
            
            // Calculate velocity summary
            const velocityCounts = { fast: 0, medium: 0, slow: 0, dead: 0, none: 0 };
            const velocityValue = { fast: 0, medium: 0, slow: 0, dead: 0, none: 0 };
            let totalValue = 0;
            let totalUnitsSold = 0;
            
            turnoverData.forEach(item => {
                velocityCounts[item.velocity]++;
                velocityValue[item.velocity] += item.inventoryValue;
                totalValue += item.inventoryValue;
                totalUnitsSold += item.unitsSold;
            });
            
            const avgTurnover = turnoverData.length > 0 
                ? turnoverData.reduce((sum, i) => sum + i.turnoverRate, 0) / turnoverData.length 
                : 0;
            
            // Generate unique chart ID
            const chartId = 'turnoverChart_' + Date.now();
            const pieChartId = 'turnoverPieChart_' + Date.now();
            
            let html = `
                <h3 style="margin-top: 0;"> Inventory Turnover Analysis</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    Analyzing ${daysPeriod} days of sales data (${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()})
                </p>
                
                <!-- KPI Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 12px; color: #1565c0; margin-bottom: 5px;"> Total Items</div>
                        <div style="font-size: 22px; font-weight: bold; color: #1976d2;">${turnoverData.length}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px;"> Units Sold</div>
                        <div style="font-size: 22px; font-weight: bold; color: #388e3c;">${totalUnitsSold.toLocaleString()}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                        <div style="font-size: 12px; color: #7b1fa2; margin-bottom: 5px;"> Avg Turnover</div>
                        <div style="font-size: 22px; font-weight: bold; color: #8e24aa;">${avgTurnover.toFixed(1)}x/yr</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #f44336;">
                        <div style="font-size: 12px; color: #c62828; margin-bottom: 5px;"> Dead Stock Value</div>
                        <div style="font-size: 22px; font-weight: bold; color: #d32f2f;">${formatMoney(velocityValue.dead)}</div>
                    </div>
                </div>
                
                <!-- Velocity Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: white; border: 2px solid #22c55e; border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 32px;"></div>
                        <div style="font-size: 24px; font-weight: bold; color: #22c55e;">${velocityCounts.fast}</div>
                        <div style="font-size: 12px; color: #666;">Fast Movers</div>
                        <div style="font-size: 11px; color: #22c55e;">(2+ units/day)</div>
                        <div style="font-size: 13px; color: #333; margin-top: 5px;">${formatMoney(velocityValue.fast)}</div>
                    </div>
                    <div style="background: white; border: 2px solid #3b82f6; border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 32px;"></div>
                        <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">${velocityCounts.medium}</div>
                        <div style="font-size: 12px; color: #666;">Medium Movers</div>
                        <div style="font-size: 11px; color: #3b82f6;">(0.5-2 units/day)</div>
                        <div style="font-size: 13px; color: #333; margin-top: 5px;">${formatMoney(velocityValue.medium)}</div>
                    </div>
                    <div style="background: white; border: 2px solid #f59e0b; border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 32px;"></div>
                        <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${velocityCounts.slow}</div>
                        <div style="font-size: 12px; color: #666;">Slow Movers</div>
                        <div style="font-size: 11px; color: #f59e0b;">(<0.5 units/day)</div>
                        <div style="font-size: 13px; color: #333; margin-top: 5px;">${formatMoney(velocityValue.slow)}</div>
                    </div>
                    <div style="background: white; border: 2px solid #ef4444; border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 32px;"></div>
                        <div style="font-size: 24px; font-weight: bold; color: #ef4444;">${velocityCounts.dead}</div>
                        <div style="font-size: 12px; color: #666;">Dead Stock</div>
                        <div style="font-size: 11px; color: #ef4444;">(No sales in period)</div>
                        <div style="font-size: 13px; color: #333; margin-top: 5px;">${formatMoney(velocityValue.dead)}</div>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; color: #333;"> Inventory Value by Velocity</h4>
                        <canvas id="${chartId}" height="200"></canvas>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; color: #333;"> Item Count Distribution</h4>
                        <canvas id="${pieChartId}" height="200"></canvas>
                    </div>
                </div>
                
                <!-- Detail Table -->
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 15px 0;"> Item Details</h4>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Velocity</th>
                                    <th>SKU</th>
                                    <th>Description</th>
                                    <th style="text-align: right;">On Hand</th>
                                    <th style="text-align: right;">Backorder</th>
                                    <th style="text-align: right;">Sold (${daysPeriod}d)</th>
                                    <th style="text-align: right;">Daily Rate</th>
                                    <th style="text-align: right;">Days Supply</th>
                                    <th style="text-align: right;">Turnover</th>
                                    <th style="text-align: right;">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${turnoverData.map(item => `
                                    <tr>
                                        <td>
                                            <span style="display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 15px; background: ${item.velocityColor}20; color: ${item.velocityColor}; font-weight: 600; font-size: 12px;">
                                                ${item.velocityIcon} ${item.velocity.charAt(0).toUpperCase() + item.velocity.slice(1)}
                                            </span>
                                        </td>
                                        <td style="font-family: monospace;">${item.sku}</td>
                                        <td>${item.description}</td>
                                        <td style="text-align: right; color: ${item.qtyOnHand <= 0 ? '#ef4444' : '#333'};">${item.qtyOnHand}</td>
                                        <td style="text-align: right; color: ${item.qtyOnBackorder > 0 ? '#dc2626' : '#666'}; font-weight: ${item.qtyOnBackorder > 0 ? '600' : 'normal'};">${item.qtyOnBackorder > 0 ? item.qtyOnBackorder : '-'}</td>
                                        <td style="text-align: right; font-weight: ${item.unitsSold > 0 ? 'bold' : 'normal'}; color: ${item.unitsSold > 0 ? '#22c55e' : '#999'};">${item.unitsSold}</td>
                                        <td style="text-align: right;">${item.dailySalesRate.toFixed(2)}</td>
                                        <td style="text-align: right;">
                                            ${item.daysOfSupply >= 999 ? '<span style="color: #ef4444;"></span>' : 
                                              item.daysOfSupply <= 7 ? `<span style="color: #ef4444; font-weight: bold;">${item.daysOfSupply}d</span>` :
                                              item.daysOfSupply <= 30 ? `<span style="color: #f59e0b;">${item.daysOfSupply}d</span>` :
                                              `${item.daysOfSupply}d`}
                                        </td>
                                        <td style="text-align: right;">${item.turnoverRate.toFixed(1)}x</td>
                                        <td style="text-align: right;">${formatMoney(item.inventoryValue)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <scr` + `ipt>
                    setTimeout(() => {
                        // Bar Chart - Value by Velocity
                        const ctx1 = document.getElementById('${chartId}');
                        if (ctx1) {
                            if(Chart.getChart(ctx1))Chart.getChart(ctx1).destroy(); new Chart(ctx1, {
                                type: 'bar',
                                data: {
                                    labels: [' Fast', ' Medium', ' Slow', ' Dead'],
                                    datasets: [{
                                        label: 'Inventory Value',
                                        data: [${velocityValue.fast.toFixed(2)}, ${velocityValue.medium.toFixed(2)}, ${velocityValue.slow.toFixed(2)}, ${velocityValue.dead.toFixed(2)}],
                                        backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444'],
                                        borderRadius: 8
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: {
                                                callback: (val) => '$' + val.toLocaleString()
                                            }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Pie Chart - Item Count
                        const ctx2 = document.getElementById('${pieChartId}');
                        if (ctx2) {
                            if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                type: 'doughnut',
                                data: {
                                    labels: ['Fast Movers', 'Medium Movers', 'Slow Movers', 'Dead Stock'],
                                    datasets: [{
                                        data: [${velocityCounts.fast}, ${velocityCounts.medium}, ${velocityCounts.slow}, ${velocityCounts.dead}],
                                        backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            position: 'bottom',
                                            labels: { padding: 15, usePointStyle: true }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        async function generateGrossMarginModal() {
            return await generateInventoryReportModal('margin');
        }
        
        // ==================== SUPPLIER PERFORMANCE DASHBOARD ====================
        
        async function generateSupplierPerformanceModal() {
            const fromDate = reportFilters.fromDate ? parseLocalDate(reportFilters.fromDate) : null;
            let toDate = reportFilters.toDate ? parseLocalDate(reportFilters.toDate) : null;
            if (toDate) toDate.setHours(23, 59, 59, 999);
            if (fromDate) fromDate.setHours(0, 0, 0, 0);
            const supplierFilter = reportFilters.supplier || '';
            
            // Fetch data
            const [poResult, suppliersResult, itemsResult] = await Promise.all([
                apiCall('getPurchaseOrders'),
                apiCall('getSuppliers'),
                apiCall('getItems')
            ]);
            
            if (!poResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            const items = itemsResult?.data || [];
            let purchases = poResult.data;
            
            // Date range label
            let dateLabel = 'All Time';
            if (fromDate && toDate) {
                dateLabel = `${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`;
            } else if (fromDate) {
                dateLabel = `Since ${fromDate.toLocaleDateString()}`;
            } else if (toDate) {
                dateLabel = `Through ${toDate.toLocaleDateString()}`;
            }
            
            // Filter by date
            if (fromDate) {
                purchases = purchases.filter(po => {
                    const d = parseDate(po.PO_Date);
                    return d && d >= fromDate;
                });
            }
            if (toDate) {
                purchases = purchases.filter(po => {
                    const d = parseDate(po.PO_Date);
                    return d && d <= toDate;
                });
            }
            
            // Filter by supplier if specified
            if (supplierFilter) {
                purchases = purchases.filter(po => po.Supplier_ID === supplierFilter);
            }
            
            // Exclude voided/cancelled
            purchases = purchases.filter(po => po.Status !== 'Void' && po.Status !== 'Cancelled' && po.Status !== 'Voided');
            
            // Calculate metrics per supplier
            const supplierStats = {};
            const allFulfillmentDays = [];
            let totalOnTime = 0, totalLate = 0, totalPending = 0;
            const lateOrders = [];
            const monthlyData = {};
            
            purchases.forEach(po => {
                const suppId = po.Supplier_ID;
                const supplier = suppliers.find(s => s.Supplier_ID === suppId);
                const supplierName = supplier?.Supplier_Name || suppId;
                
                if (!supplierStats[suppId]) {
                    supplierStats[suppId] = {
                        id: suppId,
                        name: supplierName,
                        totalPOs: 0,
                        receivedPOs: 0,
                        pendingPOs: 0,
                        onTime: 0,
                        late: 0,
                        totalAmount: 0,
                        fulfillmentDays: [],
                        lateDays: []
                    };
                }
                
                const stats = supplierStats[suppId];
                stats.totalPOs++;
                stats.totalAmount += parseFloat(po.Total_Amount || po.Invoice_Total) || 0;
                
                const poDate = parseDate(po.PO_Date);
                const dueDate = parseDate(po.Due_Date);
                const isReceived = po.Status === 'Received' || po.Status === 'Partial';
                
                // Track monthly data
                if (poDate) {
                    const monthKey = `${poDate.getFullYear()}-${String(poDate.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { total: 0, onTime: 0, late: 0 };
                    }
                    monthlyData[monthKey].total++;
                }
                
                if (isReceived) {
                    stats.receivedPOs++;
                    
                    // Calculate actual lead time using Receive_Date
                    const receiveDate = parseDate(po.Receive_Date);
                    
                    if (receiveDate && poDate) {
                        // Actual lead time = Receive_Date - PO_Date
                        const actualLeadDays = Math.ceil((receiveDate - poDate) / (1000 * 60 * 60 * 24));
                        stats.fulfillmentDays.push(actualLeadDays);
                        allFulfillmentDays.push(actualLeadDays);
                        
                        // Check if on-time: compare Receive_Date to Due_Date (expected delivery)
                        if (dueDate) {
                            if (receiveDate <= dueDate) {
                                stats.onTime++;
                                totalOnTime++;
                                if (poDate) {
                                    const monthKey = `${poDate.getFullYear()}-${String(poDate.getMonth() + 1).padStart(2, '0')}`;
                                    if (monthlyData[monthKey]) monthlyData[monthKey].onTime++;
                                }
                            } else {
                                // Received late
                                const daysLate = Math.ceil((receiveDate - dueDate) / (1000 * 60 * 60 * 24));
                                stats.late++;
                                stats.lateDays.push(daysLate);
                                totalLate++;
                                if (poDate) {
                                    const monthKey = `${poDate.getFullYear()}-${String(poDate.getMonth() + 1).padStart(2, '0')}`;
                                    if (monthlyData[monthKey]) monthlyData[monthKey].late++;
                                }
                            }
                        } else {
                            // No due date set, count as on-time
                            stats.onTime++;
                            totalOnTime++;
                        }
                    } else if (dueDate && poDate) {
                        // Fallback if no Receive_Date: use expected days
                        const expectedDays = Math.ceil((dueDate - poDate) / (1000 * 60 * 60 * 24));
                        stats.fulfillmentDays.push(expectedDays);
                        allFulfillmentDays.push(expectedDays);
                        stats.onTime++;
                        totalOnTime++;
                    } else {
                        stats.onTime++;
                        totalOnTime++;
                    }
                } else if (po.Status === 'Ordered') {
                    stats.pendingPOs++;
                    totalPending++;
                    
                    // Check if overdue
                    const today = new Date();
                    if (dueDate && today > dueDate) {
                        const daysLate = Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24));
                        stats.late++;
                        stats.lateDays.push(daysLate);
                        totalLate++;
                        
                        lateOrders.push({
                            poId: po.Invoice_Number || po.PO_ID,
                            supplier: supplierName,
                            poDate: poDate,
                            dueDate: dueDate,
                            daysLate: daysLate,
                            amount: parseFloat(po.Total_Amount || po.Invoice_Total) || 0,
                            status: po.Status
                        });
                        
                        if (poDate) {
                            const monthKey = `${poDate.getFullYear()}-${String(poDate.getMonth() + 1).padStart(2, '0')}`;
                            if (monthlyData[monthKey]) monthlyData[monthKey].late++;
                        }
                    }
                }
            });
            
            // Calculate overall metrics
            const totalPOs = purchases.length;
            const onTimeRate = totalPOs > 0 ? ((totalOnTime / (totalOnTime + totalLate)) * 100) : 0;
            const avgFulfillmentDays = allFulfillmentDays.length > 0 
                ? allFulfillmentDays.reduce((a, b) => a + b, 0) / allFulfillmentDays.length 
                : 0;
            
            // Sort suppliers by total POs
            const sortedSuppliers = Object.values(supplierStats).sort((a, b) => b.totalPOs - a.totalPOs);
            
            // Sort late orders by days late
            lateOrders.sort((a, b) => b.daysLate - a.daysLate);
            
            // Get monthly trend (last 6 months)
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const now = new Date();
            const trendMonths = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const data = monthlyData[key] || { total: 0, onTime: 0, late: 0 };
                trendMonths.push({
                    label: monthNames[d.getMonth()],
                    ...data,
                    onTimeRate: data.total > 0 ? ((data.onTime / data.total) * 100) : 0
                });
            }
            
            // Colors
            const chartColors = ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ec4899', '#06b6d4'];
            
            let html = `
                <style>
                    .sp-header {
                        text-align: center;
                        padding: 30px;
                        background: linear-gradient(135deg, #7c3aed, #a855f7);
                        color: white;
                        border-radius: 16px;
                        margin-bottom: 25px;
                    }
                    .sp-header h2 { margin: 0; font-size: 28px; }
                    .sp-header p { margin: 10px 0 0 0; opacity: 0.9; }
                    
                    .sp-kpi-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    .sp-kpi {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        text-align: center;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                        border-top: 4px solid #8b5cf6;
                    }
                    .sp-kpi .value { font-size: 32px; font-weight: bold; }
                    .sp-kpi .label { font-size: 12px; color: #666; text-transform: uppercase; margin-top: 5px; }
                    
                    .sp-section {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 20px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                    }
                    .sp-section h3 {
                        margin: 0 0 15px 0;
                        color: #1f2937;
                        font-size: 18px;
                    }
                    
                    .sp-gauge {
                        width: 120px;
                        height: 60px;
                        margin: 0 auto 10px;
                        position: relative;
                        overflow: hidden;
                    }
                    .sp-gauge-bg {
                        width: 120px;
                        height: 60px;
                        border-radius: 60px 60px 0 0;
                        background: #e5e7eb;
                    }
                    .sp-gauge-fill {
                        position: absolute;
                        bottom: 0;
                        left: 0;
                        width: 120px;
                        height: 60px;
                        border-radius: 60px 60px 0 0;
                        transform-origin: center bottom;
                    }
                    
                    .sp-bar {
                        height: 24px;
                        border-radius: 12px;
                        margin-bottom: 8px;
                        display: flex;
                        overflow: hidden;
                    }
                    .sp-bar-segment {
                        height: 100%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 11px;
                        font-weight: 600;
                        color: white;
                        min-width: 30px;
                    }
                    
                    .sp-supplier-row {
                        display: grid;
                        grid-template-columns: 150px 1fr 80px 80px 80px;
                        gap: 10px;
                        align-items: center;
                        padding: 12px;
                        border-bottom: 1px solid #f3f4f6;
                    }
                    .sp-supplier-row:hover {
                        background: #f9fafb;
                    }
                    .sp-supplier-name {
                        font-weight: 600;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .sp-mini-bar {
                        height: 20px;
                        background: #f3f4f6;
                        border-radius: 10px;
                        overflow: hidden;
                        display: flex;
                    }
                    .sp-mini-bar-fill {
                        height: 100%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 10px;
                        color: white;
                        font-weight: 600;
                        min-width: 25px;
                    }
                    
                    .sp-trend-chart {
                        display: flex;
                        align-items: flex-end;
                        justify-content: space-around;
                        height: 120px;
                        padding: 10px;
                        background: #f9fafb;
                        border-radius: 8px;
                    }
                    .sp-trend-bar {
                        flex: 1;
                        margin: 0 5px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                    }
                    .sp-trend-fill {
                        width: 100%;
                        max-width: 40px;
                        border-radius: 4px 4px 0 0;
                        transition: height 0.3s;
                    }
                    .sp-trend-label {
                        font-size: 11px;
                        color: #666;
                        margin-top: 5px;
                    }
                    
                    .sp-late-card {
                        background: #fef2f2;
                        border: 1px solid #fecaca;
                        border-radius: 8px;
                        padding: 12px;
                        margin-bottom: 10px;
                    }
                    .sp-late-card .days-late {
                        background: #dc2626;
                        color: white;
                        padding: 2px 8px;
                        border-radius: 10px;
                        font-size: 12px;
                        font-weight: 600;
                    }
                    
                    @media (max-width: 768px) {
                        .sp-supplier-row {
                            grid-template-columns: 1fr;
                            gap: 5px;
                        }
                        .sp-supplier-row > div:not(:first-child) {
                            font-size: 12px;
                        }
                    }
                </style>
                
                <div class="sp-header">
                    <h2> Supplier Performance Dashboard</h2>
                    <p>${dateLabel}${supplierFilter ? '  Filtered by supplier' : ''}</p>
                </div>
                
                <!-- KPI Cards -->
                <div class="sp-kpi-grid">
                    <div class="sp-kpi">
                        <div class="value" style="color: #7c3aed;">${totalPOs}</div>
                        <div class="label">Total POs</div>
                    </div>
                    <div class="sp-kpi" style="border-top-color: #10b981;">
                        <div class="value" style="color: #10b981;">${totalOnTime}</div>
                        <div class="label">Received</div>
                    </div>
                    <div class="sp-kpi" style="border-top-color: #f59e0b;">
                        <div class="value" style="color: #f59e0b;">${totalPending}</div>
                        <div class="label">Pending</div>
                    </div>
                    <div class="sp-kpi" style="border-top-color: #dc2626;">
                        <div class="value" style="color: #dc2626;">${totalLate}</div>
                        <div class="label">Overdue</div>
                    </div>
                    <div class="sp-kpi" style="border-top-color: #3b82f6;">
                        <div class="value" style="color: #3b82f6;">${onTimeRate.toFixed(0)}%</div>
                        <div class="label">On-Time Rate</div>
                    </div>
                    <div class="sp-kpi" style="border-top-color: #6366f1;">
                        <div class="value" style="color: #6366f1;">${avgFulfillmentDays.toFixed(0)}</div>
                        <div class="label">Avg Lead Time (days)</div>
                    </div>
                </div>
                
                <!-- Overall Performance Bar -->
                <div class="sp-section">
                    <h3> Overall Fulfillment Status</h3>
                    <div class="sp-bar">
                        ${totalOnTime > 0 ? `<div class="sp-bar-segment" style="width: ${(totalOnTime/totalPOs)*100}%; background: #10b981;"> ${totalOnTime}</div>` : ''}
                        ${totalPending > 0 ? `<div class="sp-bar-segment" style="width: ${(totalPending/totalPOs)*100}%; background: #f59e0b;"> ${totalPending}</div>` : ''}
                        ${totalLate > 0 ? `<div class="sp-bar-segment" style="width: ${(totalLate/totalPOs)*100}%; background: #dc2626;"> ${totalLate}</div>` : ''}
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px; font-size: 12px; color: #666;">
                        <span> Received: ${totalOnTime}</span>
                        <span> Pending: ${totalPending}</span>
                        <span> Overdue: ${totalLate}</span>
                    </div>
                </div>
                
                <!-- Monthly Trend -->
                <div class="sp-section">
                    <h3> Monthly Order Trend (Last 6 Months)</h3>
                    <div class="sp-trend-chart">
                        ${trendMonths.map(m => {
                            const maxOrders = Math.max(...trendMonths.map(x => x.total), 1);
                            const height = (m.total / maxOrders) * 80;
                            return `
                                <div class="sp-trend-bar">
                                    <div style="font-size: 11px; margin-bottom: 5px; color: #666;">${m.total}</div>
                                    <div class="sp-trend-fill" style="height: ${Math.max(height, 5)}px; background: linear-gradient(to top, #7c3aed, #a855f7);"></div>
                                    <div class="sp-trend-label">${m.label}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Supplier Breakdown -->
                <div class="sp-section">
                    <h3> Performance by Supplier</h3>
                    ${sortedSuppliers.length === 0 ? '<p style="color: #666; text-align: center;">No supplier data</p>' : `
                        <div style="overflow-x: auto;">
                            <div style="min-width: 500px;">
                                <div class="sp-supplier-row" style="background: #f3f4f6; font-weight: 600; font-size: 12px;">
                                    <div>Supplier</div>
                                    <div>Fulfillment</div>
                                    <div style="text-align: center;">POs</div>
                                    <div style="text-align: center;">On-Time</div>
                                    <div style="text-align: center;">Overdue</div>
                                </div>
                                ${sortedSuppliers.map((s, i) => {
                                    const onTimeWidth = s.totalPOs > 0 ? ((s.receivedPOs / s.totalPOs) * 100) : 0;
                                    const pendingWidth = s.totalPOs > 0 ? ((s.pendingPOs / s.totalPOs) * 100) : 0;
                                    const lateWidth = s.totalPOs > 0 ? ((s.late / s.totalPOs) * 100) : 0;
                                    return `
                                        <div class="sp-supplier-row">
                                            <div class="sp-supplier-name" title="${s.name}">${s.name}</div>
                                            <div>
                                                <div class="sp-mini-bar">
                                                    ${s.receivedPOs > 0 ? `<div class="sp-mini-bar-fill" style="width: ${onTimeWidth}%; background: #10b981;">${s.receivedPOs}</div>` : ''}
                                                    ${s.pendingPOs > 0 ? `<div class="sp-mini-bar-fill" style="width: ${pendingWidth}%; background: #f59e0b;">${s.pendingPOs}</div>` : ''}
                                                    ${s.late > 0 ? `<div class="sp-mini-bar-fill" style="width: ${lateWidth}%; background: #dc2626;">${s.late}</div>` : ''}
                                                </div>
                                            </div>
                                            <div style="text-align: center; font-weight: 600;">${s.totalPOs}</div>
                                            <div style="text-align: center; color: #10b981; font-weight: 600;">${s.receivedPOs}</div>
                                            <div style="text-align: center; color: ${s.late > 0 ? '#dc2626' : '#666'}; font-weight: 600;">${s.late}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `}
                </div>
                
                <!-- Overdue Orders Alert -->
                ${lateOrders.length > 0 ? `
                    <div class="sp-section" style="border-left: 4px solid #dc2626;">
                        <h3> Overdue Purchase Orders (${lateOrders.length})</h3>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">These orders have passed their due date and have not been received.</p>
                        ${lateOrders.slice(0, 10).map(o => `
                            <div class="sp-late-card">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                    <div>
                                        <strong style="color: #991b1b;">${o.poId}</strong>
                                        <span style="color: #666; margin-left: 10px;">${o.supplier}</span>
                                    </div>
                                    <span class="days-late"> ${o.daysLate} days late</span>
                                </div>
                                <div style="margin-top: 8px; font-size: 13px; color: #666;">
                                    <span> Due: ${o.dueDate?.toLocaleDateString() || '-'}</span>
                                    <span style="margin-left: 15px;"> ${formatMoney(o.amount)}</span>
                                </div>
                            </div>
                        `).join('')}
                        ${lateOrders.length > 10 ? `<p style="color: #666; font-size: 12px; text-align: center;">... and ${lateOrders.length - 10} more overdue orders</p>` : ''}
                    </div>
                ` : `
                    <div class="sp-section" style="border-left: 4px solid #10b981; background: #f0fdf4;">
                        <h3 style="color: #166534;"> No Overdue Orders!</h3>
                        <p style="color: #666; margin: 0;">All pending orders are within their due dates. Great job!</p>
                    </div>
                `}
                
                <!-- Summary Table -->
                <div class="sp-section">
                    <h3> Supplier Summary</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Supplier</th>
                                    <th style="text-align: right;">Total POs</th>
                                    <th style="text-align: right;">Received</th>
                                    <th style="text-align: right;">Pending</th>
                                    <th style="text-align: right;">Overdue</th>
                                    <th style="text-align: right;">Total Spend</th>
                                    <th style="text-align: right;">Avg Days</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedSuppliers.map(s => {
                                    const avgDays = s.fulfillmentDays.length > 0 
                                        ? (s.fulfillmentDays.reduce((a,b) => a+b, 0) / s.fulfillmentDays.length).toFixed(0)
                                        : '-';
                                    return `
                                        <tr>
                                            <td><strong>${s.name}</strong></td>
                                            <td style="text-align: right;">${s.totalPOs}</td>
                                            <td style="text-align: right; color: #10b981;">${s.receivedPOs}</td>
                                            <td style="text-align: right; color: #f59e0b;">${s.pendingPOs}</td>
                                            <td style="text-align: right; color: ${s.late > 0 ? '#dc2626' : '#666'}; font-weight: ${s.late > 0 ? 'bold' : 'normal'};">${s.late}</td>
                                            <td style="text-align: right;">$${s.totalAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                            <td style="text-align: right;">${avgDays}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <p style="margin: 0; font-size: 12px; color: #666;">
                        <strong> Note:</strong> On-time rate is calculated by comparing Receive Date to Due Date. "Avg Days" shows the average lead time from PO creation to receipt.
                    </p>
                </div>
            `;
            
            return html;
        }
        
        // ==================== INVENTORY PICK LIST ====================
        
        async function generatePickListModal() {
            const fromDate = reportFilters.fromDate ? parseLocalDate(reportFilters.fromDate) : null;
            let toDate = reportFilters.toDate ? parseLocalDate(reportFilters.toDate) : null;
            if (toDate) toDate.setHours(23, 59, 59, 999);
            if (fromDate) fromDate.setHours(0, 0, 0, 0);
            const customerFilter = reportFilters.customer || '';
            const deliveryStatus = reportFilters.deliveryStatus || 'needs-delivery';
            const salesInvoiceFilter = reportFilters.salesInvoice || '';
            
            // Fetch all data
            const [salesResult, customersResult, itemsResult, suppliersResult] = await Promise.all([
                apiCall('getSalesOrders'),
                apiCall('getCustomers'),
                apiCall('getItems'),
                apiCall('getSuppliers')
            ]);
            
            if (!salesResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const customers = customersResult?.data || [];
            const items = itemsResult?.data || [];
            const suppliers = suppliersResult?.data || [];
            let sales = salesResult.data;
            
            // Exclude voided orders
            sales = sales.filter(so => so.Status !== 'Voided' && so.Status !== 'Void');
            
            // Date range label
            let dateLabel = 'All Time';
            if (fromDate && toDate) {
                dateLabel = `${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`;
            } else if (fromDate) {
                dateLabel = `Since ${fromDate.toLocaleDateString()}`;
            } else if (toDate) {
                dateLabel = `Through ${toDate.toLocaleDateString()}`;
            }
            
            // Filter by date
            if (fromDate) {
                sales = sales.filter(so => {
                    const d = parseDate(so.Sale_Date || so.SO_Date);
                    return d && d >= fromDate;
                });
            }
            if (toDate) {
                sales = sales.filter(so => {
                    const d = parseDate(so.Sale_Date || so.SO_Date);
                    return d && d <= toDate;
                });
            }
            
            // Filter by customer if specified
            if (customerFilter) {
                sales = sales.filter(so => so.Customer_ID === customerFilter);
            }
            
            // Filter by delivery status
            if (deliveryStatus === 'needs-delivery') {
                // Show Pending, Ready, Out for Delivery (not yet completed/delivered)
                sales = sales.filter(so => 
                    so.Status === 'Pending' || 
                    so.Status === 'Ready' || 
                    so.Status === 'Out for Delivery'
                );
            } else if (deliveryStatus === 'pending') {
                sales = sales.filter(so => so.Status === 'Pending');
            } else if (deliveryStatus === 'ready') {
                sales = sales.filter(so => so.Status === 'Ready');
            } else if (deliveryStatus === 'out') {
                sales = sales.filter(so => so.Status === 'Out for Delivery');
            } else if (deliveryStatus === 'delivered') {
                sales = sales.filter(so => so.Status === 'Completed' || so.Status === 'Delivered');
            }
            
            // Filter by invoice number if specified
            if (salesInvoiceFilter) {
                const searchTerm = salesInvoiceFilter.toLowerCase();
                sales = sales.filter(so => {
                    const invoiceNum = (so.Invoice_Number || so.SO_Number || so.SO_ID || '').toLowerCase();
                    return invoiceNum.includes(searchTerm);
                });
            }
            
            // Build item lookup map
            const itemMap = {};
            items.forEach(item => {
                itemMap[item.Item_ID] = {
                    ...item,
                    supplierName: suppliers.find(s => s.Supplier_ID === item.Supplier_ID)?.Supplier_Name || 'Unknown'
                };
            });
            
            // Gather all line items grouped by customer/order
            const pickListData = [];
            let totalCost = 0, totalSale = 0, totalUnits = 0, totalCases = 0;
            const itemQuantities = {}; // Track total quantities needed per item
            
            for (const so of sales) {
                const customer = customers.find(c => c.Customer_ID === so.Customer_ID);
                const customerName = customer?.Customer_Name || so.Customer_ID;
                const soDate = parseDate(so.Sale_Date || so.SO_Date);
                
                // Get line items
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data && linesResult.data.length > 0) {
                    const orderLines = [];
                    let orderCost = 0, orderSale = 0;
                    
                    for (const line of linesResult.data) {
                        const item = itemMap[line.Item_ID];
                        const qty = parseInt(line.Quantity) || 0;
                        const unitPrice = parseFloat(line.Unit_Price) || 0;
                        const unitsPerPkg = parseFloat(item?.Units_Per_Package) || 1;
                        const pkgCost = parseFloat(item?.Package_Cost) || 0;
                        const unitCost = pkgCost / unitsPerPkg;
                        const lineCost = qty * unitCost;
                        const lineSale = qty * unitPrice;
                        const qtyOnHand = parseInt(item?.Qty_On_Hand) || 0;
                        const casesNeeded = Math.ceil(qty / unitsPerPkg);
                        const uom = item?.Unit_of_Measure || item?.UOM || 'case';
                        
                        orderLines.push({
                            itemId: line.Item_ID,
                            sku: item?.SKU || '-',
                            description: item?.Item_Description || line.Item_ID,
                            supplier: item?.supplierName || 'Unknown',
                            qty: qty,
                            unitsPerPkg: unitsPerPkg,
                            casesNeeded: casesNeeded,
                            uom: uom,
                            unitCost: unitCost,
                            unitPrice: unitPrice,
                            lineCost: lineCost,
                            lineSale: lineSale,
                            qtyOnHand: qtyOnHand,
                            afterPick: qtyOnHand - qty
                        });
                        
                        orderCost += lineCost;
                        orderSale += lineSale;
                        totalUnits += qty;
                        totalCases += casesNeeded;
                        
                        // Track quantities per item
                        if (!itemQuantities[line.Item_ID]) {
                            itemQuantities[line.Item_ID] = {
                                description: item?.Item_Description || line.Item_ID,
                                sku: item?.SKU || '-',
                                supplier: item?.supplierName || 'Unknown',
                                qtyNeeded: 0,
                                casesNeeded: 0,
                                unitsPerPkg: unitsPerPkg,
                                uom: uom,
                                qtyOnHand: qtyOnHand
                            };
                        }
                        itemQuantities[line.Item_ID].qtyNeeded += qty;
                        itemQuantities[line.Item_ID].casesNeeded += casesNeeded;
                    }
                    
                    pickListData.push({
                        soId: so.SO_ID,
                        invoiceNum: so.Invoice_Number || so.SO_ID,
                        customerName: customerName,
                        customerId: so.Customer_ID,
                        customerAddress: customer?.Address || '',
                        customerCity: customer?.City || '',
                        customerState: customer?.State || '',
                        customerZip: customer?.Zip || '',
                        customerPhone: customer?.Phone || '',
                        date: soDate,
                        status: so.Status || 'Pending',
                        lines: orderLines,
                        orderCost: orderCost,
                        orderSale: orderSale,
                        itemCount: orderLines.length
                    });
                    
                    totalCost += orderCost;
                    totalSale += orderSale;
                }
            }
            
            totalSale = pickListData.reduce((sum, o) => sum + o.orderSale, 0);
            const totalProfit = totalSale - totalCost;
            const totalOrders = pickListData.length;
            
            // Check for stock issues
            const stockIssues = Object.entries(itemQuantities).filter(([id, data]) => data.qtyNeeded > data.qtyOnHand);
            
            let html = `
                <style>
                    .pl-header {
                        text-align: center;
                        padding: 25px;
                        background: linear-gradient(135deg, #0891b2, #06b6d4);
                        color: white;
                        border-radius: 16px;
                        margin-bottom: 20px;
                    }
                    .pl-header h2 { margin: 0; font-size: 26px; }
                    .pl-header p { margin: 10px 0 0 0; opacity: 0.9; }
                    
                    .pl-summary {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                        gap: 12px;
                        margin-bottom: 20px;
                    }
                    .pl-stat {
                        background: white;
                        border-radius: 10px;
                        padding: 15px;
                        text-align: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        border-top: 3px solid #0891b2;
                    }
                    .pl-stat .value { font-size: 24px; font-weight: bold; color: #0891b2; }
                    .pl-stat .label { font-size: 11px; color: #666; text-transform: uppercase; margin-top: 3px; }
                    
                    .pl-order {
                        background: white;
                        border-radius: 12px;
                        margin-bottom: 15px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        overflow: hidden;
                    }
                    .pl-order-header {
                        background: #f8fafc;
                        padding: 15px;
                        border-bottom: 1px solid #e2e8f0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-wrap: wrap;
                        gap: 10px;
                    }
                    .pl-order-header .customer { font-weight: 700; font-size: 16px; color: #0f172a; }
                    .pl-order-header .invoice { font-size: 13px; color: #0891b2; }
                    .pl-order-header .date { font-size: 13px; color: #64748b; }
                    .pl-order-header .status {
                        padding: 4px 12px;
                        border-radius: 20px;
                        font-size: 12px;
                        font-weight: 600;
                    }
                    .pl-order-header .status.pending { background: #fef3c7; color: #92400e; }
                    .pl-order-header .status.ready { background: #dbeafe; color: #1e40af; }
                    .pl-order-header .status.out { background: #e0e7ff; color: #4338ca; }
                    .pl-order-header .status.delivered { background: #d1fae5; color: #065f46; }
                    .pl-order-header .status.completed { background: #d1fae5; color: #065f46; }
                    
                    .pl-items {
                        padding: 0;
                    }
                    .pl-item {
                        display: grid;
                        grid-template-columns: 1fr 70px 70px 70px 70px 80px;
                        gap: 8px;
                        padding: 12px 15px;
                        border-bottom: 1px solid #f1f5f9;
                        align-items: center;
                        font-size: 13px;
                    }
                    .pl-item:last-child { border-bottom: none; }
                    .pl-item:hover { background: #f8fafc; }
                    .pl-item-desc { font-weight: 500; }
                    .pl-item-sku { font-size: 11px; color: #64748b; font-family: monospace; }
                    .pl-item-supplier { font-size: 11px; color: #0891b2; }
                    .pl-item .qty { font-weight: 700; text-align: center; }
                    .pl-item .cases { font-weight: 700; text-align: center; color: #7c3aed; }
                    .pl-item .stock { text-align: center; }
                    .pl-item .stock.low { color: #dc2626; font-weight: 600; }
                    .pl-item .stock.ok { color: #059669; }
                    .pl-item .price { text-align: right; }
                    
                    .pl-order-footer {
                        background: #f1f5f9;
                        padding: 12px 15px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-wrap: wrap;
                        gap: 10px;
                        font-size: 13px;
                    }
                    .pl-order-footer .cost { color: #dc2626; }
                    .pl-order-footer .sale { color: #059669; font-weight: 700; }
                    .pl-order-footer .profit { color: #7c3aed; font-weight: 600; }
                    
                    .pl-alert {
                        background: #fef2f2;
                        border: 1px solid #fecaca;
                        border-radius: 10px;
                        padding: 15px;
                        margin-bottom: 20px;
                    }
                    .pl-alert h4 { margin: 0 0 10px 0; color: #991b1b; }
                    .pl-alert-item {
                        display: flex;
                        justify-content: space-between;
                        padding: 8px 0;
                        border-bottom: 1px solid #fecaca;
                        font-size: 13px;
                    }
                    .pl-alert-item:last-child { border-bottom: none; }
                    
                    .pl-totals {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        margin-top: 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    }
                    .pl-totals h3 { margin: 0 0 15px 0; }
                    .pl-total-row {
                        display: flex;
                        justify-content: space-between;
                        padding: 8px 0;
                        border-bottom: 1px solid #f1f5f9;
                    }
                    .pl-total-row:last-child { border-bottom: none; font-weight: bold; font-size: 18px; }
                    
                    .pl-print-btn {
                        background: #0891b2;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    .pl-print-btn:hover { background: #0e7490; }
                    
                    @media (max-width: 768px) {
                        .pl-item {
                            grid-template-columns: 1fr;
                            gap: 8px;
                            padding: 15px;
                            background: white;
                            border-bottom: 2px solid #e2e8f0;
                        }
                        .pl-item > div { text-align: left !important; }
                        
                        /* Hide the header row on mobile */
                        .pl-item.pl-item-header {
                            display: none !important;
                        }
                        
                        /* Style data rows as cards on mobile */
                        .pl-item .pl-item-desc {
                            font-size: 15px;
                            font-weight: 600;
                            color: #0f172a;
                            margin-bottom: 4px;
                        }
                        .pl-item .pl-item-sku {
                            font-size: 12px;
                            color: #64748b;
                        }
                        .pl-item .pl-item-supplier {
                            font-size: 12px;
                            color: #0891b2;
                            margin-bottom: 8px;
                        }
                        
                        /* Inline labels on mobile */
                        .pl-item .qty::before { content: 'Units: '; font-weight: 500; color: #64748b; }
                        .pl-item .cases::before { content: ' Cases: '; font-weight: 500; color: #64748b; }
                        .pl-item .stock::before { content: 'Stock: '; font-weight: 500; color: #64748b; }
                        .pl-item .after::before { content: 'After: '; font-weight: 500; color: #64748b; }
                        .pl-item .price::before { content: 'Price: '; font-weight: 500; color: #64748b; }
                        
                        /* Make values stand out */
                        .pl-item .qty, .pl-item .cases, .pl-item .stock, .pl-item .after, .pl-item .price {
                            display: inline-block;
                            margin-right: 15px;
                            padding: 4px 0;
                        }
                        
                        /* Order header on mobile */
                        .pl-order-header {
                            flex-direction: column;
                            align-items: flex-start;
                        }
                        .pl-order-header > div:last-child {
                            text-align: left !important;
                            margin-top: 8px;
                        }
                    }
                    
                    @media print {
                        /* Hide buttons */
                        .pl-print-btn { display: none !important; }
                        
                        /* Make everything visible and print-friendly */
                        .pl-header {
                            background: #0891b2 !important;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                            padding: 15px !important;
                            margin-bottom: 15px !important;
                        }
                        
                        .pl-header h2 {
                            font-size: 18pt !important;
                            margin: 0 !important;
                        }
                        
                        .pl-header p {
                            font-size: 10pt !important;
                        }
                        
                        /* Summary stats - 3 per row for print */
                        .pl-summary {
                            display: flex !important;
                            flex-wrap: wrap !important;
                            gap: 8px !important;
                            margin-bottom: 15px !important;
                        }
                        
                        .pl-stat {
                            flex: 1 1 100px !important;
                            padding: 8px !important;
                            border: 1px solid #ddd !important;
                        }
                        
                        .pl-stat .value {
                            font-size: 14pt !important;
                        }
                        
                        .pl-stat .label {
                            font-size: 8pt !important;
                        }
                        
                        /* Stock alert */
                        .pl-alert {
                            border: 2px solid #dc2626 !important;
                            padding: 10px !important;
                            margin-bottom: 15px !important;
                            page-break-inside: avoid !important;
                        }
                        
                        .pl-alert h4 {
                            font-size: 12pt !important;
                            margin-bottom: 8px !important;
                        }
                        
                        .pl-alert-item {
                            font-size: 10pt !important;
                            padding: 5px 0 !important;
                        }
                        
                        /* Orders */
                        .pl-order {
                            page-break-inside: avoid !important;
                            margin-bottom: 15px !important;
                            border: 1px solid #ddd !important;
                        }
                        
                        .pl-order-header {
                            padding: 10px !important;
                            background: #f8f8f8 !important;
                        }
                        
                        .pl-order-header .customer {
                            font-size: 12pt !important;
                            font-weight: bold !important;
                        }
                        
                        .pl-order-header .invoice,
                        .pl-order-header .date {
                            font-size: 9pt !important;
                        }
                        
                        /* Item rows - table layout for print */
                        .pl-item {
                            display: table-row !important;
                            font-size: 9pt !important;
                        }
                        
                        .pl-item > div {
                            display: table-cell !important;
                            padding: 4px 6px !important;
                            border-bottom: 1px solid #eee !important;
                        }
                        
                        .pl-item.pl-item-header {
                            display: table-row !important;
                            background: #f0f0f0 !important;
                            font-size: 8pt !important;
                            font-weight: bold !important;
                        }
                        
                        .pl-items {
                            display: table !important;
                            width: 100% !important;
                        }
                        
                        /* Remove ::before labels in print */
                        .pl-item .qty::before,
                        .pl-item .cases::before,
                        .pl-item .stock::before,
                        .pl-item .after::before,
                        .pl-item .price::before {
                            content: none !important;
                        }
                        
                        /* Order footer */
                        .pl-order-footer {
                            padding: 8px 10px !important;
                            font-size: 9pt !important;
                            background: #f8f8f8 !important;
                        }
                    }
                </style>
                
                <div class="pl-header">
                    <h2> Pick List / Delivery Manifest</h2>
                    <p>${dateLabel}  ${
                        deliveryStatus === 'needs-delivery' ? ' Needs Delivery' : 
                        deliveryStatus === 'pending' ? ' Pending Orders' : 
                        deliveryStatus === 'ready' ? ' Ready for Pickup' : 
                        deliveryStatus === 'out' ? ' Out for Delivery' : 
                        deliveryStatus === 'delivered' ? ' Delivered/Completed' : 
                        'All Orders'
                    }${customerFilter ? '  Filtered by customer' : ''}${salesInvoiceFilter ? `  Invoice: ${salesInvoiceFilter}` : ''}</p>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <div style="font-size: 14px; color: #666;">
                         Generated: ${new Date().toLocaleString()}
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="pl-print-btn" onclick="window.print()">
                             Print Manifest
                        </button>
                        <button class="pl-print-btn" style="background: #7c3aed;" onclick="printShippingLabels()">
                             Print Labels
                        </button>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="pl-summary">
                    <div class="pl-stat">
                        <div class="value">${totalOrders}</div>
                        <div class="label">Orders</div>
                    </div>
                    <div class="pl-stat" style="border-top-color: #7c3aed;">
                        <div class="value" style="color: #7c3aed;">${totalCases}</div>
                        <div class="label"> Cases to Load</div>
                    </div>
                    <div class="pl-stat" style="border-top-color: #059669;">
                        <div class="value" style="color: #059669;">${totalUnits}</div>
                        <div class="label">Total Units</div>
                    </div>
                    <div class="pl-stat" style="border-top-color: #dc2626;">
                        <div class="value" style="color: #dc2626;">${formatMoney(totalCost)}</div>
                        <div class="label">Your Cost</div>
                    </div>
                    <div class="pl-stat" style="border-top-color: #059669;">
                        <div class="value" style="color: #059669;">${formatMoney(totalSale)}</div>
                        <div class="label">Sale Value</div>
                    </div>
                    <div class="pl-stat" style="border-top-color: #7c3aed;">
                        <div class="value" style="color: #7c3aed;">${formatMoney(totalProfit)}</div>
                        <div class="label">Gross Profit</div>
                    </div>
                </div>
                
                ${stockIssues.length > 0 ? `
                    <div class="pl-alert">
                        <h4> Stock Warning - ${stockIssues.length} Item(s) Need Attention</h4>
                        ${stockIssues.map(([id, data]) => `
                            <div class="pl-alert-item">
                                <div>
                                    <strong>${data.description}</strong>
                                    <span style="color: #666; margin-left: 10px;">${data.sku}</span>
                                </div>
                                <div>
                                    <span style="color: #dc2626;">Need: ${data.qtyNeeded}</span>
                                    <span style="margin: 0 10px;">|</span>
                                    <span>Have: ${data.qtyOnHand}</span>
                                    <span style="margin: 0 10px;">|</span>
                                    <span style="color: #dc2626; font-weight: 600;">Short: ${data.qtyNeeded - data.qtyOnHand}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <!-- Consolidated Pick Summary -->
                ${Object.keys(itemQuantities).length > 0 ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #0891b2;">
                        <h3 style="margin: 0 0 15px 0; color: #0f172a;"> Consolidated Pick List - What to Grab</h3>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">Total items to pick across all orders:</p>
                        <div style="overflow-x: auto;">
                            <table class="data-table" style="margin: 0;">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>SKU</th>
                                        <th>Supplier</th>
                                        <th style="text-align: center;"> Cases</th>
                                        <th style="text-align: center;">Units</th>
                                        <th style="text-align: center;">In Stock</th>
                                        <th style="text-align: center;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(itemQuantities)
                                        .sort((a, b) => b[1].casesNeeded - a[1].casesNeeded)
                                        .map(([itemId, data]) => {
                                            const isShort = data.qtyNeeded > data.qtyOnHand;
                                            const remaining = data.qtyOnHand - data.qtyNeeded;
                                            return `
                                                <tr style="${isShort ? 'background: #fef2f2;' : ''}">
                                                    <td><strong>${data.description}</strong></td>
                                                    <td style="font-family: monospace; font-size: 12px; color: #64748b;">${data.sku}</td>
                                                    <td style="font-size: 12px; color: #0891b2;">${data.supplier}</td>
                                                    <td style="text-align: center; font-weight: 700; color: #7c3aed; font-size: 16px;">
                                                        ${data.casesNeeded}
                                                        <span style="font-size: 10px; font-weight: normal; color: #666;">${data.uom}${data.casesNeeded !== 1 ? 's' : ''}</span>
                                                    </td>
                                                    <td style="text-align: center;">${data.qtyNeeded}</td>
                                                    <td style="text-align: center; color: ${isShort ? '#dc2626' : '#059669'}; font-weight: ${isShort ? '600' : 'normal'};">${data.qtyOnHand}</td>
                                                    <td style="text-align: center;">
                                                        ${isShort 
                                                            ? `<span style="background: #dc2626; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;"> Short ${Math.abs(remaining)}</span>`
                                                            : `<span style="background: #059669; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;"> OK</span>`
                                                        }
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
                
                ${pickListData.length === 0 ? `
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 15px;"></div>
                        <h3 style="margin: 0; color: #666;">No Orders Found</h3>
                        <p style="color: #999;">Try adjusting your filters to see orders.</p>
                    </div>
                ` : `
                    <!-- Orders -->
                    ${pickListData.map(order => {
                        // Build address string
                        const addressParts = [];
                        if (order.customerAddress) addressParts.push(order.customerAddress);
                        const cityStateZip = [order.customerCity, order.customerState, order.customerZip].filter(Boolean).join(', ');
                        if (cityStateZip) addressParts.push(cityStateZip);
                        const fullAddress = addressParts.join('<br>');
                        
                        return `
                        <div class="pl-order">
                            <div class="pl-order-header">
                                <div>
                                    <div class="customer"> ${order.customerName}</div>
                                    ${fullAddress ? `<div style="font-size: 13px; color: #475569; margin-top: 4px; line-height: 1.4;"> ${fullAddress}</div>` : ''}
                                    <div class="invoice" style="margin-top: 4px;"> ${order.invoiceNum}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div class="date"> ${order.date?.toLocaleDateString() || '-'}</div>
                                    <span class="status ${
                                        order.status === 'Completed' ? 'completed' : 
                                        order.status === 'Delivered' ? 'delivered' : 
                                        order.status === 'Out for Delivery' ? 'out' : 
                                        order.status === 'Ready' ? 'ready' : 
                                        'pending'
                                    }">
                                        ${
                                            order.status === 'Completed' ? ' Completed' : 
                                            order.status === 'Delivered' ? ' Delivered' : 
                                            order.status === 'Out for Delivery' ? ' Out for Delivery' : 
                                            order.status === 'Ready' ? ' Ready' : 
                                            ' Pending'
                                        }
                                    </span>
                                </div>
                            </div>
                            
                            <div class="pl-items">
                                <div class="pl-item pl-item-header" style="background: #f8fafc; font-weight: 600; font-size: 11px; text-transform: uppercase; color: #64748b;">
                                    <div>Item</div>
                                    <div style="text-align: center;">Units</div>
                                    <div style="text-align: center;"> Cases</div>
                                    <div style="text-align: center;">Stock</div>
                                    <div style="text-align: center;">After</div>
                                    <div style="text-align: right;">Price</div>
                                </div>
                                ${order.lines.map(line => `
                                    <div class="pl-item">
                                        <div>
                                            <div class="pl-item-desc">${line.description}</div>
                                            <div class="pl-item-sku">${line.sku}</div>
                                            <div class="pl-item-supplier"> ${line.supplier}</div>
                                        </div>
                                        <div class="qty">${line.qty}</div>
                                        <div class="cases" title="${line.unitsPerPkg} per ${line.uom}">
                                            ${line.casesNeeded} <span style="font-size: 10px; font-weight: normal; color: #666;">${line.uom}${line.casesNeeded !== 1 ? 's' : ''}</span>
                                        </div>
                                        <div class="stock ${line.qtyOnHand < line.qty ? 'low' : 'ok'}">
                                            ${line.qtyOnHand}
                                        </div>
                                        <div class="after ${line.afterPick < 0 ? 'low' : 'ok'}">
                                            ${line.afterPick}
                                        </div>
                                        <div class="price">${formatMoney(line.lineSale)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="pl-order-footer">
                                <div>
                                    <span style="color: #666;">${order.itemCount} item(s)</span>
                                </div>
                                <div style="display: flex; gap: 20px;">
                                    <span class="cost">Cost: ${formatMoney(order.orderCost)}</span>
                                    <span class="sale">Sale: ${formatMoney(order.orderSale)}</span>
                                    <span class="profit">Profit: ${formatMoney(order.orderSale - order.orderCost)}</span>
                                </div>
                            </div>
                        </div>
                    `}).join('')}
                    
                    <!-- Totals -->
                    <div class="pl-totals">
                        <h3> Pick List Summary</h3>
                        <div class="pl-total-row">
                            <span>Total Orders</span>
                            <span>${totalOrders}</span>
                        </div>
                        <div class="pl-total-row">
                            <span> Total Cases to Load</span>
                            <span style="color: #7c3aed; font-weight: 600;">${totalCases}</span>
                        </div>
                        <div class="pl-total-row">
                            <span>Total Units to Pick</span>
                            <span>${totalUnits}</span>
                        </div>
                        <div class="pl-total-row">
                            <span>Your Cost (COGS)</span>
                            <span style="color: #dc2626;">${formatMoney(totalCost)}</span>
                        </div>
                        <div class="pl-total-row">
                            <span>Total Sale Value</span>
                            <span style="color: #059669;">${formatMoney(totalSale)}</span>
                        </div>
                        <div class="pl-total-row">
                            <span> Gross Profit</span>
                            <span style="color: #7c3aed;">${formatMoney(totalProfit)}</span>
                        </div>
                    </div>
                `}
            `;
            
            // Store label data for printing
            window.pickListLabelData = pickListData.map(order => ({
                customerName: order.customerName,
                customerAddress: order.customerAddress,
                customerCity: order.customerCity,
                customerState: order.customerState,
                customerZip: order.customerZip,
                invoiceNum: order.invoiceNum,
                date: order.date,
                lines: order.lines.map(line => ({
                    description: line.description,
                    sku: line.sku,
                    casesNeeded: line.casesNeeded,
                    unitsPerPkg: line.unitsPerPkg,
                    uom: line.uom,
                    qty: line.qty
                })),
                totalCases: order.lines.reduce((sum, line) => sum + line.casesNeeded, 0),
                status: order.status
            }));
            
            return html;
        }
        
        // Print Shipping Labels Function
        function printShippingLabels() {
            const labelData = window.pickListLabelData || [];
            
            if (labelData.length === 0) {
                alert('No orders to print labels for!');
                return;
            }
            
            // Generate all labels - one per item case
            const allLabels = [];
            const today = new Date().toLocaleDateString();
            
            labelData.forEach(order => {
                // Build full address
                const addressParts = [];
                if (order.customerAddress) addressParts.push(order.customerAddress);
                const cityStateZip = [order.customerCity, order.customerState, order.customerZip].filter(Boolean).join(', ');
                if (cityStateZip) addressParts.push(cityStateZip);
                const fullAddress = addressParts.join('<br>');
                
                // Create labels for each item's cases
                order.lines.forEach(line => {
                    const unitsPerPkg = line.unitsPerPkg || 1;
                    const totalQty = line.qty;
                    const fullCases = Math.floor(totalQty / unitsPerPkg);
                    const partialUnits = totalQty % unitsPerPkg;
                    const totalLabels = fullCases + (partialUnits > 0 ? 1 : 0);
                    
                    // Create labels for full cases
                    for (let box = 1; box <= fullCases; box++) {
                        allLabels.push({
                            customerName: order.customerName,
                            customerAddress: fullAddress,
                            invoiceNum: order.invoiceNum,
                            date: order.date?.toLocaleDateString() || today,
                            itemName: line.description,
                            itemSku: line.sku || '-',
                            itemQty: unitsPerPkg,
                            isPartial: false,
                            unitsPerPkg: unitsPerPkg,
                            boxNum: box,
                            totalBoxesForItem: totalLabels,
                            uom: line.uom || 'case'
                        });
                    }
                    
                    // Create label for partial case if any
                    if (partialUnits > 0) {
                        allLabels.push({
                            customerName: order.customerName,
                            customerAddress: fullAddress,
                            invoiceNum: order.invoiceNum,
                            date: order.date?.toLocaleDateString() || today,
                            itemName: line.description,
                            itemSku: line.sku || '-',
                            itemQty: partialUnits,
                            isPartial: true,
                            unitsPerPkg: unitsPerPkg,
                            boxNum: fullCases + 1,
                            totalBoxesForItem: totalLabels,
                            uom: line.uom || 'case'
                        });
                    }
                });
            });
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Shipping Labels - Nowak Distributing</title>
                    <style>
                        @page {
                            size: letter;
                            margin: 0.25in;
                        }
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        body {
                            font-family: Arial, sans-serif;
                            background: white;
                        }
                        .label-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 0.2in;
                            padding: 0.2in;
                        }
                        .label {
                            border: 2px solid #333;
                            border-radius: 8px;
                            padding: 12px;
                            height: 3.2in;
                            display: flex;
                            flex-direction: column;
                            page-break-inside: avoid;
                            background: white;
                        }
                        .label-header {
                            text-align: center;
                            border-bottom: 2px solid #333;
                            padding-bottom: 6px;
                            margin-bottom: 8px;
                        }
                        .label-header .company {
                            font-size: 12px;
                            font-weight: bold;
                            color: #333;
                        }
                        .label-body {
                            flex: 1;
                            display: flex;
                            flex-direction: column;
                        }
                        .customer-section {
                            margin-bottom: 8px;
                        }
                        .customer-name {
                            font-size: 18px;
                            font-weight: bold;
                            color: #000;
                            margin-bottom: 3px;
                        }
                        .customer-address {
                            font-size: 11px;
                            color: #444;
                            line-height: 1.3;
                        }
                        .order-info {
                            font-size: 10px;
                            color: #666;
                            margin-bottom: 8px;
                            display: flex;
                            justify-content: space-between;
                        }
                        .item-section {
                            background: #f5f5f5;
                            border: 2px solid #666;
                            border-radius: 6px;
                            padding: 8px;
                            margin-bottom: 8px;
                            flex: 1;
                        }
                        .item-label {
                            font-size: 9px;
                            color: #666;
                            text-transform: uppercase;
                            margin-bottom: 2px;
                        }
                        .item-name {
                            font-size: 14px;
                            font-weight: bold;
                            color: #000;
                            line-height: 1.2;
                        }
                        .item-sku {
                            font-size: 10px;
                            font-family: monospace;
                            color: #666;
                            margin-top: 2px;
                        }
                        .item-qty {
                            font-size: 11px;
                            color: #444;
                            margin-top: 4px;
                        }
                        .label-footer {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            border-top: 2px solid #333;
                            padding-top: 8px;
                        }
                        .box-indicator {
                            font-size: 16px;
                            font-weight: bold;
                            color: #000;
                            background: #e0e0e0;
                            padding: 4px 10px;
                            border-radius: 5px;
                            border: 2px solid #333;
                        }
                        .box-indicator.partial {
                            background: #fff3cd;
                            border-color: #f59e0b;
                            color: #92400e;
                        }
                        .box-indicator.full {
                            background: #d1fae5;
                            border-color: #10b981;
                            color: #065f46;
                        }
                        .box-total {
                            font-size: 11px;
                            color: #666;
                            text-align: center;
                        }
                        .checkbox-area {
                            display: flex;
                            align-items: center;
                            gap: 4px;
                        }
                        .checkbox {
                            width: 18px;
                            height: 18px;
                            border: 2px solid #333;
                            border-radius: 3px;
                        }
                        .checkbox-label {
                            font-size: 10px;
                            color: #666;
                        }
                        @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            .label { break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="label-grid">
                        ${allLabels.map(label => `
                            <div class="label">
                                <div class="label-header">
                                    <div class="company"> NOWAK DISTRIBUTING</div>
                                </div>
                                <div class="label-body">
                                    <div class="customer-section">
                                        <div class="customer-name">${label.customerName}</div>
                                        ${label.customerAddress ? `<div class="customer-address">${label.customerAddress}</div>` : ''}
                                    </div>
                                    <div class="order-info">
                                        <span> ${label.invoiceNum}</span>
                                        <span> ${label.date}</span>
                                    </div>
                                    <div class="item-section">
                                        <div class="item-label">Contents:</div>
                                        <div class="item-name">${label.itemName}</div>
                                        <div class="item-sku">SKU: ${label.itemSku}</div>
                                        <div class="item-qty">${label.itemQty} units ${label.isPartial ? `(of ${label.unitsPerPkg} per ${label.uom})` : ''}</div>
                                    </div>
                                </div>
                                <div class="label-footer">
                                    <div class="box-indicator ${label.isPartial ? 'partial' : 'full'}">
                                        ${label.isPartial 
                                            ? ` PARTIAL` 
                                            : ` FULL ${label.uom.toUpperCase()}`
                                        }
                                    </div>
                                    <div class="box-total">
                                        ${label.isPartial 
                                            ? `${label.itemQty} of ${label.unitsPerPkg}` 
                                            : `#${label.boxNum} of ${label.totalBoxesForItem}`
                                        }
                                    </div>
                                    <div class="checkbox-area">
                                        <div class="checkbox"></div>
                                        <div class="checkbox-label"></div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <scr` + `ipt>
                        window.onload = function() {
                            window.print();
                        }
                    <` + `/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // Dormant Customers Report - Win back inactive customers
        async function generateDormantCustomersModal() {
            const dormantThreshold = reportFilters.dormantDays || 30;
            const sortBy = reportFilters.dormantSort || 'days-desc';
            
            // Fetch all necessary data
            const [salesResult, customersResult, itemsResult] = await Promise.all([
                apiCall('getSalesOrders'),
                apiCall('getCustomers'),
                apiCall('getItems')
            ]);
            
            if (!salesResult?.data || !customersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const sales = salesResult.data.filter(s => s.Status !== 'Voided');
            const customers = customersResult.data;
            const items = itemsResult?.data || [];
            
            // Build item lookup
            const itemMap = {};
            items.forEach(item => {
                itemMap[item.Item_ID] = item.Item_Description || item.SKU || item.Item_ID;
            });
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const thresholdDate = new Date(today);
            thresholdDate.setDate(thresholdDate.getDate() - dormantThreshold);
            
            // Analyze each customer's buying history
            const customerAnalysis = [];
            
            for (const customer of customers) {
                // Get all orders for this customer
                const customerOrders = sales.filter(s => s.Customer_ID === customer.Customer_ID);
                
                if (customerOrders.length === 0) continue; // Skip customers who never ordered
                
                // Sort by date to find latest order
                customerOrders.sort((a, b) => new Date(b.Sale_Date || b.SO_Date) - new Date(a.Sale_Date || a.SO_Date));
                
                const lastOrder = customerOrders[0];
                const lastOrderDate = new Date(lastOrder.Sale_Date || lastOrder.SO_Date);
                lastOrderDate.setHours(0, 0, 0, 0);
                
                // Only include if last order was before threshold
                if (lastOrderDate >= thresholdDate) continue;
                
                const daysSinceOrder = Math.floor((today - lastOrderDate) / (1000 * 60 * 60 * 24));
                
                // Calculate stats
                const totalOrders = customerOrders.length;
                const totalSpent = customerOrders.reduce((sum, o) => sum + (parseFloat(o.Total_Amount) || 0), 0);
                const avgOrderValue = totalSpent / totalOrders;
                
                // Find first order date for customer lifetime
                const firstOrderDate = new Date(customerOrders[customerOrders.length - 1].Sale_Date || customerOrders[customerOrders.length - 1].SO_Date);
                const customerLifetimeDays = Math.floor((lastOrderDate - firstOrderDate) / (1000 * 60 * 60 * 24)) + 1;
                const orderFrequency = totalOrders > 1 ? Math.round(customerLifetimeDays / (totalOrders - 1)) : 0;
                
                // Get last order line items
                let lastOrderItems = [];
                try {
                    const linesResult = await apiCall('getSalesOrderLines', { soId: lastOrder.SO_ID });
                    if (linesResult?.data) {
                        lastOrderItems = linesResult.data.map(line => ({
                            name: itemMap[line.Item_ID] || line.Item_ID,
                            qty: parseInt(line.Quantity) || 0,
                            price: parseFloat(line.Unit_Price) || 0,
                            total: (parseInt(line.Quantity) || 0) * (parseFloat(line.Unit_Price) || 0)
                        }));
                    }
                } catch(e) {
                    // Skip if can't fetch lines
                }
                
                // Build address
                const addressParts = [];
                if (customer.Address) addressParts.push(customer.Address);
                const cityStateZip = [customer.City, customer.State, customer.Zip].filter(Boolean).join(', ');
                if (cityStateZip) addressParts.push(cityStateZip);
                
                customerAnalysis.push({
                    customerId: customer.Customer_ID,
                    name: customer.Customer_Name || customer.Customer_ID,
                    phone: customer.Phone || '',
                    mobile: customer.Mobile || '',
                    email: customer.Email || '',
                    address: customer.Address || '',
                    city: customer.City || '',
                    state: customer.State || '',
                    zip: customer.Zip || '',
                    fullAddress: addressParts.join(', '),
                    lastOrderDate: lastOrderDate,
                    daysSinceOrder: daysSinceOrder,
                    totalOrders: totalOrders,
                    totalSpent: totalSpent,
                    avgOrderValue: avgOrderValue,
                    orderFrequency: orderFrequency,
                    lastOrderItems: lastOrderItems,
                    lastOrderTotal: parseFloat(lastOrder.Total_Amount) || 0,
                    lastInvoice: lastOrder.Invoice_Number || lastOrder.SO_ID
                });
            }
            
            // Sort based on user selection
            switch(sortBy) {
                case 'days-asc':
                    customerAnalysis.sort((a, b) => a.daysSinceOrder - b.daysSinceOrder);
                    break;
                case 'city':
                    customerAnalysis.sort((a, b) => (a.city || '').localeCompare(b.city || ''));
                    break;
                case 'value-desc':
                    customerAnalysis.sort((a, b) => b.totalSpent - a.totalSpent);
                    break;
                case 'orders-desc':
                    customerAnalysis.sort((a, b) => b.totalOrders - a.totalOrders);
                    break;
                default: // days-desc
                    customerAnalysis.sort((a, b) => b.daysSinceOrder - a.daysSinceOrder);
            }
            
            // Calculate summary stats
            const totalDormant = customerAnalysis.length;
            const totalAtRisk = customerAnalysis.reduce((sum, c) => sum + c.totalSpent, 0);
            const avgDormantDays = totalDormant > 0 ? Math.round(customerAnalysis.reduce((sum, c) => sum + c.daysSinceOrder, 0) / totalDormant) : 0;
            const highValueDormant = customerAnalysis.filter(c => c.totalSpent > 500).length;
            
            // Determine dormancy level
            function getDormancyLevel(days) {
                if (days >= 180) return { label: ' Critical', color: '#dc2626', bg: '#fef2f2' };
                if (days >= 90) return { label: ' High Risk', color: '#ea580c', bg: '#fff7ed' };
                if (days >= 60) return { label: ' At Risk', color: '#ca8a04', bg: '#fefce8' };
                return { label: ' Watch', color: '#16a34a', bg: '#f0fdf4' };
            }
            
            let html = `
                <style>
                    .dormant-header {
                        text-align: center;
                        padding: 25px;
                        background: linear-gradient(135deg, #f59e0b, #d97706);
                        color: white;
                        border-radius: 16px;
                        margin-bottom: 20px;
                    }
                    .dormant-header h2 { margin: 0; font-size: 26px; }
                    .dormant-header p { margin: 10px 0 0 0; opacity: 0.9; }
                    
                    .dormant-summary {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    .dormant-stat {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        text-align: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        border-top: 4px solid #f59e0b;
                    }
                    .dormant-stat .value { font-size: 28px; font-weight: bold; color: #f59e0b; }
                    .dormant-stat .label { font-size: 12px; color: #666; text-transform: uppercase; margin-top: 5px; }
                    
                    .insight-box {
                        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
                        border: 2px solid #f59e0b;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 25px;
                    }
                    .insight-box h3 { margin: 0 0 15px 0; color: #92400e; }
                    .insight-item {
                        display: flex;
                        align-items: flex-start;
                        gap: 10px;
                        margin-bottom: 10px;
                        font-size: 14px;
                        color: #78350f;
                    }
                    .insight-item:last-child { margin-bottom: 0; }
                    
                    .customer-card {
                        background: white;
                        border-radius: 12px;
                        margin-bottom: 15px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        overflow: hidden;
                        border-left: 5px solid #f59e0b;
                    }
                    .customer-card-header {
                        padding: 15px 20px;
                        background: #fafafa;
                        border-bottom: 1px solid #e5e7eb;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        flex-wrap: wrap;
                        gap: 10px;
                    }
                    .customer-name { font-size: 18px; font-weight: 700; color: #1f2937; }
                    .customer-address { font-size: 13px; color: #6b7280; margin-top: 4px; line-height: 1.4; }
                    .customer-contact { font-size: 13px; color: #3b82f6; margin-top: 4px; }
                    .dormancy-badge {
                        padding: 6px 14px;
                        border-radius: 20px;
                        font-size: 13px;
                        font-weight: 600;
                    }
                    
                    .customer-stats {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                        gap: 15px;
                        padding: 15px 20px;
                        background: #f9fafb;
                    }
                    .stat-item {
                        text-align: center;
                    }
                    .stat-item .stat-value { font-size: 18px; font-weight: 700; color: #1f2937; }
                    .stat-item .stat-label { font-size: 11px; color: #6b7280; text-transform: uppercase; }
                    
                    .last-order-section {
                        padding: 15px 20px;
                        border-top: 1px solid #e5e7eb;
                    }
                    .last-order-title { font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px; }
                    .last-order-items {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 8px;
                    }
                    .order-item-chip {
                        background: #e0e7ff;
                        color: #3730a3;
                        padding: 5px 12px;
                        border-radius: 15px;
                        font-size: 12px;
                        font-weight: 500;
                    }
                    
                    .action-section {
                        padding: 15px 20px;
                        background: #fefce8;
                        border-top: 1px solid #fde047;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-wrap: wrap;
                        gap: 10px;
                    }
                    .action-hint { font-size: 13px; color: #854d0e; }
                    .action-btn {
                        background: #f59e0b;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 20px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 13px;
                    }
                    .action-btn:hover { background: #d97706; }
                    
                    @media print {
                        .action-section { display: none; }
                        .customer-card { break-inside: avoid; }
                    }
                </style>
                
                <div class="dormant-header">
                    <h2> Dormant Customers Report</h2>
                    <p>Customers with no orders in the last ${dormantThreshold} days  Time to reconnect!</p>
                </div>
                
                <div class="dormant-summary">
                    <div class="dormant-stat">
                        <div class="value">${totalDormant}</div>
                        <div class="label">Dormant Customers</div>
                    </div>
                    <div class="dormant-stat" style="border-top-color: #dc2626;">
                        <div class="value" style="color: #dc2626;">${formatMoney(totalAtRisk)}</div>
                        <div class="label"> Revenue at Risk</div>
                    </div>
                    <div class="dormant-stat" style="border-top-color: #7c3aed;">
                        <div class="value" style="color: #7c3aed;">${avgDormantDays}</div>
                        <div class="label"> Avg Days Dormant</div>
                    </div>
                    <div class="dormant-stat" style="border-top-color: #059669;">
                        <div class="value" style="color: #059669;">${highValueDormant}</div>
                        <div class="label"> High Value ($500+)</div>
                    </div>
                </div>
                
                <div class="insight-box">
                    <h3> Sales Call Strategy</h3>
                    <div class="insight-item">
                        <span></span>
                        <span><strong>Review their last order</strong> below before calling - know what they typically buy so you can suggest reorders.</span>
                    </div>
                    <div class="insight-item">
                        <span></span>
                        <span><strong>Prioritize high-value customers</strong> - Sort by "Highest Value First" to focus on your most important relationships.</span>
                    </div>
                    <div class="insight-item">
                        <span></span>
                        <span><strong>Check their order frequency</strong> - If they usually order every 14 days and it's been 30, they're overdue!</span>
                    </div>
                    <div class="insight-item">
                        <span></span>
                        <span><strong>Plan your route</strong> - Sort by City to group nearby customers for efficient in-person visits.</span>
                    </div>
                </div>
            `;
            
            if (customerAnalysis.length === 0) {
                html += `
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 15px;"></div>
                        <h3 style="margin: 0; color: #059669;">Great News!</h3>
                        <p style="color: #666;">No dormant customers in this time period. Everyone's been ordering!</p>
                    </div>
                `;
            } else {
                // Customer detail cards
                html += `<h3 style="margin: 0 0 15px 0; color: #1f2937;"> Customer Details (${customerAnalysis.length} customers)</h3>`;
                
                customerAnalysis.forEach(customer => {
                    const level = getDormancyLevel(customer.daysSinceOrder);
                    
                    // Build contact info section
                    let contactHtml = '';
                    if (customer.phone || customer.mobile) {
                        contactHtml += '<div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 8px;">';
                        if (customer.phone) {
                            contactHtml += `<a href="tel:${customer.phone.replace(/[^0-9+]/g, '')}" style="color: #2563eb; text-decoration: none; font-size: 13px; display: flex; align-items: center; gap: 4px;"> <span style="text-decoration: underline;">${customer.phone}</span></a>`;
                        }
                        if (customer.mobile) {
                            contactHtml += `<a href="tel:${customer.mobile.replace(/[^0-9+]/g, '')}" style="color: #2563eb; text-decoration: none; font-size: 13px; display: flex; align-items: center; gap: 4px;"> <span style="text-decoration: underline;">${customer.mobile}</span></a>`;
                        }
                        contactHtml += '</div>';
                    }
                    if (customer.email) {
                        contactHtml += `<div style="margin-top: 4px;"><a href="mailto:${customer.email}" style="color: #2563eb; text-decoration: none; font-size: 13px; display: flex; align-items: center; gap: 4px;"> <span style="text-decoration: underline;">${customer.email}</span></a></div>`;
                    }
                    
                    html += `
                        <div class="customer-card" style="border-left-color: ${level.color};">
                            <div class="customer-card-header">
                                <div style="flex: 1;">
                                    <div class="customer-name"> ${customer.name}</div>
                                    ${customer.fullAddress ? `
                                        <div style="margin-top: 8px; padding: 10px 12px; background: #f8fafc; border-radius: 8px; border-left: 3px solid #3b82f6;">
                                            <div style="font-size: 12px; color: #64748b; text-transform: uppercase; margin-bottom: 4px; font-weight: 600;"> Delivery Address</div>
                                            <div style="font-size: 14px; color: #1f2937; line-height: 1.5;">
                                                ${customer.address ? customer.address + '<br>' : ''}
                                                ${[customer.city, customer.state].filter(Boolean).join(', ')}${customer.zip ? ' ' + customer.zip : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${contactHtml}
                                </div>
                                <div style="text-align: right;">
                                    <div class="dormancy-badge" style="background: ${level.bg}; color: ${level.color};">
                                        ${level.label}  ${customer.daysSinceOrder} days
                                    </div>
                                    <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                        Last order: ${(customer.lastOrderDate.getMonth()+1) + '/' + customer.lastOrderDate.getDate() + '/' + customer.lastOrderDate.getFullYear()}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="customer-stats">
                                <div class="stat-item">
                                    <div class="stat-value">${formatMoney(customer.totalSpent)}</div>
                                    <div class="stat-label">Lifetime Value</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${customer.totalOrders}</div>
                                    <div class="stat-label">Total Orders</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${formatMoney(customer.avgOrderValue)}</div>
                                    <div class="stat-label">Avg Order</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${customer.orderFrequency > 0 ? customer.orderFrequency + ' days' : 'N/A'}</div>
                                    <div class="stat-label">Order Frequency</div>
                                </div>
                            </div>
                            
                            <div class="last-order-section">
                                <div class="last-order-title"> Last Order (${customer.lastInvoice}) - ${formatMoney(customer.lastOrderTotal)}</div>
                                <div class="last-order-items">
                                    ${customer.lastOrderItems.length > 0 
                                        ? customer.lastOrderItems.map(item => 
                                            `<span class="order-item-chip">${item.qty}x ${item.name}</span>`
                                        ).join('')
                                        : '<span style="color: #666; font-size: 13px;">No line items recorded</span>'
                                    }
                                </div>
                            </div>
                            
                            <div class="action-section">
                                <div class="action-hint">
                                    ${customer.orderFrequency > 0 && customer.daysSinceOrder > customer.orderFrequency * 1.5
                                        ? ` Usually orders every ${customer.orderFrequency} days - ${Math.round(customer.daysSinceOrder / customer.orderFrequency)}x overdue!`
                                        : ` ${customer.totalOrders} orders over their history`
                                    }
                                </div>
                                <button class="action-btn" onclick="createSalesOrderForCustomer('${customer.customerId}')">
                                     New Order
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            return html;
        }
        
        async function generateSimpleInventoryModal() {
            return await generateInventoryReportModal('simple');
        }
        
        // Inventory Adjustments Report
        async function generateInventoryAdjustmentsModal() {
            try {
                console.log(' Loading inventory adjustments report...');
                console.log(' User agent:', navigator.userAgent);
                console.log(' Report filters:', reportFilters);
                
                const [adjustmentsResult, itemsResult] = await Promise.all([
                    apiCall('getInventoryAdjustments'),
                    apiCall('getItems')
                ]);
                
                console.log(' Adjustments API result:', adjustmentsResult);
                console.log(' Items API result:', itemsResult);
                
                if (!adjustmentsResult) {
                    console.error(' adjustmentsResult is null/undefined');
                    return `<h3 style="margin-top: 0;"> Inventory Adjustment History</h3>
                        <div style="background: #ffebee; border: 2px solid #f44336; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <p style="color: #c62828; margin: 0;"><strong> Error:</strong> Failed to load adjustments data.</p>
                            <p style="color: #666; font-size: 13px; margin: 10px 0 0 0;">This might be a network issue or the Inventory_Adjustments sheet doesn't exist. Check your Google Sheets.</p>
                        </div>`;
                }
                
                if (!adjustmentsResult?.data) {
                    console.log(' adjustmentsResult.data is undefined');
                    return `<h3 style="margin-top: 0;"> Inventory Adjustment History</h3>
                        <div style="background: #fff3e0; border: 2px solid #ff9800; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <p style="color: #e65100; margin: 0;"><strong> No Data:</strong> The adjustments table exists but is empty.</p>
                            <p style="color: #666; font-size: 13px; margin: 10px 0 0 0;">Adjustments are logged automatically when:<br>
                             You create sales orders<br>
                             You receive purchase orders<br>
                             You manually adjust inventory</p>
                        </div>`;
                }
                
                const items = itemsResult?.data || [];
                let adjustments = adjustmentsResult.data;
                
                console.log(' Total adjustments retrieved:', adjustments.length);
                if (adjustments.length > 0) {
                    console.log(' Sample adjustment:', adjustments[0]);
                    console.log(' All column names in sample:', Object.keys(adjustments[0]));
                }
                
                // Helper to get item description
                function getItemDesc(itemId) {
                    const item = items.find(i => String(i.Item_ID) === String(itemId));
                    return item ? item.Item_Description : itemId;
                }
                
                function getItemSKU(itemId) {
                    const item = items.find(i => String(i.Item_ID) === String(itemId));
                    return item ? item.SKU : '-';
                }
                
                // More robust date parsing for mobile
                function parseDateSafe(dateVal) {
                    if (!dateVal) return null;
                    if (dateVal instanceof Date) return dateVal;
                    
                    try {
                        // Try standard parsing
                        const d = new Date(dateVal);
                        if (!isNaN(d.getTime())) return d;
                        
                        // Try parsing common formats manually (mobile Safari can be picky)
                        if (typeof dateVal === 'string') {
                            // Handle YYYY-MM-DD format
                            const parts = dateVal.split(/[-/]/);
                            if (parts.length === 3) {
                                const year = parseInt(parts[0]);
                                const month = parseInt(parts[1]) - 1; // JS months are 0-indexed
                                const day = parseInt(parts[2]);
                                const d2 = new Date(year, month, day);
                                if (!isNaN(d2.getTime())) return d2;
                            }
                        }
                        
                        console.warn('Could not parse date:', dateVal);
                        return null;
                    } catch (e) {
                        console.error('Error parsing date:', dateVal, e);
                        return null;
                    }
                }
                
                // Apply date filters with better error handling
                try {
                    if (reportFilters.fromDate && reportFilters.fromDate.trim() !== '') {
                        console.log('Applying fromDate filter:', reportFilters.fromDate);
                        const fromDate = parseLocalDate(reportFilters.fromDate);
                        if (!isNaN(fromDate.getTime())) {
                            fromDate.setHours(0, 0, 0, 0);
                            adjustments = adjustments.filter(a => {
                                const adjDate = parseDateSafe(a.Adjustment_Date || a.Date);
                                return adjDate && adjDate >= fromDate;
                            });
                            console.log('After fromDate filter:', adjustments.length);
                        } else {
                            console.warn('Invalid fromDate:', reportFilters.fromDate);
                        }
                    } else {
                        console.log('No fromDate filter - showing all dates');
                    }
                    
                    if (reportFilters.toDate && reportFilters.toDate.trim() !== '') {
                        console.log('Applying toDate filter:', reportFilters.toDate);
                        const toDate = parseLocalDate(reportFilters.toDate);
                        if (!isNaN(toDate.getTime())) {
                            toDate.setHours(23, 59, 59, 999);
                            adjustments = adjustments.filter(a => {
                                const adjDate = parseDateSafe(a.Adjustment_Date || a.Date);
                                return adjDate && adjDate <= toDate;
                            });
                            console.log('After toDate filter:', adjustments.length);
                        } else {
                            console.warn('Invalid toDate:', reportFilters.toDate);
                        }
                    } else {
                        console.log('No toDate filter - showing all dates');
                    }
                } catch (e) {
                    console.error('Error applying date filters:', e);
                }
                
                // Apply item filter
                if (reportFilters.item) {
                    console.log('Applying item filter:', reportFilters.item);
                    adjustments = adjustments.filter(a => matchesFilter(a.Item_ID, reportFilters.item));
                    console.log('After item filter:', adjustments.length);
                }
                
                // Apply adjustment type filter
                if (reportFilters.adjustmentType) {
                    console.log('Applying adjustment type filter:', reportFilters.adjustmentType);
                    adjustments = adjustments.filter(a => {
                        const reason = String(a.Reason || '').toUpperCase();
                        const filterType = String(reportFilters.adjustmentType).toUpperCase();
                        return reason.includes(filterType);
                    });
                    console.log('After adjustment type filter:', adjustments.length);
                }
                
                console.log('Total adjustments after all filtering:', adjustments.length);
                
                // Sort by date (newest first)
                adjustments.sort((a, b) => {
                    const dateA = parseDateSafe(a.Adjustment_Date || a.Date) || new Date(0);
                    const dateB = parseDateSafe(b.Adjustment_Date || b.Date) || new Date(0);
                    return dateB - dateA;
                });
                
                // Build filter summary
                const filterSummary = generateFilterSummary();
                
                // Calculate summary stats
                let totalPositive = 0, totalNegative = 0;
                const byType = {};
                adjustments.forEach(a => {
                    // Backend column is Quantity_Change
                    const qty = parseFloat(
                        a.Quantity_Change || a.Qty_Change || a.Adjustment || a.Change || 0
                    ) || 0;
                    if (qty > 0) totalPositive += qty;
                    else totalNegative += Math.abs(qty);
                    
                    // Group by reason/type
                    let reason = String(a.Reason || a.Adjustment_Type || 'Other').trim();
                    if (reason.includes('Sale') || reason.includes('SALE')) reason = 'Sales';
                    else if (reason.includes('Purchase') || reason.includes('Received') || reason.includes('PURCHASE')) reason = 'Purchases';
                    else if (reason.includes('VOID')) reason = 'Voids';
                    else if (reason.includes('Manual')) reason = 'Manual';
                    else if (reason.includes('OUTGOING')) reason = 'Outgoing';
                    
                    if (!byType[reason]) byType[reason] = { count: 0, netChange: 0 };
                    byType[reason].count++;
                    byType[reason].netChange += qty;
                });
                
                const chartId = 'adjChart_' + Date.now();
                const typeLabels = Object.keys(byType);
                const typeCounts = typeLabels.map(t => byType[t].count);
                const typeColors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
                
                let html = `<h3 style="margin-top: 0;"> Inventory Adjustment History</h3>`;
                html += filterSummary;
                
                // Summary cards
                html += `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #1565c0;">${adjustments.length}</div>
                            <div style="font-size: 12px; color: #666;">Total Adjustments</div>
                        </div>
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">+${totalPositive.toLocaleString()}</div>
                            <div style="font-size: 12px; color: #666;">Units Added</div>
                        </div>
                        <div style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #c62828;">-${totalNegative.toLocaleString()}</div>
                            <div style="font-size: 12px; color: #666;">Units Removed</div>
                        </div>
                        <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">${(totalPositive - totalNegative).toLocaleString()}</div>
                            <div style="font-size: 12px; color: #666;">Net Change</div>
                        </div>
                    </div>
                `;
                
                if (adjustments.length === 0) {
                    html += `<p style="color: #888; text-align: center; padding: 40px;">No adjustments found for the selected filters.</p>`;
                    return html;
                }
                
                // Chart Section
                if (typeLabels.length > 0) {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                                 style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                                <span class="toggle-icon"></span>
                                <strong> Adjustments by Type</strong>
                                <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                            </div>
                            <div style="margin-top: 15px;">
                                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 350px;">
                                    <canvas id="${chartId}" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <scr` + `ipt>
                            setTimeout(() => {
                                const ctx = document.getElementById('${chartId}');
                                if (ctx) {
                                    if(Chart.getChart(ctx))Chart.getChart(ctx).destroy(); new Chart(ctx, {
                                        type: 'doughnut',
                                        data: {
                                            labels: ['${typeLabels.join("', '")}'],
                                            datasets: [{
                                                data: [${typeCounts.join(', ')}],
                                                backgroundColor: ['${typeColors.slice(0, typeLabels.length).join("', '")}'],
                                                borderWidth: 0
                                            }]
                                        },
                                        options: {
                                            responsive: false, animation: false,
                                            maintainAspectRatio: false,
                                            plugins: {
                                                legend: { position: 'right', labels: { padding: 10, usePointStyle: true, font: { size: 11 } } }
                                            }
                                        }
                                    });
                                }
                            }, 100);
                        <` + `/script>
                    `;
                }
                
                // Detail Table Section
                html += `
                    <div>
                        <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                             style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                            <span class="toggle-icon"></span>
                            <strong> Detail Table</strong>
                            <span style="color: #666; font-size: 12px;">(${adjustments.length} adjustments - click to hide/show)</span>
                        </div>
                        <div style="margin-top: 15px;">
                `;
                
                html += `<div style="overflow-x: auto; -webkit-overflow-scrolling: touch;"><table class="data-table" style="min-width: 100%; width: auto;">
                    <thead><tr>
                        <th style="white-space: nowrap;">Date</th>
                        <th style="white-space: nowrap;">Item</th>
                        <th style="white-space: nowrap;">SKU</th>
                        <th style="white-space: nowrap;">Reason</th>
                        <th style="text-align: right; white-space: nowrap;">Before</th>
                        <th style="text-align: right; white-space: nowrap;">Change</th>
                        <th style="text-align: right; white-space: nowrap;">After</th>
                        <th style="white-space: nowrap;">Notes</th>
                    </tr></thead><tbody>`;
                
                adjustments.forEach(a => {
                    const adjDate = parseDateSafe(a.Adjustment_Date || a.Date);
                    const dateStr = adjDate ? adjDate.toLocaleDateString() : '-';
                    
                    // Backend columns: Adjustment_ID, Item_ID, Adjustment_Date, Adjustment_Type, Quantity_Change, New_Qty_On_Hand, Reason, User
                    const qtyChange = parseFloat(
                        a.Quantity_Change || a.Qty_Change || a.Adjustment || a.Change || 0
                    ) || 0;
                    
                    // New_Qty_On_Hand is the "after" value - backend doesn't store "before"
                    const qtyAfter = parseFloat(
                        a.New_Qty_On_Hand || a.Qty_After || a.New_Qty || a.After || 0
                    ) || 0;
                    
                    // Calculate "before" from after - change
                    const qtyBefore = qtyAfter - qtyChange;
                    
                    const reason = String(a.Reason || a.Adjustment_Type || '-');
                    const notes = a.User || a.Notes || '';
                    
                    // Color code the reason
                    let reasonBadge = reason;
                    if (reason.includes('VOID')) {
                        reasonBadge = `<span style="background: #ffcdd2; color: #c62828; padding: 2px 8px; border-radius: 10px; font-size: 11px; white-space: nowrap;"> ${reason}</span>`;
                    } else if (reason.includes('Sale') || reason.includes('SALE')) {
                        reasonBadge = `<span style="background: #fff3e0; color: #e65100; padding: 2px 8px; border-radius: 10px; font-size: 11px; white-space: nowrap;"> ${reason}</span>`;
                    } else if (reason.includes('Purchase') || reason.includes('PURCHASE') || reason.includes('Received')) {
                        reasonBadge = `<span style="background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 10px; font-size: 11px; white-space: nowrap;"> ${reason}</span>`;
                    } else if (reason.includes('Manual')) {
                        reasonBadge = `<span style="background: #e3f2fd; color: #1565c0; padding: 2px 8px; border-radius: 10px; font-size: 11px; white-space: nowrap;"> ${reason}</span>`;
                    } else if (reason.includes('OUTGOING')) {
                        reasonBadge = `<span style="background: #f3e5f5; color: #7b1fa2; padding: 2px 8px; border-radius: 10px; font-size: 11px; white-space: nowrap;"> ${reason}</span>`;
                    }
                    
                    html += `<tr>
                        <td style="white-space: nowrap;">${dateStr}</td>
                        <td style="min-width: 150px;">${getItemDesc(a.Item_ID)}</td>
                        <td style="font-family: monospace; font-size: 11px; white-space: nowrap;">${getItemSKU(a.Item_ID)}</td>
                        <td>${reasonBadge}</td>
                        <td style="text-align: right; white-space: nowrap;">${qtyBefore}</td>
                        <td style="text-align: right; font-weight: bold; color: ${qtyChange >= 0 ? '#2e7d32' : '#c62828'}; white-space: nowrap;">
                            ${qtyChange >= 0 ? '+' : ''}${qtyChange}
                        </td>
                        <td style="text-align: right; white-space: nowrap;">${qtyAfter}</td>
                        <td style="max-width: 200px; min-width: 100px; font-size: 11px; color: #666;">${notes}</td>
                    </tr>`;
                });
                
                html += `</tbody></table></div>
                        </div>
                    </div>`;
                
                return html;
                
            } catch (error) {
                console.error('Error in generateInventoryAdjustmentsModal:', error);
                console.error('Error stack:', error.stack);
                return `<h3 style="margin-top: 0;"> Inventory Adjustment History</h3>
                    <div style="background: #ffebee; border: 2px solid #f44336; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <p style="color: #c62828; margin: 0;"><strong>Error loading adjustments:</strong></p>
                        <p style="color: #666; font-size: 13px; margin: 10px 0 0 0;">${error.message}</p>
                        <p style="color: #888; font-size: 11px; margin: 10px 0 0 0;">Check browser console (F12) for more details.</p>
                    </div>`;
            }
        }
        
        async function generateInventoryReportModal(type) {
            const itemsResult = await apiCall('getItems');
            if (!itemsResult?.data) throw new Error('Failed to load items');
            
            let items = itemsResult.data;
            
            // Apply filters
            if (reportFilters.supplier) {
                items = items.filter(i => matchesFilter(i.Supplier_ID, reportFilters.supplier));
            }
            if (reportFilters.stockStatus) {
                items = items.filter(i => {
                    const qty = parseInt(i.Qty_On_Hand) || 0;
                    const reorder = parseInt(i.Reorder_Level) || 0;
                    switch(reportFilters.stockStatus) {
                        case 'negative': return qty < 0;
                        case 'out': return qty === 0;
                        case 'low': return qty > 0 && qty <= reorder;
                        case 'ok': return qty > reorder;
                        default: return true;
                    }
                });
            }
            
            // Calculate totals and margin data
            let totalQty = 0, totalValue = 0, totalSellValue = 0, totalBackorder = 0;
            let negativeCount = 0, lowStockCount = 0, inStockCount = 0;
            const marginData = [];
            
            items.forEach(item => {
                const qty = parseInt(item.Qty_On_Hand) || 0;
                const backorder = parseInt(item.Qty_On_Backorder) || 0;
                const cost = parseFloat(item.Package_Cost) || 0;
                const sell = parseFloat(item.Unit_Sell_Price) || parseFloat(item.Sell_Price) || 0;
                const units = parseInt(item.Units_Per_Package) || 1;
                const unitCost = cost / units;
                const reorder = parseInt(item.Reorder_Point) || 0;
                const margin = sell > 0 ? ((sell - unitCost) / sell * 100) : 0;
                
                totalQty += qty;
                totalBackorder += backorder;
                totalValue += Math.abs(qty) * unitCost;
                totalSellValue += Math.abs(qty) * sell;
                
                if (qty < 0) negativeCount++;
                else if (qty <= reorder && reorder > 0) lowStockCount++;
                else if (qty > 0) inStockCount++;
                
                // Collect margin data for chart
                if (sell > 0) {
                    marginData.push({
                        name: (item.Item_Description || item.SKU || '-').substring(0, 20),
                        margin: margin,
                        value: Math.abs(qty) * unitCost
                    });
                }
            });
            
            const totalMargin = totalSellValue > 0 ? ((totalSellValue - totalValue) / totalSellValue * 100) : 0;
            const potentialProfit = totalSellValue - totalValue;
            
            // Sort by margin for chart
            marginData.sort((a, b) => b.margin - a.margin);
            const top10Margins = marginData.slice(0, 10);
            const bottom5Margins = marginData.slice(-5).reverse();
            
            let html = `<h3 style="margin-top: 0;">${type === 'turnover' ? 'Inventory Turnover' : type === 'margin' ? 'Gross Margin' : 'Inventory List'}</h3>`;
            html += `<p style="color: #666; margin-bottom: 20px;">${items.length} items</p>`;
            
            // KPI Summary Cards
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 12px; color: #1565c0; margin-bottom: 5px;"> Total Units</div>
                        <div style="font-size: 22px; font-weight: bold; color: #1976d2;">${totalQty.toLocaleString()}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, ${totalBackorder > 0 ? '#fef2f2 0%, #fecaca 100%' : '#f5f5f5 0%, #e0e0e0 100%'}); padding: 15px; border-radius: 8px; border-left: 4px solid ${totalBackorder > 0 ? '#dc2626' : '#9e9e9e'};">
                        <div style="font-size: 12px; color: ${totalBackorder > 0 ? '#991b1b' : '#666'}; margin-bottom: 5px;"> On Backorder</div>
                        <div style="font-size: 22px; font-weight: bold; color: ${totalBackorder > 0 ? '#dc2626' : '#666'};">${totalBackorder > 0 ? totalBackorder.toLocaleString() : '0'}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px;"> Cost Value</div>
                        <div style="font-size: 22px; font-weight: bold; color: #388e3c;">${formatMoney(totalValue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                        <div style="font-size: 12px; color: #7b1fa2; margin-bottom: 5px;"> Retail Value</div>
                        <div style="font-size: 22px; font-weight: bold; color: #8e24aa;">${formatMoney(totalSellValue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <div style="font-size: 12px; color: #e65100; margin-bottom: 5px;"> Avg Margin</div>
                        <div style="font-size: 22px; font-weight: bold; color: #f57c00;">${totalMargin.toFixed(1)}%</div>
                    </div>
                </div>
            `;
            
            // Add charts for margin type
            if (type === 'margin' && marginData.length > 0) {
                const topChartId = 'marginTopChart_' + Date.now();
                const bottomChartId = 'marginBottomChart_' + Date.now();
                
                html += `
                    <div style="margin-bottom: 20px;">
                        <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'grid' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                             style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                            <span class="toggle-icon"></span>
                            <strong> Margin Charts</strong>
                            <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 15px;">
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 15px 0; color: #2e7d32;"> Top 10 Margins</h4>
                                <canvas id="${topChartId}" height="220"></canvas>
                            </div>
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 15px 0; color: #c62828;"> Lowest 5 Margins</h4>
                                <canvas id="${bottomChartId}" height="220"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <scr` + `ipt>
                        setTimeout(() => {
                            const ctx1 = document.getElementById('${topChartId}');
                            if (ctx1) {
                                if(Chart.getChart(ctx1))Chart.getChart(ctx1).destroy(); new Chart(ctx1, {
                                    type: 'bar',
                                    data: {
                                        labels: [${top10Margins.map(d => `'${d.name.replace(/'/g, "\\'")}'`).join(', ')}],
                                        datasets: [{
                                            label: 'Margin %',
                                            data: [${top10Margins.map(d => d.margin.toFixed(1)).join(', ')}],
                                            backgroundColor: '#4caf50',
                                            borderRadius: 6
                                        }]
                                    },
                                    options: {
                                        indexAxis: 'y',
                                        responsive: false, animation: false,
                                        maintainAspectRatio: false,
                                        plugins: { legend: { display: false } },
                                        scales: { x: { beginAtZero: true, max: 100, ticks: { callback: (val) => val + '%' } } }
                                    }
                                });
                            }
                            const ctx2 = document.getElementById('${bottomChartId}');
                            if (ctx2) {
                                if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                    type: 'bar',
                                    data: {
                                        labels: [${bottom5Margins.map(d => `'${d.name.replace(/'/g, "\\'")}'`).join(', ')}],
                                        datasets: [{
                                            label: 'Margin %',
                                            data: [${bottom5Margins.map(d => d.margin.toFixed(1)).join(', ')}],
                                            backgroundColor: [${bottom5Margins.map(d => d.margin < 10 ? "'#f44336'" : d.margin < 20 ? "'#ff9800'" : "'#4caf50'").join(', ')}],
                                            borderRadius: 6
                                        }]
                                    },
                                    options: {
                                        indexAxis: 'y',
                                        responsive: false, animation: false,
                                        maintainAspectRatio: false,
                                        plugins: { legend: { display: false } },
                                        scales: { x: { beginAtZero: true, max: 100, ticks: { callback: (val) => val + '%' } } }
                                    }
                                });
                            }
                        }, 100);
                    <` + `/script>
                `;
            }
            
            // Detail table section
            html += `
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Detail Table</strong>
                        <span style="color: #666; font-size: 12px;">(${items.length} items - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>SKU</th>
                                <th>Description</th>
                                <th style="text-align: right;">Qty</th>
                                <th style="text-align: right;">Backorder</th>
                                <th style="text-align: right;">Cost</th>
                                <th style="text-align: right;">Sell</th>
                                <th style="text-align: right;">Value</th>
                                ${type === 'margin' ? '<th style="text-align: right;">Margin</th>' : ''}
                            </tr></thead><tbody>`;
            
            items.forEach(item => {
                const qty = parseInt(item.Qty_On_Hand) || 0;
                const backorder = parseInt(item.Qty_On_Backorder) || 0;
                const cost = parseFloat(item.Package_Cost) || 0;
                const sell = parseFloat(item.Unit_Sell_Price) || parseFloat(item.Sell_Price) || 0;
                const units = parseInt(item.Units_Per_Package) || 1;
                const unitCost = cost / units;
                const margin = sell > 0 ? ((sell - unitCost) / sell * 100) : 0;
                // Use absolute value for calculations - negative inventory still has positive value
                const itemValue = Math.abs(qty) * unitCost;
                
                html += `<tr>
                    <td>${item.SKU || '-'}</td>
                    <td>${item.Item_Description || '-'}</td>
                    <td style="text-align: right; color: ${qty <= 0 ? '#c62828' : '#333'};">${qty}</td>
                    <td style="text-align: right; color: ${backorder > 0 ? '#dc2626' : '#666'}; font-weight: ${backorder > 0 ? '600' : 'normal'};">${backorder > 0 ? backorder : '-'}</td>
                    <td style="text-align: right;">${formatMoney(unitCost)}</td>
                    <td style="text-align: right;">${formatMoney(sell)}</td>
                    <td style="text-align: right;">${formatMoney(itemValue)}</td>
                    ${type === 'margin' ? `<td style="text-align: right; color: ${margin >= 20 ? '#2e7d32' : '#ff9800'};">${margin.toFixed(1)}%</td>` : ''}
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="2">TOTAL</td>
                <td style="text-align: right;">${totalQty}</td>
                <td style="text-align: right; color: ${totalBackorder > 0 ? '#dc2626' : '#666'};">${totalBackorder > 0 ? totalBackorder : '-'}</td>
                <td colspan="2" style="text-align: right;">Inventory Value:</td>
                <td style="text-align: right;">${formatMoney(totalValue)}</td>
                ${type === 'margin' ? `<td style="text-align: right;">${totalMargin.toFixed(1)}%</td>` : ''}
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            return html;
        }
        
        async function generateAccountsReceivableModal() {
            const salesResult = await apiCall('getSalesOrders');
            if (!salesResult?.data) throw new Error('Failed to load sales');
            
            let unpaid = salesResult.data.filter(s => s.Payment_Status !== 'Paid');
            
            if (reportFilters.customer) {
                unpaid = unpaid.filter(s => matchesFilter(s.Customer_ID, reportFilters.customer));
            }
            
            // Calculate totals and aging
            let totalAmount = 0, totalPaid = 0, totalDue = 0;
            let current = 0, over30 = 0, over60 = 0, over90 = 0;
            const today = new Date();
            const byCustomer = {};
            
            unpaid.forEach(s => {
                const amt = parseFloat(s.Total_Amount) || 0;
                const paid = parseFloat(s.Amount_Paid) || 0;
                const due = amt - paid;
                totalAmount += amt;
                totalPaid += paid;
                totalDue += due;
                
                // Track by customer
                const custId = s.Customer_ID;
                if (!byCustomer[custId]) {
                    byCustomer[custId] = { name: getCustomerName(custId), owed: 0 };
                }
                byCustomer[custId].owed += due;
                
                // Calculate aging
                const dueDate = parseDate(s.Due_Date || s.Sale_Date);
                if (dueDate) {
                    const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
                    if (daysOverdue > 90) over90 += due;
                    else if (daysOverdue > 60) over60 += due;
                    else if (daysOverdue > 30) over30 += due;
                    else current += due;
                } else {
                    current += due;
                }
            });
            
            const agingChartId = 'arAgingChart_' + Date.now();
            const custChartId = 'arCustChart_' + Date.now();
            const topCustomers = Object.entries(byCustomer).sort((a, b) => b[1].owed - a[1].owed).slice(0, 5);
            
            let html = `<h3 style="margin-top: 0;">Accounts Receivable</h3>`;
            html += `<p style="color: #666; margin-bottom: 20px;">${unpaid.length} unpaid invoices | ${formatMoney(totalDue)} outstanding</p>`;
            
            // KPI Summary Cards
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #f44336;">
                        <div style="font-size: 12px; color: #c62828; margin-bottom: 5px;"> Total Owed</div>
                        <div style="font-size: 22px; font-weight: bold; color: #d32f2f;">${formatMoney(totalDue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px;"> Current</div>
                        <div style="font-size: 22px; font-weight: bold; color: #388e3c;">${formatMoney(current)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <div style="font-size: 12px; color: #e65100; margin-bottom: 5px;"> 31-60 Days</div>
                        <div style="font-size: 22px; font-weight: bold; color: #f57c00;">${formatMoney(over30)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #e91e63;">
                        <div style="font-size: 12px; color: #c2185b; margin-bottom: 5px;"> 90+ Days</div>
                        <div style="font-size: 22px; font-weight: bold; color: #ad1457;">${formatMoney(over90)}</div>
                    </div>
                </div>
            `;
            
            // Charts Section (collapsible)
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'grid' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Aging Analysis</h4>
                            <canvas id="${agingChartId}" height="200"></canvas>
                        </div>
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Top 5 Outstanding</h4>
                            <canvas id="${custChartId}" height="200"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // Detail Table Section (collapsible)
            html += `
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Detail Table</strong>
                        <span style="color: #666; font-size: 12px;">(${unpaid.length} invoices - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>Invoice</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th style="text-align: right;">Total</th>
                                <th style="text-align: right;">Paid</th>
                                <th style="text-align: right;">Balance Due</th>
                                <th>Status</th>
                            </tr></thead><tbody>`;
            
            unpaid.forEach(s => {
                const amt = parseFloat(s.Total_Amount) || 0;
                const paid = parseFloat(s.Amount_Paid) || 0;
                const due = amt - paid;
                html += `<tr>
                    <td>${s.Invoice_Number || s.SO_Number || '-'}</td>
                    <td>${getCustomerName(s.Customer_ID)}</td>
                    <td>${s.Sale_Date || '-'}</td>
                    <td style="text-align: right;">${formatMoney(amt)}</td>
                    <td style="text-align: right;">${formatMoney(paid)}</td>
                    <td style="text-align: right; color: #c62828; font-weight: bold;">${formatMoney(due)}</td>
                    <td>${s.Payment_Status || 'Unpaid'}</td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="3">TOTAL</td>
                <td style="text-align: right;">${formatMoney(totalAmount)}</td>
                <td style="text-align: right;">${formatMoney(totalPaid)}</td>
                <td style="text-align: right; color: #c62828;">${formatMoney(totalDue)}</td>
                <td></td>
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            
            // Chart.js initialization
            html += `
                <scr` + `ipt>
                    setTimeout(() => {
                        // Aging Bar Chart
                        const ctx1 = document.getElementById('${agingChartId}');
                        if (ctx1) {
                            if(Chart.getChart(ctx1))Chart.getChart(ctx1).destroy(); new Chart(ctx1, {
                                type: 'bar',
                                data: {
                                    labels: ['Current', '31-60 Days', '61-90 Days', '90+ Days'],
                                    datasets: [{
                                        label: 'Amount',
                                        data: [${current.toFixed(2)}, ${over30.toFixed(2)}, ${over60.toFixed(2)}, ${over90.toFixed(2)}],
                                        backgroundColor: ['#4caf50', '#ff9800', '#ff5722', '#f44336'],
                                        borderRadius: 6
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Customer Pie Chart
                        const ctx2 = document.getElementById('${custChartId}');
                        if (ctx2) {
                            if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                type: 'doughnut',
                                data: {
                                    labels: [${topCustomers.map(([id, d]) => `'${d.name.replace(/'/g, "\\'").substring(0, 15)}'`).join(', ')}${topCustomers.length < Object.keys(byCustomer).length ? ", 'Others'" : ''}],
                                    datasets: [{
                                        data: [${topCustomers.map(([id, d]) => d.owed.toFixed(2)).join(', ')}${topCustomers.length < Object.keys(byCustomer).length ? ', ' + Object.entries(byCustomer).slice(5).reduce((sum, [id, d]) => sum + d.owed, 0).toFixed(2) : ''}],
                                        backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#10b981', '#9ca3af'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { position: 'right', labels: { padding: 8, usePointStyle: true, font: { size: 10 } } }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        async function generateAccountsPayableModal() {
            const poResult = await apiCall('getPurchaseOrders');
            if (!poResult?.data) throw new Error('Failed to load POs');
            
            let unpaid = poResult.data.filter(p => p.Payment_Status !== 'Paid' && p.Status !== 'Void');
            
            if (reportFilters.supplier) {
                unpaid = unpaid.filter(p => matchesFilter(p.Supplier_ID, reportFilters.supplier));
            }
            
            // Calculate totals and aging
            let totalAmount = 0, totalPaid = 0, totalDue = 0;
            let current = 0, over30 = 0, over60 = 0, over90 = 0;
            const today = new Date();
            const bySupplier = {};
            
            unpaid.forEach(p => {
                const amt = parseFloat(p.Total_Amount) || 0;
                const paid = parseFloat(p.Amount_Paid) || 0;
                const due = amt - paid;
                totalAmount += amt;
                totalPaid += paid;
                totalDue += due;
                
                // Track by supplier
                const suppId = p.Supplier_ID;
                if (!bySupplier[suppId]) {
                    bySupplier[suppId] = { name: getSupplierName(suppId), owed: 0 };
                }
                bySupplier[suppId].owed += due;
                
                // Calculate aging
                const dueDate = parseDate(p.Due_Date || p.PO_Date);
                if (dueDate) {
                    const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
                    if (daysOverdue > 90) over90 += due;
                    else if (daysOverdue > 60) over60 += due;
                    else if (daysOverdue > 30) over30 += due;
                    else current += due;
                } else {
                    current += due;
                }
            });
            
            const agingChartId = 'apAgingChart_' + Date.now();
            const suppChartId = 'apSuppChart_' + Date.now();
            const topSuppliers = Object.entries(bySupplier).sort((a, b) => b[1].owed - a[1].owed).slice(0, 5);
            
            let html = `<h3 style="margin-top: 0;">Accounts Payable</h3>`;
            html += `<p style="color: #666; margin-bottom: 20px;">${unpaid.length} unpaid POs | ${formatMoney(totalDue)} outstanding</p>`;
            
            // KPI Summary Cards
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #f44336;">
                        <div style="font-size: 12px; color: #c62828; margin-bottom: 5px;"> Total Owed</div>
                        <div style="font-size: 22px; font-weight: bold; color: #d32f2f;">${formatMoney(totalDue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px;"> Current</div>
                        <div style="font-size: 22px; font-weight: bold; color: #388e3c;">${formatMoney(current)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <div style="font-size: 12px; color: #e65100; margin-bottom: 5px;"> 31-60 Days</div>
                        <div style="font-size: 22px; font-weight: bold; color: #f57c00;">${formatMoney(over30)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #e91e63;">
                        <div style="font-size: 12px; color: #c2185b; margin-bottom: 5px;"> 90+ Days</div>
                        <div style="font-size: 22px; font-weight: bold; color: #ad1457;">${formatMoney(over90)}</div>
                    </div>
                </div>
            `;
            
            // Charts Section (collapsible)
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'grid' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Aging Analysis</h4>
                            <canvas id="${agingChartId}" height="200"></canvas>
                        </div>
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Top 5 Owed To</h4>
                            <canvas id="${suppChartId}" height="200"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // Detail Table Section (collapsible)
            html += `
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Detail Table</strong>
                        <span style="color: #666; font-size: 12px;">(${unpaid.length} POs - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>PO #</th>
                                <th>Supplier</th>
                                <th>Date</th>
                                <th style="text-align: right;">Total</th>
                                <th style="text-align: right;">Paid</th>
                                <th style="text-align: right;">Balance Due</th>
                                <th>Status</th>
                            </tr></thead><tbody>`;
            
            unpaid.forEach(p => {
                const amt = parseFloat(p.Total_Amount) || 0;
                const paid = parseFloat(p.Amount_Paid) || 0;
                const due = amt - paid;
                html += `<tr>
                    <td>${p.PO_ID || '-'}</td>
                    <td>${getSupplierName(p.Supplier_ID)}</td>
                    <td>${p.PO_Date || '-'}</td>
                    <td style="text-align: right;">${formatMoney(amt)}</td>
                    <td style="text-align: right;">${formatMoney(paid)}</td>
                    <td style="text-align: right; color: #c62828; font-weight: bold;">${formatMoney(due)}</td>
                    <td>${p.Payment_Status || 'Unpaid'}</td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="3">TOTAL</td>
                <td style="text-align: right;">${formatMoney(totalAmount)}</td>
                <td style="text-align: right;">${formatMoney(totalPaid)}</td>
                <td style="text-align: right; color: #c62828;">${formatMoney(totalDue)}</td>
                <td></td>
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            
            // Chart.js initialization
            const suppLabels = topSuppliers.map(([id, d]) => d.name.replace(/'/g, "\\'").substring(0, 15));
            const suppData = topSuppliers.map(([id, d]) => d.owed);
            const othersOwed = Object.entries(bySupplier).slice(5).reduce((sum, [id, d]) => sum + d.owed, 0);
            
            html += `
                <scr` + `ipt>
                    setTimeout(() => {
                        const ctx1 = document.getElementById('${agingChartId}');
                        if (ctx1) {
                            if(Chart.getChart(ctx1))Chart.getChart(ctx1).destroy(); new Chart(ctx1, {
                                type: 'bar',
                                data: {
                                    labels: ['Current', '31-60 Days', '61-90 Days', '90+ Days'],
                                    datasets: [{
                                        label: 'Amount',
                                        data: [${current.toFixed(2)}, ${over30.toFixed(2)}, ${over60.toFixed(2)}, ${over90.toFixed(2)}],
                                        backgroundColor: ['#4caf50', '#ff9800', '#ff5722', '#f44336'],
                                        borderRadius: 6
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: false } },
                                    scales: { y: { beginAtZero: true, ticks: { callback: (val) => '$' + val.toLocaleString() } } }
                                }
                            });
                        }
                        const ctx2 = document.getElementById('${suppChartId}');
                        if (ctx2) {
                            if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                type: 'doughnut',
                                data: {
                                    labels: ['${suppLabels.join("', '")}' ${othersOwed > 0 ? ", 'Others'" : ''}],
                                    datasets: [{
                                        data: [${suppData.join(', ')}${othersOwed > 0 ? ', ' + othersOwed.toFixed(2) : ''}],
                                        backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#10b981', '#9ca3af'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { position: 'right', labels: { padding: 8, usePointStyle: true, font: { size: 10 } } } }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        // ==================== TAX & ANNUAL REPORT GENERATORS ====================
        
        // Helper function to get date range for year/quarter
        function getDateRangeForPeriod(year, quarter) {
            year = parseInt(year);
            let startDate, endDate;
            
            if (quarter === 'annual' || !quarter) {
                startDate = new Date(year, 0, 1);  // Jan 1
                endDate = new Date(year, 11, 31, 23, 59, 59);  // Dec 31
            } else if (quarter === 'Q1') {
                startDate = new Date(year, 0, 1);  // Jan 1
                endDate = new Date(year, 2, 31, 23, 59, 59);  // Mar 31
            } else if (quarter === 'Q2') {
                startDate = new Date(year, 3, 1);  // Apr 1
                endDate = new Date(year, 5, 30, 23, 59, 59);  // Jun 30
            } else if (quarter === 'Q3') {
                startDate = new Date(year, 6, 1);  // Jul 1
                endDate = new Date(year, 8, 30, 23, 59, 59);  // Sep 30
            } else if (quarter === 'Q4') {
                startDate = new Date(year, 9, 1);  // Oct 1
                endDate = new Date(year, 11, 31, 23, 59, 59);  // Dec 31
            }
            
            return { startDate, endDate };
        }
        
        // Helper to parse dates flexibly
        function parseDate(dateVal) {
            if (!dateVal) return null;
            if (dateVal instanceof Date) return dateVal;
            const d = new Date(dateVal);
            return isNaN(d.getTime()) ? null : d;
        }
        
        // Enhanced date parsing for mobile Safari compatibility - used by all reports
        function parseDateSafe(dateVal) {
            if (!dateVal) return null;
            if (dateVal instanceof Date) return dateVal;
            
            try {
                // Try standard parsing first
                const d = new Date(dateVal);
                if (!isNaN(d.getTime())) return d;
                
                // Mobile Safari fallback: Try parsing common formats manually
                if (typeof dateVal === 'string') {
                    // Handle YYYY-MM-DD, MM/DD/YYYY, etc.
                    const parts = dateVal.split(/[-/]/);
                    if (parts.length === 3) {
                        const year = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // JS months are 0-indexed
                        const day = parseInt(parts[2]);
                        const d2 = new Date(year, month, day);
                        if (!isNaN(d2.getTime())) return d2;
                    }
                }
                
                return null;
            } catch (e) {
                console.error('Error parsing date:', dateVal, e);
                return null;
            }
        }
        
        // Apply date range filter with mobile-safe parsing
        function applyDateRangeFilter(items, dateField) {
            let filtered = items;
            
            try {
                // From date
                if (reportFilters.fromDate && reportFilters.fromDate.trim() !== '') {
                    const fromDate = parseLocalDate(reportFilters.fromDate);
                    if (!isNaN(fromDate.getTime())) {
                        fromDate.setHours(0, 0, 0, 0);
                        filtered = filtered.filter(item => {
                            const itemDate = parseDateSafe(item[dateField]);
                            return itemDate && itemDate >= fromDate;
                        });
                    }
                }
                
                // To date
                if (reportFilters.toDate && reportFilters.toDate.trim() !== '') {
                    const toDate = parseLocalDate(reportFilters.toDate);
                    if (!isNaN(toDate.getTime())) {
                        toDate.setHours(23, 59, 59, 999);
                        filtered = filtered.filter(item => {
                            const itemDate = parseDateSafe(item[dateField]);
                            return itemDate && itemDate <= toDate;
                        });
                    }
                }
            } catch (e) {
                console.error('Error applying date filter:', e);
            }
            
            return filtered;
        }
        
        // Helper to filter transactions by status
        function filterByTransactionStatus(items, statusField = 'Status') {
            const statusFilter = reportFilters.transactionStatus || 'exclude-voided';
            
            if (statusFilter === 'exclude-voided') {
                return items.filter(item => item[statusField] !== 'Voided');
            } else if (statusFilter === '') {
                return items; // All transactions
            } else {
                return items.filter(item => item[statusField] === statusFilter);
            }
        }
        
        // Helper to generate filter summary HTML
        function generateFilterSummary(options = {}) {
            const parts = [];
            
            // Date range
            if (reportFilters.fromDate && reportFilters.toDate) {
                parts.push(` ${new Date(reportFilters.fromDate).toLocaleDateString()} - ${new Date(reportFilters.toDate).toLocaleDateString()}`);
            } else if (reportFilters.fromDate) {
                parts.push(` From ${new Date(reportFilters.fromDate).toLocaleDateString()}`);
            } else if (reportFilters.toDate) {
                parts.push(` Through ${new Date(reportFilters.toDate).toLocaleDateString()}`);
            }
            
            // Year/Quarter for tax reports
            if (options.showYear && reportFilters.year) {
                const periodLabel = reportFilters.quarter === 'annual' ? `Year ${reportFilters.year}` : `${reportFilters.quarter} ${reportFilters.year}`;
                parts.push(` ${periodLabel}`);
            }
            
            // Customer (handle multi-select)
            if (reportFilters.customer) {
                const customerIds = reportFilters.customer.split(',').filter(id => id.trim());
                if (customerIds.length === 1) {
                    parts.push(` ${getCustomerName(customerIds[0])}`);
                } else if (customerIds.length > 1) {
                    // Show names instead of just codes
                    const names = customerIds.map(id => getCustomerName(id)).join(', ');
                    if (names.length > 50) {
                        // If too long, abbreviate
                        parts.push(` ${customerIds.length} customers`);
                    } else {
                        parts.push(` ${names}`);
                    }
                }
            }
            
            // Supplier (handle multi-select)
            if (reportFilters.supplier) {
                const supplierIds = reportFilters.supplier.split(',').filter(id => id.trim());
                if (supplierIds.length === 1) {
                    parts.push(` ${getSupplierName(supplierIds[0])}`);
                } else if (supplierIds.length > 1) {
                    // Show names instead of just codes
                    const names = supplierIds.map(id => getSupplierName(id)).join(', ');
                    if (names.length > 50) {
                        parts.push(` ${supplierIds.length} suppliers`);
                    } else {
                        parts.push(` ${names}`);
                    }
                }
            }
            
            // Payment Status
            if (reportFilters.paymentStatus) {
                const statusLabels = { 'Paid': ' Paid', 'Partial': ' Partial', 'Unpaid': ' Unpaid' };
                parts.push(statusLabels[reportFilters.paymentStatus] || reportFilters.paymentStatus);
            }
            
            // Transaction Status
            if (reportFilters.transactionStatus) {
                const statusLabels = {
                    'exclude-voided': ' Excluding Voided',
                    'Completed': ' Completed Only',
                    'Pending': ' Pending Only',
                    'Voided': ' Voided Only'
                };
                if (reportFilters.transactionStatus !== 'exclude-voided' || options.showVoidedFilter) {
                    parts.push(statusLabels[reportFilters.transactionStatus] || reportFilters.transactionStatus);
                }
            }
            
            // Min Amount
            if (reportFilters.minAmount > 0) {
                parts.push(` Min ${formatMoney(reportFilters.minAmount)}`);
            }
            
            // Stock Status
            if (reportFilters.stockStatus) {
                const labels = { 'negative': ' Negative', 'out': ' Out of Stock', 'low': ' Low Stock', 'ok': ' In Stock' };
                parts.push(labels[reportFilters.stockStatus] || reportFilters.stockStatus);
            }
            
            // Sales Invoice
            if (reportFilters.salesInvoice) {
                parts.push(` Invoice: ${reportFilters.salesInvoice}`);
            }
            
            // COGS Method
            if (options.showCogsMethod && reportFilters.cogsMethod) {
                parts.push(` COGS: ${reportFilters.cogsMethod === 'actual' ? 'Actual Costs' : 'Standard Costs'}`);
            }
            
            if (parts.length === 0) {
                return '';
            }
            
            return `
                <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    <span style="font-weight: 600; color: #666; font-size: 12px;">FILTERS:</span>
                    ${parts.map(p => `<span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;">${p}</span>`).join('')}
                </div>
            `;
        }
        
        // Profit & Loss Statement
        async function generateProfitLossModal() {
            const year = reportFilters.year || new Date().getFullYear();
            const quarter = reportFilters.quarter || 'annual';
            const cogsMethod = reportFilters.cogsMethod || 'actual';
            
            const { startDate, endDate } = getDateRangeForPeriod(year, quarter);
            
            // Fetch all data
            const [salesResult, poResult, itemsResult] = await Promise.all([
                apiCall('getSalesOrders'),
                apiCall('getPurchaseOrders'),
                apiCall('getItems')
            ]);
            
            if (!salesResult?.data || !poResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            
            // Filter sales by date AND exclude voided (tax reports always exclude voided)
            const salesInPeriod = salesResult.data.filter(s => {
                if (s.Status === 'Voided') return false; // Always exclude voided for tax reports
                const saleDate = parseDate(s.Sale_Date || s.SO_Date);
                return saleDate && saleDate >= startDate && saleDate <= endDate;
            });
            
            // Filter purchases by date AND exclude voided
            const purchasesInPeriod = poResult.data.filter(p => {
                if (p.Status === 'Voided') return false; // Always exclude voided for tax reports
                const poDate = parseDate(p.PO_Date);
                return poDate && poDate >= startDate && poDate <= endDate;
            });
            
            // Calculate Revenue (total sales)
            let totalRevenue = 0;
            salesInPeriod.forEach(s => {
                totalRevenue += parseFloat(s.Total_Amount) || 0;
            });
            
            // Calculate COGS based on method
            let totalCOGS = 0;
            
            if (cogsMethod === 'actual') {
                // COGS from actual purchase orders (INCOMING POs only)
                purchasesInPeriod.forEach(p => {
                    if (p.PO_Type !== 'OUTGOING') {
                        totalCOGS += parseFloat(p.Total_Amount) || 0;
                    }
                });
            } else {
                // COGS from standard costs based on units sold
                for (const so of salesInPeriod) {
                    const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                    if (linesResult?.data) {
                        linesResult.data.forEach(line => {
                            const item = items.find(i => i.Item_ID === line.Item_ID);
                            const unitsPerPackage = parseFloat(item?.Units_Per_Package) || 1;
                            const packageCost = parseFloat(item?.Package_Cost) || 0;
                            const unitCost = packageCost / unitsPerPackage;
                            const qty = parseInt(line.Quantity) || 0;
                            totalCOGS += qty * unitCost;
                        });
                    }
                }
            }
            
            // Calculate Gross Profit
            const grossProfit = totalRevenue - totalCOGS;
            const grossMargin = totalRevenue > 0 ? (grossProfit / totalRevenue * 100) : 0;
            
            // Period label
            const periodLabel = quarter === 'annual' ? `Year ${year}` : `${quarter} ${year}`;
            const cogsLabel = cogsMethod === 'actual' ? 'Actual Purchase Costs' : 'Standard Costs';
            
            let html = `
                <h3 style="margin-top: 0;"> Profit & Loss Statement</h3>
                
                <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    <span style="font-weight: 600; color: #666; font-size: 12px;">REPORT PARAMETERS:</span>
                    <span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;"> ${periodLabel}</span>
                    <span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;"> COGS: ${cogsLabel}</span>
                    <span style="background: #fff3e0; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ffe0b2;"> Voided Excluded</span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 12px; color: #1565c0; margin-bottom: 5px;"> Revenue</div>
                        <div style="font-size: 22px; font-weight: bold; color: #1976d2;">${formatMoney(totalRevenue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #f44336;">
                        <div style="font-size: 12px; color: #c62828; margin-bottom: 5px;"> COGS</div>
                        <div style="font-size: 22px; font-weight: bold; color: #d32f2f;">${formatMoney(totalCOGS)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px;"> Gross Profit</div>
                        <div style="font-size: 22px; font-weight: bold; color: ${grossProfit >= 0 ? '#388e3c' : '#c62828'};">${formatMoney(grossProfit)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <div style="font-size: 12px; color: #e65100; margin-bottom: 5px;"> Margin</div>
                        <div style="font-size: 22px; font-weight: bold; color: #f57c00;">${grossMargin.toFixed(1)}%</div>
                    </div>
                </div>
                
                <div style="max-width: 500px; margin: 0 auto;">
                    <table class="data-table" style="width: 100%;">
                        <tbody>
                            <tr style="background: #e8f5e9;">
                                <td style="padding: 15px; font-weight: bold; font-size: 16px;"> REVENUE</td>
                                <td style="padding: 15px; text-align: right; font-weight: bold; font-size: 16px; color: #2e7d32;">${formatMoney(totalRevenue)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; padding-left: 30px; color: #666;">Sales Orders (${salesInPeriod.length})</td>
                                <td style="padding: 12px; text-align: right;">${formatMoney(totalRevenue)}</td>
                            </tr>
                            
                            <tr style="background: #ffebee;">
                                <td style="padding: 15px; font-weight: bold; font-size: 16px;"> COST OF GOODS SOLD</td>
                                <td style="padding: 15px; text-align: right; font-weight: bold; font-size: 16px; color: #c62828;">(${formatMoney(totalCOGS)})</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; padding-left: 30px; color: #666;">
                                    ${cogsMethod === 'actual' ? `Purchase Orders (${purchasesInPeriod.filter(p => p.PO_Type !== 'OUTGOING').length})` : 'Standard unit costs  units sold'}
                                </td>
                                <td style="padding: 12px; text-align: right;">${formatMoney(totalCOGS)}</td>
                            </tr>
                            
                            <tr style="background: linear-gradient(135deg, #667eea15, #764ba215); border-top: 3px solid #667eea;">
                                <td style="padding: 20px; font-weight: bold; font-size: 18px;"> GROSS PROFIT</td>
                                <td style="padding: 20px; text-align: right; font-weight: bold; font-size: 18px; color: ${grossProfit >= 0 ? '#2e7d32' : '#c62828'};">
                                    ${formatMoney(grossProfit)}
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; padding-left: 30px; color: #666;">Gross Margin</td>
                                <td style="padding: 12px; text-align: right; font-weight: bold; color: ${grossMargin >= 20 ? '#2e7d32' : '#ff9800'};">${grossMargin.toFixed(1)}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 30px; padding: 15px; background: #f5f5f5; border-radius: 8px; font-size: 12px; color: #666;">
                    <strong>Note:</strong> This is a simplified P&L showing gross profit only. Operating expenses, taxes, and net income are not tracked in this system.
                </div>
            `;
            
            // Add P&L Chart
            const plChartId = 'plChart_' + Date.now();
            
            html += `
                <div style="margin-top: 20px; margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Visual Summary</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 450px;">
                            <canvas id="${plChartId}" height="180"></canvas>
                        </div>
                    </div>
                </div>
                
                <scr` + `ipt>
                    setTimeout(() => {
                        const ctx = document.getElementById('${plChartId}');
                        if (ctx) {
                            if(Chart.getChart(ctx))Chart.getChart(ctx).destroy(); new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: ['Revenue', 'COGS', 'Gross Profit'],
                                    datasets: [{
                                        data: [${totalRevenue.toFixed(2)}, ${totalCOGS.toFixed(2)}, ${grossProfit.toFixed(2)}],
                                        backgroundColor: ['#4caf50', '#f44336', '${grossProfit >= 0 ? '#2196f3' : '#ff9800'}'],
                                        borderRadius: 8
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + Math.abs(ctx.raw).toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        // Annual Sales Summary
        async function generateAnnualSalesSummaryModal() {
            const year = parseInt(reportFilters.year) || new Date().getFullYear();
            const { startDate, endDate } = getDateRangeForPeriod(year, 'annual');
            
            const salesResult = await apiCall('getSalesOrders');
            if (!salesResult?.data) throw new Error('Failed to load sales data');
            
            // Filter by year AND exclude voided
            const salesInYear = salesResult.data.filter(s => {
                if (s.Status === 'Voided') return false;
                const saleDate = parseDate(s.Sale_Date || s.SO_Date);
                return saleDate && saleDate >= startDate && saleDate <= endDate;
            });
            
            // Group by month
            const byMonth = {};
            for (let m = 0; m < 12; m++) {
                byMonth[m] = { sales: 0, orders: 0, paid: 0 };
            }
            
            salesInYear.forEach(s => {
                const saleDate = parseDate(s.Sale_Date || s.SO_Date);
                if (saleDate) {
                    const month = saleDate.getMonth();
                    byMonth[month].sales += parseFloat(s.Total_Amount) || 0;
                    byMonth[month].orders++;
                    byMonth[month].paid += parseFloat(s.Amount_Paid) || 0;
                }
            });
            
            // Group by customer
            const byCustomer = {};
            salesInYear.forEach(s => {
                const custId = s.Customer_ID;
                if (!byCustomer[custId]) {
                    byCustomer[custId] = { name: getCustomerName(custId), total: 0, orders: 0 };
                }
                byCustomer[custId].total += parseFloat(s.Total_Amount) || 0;
                byCustomer[custId].orders++;
            });
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthNamesFull = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Calculate totals
            let totalSales = 0, totalOrders = 0, totalPaid = 0;
            const monthlyData = [];
            for (let m = 0; m < 12; m++) {
                totalSales += byMonth[m].sales;
                totalOrders += byMonth[m].orders;
                totalPaid += byMonth[m].paid;
                monthlyData.push(byMonth[m].sales);
            }
            const avgPerOrder = totalOrders > 0 ? totalSales / totalOrders : 0;
            const collectionRate = totalSales > 0 ? (totalPaid / totalSales * 100) : 0;
            
            const lineChartId = 'annualSalesLineChart_' + Date.now();
            const barChartId = 'annualSalesBarChart_' + Date.now();
            const topCustomers = Object.entries(byCustomer).sort((a, b) => b[1].total - a[1].total).slice(0, 5);
            
            let html = `
                <h3 style="margin-top: 0;"> Annual Sales Summary - ${year}</h3>
                
                <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    <span style="font-weight: 600; color: #666; font-size: 12px;">REPORT PARAMETERS:</span>
                    <span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;"> Calendar Year ${year}</span>
                    <span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;"> ${salesInYear.length} Orders</span>
                    <span style="background: #fff3e0; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ffe0b2;"> Voided Excluded</span>
                </div>
                
                <!-- KPI Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 12px; color: #1565c0; margin-bottom: 5px;"> Total Sales</div>
                        <div style="font-size: 22px; font-weight: bold; color: #1976d2;">${formatMoney(totalSales)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px;"> Collected</div>
                        <div style="font-size: 22px; font-weight: bold; color: #388e3c;">${formatMoney(totalPaid)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                        <div style="font-size: 12px; color: #7b1fa2; margin-bottom: 5px;"> Avg/Order</div>
                        <div style="font-size: 22px; font-weight: bold; color: #8e24aa;">${formatMoney(avgPerOrder)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <div style="font-size: 12px; color: #e65100; margin-bottom: 5px;"> Collection %</div>
                        <div style="font-size: 22px; font-weight: bold; color: #f57c00;">${collectionRate.toFixed(1)}%</div>
                    </div>
                </div>
                
                <!-- Charts Section (collapsible) -->
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'grid' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Monthly Sales Trend</h4>
                            <canvas id="${lineChartId}" height="120"></canvas>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 15px 0; color: #333;"> Top Customers</h4>
                                <canvas id="${barChartId}" height="180"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Table (collapsible) -->
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Monthly Breakdown</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>Month</th>
                                <th style="text-align: right;">Orders</th>
                                <th style="text-align: right;">Sales</th>
                                <th style="text-align: right;">Collected</th>
                            </tr></thead><tbody>`;
            
            for (let m = 0; m < 12; m++) {
                const data = byMonth[m];
                html += `<tr${data.orders === 0 ? ' style="color: #999;"' : ''}>
                    <td>${monthNamesFull[m]}</td>
                    <td style="text-align: right;">${data.orders}</td>
                    <td style="text-align: right;">${formatMoney(data.sales)}</td>
                    <td style="text-align: right;">${formatMoney(data.paid)}</td>
                </tr>`;
            }
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td>TOTAL</td>
                <td style="text-align: right;">${totalOrders}</td>
                <td style="text-align: right;">${formatMoney(totalSales)}</td>
                <td style="text-align: right;">${formatMoney(totalPaid)}</td>
            </tr></tfoot></table></div>
                    </div>
                </div>
                
                <!-- Customer Table (collapsible) -->
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Sales by Customer</strong>
                        <span style="color: #666; font-size: 12px;">(${Object.keys(byCustomer).length} customers - click to show)</span>
                    </div>
                    <div style="display: none; margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>Customer</th>
                                <th style="text-align: right;">Orders</th>
                                <th style="text-align: right;">Total Sales</th>
                            </tr></thead><tbody>`;
            
            Object.entries(byCustomer)
                .sort((a, b) => b[1].total - a[1].total)
                .forEach(([id, data]) => {
                    html += `<tr>
                        <td>${data.name}</td>
                        <td style="text-align: right;">${data.orders}</td>
                        <td style="text-align: right;">${formatMoney(data.total)}</td>
                    </tr>`;
                });
            
            html += `</tbody></table></div>
                    </div>
                </div>
                
                <!-- Chart.js -->
                <scr` + `ipt>
                    setTimeout(() => {
                        // Line Chart - Monthly Trend
                        const ctx1 = document.getElementById('${lineChartId}');
                        if (ctx1) {
                            if(Chart.getChart(ctx1))Chart.getChart(ctx1).destroy(); new Chart(ctx1, {
                                type: 'line',
                                data: {
                                    labels: ['${monthNames.join("', '")}'],
                                    datasets: [{
                                        label: 'Sales',
                                        data: [${monthlyData.map(d => d.toFixed(2)).join(', ')}],
                                        borderColor: '#3b82f6',
                                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                        fill: true,
                                        tension: 0.3,
                                        pointRadius: 4,
                                        pointBackgroundColor: '#3b82f6'
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Bar Chart - Top Customers
                        const ctx2 = document.getElementById('${barChartId}');
                        if (ctx2) {
                            if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                type: 'bar',
                                data: {
                                    labels: [${topCustomers.map(([id, d]) => `'${d.name.replace(/'/g, "\\'").substring(0, 15)}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Sales',
                                        data: [${topCustomers.map(([id, d]) => d.total.toFixed(2)).join(', ')}],
                                        backgroundColor: ['#3b82f6', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b'],
                                        borderRadius: 6
                                    }]
                                },
                                options: {
                                    indexAxis: 'y',
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    },
                                    scales: {
                                        x: {
                                            beginAtZero: true,
                                            ticks: { callback: (val) => '$' + val.toLocaleString() }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        // Annual Purchase Summary
        async function generateAnnualPurchaseSummaryModal() {
            const year = parseInt(reportFilters.year) || new Date().getFullYear();
            const { startDate, endDate } = getDateRangeForPeriod(year, 'annual');
            
            const poResult = await apiCall('getPurchaseOrders');
            if (!poResult?.data) throw new Error('Failed to load PO data');
            
            // Filter by year AND exclude voided (tax reports always exclude voided)
            const posInYear = poResult.data.filter(p => {
                if (p.Status === 'Voided') return false;
                const poDate = parseDate(p.PO_Date);
                return poDate && poDate >= startDate && poDate <= endDate;
            });
            
            // Group by month
            const byMonth = {};
            for (let m = 0; m < 12; m++) {
                byMonth[m] = { total: 0, orders: 0, paid: 0 };
            }
            
            posInYear.forEach(p => {
                const poDate = parseDate(p.PO_Date);
                if (poDate) {
                    const month = poDate.getMonth();
                    byMonth[month].total += parseFloat(p.Total_Amount) || 0;
                    byMonth[month].orders++;
                    byMonth[month].paid += parseFloat(p.Amount_Paid) || 0;
                }
            });
            
            // Group by supplier
            const bySupplier = {};
            posInYear.forEach(p => {
                const suppId = p.Supplier_ID;
                if (!bySupplier[suppId]) {
                    bySupplier[suppId] = { name: getSupplierName(suppId), total: 0, orders: 0 };
                }
                bySupplier[suppId].total += parseFloat(p.Total_Amount) || 0;
                bySupplier[suppId].orders++;
            });
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Calculate totals FIRST for KPI cards
            let totalPurchases = 0, totalOrders = 0, totalPaid = 0;
            for (let m = 0; m < 12; m++) {
                totalPurchases += byMonth[m].total;
                totalOrders += byMonth[m].orders;
                totalPaid += byMonth[m].paid;
            }
            const totalOwed = totalPurchases - totalPaid;
            const avgPerOrder = totalOrders > 0 ? totalPurchases / totalOrders : 0;
            
            let html = `
                <h3 style="margin-top: 0;"> Annual Purchase Summary - ${year}</h3>
                
                <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    <span style="font-weight: 600; color: #666; font-size: 12px;">REPORT PARAMETERS:</span>
                    <span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;"> Calendar Year ${year}</span>
                    <span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;"> ${posInYear.length} POs</span>
                    <span style="background: #fff3e0; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ffe0b2;"> Voided Excluded</span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 12px; color: #1565c0; margin-bottom: 5px;"> Total Purchases</div>
                        <div style="font-size: 22px; font-weight: bold; color: #1976d2;">${formatMoney(totalPurchases)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px;"> Paid</div>
                        <div style="font-size: 22px; font-weight: bold; color: #388e3c;">${formatMoney(totalPaid)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <div style="font-size: 12px; color: #e65100; margin-bottom: 5px;"> Owed</div>
                        <div style="font-size: 22px; font-weight: bold; color: #f57c00;">${formatMoney(totalOwed)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                        <div style="font-size: 12px; color: #7b1fa2; margin-bottom: 5px;"> Avg/Order</div>
                        <div style="font-size: 22px; font-weight: bold; color: #8e24aa;">${formatMoney(avgPerOrder)}</div>
                    </div>
                </div>
                
                <h4 style="margin: 20px 0 10px 0; cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';"><span class="toggle-icon"></span>  Monthly Breakdown</h4>
                <div style="overflow-x: auto;"><table class="data-table">
                    <thead><tr>
                        <th>Month</th>
                        <th style="text-align: right;">POs</th>
                        <th style="text-align: right;">Purchases</th>
                        <th style="text-align: right;">Paid</th>
                    </tr></thead><tbody>`;
            
            for (let m = 0; m < 12; m++) {
                const data = byMonth[m];
                
                html += `<tr${data.orders === 0 ? ' style="color: #999;"' : ''}>
                    <td>${monthNames[m]}</td>
                    <td style="text-align: right;">${data.orders}</td>
                    <td style="text-align: right;">${formatMoney(data.total)}</td>
                    <td style="text-align: right;">${formatMoney(data.paid)}</td>
                </tr>`;
            }
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td>TOTAL</td>
                <td style="text-align: right;">${totalOrders}</td>
                <td style="text-align: right;">${formatMoney(totalPurchases)}</td>
                <td style="text-align: right;">${formatMoney(totalPaid)}</td>
            </tr></tfoot></table></div>`;
            
            // Supplier summary
            html += `
                <div style="margin-top: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Purchases by Supplier</strong>
                        <span style="color: #666; font-size: 12px;">(${Object.keys(bySupplier).length} suppliers - click to show)</span>
                    </div>
                    <div style="display: none; margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>Supplier</th>
                                <th style="text-align: right;">POs</th>
                                <th style="text-align: right;">Total Purchases</th>
                            </tr></thead><tbody>`;
            
            Object.entries(bySupplier)
                .sort((a, b) => b[1].total - a[1].total)
                .forEach(([id, data]) => {
                    html += `<tr>
                        <td>${data.name}</td>
                        <td style="text-align: right;">${data.orders}</td>
                        <td style="text-align: right;">${formatMoney(data.total)}</td>
                    </tr>`;
                });
            
            html += `</tbody></table></div>
                    </div>
                </div>
            `;
            
            // Charts
            const lineChartId = 'purchLineChart_' + Date.now();
            const barChartId = 'purchBarChart_' + Date.now();
            const monthlyData = [];
            for (let m = 0; m < 12; m++) {
                monthlyData.push(byMonth[m].total);
            }
            const topSuppliers = Object.entries(bySupplier).sort((a, b) => b[1].total - a[1].total).slice(0, 5);
            
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'grid' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Monthly Purchases</h4>
                            <canvas id="${lineChartId}" height="200"></canvas>
                        </div>
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Top 5 Suppliers</h4>
                            <canvas id="${barChartId}" height="200"></canvas>
                        </div>
                    </div>
                </div>
                
                <scr` + `ipt>
                    setTimeout(() => {
                        const ctx1 = document.getElementById('${lineChartId}');
                        if (ctx1) {
                            if(Chart.getChart(ctx1))Chart.getChart(ctx1).destroy(); new Chart(ctx1, {
                                type: 'line',
                                data: {
                                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                                    datasets: [{
                                        label: 'Purchases',
                                        data: [${monthlyData.map(v => v.toFixed(2)).join(', ')}],
                                        borderColor: '#3b82f6',
                                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                        fill: true,
                                        tension: 0.3
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: false } },
                                    scales: { y: { beginAtZero: true, ticks: { callback: (val) => '$' + val.toLocaleString() } } }
                                }
                            });
                        }
                        const ctx2 = document.getElementById('${barChartId}');
                        if (ctx2) {
                            if(Chart.getChart(ctx2))Chart.getChart(ctx2).destroy(); new Chart(ctx2, {
                                type: 'bar',
                                data: {
                                    labels: [${topSuppliers.map(([id, d]) => `'${d.name.replace(/'/g, "\\'").substring(0, 15)}'`).join(', ')}],
                                    datasets: [{
                                        label: 'Purchases',
                                        data: [${topSuppliers.map(([id, d]) => d.total.toFixed(2)).join(', ')}],
                                        backgroundColor: ['#3b82f6', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b'],
                                        borderRadius: 6
                                    }]
                                },
                                options: {
                                    indexAxis: 'y',
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: false } },
                                    scales: { x: { beginAtZero: true, ticks: { callback: (val) => '$' + val.toLocaleString() } } }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        // Inventory Valuation
        async function generateInventoryValuationModal() {
            const itemsResult = await apiCall('getItems');
            if (!itemsResult?.data) throw new Error('Failed to load items');
            
            let items = itemsResult.data;
            
            // Filter by supplier if selected
            if (reportFilters.supplier) {
                items = items.filter(i => matchesFilter(i.Supplier_ID, reportFilters.supplier));
            }
            
            // Calculate totals and group by supplier
            let totalUnits = 0, totalValue = 0, totalRetailValue = 0;
            const bySupplier = {};
            
            items.forEach(item => {
                const qty = parseInt(item.Qty_On_Hand) || 0;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPkg = parseInt(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPkg;
                const sellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const extValue = Math.abs(qty) * unitCost;
                
                totalUnits += qty;
                totalValue += extValue;
                totalRetailValue += Math.abs(qty) * sellPrice;
                
                // Group by supplier
                const suppId = item.Supplier_ID || 'Unknown';
                if (!bySupplier[suppId]) {
                    bySupplier[suppId] = { name: getSupplierName(suppId), value: 0, items: 0 };
                }
                bySupplier[suppId].value += extValue;
                bySupplier[suppId].items++;
            });
            
            const potentialProfit = totalRetailValue - totalValue;
            const avgMargin = totalRetailValue > 0 ? (potentialProfit / totalRetailValue * 100) : 0;
            const today = new Date().toLocaleDateString();
            
            const pieChartId = 'invValPieChart_' + Date.now();
            const topSuppliers = Object.entries(bySupplier).sort((a, b) => b[1].value - a[1].value).slice(0, 5);
            const othersValue = Object.entries(bySupplier).slice(5).reduce((sum, [id, d]) => sum + d.value, 0);
            
            let html = `
                <h3 style="margin-top: 0;"> Inventory Valuation Report</h3>
                <p style="color: #666; margin-bottom: 20px;">As of ${today} | ${items.length} items</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 12px; color: #1565c0; margin-bottom: 5px;"> Total Units</div>
                        <div style="font-size: 22px; font-weight: bold; color: #1976d2;">${totalUnits.toLocaleString()}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px;"> Cost Value</div>
                        <div style="font-size: 22px; font-weight: bold; color: #388e3c;">${formatMoney(totalValue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                        <div style="font-size: 12px; color: #7b1fa2; margin-bottom: 5px;"> Retail Value</div>
                        <div style="font-size: 22px; font-weight: bold; color: #8e24aa;">${formatMoney(totalRetailValue)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <div style="font-size: 12px; color: #e65100; margin-bottom: 5px;"> Potential Profit</div>
                        <div style="font-size: 22px; font-weight: bold; color: #f57c00;">${formatMoney(potentialProfit)}</div>
                    </div>
                </div>
            `;
            
            // Charts Section
            html += `
                <div style="margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'grid' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Charts</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #333;"> Value by Supplier</h4>
                            <canvas id="${pieChartId}" height="220"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // Detail Table Section
            html += `
                <div>
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Detail Table</strong>
                        <span style="color: #666; font-size: 12px;">(${items.length} items - click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="overflow-x: auto;"><table class="data-table">
                            <thead><tr>
                                <th>SKU</th>
                                <th>Description</th>
                                <th>Supplier</th>
                                <th style="text-align: right;">Qty</th>
                                <th style="text-align: right;">Unit Cost</th>
                                <th style="text-align: right;">Ext. Value</th>
                            </tr></thead><tbody>`;
            
            items.forEach(item => {
                const qty = parseInt(item.Qty_On_Hand) || 0;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPkg = parseInt(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPkg;
                const extValue = Math.abs(qty) * unitCost;
                
                html += `<tr>
                    <td>${item.SKU || '-'}</td>
                    <td>${item.Item_Description || '-'}</td>
                    <td>${getSupplierName(item.Supplier_ID)}</td>
                    <td style="text-align: right; color: ${qty < 0 ? '#c62828' : '#333'};">${qty}</td>
                    <td style="text-align: right;">${formatMoney(unitCost)}</td>
                    <td style="text-align: right;">${formatMoney(extValue)}</td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="3">TOTAL</td>
                <td style="text-align: right;">${totalUnits}</td>
                <td></td>
                <td style="text-align: right; color: #2e7d32;">${formatMoney(totalValue)}</td>
            </tr></tfoot></table></div>
                    </div>
                </div>
            `;
            
            // Chart.js initialization
            const suppLabels = topSuppliers.map(([id, d]) => d.name.replace(/'/g, "\\'").substring(0, 15));
            const suppData = topSuppliers.map(([id, d]) => d.value);
            
            html += `
                <scr` + `ipt>
                    setTimeout(() => {
                        const ctx = document.getElementById('${pieChartId}');
                        if (ctx) {
                            if(Chart.getChart(ctx))Chart.getChart(ctx).destroy(); new Chart(ctx, {
                                type: 'doughnut',
                                data: {
                                    labels: ['${suppLabels.join("', '")}' ${othersValue > 0 ? ", 'Others'" : ''}],
                                    datasets: [{
                                        data: [${suppData.join(', ')}${othersValue > 0 ? ', ' + othersValue.toFixed(2) : ''}],
                                        backgroundColor: ['#3b82f6', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#9ca3af'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { position: 'right', labels: { padding: 10, usePointStyle: true, font: { size: 11 } } },
                                        tooltip: {
                                            callbacks: {
                                                label: (ctx) => ctx.label + ': $' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        // Cash Flow Summary
        async function generateCashFlowSummaryModal() {
            const year = parseInt(reportFilters.year) || new Date().getFullYear();
            const quarter = reportFilters.quarter || 'annual';
            
            const { startDate, endDate } = getDateRangeForPeriod(year, quarter);
            
            const [salesResult, poResult] = await Promise.all([
                apiCall('getSalesOrders'),
                apiCall('getPurchaseOrders')
            ]);
            
            if (!salesResult?.data || !poResult?.data) {
                throw new Error('Failed to load data');
            }
            
            // Filter by period AND exclude voided (tax reports always exclude voided)
            const salesInPeriod = salesResult.data.filter(s => {
                if (s.Status === 'Voided') return false;
                const d = parseDate(s.Sale_Date || s.SO_Date);
                return d && d >= startDate && d <= endDate;
            });
            
            const posInPeriod = poResult.data.filter(p => {
                if (p.Status === 'Voided') return false;
                const d = parseDate(p.PO_Date);
                return d && d >= startDate && d <= endDate;
            });
            
            // Calculate totals
            let totalSalesInvoiced = 0, totalSalesCollected = 0;
            let totalPurchasesInvoiced = 0, totalPurchasesPaid = 0;
            
            salesInPeriod.forEach(s => {
                totalSalesInvoiced += parseFloat(s.Total_Amount) || 0;
                totalSalesCollected += parseFloat(s.Amount_Paid) || 0;
            });
            
            posInPeriod.forEach(p => {
                totalPurchasesInvoiced += parseFloat(p.Total_Amount) || 0;
                totalPurchasesPaid += parseFloat(p.Amount_Paid) || 0;
            });
            
            const outstandingReceivables = totalSalesInvoiced - totalSalesCollected;
            const outstandingPayables = totalPurchasesInvoiced - totalPurchasesPaid;
            const netCashFlow = totalSalesCollected - totalPurchasesPaid;
            
            const periodLabel = quarter === 'annual' ? `Year ${year}` : `${quarter} ${year}`;
            
            let html = `
                <h3 style="margin-top: 0;"> Cash Flow Summary</h3>
                
                <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    <span style="font-weight: 600; color: #666; font-size: 12px;">REPORT PARAMETERS:</span>
                    <span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;"> ${periodLabel}</span>
                    <span style="background: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ddd;"> ${salesInPeriod.length} Sales / ${posInPeriod.length} POs</span>
                    <span style="background: #fff3e0; padding: 4px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #ffe0b2;"> Voided Excluded</span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    
                    <!-- Cash In -->
                    <div style="background: #e8f5e9; padding: 20px; border-radius: 12px; border-left: 4px solid #2e7d32;">
                        <h4 style="margin: 0 0 15px 0; color: #2e7d32;"> Cash In (Collections)</h4>
                        <table style="width: 100%;">
                            <tr>
                                <td style="padding: 8px 0; color: #666;">Sales Invoiced</td>
                                <td style="text-align: right;">${formatMoney(totalSalesInvoiced)}</td>
                            </tr>
                            <tr style="font-weight: bold; font-size: 18px;">
                                <td style="padding: 8px 0; color: #2e7d32;">Collected</td>
                                <td style="text-align: right; color: #2e7d32;">${formatMoney(totalSalesCollected)}</td>
                            </tr>
                            <tr style="border-top: 1px solid #c8e6c9;">
                                <td style="padding: 8px 0; color: #666;">Outstanding A/R</td>
                                <td style="text-align: right; color: #ff9800;">${formatMoney(outstandingReceivables)}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Cash Out -->
                    <div style="background: #ffebee; padding: 20px; border-radius: 12px; border-left: 4px solid #c62828;">
                        <h4 style="margin: 0 0 15px 0; color: #c62828;"> Cash Out (Payments)</h4>
                        <table style="width: 100%;">
                            <tr>
                                <td style="padding: 8px 0; color: #666;">Purchases Invoiced</td>
                                <td style="text-align: right;">${formatMoney(totalPurchasesInvoiced)}</td>
                            </tr>
                            <tr style="font-weight: bold; font-size: 18px;">
                                <td style="padding: 8px 0; color: #c62828;">Paid Out</td>
                                <td style="text-align: right; color: #c62828;">${formatMoney(totalPurchasesPaid)}</td>
                            </tr>
                            <tr style="border-top: 1px solid #ffcdd2;">
                                <td style="padding: 8px 0; color: #666;">Outstanding A/P</td>
                                <td style="text-align: right; color: #ff9800;">${formatMoney(outstandingPayables)}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Net Cash Flow -->
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 25px; border-radius: 12px; color: white; text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">NET CASH FLOW</div>
                    <div style="font-size: 36px; font-weight: bold;">
                        ${netCashFlow >= 0 ? '+' : ''}${formatMoney(netCashFlow)}
                    </div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Collections minus Payments</div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0;">Summary</h4>
                    <table class="data-table">
                        <tr>
                            <td>Total Sales Orders</td>
                            <td style="text-align: right;">${salesInPeriod.length}</td>
                        </tr>
                        <tr>
                            <td>Total Purchase Orders</td>
                            <td style="text-align: right;">${posInPeriod.length}</td>
                        </tr>
                        <tr>
                            <td>Collection Rate</td>
                            <td style="text-align: right;">${totalSalesInvoiced > 0 ? (totalSalesCollected / totalSalesInvoiced * 100).toFixed(1) : 0}%</td>
                        </tr>
                        <tr>
                            <td>Payment Rate</td>
                            <td style="text-align: right;">${totalPurchasesInvoiced > 0 ? (totalPurchasesPaid / totalPurchasesInvoiced * 100).toFixed(1) : 0}%</td>
                        </tr>
                    </table>
                </div>
            `;
            
            // Add chart for cash in vs cash out
            const cashChartId = 'cashFlowChart_' + Date.now();
            
            html += `
                <div style="margin-top: 20px; margin-bottom: 20px;">
                    <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '' : '';" 
                         style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none;">
                        <span class="toggle-icon"></span>
                        <strong> Cash Flow Chart</strong>
                        <span style="color: #666; font-size: 12px;">(click to hide/show)</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 500px;">
                            <canvas id="${cashChartId}" height="180"></canvas>
                        </div>
                    </div>
                </div>
                
                <scr` + `ipt>
                    setTimeout(() => {
                        const ctx = document.getElementById('${cashChartId}');
                        if (ctx) {
                            if(Chart.getChart(ctx))Chart.getChart(ctx).destroy(); new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: ['Cash In', 'Cash Out', 'Net Flow'],
                                    datasets: [{
                                        data: [${totalSalesCollected.toFixed(2)}, ${totalPurchasesPaid.toFixed(2)}, ${netCashFlow.toFixed(2)}],
                                        backgroundColor: ['#4caf50', '#f44336', '${netCashFlow >= 0 ? '#2196f3' : '#ff9800'}'],
                                        borderRadius: 8
                                    }]
                                },
                                options: {
                                    responsive: false, animation: false,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: false } },
                                    scales: { y: { beginAtZero: true, ticks: { callback: (val) => '$' + val.toLocaleString() } } }
                                }
                            });
                        }
                    }, 100);
                <` + `/script>
            `;
            
            return html;
        }
        
        async function generateActionDashboard() {
            // Fetch all necessary data
            const [salesResult, purchasesResult, itemsResult, customersResult, suppliersResult] = await Promise.all([
                apiCall('getSalesOrders'),
                apiCall('getPurchaseOrders'),
                apiCall('getItems'),
                apiCall('getCustomers'),
                apiCall('getSuppliers')
            ]);
            
            if (!salesResult?.data || !purchasesResult?.data || !itemsResult?.data || !customersResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const sales = salesResult.data.filter(s => s.Status !== 'Voided');
            const purchases = purchasesResult.data.filter(p => p.Status !== 'Voided');
            const items = itemsResult.data;
            const customers = customersResult.data;
            const suppliers = suppliersResult.data;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // ===== 1. PAST DUE PAYMENTS =====
            const pastDuePayments = sales.filter(s => {
                if (s.Payment_Status === 'Paid' || !s.Due_Date) return false;
                const dueDate = new Date(s.Due_Date);
                return dueDate < today;
            }).map(s => {
                const dueDate = new Date(s.Due_Date);
                const daysLate = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
                const customer = customers.find(c => c.Customer_ID === s.Customer_ID);
                let balance = parseFloat(s.Total_Amount || 0) - parseFloat(s.Amount_Paid || 0);
                if (Math.abs(balance) < 0.01) balance = 0;
                return {
                    ...s,
                    Customer_Name: customer?.Customer_Name || 'Unknown',
                    Days_Late: daysLate,
                    Balance: balance
                };
            }).sort((a, b) => b.Days_Late - a.Days_Late);
            
            // ===== 2. LATE PURCHASE ORDERS =====
            const latePOs = purchases.filter(p => {
                if (!p.Need_By_Date) return false;
                const needBy = new Date(p.Need_By_Date);
                return needBy < today && p.Status !== 'Received';
            }).map(p => {
                const needBy = new Date(p.Need_By_Date);
                const daysLate = Math.floor((today - needBy) / (1000 * 60 * 60 * 24));
                const supplier = suppliers.find(s => s.Supplier_ID === p.Supplier_ID);
                return {
                    ...p,
                    Supplier_Name: supplier?.Supplier_Name || 'Unknown',
                    Days_Late: daysLate
                };
            }).sort((a, b) => b.Days_Late - a.Days_Late);
            
            // ===== 3. NEGATIVE INVENTORY =====
            const negativeInventory = items.filter(item => {
                const qty = parseFloat(item.Qty_On_Hand || 0);
                return qty < 0;
            }).map(item => {
                const qty = parseFloat(item.Qty_On_Hand || 0);
                const supplier = suppliers.find(s => s.Supplier_ID === item.Supplier_ID);
                return {
                    ...item,
                    Qty: qty,
                    Supplier_Name: supplier?.Supplier_Name || 'Unknown'
                };
            }).sort((a, b) => a.Qty - b.Qty);
            
            // ===== 4. LOW STOCK (NEEDS REORDER) =====
            // First, calculate committed stock from pending sales orders
            const committedByItem = {};
            
            // Get pending/unfulfilled sales orders
            const pendingSales = sales.filter(s => 
                s.Status === 'Pending' || s.Status === 'Ready' || s.Status === 'Out for Delivery'
            );
            
            // Fetch lines for pending orders to get committed quantities
            for (const so of pendingSales) {
                try {
                    const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                    if (linesResult?.data) {
                        linesResult.data.forEach(line => {
                            const itemId = line.Item_ID;
                            const qty = parseFloat(line.Quantity) || 0;
                            if (!committedByItem[itemId]) committedByItem[itemId] = 0;
                            committedByItem[itemId] += qty;
                        });
                    }
                } catch(e) {
                    // Skip if can't fetch lines
                }
            }
            
            const lowStock = items.filter(item => {
                const qty = parseFloat(item.Qty_On_Hand || 0);
                const committed = committedByItem[item.Item_ID] || 0;
                const available = qty - committed;
                const reorder = parseFloat(item.Reorder_Point || 0);
                return available <= reorder && reorder > 0;
            }).map(item => {
                const qty = parseFloat(item.Qty_On_Hand || 0);
                const committed = committedByItem[item.Item_ID] || 0;
                const available = qty - committed;
                const reorder = parseFloat(item.Reorder_Point || 0);
                const supplier = suppliers.find(s => s.Supplier_ID === item.Supplier_ID);
                const unitsNeeded = reorder - available;
                return {
                    ...item,
                    Qty: qty,
                    Committed: committed,
                    Available: available,
                    Reorder_Point: reorder,
                    Units_Needed: unitsNeeded,
                    Supplier_Name: supplier?.Supplier_Name || 'Unknown'
                };
            }).sort((a, b) => (a.Available / a.Reorder_Point) - (b.Available / b.Reorder_Point));
            
            // ===== 5. DEAD STOCK (NO SALES) =====
            const deadStockDays = 180; // Configurable threshold
            const deadStockDate = new Date();
            deadStockDate.setDate(deadStockDate.getDate() - deadStockDays);
            
            const deadStock = items.filter(item => {
                const qty = parseFloat(item.Qty_On_Hand || 0);
                if (qty <= 0) return false;
                
                // Find last sale of this item
                const itemSales = sales.filter(s => {
                    const lineItems = s.Line_Items ? JSON.parse(s.Line_Items) : [];
                    return lineItems.some(li => li.Item_ID === item.Item_ID);
                });
                
                if (itemSales.length === 0) return true; // Never sold
                
                const lastSale = itemSales.sort((a, b) => 
                    new Date(b.Order_Date) - new Date(a.Order_Date)
                )[0];
                
                return new Date(lastSale.Order_Date) < deadStockDate;
            }).map(item => {
                const qty = parseFloat(item.Qty_On_Hand || 0);
                const unitCost = parseFloat(item.Package_Cost || 0) / parseFloat(item.Units_Per_Package || 1);
                // Use absolute value - dead stock value is always positive
                const value = Math.abs(qty) * unitCost;
                
                // Find last sale date
                const itemSales = sales.filter(s => {
                    const lineItems = s.Line_Items ? JSON.parse(s.Line_Items) : [];
                    return lineItems.some(li => li.Item_ID === item.Item_ID);
                }).sort((a, b) => new Date(b.Order_Date) - new Date(a.Order_Date));
                
                let daysSinceLastSale = 999;
                if (itemSales.length > 0) {
                    const lastSaleDate = new Date(itemSales[0].Order_Date);
                    daysSinceLastSale = Math.floor((today - lastSaleDate) / (1000 * 60 * 60 * 24));
                }
                
                const supplier = suppliers.find(s => s.Supplier_ID === item.Supplier_ID);
                return {
                    ...item,
                    Qty: qty,
                    Value: value,
                    Days_Since_Sale: daysSinceLastSale,
                    Supplier_Name: supplier?.Supplier_Name || 'Unknown'
                };
            }).sort((a, b) => b.Days_Since_Sale - a.Days_Since_Sale);
            
            const totalDeadStockValue = deadStock.reduce((sum, item) => sum + item.Value, 0);
            
            // ===== 6. SLOW MOVING INVENTORY =====
            const slowMovingDays = 60; // Configurable threshold
            const slowMovingDate = new Date();
            slowMovingDate.setDate(slowMovingDate.getDate() - slowMovingDays);
            
            const slowMoving = items.filter(item => {
                const qty = parseFloat(item.Qty_On_Hand || 0);
                if (qty <= 0) return false;
                
                // Find last sale of this item
                const itemSales = sales.filter(s => {
                    const lineItems = s.Line_Items ? JSON.parse(s.Line_Items) : [];
                    return lineItems.some(li => li.Item_ID === item.Item_ID);
                });
                
                if (itemSales.length === 0) return false; // This is dead stock, not slow moving
                
                const lastSale = itemSales.sort((a, b) => 
                    new Date(b.Order_Date) - new Date(a.Order_Date)
                )[0];
                
                const lastSaleDate = new Date(lastSale.Order_Date);
                return lastSaleDate < slowMovingDate && lastSaleDate >= deadStockDate;
            }).map(item => {
                const qty = parseFloat(item.Qty_On_Hand || 0);
                
                // Find last sale date
                const itemSales = sales.filter(s => {
                    const lineItems = s.Line_Items ? JSON.parse(s.Line_Items) : [];
                    return lineItems.some(li => li.Item_ID === item.Item_ID);
                }).sort((a, b) => new Date(b.Order_Date) - new Date(a.Order_Date));
                
                const lastSaleDate = new Date(itemSales[0].Order_Date);
                const daysSinceLastSale = Math.floor((today - lastSaleDate) / (1000 * 60 * 60 * 24));
                
                const supplier = suppliers.find(s => s.Supplier_ID === item.Supplier_ID);
                return {
                    ...item,
                    Qty: qty,
                    Days_Since_Sale: daysSinceLastSale,
                    Supplier_Name: supplier?.Supplier_Name || 'Unknown'
                };
            }).sort((a, b) => b.Days_Since_Sale - a.Days_Since_Sale);
            
            // ===== 7. DORMANT CUSTOMERS =====
            const dormantDays = 45; // Configurable threshold
            const dormantDate = new Date();
            dormantDate.setDate(dormantDate.getDate() - dormantDays);
            
            const dormantCustomers = customers.filter(c => {
                const customerSales = sales.filter(s => s.Customer_ID === c.Customer_ID);
                if (customerSales.length === 0) return false; // Never bought - not dormant, just never active
                
                const lastSale = customerSales.sort((a, b) => 
                    new Date(b.Order_Date) - new Date(a.Order_Date)
                )[0];
                
                return new Date(lastSale.Order_Date) < dormantDate;
            }).map(c => {
                const customerSales = sales.filter(s => s.Customer_ID === c.Customer_ID)
                    .sort((a, b) => new Date(b.Order_Date) - new Date(a.Order_Date));
                
                const lastSaleDate = new Date(customerSales[0].Order_Date);
                const daysSinceLastOrder = Math.floor((today - lastSaleDate) / (1000 * 60 * 60 * 24));
                
                const totalSales = customerSales.reduce((sum, s) => 
                    sum + parseFloat(s.Total_Amount || 0), 0
                );
                
                return {
                    ...c,
                    Last_Order_Date: lastSaleDate,
                    Days_Since_Order: daysSinceLastOrder,
                    Total_Sales: totalSales
                };
            }).sort((a, b) => b.Total_Sales - a.Total_Sales); // Sort by best customers first
            
            // ===== BUILD HTML =====
            let html = `
                <style>
                    .action-section {
                        background: white;
                        border-radius: 16px;
                        padding: 25px;
                        margin-bottom: 25px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 2px 6px rgba(0,0,0,0.04);
                        border-left: 6px solid #666;
                        transition: transform 0.2s, box-shadow 0.2s;
                    }
                    .action-section:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 8px 20px rgba(0,0,0,0.12), 0 4px 10px rgba(0,0,0,0.06);
                    }
                    .action-section.critical { 
                        border-left-color: #dc2626;
                        border-left-width: 6px;
                    }
                    .action-section.warning { 
                        border-left-color: #f59e0b;
                        border-left-width: 6px;
                    }
                    .action-section.info { 
                        border-left-color: #3b82f6;
                        border-left-width: 6px;
                    }
                    .action-section-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        padding-bottom: 15px;
                        border-bottom: 3px solid #e5e7eb;
                    }
                    .action-section-title {
                        font-size: 22px;
                        font-weight: 700;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        color: #1f2937;
                    }
                    .action-count {
                        background: linear-gradient(135deg, #dc2626, #ef4444);
                        color: white;
                        padding: 6px 16px;
                        border-radius: 20px;
                        font-size: 15px;
                        font-weight: 700;
                        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
                    }
                    .action-count.warning {
                        background: linear-gradient(135deg, #f59e0b, #fbbf24);
                        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
                    }
                    .action-count.info {
                        background: linear-gradient(135deg, #3b82f6, #60a5fa);
                        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
                    }
                    .action-table {
                        width: 100%;
                        border-collapse: separate;
                        border-spacing: 0;
                        margin-top: 15px;
                        border-radius: 8px;
                        overflow: hidden;
                        border: 1px solid #e5e7eb;
                    }
                    .action-table th {
                        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
                        padding: 12px 14px;
                        text-align: left;
                        font-weight: 600;
                        font-size: 13px;
                        color: #374151;
                        border-bottom: 2px solid #d1d5db;
                    }
                    .action-table td {
                        padding: 12px 14px;
                        border-bottom: 1px solid #e5e7eb;
                        font-size: 14px;
                    }
                    .action-table tr:last-child td {
                        border-bottom: none;
                    }
                    .action-table tbody tr:hover {
                        background: #f9fafb;
                        transition: background 0.2s;
                    }
                    .action-btn {
                        padding: 8px 16px;
                        border-radius: 8px;
                        border: none;
                        cursor: pointer;
                        font-size: 13px;
                        font-weight: 600;
                        transition: all 0.2s;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .action-btn:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                    }
                    .action-btn-primary {
                        background: linear-gradient(135deg, #3b82f6, #60a5fa);
                        color: white;
                    }
                    .action-btn-primary:hover {
                        background: linear-gradient(135deg, #2563eb, #3b82f6);
                    }
                    .action-btn-success {
                        background: linear-gradient(135deg, #10b981, #34d399);
                        color: white;
                    }
                    .action-btn-success:hover {
                        background: linear-gradient(135deg, #059669, #10b981);
                    }
                    .action-btn-warning {
                        background: linear-gradient(135deg, #f59e0b, #fbbf24);
                        color: white;
                    }
                    .action-btn-warning:hover {
                        background: linear-gradient(135deg, #d97706, #f59e0b);
                    }
                    .action-btn-danger {
                        background: linear-gradient(135deg, #ef4444, #f87171);
                        color: white;
                    }
                    .action-btn-danger:hover {
                        background: linear-gradient(135deg, #dc2626, #ef4444);
                    }
                    .days-late {
                        color: #dc2626;
                        font-weight: 700;
                    }
                    .summary-box {
                        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
                        border: 2px solid #fecaca;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 20px;
                        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.1);
                    }
                    .summary-item {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 8px;
                    }
                    .summary-label {
                        font-weight: 600;
                        color: #374151;
                    }
                    .summary-value {
                        font-weight: 700;
                        color: #dc2626;
                    }
                    
                    /* Oval Action Buttons */
                    .oval-action-btn {
                        padding: 6px 14px;
                        border-radius: 20px;
                        border: 2px solid;
                        font-size: 13px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s;
                        white-space: nowrap;
                        display: inline-flex;
                        align-items: center;
                        gap: 4px;
                    }
                    .oval-action-btn:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                    }
                    .oval-action-primary {
                        background: #3b82f6;
                        color: white;
                        border-color: #2563eb;
                    }
                    .oval-action-primary:hover {
                        background: #2563eb;
                    }
                    .oval-action-success {
                        background: #10b981;
                        color: white;
                        border-color: #059669;
                    }
                    .oval-action-success:hover {
                        background: #059669;
                    }
                    .oval-action-warning {
                        background: #f59e0b;
                        color: white;
                        border-color: #d97706;
                    }
                    .oval-action-warning:hover {
                        background: #d97706;
                    }
                    .oval-action-info {
                        background: #06b6d4;
                        color: white;
                        border-color: #0891b2;
                    }
                    .oval-action-info:hover {
                        background: #0891b2;
                    }
                    .oval-action-danger {
                        background: #ef4444;
                        color: white;
                        border-color: #dc2626;
                    }
                    .oval-action-danger:hover {
                        background: #dc2626;
                    }
                    
                    /* Action Dashboard Container - Locked Layout */
                    .action-dashboard-container {
                        max-width: 100%;
                        margin: 0 auto;
                        position: relative;
                        display: flex;
                        flex-direction: column;
                        gap: 0;
                        min-height: auto;
                        overflow: visible;
                    }
                    
                    /* Ensure sections don't shift */
                    .action-dashboard-container .action-section {
                        flex-shrink: 0;
                        position: relative;
                    }
                    
                    /* Mobile-specific fixes for Action Dashboard */
                    @media (max-width: 768px) {
                        .action-dashboard-container {
                            width: 100% !important;
                            max-width: 100% !important;
                            padding: 0 !important;
                            margin: 0 !important;
                        }
                        
                        .action-dashboard-container > div {
                            max-width: 100% !important;
                            overflow-x: hidden !important;
                        }
                        
                        /* Header */
                        .action-dashboard-container > div:first-child {
                            padding: 20px !important;
                            margin-bottom: 15px !important;
                            border-radius: 10px !important;
                        }
                        
                        .action-dashboard-container > div:first-child h2 {
                            font-size: 22px !important;
                        }
                        
                        .action-dashboard-container > div:first-child p {
                            font-size: 13px !important;
                        }
                        
                        /* Action sections */
                        .action-section {
                            padding: 15px !important;
                            margin-bottom: 15px !important;
                            border-radius: 10px !important;
                        }
                        
                        .action-section-header {
                            flex-direction: column !important;
                            align-items: flex-start !important;
                            gap: 10px !important;
                        }
                        
                        .action-section-title {
                            font-size: 16px !important;
                        }
                        
                        /* Tables in Action Dashboard */
                        .action-dashboard-container table {
                            font-size: 12px !important;
                        }
                        
                        .action-dashboard-container th,
                        .action-dashboard-container td {
                            padding: 8px 6px !important;
                        }
                        
                        /* Action buttons */
                        .oval-action-btn {
                            padding: 5px 10px !important;
                            font-size: 11px !important;
                        }
                        
                        /* Summary box */
                        .summary-box {
                            padding: 12px !important;
                        }
                    }
                    
                    /* Landscape-specific fixes for Action Dashboard */
                    @media (max-height: 500px) and (orientation: landscape) {
                        .action-dashboard-container {
                            width: 100% !important;
                            max-width: 100% !important;
                            padding: 0 !important;
                            margin: 0 !important;
                        }
                        
                        .action-dashboard-container > div {
                            max-width: 100% !important;
                            overflow-x: hidden !important;
                        }
                        
                        /* Header - compact in landscape */
                        .action-dashboard-container > div:first-child {
                            padding: 10px 15px !important;
                            margin-bottom: 10px !important;
                            border-radius: 8px !important;
                        }
                        
                        .action-dashboard-container > div:first-child h2 {
                            font-size: 16px !important;
                            margin-bottom: 0 !important;
                        }
                        
                        .action-dashboard-container > div:first-child p {
                            display: none !important;
                        }
                        
                        /* Action sections - compact */
                        .action-section {
                            padding: 10px !important;
                            margin-bottom: 10px !important;
                            border-radius: 8px !important;
                        }
                        
                        .action-section-header {
                            flex-direction: row !important;
                            align-items: center !important;
                            gap: 10px !important;
                            padding: 5px 0 !important;
                        }
                        
                        .action-section-title {
                            font-size: 14px !important;
                        }
                        
                        /* Tables in Action Dashboard - compact */
                        .action-dashboard-container table {
                            font-size: 11px !important;
                        }
                        
                        .action-dashboard-container th,
                        .action-dashboard-container td {
                            padding: 5px 4px !important;
                        }
                        
                        /* Action buttons - smaller */
                        .oval-action-btn {
                            padding: 3px 8px !important;
                            font-size: 10px !important;
                        }
                        
                        /* Summary box - compact */
                        .summary-box {
                            padding: 8px !important;
                            margin-bottom: 10px !important;
                        }
                        
                        .summary-item {
                            margin-bottom: 4px !important;
                            font-size: 12px !important;
                        }
                    }
                </style>
                
                <div class="action-dashboard-container">
                <div style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white; padding: 35px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(220, 38, 38, 0.3), 0 4px 12px rgba(0,0,0,0.1); border: 2px solid rgba(255, 255, 255, 0.1);">
                    <h2 style="margin: 0 0 10px 0; font-size: 32px; display: flex; align-items: center; gap: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                         ACTION DASHBOARD
                    </h2>
                    <p style="margin: 0; font-size: 16px; opacity: 0.95;">
                        Critical issues requiring immediate attention
                    </p>
                </div>
            `;
            
            // 1. PAST DUE PAYMENTS
            html += `
                <div class="action-section critical">
                    <div class="action-section-header">
                        <div class="action-section-title">
                             PAST DUE PAYMENTS
                            <span class="action-count">${pastDuePayments.length}</span>
                        </div>
                        ${pastDuePayments.length > 0 ? '<button class="action-btn action-btn-primary" onclick="alert(\'Send Reminder feature coming soon!\')"> Send Reminders</button>' : ''}
                    </div>
                    <p style="color: #6b7280; font-size: 14px; margin: -10px 0 15px 0; padding: 0; line-height: 1.5;">
                        <strong>Customer invoices (sales orders)</strong> where the due date has passed and payment is not yet received. Sorted by most overdue first.
                    </p>
            `;
            
            if (pastDuePayments.length === 0) {
                html += '<p style="color: #10b981; font-weight: 600;"> No past due payments!</p>';
            } else {
                const totalPastDue = pastDuePayments.reduce((sum, p) => sum + p.Balance, 0);
                html += `
                    <div class="summary-box">
                        <div class="summary-item">
                            <span class="summary-label">Total Past Due Amount:</span>
                            <span class="summary-value">${formatMoney(totalPastDue)}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Number of Customers:</span>
                            <span class="summary-value">${new Set(pastDuePayments.map(p => p.Customer_ID)).size}</span>
                        </div>
                    </div>
                    <table class="action-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Invoice</th>
                                <th>Due Date</th>
                                <th>Days Late</th>
                                <th>Balance</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                pastDuePayments.slice(0, 10).forEach(p => {
                    const dueDate = new Date(p.Due_Date);
                    const dueDateStr = (dueDate.getMonth()+1) + '/' + dueDate.getDate() + '/' + dueDate.getFullYear();
                    html += `
                        <tr>
                            <td>${p.Customer_Name}</td>
                            <td>SO-${p.Sale_ID}</td>
                            <td>${dueDateStr}</td>
                            <td class="days-late">${p.Days_Late} days</td>
                            <td>${formatMoney(p.Balance)}</td>
                            <td>
                                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                    <button class="oval-action-btn oval-action-primary" onclick="viewSaleOrder('${p.Sale_ID}')"> View</button>
                                    <button class="oval-action-btn oval-action-success" onclick="recordSalesPayment('${p.Sale_ID}', ${p.Total_Amount || 0}, ${p.Amount_Paid || 0})"> Pay</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                if (pastDuePayments.length > 10) {
                    html += `<tr><td colspan="6" style="text-align: center; color: #666; padding: 15px;">... and ${pastDuePayments.length - 10} more</td></tr>`;
                }
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            html += '</div>';
            
            // 2. LATE PURCHASE ORDERS
            html += `
                <div class="action-section warning">
                    <div class="action-section-header">
                        <div class="action-section-title">
                             LATE PURCHASE ORDERS
                            <span class="action-count warning">${latePOs.length}</span>
                        </div>
                    </div>
                    <p style="color: #6b7280; font-size: 14px; margin: -10px 0 15px 0; padding: 0; line-height: 1.5;">
                        <strong>Inbound orders from suppliers</strong> where the "Need By Date" has passed and the order is not yet received. Only shows POs that have a Need By Date set.
                    </p>
            `;
            
            if (latePOs.length === 0) {
                html += '<p style="color: #10b981; font-weight: 600;"> No late purchase orders!</p>';
            } else {
                html += `
                    <table class="action-table">
                        <thead>
                            <tr>
                                <th>Supplier</th>
                                <th>PO #</th>
                                <th>Need By Date</th>
                                <th>Days Late</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                latePOs.forEach(p => {
                    const needByDate = new Date(p.Need_By_Date);
                    const needByStr = (needByDate.getMonth()+1) + '/' + needByDate.getDate() + '/' + needByDate.getFullYear();
                    html += `
                        <tr>
                            <td>${p.Supplier_Name}</td>
                            <td>PO-${p.PO_ID}</td>
                            <td>${needByStr}</td>
                            <td class="days-late">${p.Days_Late} days</td>
                            <td>${p.Status}</td>
                            <td>
                                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                    <button class="oval-action-btn oval-action-warning" onclick="viewPurchaseOrder('${p.PO_ID}')"> View</button>
                                    <button class="oval-action-btn oval-action-info" onclick="viewPurchaseOrder('${p.PO_ID}')"> Receive</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            html += '</div>';
            
            // 3. NEGATIVE INVENTORY
            html += `
                <div class="action-section critical">
                    <div class="action-section-header">
                        <div class="action-section-title">
                             NEGATIVE INVENTORY
                            <span class="action-count">${negativeInventory.length}</span>
                        </div>
                        ${negativeInventory.length > 0 ? '<button class="action-btn action-btn-danger" onclick="showSection(\'inventory\')">Fix Now</button>' : ''}
                    </div>
                    <p style="color: #6b7280; font-size: 14px; margin: -10px 0 15px 0; padding: 0; line-height: 1.5;">
                        <strong>Items sold before received</strong> - Qty On Hand is below zero. This indicates you sold more than you had in stock. Needs immediate correction.
                    </p>
            `;
            
            if (negativeInventory.length === 0) {
                html += '<p style="color: #10b981; font-weight: 600;"> No negative inventory!</p>';
            } else {
                html += `
                    <table class="action-table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Item</th>
                                <th>Supplier</th>
                                <th>Current Qty</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                negativeInventory.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.SKU || 'N/A'}</td>
                            <td>${item.Item_Description}</td>
                            <td>${item.Supplier_Name}</td>
                            <td class="days-late">${item.Qty} units</td>
                            <td>
                                <button class="oval-action-btn oval-action-danger" onclick="createInventoryAdjustment('${item.Item_ID}')"> Adjust</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            html += '</div>';
            
            // 4. LOW STOCK
            html += `
                <div class="action-section warning">
                    <div class="action-section-header">
                        <div class="action-section-title">
                             LOW STOCK - NEEDS REORDER
                            <span class="action-count warning">${lowStock.length}</span>
                        </div>
                        ${lowStock.length > 0 ? '<button class="action-btn action-btn-success" onclick="bulkReorder()"> Bulk Reorder</button>' : ''}
                    </div>
                    <p style="color: #6b7280; font-size: 14px; margin: -10px 0 15px 0; padding: 0; line-height: 1.5;">
                        <strong>Items at or below reorder point</strong> (considering pending orders). Sorted by lowest availability first.
                    </p>
                    <div style="background: #fffbeb; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px 16px; margin-bottom: 15px;">
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 6px;"> Gap Formula:</div>
                        <div style="font-family: monospace; font-size: 13px; color: #78350f; line-height: 1.6;">
                            Available = On Hand  Committed (pending orders)<br>
                            Gap = Reorder Point  Available<br>
                            <em style="font-size: 12px; color: #a16207;">This ensures you order enough to cover existing orders AND maintain safety stock.</em>
                        </div>
                    </div>
            `;
            
            if (lowStock.length === 0) {
                html += '<p style="color: #10b981; font-weight: 600;"> All items adequately stocked!</p>';
            } else {
                html += `
                    <table class="action-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllLowStock" onclick="toggleSelectAllLowStock()"></th>
                                <th>SKU</th>
                                <th>Item</th>
                                <th>Supplier</th>
                                <th style="text-align: center;">On Hand</th>
                                <th style="text-align: center;">Backorder</th>
                                <th style="text-align: center;">Committed</th>
                                <th style="text-align: center;">Available</th>
                                <th style="text-align: center;">Reorder Pt</th>
                                <th style="text-align: center;">Gap</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                lowStock.forEach(item => {
                    const backorder = parseInt(item.Qty_On_Backorder) || 0;
                    html += `
                        <tr>
                            <td><input type="checkbox" class="lowstock-checkbox" data-item-id="${item.Item_ID}"></td>
                            <td>${item.SKU || 'N/A'}</td>
                            <td>${item.Item_Description}</td>
                            <td>${item.Supplier_Name}</td>
                            <td style="text-align: center;">${item.Qty}</td>
                            <td style="text-align: center; color: ${backorder > 0 ? '#dc2626' : '#666'}; font-weight: ${backorder > 0 ? '600' : 'normal'};">${backorder > 0 ? backorder : '-'}</td>
                            <td style="text-align: center; color: ${item.Committed > 0 ? '#dc2626' : '#666'};">${item.Committed > 0 ? '-' + item.Committed : '0'}</td>
                            <td style="text-align: center; font-weight: 600; color: ${item.Available < 0 ? '#dc2626' : '#059669'};">${item.Available}</td>
                            <td style="text-align: center;">${item.Reorder_Point}</td>
                            <td style="text-align: center; font-weight: 700; color: #f59e0b;">${Math.ceil(item.Units_Needed)}</td>
                            <td>
                                <button class="oval-action-btn oval-action-success" onclick="createPOForItem('${item.Item_ID}', ${Math.ceil(item.Units_Needed)})"> Order</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            html += '</div>';
            
            // 5. DEAD STOCK
            html += `
                <div class="action-section critical">
                    <div class="action-section-header">
                        <div class="action-section-title">
                             DEAD STOCK - NO SALES
                            <span class="action-count">${deadStock.length}</span>
                        </div>
                    </div>
                    <p style="color: #6b7280; font-size: 14px; margin: -10px 0 15px 0; padding: 0; line-height: 1.5;">
                        <strong>Items with no sales in 180+ days</strong> (or never sold). Has qty on hand but hasn't moved. Capital tied up in non-moving inventory. Top 10 shown.
                    </p>
            `;
            
            if (deadStock.length === 0) {
                html += '<p style="color: #10b981; font-weight: 600;"> No dead stock!</p>';
            } else {
                html += `
                    <div class="summary-box">
                        <div class="summary-item">
                            <span class="summary-label">Total Items:</span>
                            <span class="summary-value">${deadStock.length}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Total Units:</span>
                            <span class="summary-value">${deadStock.reduce((sum, i) => sum + i.Qty, 0).toFixed(0)}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Capital Tied Up:</span>
                            <span class="summary-value">${formatMoney(totalDeadStockValue)}</span>
                        </div>
                    </div>
                    <table class="action-table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Item</th>
                                <th>Supplier</th>
                                <th>On Hand</th>
                                <th>Last Sale</th>
                                <th>Value</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                deadStock.slice(0, 10).forEach(item => {
                    html += `
                        <tr>
                            <td>${item.SKU || 'N/A'}</td>
                            <td>${item.Item_Description}</td>
                            <td>${item.Supplier_Name}</td>
                            <td>${item.Qty}</td>
                            <td class="days-late">${item.Days_Since_Sale === 999 ? 'Never' : item.Days_Since_Sale + ' days ago'}</td>
                            <td>${formatMoney(item.Value)}</td>
                            <td>
                                <button class="oval-action-btn oval-action-warning" onclick="markForClearance('${item.Item_ID}')"> Clearance</button>
                            </td>
                        </tr>
                    `;
                });
                
                if (deadStock.length > 10) {
                    html += `<tr><td colspan="7" style="text-align: center; color: #666; padding: 15px;">... and ${deadStock.length - 10} more</td></tr>`;
                }
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            html += '</div>';
            
            // 6. SLOW MOVING
            html += `
                <div class="action-section info">
                    <div class="action-section-header">
                        <div class="action-section-title">
                             SLOW MOVING INVENTORY
                            <span class="action-count info">${slowMoving.length}</span>
                        </div>
                    </div>
                    <p style="color: #6b7280; font-size: 14px; margin: -10px 0 15px 0; padding: 0; line-height: 1.5;">
                        <strong>Items with sales 60-180 days ago</strong> - Moving, but slowly. Not dead yet, but approaching it. Consider promotions. Top 10 shown.
                    </p>
            `;
            
            if (slowMoving.length === 0) {
                html += '<p style="color: #10b981; font-weight: 600;"> No slow moving items!</p>';
            } else {
                html += `
                    <table class="action-table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Item</th>
                                <th>Supplier</th>
                                <th>On Hand</th>
                                <th>Last Sale</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                slowMoving.slice(0, 10).forEach(item => {
                    html += `
                        <tr>
                            <td>${item.SKU || 'N/A'}</td>
                            <td>${item.Item_Description}</td>
                            <td>${item.Supplier_Name}</td>
                            <td>${item.Qty}</td>
                            <td>${item.Days_Since_Sale} days ago</td>
                            <td>
                                <button class="oval-action-btn oval-action-info" onclick="alert('Promotion feature coming soon!')"> Promote</button>
                            </td>
                        </tr>
                    `;
                });
                
                if (slowMoving.length > 10) {
                    html += `<tr><td colspan="6" style="text-align: center; color: #666; padding: 15px;">... and ${slowMoving.length - 10} more</td></tr>`;
                }
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            html += '</div>';
            
            // 7. DORMANT CUSTOMERS
            html += `
                <div class="action-section info">
                    <div class="action-section-header">
                        <div class="action-section-title">
                             DORMANT CUSTOMERS
                            <span class="action-count info">${dormantCustomers.length}</span>
                        </div>
                        ${dormantCustomers.length > 0 ? '<button class="action-btn action-btn-primary" onclick="exportDormantCustomers()"> Export List</button>' : ''}
                    </div>
                    <p style="color: #6b7280; font-size: 14px; margin: -10px 0 15px 0; padding: 0; line-height: 1.5;">
                        <strong>Customers who haven't ordered in 45+ days</strong> - Previously active customers who have stopped buying. Sorted by highest lifetime sales (best customers first). Top 15 shown.
                    </p>
            `;
            
            if (dormantCustomers.length === 0) {
                html += '<p style="color: #10b981; font-weight: 600;"> All customers active!</p>';
            } else {
                html += `
                    <table class="action-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Last Order</th>
                                <th>Days Ago</th>
                                <th>Total Sales</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                dormantCustomers.slice(0, 15).forEach(c => {
                    const lastOrderStr = (c.Last_Order_Date.getMonth()+1) + '/' + c.Last_Order_Date.getDate() + '/' + c.Last_Order_Date.getFullYear();
                    html += `
                        <tr>
                            <td>${c.Customer_Name}</td>
                            <td>${lastOrderStr}</td>
                            <td>${c.Days_Since_Order} days</td>
                            <td>${formatMoney(c.Total_Sales)}</td>
                            <td>
                                <button class="oval-action-btn oval-action-info" onclick="scheduleCustomerVisit('${c.Customer_ID}')"> Visit</button>
                            </td>
                        </tr>
                    `;
                });
                
                if (dormantCustomers.length > 15) {
                    html += `<tr><td colspan="5" style="text-align: center; color: #666; padding: 15px;">... and ${dormantCustomers.length - 15} more</td></tr>`;
                }
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            html += '</div>';
            
            // Close the container wrapper
            html += '</div>'; // End action-dashboard-container
            
            return html;
        }
        
        // ========== CUSTOMER BACKORDERS REPORT ==========
        async function generateCustomerBackordersModal() {
            // Fetch all necessary data
            const [salesResult, itemsResult, customersResult, suppliersResult, poResult] = await Promise.all([
                apiCall('getSalesOrders'),
                apiCall('getItems'),
                apiCall('getCustomers'),
                apiCall('getSuppliers'),
                apiCall('getPurchaseOrders')
            ]);
            
            if (!salesResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const sales = salesResult.data.filter(s => s.Status !== 'Voided');
            const items = itemsResult.data;
            const customers = customersResult?.data || [];
            const suppliers = suppliersResult?.data || [];
            const purchases = (poResult?.data || []).filter(p => p.Status !== 'Voided' && p.Status !== 'Cancelled');
            
            // Build item lookup with supplier info
            const itemMap = {};
            items.forEach(item => {
                const supplier = suppliers.find(s => s.Supplier_ID === item.Supplier_ID);
                itemMap[item.Item_ID] = {
                    ...item,
                    supplierName: supplier?.Supplier_Name || 'Unknown',
                    qtyOnHand: parseInt(item.Qty_On_Hand) || 0,
                    qtyOnOrder: parseInt(item.Qty_On_Order) || 0,
                    qtyOnBackorder: parseInt(item.Qty_On_Backorder) || 0
                };
            });
            
            // Find pending sales orders (not yet fulfilled)
            const pendingSales = sales.filter(s => 
                s.Status === 'Pending' || s.Status === 'Ready' || s.Status === 'Out for Delivery'
            );
            
            // Track backorders by customer and by item
            const customerBackorders = {}; // customerId -> { customerName, orders: [{ soId, invoiceNum, items: [...] }] }
            const itemBackorders = {}; // itemId -> { item info, customers: [{ customerId, customerName, qty, soId }], totalNeeded }
            
            // Fetch line items for each pending order
            for (const so of pendingSales) {
                try {
                    const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                    if (!linesResult?.data) continue;
                    
                    const customer = customers.find(c => c.Customer_ID === so.Customer_ID);
                    const customerName = customer?.Customer_Name || 'Unknown';
                    
                    for (const line of linesResult.data) {
                        const item = itemMap[line.Item_ID];
                        if (!item) continue;
                        
                        const qty = parseInt(line.Quantity) || 0;
                        const qtyOnHand = item.qtyOnHand;
                        
                        // Check if this item is on backorder (insufficient stock)
                        if (qtyOnHand < 0 || item.qtyOnBackorder > 0) {
                            // Add to customer backorders
                            if (!customerBackorders[so.Customer_ID]) {
                                customerBackorders[so.Customer_ID] = {
                                    customerName: customerName,
                                    customerId: so.Customer_ID,
                                    orders: []
                                };
                            }
                            
                            // Find or create order entry
                            let orderEntry = customerBackorders[so.Customer_ID].orders.find(o => o.soId === so.SO_ID);
                            if (!orderEntry) {
                                orderEntry = {
                                    soId: so.SO_ID,
                                    invoiceNum: so.Invoice_Number || so.SO_ID,
                                    soDate: so.Sale_Date || so.SO_Date,
                                    items: []
                                };
                                customerBackorders[so.Customer_ID].orders.push(orderEntry);
                            }
                            
                            orderEntry.items.push({
                                itemId: line.Item_ID,
                                itemDesc: item.Item_Description,
                                sku: item.SKU,
                                supplierName: item.supplierName,
                                supplierId: item.Supplier_ID,
                                qtyOrdered: qty,
                                qtyOnHand: qtyOnHand,
                                qtyOnOrder: item.qtyOnOrder,
                                qtyOnBackorder: item.qtyOnBackorder
                            });
                            
                            // Add to item backorders
                            if (!itemBackorders[line.Item_ID]) {
                                itemBackorders[line.Item_ID] = {
                                    itemId: line.Item_ID,
                                    itemDesc: item.Item_Description,
                                    sku: item.SKU,
                                    supplierName: item.supplierName,
                                    supplierId: item.Supplier_ID,
                                    qtyOnHand: qtyOnHand,
                                    qtyOnOrder: item.qtyOnOrder,
                                    qtyOnBackorder: item.qtyOnBackorder,
                                    customers: [],
                                    totalNeeded: 0
                                };
                            }
                            
                            itemBackorders[line.Item_ID].customers.push({
                                customerId: so.Customer_ID,
                                customerName: customerName,
                                qty: qty,
                                soId: so.SO_ID,
                                invoiceNum: so.Invoice_Number || so.SO_ID
                            });
                            itemBackorders[line.Item_ID].totalNeeded += qty;
                        }
                    }
                } catch(e) {
                    console.warn('Error fetching lines for SO:', so.SO_ID, e);
                }
            }
            
            // Calculate totals
            const totalCustomersAffected = Object.keys(customerBackorders).length;
            const totalItemsOnBackorder = Object.keys(itemBackorders).length;
            const totalUnitsNeeded = Object.values(itemBackorders).reduce((sum, i) => sum + i.totalNeeded, 0);
            
            // Build HTML
            let html = `
                <style>
                    .backorder-container {
                        max-width: 100%;
                    }
                    .backorder-header {
                        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
                        color: white;
                        padding: 25px;
                        border-radius: 12px;
                        margin-bottom: 20px;
                        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
                    }
                    .backorder-header h2 {
                        margin: 0 0 8px 0;
                        font-size: 24px;
                    }
                    .backorder-header p {
                        margin: 0;
                        opacity: 0.9;
                    }
                    .backorder-kpi-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                        gap: 12px;
                        margin-bottom: 20px;
                    }
                    .backorder-kpi {
                        background: white;
                        border-radius: 10px;
                        padding: 15px;
                        text-align: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    }
                    .backorder-kpi .value {
                        font-size: 28px;
                        font-weight: 700;
                    }
                    .backorder-kpi .label {
                        font-size: 12px;
                        color: #666;
                        text-transform: uppercase;
                        margin-top: 5px;
                    }
                    .backorder-section {
                        background: white;
                        border-radius: 12px;
                        margin-bottom: 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        overflow: hidden;
                    }
                    .backorder-section-header {
                        background: #f8fafc;
                        padding: 15px 20px;
                        border-bottom: 1px solid #e2e8f0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-wrap: wrap;
                        gap: 10px;
                    }
                    .backorder-section-title {
                        font-weight: 700;
                        font-size: 16px;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    .backorder-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 13px;
                    }
                    .backorder-table th {
                        background: #f1f5f9;
                        padding: 10px 12px;
                        text-align: left;
                        font-weight: 600;
                        color: #475569;
                        border-bottom: 1px solid #e2e8f0;
                    }
                    .backorder-table td {
                        padding: 10px 12px;
                        border-bottom: 1px solid #f1f5f9;
                    }
                    .backorder-table tr:hover {
                        background: #f8fafc;
                    }
                    .customer-card {
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        margin: 15px;
                        overflow: hidden;
                    }
                    .customer-card-header {
                        background: #f0f9ff;
                        padding: 12px 15px;
                        border-bottom: 1px solid #e2e8f0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .customer-name {
                        font-weight: 700;
                        color: #0369a1;
                    }
                    .order-badge {
                        background: #0891b2;
                        color: white;
                        padding: 4px 10px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: 600;
                    }
                    .item-summary-card {
                        background: #fffbeb;
                        border: 2px solid #fbbf24;
                        border-radius: 10px;
                        padding: 15px;
                        margin: 15px;
                    }
                    .item-summary-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        margin-bottom: 12px;
                    }
                    .item-summary-title {
                        font-weight: 700;
                        color: #92400e;
                    }
                    .item-summary-stats {
                        display: flex;
                        gap: 15px;
                        flex-wrap: wrap;
                        margin-bottom: 12px;
                        font-size: 13px;
                    }
                    .item-stat {
                        display: flex;
                        flex-direction: column;
                    }
                    .item-stat-label {
                        font-size: 10px;
                        color: #666;
                        text-transform: uppercase;
                    }
                    .item-stat-value {
                        font-weight: 700;
                        font-size: 16px;
                    }
                    .create-po-btn {
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 6px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 13px;
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                    }
                    .create-po-btn:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
                    }
                    .create-po-btn:disabled {
                        background: #9ca3af;
                        cursor: not-allowed;
                        transform: none;
                        box-shadow: none;
                    }
                    .qty-input {
                        width: 70px;
                        padding: 6px 8px;
                        border: 2px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                        text-align: center;
                    }
                    .qty-input:focus {
                        border-color: #10b981;
                        outline: none;
                    }
                    
                    @media (max-width: 768px) {
                        .backorder-table {
                            font-size: 11px;
                        }
                        .backorder-table th,
                        .backorder-table td {
                            padding: 8px 6px;
                        }
                        .item-summary-stats {
                            gap: 10px;
                        }
                    }
                </style>
                
                <div class="backorder-container">
                    <div class="backorder-header">
                        <h2> Customer Backorders</h2>
                        <p>Items on backorder for pending customer orders  Create POs to fulfill</p>
                    </div>
                    
                    <div class="backorder-kpi-grid">
                        <div class="backorder-kpi" style="border-top: 4px solid #f59e0b;">
                            <div class="value" style="color: #f59e0b;">${totalCustomersAffected}</div>
                            <div class="label">Customers Waiting</div>
                        </div>
                        <div class="backorder-kpi" style="border-top: 4px solid #dc2626;">
                            <div class="value" style="color: #dc2626;">${totalItemsOnBackorder}</div>
                            <div class="label">Items on Backorder</div>
                        </div>
                        <div class="backorder-kpi" style="border-top: 4px solid #7c3aed;">
                            <div class="value" style="color: #7c3aed;">${totalUnitsNeeded}</div>
                            <div class="label">Total Units Needed</div>
                        </div>
                    </div>
            `;
            
            if (totalItemsOnBackorder === 0) {
                html += `
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 15px;"></div>
                        <h3 style="margin: 0; color: #10b981;">No Backorders!</h3>
                        <p style="color: #666;">All customer orders can be fulfilled with current inventory.</p>
                    </div>
                `;
            } else {
                // SECTION 1: CONSOLIDATED VIEW BY ITEM
                html += `
                    <div class="backorder-section">
                        <div class="backorder-section-header">
                            <div class="backorder-section-title">
                                 Consolidated by Product
                                <span style="background: #f59e0b; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">${totalItemsOnBackorder} items</span>
                            </div>
                            <div style="font-size: 12px; color: #666;">Create POs for backorder quantities only (not up to reorder point)</div>
                        </div>
                        <div style="padding: 0;">
                `;
                
                // Sort items by total units needed (from actual orders)
                const sortedItems = Object.values(itemBackorders).sort((a, b) => b.totalNeeded - a.totalNeeded);
                
                for (const item of sortedItems) {
                    // Use totalNeeded (sum of actual order quantities) instead of qtyOnBackorder
                    const unitsNeeded = item.totalNeeded;
                    const netNeeded = Math.max(0, unitsNeeded - item.qtyOnOrder);
                    const alreadyCovered = Math.min(item.qtyOnOrder, unitsNeeded);
                    
                    html += `
                        <div class="item-summary-card">
                            <div class="item-summary-header">
                                <div>
                                    <div class="item-summary-title">${item.itemDesc}</div>
                                    <div style="font-size: 12px; color: #666;">SKU: ${item.sku}  ${item.supplierName}</div>
                                </div>
                            </div>
                            <div class="item-summary-stats">
                                <div class="item-stat">
                                    <span class="item-stat-label">On Hand</span>
                                    <span class="item-stat-value" style="color: ${item.qtyOnHand < 0 ? '#dc2626' : '#333'};">${item.qtyOnHand}</span>
                                </div>
                                <div class="item-stat">
                                    <span class="item-stat-label">Units Ordered</span>
                                    <span class="item-stat-value" style="color: #dc2626;">${unitsNeeded}</span>
                                </div>
                                <div class="item-stat">
                                    <span class="item-stat-label">Already On Order</span>
                                    <span class="item-stat-value" style="color: ${item.qtyOnOrder > 0 ? '#f59e0b' : '#666'};">${item.qtyOnOrder}</span>
                                </div>
                                <div class="item-stat">
                                    <span class="item-stat-label">Still Need</span>
                                    <span class="item-stat-value" style="color: ${netNeeded > 0 ? '#dc2626' : '#10b981'}; font-weight: 800;">${netNeeded}</span>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 12px; font-size: 13px; color: #666;">
                                <strong>Customers waiting:</strong> 
                                ${item.customers.map(c => `${c.customerName} (${c.qty} units - ${c.invoiceNum})`).join(', ')}
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                ${netNeeded > 0 ? `
                                    <label style="font-size: 13px; color: #333;">Order Qty:</label>
                                    <input type="number" class="qty-input" id="backorderQty_${item.itemId}" value="${netNeeded}" min="1" max="${netNeeded + 100}">
                                    <button class="create-po-btn" onclick="createBackorderPO('${item.itemId}', '${item.supplierId}')">
                                         Create PO
                                    </button>
                                    <span style="font-size: 11px; color: #666;">(Just enough to fulfill backorders)</span>
                                ` : `
                                    <span style="color: #10b981; font-weight: 600;"> Covered by existing PO</span>
                                    <span style="font-size: 11px; color: #666;">(${alreadyCovered} on order)</span>
                                `}
                            </div>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                // SECTION 2: BY CUSTOMER VIEW
                html += `
                    <div class="backorder-section">
                        <div class="backorder-section-header">
                            <div class="backorder-section-title">
                                 By Customer
                                <span style="background: #0891b2; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">${totalCustomersAffected} customers</span>
                            </div>
                        </div>
                `;
                
                // Sort customers by name
                const sortedCustomers = Object.values(customerBackorders).sort((a, b) => a.customerName.localeCompare(b.customerName));
                
                for (const customer of sortedCustomers) {
                    html += `
                        <div class="customer-card">
                            <div class="customer-card-header">
                                <span class="customer-name"> ${customer.customerName}</span>
                                <span class="order-badge">${customer.orders.length} order${customer.orders.length > 1 ? 's' : ''} affected</span>
                            </div>
                            <table class="backorder-table">
                                <thead>
                                    <tr>
                                        <th>Order #</th>
                                        <th>Item</th>
                                        <th>SKU</th>
                                        <th>Qty Ordered</th>
                                        <th>On Hand</th>
                                        <th>On Order</th>
                                        <th>Short</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    for (const order of customer.orders) {
                        for (const item of order.items) {
                            const shortQty = Math.max(0, item.qtyOrdered - Math.max(0, item.qtyOnHand));
                            html += `
                                <tr>
                                    <td><a href="#" onclick="viewSalesOrder('${order.soId}'); return false;" style="color: #0891b2; text-decoration: none;">${order.invoiceNum}</a></td>
                                    <td>${item.itemDesc}</td>
                                    <td style="font-family: monospace; font-size: 11px;">${item.sku}</td>
                                    <td style="text-align: center;">${item.qtyOrdered}</td>
                                    <td style="text-align: center; color: ${item.qtyOnHand < 0 ? '#dc2626' : '#333'};">${item.qtyOnHand}</td>
                                    <td style="text-align: center; color: ${item.qtyOnOrder > 0 ? '#f59e0b' : '#666'};">${item.qtyOnOrder}</td>
                                    <td style="text-align: center; color: #dc2626; font-weight: 600;">${shortQty > 0 ? shortQty : '-'}</td>
                                </tr>
                            `;
                        }
                    }
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                html += `
                    </div>
                `;
            }
            
            html += '</div>'; // End backorder-container
            
            return html;
        }
        
        // Create PO for backorder item - navigates to Create PO tab with pre-filled data
        function createBackorderPO(itemId, supplierId) {
            const qtyInput = document.getElementById(`backorderQty_${itemId}`);
            const unitsNeeded = parseInt(qtyInput?.value) || 0;
            
            if (unitsNeeded <= 0) {
                alert('Please enter a quantity greater than 0');
                return;
            }
            
            // Get item details
            const item = (cachedItems || []).find(i => i.Item_ID === itemId);
            if (!item) {
                alert('Item not found. Please refresh and try again.');
                return;
            }
            
            const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === supplierId);
            const supplierName = supplier?.Supplier_Name || 'Unknown';
            
            if (!confirm(`Create PO for ${unitsNeeded} units of:\n\n${item.Item_Description}\n\nFrom: ${supplierName}\n\nThis is for backorder fulfillment only.`)) {
                return;
            }
            
            // Close the report modal
            closeReportSetup();
            
            // Skip clearing since we're pre-filling
            window.skipCreatePOClear = true;
            
            // Switch to CREATE PO tab
            switchTab('createpo');
            
            setTimeout(() => {
                // Set supplier
                const supplierSelect = document.getElementById('createPOSupplier');
                if (supplierSelect) {
                    supplierSelect.value = supplierId;
                    filterItemsBySupplier();
                }
                
                // Set today's date
                const today = getTodayLocalDate();
                document.getElementById('createPODate').value = today;
                document.getElementById('createPOExpectedDate').value = '';
                
                // Set notes
                const notesField = document.getElementById('createPONotes');
                if (notesField) {
                    notesField.value = 'Backorder fulfillment - Created from Customer Backorders report';
                }
                
                // Clear existing line items
                const container = document.getElementById('createPOLineItems');
                container.innerHTML = '';
                
                // Calculate cases needed
                const cost = parseFloat(item.Package_Cost) || 0;
                const units = parseInt(item.Units_Per_Package) || 1;
                const casesNeeded = Math.ceil(unitsNeeded / units);
                
                const newRow = document.createElement('div');
                newRow.className = 'line-item-row';
                newRow.style.cssText = 'display: grid; grid-template-columns: 2.5fr 1fr 0.6fr 0.8fr 0.8fr 0.8fr 50px; gap: 8px; margin-bottom: 10px; align-items: end;';
                
                newRow.innerHTML = `
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                        <select class="createpo-item" style="width: 100%; padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white;" onchange="updateCreatePOItemCost(this)">
                            <option value="${item.Item_ID}" data-cost="${cost}" data-units="${units}" selected>${item.SKU || item.Item_ID} - ${item.Item_Description}</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Cases</label>
                        <input type="number" class="createpo-qty" value="${casesNeeded > 0 ? casesNeeded : ''}" placeholder="Qty" min="1" oninput="calculateCreatePOTotal()" style="width: 100%; padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px;">
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-units" style="text-align: center; font-size: 14px; color: #666; padding: 6px;">${units}</div>
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-totalunits" style="text-align: center; font-size: 16px; font-weight: bold; color: var(--primary, #667eea); padding: 6px;">${casesNeeded > 0 ? casesNeeded * units : '-'}</div>
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-cost" style="text-align: center; font-size: 14px; font-weight: bold; color: #28a745; background: #e8f5e9; padding: 10px; border-radius: 6px;">$${cost.toFixed(2)}</div>
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-linetotal" style="text-align: right; font-size: 14px; font-weight: bold; color: var(--primary, #667eea); background: var(--primary-light, #E3F2FD); padding: 10px; border-radius: 6px;">${casesNeeded > 0 ? '$' + (casesNeeded * cost).toFixed(2) : '$0.00'}</div>
                    </div>
                    <button type="button" class="btn-danger" onclick="removeLineItem(this); calculateCreatePOTotal();" style="width: 100%; padding: 10px; font-size: 14px; margin-top: 26px;"></button>
                `;
                
                container.appendChild(newRow);
                
                // Calculate total
                calculateCreatePOTotal();
                
            }, 300);
        }
        
        // Helper functions for Action Dashboard
        function toggleSelectAllLowStock() {
            const checkboxes = document.querySelectorAll('.lowstock-checkbox');
            const selectAll = document.getElementById('selectAllLowStock');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }
        
        function bulkReorder() {
            const checkboxes = document.querySelectorAll('.lowstock-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Please select items to reorder first.\n\nUse the checkboxes next to each item, or "Select All" at the top.');
                return;
            }
            
            const itemIds = Array.from(checkboxes).map(cb => cb.dataset.itemId);
            
            // Get item details and check suppliers
            const items = itemIds.map(id => (cachedItems || []).find(i => i.Item_ID === id)).filter(Boolean);
            
            if (items.length === 0) {
                alert('Could not find selected items. Please refresh and try again.');
                return;
            }
            
            // Check if all items are from the same supplier
            const suppliers = [...new Set(items.map(i => i.Supplier_ID))];
            
            if (suppliers.length > 1) {
                // Multiple suppliers - show error
                const supplierNames = suppliers.map(supId => {
                    const sup = (cachedSuppliers || []).find(s => s.Supplier_ID === supId);
                    const itemCount = items.filter(i => i.Supplier_ID === supId).length;
                    return ` ${sup?.Supplier_Name || 'Unknown'}: ${itemCount} item${itemCount > 1 ? 's' : ''}`;
                }).join('\n');
                
                alert(` Cannot create a single PO with items from multiple suppliers!\n\nYou selected items from ${suppliers.length} different suppliers:\n\n${supplierNames}\n\nPurchase orders can only contain items from ONE supplier.\n\nPlease select items from a single supplier, or create separate POs for each supplier.`);
                return;
            }
            
            // All items are from the same supplier - proceed!
            const supplierId = suppliers[0];
            const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === supplierId);
            
            // Close the report modal
            closeReportSetup();
            
            // Skip clearing since we're pre-filling
            window.skipCreatePOClear = true;
            
            // Switch to CREATE PO tab
            switchTab('createpo');
            
            setTimeout(() => {
                // Set supplier
                const supplierSelect = document.getElementById('createPOSupplier');
                if (supplierSelect) {
                    supplierSelect.value = supplierId;
                    
                    // Trigger change to populate items dropdown
                    filterItemsBySupplier();
                }
                
                // Set today's date
                const today = getTodayLocalDate();
                document.getElementById('createPODate').value = today;
                document.getElementById('createPOExpectedDate').value = ''; // User must select
                
                // Clear existing line items
                const container = document.getElementById('createPOLineItems');
                container.innerHTML = '';
                
                // Add a row for each selected item
                items.forEach(item => {
                    const cost = parseFloat(item.Package_Cost) || 0;
                    const units = parseInt(item.Units_Per_Package) || 1;
                    const qtyNeeded = Math.max(0, (parseInt(item.Reorder_Point) || 0) - (parseInt(item.Qty_On_Hand) || 0));
                    const casesNeeded = Math.ceil(qtyNeeded / units);
                    
                    const newRow = document.createElement('div');
                    newRow.className = 'line-item-row';
                    newRow.style.cssText = 'display: grid; grid-template-columns: 2.5fr 1fr 0.6fr 0.8fr 0.8fr 0.8fr 50px; gap: 8px; margin-bottom: 10px; align-items: end;';
                    
                    newRow.innerHTML = `
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                            <select class="createpo-item" style="width: 100%; padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white;" onchange="updateCreatePOItemCost(this)">
                                <option value="${item.Item_ID}" data-cost="${cost}" data-units="${units}" selected>${item.SKU || item.Item_ID} - ${item.Item_Description}</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Cases</label>
                            <input type="number" class="createpo-qty" value="${casesNeeded > 0 ? casesNeeded : ''}" placeholder="Qty" min="1" oninput="calculateCreatePOTotal()" style="width: 100%; padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px;">
                        </div>
                        <div style="margin-top: 26px;">
                            <div class="createpo-units" style="text-align: center; font-size: 14px; color: #666; padding: 6px;">${units}</div>
                        </div>
                        <div style="margin-top: 26px;">
                            <div class="createpo-totalunits" style="text-align: center; font-size: 16px; font-weight: bold; color: var(--primary, #667eea); padding: 6px;">${casesNeeded > 0 ? casesNeeded * units : '-'}</div>
                        </div>
                        <div style="margin-top: 26px;">
                            <div class="createpo-cost" style="text-align: center; font-size: 14px; font-weight: bold; color: #28a745; background: #e8f5e9; padding: 10px; border-radius: 6px;">$${cost.toFixed(2)}</div>
                        </div>
                        <div style="margin-top: 26px;">
                            <div class="createpo-linetotal" style="text-align: right; font-size: 14px; font-weight: bold; color: var(--primary, #667eea); background: var(--primary-light, #E3F2FD); padding: 10px; border-radius: 6px;">${casesNeeded > 0 ? '$' + (casesNeeded * cost).toFixed(2) : '$0.00'}</div>
                        </div>
                        <button type="button" class="btn-danger" onclick="removeLineItem(this); calculateCreatePOTotal();" style="width: 100%; padding: 10px; font-size: 14px; margin-top: 26px;"></button>
                    `;
                    
                    container.appendChild(newRow);
                });
                
                // Calculate total
                calculateCreatePOTotal();
                
                alert(` Created PO with ${items.length} item${items.length > 1 ? 's' : ''} from ${supplier?.Supplier_Name || 'supplier'}!\n\nSuggested quantities are pre-filled based on reorder points.\n\nReview quantities and click "Save PO" when ready.`);
                
            }, 300);
        }
        
        function createPOForItem(itemId, unitsNeeded) {
            // Get item details
            const item = (cachedItems || []).find(i => i.Item_ID === itemId);
            if (!item) {
                alert('Item not found. Please refresh and try again.');
                return;
            }
            
            const supplierId = item.Supplier_ID;
            const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === supplierId);
            
            // Close the report modal
            closeReportSetup();
            
            // Skip clearing since we're pre-filling
            window.skipCreatePOClear = true;
            
            // Switch to CREATE PO tab
            switchTab('createpo');
            
            setTimeout(() => {
                // Set supplier
                const supplierSelect = document.getElementById('createPOSupplier');
                if (supplierSelect) {
                    supplierSelect.value = supplierId;
                    filterItemsBySupplier();
                }
                
                // Set today's date
                const today = getTodayLocalDate();
                document.getElementById('createPODate').value = today;
                document.getElementById('createPOExpectedDate').value = ''; // User must select
                
                // Clear existing line items
                const container = document.getElementById('createPOLineItems');
                container.innerHTML = '';
                
                // Use passed unitsNeeded if provided, otherwise calculate simple gap
                const cost = parseFloat(item.Package_Cost) || 0;
                const units = parseInt(item.Units_Per_Package) || 1;
                const qtyNeeded = unitsNeeded !== undefined ? unitsNeeded : Math.max(0, (parseInt(item.Reorder_Point) || 0) - (parseInt(item.Qty_On_Hand) || 0));
                const casesNeeded = Math.ceil(qtyNeeded / units);
                
                const newRow = document.createElement('div');
                newRow.className = 'line-item-row';
                newRow.style.cssText = 'display: grid; grid-template-columns: 2.5fr 1fr 0.6fr 0.8fr 0.8fr 0.8fr 50px; gap: 8px; margin-bottom: 10px; align-items: end;';
                
                newRow.innerHTML = `
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                        <select class="createpo-item" style="width: 100%; padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white;" onchange="updateCreatePOItemCost(this)">
                            <option value="${item.Item_ID}" data-cost="${cost}" data-units="${units}" selected>${item.SKU || item.Item_ID} - ${item.Item_Description}</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Cases</label>
                        <input type="number" class="createpo-qty" value="${casesNeeded > 0 ? casesNeeded : ''}" placeholder="Qty" min="1" oninput="calculateCreatePOTotal()" style="width: 100%; padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px;">
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-units" style="text-align: center; font-size: 14px; color: #666; padding: 6px;">${units}</div>
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-totalunits" style="text-align: center; font-size: 16px; font-weight: bold; color: var(--primary, #667eea); padding: 6px;">${casesNeeded > 0 ? casesNeeded * units : '-'}</div>
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-cost" style="text-align: center; font-size: 14px; font-weight: bold; color: #28a745; background: #e8f5e9; padding: 10px; border-radius: 6px;">$${cost.toFixed(2)}</div>
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-linetotal" style="text-align: right; font-size: 14px; font-weight: bold; color: var(--primary, #667eea); background: var(--primary-light, #E3F2FD); padding: 10px; border-radius: 6px;">${casesNeeded > 0 ? '$' + (casesNeeded * cost).toFixed(2) : '$0.00'}</div>
                    </div>
                    <button type="button" class="btn-danger" onclick="removeLineItem(this); calculateCreatePOTotal();" style="width: 100%; padding: 10px; font-size: 14px; margin-top: 26px;"></button>
                `;
                
                container.appendChild(newRow);
                
                // Calculate total
                calculateCreatePOTotal();
                
                // Focus quantity field
                const qtyInput = container.querySelector('.createpo-qty');
                if (qtyInput && !qtyInput.value) {
                    qtyInput.focus();
                }
                
            }, 300);
        }
        
        async function createInventoryAdjustment(itemId) {
            // Get item details
            const item = (cachedItems || []).find(i => i.Item_ID === itemId);
            if (!item) {
                alert('Item not found. Please refresh and try again.');
                return;
            }
            
            // Store that we should return to Action Dashboard when done
            returnToReport = 'action-dashboard';
            
            // Close the report modal
            closeReportSetup();
            
            // Switch to inventory tab
            switchTab('inventory');
            
            setTimeout(async () => {
                // Show the adjustment form
                await showAdjustInventoryForm();
                
                setTimeout(() => {
                    // Pre-populate the item
                    document.getElementById('adjustItem').value = item.Item_ID;
                    document.getElementById('adjustItemDisplay').value = `${item.SKU || item.Item_ID} - ${item.Item_Description}`;
                    document.getElementById('adjustCurrentQty').value = parseInt(item.Qty_On_Hand) || 0;
                    
                    // Focus on the new quantity or adjustment amount field
                    const adjustQtyInput = document.getElementById('adjustQuantity');
                    if (adjustQtyInput) {
                        adjustQtyInput.focus();
                    }
                    
                    // Show helpful message for negative inventory
                    if (parseInt(item.Qty_On_Hand) < 0) {
                        showStatus('inventoryStatus', ` ${item.SKU} has ${item.Qty_On_Hand} units. Enter adjustment to fix.`, 'warning');
                    }
                }, 300);
            }, 300);
        }
        
        function viewSaleOrder(saleId) {
            showSection('sales');
            // TODO: Open sale order modal
        }
        
        function markForClearance(itemId) {
            if (confirm('Mark this item for clearance sale?')) {
                alert('Clearance feature coming soon!');
                // TODO: Implement clearance modal
            }
        }
        
        function scheduleCustomerVisit(customerId) {
            alert('Schedule Visit feature coming soon!');
            // TODO: Implement visit scheduling
        }
        
        function exportDormantCustomers() {
            alert('Export feature coming soon!');
            // TODO: Implement CSV export
        }
        
        // Create a new sales order for a customer (from Dormant Customers report)
        function createSalesOrderForCustomer(customerId) {
            // Close the report modal
            closeReportSetup();
            
            // Switch to CREATE SO tab
            switchTab('createso');
            
            setTimeout(() => {
                // Set customer in the picker
                const customer = (cachedCustomers || []).find(c => c.Customer_ID === customerId);
                if (customer) {
                    const displayInput = document.getElementById('createSOCustomerDisplay');
                    const hiddenInput = document.getElementById('createSOCustomer');
                    if (displayInput && hiddenInput) {
                        displayInput.value = customer.Customer_Name || customer.Customer_ID;
                        hiddenInput.value = customerId;
                    }
                }
                
                // Set today's date
                const today = getTodayLocalDate();
                const dateInput = document.getElementById('createSODate');
                if (dateInput) dateInput.value = today;
                
                // Clear existing line items
                const container = document.getElementById('createSOLineItems');
                if (container) container.innerHTML = '';
                
                // Add an empty line item row
                if (typeof addSOLineItem === 'function') {
                    addSOLineItem();
                }
                
                // Show confirmation
                if (customer) {
                    showStatus('soStatus', ` Creating order for ${customer.Customer_Name}. Add items below!`, 'success');
                }
            }, 300);
        }
        
        // ==================== DAILY DASHBOARD ====================
        
        async function generateDailyDashboardModal() {
            // Default to ALL TIME if no dates specified (not just today)
            let fromDate, toDate;
            
            if (reportFilters.fromDate) {
                fromDate = parseLocalDate(reportFilters.fromDate);
                fromDate.setHours(0, 0, 0, 0);
            } else {
                // Default: beginning of time (Jan 1, 2020)
                fromDate = new Date(2020, 0, 1, 0, 0, 0, 0);
            }
            
            if (reportFilters.toDate) {
                toDate = parseLocalDate(reportFilters.toDate);
                toDate.setHours(23, 59, 59, 999);
            } else {
                // Default: end of today
                toDate = new Date();
                toDate.setHours(23, 59, 59, 999);
            }
            
            // Fetch all data
            const [salesResult, itemsResult, customersResult] = await Promise.all([
                apiCall('getSalesOrders'),
                apiCall('getItems'),
                apiCall('getCustomers')
            ]);
            
            if (!salesResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const customers = customersResult?.data || [];
            
            // Filter sales by date range
            let salesInPeriod = salesResult.data.filter(s => {
                const saleDate = parseDate(s.Sale_Date || s.SO_Date);
                return saleDate && saleDate >= fromDate && saleDate <= toDate;
            });
            
            // Filter by customer if selected
            if (reportFilters.customer) {
                salesInPeriod = salesInPeriod.filter(s => matchesFilter(s.Customer_ID, reportFilters.customer));
            }
            
            // Calculate metrics
            let totalQtySold = 0;
            let totalSales = 0;
            let totalCost = 0;
            let orderCount = salesInPeriod.length;
            
            // Get line items for each sale
            const productSales = {};
            const customerSales = {};
            
            for (const so of salesInPeriod) {
                const soTotal = parseFloat(so.Total_Amount) || 0;
                totalSales += soTotal;
                
                // Track customer sales
                const custId = so.Customer_ID;
                if (!customerSales[custId]) {
                    customerSales[custId] = { 
                        name: getCustomerName(custId), 
                        sales: 0, 
                        orders: 0 
                    };
                }
                customerSales[custId].sales += soTotal;
                customerSales[custId].orders++;
                
                // Get line items
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const qty = parseInt(line.Quantity) || 0;
                        totalQtySold += qty;
                        
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const unitsPerPkg = parseFloat(item?.Units_Per_Package) || 1;
                        const pkgCost = parseFloat(item?.Package_Cost) || 0;
                        const unitCost = pkgCost / unitsPerPkg;
                        totalCost += qty * unitCost;
                        
                        // Calculate line total (Line_Total may not exist in data)
                        const unitPrice = parseFloat(line.Unit_Price) || 0;
                        const lineTotal = qty * unitPrice;
                        
                        // Track product sales
                        const itemId = line.Item_ID;
                        if (!productSales[itemId]) {
                            productSales[itemId] = {
                                name: item?.Item_Description || itemId,
                                sku: item?.SKU || '-',
                                qty: 0,
                                sales: 0
                            };
                        }
                        productSales[itemId].qty += qty;
                        productSales[itemId].sales += lineTotal;
                    });
                }
            }
            
            const profit = totalSales - totalCost;
            const grossMargin = totalSales > 0 ? (profit / totalSales * 100) : 0;
            const avgOrderValue = orderCount > 0 ? (totalSales / orderCount) : 0;
            const avgUnitPrice = totalQtySold > 0 ? (totalSales / totalQtySold) : 0;
            const avgUnitCost = totalQtySold > 0 ? (totalCost / totalQtySold) : 0;
            
            // Sort top performers
            const topCustomers = Object.values(customerSales).sort((a, b) => b.sales - a.sales).slice(0, 5);
            const topProducts = Object.values(productSales).sort((a, b) => b.sales - a.sales).slice(0, 5);
            
            // Date range label - show "All Time" if no specific dates were selected
            let dateLabel;
            if (!reportFilters.fromDate && !reportFilters.toDate) {
                dateLabel = 'All Time';
            } else {
                const fromStr = fromDate.toLocaleDateString();
                const toStr = toDate.toLocaleDateString();
                dateLabel = fromStr === toStr ? fromStr : `${fromStr} - ${toStr}`;
            }
            
            // Build dashboard HTML with card styling
            let html = `
                <style>
                    .dash-header {
                        padding: 35px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border-radius: 16px;
                        margin-bottom: 30px;
                        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3), 0 4px 12px rgba(0,0,0,0.1);
                        border: 2px solid rgba(255, 255, 255, 0.1);
                    }
                    .dash-header h2 {
                        margin: 0 0 10px 0;
                        font-size: 32px;
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    }
                    .dash-header p {
                        margin: 0;
                        font-size: 16px;
                        opacity: 0.95;
                    }
                    .dash-card-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    .dash-card {
                        background: white;
                        border-radius: 12px;
                        padding: 15px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        border-left: 4px solid #667eea;
                        transition: transform 0.2s, box-shadow 0.2s;
                    }
                    .dash-card:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 15px rgba(0,0,0,0.12);
                    }
                    .dash-card-label {
                        font-size: 11px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        margin-bottom: 8px;
                    }
                    .dash-card-value {
                        font-size: 28px;
                        font-weight: bold;
                        color: #333;
                        line-height: 1.1;
                    }
                    .dash-card-sub {
                        font-size: 12px;
                        color: #888;
                        margin-top: 5px;
                    }
                    .dash-section {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    }
                    .dash-section h4 {
                        margin: 0 0 15px 0;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    .top-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 10px 0;
                        border-bottom: 1px solid #f0f0f0;
                    }
                    .top-item:last-child { border-bottom: none; }
                    .top-item-rank {
                        width: 28px;
                        height: 28px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 12px;
                        margin-right: 12px;
                    }
                    .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: white; }
                    .rank-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); color: white; }
                    .rank-3 { background: linear-gradient(135deg, #CD7F32, #8B4513); color: white; }
                    .rank-other { background: #f0f0f0; color: #666; }
                </style>
                
                <div class="dash-header">
                    <h2> Sales Dashboard</h2>
                    <p>${dateLabel}${reportFilters.customer ? '  ' + getCustomerName(reportFilters.customer) : ''}</p>
                </div>
                
                <!-- Main KPI Cards -->
                <div class="dash-card-grid">
                    <div class="dash-card" style="border-color: #2196F3;">
                        <div class="dash-card-label" style="color: #2196F3;"> QTY SOLD</div>
                        <div class="dash-card-value">${totalQtySold.toLocaleString()}</div>
                        <div class="dash-card-sub">units</div>
                    </div>
                    
                    <div class="dash-card" style="border-color: #9C27B0;">
                        <div class="dash-card-label" style="color: #9C27B0;"> ORDERS</div>
                        <div class="dash-card-value">${orderCount}</div>
                        <div class="dash-card-sub">sales orders</div>
                    </div>
                    
                    <div class="dash-card" style="border-color: #4CAF50;">
                        <div class="dash-card-label" style="color: #4CAF50;"> SALES</div>
                        <div class="dash-card-value">${formatMoney(totalSales)}</div>
                        <div class="dash-card-sub">total revenue</div>
                    </div>
                    
                    <div class="dash-card" style="border-color: #FF9800;">
                        <div class="dash-card-label" style="color: #FF9800;"> COST</div>
                        <div class="dash-card-value">$${totalCost.toFixed(0)}</div>
                        <div class="dash-card-sub">cost of goods</div>
                    </div>
                    
                    <div class="dash-card" style="border-color: #4CAF50;">
                        <div class="dash-card-label" style="color: #4CAF50;"> PROFIT</div>
                        <div class="dash-card-value" style="color: ${profit >= 0 ? '#2e7d32' : '#c62828'};">$${profit.toFixed(0)}</div>
                        <div class="dash-card-sub">gross profit</div>
                    </div>
                    
                    <div class="dash-card" style="border-color: ${grossMargin >= 20 ? '#4CAF50' : grossMargin >= 10 ? '#FF9800' : '#f44336'};">
                        <div class="dash-card-label" style="color: ${grossMargin >= 20 ? '#4CAF50' : grossMargin >= 10 ? '#FF9800' : '#f44336'};"> MARGIN</div>
                        <div class="dash-card-value">${grossMargin.toFixed(1)}%</div>
                        <div class="dash-card-sub">gross margin</div>
                    </div>
                </div>
                
                <!-- Secondary KPIs -->
                <div class="dash-card-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                    <div class="dash-card" style="border-color: #607D8B;">
                        <div class="dash-card-label" style="color: #607D8B;"> AVG ORDER</div>
                        <div class="dash-card-value">${formatMoney(avgOrderValue)}</div>
                        <div class="dash-card-sub">average order value</div>
                    </div>
                    
                    <div class="dash-card" style="border-color: #795548;">
                        <div class="dash-card-label" style="color: #795548;"> AVG PRICE</div>
                        <div class="dash-card-value">${formatMoney(avgUnitPrice)}</div>
                        <div class="dash-card-sub">per unit sold</div>
                    </div>
                    
                    <div class="dash-card" style="border-color: #9E9E9E;">
                        <div class="dash-card-label" style="color: #9E9E9E;"> AVG COST</div>
                        <div class="dash-card-value">${formatMoney(avgUnitCost)}</div>
                        <div class="dash-card-sub">per unit cost</div>
                    </div>
                </div>
                
                <!-- Top Performers Section -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    
                    <!-- Top Customers -->
                    <div class="dash-section">
                        <h4> Top Customers</h4>
                        ${topCustomers.length === 0 ? '<p style="color: #888; text-align: center;">No sales in this period</p>' : ''}
                        ${topCustomers.map((c, i) => `
                            <div class="top-item">
                                <div style="display: flex; align-items: center;">
                                    <div class="top-item-rank ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other'}">${i + 1}</div>
                                    <div>
                                        <div style="font-weight: 500;">${c.name}</div>
                                        <div style="font-size: 12px; color: #888;">${c.orders} order${c.orders !== 1 ? 's' : ''}</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: #2e7d32;">${formatMoney(c.sales)}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Top Products -->
                    <div class="dash-section">
                        <h4> Top Products</h4>
                        ${topProducts.length === 0 ? '<p style="color: #888; text-align: center;">No sales in this period</p>' : ''}
                        ${topProducts.map((p, i) => `
                            <div class="top-item">
                                <div style="display: flex; align-items: center;">
                                    <div class="top-item-rank ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other'}">${i + 1}</div>
                                    <div>
                                        <div style="font-weight: 500;">${p.name}</div>
                                        <div style="font-size: 12px; color: #888;">${p.qty} units  ${p.sku}</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: #2e7d32;">${formatMoney(p.sales)}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // ==================== BUSINESS OVERVIEW DASHBOARD ====================
        
        async function generateBusinessOverviewModal() {
            const topN = reportFilters.topN || 10;
            const fromDate = reportFilters.fromDate ? parseLocalDate(reportFilters.fromDate) : null;
            let toDate = reportFilters.toDate ? parseLocalDate(reportFilters.toDate) : null;
            if (toDate) toDate.setHours(23, 59, 59, 999);
            if (fromDate) fromDate.setHours(0, 0, 0, 0);
            
            // Fetch all data
            const [salesResult, poResult, itemsResult, customersResult, suppliersResult] = await Promise.all([
                apiCall('getSalesOrders'),
                apiCall('getPurchaseOrders'),
                apiCall('getItems'),
                apiCall('getCustomers'),
                apiCall('getSuppliers')
            ]);
            
            if (!salesResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const customers = customersResult?.data || [];
            const suppliers = suppliersResult?.data || [];
            const purchases = poResult?.data || [];
            let sales = salesResult.data.filter(so => so.Status !== 'Voided');
            
            // Calculate inventory stats including backorder
            let totalBackorder = 0;
            let backorderItems = 0;
            items.forEach(item => {
                const backorder = parseInt(item.Qty_On_Backorder) || 0;
                if (backorder > 0) {
                    totalBackorder += backorder;
                    backorderItems++;
                }
            });
            
            // Filter purchases by date and calculate stats
            const filteredPurchases = purchases.filter(po => {
                if (po.Status === 'Voided' || po.Status === 'Cancelled') return false;
                const poDate = parseDate(po.PO_Date);
                if (!poDate) return false;
                if (fromDate && poDate < fromDate) return false;
                if (toDate && poDate > toDate) return false;
                return true;
            });
            
            // Calculate purchase stats
            let totalPOAmount = 0, totalPOPaid = 0, totalPOOutstanding = 0;
            let poCount = filteredPurchases.length;
            let paidPOCount = 0, unpaidPOCount = 0, partialPOCount = 0;
            let receivedPOCount = 0, pendingPOCount = 0;
            const supplierSpend = {};
            const monthlyPurchases = {};
            
            for (const po of filteredPurchases) {
                const poAmount = parseFloat(po.Total_Amount) || 0;
                const poPaid = parseFloat(po.Amount_Paid) || 0;
                
                totalPOAmount += poAmount;
                totalPOPaid += poPaid;
                totalPOOutstanding += (poAmount - poPaid);
                
                // Payment status counts
                if (po.Payment_Status === 'Paid') paidPOCount++;
                else if (po.Payment_Status === 'Partial') partialPOCount++;
                else unpaidPOCount++;
                
                // Receiving status counts
                if (po.Status === 'Received') receivedPOCount++;
                else pendingPOCount++;
                
                // Supplier breakdown
                const suppId = po.Supplier_ID;
                if (!supplierSpend[suppId]) {
                    const supp = suppliers.find(s => s.Supplier_ID === suppId);
                    supplierSpend[suppId] = { name: supp?.Supplier_Name || 'Unknown', spend: 0, paid: 0, orders: 0 };
                }
                supplierSpend[suppId].spend += poAmount;
                supplierSpend[suppId].paid += poPaid;
                supplierSpend[suppId].orders++;
                
                // Monthly breakdown
                const poDate = parseDate(po.PO_Date);
                if (poDate) {
                    const monthKey = `${poDate.getFullYear()}-${String(poDate.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyPurchases[monthKey]) {
                        monthlyPurchases[monthKey] = { spend: 0, paid: 0, orders: 0 };
                    }
                    monthlyPurchases[monthKey].spend += poAmount;
                    monthlyPurchases[monthKey].paid += poPaid;
                    monthlyPurchases[monthKey].orders++;
                }
            }
            
            // Sort suppliers by spend
            const topSuppliersBySpend = Object.values(supplierSpend).sort((a, b) => b.spend - a.spend);
            const maxSupplierSpend = topSuppliersBySpend.length > 0 ? topSuppliersBySpend[0].spend : 1;
            
            // Sort monthly purchases
            const sortedMonthlyPurchases = Object.entries(monthlyPurchases).sort((a, b) => a[0].localeCompare(b[0]));
            const maxMonthlySpend = Math.max(...sortedMonthlyPurchases.map(([, d]) => d.spend), 1);
            
            // Calculate date range for comparison (same period last year)
            const now = new Date();
            let periodStart = fromDate || new Date(now.getFullYear(), 0, 1); // Default to YTD
            let periodEnd = toDate || now;
            const periodDays = Math.ceil((periodEnd - periodStart) / (1000 * 60 * 60 * 24));
            
            // Last year same period
            const lyStart = new Date(periodStart);
            lyStart.setFullYear(lyStart.getFullYear() - 1);
            const lyEnd = new Date(periodEnd);
            lyEnd.setFullYear(lyEnd.getFullYear() - 1);
            
            // Date label
            let dateLabel = 'All Time';
            if (fromDate && toDate) {
                dateLabel = `${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`;
            } else if (fromDate) {
                dateLabel = `Since ${fromDate.toLocaleDateString()}`;
            } else if (toDate) {
                dateLabel = `Through ${toDate.toLocaleDateString()}`;
            }
            
            // Filter sales by date
            const filteredSales = sales.filter(so => {
                const soDate = parseDate(so.Sale_Date || so.SO_Date);
                if (!soDate) return false;
                if (fromDate && soDate < fromDate) return false;
                if (toDate && soDate > toDate) return false;
                return true;
            });
            
            // Last year sales for comparison
            const lastYearSales = sales.filter(so => {
                const soDate = parseDate(so.Sale_Date || so.SO_Date);
                if (!soDate) return false;
                if (soDate < lyStart || soDate > lyEnd) return false;
                return true;
            });
            
            // Calculate current period stats
            let totalRevenue = 0, totalCost = 0, orderCount = filteredSales.length;
            const customerSales = {}, productSales = {}, supplierSales = {};
            const monthlySales = {};
            
            for (const so of filteredSales) {
                const soDate = parseDate(so.Sale_Date || so.SO_Date);
                const monthKey = soDate ? `${soDate.getFullYear()}-${String(soDate.getMonth() + 1).padStart(2, '0')}` : 'Unknown';
                
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const qty = parseInt(line.Quantity) || 0;
                        const unitPrice = parseFloat(line.Unit_Price) || 0;
                        const revenue = qty * unitPrice;
                        
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const unitsPerPkg = parseFloat(item?.Units_Per_Package) || 1;
                        const pkgCost = parseFloat(item?.Package_Cost) || 0;
                        const unitCost = pkgCost / unitsPerPkg;
                        const cost = qty * unitCost;
                        
                        totalRevenue += revenue;
                        totalCost += cost;
                        
                        // Customer breakdown
                        if (!customerSales[so.Customer_ID]) {
                            const cust = customers.find(c => c.Customer_ID === so.Customer_ID);
                            customerSales[so.Customer_ID] = { name: cust?.Customer_Name || 'Unknown', revenue: 0, orders: 0 };
                        }
                        customerSales[so.Customer_ID].revenue += revenue;
                        customerSales[so.Customer_ID].orders++;
                        
                        // Product breakdown
                        if (!productSales[line.Item_ID]) {
                            productSales[line.Item_ID] = { 
                                name: item?.Item_Description || line.Item_ID, 
                                sku: item?.SKU || '-',
                                revenue: 0, 
                                qty: 0 
                            };
                        }
                        productSales[line.Item_ID].revenue += revenue;
                        productSales[line.Item_ID].qty += qty;
                        
                        // Supplier breakdown
                        const suppId = item?.Supplier_ID || 'Unknown';
                        if (!supplierSales[suppId]) {
                            const supp = suppliers.find(s => s.Supplier_ID === suppId);
                            supplierSales[suppId] = { name: supp?.Supplier_Name || 'Unknown', revenue: 0, cost: 0 };
                        }
                        supplierSales[suppId].revenue += revenue;
                        supplierSales[suppId].cost += cost;
                        
                        // Monthly breakdown
                        if (!monthlySales[monthKey]) {
                            monthlySales[monthKey] = { revenue: 0, cost: 0, orders: 0 };
                        }
                        monthlySales[monthKey].revenue += revenue;
                        monthlySales[monthKey].cost += cost;
                    });
                }
                if (monthlySales[monthKey]) monthlySales[monthKey].orders++;
            }
            
            // Last year stats
            let lyRevenue = 0;
            for (const so of lastYearSales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const qty = parseInt(line.Quantity) || 0;
                        const unitPrice = parseFloat(line.Unit_Price) || 0;
                        lyRevenue += qty * unitPrice;
                    });
                }
            }
            
            // Calculate metrics
            const totalProfit = totalRevenue - totalCost;
            const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
            const avgOrderValue = orderCount > 0 ? totalRevenue / orderCount : 0;
            const yoyGrowth = lyRevenue > 0 ? ((totalRevenue - lyRevenue) / lyRevenue) * 100 : (totalRevenue > 0 ? 100 : 0);
            
            // Sort and get top N
            const topCustomers = Object.values(customerSales).sort((a, b) => b.revenue - a.revenue).slice(0, topN);
            const topProducts = Object.values(productSales).sort((a, b) => b.revenue - a.revenue).slice(0, topN);
            const topSuppliers = Object.values(supplierSales).sort((a, b) => b.revenue - a.revenue);
            
            // Sort monthly data
            const sortedMonths = Object.entries(monthlySales).sort((a, b) => a[0].localeCompare(b[0]));
            const maxMonthlyRevenue = Math.max(...sortedMonths.map(([, d]) => d.revenue), 1);
            
            // Max values for bar charts
            const maxCustomerRevenue = topCustomers.length > 0 ? topCustomers[0].revenue : 1;
            const maxProductRevenue = topProducts.length > 0 ? topProducts[0].revenue : 1;
            const maxSupplierRevenue = topSuppliers.length > 0 ? topSuppliers[0].revenue : 1;
            const totalSupplierRevenue = topSuppliers.reduce((sum, s) => sum + s.revenue, 0);
            
            // Colors
            const chartColors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'];
            const supplierColors = ['#1e40af', '#047857', '#b45309', '#b91c1c', '#6d28d9', '#be185d'];
            
            let html = `
                <style>
                    .biz-header {
                        padding: 35px;
                        background: linear-gradient(135deg, #059669 0%, #10b981 100%);
                        color: white;
                        border-radius: 16px;
                        margin-bottom: 30px;
                        box-shadow: 0 10px 30px rgba(5, 150, 105, 0.3), 0 4px 12px rgba(0,0,0,0.1);
                        border: 2px solid rgba(255, 255, 255, 0.1);
                    }
                    .biz-header h2 { 
                        margin: 0 0 10px 0; 
                        font-size: 32px;
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    }
                    .biz-header p { 
                        margin: 0; 
                        opacity: 0.95; 
                        font-size: 16px; 
                    }
                    
                    .biz-kpi-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    .biz-kpi {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        text-align: center;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                        position: relative;
                        overflow: hidden;
                    }
                    .biz-kpi::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        height: 4px;
                    }
                    .biz-kpi .icon { font-size: 32px; margin-bottom: 10px; }
                    .biz-kpi .value { font-size: 28px; font-weight: bold; color: #1f2937; }
                    .biz-kpi .label { font-size: 12px; color: #6b7280; text-transform: uppercase; margin-top: 5px; }
                    .biz-kpi .change { font-size: 13px; margin-top: 8px; font-weight: 600; }
                    .biz-kpi .change.up { color: #059669; }
                    .biz-kpi .change.down { color: #dc2626; }
                    
                    .biz-section {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 20px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                    }
                    .biz-section h3 {
                        margin: 0 0 20px 0;
                        padding-bottom: 12px;
                        border-bottom: 2px solid #e5e7eb;
                        color: #1f2937;
                        font-size: 18px;
                    }
                    
                    .biz-row {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                        gap: 20px;
                        margin-bottom: 20px;
                    }
                    
                    .biz-chart-bar {
                        display: flex;
                        align-items: center;
                        margin-bottom: 12px;
                        gap: 10px;
                    }
                    .biz-chart-label {
                        width: 140px;
                        font-size: 13px;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        color: #374151;
                    }
                    .biz-chart-bar-bg {
                        flex: 1;
                        height: 24px;
                        background: #f3f4f6;
                        border-radius: 12px;
                        overflow: hidden;
                    }
                    .biz-chart-bar-fill {
                        height: 100%;
                        border-radius: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: flex-end;
                        padding-right: 8px;
                        font-size: 11px;
                        font-weight: 600;
                        color: white;
                        min-width: 50px;
                        transition: width 0.5s ease;
                    }
                    .biz-chart-value {
                        width: 80px;
                        text-align: right;
                        font-weight: 600;
                        font-size: 13px;
                        color: #1f2937;
                    }
                    
                    .biz-compare-grid {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 20px;
                    }
                    .biz-compare-card {
                        background: #f9fafb;
                        border-radius: 12px;
                        padding: 20px;
                        text-align: center;
                    }
                    .biz-compare-card.current { border-left: 4px solid #10b981; }
                    .biz-compare-card.previous { border-left: 4px solid #6b7280; }
                    .biz-compare-card .period { font-size: 12px; color: #6b7280; text-transform: uppercase; margin-bottom: 8px; }
                    .biz-compare-card .amount { font-size: 32px; font-weight: bold; }
                    .biz-compare-card.current .amount { color: #059669; }
                    .biz-compare-card.previous .amount { color: #6b7280; }
                    .biz-compare-card .sub { font-size: 13px; color: #9ca3af; margin-top: 5px; }
                    
                    .biz-growth-badge {
                        display: inline-flex;
                        align-items: center;
                        gap: 5px;
                        padding: 8px 16px;
                        border-radius: 20px;
                        font-size: 16px;
                        font-weight: 600;
                    }
                    .biz-growth-badge.up { background: #d1fae5; color: #059669; }
                    .biz-growth-badge.down { background: #fee2e2; color: #dc2626; }
                    .biz-growth-badge.neutral { background: #f3f4f6; color: #6b7280; }
                    
                    .biz-monthly-chart {
                        display: flex;
                        align-items: flex-end;
                        justify-content: space-between;
                        height: 200px;
                        padding: 20px 10px 40px 10px;
                        gap: 8px;
                    }
                    .biz-monthly-bar {
                        flex: 1;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        height: 100%;
                    }
                    .biz-monthly-bar-fill {
                        width: 100%;
                        max-width: 50px;
                        background: linear-gradient(180deg, #3b82f6, #1d4ed8);
                        border-radius: 6px 6px 0 0;
                        transition: height 0.5s ease;
                        position: relative;
                    }
                    .biz-monthly-bar-fill:hover {
                        background: linear-gradient(180deg, #60a5fa, #3b82f6);
                    }
                    .biz-monthly-bar-fill::after {
                        content: attr(data-value);
                        position: absolute;
                        top: -25px;
                        left: 50%;
                        transform: translateX(-50%);
                        font-size: 10px;
                        font-weight: 600;
                        color: #1f2937;
                        white-space: nowrap;
                    }
                    .biz-monthly-label {
                        font-size: 11px;
                        color: #6b7280;
                        margin-top: 8px;
                        transform: rotate(-45deg);
                        white-space: nowrap;
                    }
                    
                    .biz-pie-legend {
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    }
                    .biz-pie-item {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    .biz-pie-color {
                        width: 16px;
                        height: 16px;
                        border-radius: 4px;
                    }
                    .biz-pie-name { flex: 1; font-size: 13px; color: #374151; }
                    .biz-pie-value { font-weight: 600; color: #1f2937; }
                    .biz-pie-pct { font-size: 12px; color: #6b7280; width: 50px; text-align: right; }
                    
                    .biz-stat-row {
                        display: flex;
                        justify-content: space-between;
                        padding: 12px 0;
                        border-bottom: 1px solid #f3f4f6;
                    }
                    .biz-stat-row:last-child { border-bottom: none; }
                    .biz-stat-label { color: #6b7280; }
                    .biz-stat-value { font-weight: 600; color: #1f2937; }
                </style>
                
                <div class="biz-header">
                    <h2> Business Overview Dashboard</h2>
                    <p>${dateLabel}  Top ${topN} Analysis</p>
                </div>
                
                <!-- KPI Cards -->
                <div class="biz-kpi-grid">
                    <div class="biz-kpi" style="border-top: 4px solid #10b981;">
                        <div class="icon"></div>
                        <div class="value">$${totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="label">Total Revenue</div>
                        <div class="change ${yoyGrowth >= 0 ? 'up' : 'down'}">${yoyGrowth >= 0 ? '' : ''} ${Math.abs(yoyGrowth).toFixed(1)}% vs Last Year</div>
                    </div>
                    <div class="biz-kpi" style="border-top: 4px solid #3b82f6;">
                        <div class="icon"></div>
                        <div class="value">$${totalProfit.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="label">Gross Profit</div>
                        <div class="change up">${avgMargin.toFixed(1)}% margin</div>
                    </div>
                    <div class="biz-kpi" style="border-top: 4px solid #8b5cf6;">
                        <div class="icon"></div>
                        <div class="value">${orderCount.toLocaleString()}</div>
                        <div class="label">Total Orders</div>
                        <div class="change up">${lastYearSales.length > 0 ? ((orderCount - lastYearSales.length) / lastYearSales.length * 100).toFixed(1) : '100'}% vs LY</div>
                    </div>
                    <div class="biz-kpi" style="border-top: 4px solid #f59e0b;">
                        <div class="icon"></div>
                        <div class="value">${formatMoney(avgOrderValue)}</div>
                        <div class="label">Avg Order Value</div>
                    </div>
                    <div class="biz-kpi" style="border-top: 4px solid #ec4899;">
                        <div class="icon"></div>
                        <div class="value">${Object.keys(customerSales).length}</div>
                        <div class="label">Active Customers</div>
                    </div>
                    <div class="biz-kpi" style="border-top: 4px solid #06b6d4;">
                        <div class="icon"></div>
                        <div class="value">${Object.keys(productSales).length}</div>
                        <div class="label">Products Sold</div>
                    </div>
                    <div class="biz-kpi" style="border-top: 4px solid ${totalBackorder > 0 ? '#dc2626' : '#9ca3af'};">
                        <div class="icon"></div>
                        <div class="value" style="color: ${totalBackorder > 0 ? '#dc2626' : '#666'};">${totalBackorder}</div>
                        <div class="label">On Backorder</div>
                        <div class="change ${totalBackorder > 0 ? 'down' : 'up'}">${backorderItems} items</div>
                    </div>
                </div>
                
                <!-- Purchases KPI Cards -->
                <div style="margin-top: 10px; margin-bottom: 25px;">
                    <h3 style="margin: 0 0 15px 0; color: #dc2626; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                         Purchase Orders Summary
                    </h3>
                    <div class="biz-kpi-grid">
                        <div class="biz-kpi" style="border-top: 4px solid #dc2626;">
                            <div class="icon"></div>
                            <div class="value">$${totalPOAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div class="label">Total PO Amount</div>
                            <div class="change">${poCount} orders</div>
                        </div>
                        <div class="biz-kpi" style="border-top: 4px solid #16a34a;">
                            <div class="icon"></div>
                            <div class="value">$${totalPOPaid.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div class="label">Amount Paid</div>
                            <div class="change up">${paidPOCount} paid in full</div>
                        </div>
                        <div class="biz-kpi" style="border-top: 4px solid #f59e0b;">
                            <div class="icon"></div>
                            <div class="value" style="color: ${totalPOOutstanding > 0 ? '#dc2626' : '#16a34a'};">$${totalPOOutstanding.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div class="label">Outstanding Payables</div>
                            <div class="change ${totalPOOutstanding > 0 ? 'down' : 'up'}">${unpaidPOCount + partialPOCount} unpaid</div>
                        </div>
                        <div class="biz-kpi" style="border-top: 4px solid #7c3aed;">
                            <div class="icon"></div>
                            <div class="value">${receivedPOCount}</div>
                            <div class="label">POs Received</div>
                            <div class="change">${pendingPOCount} pending</div>
                        </div>
                    </div>
                </div>
                
                <!-- Year over Year Comparison -->
                <div class="biz-section">
                    <h3> Year-over-Year Comparison</h3>
                    <div class="biz-compare-grid">
                        <div class="biz-compare-card current">
                            <div class="period">Current Period</div>
                            <div class="amount">$${totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div class="sub">${orderCount} orders</div>
                        </div>
                        <div class="biz-compare-card previous">
                            <div class="period">Same Period Last Year</div>
                            <div class="amount">$${lyRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div class="sub">${lastYearSales.length} orders</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <span class="biz-growth-badge ${yoyGrowth > 0 ? 'up' : yoyGrowth < 0 ? 'down' : 'neutral'}">
                            ${yoyGrowth > 0 ? ' ' : yoyGrowth < 0 ? ' ' : ''} 
                            ${yoyGrowth > 0 ? '+' : ''}${yoyGrowth.toFixed(1)}% 
                            ${yoyGrowth > 0 ? 'Growth' : yoyGrowth < 0 ? 'Decline' : 'No Change'}
                        </span>
                        <p style="color: #6b7280; font-size: 13px; margin-top: 10px;">
                            ${yoyGrowth > 0 ? `You've earned ${formatMoney(totalRevenue - lyRevenue)} more than last year!` : 
                              yoyGrowth < 0 ? `Revenue is down ${formatMoney(Math.abs(totalRevenue - lyRevenue))} from last year` : 
                              'Revenue is the same as last year'}
                        </p>
                    </div>
                </div>
                
                <!-- Monthly Sales Trend -->
                ${sortedMonths.length > 0 ? `
                <div class="biz-section">
                    <h3> Sales Trend by Month</h3>
                    <div class="biz-monthly-chart">
                        ${sortedMonths.slice(-12).map(([month, data]) => {
                            const height = (data.revenue / maxMonthlyRevenue) * 100;
                            const monthName = new Date(month + '-01').toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                            return `
                                <div class="biz-monthly-bar">
                                    <div class="biz-monthly-bar-fill" style="height: ${Math.max(height, 5)}%;" data-value="$${(data.revenue/1000).toFixed(1)}k"></div>
                                    <div class="biz-monthly-label">${monthName}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <span style="font-size: 12px; color: #6b7280;"> Monthly Revenue Trend (Last 12 Months)</span>
                    </div>
                </div>
                ` : ''}
                
                <div class="biz-row">
                    <!-- Top Customers -->
                    <div class="biz-section">
                        <h3> Top ${topN} Customers</h3>
                        ${topCustomers.length === 0 ? '<p style="color: #6b7280; text-align: center;">No customer data</p>' :
                        topCustomers.map((c, i) => {
                            const width = (c.revenue / maxCustomerRevenue) * 100;
                            return `
                                <div class="biz-chart-bar">
                                    <div class="biz-chart-label" title="${c.name}">${i + 1}. ${c.name}</div>
                                    <div class="biz-chart-bar-bg">
                                        <div class="biz-chart-bar-fill" style="width: ${Math.max(width, 8)}%; background: ${chartColors[i % chartColors.length]};">
                                            ${c.orders}
                                        </div>
                                    </div>
                                    <div class="biz-chart-value">$${c.revenue.toFixed(0)}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Top Products -->
                    <div class="biz-section">
                        <h3> Top ${topN} Products</h3>
                        ${topProducts.length === 0 ? '<p style="color: #6b7280; text-align: center;">No product data</p>' :
                        topProducts.map((p, i) => {
                            const width = (p.revenue / maxProductRevenue) * 100;
                            return `
                                <div class="biz-chart-bar">
                                    <div class="biz-chart-label" title="${p.name}">${i + 1}. ${p.name}</div>
                                    <div class="biz-chart-bar-bg">
                                        <div class="biz-chart-bar-fill" style="width: ${Math.max(width, 8)}%; background: ${chartColors[i % chartColors.length]};">
                                            ${p.qty}
                                        </div>
                                    </div>
                                    <div class="biz-chart-value">$${p.revenue.toFixed(0)}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div class="biz-row">
                    <!-- Supplier Breakdown -->
                    <div class="biz-section">
                        <h3> Revenue by Supplier</h3>
                        <div class="biz-pie-legend">
                            ${topSuppliers.map((s, i) => {
                                const pct = totalSupplierRevenue > 0 ? (s.revenue / totalSupplierRevenue) * 100 : 0;
                                return `
                                    <div class="biz-pie-item">
                                        <div class="biz-pie-color" style="background: ${supplierColors[i % supplierColors.length]};"></div>
                                        <div class="biz-pie-name">${s.name}</div>
                                        <div class="biz-pie-value">${formatMoney(s.revenue)}</div>
                                        <div class="biz-pie-pct">${pct.toFixed(1)}%</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                            ${topSuppliers.map((s, i) => {
                                const width = (s.revenue / maxSupplierRevenue) * 100;
                                return `
                                    <div style="height: 20px; background: #f3f4f6; border-radius: 10px; overflow: hidden; margin-bottom: 8px;">
                                        <div style="height: 100%; width: ${width}%; background: ${supplierColors[i % supplierColors.length]}; border-radius: 10px;"></div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="biz-section">
                        <h3> Quick Stats</h3>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Total Revenue</span>
                            <span class="biz-stat-value">${formatMoney(totalRevenue)}</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Total Cost</span>
                            <span class="biz-stat-value">${formatMoney(totalCost)}</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Gross Profit</span>
                            <span class="biz-stat-value" style="color: #059669;">${formatMoney(totalProfit)}</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Profit Margin</span>
                            <span class="biz-stat-value">${avgMargin.toFixed(1)}%</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Total Orders</span>
                            <span class="biz-stat-value">${orderCount}</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Avg Order Value</span>
                            <span class="biz-stat-value">${formatMoney(avgOrderValue)}</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Active Customers</span>
                            <span class="biz-stat-value">${Object.keys(customerSales).length}</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Products Sold</span>
                            <span class="biz-stat-value">${Object.keys(productSales).length}</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Period Days</span>
                            <span class="biz-stat-value">${periodDays} days</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Daily Avg Revenue</span>
                            <span class="biz-stat-value">${formatMoney(totalRevenue / Math.max(periodDays, 1))}</span>
                        </div>
                    </div>
                </div>
                
                <!-- ==================== PURCHASES SECTION ==================== -->
                <div style="margin-top: 30px; padding-top: 30px; border-top: 3px solid #dc2626;">
                    <h2 style="color: #dc2626; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                         Purchase Orders Analysis
                    </h2>
                </div>
                
                <!-- Monthly Purchases Trend -->
                ${sortedMonthlyPurchases.length > 0 ? `
                <div class="biz-section">
                    <h3> Purchases Trend by Month</h3>
                    <div class="biz-monthly-chart">
                        ${sortedMonthlyPurchases.slice(-12).map(([month, data]) => {
                            const height = (data.spend / maxMonthlySpend) * 100;
                            const monthName = new Date(month + '-01').toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                            return `
                                <div class="biz-monthly-bar">
                                    <div class="biz-monthly-bar-fill" style="height: ${Math.max(height, 5)}%; background: linear-gradient(180deg, #dc2626, #991b1b);" data-value="$${(data.spend/1000).toFixed(1)}k"></div>
                                    <div class="biz-monthly-label">${monthName}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <span style="font-size: 12px; color: #6b7280;"> Monthly Purchase Spend (Last 12 Months)</span>
                    </div>
                </div>
                ` : ''}
                
                <div class="biz-row">
                    <!-- Top Suppliers by Spend -->
                    <div class="biz-section">
                        <h3> Top Suppliers by Spend</h3>
                        ${topSuppliersBySpend.length === 0 ? '<p style="color: #6b7280; text-align: center;">No purchase data</p>' :
                        topSuppliersBySpend.slice(0, topN).map((s, i) => {
                            const width = (s.spend / maxSupplierSpend) * 100;
                            const outstanding = s.spend - s.paid;
                            return `
                                <div class="biz-chart-bar">
                                    <div class="biz-chart-label" title="${s.name}">${i + 1}. ${s.name}</div>
                                    <div class="biz-chart-bar-bg">
                                        <div class="biz-chart-bar-fill" style="width: ${Math.max(width, 8)}%; background: linear-gradient(90deg, #dc2626, #f87171);">
                                            ${s.orders}
                                        </div>
                                    </div>
                                    <div class="biz-chart-value">$${s.spend.toFixed(0)}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Purchase Quick Stats -->
                    <div class="biz-section">
                        <h3> Purchase Stats</h3>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Total PO Amount</span>
                            <span class="biz-stat-value">${formatMoney(totalPOAmount)}</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Amount Paid</span>
                            <span class="biz-stat-value" style="color: #16a34a;">${formatMoney(totalPOPaid)}</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Outstanding</span>
                            <span class="biz-stat-value" style="color: ${totalPOOutstanding > 0 ? '#dc2626' : '#16a34a'};">${formatMoney(totalPOOutstanding)}</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Total POs</span>
                            <span class="biz-stat-value">${poCount}</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Paid in Full</span>
                            <span class="biz-stat-value">${paidPOCount}</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Partial Payment</span>
                            <span class="biz-stat-value">${partialPOCount}</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Unpaid</span>
                            <span class="biz-stat-value" style="color: ${unpaidPOCount > 0 ? '#dc2626' : '#16a34a'};">${unpaidPOCount}</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Received</span>
                            <span class="biz-stat-value">${receivedPOCount}</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Pending Receipt</span>
                            <span class="biz-stat-value">${pendingPOCount}</span>
                        </div>
                        <div class="biz-stat-row">
                            <span class="biz-stat-label"> Avg PO Value</span>
                            <span class="biz-stat-value">${formatMoney(poCount > 0 ? totalPOAmount / poCount : 0)}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Supplier Spend Table -->
                ${topSuppliersBySpend.length > 0 ? `
                <div class="biz-section">
                    <h3> Supplier Spend Details</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Supplier</th>
                                    <th style="text-align: right;">PO Count</th>
                                    <th style="text-align: right;">Total Spend</th>
                                    <th style="text-align: right;">Amount Paid</th>
                                    <th style="text-align: right;">Outstanding</th>
                                    <th style="text-align: right;">% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${topSuppliersBySpend.map((s, i) => {
                                    const pct = totalPOAmount > 0 ? (s.spend / totalPOAmount) * 100 : 0;
                                    const outstanding = s.spend - s.paid;
                                    return `
                                        <tr>
                                            <td><strong>${i + 1}</strong></td>
                                            <td>${s.name}</td>
                                            <td style="text-align: right;">${s.orders}</td>
                                            <td style="text-align: right;">${formatMoney(s.spend)}</td>
                                            <td style="text-align: right; color: #16a34a;">${formatMoney(s.paid)}</td>
                                            <td style="text-align: right; color: ${outstanding > 0 ? '#dc2626' : '#16a34a'};">${formatMoney(outstanding)}</td>
                                            <td style="text-align: right;">
                                                <div style="display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                                                    <div style="width: 60px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                                        <div style="height: 100%; width: ${pct}%; background: #dc2626; border-radius: 4px;"></div>
                                                    </div>
                                                    <span>${pct.toFixed(1)}%</span>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                            <tfoot style="font-weight: bold; background: #f9fafb;">
                                <tr>
                                    <td colspan="2">TOTAL</td>
                                    <td style="text-align: right;">${poCount}</td>
                                    <td style="text-align: right;">${formatMoney(totalPOAmount)}</td>
                                    <td style="text-align: right; color: #16a34a;">${formatMoney(totalPOPaid)}</td>
                                    <td style="text-align: right; color: ${totalPOOutstanding > 0 ? '#dc2626' : '#16a34a'};">${formatMoney(totalPOOutstanding)}</td>
                                    <td style="text-align: right;">100%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                ` : ''}
                
                <!-- Cash Flow Summary -->
                <div class="biz-section" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #16a34a;">
                    <h3 style="color: #16a34a;"> Cash Flow Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center; padding: 20px; background: white; border-radius: 12px;">
                            <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;"> Revenue (Sales)</div>
                            <div style="font-size: 28px; font-weight: bold; color: #16a34a;">+${formatMoney(totalRevenue)}</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: white; border-radius: 12px;">
                            <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;"> Expenses (Purchases)</div>
                            <div style="font-size: 28px; font-weight: bold; color: #dc2626;">-${formatMoney(totalPOAmount)}</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: white; border-radius: 12px;">
                            <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;"> Net Cash Flow</div>
                            <div style="font-size: 28px; font-weight: bold; color: ${totalRevenue - totalPOAmount >= 0 ? '#16a34a' : '#dc2626'};">
                                ${totalRevenue - totalPOAmount >= 0 ? '+' : ''}${formatMoney(totalRevenue - totalPOAmount)}
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; text-align: center;">
                        <span style="font-size: 14px; color: #6b7280;">
                            ${totalRevenue - totalPOAmount >= 0 
                                ? ' Positive cash flow! Revenue exceeds purchase expenses.' 
                                : ' Negative cash flow. Purchase expenses exceed revenue.'}
                        </span>
                    </div>
                </div>
                
                <!-- Top Products Table -->
                <div class="biz-section">
                    <h3> Product Performance Details</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>SKU</th>
                                    <th>Product</th>
                                    <th style="text-align: right;">Units Sold</th>
                                    <th style="text-align: right;">Revenue</th>
                                    <th style="text-align: right;">% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${topProducts.map((p, i) => {
                                    const pct = totalRevenue > 0 ? (p.revenue / totalRevenue) * 100 : 0;
                                    return `
                                        <tr>
                                            <td><strong>${i + 1}</strong></td>
                                            <td>${p.sku}</td>
                                            <td>${p.name}</td>
                                            <td style="text-align: right;">${p.qty.toLocaleString()}</td>
                                            <td style="text-align: right;">${formatMoney(p.revenue)}</td>
                                            <td style="text-align: right;">
                                                <div style="display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                                                    <div style="width: 60px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                                        <div style="height: 100%; width: ${pct}%; background: #3b82f6; border-radius: 4px;"></div>
                                                    </div>
                                                    <span>${pct.toFixed(1)}%</span>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // ==================== PRODUCT PERFORMANCE DASHBOARD ====================
        
        async function generateProductDashboardModal() {
            const topN = reportFilters.topN || 10;
            const itemFilter = reportFilters.item || '';
            const fromDate = reportFilters.fromDate ? parseLocalDate(reportFilters.fromDate) : null;
            let toDate = reportFilters.toDate ? parseLocalDate(reportFilters.toDate) : null;
            if (toDate) toDate.setHours(23, 59, 59, 999);
            if (fromDate) fromDate.setHours(0, 0, 0, 0);
            
            // Fetch all data
            const [salesResult, itemsResult, suppliersResult] = await Promise.all([
                apiCall('getSalesOrders'),
                apiCall('getItems'),
                apiCall('getSuppliers')
            ]);
            
            if (!salesResult?.data || !itemsResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const suppliers = suppliersResult.data;
            let sales = salesResult.data.filter(so => so.Status !== 'Voided');
            
            // Get item name for filter label
            let itemFilterLabel = '';
            if (itemFilter) {
                const filteredItem = items.find(i => i.Item_ID === itemFilter);
                itemFilterLabel = filteredItem ? filteredItem.Item_Description : itemFilter;
            }
            
            // Date range label
            let dateLabel = 'All Time';
            if (fromDate && toDate) {
                dateLabel = `${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`;
            } else if (fromDate) {
                dateLabel = `Since ${fromDate.toLocaleDateString()}`;
            } else if (toDate) {
                dateLabel = `Through ${toDate.toLocaleDateString()}`;
            }
            if (itemFilterLabel) {
                dateLabel += `  Filtered: ${itemFilterLabel}`;
            }
            
            // Gather all line items with date filtering
            const productStats = {};
            
            for (const so of sales) {
                const soDate = parseDate(so.Sale_Date || so.SO_Date);
                
                // Date filtering
                if (fromDate && (!soDate || soDate < fromDate)) continue;
                if (toDate && (!soDate || soDate > toDate)) continue;
                
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const itemId = line.Item_ID;
                        
                        // Apply item filter if specified
                        if (itemFilter && itemId !== itemFilter) return;
                        
                        const qty = parseInt(line.Quantity) || 0;
                        const unitPrice = parseFloat(line.Unit_Price) || 0;
                        const revenue = qty * unitPrice;
                        
                        if (!productStats[itemId]) {
                            const item = items.find(i => i.Item_ID === itemId);
                            const supplier = suppliers.find(s => s.Supplier_ID === item?.Supplier_ID);
                            const unitsPerPkg = parseFloat(item?.Units_Per_Package) || 1;
                            const pkgCost = parseFloat(item?.Package_Cost) || 0;
                            const unitCost = pkgCost / unitsPerPkg;
                            
                            productStats[itemId] = {
                                itemId: itemId,
                                name: item?.Item_Description || itemId,
                                sku: item?.SKU || '-',
                                supplier: supplier?.Supplier_Name || 'Unknown',
                                supplierId: item?.Supplier_ID || '',
                                unitCost: unitCost,
                                unitPrice: parseFloat(item?.Unit_Sell_Price) || 0,
                                qtyOnHand: parseInt(item?.Qty_On_Hand) || 0,
                                qtyOnBackorder: parseInt(item?.Qty_On_Backorder) || 0,
                                reorderPoint: parseInt(item?.Reorder_Point) || 0,
                                qtySold: 0,
                                revenue: 0,
                                cost: 0,
                                orders: 0
                            };
                        }
                        
                        productStats[itemId].qtySold += qty;
                        productStats[itemId].revenue += revenue;
                        productStats[itemId].cost += qty * productStats[itemId].unitCost;
                        productStats[itemId].orders++;
                    });
                }
            }
            
            // Calculate profit and margin for each product
            Object.values(productStats).forEach(p => {
                p.profit = p.revenue - p.cost;
                p.margin = p.revenue > 0 ? (p.profit / p.revenue) * 100 : 0;
            });
            
            // Get all products sorted by revenue for top sellers
            const allProducts = Object.values(productStats);
            const topSellers = [...allProducts].sort((a, b) => b.revenue - a.revenue).slice(0, topN);
            
            // Bottom sellers - products with inventory but low/no sales
            const productsWithInventory = items
                .filter(item => {
                    // Apply item filter if specified
                    if (itemFilter && item.Item_ID !== itemFilter) return false;
                    return (parseInt(item.Qty_On_Hand) || 0) > 0;
                })
                .map(item => {
                    const stats = productStats[item.Item_ID];
                    const supplier = suppliers.find(s => s.Supplier_ID === item.Supplier_ID);
                    return {
                        itemId: item.Item_ID,
                        name: item.Item_Description || item.Item_ID,
                        sku: item.SKU || '-',
                        supplier: supplier?.Supplier_Name || 'Unknown',
                        qtyOnHand: parseInt(item.Qty_On_Hand) || 0,
                        qtySold: stats?.qtySold || 0,
                        revenue: stats?.revenue || 0
                    };
                })
                .sort((a, b) => a.qtySold - b.qtySold)
                .slice(0, topN);
            
            // Overall stats
            const totalRevenue = allProducts.reduce((sum, p) => sum + p.revenue, 0);
            const totalCost = allProducts.reduce((sum, p) => sum + p.cost, 0);
            const totalProfit = totalRevenue - totalCost;
            const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
            const totalUnitsSold = allProducts.reduce((sum, p) => sum + p.qtySold, 0);
            const uniqueProducts = allProducts.length;
            
            // Supplier breakdown
            const supplierStats = {};
            allProducts.forEach(p => {
                if (!supplierStats[p.supplierId]) {
                    supplierStats[p.supplierId] = {
                        name: p.supplier,
                        revenue: 0,
                        profit: 0,
                        products: 0,
                        units: 0
                    };
                }
                supplierStats[p.supplierId].revenue += p.revenue;
                supplierStats[p.supplierId].profit += p.profit;
                supplierStats[p.supplierId].products++;
                supplierStats[p.supplierId].units += p.qtySold;
            });
            const supplierBreakdown = Object.values(supplierStats).sort((a, b) => b.revenue - a.revenue);
            
            // Calculate bar widths for charts
            const maxTopRevenue = topSellers.length > 0 ? topSellers[0].revenue : 1;
            const maxSupplierRevenue = supplierBreakdown.length > 0 ? supplierBreakdown[0].revenue : 1;
            
            let html = `
                <style>
                    .prod-dash-header {
                        padding: 35px;
                        background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
                        color: white;
                        border-radius: 16px;
                        margin-bottom: 30px;
                        box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3), 0 4px 12px rgba(0,0,0,0.1);
                        border: 2px solid rgba(255, 255, 255, 0.1);
                    }
                    .prod-dash-header h2 { 
                        margin: 0 0 10px 0; 
                        font-size: 32px; 
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    }
                    .prod-dash-header p { 
                        margin: 0; 
                        font-size: 16px;
                        opacity: 0.95; 
                    }
                    
                    .prod-kpi-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    .prod-kpi-card {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        text-align: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    }
                    .prod-kpi-card .icon { font-size: 28px; margin-bottom: 8px; }
                    .prod-kpi-card .value { font-size: 28px; font-weight: bold; color: #333; }
                    .prod-kpi-card .label { font-size: 12px; color: #666; text-transform: uppercase; margin-top: 5px; }
                    
                    .prod-section {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    }
                    .prod-section h3 {
                        margin: 0 0 15px 0;
                        padding-bottom: 10px;
                        border-bottom: 2px solid #e0e0e0;
                        color: #333;
                    }
                    
                    .prod-bar-chart {
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                    }
                    .prod-bar-row {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    .prod-bar-label {
                        width: 180px;
                        font-size: 13px;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .prod-bar-container {
                        flex: 1;
                        height: 28px;
                        background: #f0f0f0;
                        border-radius: 14px;
                        overflow: hidden;
                        position: relative;
                    }
                    .prod-bar-fill {
                        height: 100%;
                        border-radius: 14px;
                        display: flex;
                        align-items: center;
                        justify-content: flex-end;
                        padding-right: 10px;
                        color: white;
                        font-size: 12px;
                        font-weight: 600;
                        min-width: 60px;
                    }
                    .prod-bar-value {
                        width: 90px;
                        text-align: right;
                        font-weight: 600;
                        font-size: 13px;
                    }
                    
                    .bottom-seller-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                        gap: 15px;
                    }
                    .bottom-seller-card {
                        background: #fff5f5;
                        border: 1px solid #fed7d7;
                        border-left: 4px solid #f56565;
                        border-radius: 8px;
                        padding: 15px;
                    }
                    .bottom-seller-card .name {
                        font-weight: 600;
                        color: #333;
                        margin-bottom: 5px;
                    }
                    .bottom-seller-card .sku {
                        font-size: 11px;
                        color: #888;
                        margin-bottom: 10px;
                    }
                    .bottom-seller-card .stats {
                        display: flex;
                        justify-content: space-between;
                        font-size: 13px;
                    }
                    .bottom-seller-card .stat-box {
                        text-align: center;
                    }
                    .bottom-seller-card .stat-value {
                        font-weight: bold;
                        font-size: 16px;
                    }
                    .bottom-seller-card .stat-label {
                        font-size: 10px;
                        color: #666;
                        text-transform: uppercase;
                    }
                    
                    /* Top Seller Cards - Green themed */
                    .top-seller-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                        gap: 15px;
                    }
                    .top-seller-card {
                        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
                        border: 1px solid #86efac;
                        border-left: 4px solid #22c55e;
                        border-radius: 8px;
                        padding: 15px;
                        position: relative;
                    }
                    .top-seller-card .rank {
                        position: absolute;
                        top: -8px;
                        right: 10px;
                        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
                        color: white;
                        font-size: 12px;
                        font-weight: bold;
                        padding: 4px 10px;
                        border-radius: 12px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    }
                    .top-seller-card .rank.gold { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
                    .top-seller-card .rank.silver { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); }
                    .top-seller-card .rank.bronze { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); }
                    .top-seller-card .name {
                        font-weight: 600;
                        color: #166534;
                        margin-bottom: 5px;
                        padding-right: 50px;
                    }
                    .top-seller-card .sku {
                        font-size: 11px;
                        color: #4ade80;
                        margin-bottom: 10px;
                    }
                    .top-seller-card .stats {
                        display: flex;
                        justify-content: space-between;
                        font-size: 13px;
                    }
                    .top-seller-card .stat-box {
                        text-align: center;
                    }
                    .top-seller-card .stat-value {
                        font-weight: bold;
                        font-size: 16px;
                    }
                    .top-seller-card .stat-label {
                        font-size: 10px;
                        color: #166534;
                        text-transform: uppercase;
                    }
                    
                    .supplier-pie-row {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 10px;
                        border-bottom: 1px solid #f0f0f0;
                    }
                    .supplier-pie-row:last-child { border-bottom: none; }
                    .supplier-color {
                        width: 16px;
                        height: 16px;
                        border-radius: 4px;
                    }
                    .supplier-name { flex: 1; font-weight: 500; }
                    .supplier-rev { font-weight: 600; color: #2e7d32; }
                    .supplier-pct { color: #666; font-size: 12px; width: 50px; text-align: right; }
                </style>
                
                <div class="prod-dash-header">
                    <h2> Product Performance Dashboard</h2>
                    <p>${dateLabel}  Top ${topN} Analysis</p>
                </div>
                
                <div class="prod-kpi-grid">
                    <div class="prod-kpi-card" style="border-top: 4px solid #3b82f6;">
                        <div class="icon"></div>
                        <div class="value">${uniqueProducts}</div>
                        <div class="label">Products Sold</div>
                    </div>
                    <div class="prod-kpi-card" style="border-top: 4px solid #10b981;">
                        <div class="icon"></div>
                        <div class="value">$${totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="label">Total Revenue</div>
                    </div>
                    <div class="prod-kpi-card" style="border-top: 4px solid #8b5cf6;">
                        <div class="icon"></div>
                        <div class="value">$${totalProfit.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="label">Gross Profit</div>
                    </div>
                    <div class="prod-kpi-card" style="border-top: 4px solid #f59e0b;">
                        <div class="icon"></div>
                        <div class="value">${avgMargin.toFixed(1)}%</div>
                        <div class="label">Avg Margin</div>
                    </div>
                    <div class="prod-kpi-card" style="border-top: 4px solid #ec4899;">
                        <div class="icon"></div>
                        <div class="value">${totalUnitsSold.toLocaleString()}</div>
                        <div class="label">Units Sold</div>
                    </div>
                </div>
                
                <div class="prod-section">
                    <h3> Top ${topN} Best Sellers by Revenue</h3>
                    <div class="prod-bar-chart">
                        ${topSellers.map((p, i) => {
                            const barWidth = (p.revenue / maxTopRevenue) * 100;
                            const colors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1', '#14b8a6'];
                            const color = colors[i % colors.length];
                            return `
                                <div class="prod-bar-row">
                                    <div class="prod-bar-label" title="${p.name}">${i + 1}. ${p.name}</div>
                                    <div class="prod-bar-container">
                                        <div class="prod-bar-fill" style="width: ${Math.max(barWidth, 5)}%; background: ${color};">
                                            ${p.qtySold} units
                                        </div>
                                    </div>
                                    <div class="prod-bar-value" style="color: ${color};">${formatMoney(p.revenue)}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>SKU</th>
                                    <th>Product</th>
                                    <th>Supplier</th>
                                    <th style="text-align: right;">Units</th>
                                    <th style="text-align: right;">Revenue</th>
                                    <th style="text-align: right;">Profit</th>
                                    <th style="text-align: right;">Margin</th>
                                    <th style="text-align: center;">Stock</th>
                                    <th style="text-align: center;">Backorder</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${topSellers.map((p, i) => {
                                    let stockIcon = p.qtyOnHand <= 0 ? '' : p.qtyOnHand <= p.reorderPoint ? '' : '';
                                    const backorder = p.qtyOnBackorder || 0;
                                    return `
                                        <tr>
                                            <td><strong>${i + 1}</strong></td>
                                            <td>${p.sku}</td>
                                            <td>${p.name}</td>
                                            <td>${p.supplier}</td>
                                            <td style="text-align: right;"><strong>${p.qtySold.toLocaleString()}</strong></td>
                                            <td style="text-align: right;">${formatMoney(p.revenue)}</td>
                                            <td style="text-align: right; color: ${p.profit >= 0 ? '#2e7d32' : '#c62828'};">${formatMoney(p.profit)}</td>
                                            <td style="text-align: right;">${p.margin.toFixed(1)}%</td>
                                            <td style="text-align: center;">${stockIcon} ${p.qtyOnHand}</td>
                                            <td style="text-align: center; color: ${backorder > 0 ? '#dc2626' : '#666'}; font-weight: ${backorder > 0 ? '600' : 'normal'};">${backorder > 0 ? backorder : '-'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="prod-section">
                    <h3> Top ${topN} Best Sellers - Quick View</h3>
                    <p style="color: #666; font-size: 13px; margin-bottom: 15px;">Your highest performing products - keep these in stock!</p>
                    
                    ${topSellers.length === 0 ? 
                        '<p style="text-align: center; color: #888; padding: 20px;">No sales data found for the selected period</p>' :
                        `<div class="top-seller-grid">
                            ${topSellers.map((p, i) => {
                                const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                                const rankEmoji = i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : '#' + (i + 1);
                                let stockIcon = p.qtyOnHand <= 0 ? '' : p.qtyOnHand <= p.reorderPoint ? '' : '';
                                return `
                                    <div class="top-seller-card">
                                        <div class="rank ${rankClass}">${rankEmoji}</div>
                                        <div class="name">${p.name}</div>
                                        <div class="sku">SKU: ${p.sku}  ${p.supplier}</div>
                                        <div class="stats">
                                            <div class="stat-box">
                                                <div class="stat-value" style="color: #166534;">${p.qtySold.toLocaleString()}</div>
                                                <div class="stat-label">Units Sold</div>
                                            </div>
                                            <div class="stat-box">
                                                <div class="stat-value" style="color: #166534;">${formatMoney(p.revenue)}</div>
                                                <div class="stat-label">Revenue</div>
                                            </div>
                                            <div class="stat-box">
                                                <div class="stat-value" style="color: ${p.margin >= 25 ? '#166534' : p.margin >= 15 ? '#ca8a04' : '#dc2626'};">${p.margin.toFixed(1)}%</div>
                                                <div class="stat-label">Margin</div>
                                            </div>
                                            <div class="stat-box">
                                                <div class="stat-value">${stockIcon} ${p.qtyOnHand}</div>
                                                <div class="stat-label">Stock</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>`
                    }
                </div>
                
                <div class="prod-section">
                    <h3> Bottom ${topN} Sellers (With Inventory)</h3>
                    <p style="color: #666; font-size: 13px; margin-bottom: 15px;">Products that have stock but aren't selling well - consider promotions or markdowns</p>
                    
                    ${productsWithInventory.length === 0 ? 
                        '<p style="text-align: center; color: #888; padding: 20px;">No products with inventory found</p>' :
                        `<div class="bottom-seller-grid">
                            ${productsWithInventory.map(p => `
                                <div class="bottom-seller-card">
                                    <div class="name">${p.name}</div>
                                    <div class="sku">SKU: ${p.sku}  ${p.supplier}</div>
                                    <div class="stats">
                                        <div class="stat-box">
                                            <div class="stat-value" style="color: #c62828;">${p.qtySold}</div>
                                            <div class="stat-label">Units Sold</div>
                                        </div>
                                        <div class="stat-box">
                                            <div class="stat-value" style="color: #f59e0b;">${p.qtyOnHand}</div>
                                            <div class="stat-label">In Stock</div>
                                        </div>
                                        <div class="stat-box">
                                            <div class="stat-value" style="color: #2e7d32;">${formatMoney(p.revenue)}</div>
                                            <div class="stat-label">Revenue</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`
                    }
                </div>
                
                <div class="prod-section">
                    <h3> Sales by Supplier</h3>
                    <div class="prod-bar-chart">
                        ${supplierBreakdown.map((s, i) => {
                            const barWidth = (s.revenue / maxSupplierRevenue) * 100;
                            const pct = totalRevenue > 0 ? (s.revenue / totalRevenue) * 100 : 0;
                            const colors = ['#1565c0', '#00897b', '#43a047', '#f9a825', '#e65100', '#6a1b9a'];
                            const color = colors[i % colors.length];
                            return `
                                <div class="prod-bar-row">
                                    <div class="prod-bar-label">${s.name}</div>
                                    <div class="prod-bar-container">
                                        <div class="prod-bar-fill" style="width: ${Math.max(barWidth, 5)}%; background: ${color};">
                                            ${pct.toFixed(1)}%
                                        </div>
                                    </div>
                                    <div class="prod-bar-value" style="color: ${color};">${formatMoney(s.revenue)}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Supplier</th>
                                    <th style="text-align: right;">Products</th>
                                    <th style="text-align: right;">Units Sold</th>
                                    <th style="text-align: right;">Revenue</th>
                                    <th style="text-align: right;">Profit</th>
                                    <th style="text-align: right;">% of Sales</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${supplierBreakdown.map(s => {
                                    const pct = totalRevenue > 0 ? (s.revenue / totalRevenue) * 100 : 0;
                                    return `
                                        <tr>
                                            <td><strong>${s.name}</strong></td>
                                            <td style="text-align: right;">${s.products}</td>
                                            <td style="text-align: right;">${s.units.toLocaleString()}</td>
                                            <td style="text-align: right;">${formatMoney(s.revenue)}</td>
                                            <td style="text-align: right; color: ${s.profit >= 0 ? '#2e7d32' : '#c62828'};">${formatMoney(s.profit)}</td>
                                            <td style="text-align: right;">${pct.toFixed(1)}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // ==================== CUSTOMER PRESENTATION DASHBOARD ====================
        
        async function generateCustomerDashboardModal() {
            const customerId = reportFilters.customer;
            const fromDate = reportFilters.fromDate ? parseLocalDate(reportFilters.fromDate) : null;
            let toDate = reportFilters.toDate ? parseLocalDate(reportFilters.toDate) : null;
            if (toDate) toDate.setHours(23, 59, 59, 999);
            
            // Fetch all data
            const [salesResult, itemsResult, customersResult] = await Promise.all([
                apiCall('getSalesOrders'),
                apiCall('getItems'),
                apiCall('getCustomers')
            ]);
            
            if (!salesResult?.data || !itemsResult?.data || !customersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            
            // Handle single vs multi-customer selection
            let customerName = 'Customer';
            if (customerId && !customerId.includes(',')) {
                const customer = customersResult.data.find(c => c.Customer_ID === customerId);
                customerName = customer?.Customer_Name || 'Customer';
            } else if (customerId && customerId.includes(',')) {
                const count = customerId.split(',').length;
                customerName = `${count} Customers Selected`;
            } else {
                customerName = 'All Customers';
            }
            
            // Get all sales - use matchesFilter for multi-select support
            let allCustomerSales = salesResult.data;
            if (customerId) {
                allCustomerSales = salesResult.data.filter(s => matchesFilter(s.Customer_ID, customerId));
            }
            
            // Apply date filter if provided
            let filteredSales = allCustomerSales;
            if (fromDate) {
                fromDate.setHours(0, 0, 0, 0);
                filteredSales = filteredSales.filter(s => {
                    const d = parseDate(s.Sale_Date || s.SO_Date);
                    return d && d >= fromDate;
                });
            }
            if (toDate) {
                filteredSales = filteredSales.filter(s => {
                    const d = parseDate(s.Sale_Date || s.SO_Date);
                    return d && d <= toDate;
                });
            }
            
            // Calculate time period stats (regardless of date filter)
            const now = new Date();
            const periods = {
                '1 MONTH': { start: new Date(now.getFullYear(), now.getMonth() - 1, now.getDate()), sales: 0, orders: 0 },
                '3 MONTH': { start: new Date(now.getFullYear(), now.getMonth() - 3, now.getDate()), sales: 0, orders: 0 },
                'YTD': { start: new Date(now.getFullYear(), 0, 1), sales: 0, orders: 0 },
                '1 YEAR': { start: new Date(now.getFullYear() - 1, now.getMonth(), now.getDate()), sales: 0, orders: 0 },
                '3 YEAR': { start: new Date(now.getFullYear() - 3, now.getMonth(), now.getDate()), sales: 0, orders: 0 },
                'ALL TIME': { start: new Date(2000, 0, 1), sales: 0, orders: 0 }
            };
            
            allCustomerSales.forEach(s => {
                const saleDate = parseDate(s.Sale_Date || s.SO_Date);
                const amount = parseFloat(s.Total_Amount) || 0;
                if (saleDate) {
                    Object.keys(periods).forEach(key => {
                        if (saleDate >= periods[key].start) {
                            periods[key].sales += amount;
                            periods[key].orders++;
                        }
                    });
                }
            });
            
            // Get product breakdown for filtered period
            const productSales = {};
            let totalQty = 0, totalSales = 0, totalOrders = filteredSales.length;
            
            for (const so of filteredSales) {
                totalSales += parseFloat(so.Total_Amount) || 0;
                
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const qty = parseInt(line.Quantity) || 0;
                        totalQty += qty;
                        
                        // Calculate line total (Line_Total may not exist in data)
                        const unitPrice = parseFloat(line.Unit_Price) || 0;
                        const lineTotal = qty * unitPrice;
                        
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const itemId = line.Item_ID;
                        if (!productSales[itemId]) {
                            productSales[itemId] = {
                                name: item?.Item_Description || itemId,
                                sku: item?.SKU || '-',
                                qty: 0,
                                sales: 0
                            };
                        }
                        productSales[itemId].qty += qty;
                        productSales[itemId].sales += lineTotal;
                    });
                }
            }
            
            const topProducts = Object.values(productSales).sort((a, b) => b.sales - a.sales).slice(0, 5);
            const avgOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;
            
            // Period colors matching the reference image
            const periodColors = ['#2196F3', '#9C27B0', '#FF9800', '#f44336', '#4CAF50', '#607D8B'];
            
            // Date range label
            let dateLabel = 'All Time';
            if (fromDate && toDate) {
                dateLabel = `${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`;
            } else if (fromDate) {
                dateLabel = `Since ${fromDate.toLocaleDateString()}`;
            } else if (toDate) {
                dateLabel = `Through ${toDate.toLocaleDateString()}`;
            }
            
            let html = `
                <style>
                    .pres-header {
                        padding: 35px;
                        background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
                        color: white;
                        border-radius: 16px;
                        margin-bottom: 30px;
                        box-shadow: 0 10px 30px rgba(46, 125, 50, 0.3), 0 4px 12px rgba(0,0,0,0.1);
                        border: 2px solid rgba(255, 255, 255, 0.1);
                    }
                    .pres-header h2 {
                        margin: 0 0 10px 0;
                        font-size: 32px;
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    }
                    .pres-header p {
                        margin: 0;
                        font-size: 16px;
                        opacity: 0.95;
                    }
                    .period-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                        gap: 12px;
                        margin-bottom: 25px;
                    }
                    .period-card {
                        background: white;
                        border-radius: 10px;
                        padding: 15px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        border-left: 4px solid #2e7d32;
                        transition: transform 0.2s;
                    }
                    .period-card:hover {
                        transform: translateY(-3px);
                        box-shadow: 0 4px 15px rgba(0,0,0,0.12);
                    }
                    .period-label {
                        font-size: 11px;
                        font-weight: 600;
                        text-transform: uppercase;
                        margin-bottom: 8px;
                    }
                    .period-value {
                        font-size: 26px;
                        font-weight: bold;
                        color: #333;
                    }
                    .period-sub {
                        font-size: 11px;
                        color: #888;
                        margin-top: 4px;
                    }
                    .section-title {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        margin: 25px 0 15px 0;
                        padding-bottom: 10px;
                        border-bottom: 2px solid #e0e0e0;
                    }
                    .section-title h3 {
                        margin: 0;
                        color: #333;
                    }
                    .summary-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    .summary-card {
                        background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
                        border-radius: 10px;
                        padding: 20px;
                        text-align: center;
                    }
                    .summary-card .label {
                        font-size: 12px;
                        color: #666;
                        text-transform: uppercase;
                    }
                    .summary-card .value {
                        font-size: 32px;
                        font-weight: bold;
                        color: #2e7d32;
                        margin: 5px 0;
                    }
                    .product-row {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 15px;
                        background: white;
                        border-radius: 8px;
                        margin-bottom: 8px;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                    }
                    .product-rank {
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 14px;
                        margin-right: 15px;
                        color: white;
                    }
                    .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); }
                    .rank-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
                    .rank-3 { background: linear-gradient(135deg, #CD7F32, #8B4513); }
                    .rank-other { background: #9e9e9e; }
                </style>
                
                <div class="pres-header">
                    <h2> ${customerName}</h2>
                    <p>Sales Performance Report</p>
                </div>
                
                <div class="section-title">
                    <span style="font-size: 20px;"></span>
                    <h3>Sales by Time Period</h3>
                </div>
                <p style="color: #666; margin: -10px 0 15px 0; font-size: 13px;">Click any tile to see detailed breakdown</p>
                
                <div class="period-grid">
                    ${Object.entries(periods).map(([label, data], i) => `
                        <div class="period-card" style="border-color: ${periodColors[i]};">
                            <div class="period-label" style="color: ${periodColors[i]};">${label}</div>
                            <div class="period-value">$${data.sales.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div class="period-sub">${data.orders} order${data.orders !== 1 ? 's' : ''}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="section-title">
                    <span style="font-size: 20px;"></span>
                    <h3>Selected Period Summary</h3>
                    <span style="color: #666; font-size: 13px; margin-left: auto;">${dateLabel}</span>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="label">Total Sales</div>
                        <div class="value">${formatMoney(totalSales)}</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">Orders</div>
                        <div class="value" style="color: #1565c0;">${totalOrders}</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">Units Purchased</div>
                        <div class="value" style="color: #7b1fa2;">${totalQty.toLocaleString()}</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">Avg Order Value</div>
                        <div class="value" style="color: #e65100;">${formatMoney(avgOrderValue)}</div>
                    </div>
                </div>
                
                <div class="section-title">
                    <span style="font-size: 20px;"></span>
                    <h3>Top Products Purchased</h3>
                </div>
                
                ${topProducts.length === 0 ? '<p style="color: #888; text-align: center; padding: 20px;">No purchases in selected period</p>' : ''}
                ${topProducts.map((p, i) => `
                    <div class="product-row">
                        <div style="display: flex; align-items: center;">
                            <div class="product-rank ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other'}">${i + 1}</div>
                            <div>
                                <div style="font-weight: 600;">${p.name}</div>
                                <div style="font-size: 12px; color: #888;">${p.qty} units  SKU: ${p.sku}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: bold; color: #2e7d32;">${formatMoney(p.sales)}</div>
                        </div>
                    </div>
                `).join('')}
            `;
            
            return html;
        }
        
        // ==================== SUPPLIER PRESENTATION DASHBOARD ====================
        
        async function generateSupplierDashboardModal() {
            const supplierId = reportFilters.supplier;
            const fromDate = reportFilters.fromDate ? parseLocalDate(reportFilters.fromDate) : null;
            let toDate = reportFilters.toDate ? parseLocalDate(reportFilters.toDate) : null;
            if (toDate) toDate.setHours(23, 59, 59, 999);
            
            // Fetch all data
            const [poResult, itemsResult, suppliersResult] = await Promise.all([
                apiCall('getPurchaseOrders'),
                apiCall('getItems'),
                apiCall('getSuppliers')
            ]);
            
            if (!poResult?.data || !itemsResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const supplier = suppliersResult.data.find(s => s.Supplier_ID === supplierId);
            const supplierName = supplier?.Supplier_Name || 'Supplier';
            
            // Get all POs for this supplier (exclude OUTGOING)
            let allSupplierPOs = poResult.data.filter(p => p.Supplier_ID === supplierId && p.PO_Type !== 'OUTGOING');
            
            // Apply date filter if provided
            let filteredPOs = allSupplierPOs;
            if (fromDate) {
                fromDate.setHours(0, 0, 0, 0);
                filteredPOs = filteredPOs.filter(p => {
                    const d = parseDate(p.PO_Date);
                    return d && d >= fromDate;
                });
            }
            if (toDate) {
                filteredPOs = filteredPOs.filter(p => {
                    const d = parseDate(p.PO_Date);
                    return d && d <= toDate;
                });
            }
            
            // Calculate time period stats
            const now = new Date();
            const periods = {
                '1 MONTH': { start: new Date(now.getFullYear(), now.getMonth() - 1, now.getDate()), purchases: 0, orders: 0 },
                '3 MONTH': { start: new Date(now.getFullYear(), now.getMonth() - 3, now.getDate()), purchases: 0, orders: 0 },
                'YTD': { start: new Date(now.getFullYear(), 0, 1), purchases: 0, orders: 0 },
                '1 YEAR': { start: new Date(now.getFullYear() - 1, now.getMonth(), now.getDate()), purchases: 0, orders: 0 },
                '3 YEAR': { start: new Date(now.getFullYear() - 3, now.getMonth(), now.getDate()), purchases: 0, orders: 0 },
                'ALL TIME': { start: new Date(2000, 0, 1), purchases: 0, orders: 0 }
            };
            
            allSupplierPOs.forEach(p => {
                const poDate = parseDate(p.PO_Date);
                const amount = parseFloat(p.Total_Amount) || 0;
                if (poDate) {
                    Object.keys(periods).forEach(key => {
                        if (poDate >= periods[key].start) {
                            periods[key].purchases += amount;
                            periods[key].orders++;
                        }
                    });
                }
            });
            
            // Get product breakdown for filtered period
            const productPurchases = {};
            let totalQty = 0, totalPurchases = 0, totalOrders = filteredPOs.length;
            let totalPaid = 0;
            
            for (const po of filteredPOs) {
                totalPurchases += parseFloat(po.Total_Amount) || 0;
                totalPaid += parseFloat(po.Amount_Paid) || 0;
                
                const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const qty = parseInt(line.Quantity) || 0;
                        totalQty += qty;
                        
                        // Calculate line total from qty * cost (Line_Total may not exist)
                        const unitCost = parseFloat(line.Unit_Cost) || 0;
                        const lineTotal = qty * unitCost;
                        
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const itemId = line.Item_ID;
                        if (!productPurchases[itemId]) {
                            productPurchases[itemId] = {
                                name: item?.Item_Description || itemId,
                                sku: item?.SKU || '-',
                                qty: 0,
                                cost: 0
                            };
                        }
                        productPurchases[itemId].qty += qty;
                        productPurchases[itemId].cost += lineTotal;
                    });
                }
            }
            
            const topProducts = Object.values(productPurchases).sort((a, b) => b.cost - a.cost).slice(0, 5);
            const avgOrderValue = totalOrders > 0 ? totalPurchases / totalOrders : 0;
            
            // Period colors
            const periodColors = ['#1565c0', '#0097a7', '#00897b', '#43a047', '#7cb342', '#afb42b'];
            
            // Date range label
            let dateLabel = 'All Time';
            if (fromDate && toDate) {
                dateLabel = `${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`;
            } else if (fromDate) {
                dateLabel = `Since ${fromDate.toLocaleDateString()}`;
            } else if (toDate) {
                dateLabel = `Through ${toDate.toLocaleDateString()}`;
            }
            
            let html = `
                <style>
                    .pres-header-supplier {
                        padding: 35px;
                        background: linear-gradient(135deg, #1565c0 0%, #42a5f5 100%);
                        color: white;
                        border-radius: 16px;
                        margin-bottom: 30px;
                        box-shadow: 0 10px 30px rgba(21, 101, 192, 0.3), 0 4px 12px rgba(0,0,0,0.1);
                        border: 2px solid rgba(255, 255, 255, 0.1);
                    }
                    .pres-header-supplier h2 {
                        margin: 0 0 10px 0;
                        font-size: 32px;
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    }
                    .pres-header-supplier p {
                        margin: 0;
                        font-size: 16px;
                        opacity: 0.95;
                    }
                    .period-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                        gap: 12px;
                        margin-bottom: 25px;
                    }
                    .period-card {
                        background: white;
                        border-radius: 10px;
                        padding: 15px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        border-left: 4px solid #1565c0;
                        transition: transform 0.2s;
                    }
                    .period-card:hover {
                        transform: translateY(-3px);
                        box-shadow: 0 4px 15px rgba(0,0,0,0.12);
                    }
                    .period-label {
                        font-size: 11px;
                        font-weight: 600;
                        text-transform: uppercase;
                        margin-bottom: 8px;
                    }
                    .period-value {
                        font-size: 26px;
                        font-weight: bold;
                        color: #333;
                    }
                    .period-sub {
                        font-size: 11px;
                        color: #888;
                        margin-top: 4px;
                    }
                    .section-title {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        margin: 25px 0 15px 0;
                        padding-bottom: 10px;
                        border-bottom: 2px solid #e0e0e0;
                    }
                    .section-title h3 {
                        margin: 0;
                        color: #333;
                    }
                    .summary-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    .summary-card-blue {
                        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
                        border-radius: 10px;
                        padding: 20px;
                        text-align: center;
                    }
                    .summary-card-blue .label {
                        font-size: 12px;
                        color: #1565c0;
                        text-transform: uppercase;
                        font-weight: 600;
                    }
                    .summary-card-blue .value {
                        font-size: 28px;
                        font-weight: bold;
                        color: #0d47a1;
                        margin: 5px 0;
                    }
                    .product-row {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 15px;
                        background: white;
                        border-radius: 8px;
                        margin-bottom: 8px;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                    }
                    .product-rank {
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 14px;
                        margin-right: 15px;
                        color: white;
                    }
                    .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); }
                    .rank-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
                    .rank-3 { background: linear-gradient(135deg, #CD7F32, #8B4513); }
                    .rank-other { background: #9e9e9e; }
                    .partnership-box {
                        background: linear-gradient(135deg, #1a237e, #283593);
                        color: white;
                        padding: 25px;
                        border-radius: 12px;
                        text-align: center;
                        margin-top: 25px;
                    }
                    .partnership-box h3 {
                        margin: 0 0 15px 0;
                        font-size: 18px;
                    }
                    .partnership-value {
                        font-size: 42px;
                        font-weight: bold;
                    }
                    .partnership-label {
                        font-size: 14px;
                        opacity: 0.9;
                        margin-top: 5px;
                    }
                </style>
                
                <div class="pres-header-supplier">
                    <h2> ${supplierName}</h2>
                    <p>Partnership Performance Report</p>
                </div>
                
                <div class="section-title">
                    <span style="font-size: 20px;"></span>
                    <h3>Purchase Volume by Time Period</h3>
                </div>
                <p style="color: #666; margin: -10px 0 15px 0; font-size: 13px;">Our business relationship over time</p>
                
                <div class="period-grid">
                    ${Object.entries(periods).map(([label, data], i) => `
                        <div class="period-card" style="border-color: ${periodColors[i]};">
                            <div class="period-label" style="color: ${periodColors[i]};">${label}</div>
                            <div class="period-value">$${data.purchases.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div class="period-sub">${data.orders} PO${data.orders !== 1 ? 's' : ''}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="section-title">
                    <span style="font-size: 20px;"></span>
                    <h3>Selected Period Details</h3>
                    <span style="color: #666; font-size: 13px; margin-left: auto;">${dateLabel}</span>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-card-blue">
                        <div class="label">Total Purchases</div>
                        <div class="value">${formatMoney(totalPurchases)}</div>
                    </div>
                    <div class="summary-card-blue">
                        <div class="label">Purchase Orders</div>
                        <div class="value">${totalOrders}</div>
                    </div>
                    <div class="summary-card-blue">
                        <div class="label">Units Ordered</div>
                        <div class="value">${totalQty.toLocaleString()}</div>
                    </div>
                    <div class="summary-card-blue">
                        <div class="label">Avg PO Value</div>
                        <div class="value">${formatMoney(avgOrderValue)}</div>
                    </div>
                    <div class="summary-card-blue">
                        <div class="label">Amount Paid</div>
                        <div class="value" style="color: #2e7d32;">${formatMoney(totalPaid)}</div>
                    </div>
                </div>
                
                <div class="section-title">
                    <span style="font-size: 20px;"></span>
                    <h3>Top Products Ordered</h3>
                </div>
                
                ${topProducts.length === 0 ? '<p style="color: #888; text-align: center; padding: 20px;">No purchases in selected period</p>' : ''}
                ${topProducts.map((p, i) => `
                    <div class="product-row">
                        <div style="display: flex; align-items: center;">
                            <div class="product-rank ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other'}">${i + 1}</div>
                            <div>
                                <div style="font-weight: 600;">${p.name}</div>
                                <div style="font-size: 12px; color: #888;">${p.qty} units  SKU: ${p.sku}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: bold; color: #1565c0;">${formatMoney(p.cost)}</div>
                        </div>
                    </div>
                `).join('')}
                
                <div class="partnership-box">
                    <h3> Total Partnership Value</h3>
                    <div class="partnership-value">$${periods['ALL TIME'].purchases.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div class="partnership-label">${periods['ALL TIME'].orders} purchase orders  All Time</div>
                </div>
            `;
            
            return html;
        }
        
        // 1. SALES BY CUSTOMER REPORT
        async function generateSalesByCustomer() {
            const salesResult = await apiCall('getSalesOrders');
            const customersResult = await apiCall('getCustomers');
            const itemsResult = await apiCall('getItems');
            
            if (!salesResult?.data || !customersResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const customers = customersResult.data;
            const items = itemsResult.data;
            let sales = salesResult.data;
            
            // Fetch ALL sales order lines with their SO info
            const allDetails = [];
            for (const so of sales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const unitsPerPackage = parseFloat(item?.Units_Per_Package) || 1;
                        const packageCost = parseFloat(item?.Package_Cost) || 0;
                        const unitCost = packageCost / unitsPerPackage;
                        const quantity = parseInt(line.Quantity || 0);
                        const unitPrice = parseFloat(line.Unit_Price || 0);
                        // Calculate line total from qty * price (Line_Total may not exist)
                        const lineTotal = quantity * unitPrice;
                        const lineCost = quantity * unitCost;
                        
                        allDetails.push({
                            soId: so.SO_ID,
                            soDate: so.Sale_Date || so.SO_Date,
                            customerId: so.Customer_ID,
                            customerName: getCustomerName(so.Customer_ID),
                            itemId: line.Item_ID,
                            itemDescription: item?.Item_Description || line.Item_ID,
                            quantity: quantity,
                            unitsPerPackage: unitsPerPackage,
                            unitPrice: unitPrice,
                            unitCost: unitCost,
                            lineTotal: lineTotal,
                            lineCost: lineCost,
                            lineProfit: lineTotal - lineCost,
                            paymentStatus: so.Payment_Status || 'Unknown'
                        });
                    });
                }
            }
            
            // Store raw data
            rawReportData['sales-by-customer'] = { sales, customers, items, allDetails };
            
            // APPLY FILTERS
            let filtered = allDetails;
            if (reportFilters.fromDate) {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                filtered = filtered.filter(d => new Date(d.soDate) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = parseLocalDate(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                filtered = filtered.filter(d => new Date(d.soDate) <= toDate);
            }
            if (reportFilters.customer) {
                filtered = filtered.filter(d => matchesFilter(d.customerId, reportFilters.customer));
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(d => d.lineTotal >= reportFilters.minAmount);
            }
            
            // GROUP BY CUSTOMER and calculate totals
            const customerSummary = {};
            filtered.forEach(detail => {
                if (!customerSummary[detail.customerId]) {
                    customerSummary[detail.customerId] = {
                        customerId: detail.customerId,
                        customerName: detail.customerName,
                        totalCases: 0,
                        totalUnits: 0,
                        totalRevenue: 0,
                        totalCost: 0,
                        totalProfit: 0
                    };
                }
                
                const summary = customerSummary[detail.customerId];
                // Calculate cases (divide units by units per package)
                const cases = detail.quantity / detail.unitsPerPackage;
                summary.totalCases += cases;
                summary.totalUnits += detail.quantity;
                summary.totalRevenue += detail.lineTotal;
                summary.totalCost += detail.lineCost;
                summary.totalProfit += detail.lineProfit;
            });
            
            // Convert to array and calculate margin %
            const summaryArray = Object.values(customerSummary).map(s => ({
                ...s,
                marginPercent: s.totalRevenue > 0 ? (s.totalProfit / s.totalRevenue) * 100 : 0
            }));
            
            // Sort by total revenue (highest first)
            summaryArray.sort((a, b) => b.totalRevenue - a.totalRevenue);
            
            // Calculate grand totals
            const grandTotalRevenue = summaryArray.reduce((sum, s) => sum + s.totalRevenue, 0);
            const grandTotalCost = summaryArray.reduce((sum, s) => sum + s.totalCost, 0);
            const grandTotalProfit = summaryArray.reduce((sum, s) => sum + s.totalProfit, 0);
            const grandTotalCases = summaryArray.reduce((sum, s) => sum + s.totalCases, 0);
            const grandTotalUnits = summaryArray.reduce((sum, s) => sum + s.totalUnits, 0);
            const grandMargin = grandTotalRevenue > 0 ? (grandTotalProfit / grandTotalRevenue) * 100 : 0;
            
            // Build customer list for filter
            const customerList = customers.map(c => ({ id: c.Customer_ID, name: c.Customer_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('sales-by-customer', {
                dateRange: true,
                dateLabel: 'Sale Date',
                customer: true,
                customerList: customerList,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3> Sales by Customer Summary</h3>
                    <p style="color: #666;">Total Customers: ${summaryArray.length} | Total Revenue: ${formatMoney(grandTotalRevenue)} | Total Profit: ${formatMoney(grandTotalProfit)} | Gross Margin: ${grandMargin.toFixed(1)}%</p>
                </div>`;
            
            if (summaryArray.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table" id="salesByCustomerTable">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Total Cases</th>
                            <th>Total Units</th>
                            <th>Total Revenue</th>
                            <th>Total Cost</th>
                            <th>Total Profit</th>
                            <th>Gross Margin %</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                summaryArray.forEach(summary => {
                    const marginColor = summary.marginPercent >= 30 ? '#2e7d32' : summary.marginPercent >= 20 ? '#f57c00' : '#c62828';
                    html += `<tr style="cursor: pointer;" onclick="openCustomer('${summary.customerId}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td><strong style="color: #667eea;">${summary.customerName}</strong></td>
                        <td>${summary.totalCases.toFixed(1)}</td>
                        <td>${Math.round(summary.totalUnits).toLocaleString()}</td>
                        <td><strong>${formatMoney(summary.totalRevenue)}</strong></td>
                        <td>${formatMoney(summary.totalCost)}</td>
                        <td style="color: ${summary.totalProfit >= 0 ? 'green' : 'red'};"><strong>${formatMoney(summary.totalProfit)}</strong></td>
                        <td style="color: ${marginColor}; font-weight: bold;">${summary.marginPercent.toFixed(1)}%</td>
                    </tr>`;
                });
                
                // Add totals row
                html += `<tr style="background: #f0f0f0; font-weight: bold; border-top: 3px solid #667eea;">
                    <td style="text-align: right; padding-right: 20px;">TOTALS:</td>
                    <td>${grandTotalCases.toFixed(1)}</td>
                    <td>${Math.round(grandTotalUnits).toLocaleString()}</td>
                    <td><strong>${formatMoney(grandTotalRevenue)}</strong></td>
                    <td>${formatMoney(grandTotalCost)}</td>
                    <td style="color: ${grandTotalProfit >= 0 ? 'green' : 'red'};"><strong>${formatMoney(grandTotalProfit)}</strong></td>
                    <td style="color: ${grandMargin >= 30 ? '#2e7d32' : grandMargin >= 20 ? '#f57c00' : '#c62828'}; font-weight: bold;">${grandMargin.toFixed(1)}%</td>
                </tr>`;
            
                html += '</tbody></table>';
            }
            
            reportData['sales-by-customer'] = summaryArray;
            document.getElementById('reportContainer').innerHTML = html;
            setTimeout(() => makeSortable('salesByCustomerTable'), 0);
        }
        
        // SALES ORDER DETAIL REPORT (NEW!)
        async function generateSalesOrderDetail() {
            const salesResult = await apiCall('getSalesOrders');
            const customersResult = await apiCall('getCustomers');
            const itemsResult = await apiCall('getItems');
            
            if (!salesResult?.data || !customersResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const customers = customersResult.data;
            const items = itemsResult.data;
            let sales = salesResult.data;
            
            // Fetch ALL sales order lines with their SO info
            const allDetails = [];
            for (const so of sales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const quantity = parseInt(line.Quantity || 0);
                        const unitPrice = parseFloat(line.Unit_Price || 0);
                        // Calculate line total from qty * price (Line_Total may not exist)
                        const lineTotal = quantity * unitPrice;
                        allDetails.push({
                            soId: so.SO_ID,
                            soDate: so.Sale_Date || so.SO_Date,
                            customerId: so.Customer_ID,
                            customerName: getCustomerName(so.Customer_ID),
                            itemId: line.Item_ID,
                            itemDescription: item?.Item_Description || line.Item_ID,
                            sku: item?.SKU || '',
                            quantity: quantity,
                            unitPrice: unitPrice,
                            lineTotal: lineTotal,
                            paymentStatus: so.Payment_Status || 'Unknown',
                            status: so.Status || 'Completed'
                        });
                    });
                }
            }
            
            // Store raw data
            rawReportData['sales-order-detail'] = { sales, customers, items, allDetails };
            
            // APPLY FILTERS
            let filtered = allDetails;
            if (reportFilters.fromDate) {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                filtered = filtered.filter(d => new Date(d.soDate) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = parseLocalDate(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                filtered = filtered.filter(d => new Date(d.soDate) <= toDate);
            }
            if (reportFilters.customer) {
                filtered = filtered.filter(d => matchesFilter(d.customerId, reportFilters.customer));
            }
            if (reportFilters.item) {
                filtered = filtered.filter(d => matchesFilter(d.itemId, reportFilters.item));
            }
            if (reportFilters.paymentStatus) {
                filtered = filtered.filter(d => d.paymentStatus === reportFilters.paymentStatus);
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(d => d.lineTotal >= reportFilters.minAmount);
            }
            
            // Sort by date (newest first), then by SO ID
            filtered.sort((a, b) => {
                const dateCompare = new Date(b.soDate) - new Date(a.soDate);
                if (dateCompare !== 0) return dateCompare;
                return b.soId.localeCompare(a.soId);
            });
            
            // Calculate totals
            const totalSales = filtered.reduce((sum, d) => sum + d.lineTotal, 0);
            const totalOrders = new Set(filtered.map(d => d.soId)).size;
            
            // Build lists for filters
            const customerList = customers.map(c => ({ id: c.Customer_ID, name: c.Customer_Name }));
            const itemList = items.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            
            // Build HTML with filters
            let html = buildFilterUI('sales-order-detail', {
                dateRange: true,
                dateLabel: 'Sale Date',
                customer: true,
                customerList: customerList,
                item: true,
                itemList: itemList,
                paymentStatus: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3> Sales Order Detail Report</h3>
                    <p style="color: #666;">Total Orders: ${totalOrders} | Total Lines: ${filtered.length} | Total Sales: ${formatMoney(totalSales)}</p>
                </div>`;
            
            if (filtered.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table" id="salesOrderDetailTable">
                    <thead>
                        <tr>
                            <th>SO #</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Item</th>
                            <th>SKU</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Payment</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                filtered.forEach(detail => {
                    const dateObj = parseDate(detail.soDate);
                    const sortableDate = dateObj ? dateObj.toISOString().split('T')[0] : ''; // YYYY-MM-DD for sorting
                    html += `<tr style="cursor: pointer;" onclick="openSalesOrder('${detail.soId}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td><strong style="color: #667eea;">${detail.soId}</strong></td>
                        <td data-sort="${sortableDate}">${formatDateSafe(detail.soDate)}</td>
                        <td style="color: #667eea;">${detail.customerName}</td>
                        <td style="color: #667eea;">${detail.itemDescription}</td>
                        <td>${detail.sku}</td>
                        <td>${detail.quantity}</td>
                        <td>${formatMoney(detail.unitPrice)}</td>
                        <td>${formatMoney(detail.lineTotal)}</td>
                        <td>${detail.status}</td>
                        <td><span style="color: ${detail.paymentStatus === 'Paid' ? 'green' : detail.paymentStatus === 'Partial' ? 'orange' : 'red'};">${detail.paymentStatus}</span></td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['sales-order-detail'] = filtered;
            document.getElementById('reportContainer').innerHTML = html;
            setTimeout(() => makeSortable('salesOrderDetailTable'), 0);
        }
        
        // 2. SALES BY PRODUCT REPORT
        async function generateSalesByProduct() {
            const itemsResult = await apiCall('getItems');
            const suppliersResult = await apiCall('getSuppliers');
            const salesResult = await apiCall('getSalesOrders');
            
            if (!itemsResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const suppliers = suppliersResult.data;
            let sales = salesResult?.data || [];
            
            // Fetch ALL sales order lines to get units sold
            const allLines = [];
            for (const so of sales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        line.SO_Date = so.Sale_Date || so.SO_Date;
                        // Calculate line total (Line_Total may not exist in API response)
                        const qty = parseInt(line.Quantity || 0);
                        const unitPrice = parseFloat(line.Unit_Price || 0);
                        line.Line_Total = qty * unitPrice;
                        allLines.push(line);
                    });
                }
            }
            
            // APPLY DATE FILTERS to sales lines
            let filteredLines = allLines;
            if (reportFilters.fromDate) {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                filteredLines = filteredLines.filter(line => new Date(line.SO_Date) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = parseLocalDate(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                filteredLines = filteredLines.filter(line => new Date(line.SO_Date) <= toDate);
            }
            
            // Calculate units sold per item
            const unitsSoldByItem = {};
            filteredLines.forEach(line => {
                const itemId = line.Item_ID;
                unitsSoldByItem[itemId] = (unitsSoldByItem[itemId] || 0) + parseInt(line.Quantity || 0);
            });
            
            // Build product list with margins - INCLUDE ALL ITEMS
            const productData = items.map(item => {
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitCost = packageCost / unitsPerPackage;
                const unitSellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const margin = unitSellPrice - unitCost;
                const marginPercent = unitSellPrice > 0 ? (margin / unitSellPrice) * 100 : 0;
                const unitsSold = unitsSoldByItem[item.Item_ID] || 0;
                const totalProfit = unitsSold * margin;
                
                return {
                    id: item.Item_ID,
                    description: item.Item_Description || '',
                    sku: item.SKU || '',
                    supplierId: item.Supplier_ID || '',
                    unitCost: unitCost,
                    unitSellPrice: unitSellPrice,
                    margin: margin,
                    marginPercent: marginPercent,
                    unitsSold: unitsSold,
                    totalProfit: totalProfit
                };
            });
            
            // Store raw data
            rawReportData['sales-by-product'] = { items, suppliers, productData };
            
            // APPLY FILTERS
            let filtered = productData;
            
            if (reportFilters.item) {
                filtered = filtered.filter(p => matchesFilter(p.id, reportFilters.item));
            }
            if (reportFilters.supplier) {
                filtered = filtered.filter(p => matchesFilter(p.supplierId, reportFilters.supplier));
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(p => p.margin >= reportFilters.minAmount);
            }
            
            // Sort by margin % (highest first)
            const sorted = filtered.sort((a, b) => b.marginPercent - a.marginPercent);
            
            // Build filter lists
            const itemList = items.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('sales-by-product', {
                dateRange: false, // Remove date filter - this is about pricing, not sales history
                item: true,
                itemList: itemList,
                supplier: true,
                supplierList: supplierList,
                minAmount: true,
                amountLabel: 'Min Margin ($)'
            });
            
            // Calculate totals
            const avgMarginPercent = sorted.length > 0 
                ? sorted.reduce((sum, p) => sum + p.marginPercent, 0) / sorted.length 
                : 0;
            const totalPotentialProfit = sorted.reduce((sum, p) => sum + p.totalProfit, 0);
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3> Sales by Item - Pricing & Margin Analysis</h3>
                    <p style="color: #666;">Total Items: ${sorted.length} | Average Margin: ${avgMarginPercent.toFixed(1)}% | Total Profit (from sales): ${formatMoney(totalPotentialProfit)}</p>
                    
                </div>`;
            
            if (sorted.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table" id="salesByProductTable">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>SKU</th>
                            <th>Cost</th>
                            <th>Sell</th>
                            <th>Margin</th>
                            <th>Margin %</th>
                            <th>Units Sold</th>
                            <th>Total Profit</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                sorted.forEach(product => {
                    const marginColor = product.marginPercent >= 30 ? '#2e7d32' : product.marginPercent >= 20 ? '#f57c00' : '#c62828';
                    html += `<tr style="cursor: pointer;" onclick="openItem('${product.id}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td><strong style="color: #667eea;">${product.description}</strong></td>
                        <td>${product.sku}</td>
                        <td>${formatMoney(product.unitCost)}</td>
                        <td>${formatMoney(product.unitSellPrice)}</td>
                        <td style="color: ${product.margin >= 0 ? 'green' : 'red'};">${formatMoney(product.margin)}</td>
                        <td style="color: ${marginColor}; font-weight: bold;">${product.marginPercent.toFixed(1)}%</td>
                        <td>${product.unitsSold.toLocaleString()}</td>
                        <td style="color: ${product.totalProfit >= 0 ? 'green' : 'red'};"><strong>${formatMoney(product.totalProfit)}</strong></td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['sales-by-product'] = sorted;
            document.getElementById('reportContainer').innerHTML = html;
            setTimeout(() => makeSortable('salesByProductTable'), 0);
        }
        
        // PURCHASE ORDER DETAIL REPORT (NEW!)
        async function generatePurchaseOrderDetail() {
            const purchasesResult = await apiCall('getPurchaseOrders');
            const suppliersResult = await apiCall('getSuppliers');
            const itemsResult = await apiCall('getItems');
            
            if (!purchasesResult?.data || !suppliersResult?.data || !itemsResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            const items = itemsResult.data;
            let purchases = purchasesResult.data;
            
            // Fetch ALL purchase order lines with their PO info
            const allDetails = [];
            for (const po of purchases) {
                const linesResult = await apiCall('getPurchaseOrderLines', { poId: po.PO_ID });
                if (linesResult?.data) {
                    linesResult.data.forEach(line => {
                        const item = items.find(i => i.Item_ID === line.Item_ID);
                        const quantity = parseInt(line.Quantity || 0);
                        const unitCost = parseFloat(line.Unit_Cost || 0);
                        // Calculate line total from qty * cost (Line_Total may not exist)
                        const lineTotal = quantity * unitCost;
                        allDetails.push({
                            poId: po.PO_ID,
                            poDate: po.PO_Date,
                            supplierId: po.Supplier_ID,
                            supplierName: getSupplierName(po.Supplier_ID),
                            itemId: line.Item_ID,
                            itemDescription: item?.Item_Description || line.Item_ID,
                            sku: item?.SKU || '',
                            quantity: quantity,
                            unitCost: unitCost,
                            lineTotal: lineTotal,
                            paymentStatus: po.Payment_Status || 'Unknown',
                            status: po.Status || 'Received'
                        });
                    });
                }
            }
            
            // Store raw data
            rawReportData['purchase-order-detail'] = { purchases, suppliers, items, allDetails };
            
            // APPLY FILTERS
            let filtered = allDetails;
            if (reportFilters.fromDate) {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                filtered = filtered.filter(d => new Date(d.poDate) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = parseLocalDate(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                filtered = filtered.filter(d => new Date(d.poDate) <= toDate);
            }
            if (reportFilters.supplier) {
                filtered = filtered.filter(d => matchesFilter(d.supplierId, reportFilters.supplier));
            }
            if (reportFilters.item) {
                filtered = filtered.filter(d => matchesFilter(d.itemId, reportFilters.item));
            }
            if (reportFilters.paymentStatus) {
                filtered = filtered.filter(d => d.paymentStatus === reportFilters.paymentStatus);
            }
            if (reportFilters.minAmount) {
                filtered = filtered.filter(d => d.lineTotal >= reportFilters.minAmount);
            }
            
            // Sort by date (newest first), then by PO ID
            filtered.sort((a, b) => {
                const dateCompare = new Date(b.poDate) - new Date(a.poDate);
                if (dateCompare !== 0) return dateCompare;
                return b.poId.localeCompare(a.poId);
            });
            
            // Calculate totals
            const totalPurchases = filtered.reduce((sum, d) => sum + d.lineTotal, 0);
            const totalOrders = new Set(filtered.map(d => d.poId)).size;
            
            // Build lists for filters
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            const itemList = items.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            
            // Build HTML with filters
            let html = buildFilterUI('purchase-order-detail', {
                dateRange: true,
                dateLabel: 'Purchase Date',
                supplier: true,
                supplierList: supplierList,
                item: true,
                itemList: itemList,
                paymentStatus: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3> Purchase Order Detail Report</h3>
                    <p style="color: #666;">Total Orders: ${totalOrders} | Total Lines: ${filtered.length} | Total Purchases: ${formatMoney(totalPurchases)}</p>
                    
                </div>`;
            
            if (filtered.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table" id="purchaseOrderDetailTable">
                    <thead>
                        <tr>
                            <th>PO #</th>
                            <th>Date</th>
                            <th>Supplier</th>
                            <th>Item</th>
                            <th>SKU</th>
                            <th>Qty</th>
                            <th>Cost</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Payment</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                filtered.forEach(detail => {
                    const dateObj = new Date(detail.poDate);
                    const sortableDate = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD for sorting
                    html += `<tr style="cursor: pointer;" onclick="openPurchaseOrder('${detail.poId}')" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                        <td><strong style="color: #667eea;">${detail.poId}</strong></td>
                        <td data-sort="${sortableDate}">${dateObj.toLocaleDateString()}</td>
                        <td style="color: #667eea;">${detail.supplierName}</td>
                        <td style="color: #667eea;">${detail.itemDescription}</td>
                        <td>${detail.sku}</td>
                        <td>${detail.quantity}</td>
                        <td>${formatMoney(detail.unitCost)}</td>
                        <td>${formatMoney(detail.lineTotal)}</td>
                        <td>${detail.status}</td>
                        <td><span style="color: ${detail.paymentStatus === 'Paid' ? 'green' : detail.paymentStatus === 'Partial' ? 'orange' : 'red'};">${detail.paymentStatus}</span></td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['purchase-order-detail'] = filtered;
            document.getElementById('reportContainer').innerHTML = html;
            setTimeout(() => makeSortable('purchaseOrderDetailTable'), 0);
        }
        
        // 3. PURCHASE BY SUPPLIER REPORT
        async function generatePurchaseBySupplier() {
            const purchasesResult = await apiCall('getPurchaseOrders');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!purchasesResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            let purchases = purchasesResult.data;
            
            // Store raw data
            rawReportData['purchase-by-supplier'] = { purchases, suppliers };
            
            // APPLY FILTERS
            if (reportFilters.fromDate) {
                const fromDate = parseLocalDate(reportFilters.fromDate);
                purchases = purchases.filter(po => new Date(po.PO_Date) >= fromDate);
            }
            if (reportFilters.toDate) {
                const toDate = parseLocalDate(reportFilters.toDate);
                toDate.setHours(23, 59, 59);
                purchases = purchases.filter(po => new Date(po.PO_Date) <= toDate);
            }
            if (reportFilters.supplier) {
                purchases = purchases.filter(po => matchesFilter(po.Supplier_ID, reportFilters.supplier));
            }
            if (reportFilters.minAmount) {
                purchases = purchases.filter(po => parseFloat(po.Total_Amount || po.Invoice_Total || 0) >= reportFilters.minAmount);
            }
            
            // Build supplier purchase summary
            const supplierPurchases = {};
            
            purchases.forEach(po => {
                const suppId = po.Supplier_ID;
                if (!supplierPurchases[suppId]) {
                    const supplier = suppliers.find(s => s.Supplier_ID === suppId);
                    supplierPurchases[suppId] = {
                        id: suppId,
                        name: supplier?.Supplier_Name || suppId,
                        totalSpent: 0,
                        orderCount: 0,
                        lastOrderDate: null
                    };
                }
                
                const total = parseFloat(po.Total_Amount || po.Invoice_Total || 0);
                supplierPurchases[suppId].totalSpent += total;
                supplierPurchases[suppId].orderCount++;
                
                const orderDate = new Date(po.PO_Date);
                if (!supplierPurchases[suppId].lastOrderDate || orderDate > supplierPurchases[suppId].lastOrderDate) {
                    supplierPurchases[suppId].lastOrderDate = orderDate;
                }
            });
            
            // Sort by total spent
            const sorted = Object.values(supplierPurchases).sort((a, b) => b.totalSpent - a.totalSpent);
            
            // Build supplier list for filter
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('purchase-by-supplier', {
                dateRange: true,
                dateLabel: 'Purchase Date',
                supplier: true,
                supplierList: supplierList,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3> Purchase by Supplier Report</h3>
                    <p style="color: #666;">Suppliers: ${sorted.length} | Total Spent: ${formatMoney(sorted.reduce((sum, s) => sum + s.totalSpent, 0))}</p>
                    
                </div>`;
            
            if (sorted.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Supplier</th>
                            <th>Orders</th>
                            <th>Total Spent</th>
                            <th>Avg Order</th>
                            <th>Last Order</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                sorted.forEach(supp => {
                    const avgOrder = supp.totalSpent / supp.orderCount;
                    
                    html += `<tr>
                        <td><strong>${supp.name}</strong></td>
                        <td>${supp.orderCount}</td>
                        <td>${formatMoney(supp.totalSpent)}</td>
                        <td>${formatMoney(avgOrder)}</td>
                        <td>${supp.lastOrderDate ? supp.lastOrderDate.toLocaleDateString() : '-'}</td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['purchase-by-supplier'] = sorted;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 4. INVENTORY TURNOVER REPORT
        async function generateInventoryTurnover() {
            const inventoryResult = await apiCall('getInventoryReport');
            const salesResult = await apiCall('getSalesOrders');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!inventoryResult?.data || !salesResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const inventory = inventoryResult.data;
            const sales = salesResult.data;
            const suppliers = suppliersResult.data;
            
            // Fetch ALL sales order lines
            const allLines = [];
            for (const so of sales) {
                const linesResult = await apiCall('getSalesOrderLines', { soId: so.SO_ID });
                if (linesResult?.data) {
                    allLines.push(...linesResult.data);
                }
            }
            
            // Store raw data
            rawReportData['inventory-turnover'] = { inventory, sales, suppliers, allLines };
            
            // Calculate units sold per item
            const unitsSold = {};
            allLines.forEach(line => {
                const itemId = line.Item_ID;
                unitsSold[itemId] = (unitsSold[itemId] || 0) + parseInt(line.Quantity || 0);
            });
            
            // Build turnover report
            let turnoverData = inventory.map(item => {
                const sold = unitsSold[item.Item_ID] || 0;
                const onHand = parseInt(item.Qty_On_Hand) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                const backorder = parseInt(item.Qty_On_Backorder) || 0;
                const avgInventory = onHand + (sold / 2);
                const turnover = avgInventory > 0 ? sold / avgInventory : 0;
                
                // Calculate cost from package cost
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const unitCost = packageCost / unitsPerPackage;
                const value = onHand * unitCost;
                
                return {
                    id: item.Item_ID,
                    description: item.Item_Description,
                    sku: item.SKU,
                    supplierId: item.Supplier_ID,
                    onHand: onHand,
                    onOrder: onOrder,
                    backorder: backorder,
                    sold: sold,
                    turnover: turnover,
                    value: value,
                    status: turnover > 4 ? 'Fast' : turnover > 2 ? 'Normal' : 'Slow'
                };
            });
            
            // APPLY FILTERS - use matchesFilter for multi-select support
            if (reportFilters.supplier) {
                turnoverData = turnoverData.filter(item => matchesFilter(item.supplierId, reportFilters.supplier));
            }
            if (reportFilters.turnoverStatus) {
                turnoverData = turnoverData.filter(item => item.status === reportFilters.turnoverStatus);
            }
            if (reportFilters.minAmount) {
                turnoverData = turnoverData.filter(item => item.value >= reportFilters.minAmount);
            }
            
            // Sort by turnover
            turnoverData.sort((a, b) => b.turnover - a.turnover);
            
            // Build supplier list for filter
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('inventory-turnover', {
                supplier: true,
                supplierList: supplierList,
                turnoverStatus: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3> Inventory Turnover Report</h3>
                    <p style="color: #666;">Total Items: ${turnoverData.length}</p>
                    
                </div>`;
            
            if (turnoverData.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>On Hand</th>
                            <th>Backorder</th>
                            <th>On Order</th>
                            <th>Units Sold</th>
                            <th>Turnover Rate</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                turnoverData.forEach(item => {
                    const statusColor = item.status === 'Fast' ? 'green' : item.status === 'Normal' ? 'orange' : 'red';
                    const qtyOnOrder = parseFloat(item.onOrder) || 0;
                    const backorder = parseInt(item.backorder) || 0;
                    
                    html += `<tr>
                        <td><strong>${item.description}</strong></td>
                        <td>${item.sku}</td>
                        <td>${item.onHand}</td>
                        <td style="color: ${backorder > 0 ? '#dc2626' : '#666'}; font-weight: ${backorder > 0 ? '600' : 'normal'};">${backorder > 0 ? backorder : '-'}</td>
                        <td><span style="background: ${qtyOnOrder > 0 ? '#ffc107' : '#e0e0e0'}; padding: 3px 8px; border-radius: 4px; font-weight: bold;">${qtyOnOrder}</span></td>
                        <td>${item.sold}</td>
                        <td>${item.turnover.toFixed(2)}</td>
                        <td style="color: ${statusColor}; font-weight: bold;">${item.status}</td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['inventory-turnover'] = turnoverData;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 5. GROSS MARGIN REPORT
        async function generateGrossMargin() {
            const itemsResult = await apiCall('getItems');
            const salesResult = await apiCall('getSalesOrders');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!itemsResult?.data || !salesResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const items = itemsResult.data;
            const sales = salesResult.data;
            const suppliers = suppliersResult.data;
            
            // Store raw data
            rawReportData['gross-margin'] = { items, sales, suppliers };
            
            // Calculate margin per item
            let marginData = items.map(item => {
                const unitsPerPackage = parseFloat(item.Units_Per_Package) || 1;
                const packageCost = parseFloat(item.Package_Cost) || 0;
                const cost = packageCost / unitsPerPackage;
                const sell = parseFloat(item.Unit_Sell_Price) || 0;
                const margin = sell - cost;
                const marginPercent = sell > 0 ? (margin / sell) * 100 : 0;
                
                // Calculate units sold
                let unitsSold = 0;
                sales.forEach(so => {
                    // Parse lines if they're stored as JSON string
                    let lines = so.lines;
                    if (typeof lines === 'string') {
                        try {
                            lines = JSON.parse(lines);
                        } catch (e) {
                            lines = [];
                        }
                    }
                    
                    if (lines && Array.isArray(lines)) {
                        lines.forEach(line => {
                            if ((line.itemId || line.Item_ID) === item.Item_ID) {
                                unitsSold += parseInt(line.quantity || line.Quantity || 0);
                            }
                        });
                    }
                });
                
                const totalProfit = margin * unitsSold;
                
                return {
                    id: item.Item_ID,
                    description: item.Item_Description,
                    sku: item.SKU,
                    supplierId: item.Supplier_ID,
                    cost: cost,
                    sell: sell,
                    margin: margin,
                    marginPercent: marginPercent,
                    unitsSold: unitsSold,
                    totalProfit: totalProfit
                };
            });
            
            // APPLY FILTERS - use matchesFilter for multi-select support
            if (reportFilters.supplier) {
                marginData = marginData.filter(item => matchesFilter(item.supplierId, reportFilters.supplier));
            }
            if (reportFilters.item) {
                marginData = marginData.filter(item => matchesFilter(item.id, reportFilters.item));
            }
            if (reportFilters.minAmount) {
                marginData = marginData.filter(item => item.marginPercent >= reportFilters.minAmount);
            }
            // Add max margin filter (using minAmount field with special handling)
            const maxMarginFilter = document.getElementById('filter_maxMargin');
            if (maxMarginFilter && maxMarginFilter.value) {
                const maxMargin = parseFloat(maxMarginFilter.value);
                marginData = marginData.filter(item => item.marginPercent <= maxMargin);
            }
            
            // Sort by total profit
            marginData.sort((a, b) => b.totalProfit - a.totalProfit);
            
            // Build filter lists
            const itemList = items.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters (with custom min/max margin)
            let html = buildFilterUI('gross-margin', {
                supplier: true,
                supplierList: supplierList,
                item: true,
                itemList: itemList,
                minAmount: false // We'll add custom margin filters
            });
            
            // Add custom min/max margin filters
            const filterDiv = html.lastIndexOf('</div>');
            html = html.substring(0, filterDiv) + `
                <div class="form-group">
                    <label>Min Margin %</label>
                    <input type="number" id="filter_minMargin" step="0.1" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Max Margin %</label>
                    <input type="number" id="filter_maxMargin" step="0.1" placeholder="100">
                </div>
            ` + html.substring(filterDiv);
            
            const totalProfit = marginData.reduce((sum, item) => sum + item.totalProfit, 0);
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3> Gross Margin Report</h3>
                    <p style="color: #666;">Total Products: ${marginData.length} | Total Profit: ${formatMoney(totalProfit)}</p>
                    
                </div>`;
            
            if (marginData.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No data matches your filters</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Cost</th>
                            <th>Sell</th>
                            <th>Margin</th>
                            <th>Margin %</th>
                            <th>Units Sold</th>
                            <th>Total Profit</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                marginData.forEach(item => {
                    const marginColor = item.marginPercent > 40 ? 'green' : item.marginPercent > 20 ? 'orange' : 'red';
                    
                    html += `<tr>
                        <td><strong>${item.description}</strong></td>
                        <td>${item.sku}</td>
                        <td>${formatMoney(item.cost)}</td>
                        <td>${formatMoney(item.sell)}</td>
                        <td>${formatMoney(item.margin)}</td>
                        <td style="color: ${marginColor}; font-weight: bold;">${item.marginPercent.toFixed(1)}%</td>
                        <td>${item.unitsSold}</td>
                        <td style="font-weight: bold;">${formatMoney(item.totalProfit)}</td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['gross-margin'] = marginData;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 6. ACCOUNTS RECEIVABLE REPORT (Who owes you money)
        async function generateAccountsReceivable() {
            const salesResult = await apiCall('getSalesOrders');
            const customersResult = await apiCall('getCustomers');
            
            if (!salesResult?.data || !customersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const customers = customersResult.data;
            const sales = salesResult.data;
            
            // Store raw data
            rawReportData['accounts-receivable'] = { sales, customers };
            
            // Filter for unpaid/partial invoices
            let receivables = sales
                .filter(so => {
                    const status = so.Payment_Status || 'Unpaid';
                    return status !== 'Paid';
                })
                .map(so => {
                    const customer = customers.find(c => c.Customer_ID === so.Customer_ID);
                    const total = parseFloat(so.Total_Amount || so.Order_Total || 0);
                    const paid = parseFloat(so.Amount_Paid || 0);
                    const balance = total - paid;
                    const dueDate = so.Due_Date ? new Date(so.Due_Date) : null;
                    const today = new Date();
                    const daysOverdue = dueDate ? Math.floor((today - dueDate) / (1000 * 60 * 60 * 24)) : 0;
                    
                    let aging = 'Current';
                    if (daysOverdue > 60) aging = '60+ days';
                    else if (daysOverdue > 30) aging = '31-60 days';
                    else if (daysOverdue > 0) aging = '1-30 days';
                    
                    return {
                        customerId: so.Customer_ID,
                        customer: customer?.Customer_Name || so.Customer_ID,
                        invoiceId: so.SO_ID,
                        invoiceDate: new Date(so.Sale_Date || so.SO_Date).toLocaleDateString(),
                        dueDate: dueDate ? dueDate.toLocaleDateString() : '-',
                        total: total,
                        paid: paid,
                        balance: balance,
                        status: so.Payment_Status || 'Unpaid',
                        daysOverdue: daysOverdue,
                        aging: aging,
                        agingCategory: aging // For filtering
                    };
                });
            
            // APPLY FILTERS - use matchesFilter for multi-select support
            if (reportFilters.customer) {
                receivables = receivables.filter(r => matchesFilter(r.customerId, reportFilters.customer));
            }
            if (reportFilters.minAmount) {
                receivables = receivables.filter(r => r.balance >= reportFilters.minAmount);
            }
            if (reportFilters.paymentStatus) {
                if (reportFilters.paymentStatus === 'Overdue') {
                    receivables = receivables.filter(r => r.daysOverdue > 0);
                } else {
                    receivables = receivables.filter(r => r.status === reportFilters.paymentStatus);
                }
            }
            if (reportFilters.aging) {
                const agingFilter = reportFilters.aging;
                if (agingFilter === '1-30') {
                    receivables = receivables.filter(r => r.aging === '1-30 days');
                } else if (agingFilter === '31-60') {
                    receivables = receivables.filter(r => r.aging === '31-60 days');
                } else if (agingFilter === '60+') {
                    receivables = receivables.filter(r => r.aging === '60+ days');
                } else if (agingFilter === 'Current') {
                    receivables = receivables.filter(r => r.aging === 'Current');
                }
            }
            
            // Sort by days overdue
            receivables.sort((a, b) => b.daysOverdue - a.daysOverdue);
            
            const totalOutstanding = receivables.reduce((sum, r) => sum + r.balance, 0);
            
            // Build customer list for filter
            const customerList = customers.map(c => ({ id: c.Customer_ID, name: c.Customer_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('accounts-receivable', {
                customer: true,
                customerList: customerList,
                paymentStatus: true,
                aging: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3> Accounts Receivable Report</h3>
                    <p style="color: #666;">Outstanding Invoices: ${receivables.length} | Total AR: ${formatMoney(totalOutstanding)}</p>
                    
                </div>`;
            
            if (receivables.length === 0) {
                html += '<p style="color: green; font-size: 18px; text-align: center; padding: 40px;"> All invoices paid! No outstanding receivables.</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Invoice #</th>
                            <th>Invoice Date</th>
                            <th>Due Date</th>
                            <th>Total</th>
                            <th>Paid</th>
                            <th>Balance Due</th>
                            <th>Days Overdue</th>
                            <th>Aging</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                receivables.forEach(r => {
                    const statusColor = r.status === 'Overdue' || r.daysOverdue > 0 ? 'red' : 'orange';
                    const agingColor = r.daysOverdue > 60 ? 'red' : r.daysOverdue > 30 ? 'orange' : r.daysOverdue > 0 ? '#f39c12' : 'green';
                    
                    html += `<tr>
                        <td><a href="javascript:void(0)" onclick="openCustomer('${r.customerId}')" style="color: #667eea; text-decoration: none;"><strong>${r.customer}</strong></a></td>
                        <td><a href="javascript:void(0)" onclick="openSalesOrder('${r.invoiceId}')" style="color: #667eea; text-decoration: none;"><strong>${r.invoiceId}</strong></a></td>
                        <td>${r.invoiceDate}</td>
                        <td>${r.dueDate}</td>
                        <td>${formatMoney(r.total)}</td>
                        <td>${formatMoney(r.paid)}</td>
                        <td style="font-weight: bold; color: ${statusColor};">${formatMoney(r.balance)}</td>
                        <td style="color: ${r.daysOverdue > 0 ? 'red' : 'green'};">${r.daysOverdue > 0 ? r.daysOverdue : '-'}</td>
                        <td style="color: ${agingColor}; font-weight: bold;">${r.aging}</td>
                        <td style="color: ${statusColor};">${r.status}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            }
            
            reportData['accounts-receivable'] = receivables;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 7. ACCOUNTS PAYABLE REPORT (Who you owe money to)
        async function generateAccountsPayable() {
            const purchasesResult = await apiCall('getPurchaseOrders');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!purchasesResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            const purchases = purchasesResult.data;
            
            // Store raw data
            rawReportData['accounts-payable'] = { purchases, suppliers };
            
            // Filter for unpaid/partial invoices
            let payables = purchases
                .filter(po => {
                    const status = po.Payment_Status || 'Unpaid';
                    return status !== 'Paid';
                })
                .map(po => {
                    const supplier = suppliers.find(s => s.Supplier_ID === po.Supplier_ID);
                    const total = parseFloat(po.Total_Amount || po.Invoice_Total || 0);
                    const paid = parseFloat(po.Amount_Paid || 0);
                    const balance = total - paid;
                    const dueDate = po.Due_Date ? new Date(po.Due_Date) : null;
                    const today = new Date();
                    const daysOverdue = dueDate ? Math.floor((today - dueDate) / (1000 * 60 * 60 * 24)) : 0;
                    
                    let aging = 'Current';
                    if (daysOverdue > 60) aging = '60+ days';
                    else if (daysOverdue > 30) aging = '31-60 days';
                    else if (daysOverdue > 0) aging = '1-30 days';
                    
                    return {
                        supplierId: po.Supplier_ID,
                        supplier: supplier?.Supplier_Name || po.Supplier_ID,
                        invoiceId: po.Invoice_Number || po.PO_ID,
                        poId: po.PO_ID,
                        invoiceDate: new Date(po.PO_Date).toLocaleDateString(),
                        dueDate: dueDate ? dueDate.toLocaleDateString() : '-',
                        total: total,
                        paid: paid,
                        balance: balance,
                        status: po.Payment_Status || 'Unpaid',
                        daysOverdue: daysOverdue,
                        aging: aging,
                        agingCategory: aging // For filtering
                    };
                });
            
            // APPLY FILTERS - use matchesFilter for multi-select support
            if (reportFilters.supplier) {
                payables = payables.filter(p => matchesFilter(p.supplierId, reportFilters.supplier));
            }
            if (reportFilters.minAmount) {
                payables = payables.filter(p => p.balance >= reportFilters.minAmount);
            }
            if (reportFilters.paymentStatus) {
                if (reportFilters.paymentStatus === 'Overdue') {
                    payables = payables.filter(p => p.daysOverdue > 0);
                } else {
                    payables = payables.filter(p => p.status === reportFilters.paymentStatus);
                }
            }
            if (reportFilters.aging) {
                const agingFilter = reportFilters.aging;
                if (agingFilter === '1-30') {
                    payables = payables.filter(p => p.aging === '1-30 days');
                } else if (agingFilter === '31-60') {
                    payables = payables.filter(p => p.aging === '31-60 days');
                } else if (agingFilter === '60+') {
                    payables = payables.filter(p => p.aging === '60+ days');
                } else if (agingFilter === 'Current') {
                    payables = payables.filter(p => p.aging === 'Current');
                }
            }
            
            // Sort by days overdue
            payables.sort((a, b) => b.daysOverdue - a.daysOverdue);
            
            const totalOutstanding = payables.reduce((sum, p) => sum + p.balance, 0);
            
            // Build supplier list for filter
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            
            // Build HTML with filters
            let html = buildFilterUI('accounts-payable', {
                supplier: true,
                supplierList: supplierList,
                paymentStatus: true,
                aging: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3> Accounts Payable Report</h3>
                    <p style="color: #666;">Outstanding Bills: ${payables.length} | Total AP: ${formatMoney(totalOutstanding)}</p>
                    
                </div>`;
            
            if (payables.length === 0) {
                html += '<p style="color: green; font-size: 18px; text-align: center; padding: 40px;"> All bills paid! No outstanding payables.</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Supplier</th>
                            <th>Invoice #</th>
                            <th>PO #</th>
                            <th>Invoice Date</th>
                            <th>Due Date</th>
                            <th>Total</th>
                            <th>Paid</th>
                            <th>Balance Due</th>
                            <th>Days Overdue</th>
                            <th>Aging</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                payables.forEach(p => {
                    const statusColor = p.daysOverdue > 0 ? 'red' : 'orange';
                    const agingColor = p.daysOverdue > 60 ? 'red' : p.daysOverdue > 30 ? 'orange' : p.daysOverdue > 0 ? '#f39c12' : 'green';
                    
                    html += `<tr>
                        <td><a href="javascript:void(0)" onclick="openSupplier('${p.supplierId}')" style="color: #667eea; text-decoration: none;"><strong>${p.supplier}</strong></a></td>
                        <td>${p.invoiceId}</td>
                        <td><a href="javascript:void(0)" onclick="openPurchaseOrder('${p.poId}')" style="color: #667eea; text-decoration: none;"><strong>${p.poId}</strong></a></td>
                        <td>${p.invoiceDate}</td>
                        <td>${p.dueDate}</td>
                        <td>${formatMoney(p.total)}</td>
                        <td>${formatMoney(p.paid)}</td>
                        <td style="font-weight: bold; color: ${statusColor};">${formatMoney(p.balance)}</td>
                        <td style="color: ${p.daysOverdue > 0 ? 'red' : 'green'};">${p.daysOverdue > 0 ? p.daysOverdue : '-'}</td>
                        <td style="color: ${agingColor}; font-weight: bold;">${p.aging}</td>
                        <td style="color: ${statusColor};">${p.status}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            }
            
            reportData['accounts-payable'] = payables;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // 8. SIMPLE INVENTORY REPORT
        async function generateSimpleInventory() {
            const inventoryResult = await apiCall('getInventoryReport');
            const suppliersResult = await apiCall('getSuppliers');
            
            if (!inventoryResult?.data || !suppliersResult?.data) {
                throw new Error('Failed to load data');
            }
            
            const suppliers = suppliersResult.data;
            let inventory = inventoryResult.data;
            
            // Store raw data
            rawReportData['simple-inventory'] = { inventory, suppliers };
            
            // APPLY FILTERS - use matchesFilter for multi-select support
            if (reportFilters.supplier) {
                inventory = inventory.filter(item => matchesFilter(item.Supplier_ID, reportFilters.supplier));
            }
            if (reportFilters.item) {
                inventory = inventory.filter(item => matchesFilter(item.Item_ID, reportFilters.item));
            }
            if (reportFilters.stockStatus) {
                if (reportFilters.stockStatus === 'negative') {
                    inventory = inventory.filter(item => parseFloat(item.Qty_On_Hand || 0) < 0);
                } else if (reportFilters.stockStatus === 'out') {
                    inventory = inventory.filter(item => parseFloat(item.Qty_On_Hand || 0) === 0);
                } else if (reportFilters.stockStatus === 'low') {
                    inventory = inventory.filter(item => {
                        const qty = parseFloat(item.Qty_On_Hand || 0);
                        const reorder = parseFloat(item.Reorder_Point || 0);
                        return qty > 0 && qty <= reorder;
                    });
                } else if (reportFilters.stockStatus === 'ok') {
                    inventory = inventory.filter(item => {
                        const qty = parseFloat(item.Qty_On_Hand || 0);
                        const reorder = parseFloat(item.Reorder_Point || 0);
                        return qty > reorder;
                    });
                }
            }
            if (reportFilters.minAmount) {
                inventory = inventory.filter(item => parseFloat(item.Total_Value || 0) >= reportFilters.minAmount);
            }
            
            // Sort alphabetically
            inventory.sort((a, b) => a.Item_Description.localeCompare(b.Item_Description));
            
            const totalValue = inventory.reduce((sum, item) => sum + parseFloat(item.Total_Value || 0), 0);
            const totalItems = inventory.length;
            const lowStockCount = inventory.filter(item => item.Low_Stock).length;
            
            // Build filter lists
            const supplierList = suppliers.map(s => ({ id: s.Supplier_ID, name: s.Supplier_Name }));
            const itemList = inventoryResult.data.map(i => ({ id: i.Item_ID, name: `${i.Item_Description} (${i.SKU})` }));
            
            // Build HTML with filters
            let html = buildFilterUI('simple-inventory', {
                supplier: true,
                supplierList: supplierList,
                item: true,
                itemList: itemList,
                stockStatus: true,
                minAmount: true
            });
            
            html += `
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3> Inventory List Report</h3>
                    <p style="color: #666;">
                        Total Items: ${totalItems} | 
                        Total Value: ${formatMoney(totalValue)} | 
                        Low Stock Items: ${lowStockCount}
                    </p>
                    
                </div>`;
            
            if (inventory.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: #666;">No items match your filters</p>';
            } else {
                html += `<table class="data-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Description</th>
                            <th>Supplier</th>
                            <th>UOM</th>
                            <th>Qty On Hand</th>
                            <th>Backorder</th>
                            <th>On Order</th>
                            <th>Reorder Point</th>
                            <th>Cost</th>
                            <th>Sell Price</th>
                            <th>Total Value</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                inventory.forEach(item => {
                    const lowStock = item.Low_Stock;
                    const qtyOnOrder = parseFloat(item.Qty_On_Order) || 0;
                    const backorder = parseInt(item.Qty_On_Backorder) || 0;
                    const rowStyle = lowStock ? 'background: #fff3cd;' : '';
                    const status = lowStock ? ' Low Stock' : ' OK';
                    const statusColor = lowStock ? '#f39c12' : 'green';
                    
                    html += `<tr style="${rowStyle}">
                        <td><strong>${item.SKU || '-'}</strong></td>
                        <td>${item.Item_Description}</td>
                        <td>${getSupplierName(item.Supplier_ID)}</td>
                        <td>${item.UOM}</td>
                        <td style="font-weight: bold;">${item.Qty_On_Hand}</td>
                        <td style="color: ${backorder > 0 ? '#dc2626' : '#666'}; font-weight: ${backorder > 0 ? '600' : 'normal'};">${backorder > 0 ? backorder : '-'}</td>
                        <td><span style="background: ${qtyOnOrder > 0 ? '#ffc107' : '#e0e0e0'}; padding: 3px 8px; border-radius: 4px; font-weight: bold;">${qtyOnOrder}</span></td>
                        <td>${item.Reorder_Point}</td>
                        <td>${formatMoney(parseFloat(item.Package_Cost) / parseFloat(item.Units_Per_Package || 1))}</td>
                        <td>${formatMoney(parseFloat(item.Unit_Sell_Price))}</td>
                        <td>${formatMoney(parseFloat(item.Total_Value))}</td>
                        <td style="color: ${statusColor}; font-weight: bold;">${status}</td>
                    </tr>`;
                });
            
                html += '</tbody></table>';
            }
            
            reportData['simple-inventory'] = inventory;
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        // ==================== HOT LINK FUNCTIONS ====================
        
        async function openSalesOrder(soId) {
            // Remember current tab to return to later
            const currentTab = document.querySelector('.card.active');
            if (currentTab && currentTab.id === 'reports') {
                returnToTab = 'reports';
            } else {
                returnToTab = null;
            }
            
            // Load the sales order and open edit modal
            const result = await apiCall('getSalesOrders');
            const so = result.data.find(s => s.SO_ID === soId);
            if (so) {
                // Switch to Sales tab and show the order
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="sales"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('sales').classList.add('active');
                
                // Open the order details modal
                await showSalesOrderDetails(so);
                document.getElementById('orderModal').style.display = 'block'; document.body.classList.add('modal-open');
            } else {
                alert('Sales order not found: ' + soId);
            }
        }
        
        async function openPurchaseOrder(poId) {
            // Remember current tab to return to later
            const currentTab = document.querySelector('.card.active');
            if (currentTab && currentTab.id === 'reports') {
                returnToTab = 'reports';
            } else {
                returnToTab = null;
            }
            
            // Load the purchase order and open edit modal
            const result = await apiCall('getPurchaseOrders');
            const po = result.data.find(p => p.PO_ID === poId);
            if (po) {
                // Switch to Purchases tab and show the order
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="purchases"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('purchases').classList.add('active');
                
                // Open the order details modal
                await showPurchaseOrderDetails(po);
                document.getElementById('orderModal').style.display = 'block'; document.body.classList.add('modal-open');
            } else {
                alert('Purchase order not found: ' + poId);
            }
        }
        
        async function openCustomer(customerId) {
            // Remember current tab to return to later
            const currentTab = document.querySelector('.card.active');
            if (currentTab && currentTab.id === 'reports') {
                returnToTab = 'reports';
            } else {
                returnToTab = null;
            }
            
            // Load customer and open edit modal
            const result = await apiCall('getCustomers');
            const customer = result.data.find(c => c.Customer_ID === customerId);
            if (customer) {
                // Switch to Customers tab
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="customers"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('customers').classList.add('active');
                
                // Show edit form
                showEditCustomerForm(customer);
            } else {
                alert('Customer not found: ' + customerId);
            }
        }
        
        async function openSupplier(supplierId) {
            // Remember current tab to return to later
            const currentTab = document.querySelector('.card.active');
            if (currentTab && currentTab.id === 'reports') {
                returnToTab = 'reports';
            } else {
                returnToTab = null;
            }
            
            // Load supplier and open edit modal
            const result = await apiCall('getSuppliers');
            const supplier = result.data.find(s => s.Supplier_ID === supplierId);
            if (supplier) {
                // Switch to Suppliers tab
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.tab[onclick*="suppliers"]').classList.add('active');
                document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
                document.getElementById('suppliers').classList.add('active');
                
                // Show edit form
                showEditSupplierForm(supplier);
            } else {
                alert('Supplier not found: ' + supplierId);
            }
        }
        
        async function openItem(itemId) {
            // Load items if not cached
            if (cachedItems.length === 0) {
                const result = await apiCall('getItems');
                if (result && result.status === 'success') {
                    cachedItems = result.data;
                }
            }
            
            // FIX #5: Add null checking to prevent errors
            // Switch to Items tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Find the items tab more reliably
            const itemsTab = document.querySelector('.tab[onclick*="showSection"][onclick*="items"]') || 
                             document.querySelector('.tab[onclick*="items"]');
            
            if (itemsTab) {
                itemsTab.classList.add('active');
            }
            
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            
            const itemsCard = document.getElementById('items');
            if (itemsCard) {
                itemsCard.classList.add('active');
            }
            
            // Call editItemById which handles the edit form
            editItemById(itemId);
        }
        
        
        // ==================== CREATE PO (PRINT ONLY) FUNCTIONS ====================
        
        // Add supplier check to createpo-item selects on focus AND click
        document.addEventListener('focusin', function(e) {
            if (e.target.classList.contains('createpo-item')) {
                const supplierId = document.getElementById('createPOSupplier')?.value;
                if (!supplierId) {
                    e.preventDefault();
                    e.target.blur(); // Remove focus
                    alert(' Please select a supplier first');
                    document.getElementById('createPOSupplier')?.focus();
                }
            }
        });
        
        // Also catch mousedown/touchstart to prevent dropdown from opening
        document.addEventListener('mousedown', function(e) {
            if (e.target.classList.contains('createpo-item')) {
                const supplierId = document.getElementById('createPOSupplier')?.value;
                if (!supplierId) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert(' Please select a supplier first');
                    document.getElementById('createPOSupplier')?.focus();
                }
            }
        });
        
        document.addEventListener('touchstart', function(e) {
            if (e.target.classList.contains('createpo-item')) {
                const supplierId = document.getElementById('createPOSupplier')?.value;
                if (!supplierId) {
                    e.preventDefault();
                    e.stopPropagation();
                    setTimeout(() => {
                        alert(' Please select a supplier first');
                        document.getElementById('createPOSupplier')?.focus();
                    }, 10);
                }
            }
        }, { passive: false });
        
        function filterItemsBySupplier() {
            const supplierId = document.getElementById('createPOSupplier').value;
            const itemSelects = document.querySelectorAll('.createpo-item');
            
            itemSelects.forEach(select => {
                // Clear existing options
                select.innerHTML = '<option value="">Select item...</option>';
                
                if (supplierId) {
                    // Filter items by supplier
                    const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
                    supplierItems.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.Item_ID;
                        option.textContent = `${item.SKU || item.Item_ID} - ${item.Item_Description}`;
                        option.dataset.cost = item.Package_Cost || 0;
                        option.dataset.units = item.Units_Per_Package || 1;
                        select.appendChild(option);
                    });
                }
            });
            
            calculateCreatePOTotal();
        }
        
        function addCreatePOLineItem() {
            const container = document.getElementById('createPOLineItems');
            const supplierId = document.getElementById('createPOSupplier').value;
            
            if (!supplierId) {
                alert('Please select a supplier first');
                return;
            }
            
            const newRow = document.createElement('div');
            newRow.className = 'line-item-row';
            newRow.style.cssText = 'display: grid; grid-template-columns: 2.5fr 1fr 0.6fr 0.8fr 0.8fr 0.8fr 50px; gap: 8px; margin-bottom: 10px; align-items: end;';
            newRow.innerHTML = `
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                    <select class="createpo-item" style="width: 100%; padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white;" onchange="updateCreatePOItemCost(this)">
                        <option value="">Select item...</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Cases</label>
                    <input type="number" class="createpo-qty" placeholder="0" min="1" oninput="calculateCreatePOTotal()" style="width: 100%; padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px;">
                </div>
                <div style="margin-top: 26px;">
                    <div class="createpo-units" style="text-align: center; font-size: 14px; color: #666; padding: 6px;">-</div>
                </div>
                <div style="margin-top: 26px;">
                    <div class="createpo-totalunits" style="text-align: center; font-size: 16px; font-weight: bold; color: var(--primary, #667eea); padding: 6px;">-</div>
                </div>
                <div style="margin-top: 26px;">
                    <div class="createpo-cost" style="text-align: center; font-size: 14px; font-weight: bold; color: #28a745; background: #e8f5e9; padding: 10px; border-radius: 6px;">-</div>
                </div>
                <div style="margin-top: 26px;">
                    <div class="createpo-linetotal" style="text-align: right; font-size: 14px; font-weight: bold; color: var(--primary, #667eea); background: var(--primary-light, #E3F2FD); padding: 10px; border-radius: 6px;">$0.00</div>
                </div>
                <button type="button" class="btn-danger" onclick="removeLineItem(this); calculateCreatePOTotal();" style="width: 100%; padding: 10px; font-size: 14px; margin-top: 26px;"></button>
            `;
            
            container.appendChild(newRow);
            
            // Populate the new select with filtered items
            const itemSelect = newRow.querySelector('.createpo-item');
            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
            supplierItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.Item_ID;
                option.textContent = `${item.SKU || item.Item_ID} - ${item.Item_Description}`;
                option.dataset.cost = item.Package_Cost || 0;
                option.dataset.units = item.Units_Per_Package || 1;
                itemSelect.appendChild(option);
            });
        }
        
        function updateCreatePOItemCost(selectElement) {
            const row = selectElement.closest('.line-item-row');
            const costDiv = row.querySelector('.createpo-cost');
            const unitsDiv = row.querySelector('.createpo-units');
            const qtyInput = row.querySelector('.createpo-qty');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.cost) {
                const cost = parseFloat(selectedOption.dataset.cost);
                const units = parseFloat(selectedOption.dataset.units) || 1;
                
                costDiv.textContent = '$' + cost.toFixed(2);
                unitsDiv.textContent = units;
                
                // Calculate total units if qty is entered
                const qty = parseFloat(qtyInput.value) || 0;
                const totalUnitsDiv = row.querySelector('.createpo-totalunits');
                totalUnitsDiv.textContent = qty > 0 ? (qty * units) : '-';
            } else {
                costDiv.textContent = '-';
                unitsDiv.textContent = '-';
                row.querySelector('.createpo-totalunits').textContent = '-';
            }
            
            calculateCreatePOTotal();
        }
        
        function calculateCreatePOTotal() {
            let totalCost = 0;
            let totalCases = 0;
            let totalUnits = 0;
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            
            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                const costDiv = row.querySelector('.createpo-cost');
                const unitsDiv = row.querySelector('.createpo-units');
                const totalUnitsDiv = row.querySelector('.createpo-totalunits');
                const lineTotalDiv = row.querySelector('.createpo-linetotal');
                
                // Get cost from text (strip $ and parse)
                const costText = costDiv.textContent.replace('$', '');
                const cost = costText === '-' ? 0 : parseFloat(costText);
                
                // Get units per case
                const unitsText = unitsDiv.textContent;
                const unitsPerCase = unitsText === '-' ? 0 : parseFloat(unitsText);
                
                // Update total units for this line
                if (unitsPerCase > 0 && qty > 0) {
                    const lineUnits = qty * unitsPerCase;
                    totalUnitsDiv.textContent = lineUnits;
                    totalUnits += lineUnits;
                } else {
                    totalUnitsDiv.textContent = '-';
                }
                
                // Update line total
                const lineTotal = qty * cost;
                if (lineTotal > 0) {
                    lineTotalDiv.textContent = '$' + lineTotal.toFixed(2);
                } else {
                    lineTotalDiv.textContent = '$0.00';
                }
                
                totalCost += lineTotal;
                totalCases += qty;
            });
            
            // Update all totals
            document.getElementById('createPOTotalCases').textContent = totalCases;
            document.getElementById('createPOTotalUnits').textContent = totalUnits;
            document.getElementById('createPOTotal').textContent = '$' + totalCost.toFixed(2);
            return totalCost;
        }
        
        // ==================== OUTGOING PO FUNCTIONS ====================
        
        // Void a PO (when supplier prices changed)
        async function voidPurchaseOrder(poId) {
            if (!confirm(` VOID Purchase Order ${poId}?\n\nThis will mark the PO as invalid. Use this when:\n Supplier prices have changed\n Order was entered incorrectly\n Order is no longer needed\n\nThe PO will remain in your records but won't affect inventory.`)) {
                return;
            }
            
            const reason = prompt('Optional: Enter reason for voiding (e.g., "Prices increased 10%"):', 'Supplier prices changed');
            
            try {
                const result = await apiCall('updatePurchaseOrder', {
                    poId: poId,
                    status: 'Void',
                    notes: `VOIDED: ${reason || 'No reason provided'} - ${new Date().toLocaleDateString()}`
                });
                
                if (result && result.status === 'success') {
                    showStatus('purchasesStatus', ` PO ${poId} has been voided. You can copy it to create a new PO with updated prices.`, 'success');
                    closeModal();
                    loadPurchases();
                } else {
                    alert('Error voiding PO: ' + (result?.message || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        // Duplicate a PO (useful when original was voided due to price changes)
        async function duplicatePO(poId) {
            try {
                // Load the original PO
                const result = await apiCall('getPurchaseOrders');
                if (!result || result.status !== 'success') {
                    alert('Error loading purchase order');
                    return;
                }
                
                const originalPO = result.data.find(p => p.PO_ID === poId);
                if (!originalPO) {
                    alert('Purchase order not found');
                    return;
                }
                
                // Get original line items
                const linesResult = await apiCall('getPurchaseOrderLines', { poId: poId });
                const originalLines = linesResult?.data || [];
                
                if (originalLines.length === 0) {
                    alert('No line items found in original PO');
                    return;
                }
                
                // Confirm with user
                const itemCount = originalLines.length;
                if (!confirm(`Create a NEW Purchase Order with ${itemCount} item(s) from ${poId}?\n\n You'll need to update prices in the new PO if they've changed.`)) {
                    return;
                }
                
                // Skip clearing since we're pre-filling
                window.skipCreatePOClear = true;
                
                // Switch to Create PO tab
                switchTab('createpo');
                
                // Pre-select the supplier
                const supplierSelect = document.getElementById('poSupplier');
                if (supplierSelect) {
                    supplierSelect.value = originalPO.Supplier_ID;
                    await loadSupplierItems(); // Load items for this supplier
                }
                
                // Wait a moment for items to load
                setTimeout(async () => {
                    // Add each line item to the new PO
                    for (const line of originalLines) {
                        // Find the item in the dropdown and select it
                        const itemSelect = document.getElementById('poItemSelect');
                        if (itemSelect) {
                            itemSelect.value = line.Item_ID;
                            
                            // Set quantity
                            const qtyInput = document.getElementById('poItemQty');
                            if (qtyInput) {
                                qtyInput.value = line.Quantity || 1;
                            }
                            
                            // Add to PO
                            addItemToPO();
                        }
                    }
                    
                    showStatus('poStatus', ` Copied ${itemCount} items from ${poId}. Review prices and quantities, then save!`, 'success');
                    
                    // Scroll to the line items
                    const poTable = document.getElementById('poLineItemsTable');
                    if (poTable) {
                        poTable.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 500);
                
            } catch (e) {
                alert('Error duplicating PO: ' + e.message);
            }
        }
        
        async function receiveOutgoingPO(poId) {
            // Load the OUTGOING PO
            const result = await apiCall('getPurchaseOrders');
            if (!result || result.status !== 'success') {
                alert('Error loading purchase order');
                return;
            }
            
            const po = result.data.find(p => p.PO_ID === poId);
            if (!po) {
                alert('Purchase order not found');
                return;
            }
            
            if (po.Status !== 'Ordered' && po.Status !== 'Partial') {
                alert('This PO has already been fully received');
                return;
            }
            
            // Load line items
            const linesResult = await apiCall('getPurchaseOrderLines', { poId: poId });
            if (!linesResult || linesResult.status !== 'success') {
                alert('Error loading PO line items');
                return;
            }
            
            const lines = linesResult.data || [];
            
            // Show receive modal
            showReceiveModal(po, lines);
        }
        
        function showReceiveModal(po, lines) {
            // Store supplier ID for adding items
            window.currentReceivePO = po;
            window.currentReceiveLines = lines;
            window.receiveLineCounter = lines.length;
            
            // Calculate overall receiving progress
            let totalOrdered = 0;
            let totalPrevReceived = 0;
            lines.forEach(line => {
                totalOrdered += parseFloat(line.Quantity) || 0;
                totalPrevReceived += parseFloat(line.Qty_Received) || 0;
            });
            const overallProgress = totalOrdered > 0 ? Math.round((totalPrevReceived / totalOrdered) * 100) : 0;
            
            let html = `
                <div class="receive-modal-content">
                    <h2 style="position: sticky; top: 0; background: white; padding: 10px 0; margin: 0 0 10px 0; z-index: 10;"> Receive PO Items</h2>
                    
                    <!-- Order Info Box -->
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #28a745;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <strong> Internal PO #:</strong> 
                                <span style="font-size: 18px; font-weight: bold; color: #2e7d32;">${po.Invoice_Number || po.PO_ID}</span>
                            </div>
                            <div>
                                <strong> Supplier:</strong> ${getSupplierName(po.Supplier_ID)}
                            </div>
                            <div>
                                <strong> Order Date:</strong> ${formatDateSafe(po.PO_Date)}
                            </div>
                            <div>
                                <strong> Status:</strong> 
                                <span style="background: ${po.Status === 'Received' ? '#28a745' : po.Status === 'Partial' ? '#fd7e14' : '#ffc107'}; color: ${po.Status === 'Ordered' ? 'black' : 'white'}; padding: 2px 8px; border-radius: 4px;">${po.Status}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${totalPrevReceived > 0 ? `
                    <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #2196f3;">
                        <strong> Receiving Progress:</strong> ${totalPrevReceived} of ${totalOrdered} items (${overallProgress}%)
                        <div style="background: #ddd; border-radius: 4px; height: 8px; margin-top: 8px; overflow: hidden;">
                            <div style="background: ${overallProgress >= 100 ? '#28a745' : '#2196f3'}; height: 100%; width: ${Math.min(overallProgress, 100)}%;"></div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 0;"><strong> Partial Receiving Instructions:</strong></p>
                        <ul style="margin: 10px 0 0 20px; padding-left: 0;">
                            <li>Enter the <strong>"Receive Now"</strong> quantity for each item you're receiving today</li>
                            <li>Previously received quantities are shown and cannot be changed</li>
                            <li>Items already fully received show  and are locked</li>
                            <li>You can receive remaining items in multiple shipments</li>
                        </ul>
                    </div>
                    
                    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                    <table class="data-table" id="receiveItemsTable" style="table-layout: fixed; min-width: 700px; width: 100%;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th style="width: 28%; font-size: 15px; padding: 12px 8px;">Item</th>
                                <th style="width: 12%; text-align: center; font-size: 15px; padding: 12px 8px;">Ordered</th>
                                <th style="width: 12%; text-align: center; font-size: 15px; padding: 12px 8px;">Prev Recv</th>
                                <th style="width: 14%; text-align: center; font-size: 15px; padding: 12px 8px;">Receive Now</th>
                                <th style="width: 12%; text-align: center; font-size: 15px; padding: 12px 8px;">Pending</th>
                                <th style="width: 10%; text-align: center; font-size: 15px; padding: 12px 8px;">Status</th>
                                <th style="width: 12%; text-align: right; font-size: 15px; padding: 12px 8px;">Cost</th>
                            </tr>
                        </thead>
                        <tbody id="receiveItemsBody">
            `;
            
            lines.forEach((line, index) => {
                const item = cachedItems.find(i => i.Item_ID === line.Item_ID);
                const itemName = item ? item.Item_Description : line.Item_ID;
                const unitCost = parseFloat(line.Unit_Cost) || 0;
                const qtyOrdered = parseFloat(line.Quantity) || 0;
                const qtyPrevReceived = parseFloat(line.Qty_Received) || 0;
                const qtyPending = qtyOrdered - qtyPrevReceived;
                const isComplete = qtyPrevReceived >= qtyOrdered;
                
                // Status indicator
                let statusBadge, statusBg;
                if (isComplete) {
                    statusBadge = '';
                    statusBg = '#d4edda';
                } else if (qtyPrevReceived > 0) {
                    statusBadge = '';
                    statusBg = '#fff3cd';
                } else {
                    statusBadge = '';
                    statusBg = '#f8f9fa';
                }
                
                html += `
                    <tr id="receiveLine${index}" data-is-original="true" style="background: ${statusBg};">
                        <td style="padding: 12px; word-wrap: break-word;">
                            <strong style="font-size: 18px; line-height: 1.3; display: block;">${itemName}</strong>
                            <div style="font-size: 15px; color: #666; margin-top: 4px;">${item?.SKU || ''}</div>
                        </td>
                        <td style="text-align: center; padding: 12px 8px; font-weight: bold; font-size: 18px;">${qtyOrdered}</td>
                        <td style="text-align: center; padding: 12px 8px; color: ${qtyPrevReceived > 0 ? '#28a745' : '#999'}; font-weight: ${qtyPrevReceived > 0 ? 'bold' : 'normal'}; font-size: 18px;">
                            ${qtyPrevReceived > 0 ? qtyPrevReceived : '-'}
                        </td>
                        <td style="padding: 12px 8px;">
                            ${isComplete ? `
                                <input type="number" 
                                       id="receiveQty${index}" 
                                       value="0" 
                                       disabled
                                       data-line-id="${line.Line_ID}"
                                       data-item-id="${line.Item_ID}"
                                       data-ordered="${qtyOrdered}"
                                       data-prev-received="${qtyPrevReceived}"
                                       data-cost="${unitCost}"
                                       style="width: 100%; padding: 12px; font-size: 20px; text-align: center; box-sizing: border-box; background: #e9ecef; cursor: not-allowed;">
                            ` : `
                                <input type="number" 
                                       id="receiveQty${index}" 
                                       value="${qtyPending}" 
                                       min="0" 
                                       max="${qtyPending}"
                                       step="1"
                                       data-line-id="${line.Line_ID}"
                                       data-item-id="${line.Item_ID}"
                                       data-ordered="${qtyOrdered}"
                                       data-prev-received="${qtyPrevReceived}"
                                       data-cost="${unitCost}"
                                       style="width: 100%; padding: 12px; font-size: 20px; text-align: center; box-sizing: border-box; border: 2px solid #28a745;"
                                       oninput="updateReceiveLinePartial(${index})">
                            `}
                        </td>
                        <td style="text-align: center; padding: 12px 8px; font-size: 18px;" id="receivePending${index}">
                            <span style="color: ${qtyPending > 0 ? '#dc3545' : '#28a745'}; font-weight: bold;">
                                ${isComplete ? '0' : qtyPending}
                            </span>
                        </td>
                        <td style="text-align: center; padding: 12px 8px; font-size: 24px;">${statusBadge}</td>
                        <td style="text-align: right; padding: 12px 8px; font-size: 16px; font-weight: 600;">${formatMoney(unitCost)}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td colspan="3" style="text-align: right; padding: 12px;">Items to Receive:</td>
                                <td style="text-align: center; padding: 12px;" id="receiveItemCount">0</td>
                                <td colspan="2" style="text-align: right; padding: 12px;">Value:</td>
                                <td style="text-align: right; padding: 12px;" id="receiveGrandTotal">$0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                    </div>
                    
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px;">
                        <div class="form-group" style="flex: 1; min-width: 200px; margin: 0;">
                            <label style="font-weight: 600;"> Supplier's Invoice # <span style="font-weight: normal; color: #666;">(from their packing slip)</span></label>
                            <input type="text" id="receiveInvoiceNumber" value="" placeholder="Enter supplier's invoice/packing slip #..." style="width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; border: 2px solid #ddd; border-radius: 6px;">
                            <div style="font-size: 12px; color: #666; margin-top: 4px;"> Your internal PO# (${po.Invoice_Number || po.PO_ID}) will be preserved</div>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 200px; margin: 0;">
                            <label style="font-weight: 600;"> Receive Date</label>
                            <input type="date" id="receiveDate" value="${getTodayLocalDate()}" style="width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; border: 2px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label>Notes (optional)</label>
                        <textarea id="receiveNotes" rows="2" placeholder="Any discrepancies, damage, or special notes..." style="width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box;"></textarea>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalEditBtn').style.display = 'none';
            document.getElementById('modalPrintBtn').style.display = 'none';
            document.getElementById('modalSaveBtn').style.display = 'inline-block';
            document.getElementById('modalSaveBtn').textContent = ' Receive Items into Inventory';
            document.getElementById('modalSaveBtn').onclick = () => commitReceivePartial(po.PO_ID);
            document.getElementById('orderModal').style.display = 'block'; document.body.classList.add('modal-open');
            
            // Calculate initial totals
            setTimeout(() => {
                for (let i = 0; i < lines.length; i++) {
                    updateReceiveLinePartial(i);
                }
            }, 100);
        }
        
        // Update line for partial receiving
        function updateReceiveLinePartial(index) {
            const qtyInput = document.getElementById(`receiveQty${index}`);
            const pendingSpan = document.getElementById(`receivePending${index}`);
            
            if (!qtyInput) return;
            
            const qtyOrdered = parseFloat(qtyInput.dataset.ordered) || 0;
            const qtyPrevReceived = parseFloat(qtyInput.dataset.prevReceived) || 0;
            const qtyReceiveNow = parseFloat(qtyInput.value) || 0;
            const maxReceivable = qtyOrdered - qtyPrevReceived;
            
            // Clamp value to max receivable
            if (qtyReceiveNow > maxReceivable) {
                qtyInput.value = maxReceivable;
            }
            if (qtyReceiveNow < 0) {
                qtyInput.value = 0;
            }
            
            const actualReceiveNow = parseFloat(qtyInput.value) || 0;
            const newPending = maxReceivable - actualReceiveNow;
            
            // Update pending display
            if (pendingSpan) {
                pendingSpan.innerHTML = `<span style="color: ${newPending > 0 ? '#dc3545' : '#28a745'}; font-weight: bold;">${newPending}</span>`;
            }
            
            // Recalculate totals
            recalculateReceiveTotalPartial();
        }
        
        function recalculateReceiveTotalPartial() {
            let totalItems = 0;
            let totalValue = 0;
            
            document.querySelectorAll('#receiveItemsBody tr').forEach(row => {
                const qtyInput = row.querySelector('input[type="number"]');
                if (qtyInput && !qtyInput.disabled) {
                    const qty = parseFloat(qtyInput.value) || 0;
                    const cost = parseFloat(qtyInput.dataset.cost) || 0;
                    if (qty > 0) {
                        totalItems += qty;
                        totalValue += qty * cost;
                    }
                }
            });
            
            const itemCountEl = document.getElementById('receiveItemCount');
            const grandTotalEl = document.getElementById('receiveGrandTotal');
            
            if (itemCountEl) itemCountEl.textContent = totalItems;
            if (grandTotalEl) grandTotalEl.textContent = '$' + totalValue.toFixed(2);
        }
        
        // Commit partial receive
        let isCommittingReceivePartial = false;
        
        async function commitReceivePartial(poId) {
            if (isCommittingReceivePartial) {
                console.log('Already committing, ignoring duplicate click');
                return;
            }
            
            const notes = document.getElementById('receiveNotes')?.value || '';
            const invoiceNumber = document.getElementById('receiveInvoiceNumber')?.value || '';
            const receiveDate = document.getElementById('receiveDate')?.value || '';
            
            // Collect lines to receive
            const linesToReceive = [];
            document.querySelectorAll('#receiveItemsBody tr').forEach(row => {
                const qtyInput = row.querySelector('input[type="number"]');
                if (qtyInput && !qtyInput.disabled) {
                    const qtyToReceive = parseFloat(qtyInput.value) || 0;
                    const lineId = qtyInput.dataset.lineId;
                    
                    if (qtyToReceive > 0 && lineId) {
                        linesToReceive.push({
                            lineId: lineId,
                            qtyToReceive: qtyToReceive
                        });
                    }
                }
            });
            
            if (linesToReceive.length === 0) {
                alert('No items to receive. Enter quantities greater than 0.');
                return;
            }
            
            // Confirm
            const totalQty = linesToReceive.reduce((sum, l) => sum + l.qtyToReceive, 0);
            if (!confirm(`Receive ${totalQty} items into inventory?\n\nThis will update your stock levels.`)) {
                return;
            }
            
            isCommittingReceivePartial = true;
            const commitBtn = document.getElementById('modalSaveBtn');
            if (commitBtn) {
                commitBtn.disabled = true;
                commitBtn.textContent = ' Processing...';
            }
            
            try {
                const data = {
                    poId: poId,
                    notes: notes,
                    lines: linesToReceive
                };
                
                console.log('Calling receivePOItems with:', JSON.stringify(data));
                
                const result = await apiCall('receivePOItems', data);
                
                console.log('API result:', JSON.stringify(result));
                
                if (result && result.status === 'success') {
                    // Update receive date on PO (but NOT the Invoice_Number - that's our internal PO#)
                    // Supplier's invoice # is stored in notes for reference
                    const updateData = { poId: poId };
                    
                    // DON'T update invoiceNumber - that's our internal tracking number!
                    // Instead, append supplier invoice to notes if provided
                    if (receiveDate) updateData.receiveDate = receiveDate;
                    
                    // If supplier invoice provided, append to existing notes
                    if (invoiceNumber.trim()) {
                        const existingNotes = notes.trim();
                        const supplierInvoiceNote = ` Supplier Invoice #: ${invoiceNumber.trim()}`;
                        updateData.notes = existingNotes 
                            ? `${existingNotes}\n${supplierInvoiceNote}`
                            : supplierInvoiceNote;
                        console.log('Stored supplier invoice in notes:', invoiceNumber);
                    }
                    
                    if (updateData.receiveDate || updateData.notes) {
                        await apiCall('updatePurchaseOrder', updateData);
                        console.log('Updated PO - Receive Date:', receiveDate, 'Supplier Invoice stored in notes');
                    }
                    
                    const statusMsg = result.newStatus === 'Received' 
                        ? ' All items received! PO is now complete.' 
                        : ` Items received. PO status: ${result.newStatus} (${result.totalReceived}/${result.totalOrdered})`;
                    
                    alert(statusMsg + '\n\nInventory has been updated.');
                    
                    document.getElementById('orderModal').style.display = 'none';
                    document.body.classList.remove('modal-open');
                    
                    // Reload data
                    await loadPurchases();
                    await loadItems();
                } else {
                    alert(' Error: ' + (result?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error in commitReceivePartial:', error);
                alert(' Error: ' + error.message);
            } finally {
                isCommittingReceivePartial = false;
                if (commitBtn) {
                    commitBtn.disabled = false;
                    commitBtn.textContent = ' Receive Items into Inventory';
                }
            }
        }
        
        function removeReceiveLine(index) {
            const row = document.getElementById(`receiveLine${index}`);
            if (row) {
                row.remove();
                recalculateReceiveTotal();
            }
        }
        
        function addReceiveLine() {
            const tbody = document.getElementById('receiveItemsBody');
            const index = window.receiveLineCounter++;
            const supplierId = window.currentReceivePO.Supplier_ID;
            
            // Get items for this supplier
            const supplierItems = cachedItems.filter(item => item.Supplier_ID === supplierId);
            
            const row = document.createElement('tr');
            row.id = `receiveLine${index}`;
            row.dataset.isOriginal = 'false';
            row.innerHTML = `
                <td style="text-align: center; padding: 8px 4px;">
                    <input type="checkbox" id="receiveCheck${index}" checked onchange="updateReceiveLine(${index})" style="width: 20px; height: 20px;">
                </td>
                <td style="padding: 8px;">
                    <select id="receiveItem${index}" onchange="updateReceiveItemCost(${index})" style="width: 100%; padding: 8px; font-size: 14px; box-sizing: border-box;">
                        <option value="">Select item...</option>
                        ${supplierItems.map(item => `<option value="${item.Item_ID}" data-cost="${item.Package_Cost}">${item.Item_Description}</option>`).join('')}
                    </select>
                </td>
                <td style="text-align: center; padding: 8px 4px; color: #999;">N/A</td>
                <td style="padding: 8px 4px;">
                    <input type="number" 
                           id="receiveQty${index}" 
                           value="1" 
                           min="0" 
                           step="1"
                           data-item-id=""
                           data-ordered="0"
                           data-cost="0"
                           style="width: 100%; padding: 8px; font-size: 14px; text-align: center; box-sizing: border-box;"
                           oninput="updateReceiveLine(${index})">
                </td>
                <td style="text-align: right; padding: 8px 4px; font-size: 13px;" id="receiveCost${index}">$0.00</td>
                <td style="text-align: right; padding: 8px 4px; font-weight: bold;" id="receiveLineTotal${index}">$0.00</td>
                <td style="text-align: center; padding: 8px 4px;">
                    <button type="button" class="btn-danger" onclick="removeReceiveLine(${index})" style="padding: 6px 10px; font-size: 14px;"></button>
                </td>
            `;
            tbody.appendChild(row);
        }
        
        function updateReceiveItemCost(index) {
            const select = document.getElementById(`receiveItem${index}`);
            const qtyInput = document.getElementById(`receiveQty${index}`);
            const costTd = document.getElementById(`receiveCost${index}`);
            
            const selectedOption = select.options[select.selectedIndex];
            const cost = parseFloat(selectedOption.dataset.cost) || 0;
            
            qtyInput.dataset.itemId = select.value;
            qtyInput.dataset.cost = cost;
            costTd.textContent = '$' + cost.toFixed(2);
            
            updateReceiveLine(index);
        }
        
        function recalculateReceiveTotal() {
            let grandTotal = 0;
            document.querySelectorAll('[id^="receiveLineTotal"]').forEach(td => {
                const amount = parseFloat(td.textContent.replace('$', '')) || 0;
                grandTotal += amount;
            });
            const grandTotalEl = document.getElementById('receiveGrandTotal');
            if (grandTotalEl) {
                grandTotalEl.textContent = '$' + grandTotal.toFixed(2);
            }
        }
        
        function updateReceiveLine(index) {
            const checkbox = document.getElementById(`receiveCheck${index}`);
            const qtyInput = document.getElementById(`receiveQty${index}`);
            const lineTotal = document.getElementById(`receiveLineTotal${index}`);
            
            if (!checkbox || !qtyInput || !lineTotal) return;
            
            if (!checkbox.checked) {
                qtyInput.value = 0;
                qtyInput.disabled = true;
            } else {
                qtyInput.disabled = false;
            }
            
            const qty = parseFloat(qtyInput.value) || 0;
            const cost = parseFloat(qtyInput.dataset.cost) || 0;
            const total = qty * cost;
            
            lineTotal.textContent = '$' + total.toFixed(2);
            
            // Recalculate grand total
            recalculateReceiveTotal();
        }
        
        let isCommittingReceive = false; // Prevent double-click
        
        async function commitReceive(poId) {
            // Prevent double-click
            if (isCommittingReceive) {
                console.log('Already committing receive, ignoring duplicate click');
                return;
            }
            
            const invoiceNumber = document.getElementById('receiveInvoiceNumber').value;
            const receiveDate = document.getElementById('receiveDate').value;
            const notes = document.getElementById('receiveNotes').value;
            
            if (!invoiceNumber) {
                if (!confirm('No invoice number entered. Continue anyway?')) {
                    return;
                }
            }
            
            // Collect all receive lines (including added ones)
            const receivedLines = [];
            const rows = document.querySelectorAll('#receiveItemsBody tr');
            
            console.log('Found ' + rows.length + ' rows in receive table');
            
            rows.forEach((row, idx) => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                const qtyInput = row.querySelector('input[type="number"]');
                
                console.log('Row ' + idx + ': checkbox=' + (checkbox ? checkbox.checked : 'null') + ', qtyInput=' + (qtyInput ? qtyInput.value : 'null'));
                
                if (checkbox && checkbox.checked && qtyInput) {
                    const qty = parseFloat(qtyInput.value) || 0;
                    const itemId = qtyInput.dataset.itemId;
                    const qtyOrdered = parseFloat(qtyInput.dataset.ordered) || 0;
                    const cost = parseFloat(qtyInput.dataset.cost) || 0;
                    
                    console.log('  itemId=' + itemId + ', qty=' + qty);
                    
                    if (qty > 0 && itemId) {
                        receivedLines.push({
                            itemId: itemId,
                            qtyOrdered: qtyOrdered,
                            qtyReceived: qty,
                            unitCost: cost
                        });
                    }
                }
            });
            
            console.log('Collected ' + receivedLines.length + ' lines to receive');
            
            if (receivedLines.length === 0) {
                alert('Please select at least one item to receive');
                return;
            }
            
            // LOCK - Prevent double submit
            isCommittingReceive = true;
            
            // Disable the commit button
            const commitBtn = document.getElementById('modalSaveBtn');
            if (commitBtn) {
                commitBtn.disabled = true;
                commitBtn.textContent = ' Processing...';
            }
            
            try {
                // Call API to process PO receipt
                const data = {
                    poId: poId,
                    invoiceNumber: invoiceNumber,
                    receiveDate: receiveDate,
                    notes: notes,
                    lines: receivedLines
                };
                
                console.log('Calling receiveOutgoingPO with data:', JSON.stringify(data));
                
                const result = await apiCall('receiveOutgoingPO', data);
                
                console.log('API result:', JSON.stringify(result));
                
                if (result && result.status === 'success') {
                    alert(' Items received successfully! Inventory has been updated.');
                    document.getElementById('orderModal').style.display = 'none';
                    document.body.classList.remove('modal-open');
                    
                    // Reload purchases and items
                    await loadPurchases();
                    await loadItems();
                } else {
                    alert(' Error receiving items: ' + (result?.message || JSON.stringify(result) || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error in commitReceive:', error);
                alert(' Error: ' + error.message);
            } finally {
                // UNLOCK
                isCommittingReceive = false;
                
                // Re-enable button
                if (commitBtn) {
                    commitBtn.disabled = false;
                    commitBtn.textContent = ' Commit to Inventory';
                }
            }
        }
        
        let isSavingOutgoingPO = false; // Prevent double-click
        
        async function saveOutgoingPO() {
            // Prevent double-click
            if (isSavingOutgoingPO) {
                console.log('Already saving PO, ignoring duplicate click');
                return;
            }
            
            const supplierId = document.getElementById('createPOSupplier').value;
            const poDate = document.getElementById('createPODate').value;
            const expectedDeliveryDate = document.getElementById('createPOExpectedDate').value;
            const notes = document.getElementById('createPONotes')?.value;
            
            if (!supplierId || !poDate) {
                alert('Please select supplier and date');
                return;
            }
            
            if (!expectedDeliveryDate) {
                alert('Please select an Expected Delivery Date');
                return;
            }
            
            // Get line items
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            const lineItems = [];
            
            rows.forEach(row => {
                const itemId = row.querySelector('.createpo-item').value;
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                const costDiv = row.querySelector('.createpo-cost');
                
                // Parse cost from text
                const costText = costDiv.textContent.replace('$', '');
                const cost = costText === '-' ? 0 : parseFloat(costText);
                
                if (itemId && qty > 0) {
                    lineItems.push({
                        itemId: itemId,
                        quantity: qty,
                        unitCost: cost
                    });
                }
            });
            
            if (lineItems.length === 0) {
                alert('Please add at least one line item');
                return;
            }
            
            // LOCK - Prevent double submit
            isSavingOutgoingPO = true;
            
            // Disable the button visually
            const saveBtn = document.querySelector('button[onclick="saveOutgoingPO()"]');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = ' Saving...';
            }
            
            try {
                // Calculate total
                const total = lineItems.reduce((sum, item) => sum + (item.quantity * item.unitCost), 0);
            
            // AUTO-GENERATE PO NUMBER
            // Format: PO-MMDDYY-XXX (e.g., PO-120725-001)
            const dateObj = poDate ? new Date(poDate) : new Date();
            
            // Format date as MMDDYY
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const year = String(dateObj.getFullYear()).slice(-2); // Last 2 digits
            const dateStr = `${month}${day}${year}`;
            
            // Get all existing POs to find the next number for this date
            const existingPOs = await apiCall('getPurchaseOrders');
            let nextNumber = 1;
            
            if (existingPOs && existingPOs.data && existingPOs.data.length > 0) {
                // Find highest PO number for this date
                const prefix = `PO-${dateStr}-`;
                const todayPOs = existingPOs.data
                    .filter(po => po.Invoice_Number && po.Invoice_Number.startsWith(prefix))
                    .map(po => {
                        const parts = po.Invoice_Number.split('-');
                        return parseInt(parts[2]) || 0;
                    });
                
                if (todayPOs.length > 0) {
                    nextNumber = Math.max(...todayPOs) + 1;
                }
            }
            
            // Generate PO number: PO-120725-001
            const poNumber = `PO-${dateStr}-${String(nextNumber).padStart(3, '0')}`;
            
            // Get the selected date and add current time
            const now = new Date();
            const poDateWithTime = poDate === getTodayLocalDate() 
                ? now.toISOString()  // Today - use actual current time
                : `${poDate}T${now.toTimeString().split(' ')[0]}`; // Other date - add current time
            
            // Create OUTGOING PO
            const data = {
                supplierId: supplierId,
                invoiceNumber: poNumber,
                poDate: poDateWithTime,  // Fixed: was 'purchaseDate', backend expects 'poDate'
                dueDate: expectedDeliveryDate,
                paymentTerms: 'Net 30',
                status: 'Ordered', // OUTGOING status
                totalAmount: total,
                amountPaid: 0,
                notes: notes || '',
                lineItems: lineItems,  // Fixed: was 'lines', backend expects 'lineItems'
                poType: 'INCOMING' // Fixed: should be INCOMING for supplier POs
            };
            
            const result = await apiCall('createPurchaseOrder', data);
            
            if (result && result.status === 'success') {
                alert(` OUTGOING PO created successfully!\n\nPO Number: ${poNumber}\n\nItems marked as "On Order".`);
                clearCreatePOForm();
                
                // Refresh items to update Qty_On_Order
                await loadItems();
            } else {
                alert(' Error creating OUTGOING PO: ' + (result?.message || 'Unknown error'));
            }
            } finally {
                // UNLOCK - Always reset even if error
                isSavingOutgoingPO = false;
                
                // Re-enable button
                const saveBtn = document.querySelector('button[onclick="saveOutgoingPO()"]');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = ' Save PO';
                }
            }
        }
        
        function generatePrintablePO() {
            const supplierId = document.getElementById('createPOSupplier').value;
            const poDate = document.getElementById('createPODate').value;
            
            if (!supplierId || !poDate) {
                alert('Please select supplier and date');
                return;
            }
            
            // Get line items
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            const lineItems = [];
            
            rows.forEach(row => {
                const itemId = row.querySelector('.createpo-item').value;
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                const costDiv = row.querySelector('.createpo-cost');
                const unitsDiv = row.querySelector('.createpo-units');
                const totalUnitsDiv = row.querySelector('.createpo-totalunits');
                
                // Parse cost from text
                const costText = costDiv.textContent.replace('$', '');
                const cost = costText === '-' ? 0 : parseFloat(costText);
                
                // Parse units from text
                const unitsText = unitsDiv.textContent;
                const unitsPerCase = unitsText === '-' ? 0 : parseFloat(unitsText);
                
                // Parse total units from text
                const totalUnitsText = totalUnitsDiv.textContent;
                const totalUnits = totalUnitsText === '-' ? 0 : parseFloat(totalUnitsText);
                
                if (itemId && qty > 0) {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    if (item) {
                        lineItems.push({
                            sku: item.SKU || item.Item_ID,
                            description: item.Item_Description,
                            qty: qty,
                            unitsPerCase: unitsPerCase,
                            totalUnits: totalUnits,
                            cost: cost,
                            total: qty * cost
                        });
                    }
                }
            });
            
            if (lineItems.length === 0) {
                alert('Please add at least one line item');
                return;
            }
            
            // Get supplier info
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            if (!supplier) {
                alert('Supplier not found');
                return;
            }
            
            // Get invoice settings - USE THE SAME METHOD AS SALES INVOICES
            const settings = getInvoiceSettings();
            const companyName = settings.companyName;
            const companyContactName = settings.contactName;
            const companyPhone = settings.phone;
            const companyEmail = settings.email;
            const companyAddress1 = settings.address1;
            const companyAddress2 = settings.address2;
            const companyCityStateZip = settings.cityStateZip;
            
            const total = lineItems.reduce((sum, item) => sum + item.total, 0);
            
            // Generate printable HTML
            let html = `
                <style>
                    @media print {
                        body * { visibility: hidden; }
                        #printablePO, #printablePO * { visibility: visible; }
                        #printablePO { position: absolute; left: 0; top: 0; width: 100%; }
                        button { display: none !important; }
                    }
                    .po-header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #667eea; padding-bottom: 20px; }
                    .po-info { display: flex; justify-content: space-between; margin-bottom: 30px; }
                    .po-box { flex: 1; }
                    .po-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    .po-table th { background: #667eea; color: white; padding: 12px; text-align: left; }
                    .po-table td { border: 1px solid #ddd; padding: 10px; }
                    .po-total { text-align: right; font-size: 20px; font-weight: bold; margin-top: 20px; }
                </style>
                
                <div class="po-header">
                    <h1 style="color: #667eea; margin: 0;">PURCHASE ORDER</h1>
                    <p style="font-size: 16pt; margin: 5px 0;">${companyName}</p>
                    <p style="margin: 5px 0;">Date: ${new Date(poDate).toLocaleDateString()}</p>
                </div>
                
                <div class="po-info">
                    <div class="po-box">
                        <h3>From:</h3>
                        <p><strong>${companyName}</strong></p>
                        ${companyContactName ? `<p>${companyContactName}</p>` : ''}
                        <p>${companyAddress1}</p>
                        ${companyAddress2 ? `<p>${companyAddress2}</p>` : ''}
                        <p>${companyCityStateZip}</p>
                        <p>Phone: ${companyPhone}</p>
                        <p>Email: ${companyEmail}</p>
                    </div>
                    <div class="po-box">
                        <h3>To:</h3>
                        <p><strong>${supplier.Supplier_Name}</strong></p>
                        ${supplier.Address ? `<p>${supplier.Address}</p>` : ''}
                        ${supplier.City || supplier.State || supplier.ZIP ? `<p>${supplier.City || ''}${supplier.City && supplier.State ? ', ' : ''}${supplier.State || ''} ${supplier.ZIP || ''}</p>` : ''}
                        ${supplier.Phone ? `<p>Phone: ${supplier.Phone}</p>` : ''}
                        ${supplier.Email ? `<p>Email: ${supplier.Email}</p>` : ''}
                    </div>
                </div>
                
                <table class="po-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Description</th>
                            <th style="text-align: center;">Cases</th>
                            <th style="text-align: center;">Units/Case</th>
                            <th style="text-align: center;">Total Units</th>
                            <th style="text-align: right;">Cost/Case</th>
                            <th style="text-align: right;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            lineItems.forEach(item => {
                html += `
                    <tr>
                        <td>${item.sku}</td>
                        <td>${item.description}</td>
                        <td style="text-align: center;">${item.qty}</td>
                        <td style="text-align: center;">${item.unitsPerCase}</td>
                        <td style="text-align: center;"><strong>${item.totalUnits}</strong></td>
                        <td style="text-align: right;">${formatMoney(item.cost)}</td>
                        <td style="text-align: right;">${formatMoney(item.total)}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <div class="po-total">
                    <p>TOTAL: ${formatMoney(total)}</p>
                </div>
                
                <div style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <p style="color: #666; font-size: 14px;">
                        Please confirm receipt of this purchase order and provide expected delivery date.
                    </p>
                </div>
            `;
            
            // Display printable PO
            document.getElementById('printablePO').innerHTML = html;
            document.getElementById('printablePOContainer').style.display = 'block';
            document.getElementById('createPOForm').style.display = 'none';
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
        
        function closePrintablePO() {
            document.getElementById('printablePOContainer').style.display = 'none';
            document.getElementById('createPOForm').style.display = 'block';
        }
        
        function downloadPOAsPDF() {
            // Get PO details
            const supplierId = document.getElementById('createPOSupplier').value;
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            const poDate = document.getElementById('createPODate').value;
            
            if (!supplier) {
                alert('Supplier not found');
                return;
            }
            
            // Create a clean filename
            const fileName = `PO_${supplier.Supplier_Name.replace(/[^a-z0-9]/gi, '_')}_${poDate}.pdf`;
            
            // For now, trigger print dialog with instruction
            alert('PDF Download:\n\n1. Click OK\n2. In the print dialog, select "Save as PDF"\n3. Click Save\n\nNote: Full automated PDF generation requires a backend service.');
            window.print();
        }
        
        function emailPO() {
            // Get supplier email
            const supplierId = document.getElementById('createPOSupplier').value;
            const supplier = cachedSuppliers.find(s => s.Supplier_ID === supplierId);
            const poDate = document.getElementById('createPODate').value;
            
            if (!supplier) {
                alert('Supplier not found');
                return;
            }
            
            const supplierEmail = supplier.Email || '';
            
            if (!supplierEmail) {
                alert('No email address found for ' + supplier.Supplier_Name + '. Please add an email address to the supplier record first.');
                return;
            }
            
            // Get company info - USE THE SAME METHOD AS SALES INVOICES
            const settings = getInvoiceSettings();
            const companyName = settings.companyName;
            
            // Get line items for email body
            const rows = document.querySelectorAll('#createPOLineItems .line-item-row');
            let itemsList = '';
            rows.forEach(row => {
                const itemId = row.querySelector('.createpo-item').value;
                const qty = parseFloat(row.querySelector('.createpo-qty').value) || 0;
                if (itemId && qty > 0) {
                    const item = cachedItems.find(i => i.Item_ID === itemId);
                    if (item) {
                        itemsList += ` ${item.Item_Description} - ${qty} cases\n`;
                    }
                }
            });
            
            const totalCases = document.getElementById('createPOTotalCases').textContent;
            const totalCost = document.getElementById('createPOTotal').textContent;
            
            // Create email subject and body
            const subject = `Purchase Order from ${companyName} - ${poDate}`;
            const body = `Dear ${supplier.Supplier_Name},

Please find our purchase order for ${poDate}:

${itemsList}
---
Total Cases: ${totalCases}
Total: ${totalCost}

Please confirm receipt and expected delivery date.

Best regards,
${companyName}

---
NOTE: Please print the attached PO document for full details.`;
            
            // Create mailto link
            const mailtoLink = `mailto:${supplierEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Inform user to attach the PO
            alert('Email Instructions:\n\n1. Your email client will open with the supplier\'s email pre-filled\n2. IMPORTANT: Print or save this PO as PDF first (use Print button)\n3. Attach the PDF to the email before sending\n\nClick OK to open your email client.');
            
            // Open email client
            window.location.href = mailtoLink;
        }
        
        function clearCreatePOForm() {
            document.getElementById('createPOSupplier').value = '';
            document.getElementById('createPODate').value = getTodayLocalDate();
            document.getElementById('createPOExpectedDate').value = ''; // User must select
            
            // Clear Notes field - be more aggressive
            const notesField = document.getElementById('createPONotes');
            if (notesField) {
                notesField.value = '';
                notesField.textContent = '';  // Also clear textContent for textareas
            }
            
            // Also clear old form notes if it exists (in case both are in DOM)
            const oldNotesField = document.getElementById('poNotes');
            if (oldNotesField) {
                oldNotesField.value = '';
                oldNotesField.textContent = '';
            }
            
            // Clear all line items except the first one
            const container = document.getElementById('createPOLineItems');
            const rows = container.querySelectorAll('.line-item-row');
            rows.forEach((row, index) => {
                if (index === 0) {
                    const itemSelect = row.querySelector('.createpo-item');
                    if (itemSelect) itemSelect.value = '';
                    const qtyInput = row.querySelector('.createpo-qty');
                    if (qtyInput) qtyInput.value = '';
                    const unitsDiv = row.querySelector('.createpo-units');
                    if (unitsDiv) unitsDiv.textContent = '-';
                    const totalUnitsDiv = row.querySelector('.createpo-totalunits');
                    if (totalUnitsDiv) totalUnitsDiv.textContent = '-';
                    const costDiv = row.querySelector('.createpo-cost');
                    if (costDiv) costDiv.textContent = '-';
                    const lineTotalDiv = row.querySelector('.createpo-linetotal');
                    if (lineTotalDiv) lineTotalDiv.textContent = '$0.00';
                } else {
                    row.remove();
                }
            });
            
            // Re-populate item options for first row (since supplier is now cleared)
            filterItemsBySupplier();
            
            calculateCreatePOTotal();
            
            console.log(' Create PO form cleared');
        }
        
        // ===== ITEM PICKER FUNCTIONS (must be here so inline handlers work) =====
        window.itemPickerItems = window.itemPickerItems || [];
        window.itemPickerIsFilter = false;
        window.itemPickerCallback = null;
        window.itemPickerSupplierContext = ''; // Stores supplier context for PO mode
        
        // Define globally immediately so inline handlers can find it
        window.filterItemPicker = function() {
            window.renderItemPickerList();
        };
        
        window.renderItemPickerList = function() {
            const searchEl = document.getElementById('itemPickerSearch');
            const supplierEl = document.getElementById('itemPickerSupplier');
            const listContainer = document.getElementById('itemPickerList');
            
            if (!listContainer) return;
            
            const search = searchEl ? searchEl.value.toLowerCase().trim() : '';
            // Use global context if select is empty (for PO mode where select is hidden)
            const supplier = (supplierEl && supplierEl.value) ? supplierEl.value : (window.itemPickerSupplierContext || '');
            
            const isFilterInput = window.itemPickerIsFilter;
            const isMultiSelect = window.multiSelectMode || false;
            const selectedItems = window.multiSelectedItems || new Set();
            
            let filtered = (window.itemPickerItems || []).filter(item => {
                // Search filter - check SKU and Description (convert to string first!)
                const sku = String(item.SKU || '').toLowerCase();
                const desc = String(item.Item_Description || '').toLowerCase();
                const matchesSearch = !search || sku.includes(search) || desc.includes(search);
                
                // Supplier filter - use matchesFilter for multi-select support
                const matchesSupplier = matchesFilter(item.Supplier_ID, supplier);
                
                // Hide archived items UNLESS this is a filter input
                const isArchived = item.Status === 'Archived';
                const matchesActive = isFilterInput || !isArchived;
                
                return matchesSearch && matchesSupplier && matchesActive;
            });
            
            let html = '';
            
            // Show selection count in multi-select mode
            if (isMultiSelect && selectedItems.size > 0) {
                html += `
                    <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #2e7d32; font-weight: bold;"> ${selectedItems.size} item${selectedItems.size > 1 ? 's' : ''} selected</span>
                        <button onclick="clearMultiSelection()" style="background: #fff; border: 1px solid #ccc; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Clear All</button>
                    </div>
                `;
            }
            
            // Add "Clear Filter" option for filter text inputs
            if (isFilterInput && !search && !supplier) {
                html += `
                    <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) clearItemFilter()" onclick="clearItemFilter()" style="border-left: 4px solid #6c757d; background: #f8f9fa;">
                        <div class="item-picker-desc" style="font-weight: bold; color: #495057;">
                            <span style="font-size: 18px; margin-right: 8px;"></span> Clear Filter
                        </div>
                        <div style="font-size: 12px; color: #6c757d;">Remove item filter and show all items</div>
                    </div>
                `;
            }
            
            if (filtered.length === 0) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No items found</div>
                        <div style="font-size: 14px; margin-top: 5px;">Try a different search term</div>
                    </div>
                `;
                return;
            }
            
            filtered.forEach(item => {
                const qty = parseInt(item.Qty_On_Hand) || 0;
                const reorder = parseInt(item.Reorder_Point) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                const onBackorder = parseInt(item.Qty_On_Backorder) || 0;
                const expectedDate = item.Expected_Restock_Date;
                const sellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const pkgCost = parseFloat(item.Package_Cost) || 0;
                const unitsPer = parseInt(item.Units_Per_Package) || 1;
                const unitCost = pkgCost / unitsPer;
                
                let stockClass = 'in-stock';
                let stockText = `${qty} in stock`;
                if (qty <= 0) {
                    stockClass = 'out-of-stock';
                    stockText = 'Out of stock';
                } else if (qty <= reorder) {
                    stockClass = 'low-stock';
                    stockText = `Low: ${qty}`;
                }
                
                // Add On Order badge if there's quantity on order
                const onOrderBadge = onOrder > 0 ? `<span class="item-picker-stock" style="background: #e3f2fd; color: #1976d2; border: 2px solid #90caf9; margin-left: 6px;"> On Order: ${onOrder}</span>` : '';
                
                // Add Backorder badge if there's quantity on backorder
                const backorderBadge = onBackorder > 0 ? `<span class="item-picker-stock" style="background: #fff3e0; color: #e65100; border: 2px solid #ffb74d; margin-left: 6px;"> Backorder: ${onBackorder}</span>` : '';
                
                // Add Expected Date badge if available
                let expectedDateBadge = '';
                if (expectedDate && onOrder > 0) {
                    const expDate = new Date(expectedDate);
                    const today = new Date();
                    const daysUntil = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                    let dateColor = '#2e7d32';
                    let dateBg = '#e8f5e9';
                    let dateBorder = '#81c784';
                    
                    if (daysUntil < 0) {
                        dateColor = '#c62828';
                        dateBg = '#ffebee';
                        dateBorder = '#e57373';
                    } else if (daysUntil <= 3) {
                        dateColor = '#e65100';
                        dateBg = '#fff3e0';
                        dateBorder = '#ffb74d';
                    }
                    
                    const dateText = daysUntil < 0 ? `Overdue ${Math.abs(daysUntil)}d` : 
                                     daysUntil === 0 ? 'Today' : 
                                     daysUntil === 1 ? 'Tomorrow' : 
                                     `${daysUntil} days`;
                    
                    expectedDateBadge = `<span class="item-picker-stock" style="background: ${dateBg}; color: ${dateColor}; border: 2px solid ${dateBorder}; margin-left: 6px;"> Expected: ${expDate.toLocaleDateString()} (${dateText})</span>`;
                }
                
                // Add Top Seller badge if applicable
                let topSellerBadge = '';
                if (item.Top_Seller_Rank) {
                    const rank = parseInt(item.Top_Seller_Rank);
                    if (rank === 1) {
                        topSellerBadge = `<span class="item-picker-stock" style="background: #ffd700; color: #000; border: 2px solid #ffed4e; margin-left: 6px; font-weight: bold;"> #1 Best Seller</span>`;
                    } else if (rank <= 10) {
                        topSellerBadge = `<span class="item-picker-stock" style="background: #fff9c4; color: #f57f17; border: 2px solid #fbc02d; margin-left: 6px; font-weight: bold;"> Top 10 Best Seller</span>`;
                    } else if (rank <= 25) {
                        topSellerBadge = `<span class="item-picker-stock" style="background: #e3f2fd; color: #1565c0; border: 2px solid #64b5f6; margin-left: 6px;"> Top 25 Best Seller</span>`;
                    }
                }
                
                const supplierName = (cachedSuppliers || []).find(s => s.Supplier_ID === item.Supplier_ID)?.Supplier_Name || 'Unknown';
                
                // Multi-select mode: show checkbox
                const isSelected = selectedItems.has(item.Item_ID);
                const checkboxHtml = isMultiSelect ? `
                    <div style="position: absolute; top: 10px; right: 10px; z-index: 5;">
                        <div style="width: 28px; height: 28px; border-radius: 50%; border: 3px solid ${isSelected ? '#4caf50' : '#ccc'}; background: ${isSelected ? '#4caf50' : 'white'}; display: flex; align-items: center; justify-content: center;">
                            ${isSelected ? '<span style="color: white; font-size: 16px; font-weight: bold;"></span>' : ''}
                        </div>
                    </div>
                ` : '';
                
                const cardStyle = isMultiSelect && isSelected ? 'border: 3px solid #4caf50; background: #f1f8e9;' : '';
                const clickHandler = isMultiSelect ? `toggleMultiSelectItem('${item.Item_ID}')` : `selectItemFromPicker('${item.Item_ID}')`;
                
                html += `
                    <div class="item-picker-card" style="position: relative; ${cardStyle}"
                         ontouchstart="pickerTouchStart(event)" 
                         ontouchmove="pickerTouchMove(event)" 
                         ontouchend="if(pickerTouchEnd()) ${clickHandler}"
                         onclick="${clickHandler}">
                        ${checkboxHtml}
                        <div class="item-picker-header-row" style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center; margin-bottom: 8px;">
                            <span class="item-picker-sku">${item.SKU || ''}</span>
                            <span class="item-picker-stock ${stockClass}">${stockText}</span>${onOrderBadge}${backorderBadge}${topSellerBadge}
                        </div>
                        ${expectedDateBadge ? `<div style="margin-bottom: 8px;">${expectedDateBadge}</div>` : ''}
                        <div class="item-picker-desc">${item.Item_Description || ''}</div>
                        <div class="item-picker-details">
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Unit Cost</span>
                                <span class="item-picker-detail-value">${formatMoney(unitCost)}</span>
                            </div>
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Sell Price</span>
                                <span class="item-picker-detail-value item-picker-price">${formatMoney(sellPrice)}</span>
                            </div>
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Pkg</span>
                                <span class="item-picker-detail-value">${unitsPer}/${item.Purchase_UOM || 'Case'}</span>
                            </div>
                        </div>
                        <div class="item-picker-supplier"> ${supplierName}</div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        };
        
        // Multi-select helper functions
        function toggleMultiSelectItem(itemId) {
            if (!window.multiSelectedItems) window.multiSelectedItems = new Set();
            
            if (window.multiSelectedItems.has(itemId)) {
                window.multiSelectedItems.delete(itemId);
            } else {
                window.multiSelectedItems.add(itemId);
            }
            
            renderItemPickerList();
            updateMultiSelectCount();
        }
        
        function clearMultiSelection() {
            window.multiSelectedItems = new Set();
            renderItemPickerList();
            updateMultiSelectCount();
        }
        
        function updateMultiSelectCount() {
            const count = window.multiSelectedItems ? window.multiSelectedItems.size : 0;
            const countEl = document.getElementById('itemSelectionCount');
            if (countEl) {
                countEl.textContent = count > 0 ? `${count} item${count > 1 ? 's' : ''} selected` : '';
            }
        }
        
        // Open multi-select picker for Purchase Orders
        function openMultiItemPickerForPO() {
            const supplierId = document.getElementById('createPOSupplier').value;
            
            if (!supplierId) {
                alert('Please select a supplier first');
                return;
            }
            
            // Set up multi-select mode
            window.multiSelectMode = true;
            window.multiSelectContext = 'PO';
            window.multiSelectedItems = new Set();
            window.itemPickerSupplierContext = supplierId;
            window.itemPickerItems = cachedItems || [];
            
            // Hide supplier filter (already selected)
            const supplierFilterDiv = document.getElementById('itemPickerSupplierFilter');
            if (supplierFilterDiv) supplierFilterDiv.style.display = 'none';
            
            // Update modal header
            document.querySelector('#itemPickerModal .item-picker-header h3').textContent = ' Select Multiple Items';
            
            // Update Done button to add selected items
            const doneBtn = document.querySelector('#itemPickerModal .item-picker-footer button.btn');
            if (doneBtn) {
                doneBtn.textContent = ' Add Selected Items';
                doneBtn.onclick = addSelectedItemsToPO;
            }
            
            // Clear search
            document.getElementById('itemPickerSearch').value = '';
            
            // Render items
            renderItemPickerList();
            
            // Show modal
            document.getElementById('itemPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        // Open multi-select picker for Sales Orders
        function openMultiItemPickerForSO() {
            const customerId = document.getElementById('newSaleCustomer').value;
            
            if (!customerId) {
                alert('Please select a customer first');
                return;
            }
            
            // Set up multi-select mode
            window.multiSelectMode = true;
            window.multiSelectContext = 'SO';
            window.multiSelectedItems = new Set();
            window.itemPickerSupplierContext = ''; // Show all items for sales
            window.itemPickerItems = cachedItems || [];
            
            // Show supplier filter for sales
            const supplierFilterDiv = document.getElementById('itemPickerSupplierFilter');
            const supplierSelect = document.getElementById('itemPickerSupplier');
            if (supplierFilterDiv) {
                supplierFilterDiv.style.display = 'block';
                supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
                if (cachedSuppliers && cachedSuppliers.length > 0) {
                    cachedSuppliers.forEach(s => {
                        supplierSelect.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                    });
                }
                supplierSelect.value = '';
            }
            
            // Update modal header
            document.querySelector('#itemPickerModal .item-picker-header h3').textContent = ' Select Multiple Items';
            
            // Update Done button to add selected items
            const doneBtn = document.querySelector('#itemPickerModal .item-picker-footer button.btn');
            if (doneBtn) {
                doneBtn.textContent = ' Add Selected Items';
                doneBtn.onclick = addSelectedItemsToSO;
            }
            
            // Clear search
            document.getElementById('itemPickerSearch').value = '';
            
            // Render items
            renderItemPickerList();
            
            // Show modal
            document.getElementById('itemPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        // Add selected items to Purchase Order
        function addSelectedItemsToPO() {
            const selectedItems = window.multiSelectedItems || new Set();
            
            if (selectedItems.size === 0) {
                alert('Please select at least one item');
                return;
            }
            
            const supplierId = document.getElementById('createPOSupplier').value;
            const container = document.getElementById('createPOLineItems');
            
            // Get existing rows to check for duplicates
            const existingItems = new Set();
            container.querySelectorAll('.createpo-item').forEach(sel => {
                if (sel.value) existingItems.add(sel.value);
            });
            
            // Clear empty rows first
            const rows = container.querySelectorAll('.line-item-row');
            rows.forEach(row => {
                const itemSelect = row.querySelector('.createpo-item');
                if (!itemSelect.value) {
                    row.remove();
                }
            });
            
            // Add new rows for each selected item
            selectedItems.forEach(itemId => {
                if (existingItems.has(itemId)) return; // Skip duplicates
                
                const item = (cachedItems || []).find(i => i.Item_ID === itemId);
                if (!item) return;
                
                // Create new row
                const newRow = document.createElement('div');
                newRow.className = 'line-item-row';
                newRow.style.cssText = 'display: grid; grid-template-columns: 2.5fr 1fr 0.6fr 0.8fr 0.8fr 0.8fr 50px; gap: 8px; margin-bottom: 10px; align-items: end;';
                
                const cost = parseFloat(item.Package_Cost) || 0;
                const units = parseInt(item.Units_Per_Package) || 1;
                
                newRow.innerHTML = `
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                        <select class="createpo-item" style="width: 100%; padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white;" onchange="updateCreatePOItemCost(this)">
                            <option value="${item.Item_ID}" data-cost="${cost}" data-units="${units}" selected>${item.SKU || item.Item_ID} - ${item.Item_Description}</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Cases</label>
                        <input type="number" class="createpo-qty" placeholder="Qty" min="1" oninput="calculateCreatePOTotal()" style="width: 100%; padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px;">
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-units" style="text-align: center; font-size: 14px; color: #666; padding: 6px;">${units}</div>
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-totalunits" style="text-align: center; font-size: 16px; font-weight: bold; color: var(--primary, #667eea); padding: 6px;">-</div>
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-cost" style="text-align: center; font-size: 14px; font-weight: bold; color: #28a745; background: #e8f5e9; padding: 10px; border-radius: 6px;">$${cost.toFixed(2)}</div>
                    </div>
                    <div style="margin-top: 26px;">
                        <div class="createpo-linetotal" style="text-align: right; font-size: 14px; font-weight: bold; color: var(--primary, #667eea); background: var(--primary-light, #E3F2FD); padding: 10px; border-radius: 6px;">$0.00</div>
                    </div>
                    <button type="button" class="btn-danger" onclick="removeLineItem(this); calculateCreatePOTotal();" style="width: 100%; padding: 10px; font-size: 14px; margin-top: 26px;"></button>
                `;
                
                container.appendChild(newRow);
            });
            
            // Close picker
            closeItemPicker();
            
            // Focus first empty quantity field
            setTimeout(() => {
                const firstEmptyQty = container.querySelector('.createpo-qty:not([value]):not(:placeholder-shown), .createpo-qty[value=""]');
                if (firstEmptyQty) firstEmptyQty.focus();
            }, 100);
            
            alert(` Added ${selectedItems.size} item${selectedItems.size > 1 ? 's' : ''} to the order. Now enter quantities!`);
        }
        
        // Add selected items to Sales Order
        function addSelectedItemsToSO() {
            const selectedItems = window.multiSelectedItems || new Set();
            
            if (selectedItems.size === 0) {
                alert('Please select at least one item');
                return;
            }
            
            const container = document.getElementById('soLineItems');
            
            // Get existing rows to check for duplicates
            const existingItems = new Set();
            container.querySelectorAll('.so-item').forEach(sel => {
                if (sel.value) existingItems.add(sel.value);
            });
            
            // Clear empty rows first
            const rows = container.querySelectorAll('.line-item-row');
            rows.forEach(row => {
                const itemSelect = row.querySelector('.so-item');
                if (!itemSelect.value) {
                    row.remove();
                }
            });
            
            // Add new rows for each selected item
            selectedItems.forEach(itemId => {
                if (existingItems.has(itemId)) return; // Skip duplicates
                
                const item = (cachedItems || []).find(i => i.Item_ID === itemId);
                if (!item) return;
                
                const sellPrice = parseFloat(item.Unit_Sell_Price) || 0;
                const qty = parseInt(item.Qty_On_Hand) || 0;
                
                // Create new row
                const newRow = document.createElement('div');
                newRow.className = 'line-item-row';
                newRow.style.cssText = 'display: grid; grid-template-columns: 2.5fr 1fr 1fr 50px; gap: 10px; margin-bottom: 10px; align-items: end;';
                
                newRow.innerHTML = `
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px;"> Item</label>
                        <select class="so-item" required style="padding: 14px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; min-height: 52px; font-weight: 500; background: white; width: 100%;">
                            <option value="${item.Item_ID}" selected>${item.SKU || item.Item_ID} - ${item.Item_Description}</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Quantity</label>
                        <input type="number" class="so-qty" placeholder="Qty" min="1" required style="padding: 14px 10px; border: 2px solid #f9a825; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; background: #fffde7; min-height: 52px; width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; text-align: center;"> Price</label>
                        <input type="number" class="so-price" value="${sellPrice.toFixed(2)}" step="0.01" min="0" required style="padding: 14px 10px; border: 2px solid #667eea; border-radius: 8px; text-align: center; font-size: 16px; min-height: 52px; background: white; width: 100%;">
                    </div>
                    <button type="button" class="remove-btn" style="min-height: 52px; font-size: 18px; margin-top: 26px;"></button>
                    <div class="so-stock-info" style="grid-column: 1 / -1; font-size: 13px; padding: 8px 12px; margin-top: -5px; border-radius: 6px; border: 2px solid #e8f5e9; background: #f1f8e9;">
                         Stock: ${qty} available
                    </div>
                `;
                
                container.appendChild(newRow);
                
                // Attach remove handler
                newRow.querySelector('.remove-btn').onclick = function() {
                    this.closest('.line-item-row').remove();
                };
            });
            
            // Close picker
            closeItemPicker();
            
            // Focus first empty quantity field
            setTimeout(() => {
                const firstEmptyQty = container.querySelector('.so-qty:not([value]):not(:placeholder-shown), .so-qty[value=""]');
                if (firstEmptyQty) firstEmptyQty.focus();
            }, 100);
            
            alert(` Added ${selectedItems.size} item${selectedItems.size > 1 ? 's' : ''} to the order. Now enter quantities!`);
        }
        
        // ============================================================================
        // INVENTORY FLOW DASHBOARD FUNCTIONS
        // ============================================================================
        
        /**
         * Refresh the entire Inventory Flow Dashboard
         */
        // Wrapper function with timeout to prevent hanging
        async function refreshInventoryFlowWithTimeout() {
            const timeoutMs = 30000; // 30 seconds timeout
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('Dashboard loading timed out after 30 seconds. This usually means the backend is not responding or data is too large.')), timeoutMs);
            });
            
            try {
                await Promise.race([
                    refreshInventoryFlow(),
                    timeoutPromise
                ]);
            } catch (error) {
                console.error('Dashboard timeout or error:', error);
                console.log('Dashboard failed to load: ' + error.message);
                
                const alertsDiv = document.getElementById('invflowAlerts');
                if (alertsDiv) {
                    alertsDiv.innerHTML = `
                        <div style="background: #fee2e2; border: 2px solid #dc2626; border-radius: 12px; padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 32px;"></div>
                                <div>
                                    <h4 style="margin: 0 0 8px 0; color: #dc2626;">Dashboard Loading Issue</h4>
                                    <p style="margin: 0; color: #991b1b;">${error.message}</p>
                                    <p style="margin: 8px 0 0 0; color: #991b1b; font-size: 12px;">Open browser console (F12) to see what step failed</p>
                                    <button onclick="refreshInventoryFlowWithTimeout()" style="margin-top: 12px; background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                         Try Again
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        async function refreshInventoryFlow() {
            console.log(' Starting refreshInventoryFlow...');
            try {
                console.log('Loading inventory flow data...');
                
                // Make sure we have all the data loaded
                console.log(' Checking cached data...');
                console.log('- cachedItems:', cachedItems ? cachedItems.length : 'null/undefined');
                console.log('- purchasesData:', purchasesData ? purchasesData.length : 'null/undefined');
                console.log('- salesData:', salesData ? salesData.length : 'null/undefined');
                
                if (!cachedItems || cachedItems.length === 0) {
                    console.log(' Loading items...');
                    await loadItems();
                    console.log(' Items loaded:', cachedItems ? cachedItems.length : '0');
                }
                if (!purchasesData || purchasesData.length === 0) {
                    console.log(' Loading purchase orders...');
                    await loadPurchases();
                    console.log(' Purchase orders loaded:', purchasesData ? purchasesData.length : '0');
                }
                if (!salesData || salesData.length === 0) {
                    console.log(' Loading sales orders...');
                    await loadSales();
                    console.log(' Sales orders loaded:', salesData ? salesData.length : '0');
                }
                
                console.log(' Calculating metrics...');
                calculateInvFlowMetrics();
                console.log(' Metrics calculated');
                
                console.log(' Rendering alerts...');
                renderInvFlowAlerts();
                console.log(' Alerts rendered');
                
                console.log(' Rendering backorder items...');
                renderInvFlowBackorderItems();
                console.log(' Backorder items rendered');
                
                console.log(' Rendering pending POs...');
                renderInvFlowPendingPOs();
                console.log(' Pending POs rendered');
                
                console.log(' Rendering critical items...');
                renderInvFlowCriticalItems();
                console.log(' Critical items rendered');
                
                console.log(' Dashboard refresh complete!');
                console.log('Inventory flow dashboard updated!');
            } catch (error) {
                console.error(' Error refreshing inventory flow:', error);
                console.error('Error stack:', error.stack);
                console.error('Error loading dashboard: ' + error.message);
                
                // Show error in alerts section
                const alertsDiv = document.getElementById('invflowAlerts');
                if (alertsDiv) {
                    alertsDiv.innerHTML = `
                        <div style="background: #fee2e2; border: 2px solid #dc2626; border-radius: 12px; padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 32px;"></div>
                                <div>
                                    <h4 style="margin: 0 0 8px 0; color: #dc2626;">Error Loading Dashboard</h4>
                                    <p style="margin: 0; color: #991b1b;">${error.message}</p>
                                    <p style="margin: 8px 0 0 0; color: #991b1b; font-size: 12px;">Check browser console (F12) for details</p>
                                    <button onclick="refreshInventoryFlowWithTimeout()" style="margin-top: 12px; background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                         Try Again
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        /**
         * Calculate summary metrics for inventory flow
         */
        function calculateInvFlowMetrics() {
            try {
                const items = cachedItems || [];
                const pos = purchasesData || [];
                
                // Total On Order - check if field exists and has data
                const totalOnOrder = items.reduce((sum, item) => {
                    const qty = item.Qty_On_Order;
                    if (qty === undefined || qty === null || qty === '') return sum;
                    return sum + (parseInt(qty) || 0);
                }, 0);
                
                // Total Backorder - check if field exists and has data
                const totalBackorder = items.reduce((sum, item) => {
                    const qty = item.Qty_On_Backorder;
                    if (qty === undefined || qty === null || qty === '') return sum;
                    return sum + (parseInt(qty) || 0);
                }, 0);
                
                // POs This Week
                const now = new Date();
                const endOfWeek = new Date(now);
                endOfWeek.setDate(now.getDate() + (7 - now.getDay()));
                
                const posThisWeek = pos.filter(po => {
                    if (!po || !po.Status) return false;
                    if (['Received', 'Cancelled', 'Voided'].includes(po.Status)) return false;
                    if (!po.Need_By_Date) return false;
                    try {
                        const needBy = new Date(po.Need_By_Date);
                        return needBy <= endOfWeek;
                    } catch (e) {
                        return false;
                    }
                }).length;
                
                // Total Value Pending
                const totalValue = pos.filter(po => {
                    if (!po || !po.Status) return false;
                    return !['Received', 'Cancelled', 'Voided'].includes(po.Status);
                }).reduce((sum, po) => {
                    return sum + (parseFloat(po.Total_Amount) || 0);
                }, 0);
                
                // Update display - use safe defaults
                const totalOnOrderEl = document.getElementById('invflowTotalOnOrder');
                const totalBackorderEl = document.getElementById('invflowTotalBackorder');
                const posThisWeekEl = document.getElementById('invflowPOsThisWeek');
                const totalValueEl = document.getElementById('invflowTotalValue');
                
                if (totalOnOrderEl) totalOnOrderEl.textContent = totalOnOrder.toLocaleString();
                if (totalBackorderEl) totalBackorderEl.textContent = totalBackorder.toLocaleString();
                if (posThisWeekEl) posThisWeekEl.textContent = posThisWeek;
                if (totalValueEl) totalValueEl.textContent = '$' + totalValue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
                
            } catch (error) {
                console.error('Error calculating metrics:', error);
                // Set all to 0 on error
                document.getElementById('invflowTotalOnOrder').textContent = '0';
                document.getElementById('invflowTotalBackorder').textContent = '0';
                document.getElementById('invflowPOsThisWeek').textContent = '0';
                document.getElementById('invflowTotalValue').textContent = '$0';
            }
        }
        
        /**
         * Render critical alerts
         */
        function renderInvFlowAlerts() {
            try {
                const items = cachedItems || [];
                const pos = purchasesData || [];
                
                const alerts = [];
                
                // Count items on backorder - with safety checks
                const backorderItems = items.filter(item => {
                    const qty = item.Qty_On_Backorder;
                    if (qty === undefined || qty === null || qty === '') return false;
                    return (parseInt(qty) || 0) > 0;
                });
                if (backorderItems.length > 0) {
                    alerts.push({
                        type: 'warning',
                        icon: '',
                        text: `${backorderItems.length} item${backorderItems.length > 1 ? 's' : ''} on backorder (Customers waiting!)`,
                        action: () => {
                            const backorderSection = document.getElementById('invflowBackorderItems');
                            if (backorderSection) backorderSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });
                }
                
                // Count overdue POs - with safety checks
                const now = new Date();
                const overduePOs = pos.filter(po => {
                    if (!po || !po.Status) return false;
                    if (['Received', 'Cancelled', 'Voided'].includes(po.Status)) return false;
                    if (!po.Need_By_Date) return false;
                    try {
                        return new Date(po.Need_By_Date) < now;
                    } catch (e) {
                        return false;
                    }
                });
                if (overduePOs.length > 0) {
                    alerts.push({
                        type: 'danger',
                        icon: '',
                        text: `${overduePOs.length} overdue PO${overduePOs.length > 1 ? 's' : ''} (Expected last week or earlier)`,
                        action: () => switchTab('purchases')
                    });
                }
                
                // Count critical gap items (backorder > on order) - with safety checks
                const gapItems = items.filter(item => {
                    const backorder = item.Qty_On_Backorder;
                    const onOrder = item.Qty_On_Order;
                    if (backorder === undefined || backorder === null || backorder === '') return false;
                    if (onOrder === undefined || onOrder === null || onOrder === '') return false;
                    const backorderQty = parseInt(backorder) || 0;
                    const onOrderQty = parseInt(onOrder) || 0;
                    return backorderQty > 0 && backorderQty > onOrderQty;
                });
                if (gapItems.length > 0) {
                    alerts.push({
                        type: 'danger',
                        icon: '',
                        text: `${gapItems.length} item${gapItems.length > 1 ? 's' : ''}: Backorder > On Order (Not enough ordered!)`,
                        action: () => {
                            const criticalSection = document.getElementById('invflowCriticalItems');
                            if (criticalSection) criticalSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });
                }
                
                // Count out of stock with no PO - with safety checks
                const outOfStockNoPO = items.filter(item => {
                    const qtyOnHand = parseInt(item.Qty_On_Hand) || 0;
                    const onOrder = item.Qty_On_Order;
                    const backorder = item.Qty_On_Backorder;
                    const onOrderQty = (onOrder === undefined || onOrder === null || onOrder === '') ? 0 : (parseInt(onOrder) || 0);
                    const backorderQty = (backorder === undefined || backorder === null || backorder === '') ? 0 : (parseInt(backorder) || 0);
                    return qtyOnHand === 0 && onOrderQty === 0 && backorderQty > 0;
                });
                if (outOfStockNoPO.length > 0) {
                    alerts.push({
                        type: 'danger',
                        icon: '',
                        text: `${outOfStockNoPO.length} item${outOfStockNoPO.length > 1 ? 's' : ''} out of stock with NO purchase order!`,
                        action: () => switchTab('createpo')
                    });
                }
                
                // Render alerts
                const alertsContainer = document.getElementById('invflowAlerts');
                if (!alertsContainer) {
                    console.error('invflowAlerts container not found');
                    return;
                }
                
                if (alerts.length === 0) {
                    alertsContainer.innerHTML = `
                        <div style="text-align: center; padding: 30px; background: #e8f5e9; border-radius: 8px; border: 2px solid #4caf50;">
                            <div style="font-size: 48px; margin-bottom: 10px;"></div>
                            <div style="font-size: 18px; color: #2e7d32; font-weight: 600;">All Clear!</div>
                            <div style="font-size: 14px; color: #388e3c; margin-top: 8px;">No critical issues detected</div>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                alerts.forEach(alert => {
                    const bgColor = alert.type === 'danger' ? '#ffebee' : '#fff3e0';
                    const borderColor = alert.type === 'danger' ? '#ef4444' : '#f59e0b';
                    const textColor = alert.type === 'danger' ? '#b91c1c' : '#d97706';
                    
                    html += `
                        <div onclick="(${alert.action.toString()})()" style="padding: 15px 20px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 24px;">${alert.icon}</span>
                                <span style="font-size: 15px; font-weight: 600; color: ${textColor};">${alert.text}</span>
                            </div>
                        </div>
                    `;
                });
                
                alertsContainer.innerHTML = html;
            } catch (error) {
                console.error('Error rendering alerts:', error);
                const alertsContainer = document.getElementById('invflowAlerts');
                if (alertsContainer) {
                    alertsContainer.innerHTML = `
                        <div style="background: #fee2e2; border: 2px solid #dc2626; border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="font-size: 32px; margin-bottom: 10px;"></div>
                            <div style="color: #991b1b; font-weight: 600;">Error loading alerts</div>
                            <div style="color: #b91c1c; font-size: 13px; margin-top: 8px;">${error.message}</div>
                        </div>
                    `;
                }
            }
        }
        
        /**
         * Render items on backorder
         */
        function renderInvFlowBackorderItems() {
            const items = cachedItems || [];
            const backorderItems = items.filter(item => (parseInt(item.Qty_On_Backorder) || 0) > 0)
                .sort((a, b) => (parseInt(b.Qty_On_Backorder) || 0) - (parseInt(a.Qty_On_Backorder) || 0));
            
            document.getElementById('invflowBackorderCount').textContent = backorderItems.length;
            
            const container = document.getElementById('invflowBackorderItems');
            
            if (backorderItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                        <div style="font-size: 16px; color: #666;">No items on backorder</div>
                        <div style="font-size: 14px; color: #999; margin-top: 8px;">All customer orders can be fulfilled!</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            backorderItems.slice(0, 10).forEach(item => {
                const qtyOnHand = parseInt(item.Qty_On_Hand) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                const backorder = parseInt(item.Qty_On_Backorder) || 0;
                const expectedDate = item.Expected_Restock_Date;
                
                // Determine urgency
                const gap = backorder - onOrder;
                const isUrgent = gap > 0 || onOrder === 0;
                
                html += `
                    <div style="padding: 15px; border: 2px solid ${isUrgent ? '#ef4444' : '#f59e0b'}; border-radius: 8px; margin-bottom: 12px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="font-weight: 600; font-size: 16px; color: #333; margin-bottom: 6px;">${item.Item_Description || item.SKU}</div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <span style="background: ${qtyOnHand === 0 ? '#fee2e2' : '#fff7ed'}; color: ${qtyOnHand === 0 ? '#dc2626' : '#ea580c'}; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                        Stock: ${qtyOnHand}
                                    </span>
                                    <span style="background: #e3f2fd; color: #1976d2; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                        On Order: ${onOrder}
                                    </span>
                                    <span style="background: #fff3e0; color: #f57c00; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                         Backorder: ${backorder}
                                    </span>
                                    ${gap > 0 ? `<span style="background: #ffebee; color: #c62828; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;"> Gap: ${gap}</span>` : ''}
                                </div>
                                ${expectedDate ? `
                                    <div style="margin-top: 8px; font-size: 13px; color: #555;">
                                         Expected: ${new Date(expectedDate).toLocaleDateString()}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                ${isUrgent ? `
                                    <button class="btn-small" onclick="switchTab('createpo')" style="background: #ef4444; color: white; font-size: 12px;"> CREATE PO</button>
                                ` : ''}
                                <button class="btn-small" onclick="viewItemDetails('${item.Item_ID}')" style="font-size: 12px;">View</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (backorderItems.length > 10) {
                html += `
                    <div style="text-align: center; padding: 15px; color: #666; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                        <strong>+${backorderItems.length - 10} more items on backorder</strong>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        /**
         * Render pending purchase orders
         */
        function renderInvFlowPendingPOs() {
            const pos = (purchasesData || []).filter(po => {
                return !['Received', 'Cancelled', 'Voided'].includes(po.Status);
            }).sort((a, b) => {
                if (!a.Need_By_Date) return 1;
                if (!b.Need_By_Date) return -1;
                return new Date(a.Need_By_Date) - new Date(b.Need_By_Date);
            });
            
            document.getElementById('invflowPendingCount').textContent = pos.length;
            
            const container = document.getElementById('invflowPendingPOs');
            
            if (pos.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                        <div style="font-size: 16px; color: #666;">No pending arrivals</div>
                        <div style="font-size: 14px; color: #999; margin-top: 8px;">No purchase orders expected</div>
                    </div>
                `;
                return;
            }
            
            const now = new Date();
            let html = '';
            
            pos.slice(0, 10).forEach(po => {
                const needByDate = po.Need_By_Date ? new Date(po.Need_By_Date) : null;
                const isOverdue = needByDate && needByDate < now;
                const daysUntil = needByDate ? Math.ceil((needByDate - now) / (1000 * 60 * 60 * 24)) : null;
                
                let dateText = 'No date specified';
                let dateBg = '#f8f9fa';
                let dateColor = '#666';
                
                if (needByDate) {
                    if (isOverdue) {
                        dateText = ` Overdue ${Math.abs(daysUntil)} day${Math.abs(daysUntil) !== 1 ? 's' : ''}`;
                        dateBg = '#ffebee';
                        dateColor = '#c62828';
                    } else if (daysUntil === 0) {
                        dateText = ' Today';
                        dateBg = '#fff3e0';
                        dateColor = '#f57c00';
                    } else if (daysUntil === 1) {
                        dateText = ' Tomorrow';
                        dateBg = '#e8f5e9';
                        dateColor = '#2e7d32';
                    } else if (daysUntil <= 7) {
                        dateText = ` ${daysUntil} days`;
                        dateBg = '#e8f5e9';
                        dateColor = '#2e7d32';
                    } else {
                        dateText = ` ${needByDate.toLocaleDateString()}`;
                        dateBg = '#e3f2fd';
                        dateColor = '#1976d2';
                    }
                }
                
                const supplierName = getSupplierName(po.Supplier_ID);
                const totalAmount = parseFloat(po.Total_Amount) || 0;
                
                html += `
                    <div style="padding: 15px; border: 2px solid ${isOverdue ? '#ef4444' : '#1976d2'}; border-radius: 8px; margin-bottom: 12px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1; min-width: 250px;">
                                <div style="font-weight: 600; font-size: 16px; color: #333; margin-bottom: 6px;">
                                    PO #${po.Invoice_Number || po.PO_ID} - ${supplierName}
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                                    <span style="background: ${dateBg}; color: ${dateColor}; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                        ${dateText}
                                    </span>
                                    <span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                         ${totalAmount.toLocaleString('en-US', {style: 'currency', currency: 'USD'})}
                                    </span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-small" onclick="viewPODetails('${po.PO_ID}')" style="font-size: 12px;">View PO</button>
                                <button class="btn-small" onclick="receivePO('${po.PO_ID}')" style="background: #2e7d32; color: white; font-size: 12px;">Receive</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (pos.length > 10) {
                html += `
                    <div style="text-align: center; padding: 15px; color: #666; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                        <strong>+${pos.length - 10} more pending POs</strong> - <a href="#" onclick="switchTab('purchases'); return false;" style="color: #1976d2;">View All</a>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        /**
         * Render critical items (low stock + high demand)
         */
        function renderInvFlowCriticalItems() {
            const items = cachedItems || [];
            const criticalItems = items.filter(item => {
                const qtyOnHand = parseInt(item.Qty_On_Hand) || 0;
                const reorderPoint = parseInt(item.Reorder_Point) || 0;
                const backorder = parseInt(item.Qty_On_Backorder) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                
                // Critical if: low stock AND (has backorders OR backorder > on order)
                return qtyOnHand <= reorderPoint && (backorder > 0 || (backorder > 0 && backorder > onOrder));
            }).sort((a, b) => {
                const gapA = (parseInt(a.Qty_On_Backorder) || 0) - (parseInt(a.Qty_On_Order) || 0);
                const gapB = (parseInt(b.Qty_On_Backorder) || 0) - (parseInt(b.Qty_On_Order) || 0);
                return gapB - gapA;
            });
            
            document.getElementById('invflowCriticalCount').textContent = criticalItems.length;
            
            const container = document.getElementById('invflowCriticalItems');
            
            if (criticalItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                        <div style="font-size: 16px; color: #666;">No critical items</div>
                        <div style="font-size: 14px; color: #999; margin-top: 8px;">All items have adequate stock levels</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            criticalItems.slice(0, 10).forEach(item => {
                const qtyOnHand = parseInt(item.Qty_On_Hand) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                const backorder = parseInt(item.Qty_On_Backorder) || 0;
                const gap = backorder - onOrder;
                
                html += `
                    <div style="padding: 15px; border: 2px solid #ef4444; border-radius: 8px; margin-bottom: 12px; background: #fff5f5;">
                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="font-weight: 600; font-size: 16px; color: #333; margin-bottom: 6px;">${item.Item_Description || item.SKU}</div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <span style="background: #fee2e2; color: #dc2626; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                         Stock: ${qtyOnHand}
                                    </span>
                                    <span style="background: #fff3e0; color: #f57c00; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                        Backorder: ${backorder}
                                    </span>
                                    <span style="background: #e3f2fd; color: #1976d2; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                        On Order: ${onOrder}
                                    </span>
                                    ${gap > 0 ? `<span style="background: #ffebee; color: #c62828; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;"> GAP: -${gap}!</span>` : ''}
                                </div>
                            </div>
                            <div>
                                <button class="btn-small" onclick="switchTab('createpo')" style="background: #ef4444; color: white; font-size: 12px; font-weight: 600;"> ORDER MORE!</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (criticalItems.length > 10) {
                html += `
                    <div style="text-align: center; padding: 15px; color: #666; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                        <strong>+${criticalItems.length - 10} more critical items</strong>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        /**
         * View critical items report (placeholder - can be expanded later)
         */
        function viewCriticalItemsReport() {
            // Open the Inventory Status report which shows critical items
            showReport('inventory-status');
        }
        
        /**
         * View item details - opens Items tab and could highlight the item
         */
        function viewItemDetails(itemId) {
            switchTab('items');
            // TODO: Could add auto-filtering or highlighting of the specific item
        }
        
        /**
         * View PO details (placeholder - can link to existing PO view)
         */
        function viewPODetails(poId) {
            // Open the PO detail popup directly
            viewPurchaseOrder(poId);
        }
        
        /**
         * Receive PO - calls the existing receive function
         */
        function receivePO(poId) {
            // Call existing receive PO function that opens the receive modal
            receiveOutgoingPO(poId);
        }
    </script>
    
    <!-- Order View/Edit Modal -->
    <div id="orderModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto;">
        <div id="orderModalInner" style="background: white; margin: 20px auto; max-width: 900px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: calc(100vh - 40px); display: flex; flex-direction: column; resize: both; overflow: auto; min-width: 400px; min-height: 300px;">
            <div id="orderModalHeader" style="background: var(--primary, #667eea); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <h2 id="modalTitle" style="margin: 0;">Order Details</h2>
                <button onclick="closeOrderModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <div id="modalContent" style="padding: 30px; overflow-y: auto; flex: 1;">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div id="modalFooter" style="padding: 20px 30px; border-top: 1px solid #ddd; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeOrderModal()">Close</button>
                <button id="modalPrintBtn" class="btn" onclick="printInvoice()" style="display: none;"> Print Invoice</button>
                <button id="modalEditBtn" class="btn" onclick="enableEditMode()" style="display: none;"> Edit Order</button>
                <button id="modalSaveBtn" class="btn" onclick="if(event && debounceButton(event.currentTarget)) saveOrderChanges()" style="display: none;"> Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Report Setup Modal -->
    <div id="reportSetupModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: none; align-items: center; justify-content: center;">
        <div id="reportSetupModalInner" style="background: white; width: 100%; max-width: 900px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 90vh; height: 90vh; display: flex; flex-direction: column; overflow: hidden; resize: both; min-width: 500px; min-height: 400px;">
            <div id="reportSetupHeader" style="background: var(--primary, #667eea); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <h2 id="reportSetupTitle" style="margin: 0;"> Report Setup</h2>
                <button onclick="closeReportSetup()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <div id="reportSetupFilters" style="padding: 20px; background: #f8f9fa; border-bottom: 1px solid #ddd; flex-shrink: 0;">
                <!-- Filters will be populated by JavaScript -->
            </div>
            <div id="reportSetupContent" style="padding: 20px; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; min-height: 0;">
                <div style="text-align: center; padding: 40px; color: #888;">
                    <div style="font-size: 48px; margin-bottom: 15px;"></div>
                    <p>Configure filters above and click <strong>Run Report</strong></p>
                </div>
            </div>
            <div id="reportSetupFooter" style="padding: 15px 20px; border-top: 1px solid #ddd; display: flex; gap: 10px; justify-content: space-between; background: #f8f9fa; border-radius: 0 0 12px 12px; flex-wrap: wrap; flex-shrink: 0;">
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="printReport()" title="Print Report (or Save as PDF)"> Print</button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="closeReportSetup()">Cancel</button>
                    <button class="btn" onclick="executeReport()" id="runReportBtn"> Run Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile-Friendly Item Picker Modal -->
    <div id="itemPickerModal" class="item-picker-overlay">
        <div class="item-picker-container">
            <div class="item-picker-header">
                <h3> Select Item(s)</h3>
                <button class="item-picker-close" onclick="closeItemPicker(); closeItemPickerForReport();">&times;</button>
            </div>
            <div class="item-picker-search">
                <input type="text" id="itemPickerSearch" placeholder=" Search by SKU or description..." oninput="handleItemPickerSearch();" onkeyup="handleItemPickerSearch();">
            </div>
            <div id="itemPickerSupplierFilter" class="item-picker-filter">
                <select id="itemPickerSupplier" onchange="window.filterItemPicker()">
                    <option value="">All Suppliers</option>
                </select>
            </div>
            <div id="itemPickerList" class="item-picker-list" style="max-height: calc(100% - 240px);">
                <!-- Items will be populated by JavaScript -->
            </div>
            <div class="item-picker-footer" style="padding: 15px; border-top: 2px solid #e0e0e0; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                <div id="itemSelectionCount" style="color: #666; font-size: 14px; font-weight: 600;"></div>
                <button class="btn" onclick="closeItemPicker(); closeItemPickerForReport();" style="background: var(--primary, #667eea); color: white; padding: 10px 24px;"> Done</button>
            </div>
        </div>
    </div>

    <!-- SUPPLIER PICKER MODAL -->
    <div id="supplierPickerModal" class="item-picker-overlay">
        <div class="item-picker-container">
            <div class="item-picker-header">
                <h3> Select Supplier(s)</h3>
                <button class="item-picker-close" onclick="closeSupplierPicker()">&times;</button>
            </div>
            <div class="item-picker-search">
                <input type="text" id="supplierPickerSearch" placeholder=" Search suppliers..." oninput="filterSupplierPicker()" onkeyup="filterSupplierPicker()">
            </div>
            <div id="supplierPickerList" class="item-picker-list" style="max-height: calc(100% - 180px);">
                <!-- Suppliers will be populated by JavaScript -->
            </div>
            <div class="item-picker-footer" style="padding: 15px; border-top: 2px solid #e0e0e0; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                <div id="supplierSelectionCount" style="color: #666; font-size: 14px; font-weight: 600;"></div>
                <button class="btn" onclick="closeSupplierPicker()" style="background: var(--primary, #667eea); color: white; padding: 10px 24px;"> Done</button>
            </div>
        </div>
    </div>

    <!-- CUSTOMER PICKER MODAL -->
    <div id="customerPickerModal" class="item-picker-overlay">
        <div class="item-picker-container">
            <div class="item-picker-header">
                <h3> Select Customer(s)</h3>
                <button class="item-picker-close" onclick="closeCustomerPicker()">&times;</button>
            </div>
            <div class="item-picker-search">
                <input type="text" id="customerPickerSearch" placeholder=" Search customers..." oninput="filterCustomerPicker()" onkeyup="filterCustomerPicker()">
            </div>
            <div id="customerPickerList" class="item-picker-list" style="max-height: calc(100% - 180px);">
                <!-- Customers will be populated by JavaScript -->
            </div>
            <div class="item-picker-footer" style="padding: 15px; border-top: 2px solid #e0e0e0; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                <div id="customerSelectionCount" style="color: #666; font-size: 14px; font-weight: 600;"></div>
                <button class="btn" onclick="closeCustomerPicker()" style="background: var(--primary, #667eea); color: white; padding: 10px 24px;"> Done</button>
            </div>
        </div>
    </div>

    <!-- REASON PICKER MODAL -->
    <div id="reasonPickerModal" class="item-picker-overlay">
        <div class="item-picker-container" style="max-width: 500px; height: auto; max-height: 80vh; margin: 10vh auto; border-radius: 16px;">
            <div class="item-picker-header" style="border-radius: 16px 16px 0 0;">
                <h3> Select Reason</h3>
                <button class="item-picker-close" onclick="closeReasonPicker()">&times;</button>
            </div>
            <div id="reasonPickerList" class="item-picker-list" style="padding: 15px;">
                <!-- Reason options will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- UOM PICKER MODAL -->
    <div id="uomPickerModal" class="item-picker-overlay">
        <div class="item-picker-container" style="max-width: 500px; height: auto; max-height: 80vh; margin: 10vh auto; border-radius: 16px;">
            <div class="item-picker-header" style="border-radius: 16px 16px 0 0;">
                <h3> Select Unit of Measure</h3>
                <button class="item-picker-close" onclick="closeUOMPicker()">&times;</button>
            </div>
            <div id="uomPickerList" class="item-picker-list" style="padding: 15px;">
                <!-- UOM options will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- THEME PICKER MODAL -->
    <div id="themePickerModal" class="item-picker-overlay">
        <div class="item-picker-container" style="max-width: 700px; height: 85vh; margin: 5vh auto; border-radius: 16px;">
            <div class="item-picker-header" style="border-radius: 16px 16px 0 0; background: var(--primary, #667eea);">
                <h3> Choose Your Theme</h3>
                <button class="item-picker-close" onclick="closeThemePicker()">&times;</button>
            </div>
            <div class="item-picker-search" style="padding: 15px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">
                <input type="text" id="themePickerSearch" placeholder=" Search themes... (e.g. 'packers', 'blue', 'nfl')" oninput="filterThemePicker()" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px;">
            </div>
            <div id="themePickerList" class="item-picker-list" style="padding: 15px; height: calc(85vh - 140px); overflow-y: auto;">
                <!-- Theme options will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- STATUS PICKER MODAL -->
    <div id="statusPickerModal" class="item-picker-overlay">
        <div class="item-picker-container" style="max-width: 500px; height: auto; max-height: 80vh; margin: 10vh auto; border-radius: 16px;">
            <div class="item-picker-header" id="statusPickerHeader" style="border-radius: 16px 16px 0 0;">
                <h3 id="statusPickerTitle"> Select Status</h3>
                <button class="item-picker-close" onclick="closeStatusPicker()">&times;</button>
            </div>
            <div id="statusPickerList" class="item-picker-list" style="padding: 15px;">
                <!-- Status options will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- PO PICKER MODAL -->
    <div id="poPickerModal" class="item-picker-overlay">
        <div class="item-picker-container">
            <div class="item-picker-header">
                <h3> Select Purchase Order(s)</h3>
                <button class="item-picker-close" onclick="closePOPicker()">&times;</button>
            </div>
            <div class="item-picker-search">
                <input type="text" id="poPickerSearch" placeholder=" Search by PO number..." oninput="filterPOPicker()" onkeyup="filterPOPicker()">
            </div>
            <div id="poPickerList" class="item-picker-list" style="max-height: calc(100% - 180px);">
                <!-- POs will be populated by JavaScript -->
            </div>
            <div class="item-picker-footer" style="padding: 15px; border-top: 2px solid #e0e0e0; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                <div id="poSelectionCount" style="color: #666; font-size: 14px; font-weight: 600;"></div>
                <button class="btn" onclick="closePOPicker()" style="background: var(--primary, #667eea); color: white; padding: 10px 24px;"> Done</button>
            </div>
        </div>
    </div>

    <!-- INVOICE PICKER MODAL -->
    <div id="invoicePickerModal" class="item-picker-overlay">
        <div class="item-picker-container">
            <div class="item-picker-header">
                <h3> Select Invoice(s)</h3>
                <button class="item-picker-close" onclick="closeInvoicePicker()">&times;</button>
            </div>
            <div class="item-picker-search">
                <input type="text" id="invoicePickerSearch" placeholder=" Search by invoice number..." oninput="filterInvoicePicker()" onkeyup="filterInvoicePicker()">
            </div>
            <div id="invoicePickerList" class="item-picker-list" style="max-height: calc(100% - 180px);">
                <!-- Invoices will be populated by JavaScript -->
            </div>
            <div class="item-picker-footer" style="padding: 15px; border-top: 2px solid #e0e0e0; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                <div id="invoiceSelectionCount" style="color: #666; font-size: 14px; font-weight: 600;"></div>
                <button class="btn" onclick="closeInvoicePicker()" style="background: var(--primary, #667eea); color: white; padding: 10px 24px;"> Done</button>
            </div>
        </div>
    </div>

    <!-- ITEM PICKER MODAL (for reports) -->
    <!-- PO TYPE PICKER MODAL -->
    <div id="poTypePickerModal" class="item-picker-overlay">
        <div class="item-picker-container" style="max-width: 400px;">
            <div class="item-picker-header">
                <h3> Select PO Type</h3>
                <button class="item-picker-close" onclick="closePOTypePicker()">&times;</button>
            </div>
            <div id="poTypePickerList" class="item-picker-list" style="padding: 15px;">
                <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectPOType('', 'All Types')" onclick="selectPOType('', 'All Types')" style="border-left: 4px solid #6c757d; background: #f8f9fa; margin-bottom: 10px;">
                    <div class="item-picker-desc" style="font-weight: bold; color: #495057;">
                        <span style="font-size: 24px; margin-right: 12px;"></span> All Types
                    </div>
                    <div style="font-size: 13px; color: #6c757d; margin-top: 5px;">Show both inbound and outbound POs</div>
                </div>
                <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectPOType('INCOMING', 'Incoming (Purchases)')" onclick="selectPOType('INCOMING', 'Incoming (Purchases)')" style="border-left: 4px solid #28a745; background: #e8f5e9; margin-bottom: 10px;">
                    <div class="item-picker-desc" style="font-weight: bold; color: #2e7d32;">
                        <span style="font-size: 24px; margin-right: 12px;"></span> Incoming (Purchases)
                    </div>
                    <div style="font-size: 13px; color: #388e3c; margin-top: 5px;">Products received from suppliers</div>
                </div>
                <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectPOType('OUTGOING', 'Outgoing (Returns/Transfers)')" onclick="selectPOType('OUTGOING', 'Outgoing (Returns/Transfers)')" style="border-left: 4px solid #1976d2; background: #e3f2fd; margin-bottom: 10px;">
                    <div class="item-picker-desc" style="font-weight: bold; color: #1565c0;">
                        <span style="font-size: 24px; margin-right: 12px;"></span> Outgoing (Returns/Transfers)
                    </div>
                    <div style="font-size: 13px; color: #1976d2; margin-top: 5px;">Products sent back to suppliers or transferred out</div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Mobile-Friendly Item Picker Styles */
        .item-picker-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 99999 !important;  /* Way above sticky elements (999) */
            padding: 0;
        }
        
        .item-picker-container {
            background: #f5f5f5;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 100000 !important;  /* Ensure it's on top */
        }
        
        @media (min-width: 768px) {
            .item-picker-container {
                margin: 40px auto;
                height: calc(100% - 80px);
                border-radius: 16px;
                overflow: hidden;
            }
        }
        
        .item-picker-header {
            background: var(--primary, #667eea);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .item-picker-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .item-picker-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 28px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .item-picker-search {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
        }
        
        .item-picker-search input {
            width: 100%;
            padding: 15px 20px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 12px;
            outline: none;
        }
        
        .item-picker-search input:focus {
            border-color: var(--primary, #667eea);
        }
        
        .item-picker-filter {
            padding: 10px 15px;
            background: white;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
        }
        
        .item-picker-filter select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        
        .item-picker-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            -webkit-overflow-scrolling: touch;
        }
        
        .item-picker-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            border: 2px solid transparent;
            border-left: 4px solid #c0c0c0;
        }
        
        .item-picker-card:hover,
        .item-picker-card:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            border-color: #999;
        }
        
        .item-picker-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .item-picker-sku {
            background: #f0f0f0;
            color: #555;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
        }
        
        .item-picker-stock {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
        }
        
        .item-picker-stock.in-stock {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .item-picker-stock.low-stock {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .item-picker-stock.out-stock {
            background: #ffebee;
            color: #c62828;
        }
        
        .item-picker-desc {
            font-size: 17px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .item-picker-details {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .item-picker-detail {
            display: flex;
            flex-direction: column;
        }
        
        .item-picker-detail-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
        }
        
        .item-picker-detail-value {
            font-weight: bold;
            color: #333;
        }
        
        .item-picker-price {
            color: #2e7d32 !important;
            font-size: 18px !important;
        }
        
        .item-picker-supplier {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }
        
        .item-picker-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .item-picker-empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        /* Supplier card specific styling */
        .supplier-card:hover,
        .supplier-card:active {
            border-color: #999 !important;
        }
        
        /* Customer card specific styling */
        .customer-card:hover,
        .customer-card:active {
            border-color: #999 !important;
        }
        
        /* Make ALL select elements more tappable on mobile */
        @media (max-width: 768px) {
            select {
                min-height: 48px;
                font-size: 16px !important;
                padding: 12px !important;
            }
            
            #poSupplier, #soCustomer, #editPOSupplier, #editSOCustomer {
                background: linear-gradient(to right, #f8f9fa, #ffffff);
                border: 2px solid #ddd;
                border-radius: 8px;
                cursor: pointer;
            }
        }
        
        /* Make select elements more tappable on mobile */
        .po-item, .so-item, .createpo-item, .edit-item {
            min-height: 44px;
            font-size: 16px !important;
        }
        
        /* ========== MOBILE MODAL FIXES ========== */
        
        /* Prevent horizontal scroll only */
        html, body {
            overscroll-behavior-x: none;
        }
        
        @media (max-width: 768px) {
            html {
                overflow-x: hidden;
                overflow-y: auto !important; /* Allow vertical scroll */
            }
            
            body {
                overflow-x: hidden;
                overflow-y: auto !important; /* Allow vertical scroll */
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* Receive modal content */
        .receive-modal-content {
            max-height: 70vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (max-width: 768px) {
            .receive-modal-content {
                max-height: none !important;
                height: auto !important;
                overflow-y: visible !important;
            }
        }
        
        /* Landscape mode for receive modal */
        @media (max-height: 500px) and (orientation: landscape) {
            .receive-modal-content {
                max-height: none !important;
                height: auto !important;
                overflow-y: visible !important;
                padding: 10px !important;
            }
            
            .receive-modal-content h2 {
                font-size: 16px !important;
                padding: 5px 0 !important;
                margin-bottom: 5px !important;
            }
            
            .receive-modal-content table {
                font-size: 11px !important;
            }
            
            .receive-modal-content th,
            .receive-modal-content td {
                padding: 5px 4px !important;
            }
            
            .receive-modal-content input[type="number"] {
                width: 60px !important;
                padding: 4px !important;
                font-size: 14px !important;
            }
        }
        
        /* When any modal is open, prevent body scrolling */
        body.modal-open {
            overflow: hidden !important;
            /* Don't use position:fixed on iOS - causes scroll issues */
            touch-action: none !important;
        }
        
        /* iOS-specific fix for modal scrolling */
        @supports (-webkit-touch-callout: none) {
            body.modal-open {
                position: relative !important;
                height: 100% !important;
            }
        }
        
        /* Base modal overlay styles */
        #reportSetupModal,
        #orderModal,
        #itemPickerModal,
        #supplierPickerModal,
        #customerPickerModal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100% !important;
            height: 100% !important;
            overflow: hidden !important;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Z-index hierarchy - detail modals above report modals */
        #reportSetupModal { 
            z-index: 10000 !important; 
            padding: 20px; /* Desktop padding, overridden on mobile */
        }
        #orderModal { z-index: 10500 !important; } /* Higher so it appears above reports */
        #itemPickerModal,
        #supplierPickerModal,
        #customerPickerModal { z-index: 11000 !important; } /* Picker modals highest */
        
        /* Modal content container - this is what scrolls */
        #reportSetupModal > div,
        #reportSetupModalInner,
        #orderModal > div,
        #orderModalInner {
            position: relative;
            max-height: 100vh !important;
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Mobile-specific modal fixes */
        @media (max-width: 768px) {
            #reportSetupModal > div,
            #reportSetupModalInner,
            #orderModal > div,
            #orderModalInner {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
                min-width: 0 !important;
                min-height: 0 !important;
                width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                border-radius: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                resize: none !important;
                overflow: hidden !important;
            }
            
            /* Headers don't shrink */
            #orderModalHeader,
            #reportSetupModal > div > div:first-child {
                flex-shrink: 0 !important;
            }
            
            /* Footers don't shrink */
            #modalFooter,
            #reportSetupModal > div > div:last-child {
                flex-shrink: 0 !important;
            }
            
            /* Filters don't shrink */
            #reportSetupFilters {
                flex-shrink: 0 !important;
            }
            
            /* Report content area - scrollable */
            #reportSetupContent {
                flex: 1 !important;
                overflow-y: auto !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
                min-height: 0 !important; /* Important for flex scrolling */
            }
            
            /* Order modal content */
            #modalContent {
                flex: 1 !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch;
                min-height: 0 !important;
                max-height: none !important; /* Override inline style */
            }
        }
        
        /* Landscape mode specific fixes */
        @media (max-height: 500px) and (orientation: landscape) {
            /* Make modal overlay fill screen */
            #reportSetupModal,
            #orderModal {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                padding: 0 !important;
                overflow: hidden !important;
                z-index: 99999 !important;
            }
            
            /* Make inner container fullscreen */
            #reportSetupModal > div,
            #reportSetupModalInner,
            #orderModal > div,
            #orderModalInner {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
                min-width: 0 !important;
                width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                min-height: 0 !important;
                border-radius: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                resize: none !important;
                overflow: hidden !important;
            }
            
            /* Compact header in landscape - DEBUG: red background */
            #reportSetupModal > div > div:first-child,
            #orderModal > div > div:first-child,
            #orderModalHeader {
                padding: 5px 10px !important;
                flex-shrink: 0 !important;
                min-height: 30px !important;
                max-height: 40px !important;
            }
            
            #reportSetupModal > div > div:first-child h2,
            #orderModal > div > div:first-child h2 {
                font-size: 14px !important;
            }
            
            /* HIDE filters in landscape to save space */
            #reportSetupFilters {
                display: none !important;
            }
            
            /* Content area takes remaining space */
            #reportSetupContent {
                flex: 1 1 auto !important;
                min-height: 100px !important; /* Force minimum height */
                padding: 5px !important;
                overflow: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            #modalContent {
                flex: 1 1 auto !important;
                min-height: 100px !important;
                padding: 5px !important;
                overflow: auto !important;
                -webkit-overflow-scrolling: touch !important;
                max-height: none !important;
            }
            
            /* Compact footer - DEBUG: blue background */
            #reportSetupModal > div > div:last-child {
                padding: 5px 10px !important;
                flex-shrink: 0 !important;
                min-height: 35px !important;
                max-height: 45px !important;
            }
            
            #reportSetupModal > div > div:last-child .btn {
                padding: 4px 10px !important;
                font-size: 12px !important;
            }
            
            /* Order modal footer */
            #modalFooter {
                padding: 5px 10px !important;
                flex-shrink: 0 !important;
                min-height: 35px !important;
                max-height: 45px !important;
            }
            
            #modalFooter .btn {
                padding: 4px 10px !important;
                font-size: 12px !important;
            }
        }
        
        /* Table horizontal scroll fix for reports */
        #reportSetupContent table {
            min-width: 500px; /* Force horizontal scroll on narrow screens */
        }
        
        #reportSetupContent .data-table {
            font-size: 13px;
        }
        
        /* Wrapper for horizontal table scrolling */
        #reportSetupContent > div[style*="overflow-x"] {
            max-width: 100%;
            overflow-x: auto !important;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (max-width: 768px) {
            #reportSetupContent .data-table {
                font-size: 12px;
            }
            
            #reportSetupContent .data-table th,
            #reportSetupContent .data-table td {
                padding: 8px 6px;
                white-space: nowrap;
            }
        }
        
        @media (max-height: 500px) and (orientation: landscape) {
            #reportSetupContent .data-table {
                font-size: 11px;
            }
            
            #reportSetupContent .data-table th,
            #reportSetupContent .data-table td {
                padding: 5px 4px;
            }
            
            #reportSetupContent h3 {
                font-size: 14px !important;
                margin: 0 0 5px 0 !important;
            }
            
            #reportSetupContent p {
                font-size: 11px !important;
                margin-bottom: 8px !important;
            }
        }
    </style>

    <script>
        // ==================== MOBILE ITEM PICKER ====================
        
        // itemPickerCallback declared in earlier script block
        let itemPickerSupplierFilter = '';
        
        // Bind search event properly when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Item picker - use window. since function is in different script block
            const searchInput = document.getElementById('itemPickerSearch');
            if (searchInput) {
                searchInput.addEventListener('input', window.filterItemPicker);
                searchInput.addEventListener('keyup', window.filterItemPicker);
            }
            const supplierFilter = document.getElementById('itemPickerSupplier');
            if (supplierFilter) {
                supplierFilter.addEventListener('change', window.filterItemPicker);
            }
            
            // Supplier picker
            const supplierSearchInput = document.getElementById('supplierPickerSearch');
            if (supplierSearchInput) {
                supplierSearchInput.addEventListener('input', filterSupplierPicker);
                supplierSearchInput.addEventListener('keyup', filterSupplierPicker);
            }
            
            // Customer picker
            const customerSearchInput = document.getElementById('customerPickerSearch');
            if (customerSearchInput) {
                customerSearchInput.addEventListener('input', filterCustomerPicker);
                customerSearchInput.addEventListener('keyup', filterCustomerPicker);
            }
        });
        
        function openItemPicker(selectElement, preSelectedSupplierId = null) {
            // Store callback to set value when item is selected
            window.itemPickerCallback = selectElement;
            
            // Reset filter mode flag
            window.itemPickerIsFilter = false;
            
            // Check if we're in a context where supplier is already selected (PO forms)
            let supplierContext = preSelectedSupplierId;
            let isSalesContext = false;
            
            if (!supplierContext) {
                // Try to detect from Create PO form
                const createPOSupplier = document.getElementById('createPOSupplier');
                if (createPOSupplier && createPOSupplier.value) {
                    supplierContext = createPOSupplier.value;
                }
                // Try to detect from Purchase form 
                const purchaseSupplier = document.getElementById('newPurchaseSupplier');
                if (purchaseSupplier && purchaseSupplier.value) {
                    supplierContext = purchaseSupplier.value;
                }
            }
            
            // Only check for Sales context if we DON'T have a supplier context
            // This prevents false detection when both forms might exist in DOM
            if (!supplierContext) {
                const saleCustomer = document.getElementById('newSaleCustomer');
                const editSOCustomer = document.getElementById('editSOCustomer');
                if ((saleCustomer && saleCustomer.value) || (editSOCustomer && editSOCustomer.value)) {
                    isSalesContext = true;
                }
            }
            
            const supplierFilterDiv = document.getElementById('itemPickerSupplierFilter');
            const supplierSelect = document.getElementById('itemPickerSupplier');
            
            if (isSalesContext) {
                // SALES MODE: Hide supplier filter - show ALL items from all suppliers
                supplierFilterDiv.style.display = 'none';
                supplierSelect.value = ''; // No supplier filter
                window.itemPickerSupplierContext = ''; // Store globally
            } else if (supplierContext) {
                // PO MODE with supplier selected: Hide filter, only show that supplier's items
                supplierFilterDiv.style.display = 'none';
                supplierSelect.value = supplierContext;
                window.itemPickerSupplierContext = supplierContext; // Store globally
            } else {
                // OTHER MODE: Show supplier filter dropdown
                supplierFilterDiv.style.display = 'block';
                supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
                if (cachedSuppliers && cachedSuppliers.length > 0) {
                    cachedSuppliers.forEach(s => {
                        supplierSelect.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                    });
                }
                supplierSelect.value = '';
                window.itemPickerSupplierContext = ''; // No preset context
            }
            
            // Get items from cache
            window.itemPickerItems = [];
            if (cachedItems && cachedItems.length > 0) {
                window.itemPickerItems = cachedItems;
            }
            
            // Clear search
            document.getElementById('itemPickerSearch').value = '';
            
            // Render items
            renderItemPickerList();
            
            // Show modal
            document.getElementById('itemPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Focus search after a moment - only on desktop
            document.activeElement?.blur();
            focusOnDesktop('itemPickerSearch');
        }
        
        function closeItemPicker() {
            document.getElementById('itemPickerModal').style.display = 'none';
            window.itemPickerCallback = null;
            window.multiSelectMode = false;
            window.multiSelectedItems = new Set();
            
            // Reset modal header
            const headerEl = document.querySelector('#itemPickerModal .item-picker-header h3');
            if (headerEl) headerEl.textContent = ' Select Item(s)';
            
            // Reset Done button
            const doneBtn = document.querySelector('#itemPickerModal .item-picker-footer button.btn');
            if (doneBtn) {
                doneBtn.textContent = ' Done';
                doneBtn.onclick = function() { closeItemPicker(); closeItemPickerForReport(); };
            }
            
            // Only remove modal-open if no other modals are open
            const reportModal = document.getElementById('reportSetupModal');
            const orderModal = document.getElementById('orderModal');
            const hasOpenModal = (reportModal && reportModal.style.display !== 'none') || 
                                 (orderModal && orderModal.style.display !== 'none');
            if (!hasOpenModal) {
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
            }
        }
        
        function selectItemFromPicker(itemId) {
            if (window.itemPickerCallback) {
                // Check if this is for inventory adjustment form
                if (window.itemPickerCallback.tagName === 'ADJUSTMENT_FORM') {
                    document.getElementById('adjustItem').value = itemId;
                    const item = (cachedItems || []).find(i => i.Item_ID === itemId);
                    if (item) {
                        document.getElementById('adjustItemDisplay').value = `${item.SKU} - ${item.Item_Description}`;
                        document.getElementById('adjustCurrentQty').value = parseInt(item.Qty_On_Hand) || 0;
                        updateAdjustNewQty();
                    }
                    window.adjustmentPickerActive = false;
                    closeItemPicker();
                    return;
                }
                
                // Check if this is a filter text input or a select element
                const isTextInput = window.itemPickerCallback.tagName === 'INPUT' && window.itemPickerCallback.type === 'text';
                
                if (isTextInput && window.itemPickerIsFilter) {
                    // For filter inputs, set the item description/SKU as value
                    const item = (cachedItems || []).find(i => i.Item_ID === itemId);
                    if (item) {
                        window.itemPickerCallback.value = item.SKU || item.Item_Description || itemId;
                    }
                    // Trigger the appropriate filter function based on input ID
                    const id = window.itemPickerCallback.id;
                    if (id === 'filterItemSearch') {
                        if (typeof filterItems === 'function') filterItems();
                    } else if (id === 'filterInventorySearch') {
                        if (typeof filterInventory === 'function') filterInventory();
                    } else if (id === 'pricesimSearch') {
                        if (typeof filterPriceSimItems === 'function') filterPriceSimItems();
                    }
                } else {
                    // Set the select value
                    window.itemPickerCallback.value = itemId;
                    
                    // Trigger change event to update any dependent fields
                    window.itemPickerCallback.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // Explicitly call update functions for mobile compatibility
                    if (window.itemPickerCallback.classList.contains('createpo-item')) {
                        updateCreatePOItemCost(window.itemPickerCallback);
                    } else if (window.itemPickerCallback.classList.contains('po-item')) {
                        updatePOItemInfo(window.itemPickerCallback);
                    } else if (window.itemPickerCallback.classList.contains('so-item')) {
                        if (typeof updateSOItemInfo === 'function') updateSOItemInfo(window.itemPickerCallback);
                    }
                    
                    // Recalculate totals after a brief delay to ensure DOM updates
                    setTimeout(() => {
                        if (typeof calculateCreatePOTotal === 'function') calculateCreatePOTotal();
                        if (typeof calculatePOTotal === 'function') calculatePOTotal();
                        if (typeof calculateSOTotal === 'function') calculateSOTotal();
                    }, 50);
                }
            }
            window.itemPickerIsFilter = false;
            closeItemPicker();
        }
        
        // Clear item filter and close picker
        function clearItemFilter() {
            if (window.itemPickerCallback) {
                window.itemPickerCallback.value = '';
                // Trigger the appropriate filter function
                const id = window.itemPickerCallback.id;
                if (id === 'filterItemSearch') {
                    if (typeof filterItems === 'function') filterItems();
                } else if (id === 'filterInventorySearch') {
                    if (typeof filterInventory === 'function') filterInventory();
                } else if (id === 'pricesimSearch') {
                    if (typeof filterPriceSimItems === 'function') filterPriceSimItems();
                }
            }
            window.itemPickerIsFilter = false;
            closeItemPicker();
        }
        
        // Auto-attach to item selects on ALL devices (not just mobile)
        function attachItemPickerToSelects() {
            // Attach to ALL item selects (forms + reports)
            document.querySelectorAll('.po-item, .so-item, .createpo-item, .edit-item, #filter_item').forEach(select => {
                if (!select.dataset.pickerAttached) {
                    select.dataset.pickerAttached = 'true';
                    // Use mousedown to intercept BEFORE the dropdown opens
                    select.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openItemPicker(this);
                    });
                    select.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openItemPicker(this);
                    });
                }
            });
        }
        
        // Re-attach when new rows are added
        const originalAddPORow = typeof addPurchaseLineItem === 'function' ? addPurchaseLineItem : null;
        const originalAddSORow = typeof addSaleLineItem === 'function' ? addSaleLineItem : null;
        const originalAddCreatePORow = typeof addCreatePOLine === 'function' ? addCreatePOLine : null;
        
        // Also attach when switching tabs
        const originalSwitchTab = typeof switchTab === 'function' ? switchTab : null;
        if (originalSwitchTab) {
            window.switchTabOriginal = switchTab;
            window.switchTab = function(tab) {
                switchTabOriginal(tab);
                setTimeout(attachItemPickerToSelects, 100);
                setTimeout(attachSupplierPickerToSelects, 100);
                setTimeout(attachCustomerPickerToSelects, 100);
                setTimeout(attachStatusPickerToSelects, 100);
            };
        }
        
        // ==================== SUPPLIER PICKER ====================
        
        let supplierPickerCallback = null;
        let supplierPickerIsFilter = false;  // Track if this is for a filter input
        
        // Open supplier picker for filter text inputs
        function openSupplierPickerForFilter(inputElement) {
            // Blur input to prevent mobile keyboard from appearing
            if (inputElement) inputElement.blur();
            document.activeElement?.blur();
            
            supplierPickerCallback = inputElement;
            supplierPickerIsFilter = true;
            document.getElementById('supplierPickerSearch').value = '';
            renderSupplierPickerList();
            document.getElementById('supplierPickerModal').style.display = 'block';
            document.body.classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            
            // Only focus search on desktop (not touch devices)
            if (!('ontouchstart' in window)) {
                setTimeout(() => {
                    document.getElementById('supplierPickerSearch').focus();
                }, 100);
            }
        }
        
        // Open item picker for filter text inputs
        function openItemPickerForFilter(inputElement) {
            // Blur input to prevent mobile keyboard from appearing
            if (inputElement) inputElement.blur();
            document.activeElement?.blur();
            
            window.itemPickerCallback = inputElement;
            window.itemPickerIsFilter = true;
            window.itemPickerSupplierContext = ''; // No supplier context for filters
            
            // Show supplier filter for filter context
            const supplierFilterDiv = document.getElementById('itemPickerSupplierFilter');
            if (supplierFilterDiv) {
                supplierFilterDiv.style.display = 'block';
            }
            
            // Populate supplier filter
            const supplierSelect = document.getElementById('itemPickerSupplier');
            supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
            if (cachedSuppliers && cachedSuppliers.length > 0) {
                cachedSuppliers.forEach(s => {
                    supplierSelect.innerHTML += `<option value="${s.Supplier_ID}">${s.Supplier_Name}</option>`;
                });
            }
            
            // Get items from cache
            window.itemPickerItems = cachedItems || [];
            
            // Clear search
            document.getElementById('itemPickerSearch').value = '';
            document.getElementById('itemPickerSupplier').value = '';
            
            // Render items
            renderItemPickerList();
            
            // Show modal
            document.getElementById('itemPickerModal').style.display = 'block';
            document.body.classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            
            // Only focus search on desktop (not touch devices)
            if (!('ontouchstart' in window)) {
                setTimeout(() => {
                    document.getElementById('itemPickerSearch').focus();
                }, 100);
            }
        }
        
        // Open customer picker for filter text inputs
        function openCustomerPickerForFilter(inputElement) {
            // Blur input to prevent mobile keyboard from appearing
            if (inputElement) inputElement.blur();
            document.activeElement?.blur();
            
            customerPickerCallback = inputElement;
            window.customerPickerIsFilter = true;
            document.getElementById('customerPickerSearch').value = '';
            renderCustomerPickerList();
            document.getElementById('customerPickerModal').style.display = 'block';
            document.body.classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            
            // Only focus search on desktop (not touch devices)
            if (!('ontouchstart' in window)) {
                setTimeout(() => {
                    document.getElementById('customerPickerSearch').focus();
                }, 100);
            }
        }
        
        // Customer picker for report filters
        function openCustomerPickerForReport() {
            document.activeElement?.blur();
            
            window.reportPickerType = 'customer';
            window.customerPickerIsFilter = true; // Allow "All Customers" option
            customerPickerCallback = {
                tagName: 'REPORT_FILTER',
                value: document.getElementById('rptFilter_customer').value
            };
            
            // Initialize selected customers from current value
            const currentValue = document.getElementById('rptFilter_customer').value;
            if (currentValue) {
                selectedCustomersForReport = currentValue.split(',').filter(v => v);
            } else {
                selectedCustomersForReport = [];
            }
            
            document.getElementById('customerPickerSearch').value = '';
            renderCustomerPickerList();
            document.getElementById('customerPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('customerPickerSearch');
        }
        
        // Supplier picker for report filters
        function openSupplierPickerForReport() {
            document.activeElement?.blur();
            
            window.reportPickerType = 'supplier';
            window.supplierPickerIsFilter = true; // Allow "All Suppliers" option
            supplierPickerCallback = {
                tagName: 'REPORT_FILTER',
                value: document.getElementById('rptFilter_supplier').value
            };
            
            // Initialize selected suppliers from current value
            const currentValue = document.getElementById('rptFilter_supplier').value;
            if (currentValue) {
                selectedSuppliersForReport = currentValue.split(',').filter(v => v);
            } else {
                selectedSuppliersForReport = [];
            }
            
            document.getElementById('supplierPickerSearch').value = '';
            renderSupplierPickerList();
            document.getElementById('supplierPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('supplierPickerSearch');
        }
        
        // Invoice picker for report filters (Pick List)
        async function openInvoicePickerForReport() {
            document.activeElement?.blur();
            
            // Use the existing invoice picker modal (defined in HTML)
            const modal = document.getElementById('invoicePickerModal');
            const listEl = document.getElementById('invoicePickerList');
            
            if (!modal || !listEl) {
                console.error('Invoice picker modal not found');
                return;
            }
            
            // Set flag for report mode
            window.invoicePickerForReport = true;
            
            // Show modal
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            
            // Clear search
            const searchInput = document.getElementById('invoicePickerSearch');
            if (searchInput) searchInput.value = '';
            
            // Show loading
            listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading invoices...</div>';
            
            try {
                const salesResult = await apiCall('getSalesOrders');
                const customersResult = await apiCall('getCustomers');
                
                if (!salesResult?.data) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc2626;">Failed to load invoices</div>';
                    return;
                }
                
                const customers = customersResult?.data || [];
                const customerMap = {};
                customers.forEach(c => customerMap[c.Customer_ID] = c.Customer_Name);
                
                // Filter to only non-voided, non-completed orders for pick list
                const pendingOrders = salesResult.data.filter(s => 
                    s.Status !== 'Voided' && s.Status !== 'Completed' && s.Status !== 'Delivered'
                ).sort((a, b) => new Date(b.Sale_Date || b.SO_Date) - new Date(a.Sale_Date || a.SO_Date));
                
                // Store for filtering
                window.invoicePickerData = pendingOrders.map(s => ({
                    id: s.SO_ID,
                    invoiceNum: s.Invoice_Number || s.SO_Number || s.SO_ID,
                    customerId: s.Customer_ID,
                    customerName: customerMap[s.Customer_ID] || s.Customer_ID,
                    date: s.Sale_Date || s.SO_Date,
                    status: s.Status || 'Pending',
                    amount: parseFloat(s.Total_Amount) || 0
                }));
                
                renderInvoicePickerList();
                focusOnDesktop('invoicePickerSearch');
            } catch(e) {
                listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc2626;">Error: ' + e.message + '</div>';
            }
        }
        
        function renderInvoicePickerList() {
            const listEl = document.getElementById('invoicePickerList');
            if (!listEl) return;
            
            const search = (document.getElementById('invoicePickerSearch')?.value || '').toLowerCase();
            const data = window.invoicePickerData || [];
            
            const filtered = data.filter(inv => {
                if (!search) return true;
                return inv.invoiceNum.toLowerCase().includes(search) ||
                       inv.customerName.toLowerCase().includes(search);
            });
            
            let html = `
                <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectInvoiceForReport('')" onclick="selectInvoiceForReport('')" 
                    style="border-left: 4px solid #10b981; background: #ecfdf5; user-select: none;">
                    <div style="pointer-events: none;">
                        <div class="item-picker-desc" style="font-weight: bold; color: #059669;">
                            <span style="font-size: 20px; margin-right: 8px;"></span> All Invoices
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">Show all pending orders</div>
                    </div>
                </div>
            `;
            
            if (filtered.length === 0) {
                html += '<div style="text-align: center; padding: 30px; color: #666;">No invoices found</div>';
            } else {
                filtered.slice(0, 50).forEach(inv => {
                    const statusColors = {
                        'Pending': '#f59e0b',
                        'Ready': '#3b82f6',
                        'Out for Delivery': '#8b5cf6'
                    };
                    const statusColor = statusColors[inv.status] || '#666';
                    
                    html += `
                        <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectInvoiceForReport('${inv.invoiceNum}')" onclick="selectInvoiceForReport('${inv.invoiceNum}')" 
                            style="user-select: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; pointer-events: none;">
                                <div>
                                    <div class="item-picker-desc" style="font-weight: 600; color: #1f2937;"> ${inv.invoiceNum}</div>
                                    <div style="font-size: 13px; color: #6b7280; margin-top: 2px;"> ${inv.customerName}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 600; color: #059669;">${formatMoney(inv.amount)}</div>
                                    <div style="font-size: 11px; padding: 2px 8px; border-radius: 10px; background: ${statusColor}20; color: ${statusColor}; margin-top: 3px;">${inv.status}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                if (filtered.length > 50) {
                    html += `<div style="text-align: center; padding: 10px; color: #666; font-size: 13px;">Showing 50 of ${filtered.length} invoices. Type to search more...</div>`;
                }
            }
            
            listEl.innerHTML = html;
        }
        
        function filterInvoicePickerList() {
            renderInvoicePickerList();
        }
        
        // Also handle the original filterInvoicePicker for compatibility
        function filterInvoicePicker() {
            if (window.invoicePickerForReport) {
                renderInvoicePickerList();
            }
        }
        
        function selectInvoiceForReport(invoiceNum) {
            const hiddenInput = document.getElementById('rptFilter_salesInvoice');
            const displayInput = document.getElementById('rptFilter_salesInvoice_display');
            if (hiddenInput) hiddenInput.value = invoiceNum;
            if (displayInput) displayInput.value = invoiceNum ? ' ' + invoiceNum : ' All Invoices';
            closeInvoicePicker();
        }
        
        function selectInvoice(invoiceNum) {
            // If in report mode, use report version
            if (window.invoicePickerForReport) {
                selectInvoiceForReport(invoiceNum);
            }
        }
        
        function closeInvoicePicker() {
            const modal = document.getElementById('invoicePickerModal');
            if (modal) modal.style.display = 'none';
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open');
            window.invoicePickerForReport = false;
        }
        
        // Supplier picker for Purchase Orders filter
        function openSupplierPickerForPurchases() {
            // Blur to prevent mobile keyboard
            document.activeElement?.blur();
            
            window.reportPickerType = 'supplier';
            window.supplierPickerIsFilter = true;
            supplierPickerCallback = {
                tagName: 'PURCHASE_FILTER',
                value: document.getElementById('filterPurchaseSupplier').value
            };
            
            // Initialize selected suppliers from current value
            const currentValue = document.getElementById('filterPurchaseSupplier').value;
            if (currentValue) {
                selectedSuppliersForReport = currentValue.split(',').filter(v => v);
            } else {
                selectedSuppliersForReport = [];
            }
            
            document.getElementById('supplierPickerSearch').value = '';
            renderSupplierPickerList();
            document.getElementById('supplierPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            
            // Only focus on desktop
            if (!('ontouchstart' in window)) {
                setTimeout(() => {
                    document.getElementById('supplierPickerSearch').focus();
                }, 100);
            }
        }
        
        // Supplier picker for Inventory filter
        function openSupplierPickerForInventory() {
            document.activeElement?.blur();
            
            window.reportPickerType = 'supplier';
            window.supplierPickerIsFilter = true;
            supplierPickerCallback = {
                tagName: 'INVENTORY_FILTER',
                value: document.getElementById('filterInventorySupplier').value
            };
            
            // Initialize selected suppliers from current value
            const currentValue = document.getElementById('filterInventorySupplier').value;
            if (currentValue) {
                selectedSuppliersForReport = currentValue.split(',').filter(v => v);
            } else {
                selectedSuppliersForReport = [];
            }
            
            document.getElementById('supplierPickerSearch').value = '';
            renderSupplierPickerList();
            document.getElementById('supplierPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('supplierPickerSearch');
        }
        
        // Supplier picker for Pricing Workbench filter
        function openSupplierPickerForPricing() {
            document.activeElement?.blur();
            window.reportPickerType = 'supplier';
            window.supplierPickerIsFilter = true;
            supplierPickerCallback = {
                tagName: 'PRICING_FILTER',
                value: document.getElementById('pricesimSupplier').value
            };
            
            // Initialize selected suppliers from current value
            const currentValue = document.getElementById('pricesimSupplier').value;
            if (currentValue) {
                selectedSuppliersForPricing = currentValue.split(',').filter(v => v);
            } else {
                selectedSuppliersForPricing = [];
            }
            
            document.getElementById('supplierPickerSearch').value = '';
            renderSupplierPickerListForPricing();
            document.getElementById('supplierPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('supplierPickerSearch');
        }
        
        function openSupplierPicker(selectElement) {
            document.activeElement?.blur();
            supplierPickerCallback = selectElement;
            document.getElementById('supplierPickerSearch').value = '';
            renderSupplierPickerList();
            document.getElementById('supplierPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            focusOnDesktop('supplierPickerSearch');
        }
        
        function closeSupplierPicker() {
            document.getElementById('supplierPickerModal').style.display = 'none';
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
            supplierPickerCallback = null;
        }
        
        function filterSupplierPicker() {
            renderSupplierPickerList();
        }
        
        function renderSupplierPickerList() {
            const search = document.getElementById('supplierPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('supplierPickerList');
            
            let suppliers = cachedSuppliers || [];
            
            let filtered = suppliers.filter(s => {
                return !search || 
                    (s.Supplier_Name && s.Supplier_Name.toLowerCase().includes(search)) ||
                    (s.Supplier_ID && s.Supplier_ID.toLowerCase().includes(search)) ||
                    (s.Contact_Name && s.Contact_Name.toLowerCase().includes(search));
            });
            
            // Check if this is a report, purchase, inventory, or pricing filter (multi-select enabled)
            const isReportFilter = supplierPickerCallback && (
                supplierPickerCallback.tagName === 'REPORT_FILTER' || 
                supplierPickerCallback.tagName === 'PURCHASE_FILTER' || 
                supplierPickerCallback.tagName === 'INVENTORY_FILTER' ||
                supplierPickerCallback.tagName === 'PRICING_FILTER'
            );
            
            let html = '';
            
            // Add multi-select controls for report filters
            if (isReportFilter && !search) {
                html += `
                    <div class="item-picker-card" style="border-left: 4px solid #6c757d; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="item-picker-desc" style="font-weight: bold; color: #1976d2;">
                                    <span style="font-size: 18px; margin-right: 8px;"></span> All Suppliers
                                </div>
                                <div style="font-size: 12px; color: #555;">Select specific suppliers below, or leave all unchecked for all suppliers</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllSuppliers()" class="oval-action-btn oval-action-primary" style="font-size: 11px; padding: 4px 10px;"> Select All</button>
                                <button onclick="clearAllSuppliers()" class="oval-action-btn oval-action-warning" style="font-size: 11px; padding: 4px 10px;"> Clear All</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && !isReportFilter) {
                listContainer.innerHTML = `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No suppliers found</div>
                    </div>
                `;
                return;
            }
            
            filtered.forEach(s => {
                const isSelected = selectedSuppliersForReport.includes(s.Supplier_ID);
                const touchHandlers = `ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)"`;
                const clickHandler = isReportFilter 
                    ? `${touchHandlers} ontouchend="if(pickerTouchEnd()) toggleSupplierSelection('${s.Supplier_ID}')" onclick="toggleSupplierSelection('${s.Supplier_ID}')"` 
                    : `${touchHandlers} ontouchend="if(pickerTouchEnd()) selectSupplierFromPicker('${s.Supplier_ID}')" onclick="selectSupplierFromPicker('${s.Supplier_ID}')"`;
                const checkboxHtml = isReportFilter 
                    ? `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSupplierSelection('${s.Supplier_ID}')" style="width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation()">` 
                    : '';
                
                html += `
                    <div class="item-picker-card supplier-card" ${clickHandler} style="border-left: 4px solid ${isSelected ? '#10b981' : '#c0c0c0'}; ${isSelected ? 'background: #d1fae5;' : 'background: white;'} display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        ${checkboxHtml}
                        <div style="flex: 1;">
                            <div class="item-picker-card-header">
                                <span class="item-picker-sku">${s.Supplier_ID}</span>
                            </div>
                            <div class="item-picker-desc" style="margin-bottom: 8px;">${s.Supplier_Name || 'Unnamed Supplier'}</div>
                            <div class="item-picker-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
                                ${s.Contact_Name ? `<div class="item-picker-detail"><span class="item-picker-detail-label"> Contact</span><span class="item-picker-detail-value">${s.Contact_Name}</span></div>` : ''}
                                ${s.Phone ? `<div class="item-picker-detail"><span class="item-picker-detail-label"> Phone</span><span class="item-picker-detail-value">${s.Phone}</span></div>` : ''}
                                ${s.Mobile ? `<div class="item-picker-detail"><span class="item-picker-detail-label"> Mobile</span><span class="item-picker-detail-value">${s.Mobile}</span></div>` : ''}
                                ${s.Email ? `<div class="item-picker-detail"><span class="item-picker-detail-label"> Email</span><span class="item-picker-detail-value" style="font-size: 13px;">${s.Email}</span></div>` : ''}
                            </div>
                            ${s.Address || s.City || s.State || s.ZIP ? `
                                <div style="margin-top: 10px;">
                                    <div style="font-weight: 600; color: #555; margin-bottom: 4px; font-size: 12px;"> ADDRESS</div>
                                    ${s.Address ? `<div style="font-size: 13px; color: #333;">${s.Address}</div>` : ''}
                                    ${s.City || s.State || s.ZIP ? `
                                        <div style="font-size: 13px; color: #555;">
                                            ${s.City || ''}${s.City && (s.State || s.ZIP) ? ', ' : ''}${s.State || ''} ${s.ZIP || ''}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        // Pricing Workbench supplier picker render function
        function renderSupplierPickerListForPricing() {
            const search = document.getElementById('supplierPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('supplierPickerList');
            
            let suppliers = cachedSuppliers || [];
            
            let filtered = suppliers.filter(s => {
                return !search || 
                    (s.Supplier_Name && s.Supplier_Name.toLowerCase().includes(search)) ||
                    (s.Supplier_ID && s.Supplier_ID.toLowerCase().includes(search)) ||
                    (s.Contact_Name && s.Contact_Name.toLowerCase().includes(search));
            });
            
            let html = '';
            
            // Add multi-select controls
            if (!search) {
                html += `
                    <div class="item-picker-card" style="border-left: 4px solid #6c757d; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="item-picker-desc" style="font-weight: bold; color: #1976d2;">
                                    <span style="font-size: 18px; margin-right: 8px;"></span> All Suppliers
                                </div>
                                <div style="font-size: 12px; color: #555;">Select specific suppliers below, or leave all unchecked for all suppliers</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllSuppliersForPricing()" class="oval-action-btn oval-action-primary" style="font-size: 11px; padding: 4px 10px;"> Select All</button>
                                <button onclick="clearAllSuppliersForPricing()" class="oval-action-btn oval-action-warning" style="font-size: 11px; padding: 4px 10px;"> Clear All</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && search) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No suppliers found</div>
                    </div>
                `;
                return;
            }
            
            // Sort alphabetically
            filtered.sort((a, b) => (a.Supplier_Name || '').localeCompare(b.Supplier_Name || ''));
            
            filtered.forEach(s => {
                const isSelected = selectedSuppliersForPricing.includes(s.Supplier_ID);
                const touchHandlers = `ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)"`;
                const clickHandler = `${touchHandlers} ontouchend="if(pickerTouchEnd()) toggleSupplierSelectionForPricing('${s.Supplier_ID}')" onclick="toggleSupplierSelectionForPricing('${s.Supplier_ID}')"`;
                const checkboxHtml = `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSupplierSelectionForPricing('${s.Supplier_ID}')" style="width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation()">`;
                
                html += `
                    <div class="item-picker-card" ${clickHandler} style="border-left: 4px solid ${isSelected ? '#10b981' : '#667eea'}; ${isSelected ? 'background: #d1fae5;' : 'background: white;'} display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        ${checkboxHtml}
                        <div style="flex: 1;">
                            <div class="item-picker-card-header">
                                <span class="item-picker-sku">${s.Supplier_ID || 'No ID'}</span>
                            </div>
                            <div class="item-picker-desc">${s.Supplier_Name || 'No name'}</div>
                            <div class="item-picker-details" style="margin-top: 8px;">
                                ${s.Contact_Name ? `<div style="font-size: 13px; color: #666;"> ${s.Contact_Name}</div>` : ''}
                                ${s.Phone ? `<div style="font-size: 13px; color: #666;"> ${s.Phone}</div>` : ''}
                                ${s.Email ? `<div style="font-size: 13px; color: #666;"> ${s.Email}</div>` : ''}
                                ${(s.Address || s.City || s.State || s.Zip) ? `
                                    <div style="margin-top: 6px; font-size: 12px; color: #777;">
                                        <div style="font-weight: 600; margin-bottom: 2px;"> ADDRESS</div>
                                        ${s.Address ? `<div>${s.Address}</div>` : ''}
                                        ${(s.City || s.State || s.Zip) ? `<div>${[s.City, s.State, s.Zip].filter(Boolean).join(', ')}</div>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        // Pricing-specific supplier selection functions
        function toggleSupplierSelectionForPricing(supplierId) {
            const index = selectedSuppliersForPricing.indexOf(supplierId);
            if (index > -1) {
                selectedSuppliersForPricing.splice(index, 1);
            } else {
                selectedSuppliersForPricing.push(supplierId);
            }
            renderSupplierPickerListForPricing();
            updateSupplierSelectionDisplayForPricing();
        }
        
        function selectAllSuppliersForPricing() {
            const search = document.getElementById('supplierPickerSearch').value.toLowerCase().trim();
            let suppliers = cachedSuppliers || [];
            let filtered = suppliers.filter(s => {
                return !search || 
                    (s.Supplier_Name && s.Supplier_Name.toLowerCase().includes(search)) ||
                    (s.Supplier_ID && s.Supplier_ID.toLowerCase().includes(search)) ||
                    (s.Contact_Name && s.Contact_Name.toLowerCase().includes(search));
            });
            selectedSuppliersForPricing = filtered.map(s => s.Supplier_ID);
            renderSupplierPickerListForPricing();
            updateSupplierSelectionDisplayForPricing();
        }
        
        function clearAllSuppliersForPricing() {
            selectedSuppliersForPricing = [];
            renderSupplierPickerListForPricing();
            updateSupplierSelectionDisplayForPricing();
        }
        
        function updateSupplierSelectionDisplayForPricing() {
            const displayInput = document.getElementById('pricesimSupplier_display');
            const hiddenInput = document.getElementById('pricesimSupplier');
            const countDiv = document.getElementById('supplierSelectionCount');
            
            if (selectedSuppliersForPricing.length === 0) {
                if (displayInput) displayInput.value = '';
                if (hiddenInput) hiddenInput.value = '';
                if (countDiv) countDiv.textContent = 'No suppliers selected (all will be shown)';
            } else if (selectedSuppliersForPricing.length === 1) {
                const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === selectedSuppliersForPricing[0]);
                if (displayInput) displayInput.value = supplier ? supplier.Supplier_Name : selectedSuppliersForPricing[0];
                if (hiddenInput) hiddenInput.value = selectedSuppliersForPricing[0];
                if (countDiv) countDiv.textContent = '1 supplier selected';
            } else if (selectedSuppliersForPricing.length <= 3) {
                // For 2-3 suppliers, show their names
                const names = selectedSuppliersForPricing.map(id => {
                    const s = (cachedSuppliers || []).find(sup => sup.Supplier_ID === id);
                    return s ? s.Supplier_Name : id;
                }).join(', ');
                if (displayInput) displayInput.value = names;
                if (hiddenInput) hiddenInput.value = selectedSuppliersForPricing.join(',');
                if (countDiv) countDiv.textContent = `${selectedSuppliersForPricing.length} suppliers selected`;
            } else {
                if (displayInput) displayInput.value = `${selectedSuppliersForPricing.length} suppliers selected`;
                if (hiddenInput) hiddenInput.value = selectedSuppliersForPricing.join(',');
                if (countDiv) countDiv.textContent = `${selectedSuppliersForPricing.length} suppliers selected`;
            }
            
            // Trigger filter update
            filterPriceSimItems();
        }
        
        // Toggle supplier selection for multi-select
        function toggleSupplierSelection(supplierId) {
            const index = selectedSuppliersForReport.indexOf(supplierId);
            if (index > -1) {
                selectedSuppliersForReport.splice(index, 1);
            } else {
                selectedSuppliersForReport.push(supplierId);
            }
            renderSupplierPickerList();
            updateSupplierSelectionDisplay();
        }
        
        // Select all suppliers
        function selectAllSuppliers() {
            const search = document.getElementById('supplierPickerSearch').value.toLowerCase().trim();
            let suppliers = cachedSuppliers || [];
            let filtered = suppliers.filter(s => {
                return !search || 
                    (s.Supplier_Name && s.Supplier_Name.toLowerCase().includes(search)) ||
                    (s.Supplier_ID && s.Supplier_ID.toLowerCase().includes(search));
            });
            selectedSuppliersForReport = filtered.map(s => s.Supplier_ID);
            renderSupplierPickerList();
            updateSupplierSelectionDisplay();
        }
        
        // Clear all supplier selections
        function clearAllSuppliers() {
            selectedSuppliersForReport = [];
            renderSupplierPickerList();
            updateSupplierSelectionDisplay();
        }
        
        // Update the display field with selection count
        function updateSupplierSelectionDisplay() {
            // Determine which fields to update based on callback
            let displayInput, hiddenInput;
            
            if (supplierPickerCallback && supplierPickerCallback.tagName === 'PURCHASE_FILTER') {
                displayInput = document.getElementById('filterPurchaseSupplier_display');
                hiddenInput = document.getElementById('filterPurchaseSupplier');
            } else if (supplierPickerCallback && supplierPickerCallback.tagName === 'INVENTORY_FILTER') {
                displayInput = document.getElementById('filterInventorySupplier_display');
                hiddenInput = document.getElementById('filterInventorySupplier');
            } else if (supplierPickerCallback && supplierPickerCallback.tagName === 'PRICING_FILTER') {
                displayInput = document.getElementById('pricesimSupplier_display');
                hiddenInput = document.getElementById('pricesimSupplier');
            } else {
                displayInput = document.getElementById('rptFilter_supplier_display');
                hiddenInput = document.getElementById('rptFilter_supplier');
            }
            
            const countDiv = document.getElementById('supplierSelectionCount');
            
            if (selectedSuppliersForReport.length === 0) {
                if (displayInput) displayInput.value = '';
                if (hiddenInput) hiddenInput.value = '';
                if (countDiv) countDiv.textContent = 'No suppliers selected (all will be shown)';
            } else if (selectedSuppliersForReport.length === 1) {
                const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === selectedSuppliersForReport[0]);
                if (displayInput) displayInput.value = supplier ? supplier.Supplier_Name : selectedSuppliersForReport[0];
                if (hiddenInput) hiddenInput.value = selectedSuppliersForReport[0];
                if (countDiv) countDiv.textContent = '1 supplier selected';
            } else if (selectedSuppliersForReport.length <= 3) {
                // For 2-3 suppliers, show their names
                const names = selectedSuppliersForReport.map(id => {
                    const s = (cachedSuppliers || []).find(sup => sup.Supplier_ID === id);
                    return s ? s.Supplier_Name : id;
                }).join(', ');
                if (displayInput) displayInput.value = names;
                if (hiddenInput) hiddenInput.value = selectedSuppliersForReport.join(',');
                if (countDiv) countDiv.textContent = `${selectedSuppliersForReport.length} suppliers selected`;
            } else {
                if (displayInput) displayInput.value = `${selectedSuppliersForReport.length} suppliers selected`;
                if (hiddenInput) hiddenInput.value = selectedSuppliersForReport.join(',');
                if (countDiv) countDiv.textContent = `${selectedSuppliersForReport.length} suppliers selected`;
            }
            
            // Trigger filter update for purchase orders, inventory, or pricing
            if (supplierPickerCallback && supplierPickerCallback.tagName === 'PURCHASE_FILTER') {
                filterPurchases();
            } else if (supplierPickerCallback && supplierPickerCallback.tagName === 'INVENTORY_FILTER') {
                filterInventory();
            } else if (supplierPickerCallback && supplierPickerCallback.tagName === 'PRICING_FILTER') {
                filterPriceSimItems();
            }
        }
        
        function selectSupplierFromPicker(supplierId) {
            if (supplierPickerCallback) {
                // Check if this is a report filter
                if (supplierPickerCallback.tagName === 'REPORT_FILTER') {
                    const displayInput = document.getElementById('rptFilter_supplier_display');
                    const hiddenInput = document.getElementById('rptFilter_supplier');
                    if (supplierId === '') {
                        displayInput.value = '';
                        hiddenInput.value = '';
                    } else {
                        const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === supplierId);
                        displayInput.value = supplier ? supplier.Supplier_Name : supplierId;
                        hiddenInput.value = supplierId;
                    }
                    window.supplierPickerIsFilter = false;
                    closeSupplierPicker();
                    return;
                }
                
                // Check if this is a filter text input or a select element
                const isTextInput = supplierPickerCallback.tagName === 'INPUT' && supplierPickerCallback.type === 'text';
                
                if (isTextInput && supplierPickerIsFilter) {
                    // For filter inputs, set the supplier name as value
                    if (supplierId === '') {
                        supplierPickerCallback.value = '';
                    } else {
                        const supplier = (cachedSuppliers || []).find(s => s.Supplier_ID === supplierId);
                        supplierPickerCallback.value = supplier ? supplier.Supplier_Name : supplierId;
                    }
                    // Trigger the filter function
                    if (typeof filterSuppliers === 'function') filterSuppliers();
                } else {
                    // For select elements, set the ID
                    supplierPickerCallback.value = supplierId;
                    supplierPickerCallback.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // Explicitly call update functions for specific selects
                    const id = supplierPickerCallback.id;
                    if (id === 'createPOSupplier') {
                        if (typeof filterItemsBySupplier === 'function') filterItemsBySupplier();
                    } else if (id === 'poSupplier') {
                        if (typeof loadSupplierItems === 'function') loadSupplierItems();
                    } else if (id === 'filterItemSupplier') {
                        if (typeof filterItems === 'function') filterItems();
                    } else if (id === 'filterPurchaseSupplier') {
                        if (typeof filterPurchases === 'function') filterPurchases();
                    } else if (id === 'filterInventorySupplier') {
                        if (typeof filterInventory === 'function') filterInventory();
                    } else if (id === 'pricesimSupplier') {
                        if (typeof filterPriceSimItems === 'function') filterPriceSimItems();
                    }
                }
            }
            supplierPickerIsFilter = false;
            closeSupplierPicker();
        }
        
        // Toggle supplier selection for multi-select
        function toggleSupplierSelection(supplierId) {
            const index = selectedSuppliersForReport.indexOf(supplierId);
            if (index > -1) {
                selectedSuppliersForReport.splice(index, 1);
            } else {
                selectedSuppliersForReport.push(supplierId);
            }
            renderSupplierPickerList();
            updateSupplierSelectionDisplay();
        }
        
        // Select all suppliers
        function selectAllSuppliers() {
            const search = document.getElementById('supplierPickerSearch').value.toLowerCase().trim();
            let suppliers = cachedSuppliers || [];
            let filtered = suppliers.filter(s => {
                return !search || 
                    (s.Supplier_Name && s.Supplier_Name.toLowerCase().includes(search)) ||
                    (s.Supplier_ID && s.Supplier_ID.toLowerCase().includes(search));
            });
            selectedSuppliersForReport = filtered.map(s => s.Supplier_ID);
            renderSupplierPickerList();
            updateSupplierSelectionDisplay();
        }
        
        // Clear all supplier selections
        function clearAllSuppliers() {
            selectedSuppliersForReport = [];
            renderSupplierPickerList();
            updateSupplierSelectionDisplay();
        }
        
        function attachSupplierPickerToSelects() {
            // Attach to ALL supplier selects on ALL devices (forms + filters + reports)
            const supplierSelects = [
                // Form selects
                '#poSupplier', '#editPOSupplier', '#createPOSupplier', 
                '#newItemSupplier', '#editItemSupplier', '#newSimSupplier',
                // Filter selects
                '#filterItemSupplier', '#filterPurchaseSupplier', 
                '#filterInventorySupplier', '#pricesimSupplier',
                // Report filters
                '#filter_supplier',
                // Class-based
                '.supplier-select'
            ].join(', ');
            
            document.querySelectorAll(supplierSelects).forEach(select => {
                if (!select.dataset.supplierPickerAttached) {
                    select.dataset.supplierPickerAttached = 'true';
                    select.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openSupplierPicker(this);
                    });
                    select.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openSupplierPicker(this);
                    });
                }
            });
        }
        
        // ==================== CUSTOMER PICKER ====================
        
        let customerPickerCallback = null;
        
        function openCustomerPicker(selectElement) {
            document.activeElement?.blur();
            customerPickerCallback = selectElement;
            document.getElementById('customerPickerSearch').value = '';
            renderCustomerPickerList();
            document.getElementById('customerPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            focusOnDesktop('customerPickerSearch');
        }
        
        // Customer picker for Sales Orders filter
        function openCustomerPickerForSales() {
            // Blur to prevent mobile keyboard
            document.activeElement?.blur();
            
            window.reportPickerType = 'customer';
            window.customerPickerIsFilter = true;
            customerPickerCallback = {
                tagName: 'SALES_FILTER',
                value: document.getElementById('filterSaleCustomer').value
            };
            
            // Initialize selected customers from current value
            const currentValue = document.getElementById('filterSaleCustomer').value;
            if (currentValue) {
                selectedCustomersForReport = currentValue.split(',').filter(v => v);
            } else {
                selectedCustomersForReport = [];
            }
            
            document.getElementById('customerPickerSearch').value = '';
            renderCustomerPickerList();
            document.getElementById('customerPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            
            // Only focus on desktop
            if (!('ontouchstart' in window)) {
                setTimeout(() => {
                    document.getElementById('customerPickerSearch').focus();
                }, 100);
            }
        }
        
        function closeCustomerPicker() {
            document.getElementById('customerPickerModal').style.display = 'none';
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
            customerPickerCallback = null;
        }
        
        // ==================== REASON PICKER ====================
        const adjustmentReasons = [
            { value: 'Physical Count', icon: '', desc: 'Adjust to match physical inventory count' },
            { value: 'Damaged Goods', icon: '', desc: 'Items damaged and cannot be sold' },
            { value: 'Expired Products', icon: '', desc: 'Products past expiration date' },
            { value: 'Shrinkage/Theft', icon: '', desc: 'Missing inventory, possible theft' },
            { value: 'Found Inventory', icon: '', desc: 'Located misplaced items' },
            { value: 'Data Correction', icon: '', desc: 'Fix data entry error' },
            { value: 'Returned Goods', icon: '', desc: 'Customer returned products' },
            { value: 'Sample/Promo', icon: '', desc: 'Given as sample or promotion' },
            { value: 'Transfer Out', icon: '', desc: 'Moved to another location' },
            { value: 'Transfer In', icon: '', desc: 'Received from another location' },
            { value: 'Other', icon: '', desc: 'Other reason (add notes)' }
        ];
        
        function openReasonPicker() {
            const listContainer = document.getElementById('reasonPickerList');
            
            let html = '';
            adjustmentReasons.forEach(reason => {
                html += `
                    <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectReason('${reason.value}')" onclick="selectReason('${reason.value}')" 
                         style="border-left: 4px solid #c0c0c0; margin-bottom: 10px; padding: 15px; cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.background='#f0f4ff'; this.style.borderLeftColor='var(--primary, #667eea)'"
                         onmouseout="this.style.background='white'; this.style.borderLeftColor='#c0c0c0'">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">${reason.icon}</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">${reason.value}</div>
                                <div style="font-size: 12px; color: #666;">${reason.desc}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
            
            document.getElementById('reasonPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function selectReason(reason) {
            document.getElementById('adjustReason').value = reason;
            document.getElementById('adjustReasonDisplay').value = reason;
            // Visual feedback - change border to green when reason selected
            document.getElementById('adjustReasonDisplay').style.borderColor = '#10b981';
            document.getElementById('adjustReasonDisplay').style.background = '#ecfdf5';
            closeReasonPicker();
        }
        
        function closeReasonPicker() {
            document.getElementById('reasonPickerModal').style.display = 'none';
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
        }
        
        // ==================== UOM PICKER ====================
        let uomPickerTargetId = null;
        
        const purchaseUOMs = [
            { value: 'Case', icon: '', desc: 'Standard case/carton of products' },
            { value: 'Box', icon: '', desc: 'Smaller box packaging' },
            { value: 'Pack', icon: '', desc: 'Multi-pack bundle' },
            { value: 'Each', icon: '1', desc: 'Individual unit' },
            { value: 'Pallet', icon: '', desc: 'Full pallet load' },
            { value: 'Bag', icon: '', desc: 'Bag packaging' },
            { value: 'Tray', icon: '', desc: 'Tray packaging' },
            { value: 'Dozen', icon: '', desc: '12 units' }
        ];
        
        function openUOMPicker(targetId) {
            uomPickerTargetId = targetId;
            const listContainer = document.getElementById('uomPickerList');
            
            let html = '';
            purchaseUOMs.forEach(uom => {
                html += `
                    <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectUOM('${uom.value}')" onclick="selectUOM('${uom.value}')" 
                         style="border-left: 4px solid #c0c0c0; margin-bottom: 10px; padding: 15px; cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.background='#f0f4ff'; this.style.borderLeftColor='var(--primary, #667eea)'"
                         onmouseout="this.style.background='white'; this.style.borderLeftColor='#c0c0c0'">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">${uom.icon}</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">${uom.value}</div>
                                <div style="font-size: 12px; color: #666;">${uom.desc}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
            
            document.getElementById('uomPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function selectUOM(uom) {
            if (uomPickerTargetId) {
                document.getElementById(uomPickerTargetId).value = uom;
                document.getElementById(uomPickerTargetId + 'Display').value = uom;
            }
            closeUOMPicker();
        }
        
        function closeUOMPicker() {
            document.getElementById('uomPickerModal').style.display = 'none';
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
            uomPickerTargetId = null;
        }
        
        // ==================== THEME PICKER ====================
        const themeCategories = [
            {
                name: ' Classic Themes',
                themes: [
                    { value: 'purple', name: ' Royal Purple', primary: '#667eea', secondary: '#764ba2' },
                    { value: 'ocean', name: ' Ocean Blue', primary: '#0077b6', secondary: '#00b4d8' },
                    { value: 'forest', name: ' Forest Green', primary: '#2d6a4f', secondary: '#40916c' },
                    { value: 'sunset', name: ' Sunset Orange', primary: '#f77f00', secondary: '#fcbf49' },
                    { value: 'crimson', name: ' Crimson Red', primary: '#9d0208', secondary: '#dc2f02' },
                    { value: 'slate', name: ' Slate Gray', primary: '#475569', secondary: '#64748b' },
                    { value: 'teal', name: ' Teal', primary: '#0d9488', secondary: '#14b8a6' },
                    { value: 'dark', name: ' Professional Dark', primary: '#1e293b', secondary: '#334155' }
                ]
            },
            {
                name: ' NFL - AFC',
                themes: [
                    { value: 'bills', name: ' Buffalo Bills', primary: '#00338D', secondary: '#C60C30' },
                    { value: 'dolphins', name: ' Miami Dolphins', primary: '#008E97', secondary: '#FC4C02' },
                    { value: 'patriots', name: ' New England Patriots', primary: '#002244', secondary: '#C60C30' },
                    { value: 'jets', name: ' New York Jets', primary: '#125740', secondary: '#000000' },
                    { value: 'ravens', name: ' Baltimore Ravens', primary: '#241773', secondary: '#9E7C0C' },
                    { value: 'bengals', name: ' Cincinnati Bengals', primary: '#FB4F14', secondary: '#000000' },
                    { value: 'browns', name: ' Cleveland Browns', primary: '#311D00', secondary: '#FF3C00' },
                    { value: 'steelers', name: ' Pittsburgh Steelers', primary: '#FFB612', secondary: '#101820' },
                    { value: 'texans', name: ' Houston Texans', primary: '#03202F', secondary: '#A71930' },
                    { value: 'colts', name: ' Indianapolis Colts', primary: '#002C5F', secondary: '#A2AAAD' },
                    { value: 'jaguars', name: ' Jacksonville Jaguars', primary: '#006778', secondary: '#D7A22A' },
                    { value: 'titans', name: ' Tennessee Titans', primary: '#0C2340', secondary: '#4B92DB' },
                    { value: 'broncos', name: ' Denver Broncos', primary: '#FB4F14', secondary: '#002244' },
                    { value: 'chiefs', name: ' Kansas City Chiefs', primary: '#E31837', secondary: '#FFB81C' },
                    { value: 'raiders', name: ' Las Vegas Raiders', primary: '#000000', secondary: '#A5ACAF' },
                    { value: 'chargers', name: ' Los Angeles Chargers', primary: '#0080C6', secondary: '#FFC20E' }
                ]
            },
            {
                name: ' NFL - NFC',
                themes: [
                    { value: 'cowboys', name: ' Dallas Cowboys', primary: '#003594', secondary: '#869397' },
                    { value: 'giants', name: ' New York Giants', primary: '#0B2265', secondary: '#A71930' },
                    { value: 'eagles', name: ' Philadelphia Eagles', primary: '#004C54', secondary: '#A5ACAF' },
                    { value: 'commanders', name: ' Washington Commanders', primary: '#5A1414', secondary: '#FFB612' },
                    { value: 'bears', name: ' Chicago Bears', primary: '#0B162A', secondary: '#C83803' },
                    { value: 'lions', name: ' Detroit Lions', primary: '#0076B6', secondary: '#B0B7BC' },
                    { value: 'packers', name: ' Green Bay Packers', primary: '#203731', secondary: '#FFB612' },
                    { value: 'vikings', name: ' Minnesota Vikings', primary: '#4F2683', secondary: '#FFC62F' },
                    { value: 'falcons', name: ' Atlanta Falcons', primary: '#A71930', secondary: '#000000' },
                    { value: 'panthers', name: ' Carolina Panthers', primary: '#0085CA', secondary: '#101820' },
                    { value: 'saints', name: ' New Orleans Saints', primary: '#D3BC8D', secondary: '#101820' },
                    { value: 'bucs', name: ' Tampa Bay Buccaneers', primary: '#D50A0A', secondary: '#FF7900' },
                    { value: 'azcardinals', name: ' Arizona Cardinals', primary: '#97233F', secondary: '#000000' },
                    { value: 'rams', name: ' Los Angeles Rams', primary: '#003594', secondary: '#FFA300' },
                    { value: 'niners', name: ' San Francisco 49ers', primary: '#AA0000', secondary: '#B3995D' },
                    { value: 'seahawks', name: ' Seattle Seahawks', primary: '#002244', secondary: '#69BE28' }
                ]
            },
            {
                name: ' NFL Throwbacks',
                themes: [
                    { value: 'bucscreamsicle', name: ' Bucs Creamsicle', primary: '#FF8200', secondary: '#B71234' },
                    { value: 'steelersbee', name: ' Steelers Bumblebee', primary: '#FFB612', secondary: '#000000' },
                    { value: 'oilersthrow', name: ' Oilers Columbia Blue', primary: '#8CBED6', secondary: '#C41E3A' },
                    { value: 'patpatriot', name: ' Patriots Pat Patriot', primary: '#C8102E', secondary: '#002244' },
                    { value: 'chargerspowder', name: ' Chargers Powder Blue', primary: '#0080C6', secondary: '#FFC20E' },
                    { value: 'orangecrush', name: ' Broncos Orange Crush', primary: '#FB4F14', secondary: '#002244' },
                    { value: 'kellygreen', name: ' Eagles Kelly Green', primary: '#004C54', secondary: '#A5ACAF' },
                    { value: 'niners94', name: ' 49ers 94 Gold', primary: '#AA0000', secondary: '#B3995D' },
                    { value: 'rams99', name: ' Rams 99 Blue', primary: '#003594', secondary: '#FFA300' },
                    { value: 'seahawkslime', name: ' Seahawks Original', primary: '#002244', secondary: '#69BE28' },
                    { value: 'falcons66', name: ' Falcons 66', primary: '#A71930', secondary: '#000000' },
                    { value: 'jets98', name: ' Jets 98 Green', primary: '#125740', secondary: '#000000' },
                    { value: 'bears36', name: ' Bears 36 Orange', primary: '#0B162A', secondary: '#C83803' },
                    { value: 'acme', name: ' Packers Acme', primary: '#203731', secondary: '#FFB612' },
                    { value: 'cards47', name: ' Cardinals 47', primary: '#97233F', secondary: '#000000' }
                ]
            },
            {
                name: ' NFL Alternates',
                themes: [
                    { value: 'billsred', name: ' Bills Red Helmet', primary: '#C60C30', secondary: '#00338D' },
                    { value: 'chiefsred', name: ' Chiefs Red on Red', primary: '#E31837', secondary: '#FFB81C' },
                    { value: 'raidersblack', name: ' Raiders Color Rush', primary: '#000000', secondary: '#A5ACAF' },
                    { value: 'whitetiger', name: ' Bengals White Tiger', primary: '#FB4F14', secondary: '#000000' },
                    { value: 'brownsrush', name: ' Browns Color Rush', primary: '#311D00', secondary: '#FF3C00' },
                    { value: 'eaglesblack', name: ' Eagles Black Alt', primary: '#004C54', secondary: '#000000' },
                    { value: 'titansoilers', name: ' Titans Oilers 23', primary: '#8CBED6', secondary: '#C41E3A' },
                    { value: 'actiongreen', name: ' Seahawks Action Green', primary: '#69BE28', secondary: '#002244' },
                    { value: 'jagsteal', name: ' Jaguars Teal', primary: '#006778', secondary: '#D7A22A' },
                    { value: 'purplepeople', name: ' Vikings Purple Eaters', primary: '#4F2683', secondary: '#FFC62F' }
                ]
            },
            {
                name: ' MLB - American League',
                themes: [
                    { value: 'orioles', name: ' Baltimore Orioles', primary: '#DF4601', secondary: '#000000' },
                    { value: 'redsox', name: ' Boston Red Sox', primary: '#BD3039', secondary: '#0C2340' },
                    { value: 'yankees', name: ' New York Yankees', primary: '#003087', secondary: '#E4002C' },
                    { value: 'rays', name: ' Tampa Bay Rays', primary: '#092C5C', secondary: '#8FBCE6' },
                    { value: 'bluejays', name: ' Toronto Blue Jays', primary: '#134A8E', secondary: '#E8291C' },
                    { value: 'whitesox', name: ' Chicago White Sox', primary: '#27251F', secondary: '#C4CED4' },
                    { value: 'guardians', name: ' Cleveland Guardians', primary: '#00385D', secondary: '#E50022' },
                    { value: 'tigers', name: ' Detroit Tigers', primary: '#0C2340', secondary: '#FA4616' },
                    { value: 'royals', name: ' Kansas City Royals', primary: '#004687', secondary: '#BD9B60' },
                    { value: 'twins', name: ' Minnesota Twins', primary: '#002B5C', secondary: '#D31145' },
                    { value: 'astros', name: ' Houston Astros', primary: '#002D62', secondary: '#EB6E1F' },
                    { value: 'angels', name: ' Los Angeles Angels', primary: '#BA0021', secondary: '#003263' },
                    { value: 'athletics', name: ' Oakland Athletics', primary: '#003831', secondary: '#EFB21E' },
                    { value: 'mariners', name: ' Seattle Mariners', primary: '#0C2C56', secondary: '#005C5C' },
                    { value: 'rangers', name: ' Texas Rangers', primary: '#003278', secondary: '#C0111F' }
                ]
            },
            {
                name: ' MLB - National League',
                themes: [
                    { value: 'braves', name: ' Atlanta Braves', primary: '#CE1141', secondary: '#13274F' },
                    { value: 'marlins', name: ' Miami Marlins', primary: '#00A3E0', secondary: '#EF3340' },
                    { value: 'mets', name: ' New York Mets', primary: '#002D72', secondary: '#FF5910' },
                    { value: 'phillies', name: ' Philadelphia Phillies', primary: '#E81828', secondary: '#002D72' },
                    { value: 'nationals', name: ' Washington Nationals', primary: '#AB0003', secondary: '#14225A' },
                    { value: 'cubs', name: ' Chicago Cubs', primary: '#0E3386', secondary: '#CC3433' },
                    { value: 'reds', name: ' Cincinnati Reds', primary: '#C6011F', secondary: '#000000' },
                    { value: 'brewers', name: ' Milwaukee Brewers', primary: '#12284B', secondary: '#B6922E' },
                    { value: 'pirates', name: ' Pittsburgh Pirates', primary: '#27251F', secondary: '#FDB827' },
                    { value: 'stlcardinals', name: ' St. Louis Cardinals', primary: '#C41E3A', secondary: '#0C2340' },
                    { value: 'dbacks', name: ' Arizona Diamondbacks', primary: '#A71930', secondary: '#E3D4AD' },
                    { value: 'rockies', name: ' Colorado Rockies', primary: '#33006F', secondary: '#C4CED4' },
                    { value: 'dodgers', name: ' Los Angeles Dodgers', primary: '#005A9C', secondary: '#EF3E42' },
                    { value: 'padres', name: ' San Diego Padres', primary: '#2F241D', secondary: '#FFC425' },
                    { value: 'sfgiants', name: ' San Francisco Giants', primary: '#FD5A1E', secondary: '#27251F' }
                ]
            },
            {
                name: ' NBA Teams',
                themes: [
                    { value: 'bulls', name: ' Chicago Bulls', primary: '#CE1141', secondary: '#000000' },
                    { value: 'celtics', name: ' Boston Celtics', primary: '#007A33', secondary: '#BA9653' },
                    { value: 'nets', name: ' Brooklyn Nets', primary: '#000000', secondary: '#FFFFFF' },
                    { value: 'knicks', name: ' New York Knicks', primary: '#006BB6', secondary: '#F58426' },
                    { value: 'sixers', name: ' Philadelphia 76ers', primary: '#006BB6', secondary: '#ED174C' },
                    { value: 'raptors', name: ' Toronto Raptors', primary: '#CE1141', secondary: '#000000' },
                    { value: 'cavs', name: ' Cleveland Cavaliers', primary: '#860038', secondary: '#041E42' },
                    { value: 'pistons', name: ' Detroit Pistons', primary: '#C8102E', secondary: '#1D42BA' },
                    { value: 'pacers', name: ' Indiana Pacers', primary: '#002D62', secondary: '#FDBB30' },
                    { value: 'bucks', name: ' Milwaukee Bucks', primary: '#00471B', secondary: '#EEE1C6' },
                    { value: 'hawks', name: ' Atlanta Hawks', primary: '#E03A3E', secondary: '#C1D32F' },
                    { value: 'hornets', name: ' Charlotte Hornets', primary: '#1D1160', secondary: '#00788C' },
                    { value: 'heat', name: ' Miami Heat', primary: '#98002E', secondary: '#F9A01B' },
                    { value: 'magic', name: ' Orlando Magic', primary: '#0077C0', secondary: '#C4CED4' },
                    { value: 'wizards', name: ' Washington Wizards', primary: '#002B5C', secondary: '#E31837' },
                    { value: 'nuggets', name: ' Denver Nuggets', primary: '#0E2240', secondary: '#FEC524' },
                    { value: 'twolves', name: ' Minnesota Timberwolves', primary: '#0C2340', secondary: '#236192' },
                    { value: 'thunder', name: ' Oklahoma City Thunder', primary: '#007AC1', secondary: '#EF3B24' },
                    { value: 'blazers', name: ' Portland Trail Blazers', primary: '#E03A3E', secondary: '#000000' },
                    { value: 'jazz', name: ' Utah Jazz', primary: '#002B5C', secondary: '#00471B' },
                    { value: 'warriors', name: ' Golden State Warriors', primary: '#1D428A', secondary: '#FFC72C' },
                    { value: 'clippers', name: ' LA Clippers', primary: '#C8102E', secondary: '#1D428A' },
                    { value: 'lakers', name: ' Los Angeles Lakers', primary: '#552583', secondary: '#FDB927' },
                    { value: 'suns', name: ' Phoenix Suns', primary: '#1D1160', secondary: '#E56020' },
                    { value: 'nbakings', name: ' Sacramento Kings', primary: '#5A2D81', secondary: '#63727A' },
                    { value: 'mavs', name: ' Dallas Mavericks', primary: '#00538C', secondary: '#002B5E' },
                    { value: 'rockets', name: ' Houston Rockets', primary: '#CE1141', secondary: '#000000' },
                    { value: 'grizzlies', name: ' Memphis Grizzlies', primary: '#5D76A9', secondary: '#12173F' },
                    { value: 'pelicans', name: ' New Orleans Pelicans', primary: '#0C2340', secondary: '#C8102E' },
                    { value: 'spurs', name: ' San Antonio Spurs', primary: '#C4CED4', secondary: '#000000' }
                ]
            },
            {
                name: ' NHL Teams',
                themes: [
                    { value: 'blackhawks', name: ' Chicago Blackhawks', primary: '#CF0A2C', secondary: '#000000' },
                    { value: 'bruins', name: ' Boston Bruins', primary: '#FFB81C', secondary: '#000000' },
                    { value: 'sabres', name: ' Buffalo Sabres', primary: '#002654', secondary: '#FCB514' },
                    { value: 'redwings', name: ' Detroit Red Wings', primary: '#CE1126', secondary: '#FFFFFF' },
                    { value: 'flapanthers', name: ' Florida Panthers', primary: '#041E42', secondary: '#C8102E' },
                    { value: 'canadiens', name: ' Montreal Canadiens', primary: '#AF1E2D', secondary: '#192168' },
                    { value: 'senators', name: ' Ottawa Senators', primary: '#C52032', secondary: '#C2912C' },
                    { value: 'lightning', name: ' Tampa Bay Lightning', primary: '#002868', secondary: '#FFFFFF' },
                    { value: 'mapleleafs', name: ' Toronto Maple Leafs', primary: '#00205B', secondary: '#FFFFFF' },
                    { value: 'hurricanes', name: ' Carolina Hurricanes', primary: '#CC0000', secondary: '#000000' },
                    { value: 'bluejackets', name: ' Columbus Blue Jackets', primary: '#002654', secondary: '#CE1126' },
                    { value: 'devils', name: ' New Jersey Devils', primary: '#CE1126', secondary: '#000000' },
                    { value: 'islanders', name: ' New York Islanders', primary: '#00539B', secondary: '#F47D30' },
                    { value: 'nhlrangers', name: ' New York Rangers', primary: '#0038A8', secondary: '#CE1126' },
                    { value: 'flyers', name: ' Philadelphia Flyers', primary: '#F74902', secondary: '#000000' },
                    { value: 'penguins', name: ' Pittsburgh Penguins', primary: '#000000', secondary: '#FCB514' },
                    { value: 'capitals', name: ' Washington Capitals', primary: '#041E42', secondary: '#C8102E' },
                    { value: 'coyotes', name: ' Arizona Coyotes', primary: '#8C2633', secondary: '#E2D6B5' },
                    { value: 'avalanche', name: ' Colorado Avalanche', primary: '#6F263D', secondary: '#236192' },
                    { value: 'stars', name: ' Dallas Stars', primary: '#006847', secondary: '#8F8F8C' },
                    { value: 'wild', name: ' Minnesota Wild', primary: '#154734', secondary: '#A6192E' },
                    { value: 'predators', name: ' Nashville Predators', primary: '#FFB81C', secondary: '#041E42' },
                    { value: 'stlblues', name: ' St. Louis Blues', primary: '#002F87', secondary: '#FCB514' },
                    { value: 'nhljets', name: ' Winnipeg Jets', primary: '#041E42', secondary: '#004C97' },
                    { value: 'ducks', name: ' Anaheim Ducks', primary: '#F47A38', secondary: '#B9975B' },
                    { value: 'flames', name: ' Calgary Flames', primary: '#C8102E', secondary: '#F1BE48' },
                    { value: 'oilers', name: ' Edmonton Oilers', primary: '#041E42', secondary: '#FF4C00' },
                    { value: 'kings', name: ' Los Angeles Kings', primary: '#111111', secondary: '#A2AAAD' },
                    { value: 'sharks', name: ' San Jose Sharks', primary: '#006D75', secondary: '#EA7200' },
                    { value: 'kraken', name: ' Seattle Kraken', primary: '#001628', secondary: '#99D9D9' },
                    { value: 'canucks', name: ' Vancouver Canucks', primary: '#00205B', secondary: '#00843D' },
                    { value: 'goldenknights', name: ' Vegas Golden Knights', primary: '#B4975A', secondary: '#333F42' }
                ]
            },
            {
                name: ' College Football',
                themes: [
                    { value: 'alabama', name: ' Alabama Crimson Tide', primary: '#9E1B32', secondary: '#828A8F' },
                    { value: 'arkansas', name: ' Arkansas Razorbacks', primary: '#9D2235', secondary: '#000000' },
                    { value: 'auburn', name: ' Auburn Tigers', primary: '#0C2340', secondary: '#E87722' },
                    { value: 'florida', name: ' Florida Gators', primary: '#0021A5', secondary: '#FA4616' },
                    { value: 'georgia', name: ' Georgia Bulldogs', primary: '#BA0C2F', secondary: '#000000' },
                    { value: 'lsu', name: ' LSU Tigers', primary: '#461D7C', secondary: '#FDD023' },
                    { value: 'tennessee', name: ' Tennessee Volunteers', primary: '#FF8200', secondary: '#58595B' },
                    { value: 'texasam', name: ' Texas A&M Aggies', primary: '#500000', secondary: '#FFFFFF' },
                    { value: 'michigan', name: ' Michigan Wolverines', primary: '#00274C', secondary: '#FFCB05' },
                    { value: 'michiganst', name: ' Michigan State Spartans', primary: '#18453B', secondary: '#FFFFFF' },
                    { value: 'ohiostate', name: ' Ohio State Buckeyes', primary: '#BB0000', secondary: '#666666' },
                    { value: 'pennstate', name: ' Penn State Nittany Lions', primary: '#041E42', secondary: '#FFFFFF' },
                    { value: 'wisconsin', name: ' Wisconsin Badgers', primary: '#C5050C', secondary: '#FFFFFF' },
                    { value: 'nebraska', name: ' Nebraska Cornhuskers', primary: '#E41C38', secondary: '#F5F1E7' },
                    { value: 'clemson', name: ' Clemson Tigers', primary: '#F56600', secondary: '#522D80' },
                    { value: 'fsu', name: ' Florida State Seminoles', primary: '#782F40', secondary: '#CEB888' },
                    { value: 'miami', name: ' Miami Hurricanes', primary: '#F47321', secondary: '#005030' },
                    { value: 'oklahoma', name: ' Oklahoma Sooners', primary: '#841617', secondary: '#FDF9D8' },
                    { value: 'okstate', name: ' Oklahoma State Cowboys', primary: '#FF7300', secondary: '#000000' },
                    { value: 'texas', name: ' Texas Longhorns', primary: '#BF5700', secondary: '#333F48' },
                    { value: 'oregon', name: ' Oregon Ducks', primary: '#154733', secondary: '#FEE123' },
                    { value: 'oregonst', name: ' Oregon State Beavers', primary: '#DC4405', secondary: '#000000' },
                    { value: 'usc', name: ' USC Trojans', primary: '#990000', secondary: '#FFC72C' },
                    { value: 'ucla', name: ' UCLA Bruins', primary: '#2D68C4', secondary: '#F2A900' },
                    { value: 'byu', name: ' BYU Cougars', primary: '#002E5D', secondary: '#FFFFFF' },
                    { value: 'notredame', name: ' Notre Dame Fighting Irish', primary: '#0C2340', secondary: '#C99700' }
                ]
            },
            {
                name: ' Fast Food',
                themes: [
                    { value: 'mcdonalds', name: " McDonald's", primary: '#FFC72C', secondary: '#DA291C' },
                    { value: 'burgerking', name: ' Burger King', primary: '#FF8732', secondary: '#502314' },
                    { value: 'wendys', name: " Wendy's", primary: '#E2203D', secondary: '#199FDA' },
                    { value: 'tacobell', name: ' Taco Bell', primary: '#702082', secondary: '#FF5BA3' },
                    { value: 'kfc', name: ' KFC', primary: '#F40027', secondary: '#FFFFFF' },
                    { value: 'subway', name: ' Subway', primary: '#008C15', secondary: '#FFC600' },
                    { value: 'pizzahut', name: ' Pizza Hut', primary: '#EE3124', secondary: '#00A160' },
                    { value: 'chickfila', name: ' Chick-fil-A', primary: '#E51636', secondary: '#004F71' },
                    { value: 'dunkin', name: " Dunkin'", primary: '#FF671F', secondary: '#DA1884' },
                    { value: 'dominos', name: " Domino's", primary: '#006491', secondary: '#E31837' },
                    { value: 'sonic', name: ' Sonic', primary: '#0066A1', secondary: '#EF3E42' },
                    { value: 'arbys', name: " Arby's", primary: '#D22630', secondary: '#64502F' },
                    { value: 'dairyqueen', name: ' Dairy Queen', primary: '#ED1C24', secondary: '#0066B2' },
                    { value: 'jackinthebox', name: ' Jack in the Box', primary: '#E31837', secondary: '#FFD100' },
                    { value: 'popeyes', name: ' Popeyes', primary: '#F15A22', secondary: '#008578' },
                    { value: 'chipotle', name: ' Chipotle', primary: '#441500', secondary: '#A81612' },
                    { value: 'fiveguys', name: ' Five Guys', primary: '#D32323', secondary: '#FFFFFF' },
                    { value: 'innout', name: ' In-N-Out', primary: '#E4002B', secondary: '#FFD700' },
                    { value: 'culvers', name: " Culver's", primary: '#0033A0', secondary: '#FFC72C' },
                    { value: 'timhortons', name: ' Tim Hortons', primary: '#DD0031', secondary: '#683B29' }
                ]
            },
            {
                name: ' Wisconsin & Midwest',
                themes: [
                    { value: 'kwiktrip', name: ' Kwik Trip', primary: '#D21034', secondary: '#231F20' },
                    { value: 'rutters', name: " Rutter's", primary: '#D40029', secondary: '#000000' },
                    { value: 'cenex', name: ' Cenex', primary: '#004B87', secondary: '#ED1C24' },
                    { value: 'cenexcoop', name: ' Cenex Co-op', primary: '#004B87', secondary: '#ED1C24' },
                    { value: 'fleetfarm', name: ' Fleet Farm', primary: '#00703C', secondary: '#231F20' },
                    { value: 'woodmans', name: " Woodman's Markets", primary: '#2E3092', secondary: '#ED1C24' },
                    { value: 'picknsave', name: " Pick 'n Save", primary: '#004990', secondary: '#E4002B' },
                    { value: 'sentry', name: ' Sentry Foods', primary: '#004990', secondary: '#E4002B' },
                    { value: 'festival', name: ' Festival Foods', primary: '#00A651', secondary: '#ED1C24' },
                    { value: 'pigglywiggly', name: ' Piggly Wiggly', primary: '#E31837', secondary: '#231F20' },
                    { value: 'holiday', name: ' Holiday Stationstores', primary: '#00703C', secondary: '#ED1C24' },
                    { value: 'bp', name: ' BP Wisconsin', primary: '#009639', secondary: '#F7E600' },
                    { value: 'caseys', name: " Casey's", primary: '#E21A22', secondary: '#000000' },
                    { value: 'shell', name: ' Shell', primary: '#FFD500', secondary: '#DD1D21' },
                    { value: 'mobil', name: ' Mobil / Exxon', primary: '#0033A0', secondary: '#ED1C24' }
                ]
            },
            {
                name: ' Retro Gaming',
                themes: [
                    { value: 'nes', name: ' NES Classic', primary: '#E60012', secondary: '#484848' },
                    { value: 'snes', name: ' SNES Classic', primary: '#5F249F', secondary: '#009DC4' },
                    { value: 'genesis', name: ' Sega Genesis', primary: '#0060A8', secondary: '#C8102E' },
                    { value: 'gameboy', name: ' Game Boy Color', primary: '#306230', secondary: '#8BAC0F' },
                    { value: 'n64', name: ' N64 Funtastic', primary: '#009E60', secondary: '#A020F0' },
                    { value: 'ps1', name: ' PlayStation 1', primary: '#003087', secondary: '#00A4E8' },
                    { value: 'windows95', name: ' Windows 95', primary: '#008080', secondary: '#000080' },
                    { value: 'windowsxp', name: ' Windows XP Bliss', primary: '#3A6EA5', secondary: '#6EA04B' },
                    { value: 'macos9', name: ' Mac OS 9', primary: '#666666', secondary: '#999999' },
                    { value: 'amiga', name: ' Amiga Workbench', primary: '#FF8800', secondary: '#0055AA' },
                    { value: 'c64', name: ' Commodore 64', primary: '#A5A5FF', secondary: '#0000AA' }
                ]
            },
            {
                name: ' Cars & Sneakers',
                themes: [
                    { value: 'camaro', name: " '69 Camaro Z28", primary: '#FF6600', secondary: '#1C1C1C' },
                    { value: 'challenger', name: " '70 Challenger", primary: '#7B1FA2', secondary: '#1A1A1A' },
                    { value: 'bullitt', name: " '68 Mustang Bullitt", primary: '#355E3B', secondary: '#1A1A1A' },
                    { value: 'supra', name: " '94 Toyota Supra", primary: '#FF4500', secondary: '#1A1A1A' },
                    { value: 'skyline', name: " '99 Nissan Skyline", primary: '#0033CC', secondary: '#C0C0C0' },
                    { value: 'typer', name: " '97 Civic Type R", primary: '#CC0000', secondary: '#FFFFFF' },
                    { value: 'jordan1', name: ' Jordan 1 Chicago', primary: '#CE1126', secondary: '#000000' },
                    { value: 'yeezy', name: ' Yeezy 350', primary: '#B8B8B8', secondary: '#3D3D3D' },
                    { value: 'pigeon', name: ' Nike SB Dunk Pigeon', primary: '#808080', secondary: '#FF6B00' },
                    { value: 'wotherspoon', name: ' Air Max 97 Wotherspoon', primary: '#87CEEB', secondary: '#FFD700' }
                ]
            },
            {
                name: ' Superheroes',
                themes: [
                    { value: 'spiderman', name: ' Spider-Man Classic', primary: '#E62429', secondary: '#003DA5' },
                    { value: 'symbiote', name: ' Spider-Man Symbiote', primary: '#1A1A1A', secondary: '#FFFFFF' },
                    { value: 'batman', name: ' Batman Arkham', primary: '#1A1A1A', secondary: '#2B3A4A' },
                    { value: 'superman', name: ' Superman', primary: '#0099F7', secondary: '#ED1D24' },
                    { value: 'wonderwoman', name: ' Wonder Woman', primary: '#C9A227', secondary: '#B22234' },
                    { value: 'ironman', name: ' Iron Man', primary: '#B71C1C', secondary: '#FFD700' },
                    { value: 'captainamerica', name: ' Captain America', primary: '#002868', secondary: '#BF0A30' },
                    { value: 'hulk', name: ' Hulk', primary: '#4CAF50', secondary: '#1B5E20' },
                    { value: 'thor', name: ' Thor', primary: '#0D47A1', secondary: '#FFD700' },
                    { value: 'harleyquinn', name: ' Harley Quinn', primary: '#E91E63', secondary: '#00BCD4' },
                    { value: 'starlord', name: ' Star-Lord', primary: '#8B0000', secondary: '#FFD700' },
                    { value: 'groot', name: ' Groot', primary: '#8B4513', secondary: '#228B22' },
                    { value: 'marvelrivals', name: ' Marvel Rivals', primary: '#E62429', secondary: '#003DA5' },
                    { value: 'flash', name: ' The Flash', primary: '#E62429', secondary: '#FFD700' },
                    { value: 'greenlantern', name: ' Green Lantern', primary: '#00A651', secondary: '#1A1A1A' },
                    { value: 'reaper', name: ' Overwatch Reaper', primary: '#1A1A1A', secondary: '#8B0000' }
                ]
            },
            {
                name: ' Cyberpunk 2077',
                themes: [
                    { value: 'nightcity', name: ' Night City Neon', primary: '#FF003C', secondary: '#00F0FF' },
                    { value: 'arasaka', name: ' Arasaka Corpo', primary: '#E21B1B', secondary: '#1A1A1A' },
                    { value: 'militech', name: ' Militech Military', primary: '#3D5C5C', secondary: '#8B8B00' },
                    { value: 'moxes', name: ' Moxes Gang', primary: '#9B2D9B', secondary: '#00BFFF' },
                    { value: 'valentinos', name: ' Valentinos Gang', primary: '#DC143C', secondary: '#FFD700' },
                    { value: 'vjacket', name: " V's Jacket", primary: '#FFD700', secondary: '#000000' },
                    { value: 'silverhand', name: ' Johnny Silverhand', primary: '#FF6B35', secondary: '#1A1A1A' },
                    { value: 'cyberpunkui', name: ' Cyberpunk UI', primary: '#00F0FF', secondary: '#FF003C' },
                    { value: 'phantomliberty', name: ' Phantom Liberty', primary: '#B8860B', secondary: '#191970' },
                    { value: 'cyberpunklogo', name: ' Cyberpunk Logo', primary: '#FCE94F', secondary: '#00D4FF' }
                ]
            },
            {
                name: ' Lo-Fi / Vaporwave',
                themes: [
                    { value: 'lofi', name: ' Lo-Fi ChilledCow', primary: '#E67E22', secondary: '#5B3A29' },
                    { value: 'chillhop', name: ' Chillhop Raccoon', primary: '#4A90A4', secondary: '#E8D5B7' },
                    { value: 'vaporwave', name: ' Vaporwave Classic', primary: '#FF71CE', secondary: '#01CDFE' },
                    { value: 'mallsoft', name: ' Mallsoft Sunset', primary: '#FF6B9D', secondary: '#C9EEFF' },
                    { value: 'miamivice', name: ' Miami Vice', primary: '#FF6B9D', secondary: '#00D4FF' },
                    { value: 'outrun', name: ' Outrun Grid', primary: '#FF2975', secondary: '#00BFFF' }
                ]
            },
            {
                name: ' Airlines',
                themes: [
                    { value: 'panam', name: ' Pan Am Classic', primary: '#0033A0', secondary: '#FFFFFF' },
                    { value: 'braniff', name: ' Braniff International', primary: '#FF6600', secondary: '#00A86B' },
                    { value: 'southwest', name: ' Southwest Heart', primary: '#304CB2', secondary: '#FFBF27' },
                    { value: 'pokemon', name: ' ANA Pokmon Jet', primary: '#FFCB05', secondary: '#3D7DCA' }
                ]
            },
            {
                name: ' National Parks',
                themes: [
                    { value: 'yellowstone', name: ' Yellowstone', primary: '#8B4513', secondary: '#228B22' },
                    { value: 'grandcanyon', name: ' Grand Canyon', primary: '#CD5C5C', secondary: '#DAA520' },
                    { value: 'yosemite', name: ' Yosemite', primary: '#2E8B57', secondary: '#4682B4' }
                ]
            },
            {
                name: ' Retro Search Engines',
                themes: [
                    { value: 'yahoo1996', name: ' Yahoo! 1996', primary: '#6001A8', secondary: '#FF9900' },
                    { value: 'yahoo2000s', name: ' Yahoo! 2000s', primary: '#7B0099', secondary: '#FF0000' },
                    { value: 'aol1995', name: ' AOL 1995', primary: '#00C8FF', secondary: '#FFCC00' },
                    { value: 'aol2000s', name: ' AOL 2000s Teal', primary: '#00A0D8', secondary: '#FFFFFF' },
                    { value: 'excite1997', name: ' Excite 1997', primary: '#E4002B', secondary: '#000000' },
                    { value: 'lycos', name: ' Lycos', primary: '#FF0000', secondary: '#000000' },
                    { value: 'altavista', name: ' AltaVista 1998', primary: '#0066CC', secondary: '#FF9900' },
                    { value: 'askjeeves', name: ' Ask Jeeves', primary: '#00A99D', secondary: '#FF6600' },
                    { value: 'webcrawler', name: ' WebCrawler', primary: '#009900', secondary: '#FFFF00' },
                    { value: 'infoseek', name: ' Infoseek 1997', primary: '#660099', secondary: '#FFCC00' },
                    { value: 'msn1998', name: ' MSN 1998 Butterfly', primary: '#00ADEF', secondary: '#FFB900' },
                    { value: 'netscape', name: ' Netscape Navigator', primary: '#0033CC', secondary: '#FFCC00' },
                    { value: 'dogpile', name: ' Dogpile', primary: '#FF6600', secondary: '#6600CC' },
                    { value: 'geocities', name: ' GeoCities Classic', primary: '#FF0099', secondary: '#00FF00' }
                ]
            },
            {
                name: ' MAME Arcade Classics',
                themes: [
                    { value: 'mamepacman', name: ' Pac-Man', primary: '#FFFF00', secondary: '#FF0000' },
                    { value: 'mamemspacman', name: ' Ms. Pac-Man', primary: '#FF21AE', secondary: '#00FFFF' },
                    { value: 'mamedonkeykong', name: ' Donkey Kong', primary: '#E80709', secondary: '#EE7511' },
                    { value: 'mamespaceinvaders', name: ' Space Invaders', primary: '#62DE6D', secondary: '#F83B3A' },
                    { value: 'mamegalaga', name: ' Galaga', primary: '#00FF00', secondary: '#EC4705' },
                    { value: 'mamefrogger', name: ' Frogger', primary: '#66A400', secondary: '#EB1C2D' },
                    { value: 'mamestreetfighter', name: ' Street Fighter II', primary: '#FFFFFF', secondary: '#E70000' },
                    { value: 'mamemortalkombat', name: ' Mortal Kombat', primary: '#EED911', secondary: '#F53929' },
                    { value: 'mamedefender', name: ' Defender', primary: '#00A651', secondary: '#FF4500' },
                    { value: 'mamecentipede', name: ' Centipede', primary: '#228B22', secondary: '#8B4513' },
                    { value: 'mamedigdug', name: ' Dig Dug', primary: '#4169E1', secondary: '#FF0000' },
                    { value: 'mameqbert', name: ' Q*bert', primary: '#9370DB', secondary: '#FF8C00' },
                    { value: 'mametempest', name: ' Tempest', primary: '#8A2BE2', secondary: '#00BFFF' },
                    { value: 'mameasteroids', name: ' Asteroids', primary: '#FFFFFF', secondary: '#00FFFF' },
                    { value: 'mamebubble', name: ' Bubble Bobble', primary: '#FFB6C1', secondary: '#87CEEB' },
                    { value: 'mamegauntlet', name: ' Gauntlet', primary: '#40FF40', secondary: '#FF4040' },
                    { value: 'mamerampage', name: ' Rampage', primary: '#00A000', secondary: '#FF69B4' },
                    { value: 'mamerobotron', name: ' Robotron', primary: '#00FFFF', secondary: '#FF00FF' },
                    { value: 'mamejoust', name: ' Joust', primary: '#FFD700', secondary: '#FF0000' },
                    { value: 'mametron', name: ' Tron', primary: '#00FFFF', secondary: '#FF0000' },
                    { value: 'mamenbajam', name: ' NBA Jam', primary: '#C8102E', secondary: '#002244' },
                    { value: 'mamecontra', name: ' Contra', primary: '#0000FF', secondary: '#FF0000' },
                    { value: 'mamemetalslug', name: ' Metal Slug', primary: '#FFD700', secondary: '#4169E1' },
                    { value: 'mametmnt', name: ' TMNT Arcade', primary: '#008000', secondary: '#FF0000' },
                    { value: 'mamedoubledragon', name: ' Double Dragon', primary: '#0000FF', secondary: '#FF0000' },
                    { value: 'mamefinalfight', name: ' Final Fight', primary: '#FFFF00', secondary: '#FF0000' },
                    { value: 'mamegradius', name: ' Gradius', primary: '#00FFFF', secondary: '#FF4500' },
                    { value: 'mamegoldenaxe', name: ' Golden Axe', primary: '#8B0000', secondary: '#FF4500' },
                    { value: 'mamestrider', name: ' Strider', primary: '#00FF00', secondary: '#FF00FF' },
                    { value: 'mamertype', name: ' R-Type', primary: '#4169E1', secondary: '#FF0000' }
                ]
            },
            {
                name: ' Monster Energy',
                themes: [
                    { value: 'monstergreen', name: ' Monster Original', primary: '#8DC63F', secondary: '#000000' },
                    { value: 'monsterblack', name: ' Ultra Black', primary: '#000000', secondary: '#C0C0C0' },
                    { value: 'monstersunrise', name: ' Ultra Sunrise', primary: '#FF6B00', secondary: '#FFD700' },
                    { value: 'monsterparadise', name: ' Ultra Paradise', primary: '#00FF7F', secondary: '#FFFFFF' },
                    { value: 'monsterviolet', name: ' Ultra Violet', primary: '#9932CC', secondary: '#E0B0FF' },
                    { value: 'monsterpipeline', name: ' Pipeline Punch', primary: '#FF69B4', secondary: '#FFD700' },
                    { value: 'monsterrehab', name: ' Rehab Tea+Lemonade', primary: '#FFD700', secondary: '#8B4513' },
                    { value: 'monsterred', name: ' Ultra Red', primary: '#C8102E', secondary: '#FFFFFF' }
                ]
            },
            {
                name: ' Mountain Dew',
                themes: [
                    { value: 'mtndewgreen', name: ' Original Dew', primary: '#99CC00', secondary: '#006633' },
                    { value: 'mtndewcodered', name: ' Code Red', primary: '#C8102E', secondary: '#000000' },
                    { value: 'mtndewvoltage', name: ' Voltage', primary: '#00B7EB', secondary: '#000000' },
                    { value: 'mtndewbaja', name: ' Baja Blast', primary: '#66CCCC', secondary: '#FFFFFF' },
                    { value: 'mtndewlivewire', name: ' Live Wire', primary: '#FF6B00', secondary: '#000000' },
                    { value: 'mtndewwhiteout', name: ' White Out', primary: '#FFFFFF', secondary: '#00BFFF' }
                ]
            },
            {
                name: ' Root Beer & Soda',
                themes: [
                    { value: 'awrootbeer', name: ' A&W Root Beer', primary: '#8B4513', secondary: '#FFD700' },
                    { value: 'barqs', name: ' Barqs Red Crme', primary: '#C8102E', secondary: '#FFFFFF' },
                    { value: 'mugcream', name: ' Mug Cream Soda', primary: '#FFF8DC', secondary: '#8B4513' },
                    { value: 'ibccherry', name: ' IBC Black Cherry', primary: '#4B0082', secondary: '#C71585' },
                    { value: 'cocacola', name: ' Coca-Cola', primary: '#C8102E', secondary: '#FFFFFF' },
                    { value: 'drpepper', name: ' Dr Pepper', primary: '#8B0000', secondary: '#DAA520' },
                    { value: 'pepsi', name: ' Pepsi', primary: '#004B8D', secondary: '#E4002B' },
                    { value: 'sprite', name: ' Sprite', primary: '#00A550', secondary: '#FFFFFF' },
                    { value: 'fanta', name: ' Fanta Orange', primary: '#FF6600', secondary: '#003DA5' }
                ]
            },
            {
                name: ' Energy Drinks',
                themes: [
                    { value: 'redbull', name: ' Red Bull', primary: '#0050A4', secondary: '#C0C0C0' },
                    { value: 'rockstar', name: ' Rockstar', primary: '#800080', secondary: '#FFD700' },
                    { value: 'nos', name: ' NOS Nitrous', primary: '#000000', secondary: '#FF0000' },
                    { value: 'bang', name: ' Bang Neon', primary: '#FF6B00', secondary: '#FFD700' },
                    { value: 'c4energy', name: ' C4 Electric Blue', primary: '#00BFFF', secondary: '#FFFFFF' },
                    { value: 'alaninu', name: ' Alani Nu Pink', primary: '#FF69B4', secondary: '#E0B0FF' },
                    { value: 'ghostenergy', name: ' Ghost Neon', primary: '#39FF14', secondary: '#000000' },
                    { value: 'celsius', name: ' Celsius Orange', primary: '#FF4500', secondary: '#FFD700' },
                    { value: 'prime', name: ' Prime Tropical', primary: '#00AEEF', secondary: '#FF6B00' },
                    { value: 'reign', name: ' Reign Matte Black', primary: '#000000', secondary: '#C0C0C0' },
                    { value: 'gamerfuel', name: ' Gamer Neon Grid', primary: '#00FFFF', secondary: '#FF00FF' }
                ]
            }
        ];

        function openThemePicker() {
            document.activeElement?.blur();
            renderThemePickerList();
            document.getElementById('themePickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            focusOnDesktop('themePickerSearch');
        }
        
        function closeThemePicker() {
            document.getElementById('themePickerModal').style.display = 'none';
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
        }
        
        function filterThemePicker() {
            renderThemePickerList();
        }
        
        function renderThemePickerList() {
            const search = document.getElementById('themePickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('themePickerList');
            const currentTheme = document.getElementById('themeSelector').value;
            
            let html = '';
            
            themeCategories.forEach(category => {
                // Filter themes in this category
                const filteredThemes = category.themes.filter(t => {
                    return !search || 
                        t.name.toLowerCase().includes(search) || 
                        t.value.toLowerCase().includes(search) ||
                        category.name.toLowerCase().includes(search);
                });
                
                if (filteredThemes.length === 0) return;
                
                // Category header
                html += `<div style="font-weight: 600; font-size: 16px; color: #333; margin: 15px 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #e0e0e0;">${category.name}</div>`;
                
                // Theme grid
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">';
                
                filteredThemes.forEach(theme => {
                    const isSelected = theme.value === currentTheme;
                    html += `
                        <div ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectTheme('${theme.value}', '${theme.name.replace(/'/g, "\\'")}')" onclick="selectTheme('${theme.value}', '${theme.name.replace(/'/g, "\\'")}')" 
                             style="cursor: pointer; padding: 12px; border: 2px solid ${isSelected ? theme.primary : '#e0e0e0'}; border-radius: 12px; background: ${isSelected ? '#f8f9fa' : 'white'}; transition: all 0.2s; display: flex; align-items: center; gap: 10px;"
                             onmouseover="this.style.borderColor='${theme.primary}'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                             onmouseout="this.style.borderColor='${isSelected ? theme.primary : '#e0e0e0'}'; this.style.transform='none'; this.style.boxShadow='none'">
                            <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary} 100%); box-shadow: 0 2px 6px rgba(0,0,0,0.2); flex-shrink: 0;"></div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 500; font-size: 13px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${theme.name}</div>
                                ${isSelected ? '<div style="font-size: 11px; color: #4CAF50; font-weight: 600;"> Active</div>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            if (!html) {
                html = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 15px;"></div>
                        <div>No themes found for "${search}"</div>
                    </div>
                `;
            }
            
            listContainer.innerHTML = html;
        }
        
        function selectTheme(themeValue, themeName) {
            document.getElementById('themeSelector').value = themeValue;
            document.getElementById('themePreviewName').textContent = themeName;
            
            // Call the existing changeTheme function
            changeTheme();
            
            // Update the preview swatch with new colors
            setTimeout(() => {
                const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
                const secondary = getComputedStyle(document.documentElement).getPropertyValue('--secondary').trim();
                document.getElementById('themePreviewSwatch').style.background = `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`;
            }, 50);
            
            closeThemePicker();
        }
        
        // Update theme preview on page load
        function updateThemePreview() {
            const savedTheme = localStorage.getItem('theme') || 'purple';
            document.getElementById('themeSelector').value = savedTheme;
            
            // Find the theme name
            let themeName = ' Royal Purple';
            themeCategories.forEach(cat => {
                const found = cat.themes.find(t => t.value === savedTheme);
                if (found) themeName = found.name;
            });
            
            document.getElementById('themePreviewName').textContent = themeName;
            
            // Update swatch
            setTimeout(() => {
                const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
                const secondary = getComputedStyle(document.documentElement).getPropertyValue('--secondary').trim();
                if (primary && secondary) {
                    document.getElementById('themePreviewSwatch').style.background = `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`;
                }
            }, 100);
        }
        
        function filterCustomerPicker() {
            renderCustomerPickerList();
        }
        
        function renderCustomerPickerList() {
            const search = document.getElementById('customerPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('customerPickerList');
            
            let customers = cachedCustomers || [];
            
            let filtered = customers.filter(c => {
                return !search || 
                    (c.Customer_Name && c.Customer_Name.toLowerCase().includes(search)) ||
                    (c.Customer_ID && c.Customer_ID.toLowerCase().includes(search)) ||
                    (c.Contact_Name && c.Contact_Name.toLowerCase().includes(search)) ||
                    (c.Route && c.Route.toLowerCase().includes(search));
            });
            
            // Check if this is a report or sales filter (multi-select enabled)
            const isReportFilter = customerPickerCallback && (customerPickerCallback.tagName === 'REPORT_FILTER' || customerPickerCallback.tagName === 'SALES_FILTER');
            
            let html = '';
            
            // Add "All Customers" or multi-select controls for report filters
            if (isReportFilter && !search) {
                html += `
                    <div class="item-picker-card" style="border-left: 4px solid #6c757d; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="item-picker-desc" style="font-weight: bold; color: #1976d2;">
                                    <span style="font-size: 18px; margin-right: 8px;"></span> All Customers
                                </div>
                                <div style="font-size: 12px; color: #555;">Select specific customers below, or leave all unchecked for all customers</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllCustomers()" class="oval-action-btn oval-action-primary" style="font-size: 11px; padding: 4px 10px;"> Select All</button>
                                <button onclick="clearAllCustomers()" class="oval-action-btn oval-action-warning" style="font-size: 11px; padding: 4px 10px;"> Clear All</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && !isReportFilter) {
                listContainer.innerHTML = `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No customers found</div>
                    </div>
                `;
                return;
            }
            
            filtered.forEach(c => {
                const isSelected = selectedCustomersForReport.includes(c.Customer_ID);
                const touchHandlers = `ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)"`;
                const clickHandler = isReportFilter 
                    ? `${touchHandlers} ontouchend="if(pickerTouchEnd()) toggleCustomerSelection('${c.Customer_ID}')" onclick="toggleCustomerSelection('${c.Customer_ID}')"` 
                    : `${touchHandlers} ontouchend="if(pickerTouchEnd()) selectCustomerFromPicker('${c.Customer_ID}')" onclick="selectCustomerFromPicker('${c.Customer_ID}')"`;
                const checkboxHtml = isReportFilter 
                    ? `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleCustomerSelection('${c.Customer_ID}')" style="width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation()">` 
                    : '';
                
                // Add Top Customer badge if applicable
                let topCustomerBadge = '';
                if (c.Top_Customer_Rank) {
                    const rank = parseInt(c.Top_Customer_Rank);
                    if (rank === 1) {
                        topCustomerBadge = `<span class="item-picker-stock" style="background: #ffd700; color: #000; border: 2px solid #ffed4e; font-weight: bold;"> #1 Top Customer</span>`;
                    } else if (rank <= 10) {
                        topCustomerBadge = `<span class="item-picker-stock" style="background: #fff9c4; color: #f57f17; border: 2px solid #fbc02d; font-weight: bold;"> Top 10 Customer</span>`;
                    } else if (rank <= 25) {
                        topCustomerBadge = `<span class="item-picker-stock" style="background: #e3f2fd; color: #1565c0; border: 2px solid #64b5f6;"> Top 25 Customer</span>`;
                    }
                }
                
                html += `
                    <div class="item-picker-card customer-card" ${clickHandler} style="border-left: 4px solid ${isSelected ? '#10b981' : '#c0c0c0'}; ${isSelected ? 'background: #d1fae5;' : ''} display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        ${checkboxHtml}
                        <div style="flex: 1;">
                            <div class="item-picker-card-header" style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                                <span class="item-picker-sku">${c.Customer_ID}</span>
                                ${c.Route ? `<span class="item-picker-stock" style="background: #f0f0f0; color: #555;">Route: ${c.Route}</span>` : ''}
                                ${topCustomerBadge}
                            </div>
                            <div class="item-picker-desc" style="margin-bottom: 8px;">${c.Customer_Name || 'Unnamed Customer'}</div>
                            <div class="item-picker-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
                                ${c.Contact_Name ? `<div class="item-picker-detail"><span class="item-picker-detail-label"> Contact</span><span class="item-picker-detail-value">${c.Contact_Name}</span></div>` : ''}
                                ${c.Phone ? `<div class="item-picker-detail"><span class="item-picker-detail-label"> Phone</span><span class="item-picker-detail-value">${c.Phone}</span></div>` : ''}
                                ${c.Mobile ? `<div class="item-picker-detail"><span class="item-picker-detail-label"> Mobile</span><span class="item-picker-detail-value">${c.Mobile}</span></div>` : ''}
                                ${c.Email ? `<div class="item-picker-detail"><span class="item-picker-detail-label"> Email</span><span class="item-picker-detail-value" style="font-size: 13px;">${c.Email}</span></div>` : ''}
                            </div>
                            ${c.Address || c.City || c.State || c.Zip ? `
                                <div style="margin-top: 10px; padding: 10px; background: ${isSelected ? '#ffffff' : '#f8f9fa'}; border-radius: 8px; border: 1px solid #e0e0e0;">
                                    <div style="font-weight: 600; color: #666; margin-bottom: 4px; font-size: 12px;"> ADDRESS</div>
                                    ${c.Address ? `<div style="font-size: 13px; color: #222 !important;">${c.Address}</div>` : ''}
                                    ${c.City || c.State || c.Zip ? `
                                        <div style="font-size: 13px; color: #444 !important;">
                                            ${c.City || ''}${c.City && (c.State || c.Zip) ? ', ' : ''}${c.State || ''} ${c.Zip || ''}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        // Toggle customer selection for multi-select
        function toggleCustomerSelection(customerId) {
            const index = selectedCustomersForReport.indexOf(customerId);
            if (index > -1) {
                selectedCustomersForReport.splice(index, 1);
            } else {
                selectedCustomersForReport.push(customerId);
            }
            renderCustomerPickerList();
            updateCustomerSelectionDisplay();
        }
        
        // Select all customers
        function selectAllCustomers() {
            const search = document.getElementById('customerPickerSearch').value.toLowerCase().trim();
            let customers = cachedCustomers || [];
            let filtered = customers.filter(c => {
                return !search || 
                    (c.Customer_Name && c.Customer_Name.toLowerCase().includes(search)) ||
                    (c.Customer_ID && c.Customer_ID.toLowerCase().includes(search));
            });
            selectedCustomersForReport = filtered.map(c => c.Customer_ID);
            renderCustomerPickerList();
            updateCustomerSelectionDisplay();
        }
        
        // Clear all customer selections
        function clearAllCustomers() {
            selectedCustomersForReport = [];
            renderCustomerPickerList();
            updateCustomerSelectionDisplay();
        }
        
        // Update the display field with selection count
        function updateCustomerSelectionDisplay() {
            // Determine which fields to update based on callback
            let displayInput, hiddenInput;
            
            if (customerPickerCallback && customerPickerCallback.tagName === 'SALES_FILTER') {
                displayInput = document.getElementById('filterSaleCustomer_display');
                hiddenInput = document.getElementById('filterSaleCustomer');
            } else {
                displayInput = document.getElementById('rptFilter_customer_display');
                hiddenInput = document.getElementById('rptFilter_customer');
            }
            
            const countDiv = document.getElementById('customerSelectionCount');
            
            if (selectedCustomersForReport.length === 0) {
                if (displayInput) displayInput.value = '';
                if (hiddenInput) hiddenInput.value = '';
                if (countDiv) countDiv.textContent = 'No customers selected (all will be shown)';
            } else if (selectedCustomersForReport.length === 1) {
                const customer = (cachedCustomers || []).find(c => c.Customer_ID === selectedCustomersForReport[0]);
                if (displayInput) displayInput.value = customer ? customer.Customer_Name : selectedCustomersForReport[0];
                if (hiddenInput) hiddenInput.value = selectedCustomersForReport[0];
                if (countDiv) countDiv.textContent = '1 customer selected';
            } else if (selectedCustomersForReport.length <= 3) {
                // For 2-3 customers, show their names
                const names = selectedCustomersForReport.map(id => {
                    const c = (cachedCustomers || []).find(cust => cust.Customer_ID === id);
                    return c ? c.Customer_Name : id;
                }).join(', ');
                if (displayInput) displayInput.value = names;
                if (hiddenInput) hiddenInput.value = selectedCustomersForReport.join(',');
                if (countDiv) countDiv.textContent = `${selectedCustomersForReport.length} customers selected`;
            } else {
                // For more than 3, show count
                if (displayInput) displayInput.value = `${selectedCustomersForReport.length} customers selected`;
                if (hiddenInput) hiddenInput.value = selectedCustomersForReport.join(',');
                if (countDiv) countDiv.textContent = `${selectedCustomersForReport.length} customers selected`;
            }
            
            // Trigger filter update for sales orders
            if (customerPickerCallback && customerPickerCallback.tagName === 'SALES_FILTER') {
                filterSales();
            }
        }
        
        function selectCustomerFromPicker(customerId) {
            if (customerPickerCallback) {
                // Check if this is a report filter
                if (customerPickerCallback.tagName === 'REPORT_FILTER') {
                    const displayInput = document.getElementById('rptFilter_customer_display');
                    const hiddenInput = document.getElementById('rptFilter_customer');
                    if (customerId === '') {
                        displayInput.value = '';
                        hiddenInput.value = '';
                    } else {
                        const customer = (cachedCustomers || []).find(c => c.Customer_ID === customerId);
                        displayInput.value = customer ? customer.Customer_Name : customerId;
                        hiddenInput.value = customerId;
                    }
                    window.customerPickerIsFilter = false;
                    closeCustomerPicker();
                    return;
                }
                
                // Check if this is a filter text input or a select element
                const isTextInput = customerPickerCallback.tagName === 'INPUT' && customerPickerCallback.type === 'text';
                
                if (isTextInput && window.customerPickerIsFilter) {
                    // For filter inputs, set the customer name as value
                    if (customerId === '') {
                        customerPickerCallback.value = '';
                    } else {
                        const customer = (cachedCustomers || []).find(c => c.Customer_ID === customerId);
                        customerPickerCallback.value = customer ? customer.Customer_Name : customerId;
                    }
                    // Trigger the filter function
                    if (typeof filterCustomers === 'function') filterCustomers();
                } else {
                    customerPickerCallback.value = customerId;
                    customerPickerCallback.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // Explicitly call filter function if it's a filter select
                    const id = customerPickerCallback.id;
                    if (id === 'filterSaleCustomer') {
                        if (typeof filterSales === 'function') filterSales();
                    }
                }
            }
            window.customerPickerIsFilter = false;
            closeCustomerPicker();
        }
        
        function attachCustomerPickerToSelects() {
            // Attach to ALL customer selects on ALL devices (forms + filters + reports)
            const customerSelects = [
                // Form selects
                '#soCustomer', '#editSOCustomer',
                // Filter selects
                '#filterSaleCustomer',
                // Report filters
                '#filter_customer',
                // Class-based
                '.customer-select'
            ].join(', ');
            
            document.querySelectorAll(customerSelects).forEach(select => {
                if (!select.dataset.customerPickerAttached) {
                    select.dataset.customerPickerAttached = 'true';
                    select.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openCustomerPicker(this);
                    });
                    select.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openCustomerPicker(this);
                    });
                }
            });
        }
        
        // ==================== STATUS PICKER ====================
        
        let statusPickerCallback = null;
        let statusPickerOptions = [];
        
        function openStatusPicker(selectElement, title, color) {
            statusPickerCallback = selectElement;
            
            // Get options from the select element
            statusPickerOptions = [];
            Array.from(selectElement.options).forEach(opt => {
                statusPickerOptions.push({
                    value: opt.value,
                    text: opt.textContent,
                    selected: opt.selected
                });
            });
            
            // Set title
            document.getElementById('statusPickerTitle').textContent = title || ' Select Status';
            
            // Render options
            renderStatusPickerList();
            
            // Show modal
            document.getElementById('statusPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closeStatusPicker() {
            document.getElementById('statusPickerModal').style.display = 'none';
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
            statusPickerCallback = null;
        }
        
        function renderStatusPickerList() {
            const listContainer = document.getElementById('statusPickerList');
            
            let html = '';
            statusPickerOptions.forEach((opt, index) => {
                const isAll = opt.value === '';
                const icon = isAll ? '' : (opt.text.match(/^[^\w\s]/) ? opt.text.charAt(0) : '');
                const text = opt.text.replace(/^[^\w\s]\s*/, '');
                
                html += `
                    <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectStatusFromPicker('${opt.value}')" onclick="selectStatusFromPicker('${opt.value}')" 
                         style="border-left: 4px solid #c0c0c0; 
                                ${isAll ? 'background: #f8f9fa;' : ''}
                                ${opt.selected ? 'background: #e8e8e8; border-left-color: #888;' : ''}">
                        <div class="item-picker-desc" style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">${icon}</span>
                            <span style="font-weight: ${opt.selected ? 'bold' : 'normal'};">${text}</span>
                            ${opt.selected ? '<span style="margin-left: auto; color: #555;"></span>' : ''}
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function selectStatusFromPicker(value) {
            if (statusPickerCallback) {
                statusPickerCallback.value = value;
                statusPickerCallback.dispatchEvent(new Event('change', { bubbles: true }));
            }
            closeStatusPicker();
        }
        
        // ==================== PO PICKER ====================
        
        let poPickerCallback = null;
        
        function openPOPicker(inputElement) {
            document.activeElement?.blur();
            poPickerCallback = inputElement;
            document.getElementById('poPickerSearch').value = '';
            renderPOPickerList();
            document.getElementById('poPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            focusOnDesktop('poPickerSearch');
        }
        
        // PO picker for Purchase Orders filter (multi-select)
        function openPOPickerForPurchases() {
            document.activeElement?.blur();
            poPickerCallback = {
                tagName: 'PURCHASE_FILTER',
                value: document.getElementById('filterPurchasePO').value
            };
            
            // Initialize selected POs from current value
            const currentValue = document.getElementById('filterPurchasePO').value;
            if (currentValue) {
                selectedPOsForPurchases = currentValue.split(',').filter(v => v);
            } else {
                selectedPOsForPurchases = [];
            }
            
            document.getElementById('poPickerSearch').value = '';
            renderPOPickerList();
            document.getElementById('poPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('poPickerSearch');
        }
        
        function togglePOSelection(poNum) {
            const index = selectedPOsForPurchases.indexOf(poNum);
            if (index > -1) {
                selectedPOsForPurchases.splice(index, 1);
            } else {
                selectedPOsForPurchases.push(poNum);
            }
            renderPOPickerList();
            updatePOSelectionDisplay();
        }
        
        function selectAllPOs() {
            const search = document.getElementById('poPickerSearch').value.toLowerCase().trim();
            let pos = cachedPurchases || [];
            let filtered = pos.filter(po => {
                return !search || 
                    (po.PO_ID && po.PO_ID.toLowerCase().includes(search)) ||
                    (po.Invoice_Number && po.Invoice_Number.toLowerCase().includes(search));
            });
            // Sort and limit to 50
            filtered.sort((a, b) => new Date(b.PO_Date || 0) - new Date(a.PO_Date || 0));
            selectedPOsForPurchases = filtered.slice(0, 50).map(po => po.Invoice_Number || po.PO_ID);
            renderPOPickerList();
            updatePOSelectionDisplay();
        }
        
        function clearAllPOs() {
            selectedPOsForPurchases = [];
            renderPOPickerList();
            updatePOSelectionDisplay();
        }
        
        function updatePOSelectionDisplay() {
            const displayInput = document.getElementById('filterPurchasePO_display');
            const hiddenInput = document.getElementById('filterPurchasePO');
            const countDiv = document.getElementById('poSelectionCount');
            
            if (selectedPOsForPurchases.length === 0) {
                if (displayInput) displayInput.value = '';
                if (hiddenInput) hiddenInput.value = '';
                if (countDiv) countDiv.textContent = 'No POs selected (all will be shown)';
            } else if (selectedPOsForPurchases.length === 1) {
                if (displayInput) displayInput.value = selectedPOsForPurchases[0];
                if (hiddenInput) hiddenInput.value = selectedPOsForPurchases[0];
                if (countDiv) countDiv.textContent = '1 PO selected';
            } else {
                if (displayInput) displayInput.value = `${selectedPOsForPurchases.length} POs selected`;
                if (hiddenInput) hiddenInput.value = selectedPOsForPurchases.join(',');
                if (countDiv) countDiv.textContent = `${selectedPOsForPurchases.length} POs selected`;
            }
            
            // Trigger filter update
            filterPurchases();
        }
        
        function closePOPicker() {
            document.getElementById('poPickerModal').style.display = 'none';
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
            poPickerCallback = null;
        }
        
        function filterPOPicker() {
            renderPOPickerList();
        }
        
        function renderPOPickerList() {
            const search = document.getElementById('poPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('poPickerList');
            
            // Get POs from cache
            let pos = cachedPurchases || [];
            
            let filtered = pos.filter(po => {
                return !search || 
                    (po.PO_ID && po.PO_ID.toLowerCase().includes(search)) ||
                    (po.Invoice_Number && po.Invoice_Number.toLowerCase().includes(search));
            });
            
            // Check if this is a purchase filter (multi-select enabled)
            const isPurchaseFilter = poPickerCallback && poPickerCallback.tagName === 'PURCHASE_FILTER';
            
            let html = '';
            
            // Add multi-select controls for purchase filter
            if (isPurchaseFilter && !search) {
                html += `
                    <div class="item-picker-card" style="border-left: 4px solid #6c757d; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="item-picker-desc" style="font-weight: bold; color: #1976d2;">
                                    <span style="font-size: 18px; margin-right: 8px;"></span> All Purchase Orders
                                </div>
                                <div style="font-size: 12px; color: #555;">Select specific POs below, or leave all unchecked for all POs</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllPOs()" class="oval-action-btn oval-action-primary" style="font-size: 11px; padding: 4px 10px;"> Select All</button>
                                <button onclick="clearAllPOs()" class="oval-action-btn oval-action-warning" style="font-size: 11px; padding: 4px 10px;"> Clear All</button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (!isPurchaseFilter && !search) {
                // Add "Clear Filter" option for single-select mode
                html += `
                    <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectPOFromPicker('')" onclick="selectPOFromPicker('')" style="border-left: 4px solid #6c757d; background: #f8f9fa;">
                        <div class="item-picker-desc" style="font-weight: bold; color: #495057;">
                            <span style="font-size: 18px; margin-right: 8px;"></span> Clear Filter
                        </div>
                        <div style="font-size: 12px; color: #6c757d;">Show all purchase orders</div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && !isPurchaseFilter) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No purchase orders found</div>
                    </div>
                `;
                return;
            }
            
            // Sort by date descending
            filtered.sort((a, b) => new Date(b.PO_Date || 0) - new Date(a.PO_Date || 0));
            
            // Limit to 50
            filtered.slice(0, 50).forEach(po => {
                const status = po.Status || 'Ordered';
                const statusColor = status === 'Received' ? '#4caf50' : '#ff9800';
                const supplierName = getSupplierName(po.Supplier_ID);
                const total = parseFloat(po.Total_Amount) || 0;
                const date = po.PO_Date ? new Date(po.PO_Date).toLocaleDateString() : '';
                const displayNum = po.Invoice_Number || po.PO_ID;
                
                const isSelected = selectedPOsForPurchases.includes(displayNum);
                const touchHandlers = `ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)"`;
                const clickHandler = isPurchaseFilter 
                    ? `${touchHandlers} ontouchend="if(pickerTouchEnd()) togglePOSelection('${displayNum}')" onclick="togglePOSelection('${displayNum}')"` 
                    : `${touchHandlers} ontouchend="if(pickerTouchEnd()) selectPOFromPicker('${displayNum}')" onclick="selectPOFromPicker('${displayNum}')"`;
                const checkboxHtml = isPurchaseFilter 
                    ? `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="togglePOSelection('${displayNum}')" style="width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation()">` 
                    : '';
                
                html += `
                    <div class="item-picker-card" ${clickHandler} style="border-left: 4px solid ${isSelected ? '#10b981' : '#c0c0c0'}; ${isSelected ? 'background: #d1fae5;' : 'background: white;'} display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        ${checkboxHtml}
                        <div style="flex: 1;">
                            <div class="item-picker-card-header">
                                <span class="item-picker-sku">${displayNum}</span>
                                <span class="item-picker-stock" style="background: ${status === 'Received' ? '#e8f5e9' : '#fff3e0'}; color: ${statusColor};">${status}</span>
                            </div>
                            <div class="item-picker-desc">${supplierName}</div>
                            <div class="item-picker-details">
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Date</span>
                                    <span class="item-picker-detail-value">${date}</span>
                                </div>
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Total</span>
                                <span class="item-picker-detail-value item-picker-price">${formatMoney(total)}</span>
                            </div>
                            ${po.PO_ID !== displayNum ? `<div class="item-picker-detail"><span class="item-picker-detail-label">PO ID</span><span class="item-picker-detail-value">${po.PO_ID}</span></div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function selectPOFromPicker(poNumber) {
            if (poPickerCallback) {
                poPickerCallback.value = poNumber;
                if (typeof filterPurchases === 'function') filterPurchases();
            }
            closePOPicker();
        }
        
        // ==================== INVOICE PICKER ====================
        
        let invoicePickerCallback = null;
        
        function openInvoicePicker(inputElement) {
            document.activeElement?.blur();
            invoicePickerCallback = inputElement;
            document.getElementById('invoicePickerSearch').value = '';
            renderInvoicePickerList();
            document.getElementById('invoicePickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            focusOnDesktop('invoicePickerSearch');
        }
        
        // Invoice picker for Sales Orders filter (multi-select)
        function openInvoicePickerForSales() {
            document.activeElement?.blur();
            invoicePickerCallback = {
                tagName: 'SALES_FILTER',
                value: document.getElementById('filterInvoiceNumber').value
            };
            
            // Initialize selected invoices from current value
            const currentValue = document.getElementById('filterInvoiceNumber').value;
            if (currentValue) {
                selectedInvoicesForSales = currentValue.split(',').filter(v => v);
            } else {
                selectedInvoicesForSales = [];
            }
            
            document.getElementById('invoicePickerSearch').value = '';
            renderInvoicePickerList();
            document.getElementById('invoicePickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('invoicePickerSearch');
        }
        
        function toggleInvoiceSelection(invoiceNum) {
            const index = selectedInvoicesForSales.indexOf(invoiceNum);
            if (index > -1) {
                selectedInvoicesForSales.splice(index, 1);
            } else {
                selectedInvoicesForSales.push(invoiceNum);
            }
            renderInvoicePickerList();
            updateInvoiceSelectionDisplay();
        }
        
        function selectAllInvoices() {
            const search = document.getElementById('invoicePickerSearch').value.toLowerCase().trim();
            let sales = cachedSales || [];
            let filtered = sales.filter(sale => {
                return !search || 
                    (sale.Invoice_Number && sale.Invoice_Number.toLowerCase().includes(search)) ||
                    (sale.SO_Number && sale.SO_Number.toLowerCase().includes(search));
            });
            // Sort and limit to 50
            filtered.sort((a, b) => new Date(b.Sale_Date || 0) - new Date(a.Sale_Date || 0));
            selectedInvoicesForSales = filtered.slice(0, 50).map(s => s.Invoice_Number || s.SO_Number || 'No Invoice#');
            renderInvoicePickerList();
            updateInvoiceSelectionDisplay();
        }
        
        function clearAllInvoices() {
            selectedInvoicesForSales = [];
            renderInvoicePickerList();
            updateInvoiceSelectionDisplay();
        }
        
        function updateInvoiceSelectionDisplay() {
            const displayInput = document.getElementById('filterInvoiceNumber_display');
            const hiddenInput = document.getElementById('filterInvoiceNumber');
            const countDiv = document.getElementById('invoiceSelectionCount');
            
            if (selectedInvoicesForSales.length === 0) {
                if (displayInput) displayInput.value = '';
                if (hiddenInput) hiddenInput.value = '';
                if (countDiv) countDiv.textContent = 'No invoices selected (all will be shown)';
            } else if (selectedInvoicesForSales.length === 1) {
                if (displayInput) displayInput.value = selectedInvoicesForSales[0];
                if (hiddenInput) hiddenInput.value = selectedInvoicesForSales[0];
                if (countDiv) countDiv.textContent = '1 invoice selected';
            } else {
                if (displayInput) displayInput.value = `${selectedInvoicesForSales.length} invoices selected`;
                if (hiddenInput) hiddenInput.value = selectedInvoicesForSales.join(',');
                if (countDiv) countDiv.textContent = `${selectedInvoicesForSales.length} invoices selected`;
            }
            
            // Trigger filter update
            filterSales();
        }
        
        function closeInvoicePicker() {
            document.getElementById('invoicePickerModal').style.display = 'none';
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
            invoicePickerCallback = null;
        }
        
        function filterInvoicePicker() {
            renderInvoicePickerList();
        }
        
        function renderInvoicePickerList() {
            const search = document.getElementById('invoicePickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('invoicePickerList');
            
            // Get Sales from cache
            let sales = cachedSales || [];
            
            let filtered = sales.filter(sale => {
                return !search || 
                    (sale.Invoice_Number && sale.Invoice_Number.toLowerCase().includes(search)) ||
                    (sale.SO_Number && sale.SO_Number.toLowerCase().includes(search));
            });
            
            // Check if this is a sales filter (multi-select enabled)
            const isSalesFilter = invoicePickerCallback && invoicePickerCallback.tagName === 'SALES_FILTER';
            
            let html = '';
            
            // Add multi-select controls for sales filter
            if (isSalesFilter && !search) {
                html += `
                    <div class="item-picker-card" style="border-left: 4px solid #6c757d; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="item-picker-desc" style="font-weight: bold; color: #1976d2;">
                                    <span style="font-size: 18px; margin-right: 8px;"></span> All Invoices
                                </div>
                                <div style="font-size: 12px; color: #555;">Select specific invoices below, or leave all unchecked for all invoices</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllInvoices()" class="oval-action-btn oval-action-primary" style="font-size: 11px; padding: 4px 10px;"> Select All</button>
                                <button onclick="clearAllInvoices()" class="oval-action-btn oval-action-warning" style="font-size: 11px; padding: 4px 10px;"> Clear All</button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (!isSalesFilter && !search) {
                // Add "Clear Filter" option for single-select mode
                html += `
                    <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) selectInvoiceFromPicker('')" onclick="selectInvoiceFromPicker('')" style="border-left: 4px solid #6c757d; background: #f8f9fa;">
                        <div class="item-picker-desc" style="font-weight: bold; color: #495057;">
                            <span style="font-size: 18px; margin-right: 8px;"></span> Clear Filter
                        </div>
                        <div style="font-size: 12px; color: #6c757d;">Show all invoices</div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && !isSalesFilter) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No invoices found</div>
                    </div>
                `;
                return;
            }
            
            // Sort by date descending
            filtered.sort((a, b) => new Date(b.Sale_Date || 0) - new Date(a.Sale_Date || 0));
            
            // Limit to 50
            filtered.slice(0, 50).forEach(sale => {
                const customerName = getCustomerName(sale.Customer_ID);
                const total = parseFloat(sale.Total_Amount) || 0;
                const date = sale.Sale_Date ? new Date(sale.Sale_Date).toLocaleDateString() : '';
                const invoiceNum = sale.Invoice_Number || sale.SO_Number || 'No Invoice#';
                
                const isSelected = selectedInvoicesForSales.includes(invoiceNum);
                const touchHandlers = `ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)"`;
                const clickHandler = isSalesFilter 
                    ? `${touchHandlers} ontouchend="if(pickerTouchEnd()) toggleInvoiceSelection('${invoiceNum}')" onclick="toggleInvoiceSelection('${invoiceNum}')"` 
                    : `${touchHandlers} ontouchend="if(pickerTouchEnd()) selectInvoiceFromPicker('${invoiceNum}')" onclick="selectInvoiceFromPicker('${invoiceNum}')"`;
                const checkboxHtml = isSalesFilter 
                    ? `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleInvoiceSelection('${invoiceNum}')" style="width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation()">` 
                    : '';
                
                html += `
                    <div class="item-picker-card" ${clickHandler} style="border-left: 4px solid ${isSelected ? '#10b981' : '#c0c0c0'}; ${isSelected ? 'background: #d1fae5;' : 'background: white;'} display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        ${checkboxHtml}
                        <div style="flex: 1;">
                            <div class="item-picker-card-header">
                                <span class="item-picker-sku">${invoiceNum}</span>
                            </div>
                        <div class="item-picker-desc">${customerName}</div>
                        <div class="item-picker-details">
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Date</span>
                                <span class="item-picker-detail-value">${date}</span>
                            </div>
                            <div class="item-picker-detail">
                                <span class="item-picker-detail-label">Total</span>
                                <span class="item-picker-detail-value item-picker-price">${formatMoney(total)}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function selectInvoiceFromPicker(invoiceNumber) {
            if (invoicePickerCallback) {
                invoicePickerCallback.value = invoiceNumber;
                if (typeof filterSales === 'function') filterSales();
            }
            closeInvoicePicker();
        }
        
        // ==================== ITEM PICKER (for reports) ====================
        
        function openItemPickerForReport() {
            document.activeElement?.blur();
            // Initialize selected items from current value
            const currentValue = document.getElementById('rptFilter_item').value;
            if (currentValue) {
                selectedItemsForReport = currentValue.split(',').filter(v => v);
            } else {
                selectedItemsForReport = [];
            }
            
            document.getElementById('itemPickerSearch').value = '';
            renderItemPickerListForReport();
            document.getElementById('itemPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            focusOnDesktop('itemPickerSearch');
        }
        
        // Item picker for Inventory filter (multi-select)
        function openItemPickerForInventory() {
            document.activeElement?.blur();
            window.reportPickerType = 'item';
            window.itemPickerCallback = {
                tagName: 'INVENTORY_FILTER',
                value: document.getElementById('filterInventorySearch').value
            };
            
            // Initialize selected items from current value
            const currentValue = document.getElementById('filterInventorySearch').value;
            if (currentValue) {
                selectedItemsForInventory = currentValue.split(',').filter(v => v);
            } else {
                selectedItemsForInventory = [];
            }
            
            document.getElementById('itemPickerSearch').value = '';
            renderItemPickerListForInventory();
            document.getElementById('itemPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('itemPickerSearch');
        }
        
        // Item picker for Pricing Workbench filter (multi-select)
        function openItemPickerForPricing() {
            document.activeElement?.blur();
            window.reportPickerType = 'item';
            window.itemPickerCallback = {
                tagName: 'PRICING_FILTER',
                value: document.getElementById('pricesimSearch').value
            };
            
            // Initialize selected items from current value
            const currentValue = document.getElementById('pricesimSearch').value;
            if (currentValue) {
                selectedItemsForPricing = currentValue.split(',').filter(v => v);
            } else {
                selectedItemsForPricing = [];
            }
            
            document.getElementById('itemPickerSearch').value = '';
            renderItemPickerListForPricing();
            document.getElementById('itemPickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            focusOnDesktop('itemPickerSearch');
        }
        
        function closeItemPickerForReport() {
            document.getElementById('itemPickerModal').style.display = 'none';
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
        }
        
        function renderItemPickerListForInventory() {
            const search = document.getElementById('itemPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('itemPickerList');
            
            let items = cachedItems || [];
            
            let filtered = items.filter(item => {
                return !search || 
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(search)) ||
                    (item.SKU && item.SKU.toLowerCase().includes(search));
            });
            
            let html = '';
            
            // Add multi-select controls at top
            if (!search) {
                html += `
                    <div class="item-picker-card" style="border-left: 4px solid #6c757d; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="item-picker-desc" style="font-weight: bold; color: #1976d2;">
                                    <span style="font-size: 18px; margin-right: 8px;"></span> All Items
                                </div>
                                <div style="font-size: 12px; color: #555;">Select specific items below, or leave all unchecked for all items</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllItemsForInventory()" class="oval-action-btn oval-action-primary" style="font-size: 11px; padding: 4px 10px;"> Select All</button>
                                <button onclick="clearAllItemsForInventory()" class="oval-action-btn oval-action-warning" style="font-size: 11px; padding: 4px 10px;"> Clear All</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && search) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No items found matching "${search}"</div>
                    </div>
                `;
                return;
            }
            
            // Sort alphabetically by description
            filtered.sort((a, b) => (a.Item_Description || '').localeCompare(b.Item_Description || ''));
            
            // Show items
            filtered.forEach(item => {
                const supplierName = getSupplierName(item.Supplier_ID);
                const sellPrice = parseFloat(item.Sell_Price) || 0;
                const costPrice = parseFloat(item.Cost) || 0;
                const qty = parseInt(item.Qty_On_Hand) || 0;
                
                // Stock status color
                let stockColor = '#28a745';
                let stockBg = '#e8f5e9';
                if (qty <= 0) {
                    stockColor = '#dc3545';
                    stockBg = '#ffebee';
                } else if (qty <= (parseInt(item.Reorder_Point) || 10)) {
                    stockColor = '#ff9800';
                    stockBg = '#fff3e0';
                }
                
                const isSelected = selectedItemsForInventory.includes(item.Item_ID);
                const touchHandlers = `ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)"`;
                const clickHandler = `${touchHandlers} ontouchend="if(pickerTouchEnd()) toggleItemSelectionForInventory('${item.Item_ID}')" onclick="toggleItemSelectionForInventory('${item.Item_ID}')"`;
                const checkboxHtml = `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleItemSelectionForInventory('${item.Item_ID}')" style="width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation()">`;
                
                html += `
                    <div class="item-picker-card" ${clickHandler} style="border-left: 4px solid ${isSelected ? '#10b981' : '#667eea'}; ${isSelected ? 'background: #d1fae5;' : 'background: white;'} display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        ${checkboxHtml}
                        <div style="flex: 1;">
                            <div class="item-picker-card-header">
                                <span class="item-picker-sku">${item.SKU || 'No SKU'}</span>
                                <span class="item-picker-stock" style="background: ${stockBg}; color: ${stockColor};">${qty} in stock</span>
                            </div>
                            <div class="item-picker-desc">${item.Item_Description || 'No description'}</div>
                            <div class="item-picker-details">
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Supplier</span>
                                    <span class="item-picker-detail-value">${supplierName}</span>
                                </div>
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Cost</span>
                                    <span class="item-picker-detail-value">${formatMoney(costPrice)}</span>
                                </div>
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Sell Price</span>
                                    <span class="item-picker-detail-value">${formatMoney(sellPrice)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        // Smart handler for item picker search that routes to correct render function
        function handleItemPickerSearch() {
            // Check callback context to determine which render function to use
            if (window.itemPickerCallback && window.itemPickerCallback.tagName === 'INVENTORY_FILTER') {
                renderItemPickerListForInventory();
            } else if (window.itemPickerCallback && window.itemPickerCallback.tagName === 'PRICING_FILTER') {
                renderItemPickerListForPricing();
            } else {
                // Default to report picker and general picker
                window.filterItemPicker();
                filterItemPickerForReport();
            }
        }
        
        function filterItemPickerForReport() {
            renderItemPickerListForReport();
        }
        
        function renderItemPickerListForReport() {
            const search = document.getElementById('itemPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('itemPickerList');
            
            let items = cachedItems || [];
            
            let filtered = items.filter(item => {
                return !search || 
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(search)) ||
                    (item.SKU && item.SKU.toLowerCase().includes(search));
            });
            
            let html = '';
            
            // Add multi-select controls at top
            if (!search) {
                html += `
                    <div class="item-picker-card" style="border-left: 4px solid #6c757d; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="item-picker-desc" style="font-weight: bold; color: #1976d2;">
                                    <span style="font-size: 18px; margin-right: 8px;"></span> All Items
                                </div>
                                <div style="font-size: 12px; color: #555;">Select specific items below, or leave all unchecked for all items</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllItems()" class="oval-action-btn oval-action-primary" style="font-size: 11px; padding: 4px 10px;"> Select All</button>
                                <button onclick="clearAllItems()" class="oval-action-btn oval-action-warning" style="font-size: 11px; padding: 4px 10px;"> Clear All</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && search) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No items found matching "${search}"</div>
                    </div>
                `;
                return;
            }
            
            // Sort alphabetically by description
            filtered.sort((a, b) => (a.Item_Description || '').localeCompare(b.Item_Description || ''));
            
            // Show items
            filtered.forEach(item => {
                const supplierName = getSupplierName(item.Supplier_ID);
                const sellPrice = parseFloat(item.Sell_Price) || 0;
                const costPrice = parseFloat(item.Cost) || 0;
                const qty = parseInt(item.Qty_On_Hand) || 0;
                const onOrder = parseInt(item.Qty_On_Order) || 0;
                const onBackorder = parseInt(item.Qty_On_Backorder) || 0;
                const expectedDate = item.Expected_Restock_Date;
                
                // Stock status color
                let stockColor = '#28a745';
                let stockBg = '#e8f5e9';
                if (qty <= 0) {
                    stockColor = '#dc3545';
                    stockBg = '#ffebee';
                } else if (qty <= (parseInt(item.Reorder_Point) || 10)) {
                    stockColor = '#ff9800';
                    stockBg = '#fff3e0';
                }
                
                // Add On Order badge if there's quantity on order
                const onOrderBadge = onOrder > 0 ? `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; border: 2px solid #90caf9; margin-left: 4px;"> ${onOrder} On Order</span>` : '';
                
                // Add Backorder badge if there's quantity on backorder
                const backorderBadge = onBackorder > 0 ? `<span style="background: #fff3e0; color: #e65100; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; border: 2px solid #ffb74d; margin-left: 4px;"> ${onBackorder} Backorder</span>` : '';
                
                // Add Expected Date badge if available
                let expectedDateBadge = '';
                if (expectedDate && onOrder > 0) {
                    const expDate = new Date(expectedDate);
                    const today = new Date();
                    const daysUntil = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                    let dateColor = '#2e7d32';
                    let dateBg = '#e8f5e9';
                    
                    if (daysUntil < 0) {
                        dateColor = '#c62828';
                        dateBg = '#ffebee';
                    } else if (daysUntil <= 3) {
                        dateColor = '#e65100';
                        dateBg = '#fff3e0';
                    }
                    
                    const dateText = daysUntil < 0 ? `Overdue ${Math.abs(daysUntil)}d` : 
                                     daysUntil === 0 ? 'Today' : 
                                     daysUntil === 1 ? 'Tomorrow' : 
                                     `${daysUntil} days`;
                    
                    expectedDateBadge = `<div style="margin-top: 6px;"><span style="background: ${dateBg}; color: ${dateColor}; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; border: 2px solid ${dateColor === '#2e7d32' ? '#81c784' : dateColor === '#e65100' ? '#ffb74d' : '#e57373'};"> Expected: ${expDate.toLocaleDateString()} (${dateText})</span></div>`;
                }
                
                // Add Top Seller badge if applicable
                let topSellerBadge = '';
                if (item.Top_Seller_Rank) {
                    const rank = parseInt(item.Top_Seller_Rank);
                    if (rank === 1) {
                        topSellerBadge = `<span style="background: #ffd700; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; border: 2px solid #ffed4e; margin-left: 4px;"> #1 Best Seller</span>`;
                    } else if (rank <= 10) {
                        topSellerBadge = `<span style="background: #fff9c4; color: #f57f17; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; border: 2px solid #fbc02d; margin-left: 4px;"> Top 10 Best Seller</span>`;
                    } else if (rank <= 25) {
                        topSellerBadge = `<span style="background: #e3f2fd; color: #1565c0; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; border: 2px solid #64b5f6; margin-left: 4px;"> Top 25 Best Seller</span>`;
                    }
                }
                
                const isSelected = selectedItemsForReport.includes(item.Item_ID);
                const checkboxHtml = `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleItemSelection('${item.Item_ID}')" style="width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation()">`;
                
                html += `
                    <div class="item-picker-card" ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)" ontouchend="if(pickerTouchEnd()) toggleItemSelection('${item.Item_ID}')" onclick="toggleItemSelection('${item.Item_ID}')" style="border-left: 4px solid ${isSelected ? '#10b981' : stockColor}; ${isSelected ? 'background: #d1fae5;' : ''} display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        ${checkboxHtml}
                        <div style="flex: 1;">
                            <div class="item-picker-card-header" style="display: flex; flex-wrap: wrap; gap: 4px; align-items: center;">
                                <span class="item-picker-sku">${item.SKU || 'No SKU'}</span>
                                <span style="background: ${stockBg}; color: ${stockColor}; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold;">${qty} in stock</span>${onOrderBadge}${backorderBadge}${topSellerBadge}
                            </div>
                            ${expectedDateBadge}
                            <div class="item-picker-desc">${item.Item_Description || 'No Description'}</div>
                            <div class="item-picker-details">
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Supplier</span>
                                    <span class="item-picker-detail-value">${supplierName}</span>
                                </div>
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Sell</span>
                                    <span class="item-picker-detail-value item-picker-price">${formatMoney(sellPrice)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        // Toggle item selection for multi-select
        function toggleItemSelection(itemId) {
            const index = selectedItemsForReport.indexOf(itemId);
            if (index > -1) {
                selectedItemsForReport.splice(index, 1);
            } else {
                selectedItemsForReport.push(itemId);
            }
            renderItemPickerListForReport();
            updateItemSelectionDisplay();
        }
        
        // Select all items
        function selectAllItems() {
            const search = document.getElementById('itemPickerSearch').value.toLowerCase().trim();
            let items = cachedItems || [];
            let filtered = items.filter(item => {
                return !search || 
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(search)) ||
                    (item.SKU && item.SKU.toLowerCase().includes(search));
            });
            selectedItemsForReport = filtered.map(item => item.Item_ID);
            renderItemPickerListForReport();
            updateItemSelectionDisplay();
        }
        
        // Clear all item selections
        function clearAllItems() {
            selectedItemsForReport = [];
            renderItemPickerListForReport();
            updateItemSelectionDisplay();
        }
        
        // Pricing Workbench item picker render function
        function renderItemPickerListForPricing() {
            const search = document.getElementById('itemPickerSearch').value.toLowerCase().trim();
            const listContainer = document.getElementById('itemPickerList');
            
            let items = cachedItems || [];
            
            let filtered = items.filter(item => {
                return !search || 
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(search)) ||
                    (item.SKU && item.SKU.toLowerCase().includes(search));
            });
            
            let html = '';
            
            // Add multi-select controls at top
            if (!search) {
                html += `
                    <div class="item-picker-card" style="border-left: 4px solid #6c757d; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="item-picker-desc" style="font-weight: bold; color: #1976d2;">
                                    <span style="font-size: 18px; margin-right: 8px;"></span> All Items
                                </div>
                                <div style="font-size: 12px; color: #555;">Select specific items below, or leave all unchecked for all items</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllItemsForPricing()" class="oval-action-btn oval-action-primary" style="font-size: 11px; padding: 4px 10px;"> Select All</button>
                                <button onclick="clearAllItemsForPricing()" class="oval-action-btn oval-action-warning" style="font-size: 11px; padding: 4px 10px;"> Clear All</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (filtered.length === 0 && search) {
                listContainer.innerHTML = html + `
                    <div class="item-picker-empty">
                        <div class="item-picker-empty-icon"></div>
                        <div>No items found matching "${search}"</div>
                    </div>
                `;
                return;
            }
            
            // Sort alphabetically by description
            filtered.sort((a, b) => (a.Item_Description || '').localeCompare(b.Item_Description || ''));
            
            // Show items
            filtered.forEach(item => {
                const supplierName = getSupplierName(item.Supplier_ID);
                const sellPrice = parseFloat(item.Sell_Price) || 0;
                const costPrice = parseFloat(item.Cost) || 0;
                const qty = parseInt(item.Qty_On_Hand) || 0;
                
                // Stock status color
                let stockColor = '#28a745';
                let stockBg = '#e8f5e9';
                if (qty <= 0) {
                    stockColor = '#dc3545';
                    stockBg = '#ffebee';
                } else if (qty <= (parseInt(item.Reorder_Point) || 10)) {
                    stockColor = '#ff9800';
                    stockBg = '#fff3e0';
                }
                
                const isSelected = selectedItemsForPricing.includes(item.Item_ID);
                const touchHandlers = `ontouchstart="pickerTouchStart(event)" ontouchmove="pickerTouchMove(event)"`;
                const clickHandler = `${touchHandlers} ontouchend="if(pickerTouchEnd()) toggleItemSelectionForPricing('${item.Item_ID}')" onclick="toggleItemSelectionForPricing('${item.Item_ID}')"`;
                const checkboxHtml = `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleItemSelectionForPricing('${item.Item_ID}')" style="width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation()">`;
                
                html += `
                    <div class="item-picker-card" ${clickHandler} style="border-left: 4px solid ${isSelected ? '#10b981' : '#667eea'}; ${isSelected ? 'background: #d1fae5;' : 'background: white;'} display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        ${checkboxHtml}
                        <div style="flex: 1;">
                            <div class="item-picker-card-header">
                                <span class="item-picker-sku">${item.SKU || 'No SKU'}</span>
                                <span class="item-picker-stock" style="background: ${stockBg}; color: ${stockColor};">${qty} in stock</span>
                            </div>
                            <div class="item-picker-desc">${item.Item_Description || 'No description'}</div>
                            <div class="item-picker-details">
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Supplier</span>
                                    <span class="item-picker-detail-value">${supplierName}</span>
                                </div>
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Cost</span>
                                    <span class="item-picker-detail-value">${formatMoney(costPrice)}</span>
                                </div>
                                <div class="item-picker-detail">
                                    <span class="item-picker-detail-label">Sell Price</span>
                                    <span class="item-picker-detail-value">${formatMoney(sellPrice)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        // Pricing-specific item selection functions
        function toggleItemSelectionForPricing(itemId) {
            const index = selectedItemsForPricing.indexOf(itemId);
            if (index > -1) {
                selectedItemsForPricing.splice(index, 1);
            } else {
                selectedItemsForPricing.push(itemId);
            }
            renderItemPickerListForPricing();
            updateItemSelectionDisplayForPricing();
        }
        
        function selectAllItemsForPricing() {
            const search = document.getElementById('itemPickerSearch').value.toLowerCase().trim();
            let items = cachedItems || [];
            let filtered = items.filter(item => {
                return !search || 
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(search)) ||
                    (item.SKU && item.SKU.toLowerCase().includes(search));
            });
            selectedItemsForPricing = filtered.map(item => item.Item_ID);
            renderItemPickerListForPricing();
            updateItemSelectionDisplayForPricing();
        }
        
        function clearAllItemsForPricing() {
            selectedItemsForPricing = [];
            renderItemPickerListForPricing();
            updateItemSelectionDisplayForPricing();
        }
        
        function updateItemSelectionDisplayForPricing() {
            const displayInput = document.getElementById('pricesimSearch_display');
            const hiddenInput = document.getElementById('pricesimSearch');
            const countDiv = document.getElementById('itemSelectionCount');
            
            if (selectedItemsForPricing.length === 0) {
                if (displayInput) displayInput.value = '';
                if (hiddenInput) hiddenInput.value = '';
                if (countDiv) countDiv.textContent = 'No items selected (all will be shown)';
            } else if (selectedItemsForPricing.length === 1) {
                const item = (cachedItems || []).find(i => i.Item_ID === selectedItemsForPricing[0]);
                if (displayInput) displayInput.value = item ? item.Item_Description : selectedItemsForPricing[0];
                if (hiddenInput) hiddenInput.value = selectedItemsForPricing[0];
                if (countDiv) countDiv.textContent = '1 item selected';
            } else {
                if (displayInput) displayInput.value = `${selectedItemsForPricing.length} items selected`;
                if (hiddenInput) hiddenInput.value = selectedItemsForPricing.join(',');
                if (countDiv) countDiv.textContent = `${selectedItemsForPricing.length} items selected`;
            }
            
            // Trigger filter update
            filterPriceSimItems();
        }
        
        // Inventory-specific item selection functions
        function toggleItemSelectionForInventory(itemId) {
            const index = selectedItemsForInventory.indexOf(itemId);
            if (index > -1) {
                selectedItemsForInventory.splice(index, 1);
            } else {
                selectedItemsForInventory.push(itemId);
            }
            renderItemPickerListForInventory();
            updateItemSelectionDisplayForInventory();
        }
        
        function selectAllItemsForInventory() {
            const search = document.getElementById('itemPickerSearch').value.toLowerCase().trim();
            let items = cachedItems || [];
            let filtered = items.filter(item => {
                return !search || 
                    (item.Item_Description && item.Item_Description.toLowerCase().includes(search)) ||
                    (item.SKU && item.SKU.toLowerCase().includes(search));
            });
            selectedItemsForInventory = filtered.map(item => item.Item_ID);
            renderItemPickerListForInventory();
            updateItemSelectionDisplayForInventory();
        }
        
        function clearAllItemsForInventory() {
            selectedItemsForInventory = [];
            renderItemPickerListForInventory();
            updateItemSelectionDisplayForInventory();
        }
        
        function updateItemSelectionDisplayForInventory() {
            const displayInput = document.getElementById('filterInventorySearch_display');
            const hiddenInput = document.getElementById('filterInventorySearch');
            const countDiv = document.getElementById('itemSelectionCount');
            
            if (selectedItemsForInventory.length === 0) {
                if (displayInput) displayInput.value = '';
                if (hiddenInput) hiddenInput.value = '';
                if (countDiv) countDiv.textContent = 'No items selected (all will be shown)';
            } else if (selectedItemsForInventory.length === 1) {
                const item = (cachedItems || []).find(i => i.Item_ID === selectedItemsForInventory[0]);
                if (displayInput) displayInput.value = item ? item.Item_Description : selectedItemsForInventory[0];
                if (hiddenInput) hiddenInput.value = selectedItemsForInventory[0];
                if (countDiv) countDiv.textContent = '1 item selected';
            } else {
                if (displayInput) displayInput.value = `${selectedItemsForInventory.length} items selected`;
                if (hiddenInput) hiddenInput.value = selectedItemsForInventory.join(',');
                if (countDiv) countDiv.textContent = `${selectedItemsForInventory.length} items selected`;
            }
            
            // Trigger filter update
            filterInventory();
        }
        
        // Update the display field with selection count
        function updateItemSelectionDisplay() {
            const displayInput = document.getElementById('rptFilter_item_display');
            const hiddenInput = document.getElementById('rptFilter_item');
            const countDiv = document.getElementById('itemSelectionCount');
            
            if (selectedItemsForReport.length === 0) {
                displayInput.value = '';
                hiddenInput.value = '';
                if (countDiv) countDiv.textContent = 'No items selected (all will be shown)';
            } else if (selectedItemsForReport.length === 1) {
                const item = (cachedItems || []).find(i => i.Item_ID === selectedItemsForReport[0]);
                displayInput.value = item ? item.Item_Description : selectedItemsForReport[0];
                hiddenInput.value = selectedItemsForReport[0];
                if (countDiv) countDiv.textContent = '1 item selected';
            } else {
                displayInput.value = `${selectedItemsForReport.length} items selected`;
                hiddenInput.value = selectedItemsForReport.join(',');
                if (countDiv) countDiv.textContent = `${selectedItemsForReport.length} items selected`;
            }
        }
        
        function selectItemForReport(itemId, itemName) {
            document.getElementById('rptFilter_item').value = itemId;
            document.getElementById('rptFilter_item_display').value = itemId ? itemName : 'All Items (click to filter)';
            closeItemPickerForReport();
        }
        
        // ==================== PO TYPE PICKER (for reports) ====================
        
        function openPOTypePicker() {
            document.getElementById('poTypePickerModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closePOTypePicker() {
            document.getElementById('poTypePickerModal').style.display = 'none';
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // FIX: Remove modal-open class
        }
        
        function selectPOType(typeValue, typeName) {
            document.getElementById('rptFilter_poType').value = typeValue;
            document.getElementById('rptFilter_poType_display').value = typeValue ? typeName : 'All Types (click to select)';
            closePOTypePicker();
        }
        
        function attachStatusPickerToSelects() {
            // Stock Status selects
            document.querySelectorAll('#filterItemStock, #filterInventoryStock, #pricesimStock').forEach(select => {
                if (!select.dataset.statusPickerAttached) {
                    select.dataset.statusPickerAttached = 'true';
                    select.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openStatusPicker(this, ' Stock Status', 'stock');
                    });
                    select.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openStatusPicker(this, ' Stock Status', 'stock');
                    });
                }
            });
            
            // Order Status selects
            document.querySelectorAll('#filterPurchaseStatus').forEach(select => {
                if (!select.dataset.statusPickerAttached) {
                    select.dataset.statusPickerAttached = 'true';
                    select.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openStatusPicker(this, ' Order Status', 'order');
                    });
                    select.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openStatusPicker(this, ' Order Status', 'order');
                    });
                }
            });
            
            // Payment Status selects
            document.querySelectorAll('#filterPurchasePaymentStatus').forEach(select => {
                if (!select.dataset.statusPickerAttached) {
                    select.dataset.statusPickerAttached = 'true';
                    select.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openStatusPicker(this, ' Payment Status', 'payment');
                    });
                    select.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openStatusPicker(this, ' Payment Status', 'payment');
                    });
                }
            });
        }
        
        // Attach all pickers on page load
        document.addEventListener('DOMContentLoaded', function() {
            attachItemPickerToSelects();
            attachSupplierPickerToSelects();
            attachCustomerPickerToSelects();
            attachStatusPickerToSelects();
            setInterval(() => {
                attachItemPickerToSelects();
                attachSupplierPickerToSelects();
                attachCustomerPickerToSelects();
                attachStatusPickerToSelects();
            }, 1000);
            
            // ==================== ORIENTATION CHANGE FIX ====================
            // Prevent screen from becoming "loose" when rotating device
            
            function lockViewport() {
                // Only re-lock if a modal is actually open
                const modalsOpen = document.querySelectorAll('.modal[style*="display: block"], #orderModal[style*="display: block"], #reportSetupModal[style*="display: block"]');
                if (modalsOpen.length > 0) {
                    document.body.classList.add('modal-open');
                    document.body.style.overflow = 'hidden';
                    document.body.style.position = 'fixed';
                    document.body.style.width = '100%';
                } else {
                    // Make sure body is NOT locked when no modal is open
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.position = '';
                    document.body.style.width = '';
                    document.body.style.minHeight = '';
                }
            }
            
            // Handle orientation change
            window.addEventListener('orientationchange', function() {
                setTimeout(lockViewport, 100);
                setTimeout(lockViewport, 300); // Double-check after animation
            });
            
            // Handle resize (also triggered by orientation on some devices)
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(lockViewport, 150);
            });
        });
        
        // ==================== HOW-TO GUIDE FUNCTIONS ====================
        
        function openHowToGuide() {
            document.getElementById('howToGuideModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            showGuideSection('getting-started'); // Show first section by default
        }
        
        function closeHowToGuide() {
            document.getElementById('howToGuideModal').style.display = 'none';
            document.body.style.overflow = '';
        }
        
        // ==================== TUTORIAL CONTENT ====================
        
        const tutorialContent = {
            // ===== SUPPLIER TUTORIALS =====
            'add-supplier': {
                title: 'How to Add a New Supplier',
                icon: '',
                category: 'Supplier Tasks',
                color: '#3b82f6',
                steps: [
                    { action: 'Navigate to Suppliers', detail: 'Click the <strong> Suppliers</strong> tab in the navigation bar.' },
                    { action: 'Click Add New', detail: 'Click the <strong>+ Add Supplier</strong> button in the top-right corner.' },
                    { action: 'Enter Supplier Name', detail: 'Type the supplier\'s company name (e.g., "Better Made Snack Foods").' },
                    { action: 'Add Contact Information', detail: 'Fill in contact name, phone number, and email address.' },
                    { action: 'Enter Address', detail: 'Add the supplier\'s street address, city, state, and ZIP code.' },
                    { action: 'Set Payment Terms', detail: 'Select payment terms from the dropdown (Net 30, Net 15, COD, etc.).' },
                    { action: 'Save', detail: 'Click <strong>Save Supplier</strong> to add them to your database.' }
                ],
                tips: ['Supplier ID is auto-generated (S001, S002, etc.)', 'You can add notes for special instructions or account numbers', 'Suppliers can be archived later if no longer used']
            },
            'edit-supplier': {
                title: 'How to Edit Supplier Information',
                icon: '',
                category: 'Supplier Tasks',
                color: '#3b82f6',
                steps: [
                    { action: 'Go to Suppliers', detail: 'Click the <strong> Suppliers</strong> tab.' },
                    { action: 'Find the Supplier', detail: 'Use the search box to find the supplier, or scroll through the list.' },
                    { action: 'Click Edit', detail: 'Click the <strong> Edit</strong> button on the supplier\'s row.' },
                    { action: 'Update Information', detail: 'Modify any fields that need updating (contact, phone, address, terms, etc.).' },
                    { action: 'Save Changes', detail: 'Click <strong>Save Changes</strong> to update the supplier record.' }
                ],
                tips: ['Changes take effect immediately', 'Existing POs are not affected by contact info changes', 'Use the Notes field to track important details']
            },
            'supplier-history': {
                title: 'How to View Supplier Purchase History',
                icon: '',
                category: 'Supplier Tasks',
                color: '#3b82f6',
                steps: [
                    { action: 'Go to Suppliers', detail: 'Click the <strong> Suppliers</strong> tab.' },
                    { action: 'Find the Supplier', detail: 'Locate the supplier you want to review.' },
                    { action: 'Click View', detail: 'Click the <strong> View</strong> button to see supplier details.' },
                    { action: 'Review Purchase History', detail: 'Scroll down to see all purchase orders placed with this supplier.' },
                    { action: 'Optional: Use Reports', detail: 'For more detail, go to <strong>Reports  Supplier Dashboard</strong> for analytics.' }
                ],
                tips: ['The Supplier Dashboard shows total spend and order frequency', 'You can filter by date range in reports', 'Click any PO number to see full details']
            },
            'archive-supplier': {
                title: 'How to Archive/Restore a Supplier',
                icon: '',
                category: 'Supplier Tasks',
                color: '#3b82f6',
                steps: [
                    { action: 'Go to Suppliers', detail: 'Click the <strong> Suppliers</strong> tab.' },
                    { action: 'Find the Supplier', detail: 'Locate the supplier you want to archive.' },
                    { action: 'Click Archive', detail: 'Click the <strong> Archive</strong> button (or find it in the Edit screen).' },
                    { action: 'Confirm', detail: 'Click <strong>Yes, Archive</strong> to confirm.' },
                    { action: 'To Restore', detail: 'Toggle "Show Archived" at the top, find the supplier, and click <strong>Restore</strong>.' }
                ],
                tips: ['Archived suppliers are hidden but not deleted', 'You cannot create new POs for archived suppliers', 'Historical data is preserved for reporting']
            },
            
            // ===== ITEM/PRODUCT TUTORIALS =====
            'add-item': {
                title: 'How to Add a New Item',
                icon: '',
                category: 'Item/Product Tasks',
                color: '#22c55e',
                steps: [
                    { action: 'Navigate to Items', detail: 'Click the <strong> Items</strong> tab in the navigation bar.' },
                    { action: 'Click Add New', detail: 'Click the <strong>+ Add Item</strong> button.' },
                    { action: 'Select Supplier', detail: 'Choose the supplier this item comes from (required).' },
                    { action: 'Enter SKU', detail: 'Add a unique product code/SKU (e.g., "BM-CHIPS-BBQ").' },
                    { action: 'Enter Description', detail: 'Type the item name/description (e.g., "BBQ Potato Chips 1oz").' },
                    { action: 'Set Package Cost', detail: 'Enter what you pay for one package from the supplier.' },
                    { action: 'Set Units Per Package', detail: 'How many sellable units come in one package (e.g., 24 bags per case).' },
                    { action: 'Set Sell Price', detail: 'Enter the price you charge customers per unit.' },
                    { action: 'Set Starting Inventory', detail: 'Enter current quantity on hand (can be 0).' },
                    { action: 'Set Reorder Point', detail: 'Set the low stock alert threshold.' },
                    { action: 'Save', detail: 'Click <strong>Save Item</strong> to add it to inventory.' }
                ],
                tips: ['Unit cost is auto-calculated: Package Cost  Units Per Package', 'Margin is auto-calculated from cost and sell price', 'SKUs should be unique and consistent for easy searching']
            },
            'update-pricing': {
                title: 'How to Update Item Pricing',
                icon: '',
                category: 'Item/Product Tasks',
                color: '#22c55e',
                steps: [
                    { action: 'Go to Items', detail: 'Click the <strong> Items</strong> tab.' },
                    { action: 'Find the Item', detail: 'Use search or filters to find the item.' },
                    { action: 'Click Edit', detail: 'Click the <strong> Edit</strong> button on the item row.' },
                    { action: 'Update Package Cost', detail: 'If supplier prices changed, update the package cost.' },
                    { action: 'Update Sell Price', detail: 'Adjust your selling price per unit as needed.' },
                    { action: 'Review Margin', detail: 'Check that the calculated margin is acceptable.' },
                    { action: 'Save Changes', detail: 'Click <strong>Save Changes</strong> to update pricing.' }
                ],
                tips: ['Use Price Simulator to test price changes before committing', 'Price changes affect new orders only, not existing ones', 'Consider competitor pricing and your target margin']
            },
            'set-reorder': {
                title: 'How to Set Reorder Points',
                icon: '',
                category: 'Item/Product Tasks',
                color: '#22c55e',
                steps: [
                    { action: 'Go to Items', detail: 'Click the <strong> Items</strong> tab.' },
                    { action: 'Find the Item', detail: 'Locate the item you want to set alerts for.' },
                    { action: 'Click Edit', detail: 'Click the <strong> Edit</strong> button.' },
                    { action: 'Set Reorder Point', detail: 'Enter the quantity that triggers a low stock alert (e.g., 50 units).' },
                    { action: 'Save', detail: 'Click <strong>Save Changes</strong>.' },
                    { action: 'Monitor', detail: 'Low stock items appear in the <strong>Action Dashboard</strong> and <strong>Inventory Flow Dashboard</strong>.' }
                ],
                tips: ['Set reorder point based on lead time and sales velocity', 'Consider: How many do you sell per week? How long does restock take?', 'Items below reorder point show a red warning badge']
            },
            'archive-item': {
                title: 'How to Archive Discontinued Items',
                icon: '',
                category: 'Item/Product Tasks',
                color: '#22c55e',
                steps: [
                    { action: 'Go to Items', detail: 'Click the <strong> Items</strong> tab.' },
                    { action: 'Find the Item', detail: 'Locate the discontinued item.' },
                    { action: 'Click Edit', detail: 'Click the <strong> Edit</strong> button.' },
                    { action: 'Change Status', detail: 'Change the Status dropdown from "Active" to "Archived".' },
                    { action: 'Save', detail: 'Click <strong>Save Changes</strong>.' }
                ],
                tips: ['Archived items are hidden from new orders but history is preserved', 'You can restore items by changing status back to Active', 'Consider selling remaining stock before archiving']
            },
            
            // ===== CUSTOMER TUTORIALS =====
            'add-customer': {
                title: 'How to Add a New Customer',
                icon: '',
                category: 'Customer Tasks',
                color: '#f59e0b',
                steps: [
                    { action: 'Navigate to Customers', detail: 'Click the <strong> Customers</strong> tab.' },
                    { action: 'Click Add New', detail: 'Click the <strong>+ Add Customer</strong> button.' },
                    { action: 'Enter Business Name', detail: 'Type the customer\'s business name.' },
                    { action: 'Add Contact Info', detail: 'Enter contact name, phone, and email.' },
                    { action: 'Enter Delivery Address', detail: 'Add the address where orders will be delivered.' },
                    { action: 'Set Payment Terms', detail: 'Choose payment terms (Net 30, Net 15, COD, etc.).' },
                    { action: 'Save', detail: 'Click <strong>Save Customer</strong> to add them.' }
                ],
                tips: ['Customer ID is auto-generated (C001, C002, etc.)', 'Delivery address is used on invoices and pick lists', 'You can add notes for delivery instructions']
            },
            'payment-terms': {
                title: 'How to Set Payment Terms',
                icon: '',
                category: 'Customer Tasks',
                color: '#f59e0b',
                steps: [
                    { action: 'Go to Customers', detail: 'Click the <strong> Customers</strong> tab.' },
                    { action: 'Find the Customer', detail: 'Locate the customer you want to update.' },
                    { action: 'Click Edit', detail: 'Click the <strong> Edit</strong> button.' },
                    { action: 'Update Payment Terms', detail: 'Select from: <strong>COD</strong> (Cash on Delivery), <strong>Net 15</strong>, <strong>Net 30</strong>, <strong>Net 45</strong>, <strong>Net 60</strong>.' },
                    { action: 'Save', detail: 'Click <strong>Save Changes</strong>.' }
                ],
                tips: ['Payment terms determine when invoices are due', 'Net 30 = payment due 30 days from invoice date', 'COD requires payment at time of delivery']
            },
            'customer-history': {
                title: 'How to View Customer Order History',
                icon: '',
                category: 'Customer Tasks',
                color: '#f59e0b',
                steps: [
                    { action: 'Go to Customers', detail: 'Click the <strong> Customers</strong> tab.' },
                    { action: 'Find the Customer', detail: 'Locate the customer.' },
                    { action: 'Click View', detail: 'Click the <strong> View</strong> button to see details.' },
                    { action: 'Review Order History', detail: 'Scroll down to see all past invoices and their status.' },
                    { action: 'Use Customer Dashboard', detail: 'For detailed analytics, go to <strong>Reports  Customer Dashboard</strong>.' }
                ],
                tips: ['Customer Dashboard shows buying patterns and trends', 'You can see total revenue and average order size', 'Click any invoice number to view full details']
            },
            'track-balances': {
                title: 'How to Track Outstanding Balances',
                icon: '',
                category: 'Customer Tasks',
                color: '#f59e0b',
                steps: [
                    { action: 'Go to Reports', detail: 'Click the <strong> Reports</strong> tab.' },
                    { action: 'Open Accounts Receivable', detail: 'Click <strong>Accounts Receivable Report</strong>.' },
                    { action: 'Review Balances', detail: 'See all customers with outstanding balances and aging.' },
                    { action: 'Filter if Needed', detail: 'Use filters to see only overdue invoices.' },
                    { action: 'Alternative: Action Dashboard', detail: 'The <strong>Action Dashboard</strong> also shows overdue invoices requiring attention.' }
                ],
                tips: ['AR Report shows aging buckets: Current, 1-30, 31-60, 60+ days', 'Red highlights indicate seriously overdue accounts', 'Click any invoice to record a payment']
            },
            
            // ===== PURCHASE ORDER TUTORIALS =====
            'create-po': {
                title: 'How to Create a Purchase Order',
                icon: '',
                category: 'Purchase Order Tasks',
                color: '#8b5cf6',
                steps: [
                    { action: 'Navigate to Create PO', detail: 'Click the <strong> Create PO</strong> tab.' },
                    { action: 'Select Supplier', detail: 'Choose the supplier from the dropdown. Their items will load automatically.' },
                    { action: 'Set Order Date', detail: 'Select the PO date (defaults to today).' },
                    { action: 'Add Items', detail: 'For each item you want to order, enter the quantity in the Qty field.' },
                    { action: 'Review Totals', detail: 'Check the line totals and PO total at the bottom.' },
                    { action: 'Add Notes (Optional)', detail: 'Add any special instructions in the Notes field.' },
                    { action: 'Submit PO', detail: 'Click <strong>Submit Purchase Order</strong> to create it.' }
                ],
                tips: ['Only items with quantity > 0 are included', 'PO numbers are auto-generated (PO-0001, etc.)', 'You can print or email the PO after creating it']
            },
            'receive-shipment': {
                title: 'How to Receive a Shipment (Full)',
                icon: '',
                category: 'Purchase Order Tasks',
                color: '#8b5cf6',
                steps: [
                    { action: 'Go to Purchases', detail: 'Click the <strong> Purchases</strong> tab.' },
                    { action: 'Find the PO', detail: 'Locate the purchase order (use search or scroll).' },
                    { action: 'Click View', detail: 'Click the <strong> View</strong> button to open PO details.' },
                    { action: 'Click Receive PO', detail: 'Click the <strong> Receive PO</strong> button.' },
                    { action: 'Confirm Full Receipt', detail: 'If you received everything, click <strong>Receive Full Shipment</strong>.' },
                    { action: 'Verify', detail: 'Inventory is automatically updated for all items on the PO.' }
                ],
                tips: ['Receiving updates inventory immediately', 'PO status changes from "Ordered" to "Received"', 'If items are missing, use Partial Receive instead']
            },
            'partial-receive': {
                title: 'How to Receive Partial Shipments',
                icon: '',
                category: 'Purchase Order Tasks',
                color: '#8b5cf6',
                steps: [
                    { action: 'Go to Purchases', detail: 'Click the <strong> Purchases</strong> tab.' },
                    { action: 'Find the PO', detail: 'Locate the purchase order.' },
                    { action: 'Click View', detail: 'Click <strong> View</strong> to open PO details.' },
                    { action: 'Click Receive PO', detail: 'Click the <strong> Receive PO</strong> button.' },
                    { action: 'Enter Received Quantities', detail: 'For each item, enter how many you actually received.' },
                    { action: 'Save Partial Receipt', detail: 'Click <strong>Save Partial Receipt</strong>.' },
                    { action: 'Repeat as Needed', detail: 'When more items arrive, repeat the process until fully received.' }
                ],
                tips: ['PO status shows "Partial" until fully received', 'Each partial receipt updates inventory', 'You can see Ordered vs Received quantities on the PO']
            },
            'pay-supplier': {
                title: 'How to Record Payment to Supplier',
                icon: '',
                category: 'Purchase Order Tasks',
                color: '#8b5cf6',
                steps: [
                    { action: 'Go to Purchases', detail: 'Click the <strong> Purchases</strong> tab.' },
                    { action: 'Find the PO', detail: 'Locate the purchase order you\'re paying.' },
                    { action: 'Click View', detail: 'Click <strong> View</strong> to open PO details.' },
                    { action: 'Click Record Payment', detail: 'Click the <strong> Record Payment</strong> button.' },
                    { action: 'Enter Amount', detail: 'Enter the payment amount (can be partial or full).' },
                    { action: 'Add Payment Date', detail: 'Select the date payment was made.' },
                    { action: 'Save Payment', detail: 'Click <strong>Save Payment</strong>.' }
                ],
                tips: ['Partial payments are supported', 'Payment status updates automatically (Unpaid  Partial  Paid)', 'Use Accounts Payable report to track what you owe']
            },
            'print-po': {
                title: 'How to Print/Email a PO',
                icon: '',
                category: 'Purchase Order Tasks',
                color: '#8b5cf6',
                steps: [
                    { action: 'Go to Purchases', detail: 'Click the <strong> Purchases</strong> tab.' },
                    { action: 'Find the PO', detail: 'Locate the purchase order.' },
                    { action: 'Click View', detail: 'Click <strong> View</strong> to open PO details.' },
                    { action: 'Click Print', detail: 'Click the <strong> Print PO</strong> button.' },
                    { action: 'Print or Save as PDF', detail: 'Use your browser\'s print dialog. Choose a printer or "Save as PDF".' },
                    { action: 'To Email', detail: 'Click <strong> Email</strong> to generate an email with the PO attached.' }
                ],
                tips: ['Print preview shows a clean, professional format', 'The current theme colors are used in the printout', 'You can email directly to the supplier if their email is on file']
            },
            
            // ===== SALES & INVOICE TUTORIALS =====
            'create-invoice': {
                title: 'How to Create a Sales Order/Invoice',
                icon: '',
                category: 'Sales & Invoice Tasks',
                color: '#ec4899',
                steps: [
                    { action: 'Navigate to Sales', detail: 'Click the <strong> Sales</strong> tab.' },
                    { action: 'Click Create Invoice', detail: 'Click the <strong>+ Create Invoice</strong> button.' },
                    { action: 'Select Customer', detail: 'Choose the customer from the dropdown.' },
                    { action: 'Set Invoice Date', detail: 'Select the date (defaults to today). Due date auto-calculates from payment terms.' },
                    { action: 'Add Items', detail: 'Use the item picker or dropdown to add products.' },
                    { action: 'Enter Quantities', detail: 'Set the quantity for each item.' },
                    { action: 'Review Totals', detail: 'Check line totals and invoice total.' },
                    { action: 'Save Invoice', detail: 'Click <strong>Save Invoice</strong> to create it.' }
                ],
                tips: ['Invoice numbers are auto-generated (INV-0001, etc.)', 'Inventory is automatically reduced when invoice is saved', 'You can add notes or special instructions']
            },
            'item-picker': {
                title: 'How to Use the Quick Item Picker',
                icon: '',
                category: 'Sales & Invoice Tasks',
                color: '#ec4899',
                steps: [
                    { action: 'Start Creating Invoice', detail: 'Begin a new invoice from the Sales tab.' },
                    { action: 'Click Quick Pick', detail: 'Click the <strong> Quick Pick</strong> button.' },
                    { action: 'Browse or Search', detail: 'Items are grouped by supplier. Use search to filter.' },
                    { action: 'Enter Quantities', detail: 'Type quantities directly in the picker grid.' },
                    { action: 'Click Add Selected', detail: 'Click <strong>Add Selected Items</strong> to add them to the invoice.' },
                    { action: 'Continue', detail: 'You can use the picker multiple times to add more items.' }
                ],
                tips: ['Quick picker shows current stock levels', 'Items with zero stock are highlighted', 'Great for quickly building large orders']
            },
            'print-invoice': {
                title: 'How to Print an Invoice',
                icon: '',
                category: 'Sales & Invoice Tasks',
                color: '#ec4899',
                steps: [
                    { action: 'Go to Sales', detail: 'Click the <strong> Sales</strong> tab.' },
                    { action: 'Find the Invoice', detail: 'Locate the invoice to print.' },
                    { action: 'Click View', detail: 'Click <strong> View</strong> to open invoice details.' },
                    { action: 'Click Print', detail: 'Click the <strong> Print Invoice</strong> button.' },
                    { action: 'Print or Save PDF', detail: 'In the print dialog, select your printer or "Save as PDF".' }
                ],
                tips: ['Invoice uses your current theme colors', 'Company info and customer address are included', 'PDF is great for emailing to customers']
            },
            'record-payment': {
                title: 'How to Record Customer Payment',
                icon: '',
                category: 'Sales & Invoice Tasks',
                color: '#ec4899',
                steps: [
                    { action: 'Go to Sales', detail: 'Click the <strong> Sales</strong> tab.' },
                    { action: 'Find the Invoice', detail: 'Locate the invoice being paid.' },
                    { action: 'Click View', detail: 'Click <strong> View</strong> to open invoice details.' },
                    { action: 'Click Record Payment', detail: 'Click the <strong> Record Payment</strong> button.' },
                    { action: 'Enter Amount', detail: 'Enter the payment amount received.' },
                    { action: 'Set Payment Date', detail: 'Select the date payment was received.' },
                    { action: 'Save Payment', detail: 'Click <strong>Save Payment</strong>.' }
                ],
                tips: ['Partial payments are supported', 'Status updates: Unpaid  Partial  Paid', 'Payment history is tracked for each invoice']
            },
            'pick-list': {
                title: 'How to Generate a Pick List',
                icon: '',
                category: 'Sales & Invoice Tasks',
                color: '#ec4899',
                steps: [
                    { action: 'Go to Reports', detail: 'Click the <strong> Reports</strong> tab.' },
                    { action: 'Click Pick List', detail: 'Find and click the <strong>Pick List Report</strong> button.' },
                    { action: 'Select Date Range', detail: 'Choose the dates for orders to include.' },
                    { action: 'Generate Report', detail: 'Click <strong>Generate</strong> to create the pick list.' },
                    { action: 'Print', detail: 'Click <strong> Print</strong> to print for warehouse use.' }
                ],
                tips: ['Pick list shows all items needed for pending deliveries', 'Items are grouped for efficient picking', 'Use this to prepare orders for delivery runs']
            },
            'dormant-customers': {
                title: 'How to Win Back Dormant Customers',
                icon: '',
                category: 'Sales & Invoice Tasks',
                color: '#f59e0b',
                steps: [
                    { action: 'Go to Reports', detail: 'Click the <strong> Reports</strong> tab.' },
                    { action: 'Find Sales Reports', detail: 'Look in the <strong>Sales Reports</strong> section.' },
                    { action: 'Click Dormant Customers', detail: 'Click the <strong> Dormant Customers</strong> report button.' },
                    { action: 'Set Dormancy Threshold', detail: 'Choose how long since last order (e.g., 30 days, 90 days).' },
                    { action: 'Choose Sort Order', detail: 'Sort by Most Dormant, City (for route planning), or Highest Value.' },
                    { action: 'Generate Report', detail: 'Click <strong>Generate</strong> to see your dormant customers.' },
                    { action: 'Review Customer Cards', detail: 'Each card shows contact info, address, buying history, and their last order items.' },
                    { action: 'Take Action', detail: 'Click <strong> New Order</strong> to start a new order for that customer.' }
                ],
                tips: [
                    'Review their last order items before calling - know what they typically buy',
                    'Sort by City to plan efficient in-person visit routes',
                    'High-value customers ($500+ lifetime) should be priority contacts',
                    'Check their order frequency - if they usually order every 14 days and it\'s been 45, they\'re 3x overdue!',
                    'Address and phone are included for sales calls or delivery visits'
                ]
            },
            
            // ===== INVENTORY TUTORIALS =====
            'view-inventory': {
                title: 'How to View Current Inventory Levels',
                icon: '',
                category: 'Inventory Tasks',
                color: '#64748b',
                steps: [
                    { action: 'Go to Inventory', detail: 'Click the <strong> Inventory</strong> tab.' },
                    { action: 'View All Items', detail: 'See all items with current quantities, values, and status.' },
                    { action: 'Use Search/Filter', detail: 'Search by name/SKU or filter by supplier.' },
                    { action: 'Check Status Colors', detail: '<span style="color: green;"></span> Green = Good stock, <span style="color: orange;"></span> Yellow = Low, <span style="color: red;"></span> Red = Critical/Out.' },
                    { action: 'View Details', detail: 'Click any item for detailed history and adjustments.' }
                ],
                tips: ['Total inventory value is shown at the top', 'Low stock items appear first when filtered', 'Click column headers to sort']
            },
            'adjust-inventory': {
                title: 'How to Make Manual Adjustments',
                icon: '',
                category: 'Inventory Tasks',
                color: '#64748b',
                steps: [
                    { action: 'Go to Inventory', detail: 'Click the <strong> Inventory</strong> tab.' },
                    { action: 'Find the Item', detail: 'Locate the item to adjust.' },
                    { action: 'Click Adjust', detail: 'Click the <strong></strong> or <strong>Adjust</strong> button.' },
                    { action: 'Enter Adjustment', detail: 'Enter the quantity change. Use negative for decreases (e.g., -5 for damage).' },
                    { action: 'Select Reason', detail: 'Choose a reason: Damage, Shrinkage, Count Correction, Return, Other.' },
                    { action: 'Add Notes', detail: 'Optionally add notes explaining the adjustment.' },
                    { action: 'Save', detail: 'Click <strong>Save Adjustment</strong>.' }
                ],
                tips: ['All adjustments are logged with timestamps', 'Use "Count Correction" after physical inventory counts', 'Audit trail is preserved for accountability']
            },
            'low-stock': {
                title: 'How to Track Low Stock Items',
                icon: '',
                category: 'Inventory Tasks',
                color: '#64748b',
                steps: [
                    { action: 'Check Action Dashboard', detail: 'Go to <strong>Reports  Action Dashboard</strong> to see items needing reorder.' },
                    { action: 'Or Use Inventory Tab', detail: 'Go to <strong>Inventory</strong> and look for red/yellow status indicators.' },
                    { action: 'Or Use Inventory Flow', detail: 'Go to <strong>Reports  Inventory Reports  Inventory Flow Dashboard</strong> for detailed alerts.' },
                    { action: 'Review Reorder Points', detail: 'Items below their reorder point are flagged.' },
                    { action: 'Create PO', detail: 'Click through to create a purchase order for needed items.' }
                ],
                tips: ['Set appropriate reorder points for each item', 'Consider lead time when setting reorder levels', 'Action Dashboard prioritizes what needs attention']
            },
            'inventory-flow': {
                title: 'How to Use Inventory Flow Dashboard',
                icon: '',
                category: 'Inventory Tasks',
                color: '#64748b',
                steps: [
                    { action: 'Go to Reports', detail: 'Click the <strong> Reports</strong> tab.' },
                    { action: 'Find Inventory Reports', detail: 'Scroll to the Inventory Reports section.' },
                    { action: 'Click Inventory Flow Dashboard', detail: 'Click the large <strong> Inventory Flow Dashboard</strong> button.' },
                    { action: 'Review Alerts', detail: 'See critical alerts, low stock warnings, and pending orders.' },
                    { action: 'Check Summary Metrics', detail: 'View total items, stock value, items on backorder, and pending POs.' },
                    { action: 'Take Action', detail: 'Click on any item or order to take action directly.' }
                ],
                tips: ['Dashboard refreshes when opened', 'Critical items are highlighted in red', 'Shows both inbound (POs) and outbound (sales) flow']
            }
        };
        
        function showTutorial(tutorialId) {
            const tutorial = tutorialContent[tutorialId];
            if (!tutorial) {
                alert('Tutorial not found');
                return;
            }
            
            // Build the tutorial HTML
            let stepsHtml = tutorial.steps.map((step, index) => `
                <div style="display: flex; gap: 15px; align-items: flex-start; margin-bottom: 20px;">
                    <div style="background: ${tutorial.color}; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; font-size: 16px;">${index + 1}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">${step.action}</div>
                        <div style="color: #6b7280; line-height: 1.5;">${step.detail}</div>
                    </div>
                </div>
            `).join('');
            
            let tipsHtml = tutorial.tips.map(tip => `
                <div style="display: flex; gap: 10px; align-items: flex-start; margin-bottom: 8px;">
                    <span style="color: ${tutorial.color};"></span>
                    <span style="color: #374151;">${tip}</span>
                </div>
            `).join('');
            
            const modalHtml = `
                <div id="tutorialModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10001; overflow-y: auto; padding: 20px 0;">
                    <div style="max-width: 700px; margin: 20px auto; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); overflow: hidden;">
                        <!-- Header -->
                        <div style="background: linear-gradient(135deg, ${tutorial.color} 0%, ${tutorial.color}dd 100%); color: white; padding: 25px 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">${tutorial.category}</div>
                                    <h2 style="margin: 0; font-size: 24px; display: flex; align-items: center; gap: 12px;">
                                        <span style="font-size: 32px;">${tutorial.icon}</span>
                                        ${tutorial.title}
                                    </h2>
                                </div>
                                <button onclick="closeTutorial()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;"></button>
                            </div>
                        </div>
                        
                        <!-- Steps -->
                        <div style="padding: 30px;">
                            <h3 style="margin: 0 0 25px 0; color: #1f2937; font-size: 18px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;"> Step-by-Step Instructions</h3>
                            ${stepsHtml}
                        </div>
                        
                        <!-- Tips -->
                        <div style="padding: 25px 30px; background: #f8fafc; border-top: 1px solid #e5e7eb;">
                            <h4 style="margin: 0 0 15px 0; color: #374151; font-size: 16px;"> Pro Tips</h4>
                            ${tipsHtml}
                        </div>
                        
                        <!-- Footer -->
                        <div style="padding: 20px 30px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <button onclick="closeTutorial()" style="background: #e5e7eb; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; color: #374151;">Close</button>
                            <button onclick="closeTutorial(); scrollToGuideSection('how-to');" style="background: ${tutorial.color}; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; color: white;"> Back to All Guides</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existing = document.getElementById('tutorialModal');
            if (existing) existing.remove();
            
            // Add new modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.body.style.overflow = 'hidden';
            
            // Close on backdrop click
            document.getElementById('tutorialModal').addEventListener('click', function(e) {
                if (e.target === this) closeTutorial();
            });
        }
        
        function closeTutorial() {
            const modal = document.getElementById('tutorialModal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }
        
        function showGuideSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.guide-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            const targetSection = document.getElementById('guide-' + sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // Update tab styles
            document.querySelectorAll('.guide-tab').forEach(tab => {
                tab.style.color = '#666';
                tab.style.borderBottom = '3px solid transparent';
                tab.style.background = 'none';
            });
            
            // Highlight active tab (find by checking onclick)
            document.querySelectorAll('.guide-tab').forEach(tab => {
                if (tab.onclick && tab.onclick.toString().includes(`'${sectionId}'`)) {
                    tab.style.color = '#667eea';
                    tab.style.borderBottom = '3px solid #667eea';
                    tab.style.background = 'white';
                }
            });
        }
        
        // Close guide modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('howToGuideModal');
            if (event.target === modal) {
                closeHowToGuide();
            }
        });
        
        // ==================== BULK IMPORT/EXPORT FUNCTIONS ====================
        
        // Store parsed items temporarily for commit
        let pendingItemsUpload = null;
        let pendingUploadMode = null;

        async function downloadItemsReport() {
            if (!cachedItems || cachedItems.length === 0) {
                alert('No items to download. Please load items first.');
                return;
            }

            // Create printable HTML report
            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Items Report - Nowak Distributing</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { text-align: center; color: #333; }
                        .important-notice {
                            background: #FFE4E1; /* Light pink background */
                            color: #8B0000; /* Dark red text for contrast */
                            padding: 20px 25px;
                            margin: 25px 0;
                            border-radius: 12px;
                            border-left: 6px solid #DC143C; /* Crimson left border */
                            box-shadow: 0 4px 15px rgba(220, 20, 60, 0.2);
                            font-size: 16px;
                            font-weight: 600;
                        }
                        .important-notice h2 {
                            margin: 0 0 12px 0;
                            font-size: 22px;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        .important-notice p {
                            margin: 8px 0;
                            line-height: 1.6;
                            font-size: 15px;
                        }
                        .important-notice ul {
                            margin: 12px 0;
                            padding-left: 25px;
                        }
                        .important-notice li {
                            margin: 6px 0;
                            line-height: 1.5;
                        }
                        .important-notice .highlight {
                            background: rgba(255, 255, 255, 0.2);
                            padding: 2px 8px;
                            border-radius: 4px;
                            font-weight: 700;
                        }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11px; }
                        th { background: #667eea; color: white; padding: 8px; text-align: left; border: 1px solid #ddd; }
                        td { padding: 6px; border: 1px solid #ddd; }
                        tr:nth-child(even) { background: #f9f9f9; }
                        .footer { margin-top: 30px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; }
                        .action-buttons { 
                            position: fixed; 
                            top: 10px; 
                            right: 10px; 
                            z-index: 1000; 
                            display: flex; 
                            gap: 10px; 
                        }
                        .action-btn { 
                            padding: 10px 20px; 
                            border: none; 
                            border-radius: 8px; 
                            cursor: pointer; 
                            font-size: 14px; 
                            font-weight: 600; 
                            transition: all 0.2s; 
                            box-shadow: 0 2px 8px rgba(0,0,0,0.15); 
                        }
                        .print-btn { 
                            background: #28a745; 
                            color: white; 
                        }
                        .print-btn:hover { 
                            background: #218838; 
                            transform: translateY(-2px); 
                            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
                        }
                        .close-btn { 
                            background: #f44336; 
                            color: white; 
                        }
                        .close-btn:hover { 
                            background: #d32f2f; 
                            transform: translateY(-2px); 
                            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
                        }
                        @media print {
                            .action-buttons { display: none; }
                            .important-notice { 
                                page-break-inside: avoid; 
                                page-break-after: auto;
                            }
                        }
                    </style>
                </head>
                <body>
                    <!-- Action Buttons at Top -->
                    <div class="action-buttons">
                        <button class="action-btn print-btn" onclick="window.print()"> Print</button>
                        <button class="action-btn close-btn" onclick="window.close()"> Close</button>
                    </div>

                    <h1>Nowak Distributing - Items Report</h1>
                    <p style="text-align: center; color: #666;">Generated: ${new Date().toLocaleString()} | Total Items: ${cachedItems.length}</p>
                    
                    <!-- PROMINENT NOTICE AT TOP -->
                    <div class="important-notice">
                        <h2> CRITICAL: DO NOT MODIFY ITEM_ID COLUMN!</h2>
                        <p>When editing this report in Excel:</p>
                        <ul>
                            <li> <span class="highlight">DO</span> edit: Prices, Quantities, SKUs, Descriptions, etc.</li>
                            <li> <span class="highlight">DO NOT</span> edit: Item_ID column (first column)</li>
                            <li> <span class="highlight">DO NOT</span> delete: Item_ID column</li>
                            <li> <span class="highlight">DO NOT</span> change: Item_ID values</li>
                        </ul>
                        <p><strong> Item_ID is the SYSTEM KEY that matches rows to items in your database.</strong></p>
                        <p><strong> Changing Item_ID will cause data corruption!</strong></p>
                        <p style="margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(255,255,255,0.3);">
                            <strong>REMINDER:</strong> Click  Print  Save as PDF  Upload to ilovepdf.com/pdf_to_excel  Edit in Excel  Upload back
                        </p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Item_ID</th>
                                <th>SKU</th>
                                <th>Description</th>
                                <th>Supplier_ID</th>
                                <th>Cost</th>
                                <th>Sell_Price</th>
                                <th>Qty_On_Hand</th>
                                <th>Qty_On_Backorder</th>
                                <th>Reorder_Point</th>
                                <th>Package_Cost</th>
                                <th>Units_Per_Package</th>
                                <th>Qty_On_Order</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cachedItems.map(item => `
                                <tr>
                                    <td>${item.Item_ID || ''}</td>
                                    <td>${item.SKU || ''}</td>
                                    <td>${item.Item_Description || ''}</td>
                                    <td>${item.Supplier_ID || ''}</td>
                                    <td>${parseFloat(item.Cost || 0).toFixed(2)}</td>
                                    <td>${parseFloat(item.Sell_Price || 0).toFixed(2)}</td>
                                    <td>${parseInt(item.Qty_On_Hand || 0)}</td>
                                    <td>${parseInt(item.Qty_On_Backorder || 0)}</td>
                                    <td>${parseInt(item.Reorder_Point || 0)}</td>
                                    <td>${parseFloat(item.Package_Cost || 0).toFixed(2)}</td>
                                    <td>${parseInt(item.Units_Per_Package || 0)}</td>
                                    <td>${parseInt(item.Qty_On_Order || 0)}</td>
                                    <td>${item.Status || 'Active'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <h3>How to Use This Report:</h3>
                        <ol>
                            <li>Click <strong> Print</strong> button above and save as PDF</li>
                            <li>Upload PDF to <strong>ilovepdf.com/pdf_to_excel</strong></li>
                            <li>Download the Excel file</li>
                            <li>Edit prices, quantities, or other fields</li>
                            <li><strong>DO NOT modify Item_ID column!</strong></li>
                            <li>Upload back via the "Upload Items" button</li>
                        </ol>
                        <p><strong> Important:</strong> Always backup before uploading!</p>
                    </div>
                </body>
                </html>
            `;

            // Open in new window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            printWindow.focus();
        }

        function openUploadItemsModal() {
            document.getElementById('uploadItemsModal').style.display = 'block';
            document.getElementById('uploadItemsFile').value = '';
            document.getElementById('uploadItemsPreview').style.display = 'none';
            document.body.style.overflow = 'hidden';
        }

        function closeUploadItemsModal() {
            document.getElementById('uploadItemsModal').style.display = 'none';
            document.body.style.overflow = '';
            pendingItemsUpload = null;
            pendingUploadMode = null;
        }

        async function previewItemsUpload() {
            const fileInput = document.getElementById('uploadItemsFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to upload');
                return;
            }

            const uploadMode = document.querySelector('input[name="uploadMode"]:checked').value;
            
            try {
                showStatus('itemsStatus', ' Processing file and generating preview...', 'info');

                // Read and parse the file
                const uploadedItems = await parseUploadedFile(file);
                
                if (!uploadedItems || uploadedItems.length === 0) {
                    alert('No valid items found in file');
                    return;
                }

                // Store for later commit
                pendingItemsUpload = uploadedItems;
                pendingUploadMode = uploadMode;

                // Generate comparison report
                const comparison = compareItemsForPreview(uploadedItems, uploadMode);
                
                // Display preview
                displayPreviewReport(comparison);
                
                // Show the preview section
                document.getElementById('uploadItemsPreview').style.display = 'block';
                
                // Scroll to preview
                document.getElementById('uploadItemsPreview').scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                showStatus('itemsStatus', ' Preview generated - Review changes below', 'success');

            } catch (error) {
                showStatus('itemsStatus', ' Error processing file: ' + error.message, 'error');
            }
        }

        function compareItemsForPreview(uploadedItems, mode) {
            const existing = cachedItems || [];
            const comparison = {
                toAdd: [],
                toUpdate: [],
                noChange: [],
                notInUpload: []
            };

            // Create map of existing items by Item_ID
            const existingMap = {};
            existing.forEach(item => {
                if (item.Item_ID) {
                    existingMap[item.Item_ID] = item;
                }
            });

            // Compare uploaded items
            uploadedItems.forEach(uploadItem => {
                const itemId = uploadItem.Item_ID;
                
                // Check if this is a new item
                if (!itemId || itemId === 'NEW' || itemId === '' || !existingMap[itemId]) {
                    comparison.toAdd.push({
                        item: uploadItem,
                        isNew: true
                    });
                } else {
                    // Existing item - check for changes
                    const existingItem = existingMap[itemId];
                    const changes = detectChanges(existingItem, uploadItem);
                    
                    if (changes.length > 0) {
                        comparison.toUpdate.push({
                            itemId: itemId,
                            before: existingItem,
                            after: uploadItem,
                            changes: changes
                        });
                    } else {
                        comparison.noChange.push({
                            itemId: itemId,
                            item: existingItem
                        });
                    }
                    
                    // Mark as seen
                    existingMap[itemId].seen = true;
                }
            });

            // Find items not in upload (only matters for Full Refresh)
            if (mode === 'full-refresh') {
                existing.forEach(item => {
                    if (item.Item_ID && !item.seen) {
                        comparison.notInUpload.push(item);
                    }
                });
            }

            return comparison;
        }

        function detectChanges(before, after) {
            const changes = [];
            const fieldsToCheck = [
                { key: 'SKU', label: 'SKU' },
                { key: 'Item_Description', label: 'Description' },
                { key: 'Supplier_ID', label: 'Supplier' },
                { key: 'Cost', label: 'Cost', isNumber: true },
                { key: 'Sell_Price', label: 'Sell Price', isNumber: true },
                { key: 'Qty_On_Hand', label: 'Qty On Hand', isNumber: true },
                { key: 'Reorder_Point', label: 'Reorder Point', isNumber: true },
                { key: 'Package_Cost', label: 'Package Cost', isNumber: true },
                { key: 'Units_Per_Package', label: 'Units/Package', isNumber: true },
                { key: 'Qty_On_Order', label: 'Qty On Order', isNumber: true },
                { key: 'Status', label: 'Status' }
            ];

            fieldsToCheck.forEach(field => {
                let beforeVal = before[field.key];
                let afterVal = after[field.key];

                // Normalize for comparison
                if (field.isNumber) {
                    beforeVal = parseFloat(beforeVal) || 0;
                    afterVal = parseFloat(afterVal) || 0;
                } else {
                    beforeVal = String(beforeVal || '').trim();
                    afterVal = String(afterVal || '').trim();
                }

                if (beforeVal !== afterVal) {
                    changes.push({
                        field: field.label,
                        before: beforeVal,
                        after: afterVal
                    });
                }
            });

            return changes;
        }

        function displayPreviewReport(comparison) {
            // Summary stats
            const summaryHtml = `
                <div style="padding: 12px; background: #e8f5e9; border-radius: 6px; text-align: center; border-left: 4px solid #4caf50;">
                    <div style="font-size: 20px; font-weight: bold; color: #2e7d32;">${comparison.toAdd.length}</div>
                    <div style="font-size: 11px; color: #666;">To Add</div>
                </div>
                <div style="padding: 12px; background: #fff3e0; border-radius: 6px; text-align: center; border-left: 4px solid #ff9800;">
                    <div style="font-size: 20px; font-weight: bold; color: #e65100;">${comparison.toUpdate.length}</div>
                    <div style="font-size: 11px; color: #666;">To Update</div>
                </div>
                ${pendingUploadMode === 'full-refresh' ? `
                <div style="padding: 12px; background: #ffebee; border-radius: 6px; text-align: center; border-left: 4px solid #f44336;">
                    <div style="font-size: 20px; font-weight: bold; color: #c62828;">${comparison.notInUpload.length}</div>
                    <div style="font-size: 11px; color: #666;">To Delete</div>
                </div>
                ` : ''}
                <div style="padding: 12px; background: #f5f5f5; border-radius: 6px; text-align: center; border-left: 4px solid #9e9e9e;">
                    <div style="font-size: 20px; font-weight: bold; color: #616161;">${comparison.noChange.length}</div>
                    <div style="font-size: 11px; color: #666;">No Change</div>
                </div>
            `;
            document.getElementById('uploadItemsSummary').innerHTML = summaryHtml;

            // Detailed changes
            let detailHtml = '';

            // Items to ADD
            if (comparison.toAdd.length > 0) {
                detailHtml += `<div style="margin-bottom: 15px;"><h4 style="background: #4caf50; color: white; padding: 8px; border-radius: 6px 6px 0 0; margin: 0;"> ${comparison.toAdd.length} Items to ADD</h4><div style="background: white; padding: 12px; border: 2px solid #4caf50; border-radius: 0 0 6px 6px;">`;
                
                comparison.toAdd.slice(0, 10).forEach(entry => {
                    const item = entry.item;
                    detailHtml += `<div style="padding: 8px; margin-bottom: 8px; background: #e8f5e9; border-radius: 4px; border-left: 4px solid #4caf50; font-size: 12px;"><strong>${item.SKU || 'No SKU'}</strong> - ${item.Item_Description || 'No Description'} | Cost: ${formatMoney(parseFloat(item.Cost || 0))} | Sell: ${formatMoney(parseFloat(item.Sell_Price || 0))}</div>`;
                });
                
                if (comparison.toAdd.length > 10) {
                    detailHtml += `<div style="padding: 8px; color: #666; font-size: 12px;">...and ${comparison.toAdd.length - 10} more</div>`;
                }
                
                detailHtml += `</div></div>`;
            }

            // Items to UPDATE
            if (comparison.toUpdate.length > 0) {
                detailHtml += `<div style="margin-bottom: 15px;"><h4 style="background: #ff9800; color: white; padding: 8px; border-radius: 6px 6px 0 0; margin: 0;"> ${comparison.toUpdate.length} Items to UPDATE</h4><div style="background: white; padding: 12px; border: 2px solid #ff9800; border-radius: 0 0 6px 6px;">`;
                
                comparison.toUpdate.slice(0, 10).forEach(entry => {
                    detailHtml += `<div style="padding: 8px; margin-bottom: 10px; background: #fff3e0; border-radius: 4px; border-left: 4px solid #ff9800; font-size: 12px;"><strong>${entry.before.SKU || entry.itemId}</strong> - ${entry.before.Item_Description || 'No Description'}<br>${entry.changes.map(c => `<span style="color: #e65100;">${c.field}:</span> <span style="text-decoration: line-through;">${c.before}</span>  <strong>${c.after}</strong>`).join(' | ')}</div>`;
                });
                
                if (comparison.toUpdate.length > 10) {
                    detailHtml += `<div style="padding: 8px; color: #666; font-size: 12px;">...and ${comparison.toUpdate.length - 10} more</div>`;
                }
                
                detailHtml += `</div></div>`;
            }

            // Items to DELETE (Full Refresh only)
            if (pendingUploadMode === 'full-refresh' && comparison.notInUpload.length > 0) {
                detailHtml += `<div style="margin-bottom: 15px;"><h4 style="background: #f44336; color: white; padding: 8px; border-radius: 6px 6px 0 0; margin: 0;"> ${comparison.notInUpload.length} Items to DELETE</h4><div style="background: white; padding: 12px; border: 2px solid #f44336; border-radius: 0 0 6px 6px;">`;
                
                comparison.notInUpload.slice(0, 20).forEach(item => {
                    detailHtml += `<div style="padding: 6px; margin-bottom: 6px; background: #ffebee; border-radius: 4px; border-left: 4px solid #f44336; font-size: 12px;"><strong>${item.SKU || item.Item_ID}</strong> - ${item.Item_Description || 'No Description'}</div>`;
                });
                
                if (comparison.notInUpload.length > 20) {
                    detailHtml += `<div style="padding: 8px; color: #666; font-size: 12px;">...and ${comparison.notInUpload.length - 20} more</div>`;
                }
                
                detailHtml += `</div></div>`;
            }

            document.getElementById('uploadItemsPreviewContent').innerHTML = detailHtml || '<p>No changes detected</p>';
        }

        async function commitItemsUpload() {
            if (!pendingItemsUpload) {
                alert('No upload pending');
                return;
            }

            // Final confirmation for Full Refresh
            if (pendingUploadMode === 'full-refresh') {
                if (!confirm(' FINAL CONFIRMATION: This will DELETE ALL existing items and replace with the uploaded file.\n\nAre you ABSOLUTELY SURE?')) {
                    return;
                }
                const finalConfirm = prompt('Type YES (in capital letters) to proceed with FULL REFRESH:');
                if (finalConfirm !== 'YES') {
                    alert('Upload cancelled');
                    return;
                }
            }

            try {
                showStatus('itemsStatus', ' Committing changes to database...', 'info');

                // Send to backend
                const result = await apiCall('bulkUpdateItems', {
                    items: pendingItemsUpload,
                    mode: pendingUploadMode
                });

                if (result && result.status === 'success') {
                    showStatus('itemsStatus', ` Upload complete! ${result.added || 0} added, ${result.updated || 0} updated, ${result.deleted || 0} deleted`, 'success');
                    
                    // Clear pending upload
                    pendingItemsUpload = null;
                    pendingUploadMode = null;
                    
                    closeUploadItemsModal();
                    await loadItems();
                } else {
                    showStatus('itemsStatus', ' Upload failed: ' + (result?.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                showStatus('itemsStatus', ' Error committing changes: ' + error.message, 'error');
            }
        }

        function cancelPreview() {
            // Clear pending upload
            pendingItemsUpload = null;
            pendingUploadMode = null;
            
            // Hide preview
            document.getElementById('uploadItemsPreview').style.display = 'none';
            
            // Reset file input
            document.getElementById('uploadItemsFile').value = '';
            
            showStatus('itemsStatus', 'Upload cancelled', 'info');
        }

        async function parseUploadedFile(file) {
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.csv')) {
                // Parse CSV
                const text = await file.text();
                return parseCSV(text);
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                // Parse Excel
                await loadSheetJS();
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                // Normalize column names
                return jsonData.map(row => ({
                    Item_ID: row.Item_ID || row.item_id || '',
                    SKU: row.SKU || row.sku || '',
                    Item_Description: row.Item_Description || row.Description || row.description || '',
                    Supplier_ID: row.Supplier_ID || row.supplier_id || '',
                    Cost: parseFloat(row.Cost || row.cost || 0),
                    Sell_Price: parseFloat(row.Sell_Price || row.Unit_Sell_Price || row.sell_price || 0),
                    Qty_On_Hand: parseInt(row.Qty_On_Hand || row.qty_on_hand || 0),
                    Reorder_Point: parseInt(row.Reorder_Point || row.reorder_point || 0),
                    Package_Cost: parseFloat(row.Package_Cost || row.package_cost || 0),
                    Units_Per_Package: parseInt(row.Units_Per_Package || row.units_per_package || 0),
                    Qty_On_Order: parseInt(row.Qty_On_Order || row.qty_on_order || 0),
                    Status: row.Status || row.status || 'Active'
                }));
            } else {
                throw new Error('Unsupported file type. Please use .xlsx, .xls, or .csv');
            }
        }

        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const items = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const item = {};
                
                headers.forEach((header, index) => {
                    item[header] = values[index] || '';
                });
                
                // Normalize column names
                items.push({
                    Item_ID: item.Item_ID || item.item_id || '',
                    SKU: item.SKU || item.sku || '',
                    Item_Description: item.Item_Description || item.Description || '',
                    Supplier_ID: item.Supplier_ID || item.supplier_id || '',
                    Cost: parseFloat(item.Cost || item.cost || 0),
                    Sell_Price: parseFloat(item.Sell_Price || item.Unit_Sell_Price || 0),
                    Qty_On_Hand: parseInt(item.Qty_On_Hand || 0),
                    Reorder_Point: parseInt(item.Reorder_Point || 0),
                    Package_Cost: parseFloat(item.Package_Cost || 0),
                    Units_Per_Package: parseInt(item.Units_Per_Package || 0),
                    Qty_On_Order: parseInt(item.Qty_On_Order || 0),
                    Status: item.Status || 'Active'
                });
            }
            
            return items;
        }

        function loadSheetJS() {
            return new Promise((resolve, reject) => {
                if (window.XLSX) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // ==================== DESKTOP MODAL DRAG & RESIZE ====================
        // Make modals draggable and resizable on desktop only
        
        function initDesktopModalFeatures() {
            // Only enable on desktop (screen width > 768px)
            if (window.innerWidth <= 768) return;
            
            // Find all modals with inner containers
            const modals = [
                { overlay: document.getElementById('orderModal'), container: document.querySelector('#orderModal > div') },
                { overlay: document.getElementById('reportSetupModal'), container: document.querySelector('#reportSetupModal > div') },
                { overlay: document.getElementById('howToGuideModal'), container: document.querySelector('#howToGuideModal > div') },
                { overlay: document.getElementById('uploadItemsModal'), container: document.querySelector('#uploadItemsModal > div') },
                { overlay: document.getElementById('itemPickerModal'), container: document.querySelector('#itemPickerModal .item-picker-container') }
            ];
            
            modals.forEach(modal => {
                if (!modal.overlay || !modal.container) return;
                
                // Make container resizable
                if (!modal.container.classList.contains('resizable-added')) {
                    modal.container.style.resize = 'both';
                    modal.container.style.minWidth = '400px';
                    modal.container.style.minHeight = '300px';
                    modal.container.style.maxWidth = '95vw';
                    modal.container.style.maxHeight = '95vh';
                    modal.container.classList.add('resizable-added');
                }
                
                // Find header for dragging
                const header = modal.container.querySelector('[id*="Header"], .item-picker-header, h2');
                if (!header || header.classList.contains('draggable-added')) return;
                
                header.style.cursor = 'move';
                header.style.userSelect = 'none';
                header.classList.add('draggable-added');
                
                let isDragging = false;
                let currentX;
                let currentY;
                let initialX;
                let initialY;
                let xOffset = 0;
                let yOffset = 0;
                
                header.addEventListener('mousedown', dragStart);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', dragEnd);
                
                function dragStart(e) {
                    // Don't drag if clicking on a button or input
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                    
                    if (e.target === header || header.contains(e.target)) {
                        isDragging = true;
                        
                        // Get current position
                        const rect = modal.container.getBoundingClientRect();
                        
                        // If not already fixed, convert to fixed positioning
                        if (modal.container.style.position !== 'fixed') {
                            modal.container.style.position = 'fixed';
                            modal.container.style.margin = '0';
                            
                            // Preserve the current size
                            modal.container.style.width = rect.width + 'px';
                            modal.container.style.height = rect.height + 'px';
                            
                            modal.container.style.left = rect.left + 'px';
                            modal.container.style.top = rect.top + 'px';
                            
                            // Reset transform-based offsets
                            xOffset = parseInt(modal.container.style.left) || rect.left;
                            yOffset = parseInt(modal.container.style.top) || rect.top;
                        } else {
                            // Already fixed, get current offsets from left/top
                            xOffset = parseInt(modal.container.style.left) || rect.left;
                            yOffset = parseInt(modal.container.style.top) || rect.top;
                        }
                        
                        initialX = e.clientX;
                        initialY = e.clientY;
                    }
                }
                
                function drag(e) {
                    if (isDragging) {
                        e.preventDefault();
                        
                        // Calculate new position
                        const deltaX = e.clientX - initialX;
                        const deltaY = e.clientY - initialY;
                        
                        let newLeft = xOffset + deltaX;
                        let newTop = yOffset + deltaY;
                        
                        // Keep modal within viewport (with some padding)
                        const rect = modal.container.getBoundingClientRect();
                        const padding = 10;
                        const maxX = window.innerWidth - rect.width - padding;
                        const maxY = window.innerHeight - rect.height - padding;
                        
                        newLeft = Math.max(padding, Math.min(newLeft, maxX));
                        newTop = Math.max(padding, Math.min(newTop, maxY));
                        
                        // Apply position
                        modal.container.style.left = newLeft + 'px';
                        modal.container.style.top = newTop + 'px';
                    }
                }
                
                function dragEnd(e) {
                    if (isDragging) {
                        // Update offsets for next drag
                        xOffset = parseInt(modal.container.style.left) || 0;
                        yOffset = parseInt(modal.container.style.top) || 0;
                    }
                    isDragging = false;
                }
            });
        }
        
        // Initialize on page load
        window.addEventListener('load', initDesktopModalFeatures);
        
        // Re-initialize when modals are opened
        const originalDisplaySetters = {};
        ['orderModal', 'reportSetupModal', 'howToGuideModal', 'uploadItemsModal', 'itemPickerModal'].forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal) {
                // Watch for display changes
                const observer = new MutationObserver(() => {
                    if (modal.style.display !== 'none') {
                        setTimeout(initDesktopModalFeatures, 100);
                    }
                });
                observer.observe(modal, { attributes: true, attributeFilter: ['style'] });
            }
        });
    </script>
</body>
</html>
