<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Nowak's Distributing - Complete Management System v4</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .tab.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }

        .card.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8ebff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        .preview-container {
            margin-top: 20px;
            display: none;
        }

        .preview-image {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.processing {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto;
            display: block;
        }

        .data-table table {
            width: 100%;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background: #f8f9ff;
            font-weight: 600;
            color: #667eea;
            position: sticky;
            top: 0;
        }

        .data-table tr:hover {
            background: #f8f9ff;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .info-box {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .info-box h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .config-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .config-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
        }

        .save-config-btn {
            margin-top: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöö Nowak's Distributing</h1>
            <p>Complete Business Management System</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">üì§ Upload Invoice</button>
            <button class="tab" onclick="switchTab('invoices')">üìã Manage Invoices</button>
            <button class="tab" onclick="switchTab('inventory')">üì¶ Manage Inventory</button>
            <button class="tab" onclick="switchTab('sales')">üí∞ Record Sales</button>
            <button class="tab" onclick="switchTab('customers')">üë• Manage Customers</button>
            <button class="tab" onclick="switchTab('reports')">üìä Reports</button>
            <button class="tab" onclick="switchTab('config')">‚öôÔ∏è Settings</button>
        </div>

        <!-- Upload Invoice Tab -->
        <div id="upload" class="card active">
            <h2 style="margin-bottom: 20px;">Upload Supplier Invoice</h2>
            
            <div class="status" id="status"></div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÑ</div>
                <h3>Drop invoice here or click to browse</h3>
                <p style="color: #666; margin-top: 10px;">Supports PDF and image files - AI will extract all data automatically!</p>
                <input type="file" id="fileInput" class="file-input" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileSelect(event)">
            </div>

            <div class="preview-container" id="previewContainer">
                <h3 style="margin-bottom: 15px;">AI-Extracted Data - Review & Save</h3>
                <img id="previewImage" class="preview-image" alt="Invoice preview">
                
                <div class="spinner" id="spinner"></div>
                
                <form id="invoiceForm">
                    <div class="form-group">
                        <label>Supplier</label>
                        <select id="supplier" required>
                            <option value="">Select Supplier</option>
                            <option value="Brimhall Foods Company">Brimhall Foods Company (Brims)</option>
                            <option value="Better Made Snack Foods">Better Made Snack Foods</option>
                            <option value="Kim's Processing Plant">Kim's Processing Plant</option>
                        </select>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Invoice Number</label>
                            <input type="text" id="invoiceNumber" required>
                        </div>
                        <div class="form-group">
                            <label>Invoice Date</label>
                            <input type="date" id="invoiceDate" required>
                        </div>
                        <div class="form-group">
                            <label>Total Amount</label>
                            <input type="number" id="totalAmount" step="0.01" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Line Items (AI-extracted - one per line: Quantity | Product | Unit Price)</label>
                        <textarea id="lineItems" rows="8" placeholder="AI will automatically fill this with all line items from the invoice!"></textarea>
                    </div>

                    <button type="submit" class="btn">üíæ Save Invoice & Update Inventory</button>
                </form>
            </div>
        </div>

        <!-- Manage Invoices Tab -->
        <div id="invoices" class="card">
            <h2 style="margin-bottom: 20px;">Manage Supplier Invoices</h2>
            
            <div class="action-buttons">
                <button class="btn" onclick="loadInvoices()">üîÑ Refresh</button>
                <button class="btn btn-secondary" onclick="exportInvoices()">üì• Export to CSV</button>
            </div>
            
            <div id="invoicesTable"></div>
        </div>

        <!-- Manage Inventory Tab -->
        <div id="inventory" class="card">
            <h2 style="margin-bottom: 20px;">Manage Inventory</h2>
            
            <div class="action-buttons">
                <button class="btn" onclick="loadInventory()">üîÑ Refresh</button>
                <button class="btn btn-success" onclick="showAddProductModal()">‚ûï Add Product Manually</button>
                <button class="btn btn-secondary" onclick="exportInventory()">üì• Export to CSV</button>
            </div>
            
            <div id="inventoryTable"></div>
        </div>

        <!-- Record Sales Tab -->
        <div id="sales" class="card">
            <h2 style="margin-bottom: 20px;">Record Sales</h2>
            
            <div class="info-box">
                <h3>üí° Quick Sale Entry</h3>
                <p>Record customer sales here - inventory will automatically decrease!</p>
            </div>

            <form id="salesForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Customer</label>
                        <select id="saleCustomer" required>
                            <option value="">Select Customer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sale Date</label>
                        <input type="date" id="saleDate" required>
                    </div>
                    <div class="form-group">
                        <label>Payment Method</label>
                        <select id="paymentMethod" required>
                            <option value="Cash">Cash</option>
                            <option value="Credit">Credit</option>
                            <option value="Terms">Terms (Net 30)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Products Sold (one per line: Quantity | Product | Sale Price)</label>
                    <textarea id="saleItems" rows="6" placeholder="Example:&#10;24 | Lay's Classic Chips 1oz | 1.25&#10;12 | Doritos Nacho 2oz | 1.99" required></textarea>
                </div>

                <button type="submit" class="btn">üí∞ Record Sale & Update Inventory</button>
            </form>

            <h3 style="margin-top: 40px; margin-bottom: 15px;">Recent Sales</h3>
            <div class="action-buttons">
                <button class="btn" onclick="loadSales()">üîÑ Refresh</button>
                <button class="btn btn-secondary" onclick="exportSales()">üì• Export to CSV</button>
            </div>
            <div id="salesTable"></div>
        </div>

        <!-- Manage Customers Tab -->
        <div id="customers" class="card">
            <h2 style="margin-bottom: 20px;">Manage Customers</h2>
            
            <div class="action-buttons">
                <button class="btn" onclick="loadCustomers()">üîÑ Refresh</button>
                <button class="btn btn-success" onclick="showAddCustomerModal()">‚ûï Add Customer</button>
                <button class="btn btn-secondary" onclick="exportCustomers()">üì• Export to CSV</button>
            </div>
            
            <div id="customersTable"></div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="card">
            <h2 style="margin-bottom: 20px;">Business Reports & Analytics</h2>
            
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-label">Total Products</div>
                    <div class="stat-value" id="statProducts">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Inventory Value</div>
                    <div class="stat-value" id="statInventoryValue">$--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Customers</div>
                    <div class="stat-value" id="statCustomers">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Sales This Month</div>
                    <div class="stat-value" id="statSales">$--</div>
                </div>
            </div>

            <button class="btn" onclick="generateReports()">üìä Generate Full Report</button>
        </div>

        <!-- Settings Tab -->
        <div id="config" class="card">
            <h2 style="margin-bottom: 20px;">System Configuration</h2>
            
            <div class="status" id="configStatusMessage"></div>
            
            <div class="info-box">
                <h3>Setup Instructions</h3>
                <ol style="line-height: 1.8;">
                    <li>Google Cloud Project: <strong>nowak-distributing</strong></li>
                    <li>Vision API enabled for invoice OCR ‚úÖ</li>
                    <li>Claude AI for intelligent data extraction ‚úÖ</li>
                    <li>Share your Google Sheet with "Anyone with link - Editor" ‚úÖ</li>
                    <li>Deploy Google Apps Script as Web App ‚úÖ</li>
                    <li>Configure both IDs below ‚¨áÔ∏è</li>
                </ol>
            </div>

            <div class="config-section">
                <h3>Google Sheets Configuration</h3>
                <p style="margin-bottom: 10px; color: #666;">
                    Spreadsheet ID from URL: <code>https://docs.google.com/spreadsheets/d/<strong>SPREADSHEET_ID</strong>/edit</code>
                </p>
                <input type="text" id="spreadsheetId" class="config-input" placeholder="Paste Spreadsheet ID" style="margin-bottom: 15px;">
                
                <h3 style="margin-top: 25px;">Web App URL</h3>
                <p style="margin-bottom: 10px; color: #666;">
                    From Google Apps Script deployment: <code>https://script.google.com/macros/s/.../exec</code>
                </p>
                <input type="text" id="webAppUrl" class="config-input" placeholder="Paste Web App URL">
                
                <button class="btn save-config-btn" onclick="saveConfig()">üíæ Save Configuration</button>
            </div>

            <div class="config-section">
                <h3>Current Status</h3>
                <p id="configStatus">‚ö†Ô∏è Not configured</p>
            </div>
        </div>
    </div>

    <!-- Edit Invoice Modal -->
    <div id="editInvoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Invoice</h2>
                <span class="close" onclick="closeModal('editInvoiceModal')">&times;</span>
            </div>
            <form id="editInvoiceForm">
                <input type="hidden" id="editInvoiceRow">
                <div class="form-group">
                    <label>Supplier</label>
                    <select id="editSupplier" required>
                        <option value="Brimhall Foods Company">Brimhall Foods Company</option>
                        <option value="Better Made Snack Foods">Better Made Snack Foods</option>
                        <option value="Kim's Processing Plant">Kim's Processing Plant</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Invoice Number</label>
                    <input type="text" id="editInvoiceNumber" required>
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="editInvoiceDate" required>
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" id="editInvoiceAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Line Items</label>
                    <textarea id="editInvoiceItems" rows="6"></textarea>
                </div>
                <button type="submit" class="btn">üíæ Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('editInvoiceModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Edit Inventory Modal -->
    <div id="editInventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Product</h2>
                <span class="close" onclick="closeModal('editInventoryModal')">&times;</span>
            </div>
            <form id="editInventoryForm">
                <input type="hidden" id="editProductRow">
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="editProductName" required>
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="editProductQty" required>
                </div>
                <div class="form-group">
                    <label>Unit Cost</label>
                    <input type="number" id="editProductCost" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Supplier</label>
                    <select id="editProductSupplier" required>
                        <option value="Brimhall Foods Company">Brimhall Foods Company</option>
                        <option value="Better Made Snack Foods">Better Made Snack Foods</option>
                        <option value="Kim's Processing Plant">Kim's Processing Plant</option>
                    </select>
                </div>
                <button type="submit" class="btn">üíæ Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('editInventoryModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Product</h2>
                <span class="close" onclick="closeModal('addProductModal')">&times;</span>
            </div>
            <form id="addProductForm">
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="newProductName" required>
                </div>
                <div class="form-group">
                    <label>Initial Quantity</label>
                    <input type="number" id="newProductQty" required>
                </div>
                <div class="form-group">
                    <label>Unit Cost</label>
                    <input type="number" id="newProductCost" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Supplier</label>
                    <select id="newProductSupplier" required>
                        <option value="Brimhall Foods Company">Brimhall Foods Company</option>
                        <option value="Better Made Snack Foods">Better Made Snack Foods</option>
                        <option value="Kim's Processing Plant">Kim's Processing Plant</option>
                    </select>
                </div>
                <button type="submit" class="btn">‚ûï Add Product</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('addProductModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="addCustomerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Customer</h2>
                <span class="close" onclick="closeModal('addCustomerModal')">&times;</span>
            </div>
            <form id="addCustomerForm">
                <div class="form-group">
                    <label>Customer Name</label>
                    <input type="text" id="newCustomerName" required>
                </div>
                <div class="form-group">
                    <label>Business Name</label>
                    <input type="text" id="newCustomerBusiness">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="newCustomerPhone">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="newCustomerEmail">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="newCustomerAddress" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Credit Limit</label>
                    <input type="number" id="newCustomerCredit" step="0.01" value="0">
                </div>
                <button type="submit" class="btn">‚ûï Add Customer</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('addCustomerModal')">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const API_KEY = 'AIzaSyBGK5T9lX2qwSZZ8MUYgzKrUlVejR9L57c';
        let SPREADSHEET_ID = localStorage.getItem('spreadsheetId') || '';
        let WEB_APP_URL = localStorage.getItem('webAppUrl') || '';

        // Tab switching - DEFINED FIRST to be available immediately
        function switchTab(tabName) {
            console.log('switchTab called:', tabName);
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('onclick') && tab.getAttribute('onclick').includes(`'${tabName}'`)) {
                    tab.classList.add('active');
                }
            });
            
            // Update cards
            document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            // Load data when switching to certain tabs
            if (tabName === 'invoices') loadInvoices();
            if (tabName === 'inventory') loadInventory();
            if (tabName === 'sales') {
                loadSales();
                loadCustomersList();
            }
            if (tabName === 'customers') loadCustomers();
            if (tabName === 'reports') generateReports();
        }

        console.log('switchTab defined:', typeof switchTab);

        // Update config status on load
        window.addEventListener('DOMContentLoaded', () => {
            try {
                updateConfigStatus();
                const today = new Date().toISOString().split('T')[0];
                const saleDateEl = document.getElementById('saleDate');
                if (saleDateEl) {
                    saleDateEl.value = today;
                }
            } catch (error) {
                console.error('DOMContentLoaded error:', error);
            }
        });

        function updateConfigStatus() {
            const statusEl = document.getElementById('configStatus');
            const spreadsheetInput = document.getElementById('spreadsheetId');
            const webAppInput = document.getElementById('webAppUrl');
            
            if (SPREADSHEET_ID) {
                spreadsheetInput.value = SPREADSHEET_ID;
            }
            
            if (WEB_APP_URL) {
                webAppInput.value = WEB_APP_URL;
            }
            
            if (SPREADSHEET_ID && WEB_APP_URL) {
                statusEl.innerHTML = '‚úÖ Fully configured and ready!';
                statusEl.style.color = '#2e7d32';
            } else if (SPREADSHEET_ID && !WEB_APP_URL) {
                statusEl.innerHTML = '‚ö†Ô∏è Web App URL not configured';
                statusEl.style.color = '#f57c00';
            } else if (!SPREADSHEET_ID && WEB_APP_URL) {
                statusEl.innerHTML = '‚ö†Ô∏è Spreadsheet ID not configured';
                statusEl.style.color = '#f57c00';
            } else {
                statusEl.innerHTML = '‚ö†Ô∏è Not configured';
                statusEl.style.color = '#f57c00';
            }
        }

        function saveConfig() {
            const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            const webAppUrl = document.getElementById('webAppUrl').value.trim();
            const configStatus = document.getElementById('configStatusMessage');
            
            if (!spreadsheetId) {
                configStatus.textContent = 'Please enter a Spreadsheet ID';
                configStatus.className = 'status error';
                configStatus.style.display = 'block';
                return;
            }
            
            if (!webAppUrl) {
                configStatus.textContent = 'Please enter your Web App URL';
                configStatus.className = 'status error';
                configStatus.style.display = 'block';
                return;
            }
            
            SPREADSHEET_ID = spreadsheetId;
            WEB_APP_URL = webAppUrl;
            localStorage.setItem('spreadsheetId', spreadsheetId);
            localStorage.setItem('webAppUrl', webAppUrl);
            updateConfigStatus();
            
            configStatus.textContent = '‚úÖ Configuration saved! System ready to use.';
            configStatus.className = 'status success';
            configStatus.style.display = 'block';
            
            setTimeout(() => {
                configStatus.style.display = 'none';
            }, 5000);
        }

        // Modal functions
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showAddProductModal() {
            document.getElementById('addProductModal').style.display = 'block';
        }

        function showAddCustomerModal() {
            document.getElementById('addCustomerModal').style.display = 'block';
        }

        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        async function handleFile(file) {
            if (!SPREADSHEET_ID || !WEB_APP_URL) {
                showStatus('Please configure your Spreadsheet ID and Web App URL in Settings first!', 'error');
                setTimeout(() => {
                    switchTab('config');
                }, 2000);
                return;
            }

            showStatus('Processing invoice with AI...', 'processing');
            document.getElementById('previewContainer').style.display = 'block';
            document.getElementById('spinner').style.display = 'block';

            // Show preview for images
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('previewImage').src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('previewImage').style.display = 'none';
            }

            // Extract text with Vision API + Claude AI
            try {
                const extractedData = await extractInvoiceData(file);
                populateForm(extractedData);
                document.getElementById('spinner').style.display = 'none';
                showStatus('‚úÖ AI extracted all data! Review and save.', 'success');
            } catch (error) {
                document.getElementById('spinner').style.display = 'none';
                showStatus('Error: ' + error.message, 'error');
            }
        }

        async function extractInvoiceData(file) {
            // Convert file to base64
            const base64 = await fileToBase64(file);
            const base64Content = base64.split(',')[1];

            // Call Vision API
            const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    requests: [{
                        image: {
                            content: base64Content
                        },
                        features: [{
                            type: 'DOCUMENT_TEXT_DETECTION'
                        }]
                    }]
                })
            });

            if (!response.ok) {
                throw new Error('Vision API error: ' + response.statusText);
            }

            const data = await response.json();
            const text = data.responses[0]?.fullTextAnnotation?.text || '';
            
            return parseInvoiceText(text);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function parseInvoiceText(text) {
            // Use Claude AI to intelligently parse the invoice
            try {
                const claudeResponse = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [
                            { 
                                role: "user", 
                                content: `You are an invoice data extraction assistant. Extract information from this invoice and return ONLY valid JSON:

Invoice Text:
${text}

Return JSON with these fields:
{
  "supplier": "exact supplier name",
  "invoiceNumber": "invoice number",
  "invoiceDate": "YYYY-MM-DD format",
  "totalAmount": "number only",
  "lineItems": "Quantity | Product | Price (one per line)"
}

Extract ALL line items thoroughly. Format:
24 | Lay's Classic Chips 1oz | 0.45` 
                            }
                        ],
                    })
                });

                const claudeData = await claudeResponse.json();
                const responseText = claudeData.content?.[0]?.text || '{}';
                const parsedData = JSON.parse(responseText);
                
                return {
                    supplier: parsedData.supplier || detectSupplier(text),
                    invoiceNumber: parsedData.invoiceNumber || '',
                    invoiceDate: parsedData.invoiceDate || '',
                    totalAmount: parsedData.totalAmount || '',
                    lineItems: parsedData.lineItems || '',
                    rawText: text
                };
                
            } catch (error) {
                console.error('Claude API error:', error);
                return simpleParseInvoice(text);
            }
        }

        function detectSupplier(text) {
            if (text.toLowerCase().includes('brimhall') || text.toLowerCase().includes('brims')) {
                return 'Brimhall Foods Company';
            } else if (text.toLowerCase().includes('better made')) {
                return 'Better Made Snack Foods';
            } else if (text.toLowerCase().includes('kim')) {
                return "Kim's Processing Plant";
            }
            return '';
        }

        function simpleParseInvoice(text) {
            const invoiceMatch = text.match(/(?:invoice|inv|#)\s*[:#]?\s*([A-Z0-9-]+)/i);
            const invoiceNumber = invoiceMatch ? invoiceMatch[1] : '';
            
            const dateMatch = text.match(/(\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4})/);
            const invoiceDate = dateMatch ? formatDate(dateMatch[1]) : '';
            
            const totalMatch = text.match(/(?:total|amount due|balance)[\s:$]*(\d+[.,]\d{2})/i);
            const totalAmount = totalMatch ? totalMatch[1].replace(',', '') : '';
            
            return {
                supplier: detectSupplier(text),
                invoiceNumber,
                invoiceDate,
                totalAmount,
                lineItems: '',
                rawText: text
            };
        }

        function formatDate(dateStr) {
            const parts = dateStr.split(/[-\/]/);
            if (parts.length === 3) {
                let [month, day, year] = parts;
                if (year.length === 2) year = '20' + year;
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            return '';
        }

        function populateForm(data) {
            document.getElementById('supplier').value = data.supplier;
            document.getElementById('invoiceNumber').value = data.invoiceNumber;
            document.getElementById('invoiceDate').value = data.invoiceDate;
            document.getElementById('totalAmount').value = data.totalAmount;
            document.getElementById('lineItems').value = data.lineItems || '';
        }

        // Form submission
        document.getElementById('invoiceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            showStatus('Saving invoice and updating inventory...', 'processing');

            const formData = {
                supplier: document.getElementById('supplier').value,
                invoiceNumber: document.getElementById('invoiceNumber').value,
                invoiceDate: document.getElementById('invoiceDate').value,
                totalAmount: document.getElementById('totalAmount').value,
                lineItems: document.getElementById('lineItems').value,
                timestamp: new Date().toISOString()
            };

            try {
                await saveToSheets(formData);
                showStatus('‚úÖ Invoice saved and inventory updated!', 'success');
                document.getElementById('invoiceForm').reset();
                document.getElementById('previewContainer').style.display = 'none';
                fileInput.value = '';
            } catch (error) {
                showStatus('Error saving: ' + error.message, 'error');
            }
        });

        async function saveToSheets(data) {
            if (!WEB_APP_URL) {
                throw new Error('Please configure your Web App URL in Settings!');
            }

            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'saveInvoice',
                    sheetName: 'Supplier Invoices',
                    timestamp: data.timestamp,
                    supplier: data.supplier,
                    invoiceNumber: data.invoiceNumber,
                    invoiceDate: data.invoiceDate,
                    totalAmount: data.totalAmount,
                    lineItems: data.lineItems
                })
            });

            return { success: true };
        }

        // Load invoices
        async function loadInvoices() {
            if (!SPREADSHEET_ID) {
                document.getElementById('invoicesTable').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚öôÔ∏è</div><p>Please configure your system in Settings first</p></div>';
                return;
            }

            try {
                const data = await fetchSheetData('Supplier Invoices');
                displayInvoicesTable(data);
            } catch (error) {
                document.getElementById('invoicesTable').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Error loading invoices</p></div>';
            }
        }

        function displayInvoicesTable(data) {
            const container = document.getElementById('invoicesTable');
            
            if (!data || data.length <= 1) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><p>No invoices yet. Upload your first invoice!</p></div>';
                return;
            }

            let html = '<div class="data-table"><table><thead><tr>';
            html += '<th>Date</th><th>Supplier</th><th>Invoice #</th><th>Amount</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                html += `<tr>
                    <td>${row[3] || ''}</td>
                    <td>${row[1] || ''}</td>
                    <td>${row[2] || ''}</td>
                    <td>$${parseFloat(row[4] || 0).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-small" onclick="editInvoice(${i + 1})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteInvoice(${i + 1})">üóëÔ∏è Delete</button>
                    </td>
                </tr>`;
            }

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Load inventory
        async function loadInventory() {
            if (!SPREADSHEET_ID) {
                document.getElementById('inventoryTable').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚öôÔ∏è</div><p>Please configure your system in Settings first</p></div>';
                return;
            }

            try {
                const data = await fetchSheetData('Inventory');
                displayInventoryTable(data);
            } catch (error) {
                document.getElementById('inventoryTable').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Error loading inventory</p></div>';
            }
        }

        function displayInventoryTable(data) {
            const container = document.getElementById('inventoryTable');
            
            if (!data || data.length <= 1) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><p>No inventory yet. Upload invoices to populate inventory!</p></div>';
                return;
            }

            let html = '<div class="data-table"><table><thead><tr>';
            html += '<th>Product</th><th>Quantity</th><th>Unit Cost</th><th>Supplier</th><th>Total Value</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                const qty = parseFloat(row[1] || 0);
                const cost = parseFloat(row[2] || 0);
                const totalValue = qty * cost;
                
                const lowStock = qty < 10 ? 'style="background:#fff3cd;"' : '';
                
                html += `<tr ${lowStock}>
                    <td><strong>${row[0] || ''}</strong></td>
                    <td>${qty}</td>
                    <td>$${cost.toFixed(2)}</td>
                    <td>${row[3] || ''}</td>
                    <td>$${totalValue.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-small" onclick="editProduct(${i + 1})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteProduct(${i + 1})">üóëÔ∏è Delete</button>
                    </td>
                </tr>`;
            }

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Load sales
        async function loadSales() {
            if (!SPREADSHEET_ID) {
                document.getElementById('salesTable').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚öôÔ∏è</div><p>Please configure your system in Settings first</p></div>';
                return;
            }

            try {
                const data = await fetchSheetData('Sales');
                displaySalesTable(data);
            } catch (error) {
                document.getElementById('salesTable').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Error loading sales</p></div>';
            }
        }

        function displaySalesTable(data) {
            const container = document.getElementById('salesTable');
            
            if (!data || data.length <= 1) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∞</div><p>No sales yet. Record your first sale!</p></div>';
                return;
            }

            let html = '<div class="data-table"><table><thead><tr>';
            html += '<th>Date</th><th>Customer</th><th>Items</th><th>Total</th><th>Payment</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                html += `<tr>
                    <td>${row[0] || ''}</td>
                    <td>${row[1] || ''}</td>
                    <td>${row[2] || ''}</td>
                    <td>$${parseFloat(row[3] || 0).toFixed(2)}</td>
                    <td>${row[4] || ''}</td>
                    <td>
                        <button class="btn btn-small btn-danger" onclick="deleteSale(${i + 1})">üóëÔ∏è Delete</button>
                    </td>
                </tr>`;
            }

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Load customers
        async function loadCustomers() {
            if (!SPREADSHEET_ID) {
                document.getElementById('customersTable').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚öôÔ∏è</div><p>Please configure your system in Settings first</p></div>';
                return;
            }

            try {
                const data = await fetchSheetData('Customers');
                displayCustomersTable(data);
            } catch (error) {
                document.getElementById('customersTable').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Error loading customers</p></div>';
            }
        }

        function displayCustomersTable(data) {
            const container = document.getElementById('customersTable');
            
            if (!data || data.length <= 1) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><p>No customers yet. Add your first customer!</p></div>';
                return;
            }

            let html = '<div class="data-table"><table><thead><tr>';
            html += '<th>Name</th><th>Business</th><th>Phone</th><th>Email</th><th>Credit Limit</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                html += `<tr>
                    <td><strong>${row[0] || ''}</strong></td>
                    <td>${row[1] || ''}</td>
                    <td>${row[2] || ''}</td>
                    <td>${row[3] || ''}</td>
                    <td>$${parseFloat(row[5] || 0).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-small" onclick="editCustomer(${i + 1})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteCustomer(${i + 1})">üóëÔ∏è Delete</button>
                    </td>
                </tr>`;
            }

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Load customers list for sales dropdown
        async function loadCustomersList() {
            try {
                const data = await fetchSheetData('Customers');
                const select = document.getElementById('saleCustomer');
                select.innerHTML = '<option value="">Select Customer</option>';
                
                for (let i = 1; i < data.length; i++) {
                    const customerName = data[i][0];
                    if (customerName) {
                        select.innerHTML += `<option value="${customerName}">${customerName}</option>`;
                    }
                }
            } catch (error) {
                console.error('Error loading customers list:', error);
            }
        }

        async function fetchSheetData(sheetName) {
            const response = await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${sheetName}?key=${API_KEY}`
            );

            if (!response.ok) {
                throw new Error('Failed to fetch data from Sheets');
            }

            const data = await response.json();
            return data.values || [];
        }

        // Placeholder edit/delete functions (would need Apps Script endpoints)
        async function editInvoice(rowNumber) {
            try {
                const data = await fetchSheetData('Supplier Invoices');
                const invoice = data[rowNumber - 1];
                
                document.getElementById('editInvoiceRow').value = rowNumber;
                document.getElementById('editSupplier').value = invoice[1];
                document.getElementById('editInvoiceNumber').value = invoice[2];
                document.getElementById('editInvoiceDate').value = invoice[3];
                document.getElementById('editInvoiceAmount').value = invoice[4];
                document.getElementById('editInvoiceItems').value = invoice[5] || '';
                
                document.getElementById('editInvoiceModal').style.display = 'block';
            } catch (error) {
                alert('Error loading invoice: ' + error.message);
            }
        }

        async function deleteInvoice(rowNumber) {
            if (!confirm('Delete this invoice? This will NOT reverse inventory changes.')) {
                return;
            }
            
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'deleteInvoice',
                        rowNumber: rowNumber
                    })
                });
                
                alert('Invoice deleted successfully!');
                loadInvoices();
            } catch (error) {
                alert('Error deleting invoice: ' + error.message);
            }
        }

        async function editProduct(rowNumber) {
            try {
                const data = await fetchSheetData('Inventory');
                const product = data[rowNumber - 1];
                
                document.getElementById('editProductRow').value = rowNumber;
                document.getElementById('editProductName').value = product[0];
                document.getElementById('editProductQty').value = product[1];
                document.getElementById('editProductCost').value = product[2];
                document.getElementById('editProductSupplier').value = product[3];
                
                document.getElementById('editInventoryModal').style.display = 'block';
            } catch (error) {
                alert('Error loading product: ' + error.message);
            }
        }

        async function deleteProduct(rowNumber) {
            if (!confirm('Delete this product from inventory?')) {
                return;
            }
            
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'deleteProduct',
                        rowNumber: rowNumber
                    })
                });
                
                alert('Product deleted successfully!');
                loadInventory();
            } catch (error) {
                alert('Error deleting product: ' + error.message);
            }
        }

        async function deleteSale(rowNumber) {
            if (!confirm('Delete this sale? This will NOT reverse inventory changes.')) {
                return;
            }
            
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'deleteSale',
                        rowNumber: rowNumber
                    })
                });
                
                alert('Sale deleted successfully!');
                loadSales();
            } catch (error) {
                alert('Error deleting sale: ' + error.message);
            }
        }

        function editCustomer(row) {
            alert('Customer edit modal - coming soon! For now, delete and re-add the customer.');
        }

        async function deleteCustomer(rowNumber) {
            if (!confirm('Delete this customer?')) {
                return;
            }
            
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'deleteCustomer',
                        rowNumber: rowNumber
                    })
                });
                
                alert('Customer deleted successfully!');
                loadCustomers();
            } catch (error) {
                alert('Error deleting customer: ' + error.message);
            }
        }

        // Edit invoice form submission
        document.getElementById('editInvoiceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateInvoice',
                        rowNumber: document.getElementById('editInvoiceRow').value,
                        supplier: document.getElementById('editSupplier').value,
                        invoiceNumber: document.getElementById('editInvoiceNumber').value,
                        invoiceDate: document.getElementById('editInvoiceDate').value,
                        totalAmount: document.getElementById('editInvoiceAmount').value,
                        lineItems: document.getElementById('editInvoiceItems').value
                    })
                });
                
                alert('Invoice updated successfully!');
                closeModal('editInvoiceModal');
                loadInvoices();
            } catch (error) {
                alert('Error updating invoice: ' + error.message);
            }
        });

        // Edit inventory form submission
        document.getElementById('editInventoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateProduct',
                        rowNumber: document.getElementById('editProductRow').value,
                        productName: document.getElementById('editProductName').value,
                        quantity: document.getElementById('editProductQty').value,
                        unitCost: document.getElementById('editProductCost').value,
                        supplier: document.getElementById('editProductSupplier').value
                    })
                });
                
                alert('Product updated successfully!');
                closeModal('editInventoryModal');
                loadInventory();
            } catch (error) {
                alert('Error updating product: ' + error.message);
            }
        });

        // Add product form
        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'addProduct',
                        productName: document.getElementById('newProductName').value,
                        quantity: document.getElementById('newProductQty').value,
                        unitCost: document.getElementById('newProductCost').value,
                        supplier: document.getElementById('newProductSupplier').value
                    })
                });
                
                alert('Product added successfully!');
                closeModal('addProductModal');
                document.getElementById('addProductForm').reset();
                loadInventory();
            } catch (error) {
                alert('Error adding product: ' + error.message);
            }
        });

        // Add customer form
        document.getElementById('addCustomerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'addCustomer',
                        name: document.getElementById('newCustomerName').value,
                        business: document.getElementById('newCustomerBusiness').value,
                        phone: document.getElementById('newCustomerPhone').value,
                        email: document.getElementById('newCustomerEmail').value,
                        address: document.getElementById('newCustomerAddress').value,
                        creditLimit: document.getElementById('newCustomerCredit').value
                    })
                });
                
                alert('Customer added successfully!');
                closeModal('addCustomerModal');
                document.getElementById('addCustomerForm').reset();
                loadCustomers();
                loadCustomersList(); // Also update the sales dropdown
            } catch (error) {
                alert('Error adding customer: ' + error.message);
            }
        });

        // Sales form  
        document.getElementById('salesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'recordSale',
                        saleDate: document.getElementById('saleDate').value,
                        customer: document.getElementById('saleCustomer').value,
                        saleItems: document.getElementById('saleItems').value,
                        paymentMethod: document.getElementById('paymentMethod').value
                    })
                });
                
                alert('Sale recorded and inventory updated!');
                document.getElementById('salesForm').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('saleDate').value = today;
                loadSales();
            } catch (error) {
                alert('Error recording sale: ' + error.message);
            }
        });
            try {
                const inventory = await fetchSheetData('Inventory');
                const sales = await fetchSheetData('Sales');
                const customers = await fetchSheetData('Customers');
                
                // Calculate stats
                let totalProducts = Math.max(0, inventory.length - 1);
                let inventoryValue = 0;
                
                for (let i = 1; i < inventory.length; i++) {
                    const qty = parseFloat(inventory[i][1] || 0);
                    const cost = parseFloat(inventory[i][2] || 0);
                    inventoryValue += qty * cost;
                }
                
                let totalCustomers = Math.max(0, customers.length - 1);
                let salesThisMonth = 0;
                
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                for (let i = 1; i < sales.length; i++) {
                    const dateStr = sales[i][0];
                    if (dateStr) {
                        const date = new Date(dateStr);
                        if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                            salesThisMonth += parseFloat(sales[i][3] || 0);
                        }
                    }
                }
                
                document.getElementById('statProducts').textContent = totalProducts;
                document.getElementById('statInventoryValue').textContent = '$' + inventoryValue.toFixed(2);
                document.getElementById('statCustomers').textContent = totalCustomers;
                document.getElementById('statSales').textContent = '$' + salesThisMonth.toFixed(2);
                
            } catch (error) {
                console.error('Error generating reports:', error);
            }
        }

        // Export functions
        function exportInvoices() {
            alert('Export to CSV functionality');
        }

        function exportInventory() {
            alert('Export to CSV functionality');
        }

        function exportSales() {
            alert('Export to CSV functionality');
        }

        function exportCustomers() {
            alert('Export to CSV functionality');
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>
